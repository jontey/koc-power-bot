if (!g_js_strings) {
    var g_js_strings = new Object()
}
g_js_strings.errorcode = new Object();
g_js_strings.errorcode.err_default = 'Something has gone wrong! Please try again, or refresh if this message reappears<br><br><a onclick="HelpDesk.show(4);return false;">See this error a lot? Let us know</a>';
g_js_strings.errorcode.err_0 = 'An Unexpected Error has occurred. Please try again later, or refresh if this message reappears<br><br><a onclick="HelpDesk.show(4);return false;">See this error a lot? Let us know</a>';
g_js_strings.errorcode.err_1 = 'A Fatal Error was encountered. Please refresh the page<br><br><a onclick="HelpDesk.show(4);return false;">See this error a lot? Let us know</a>';
g_js_strings.errorcode.err_2 = "Construction is already starting or is in progress";
g_js_strings.errorcode.err_3 = 'Unknown issue when updating your game, please try again later<br><br><a onclick="HelpDesk.show(4);return false;">See this error a lot? Let us know</a>';
g_js_strings.errorcode.err_4 = "You have insufficient %1$s! You currently have %2$s %3$s";
g_js_strings.errorcode.err_4b = "Your %1$s is not high enough level. You currently have %2$s";
g_js_strings.errorcode.err_4c = "You do not have enough %1$s. You currently have %2$s";
g_js_strings.errorcode.err_4z = "Requirements not met";
g_js_strings.errorcode.err_5 = 'There is a problem with the City. Please try again <br><br><br><a onclick="HelpDesk.show(4);return false;">See this error a lot? Let us know</a>';
g_js_strings.errorcode.err_6 = "Training queue of this City is full!";
g_js_strings.errorcode.err_7 = "You cannot perform this action again until %1$s";
g_js_strings.errorcode.err_8 = 'Kingdoms of Camelot is not able to process your request due to excess traffic. Please wait to try again. <br><br><a onclick="HelpDesk.show(4);return false;">See this error a lot? Let us know</a>';
g_js_strings.errorcode.err_50 = "Name is already taken! Please choose another";
g_js_strings.errorcode.err_51 = "Character names must be 3~15 letters with no spaces";
g_js_strings.errorcode.err_52 = "This name is not allowed. Please choose another";
g_js_strings.errorcode.err_53 = "No player found";
g_js_strings.errorcode.err_61 = "Not allowed to access this report";
g_js_strings.errorcode.err_62 = "No report exists on this page";
g_js_strings.errorcode.err_63 = "That report does not exist.";
g_js_strings.errorcode.err_101 = "That building does not seem to exist. Please refresh if this message reappears";
g_js_strings.errorcode.err_102 = "Another building already exists on that spot! If you cannot see it, please refresh the page";
g_js_strings.errorcode.err_102b = "Can only use a Portal to a free Plain";
g_js_strings.errorcode.err_103 = "Cannot change to specified level. You are currently at level %1$s. Please reload the page if this is not the level shown in the game";
g_js_strings.errorcode.err_103b = "Buildings can only be destroyed when their level is greater than 1";
g_js_strings.errorcode.err_104 = "Cannot perform this action on target location.";
g_js_strings.errorcode.err_105 = "The building you are trying to upgrade does not appear to exist in that location. Please try again later, or refresh the page";
g_js_strings.errorcode.err_106 = "Only one building of this type is allowed per City";
g_js_strings.errorcode.err_111 = "This City is already researching!";
g_js_strings.errorcode.err_112 = "This technology is already being researched!";
g_js_strings.errorcode.err_121 = "There is no space available for this Fortification";
g_js_strings.errorcode.err_121b = "Load capacity exceeded";
g_js_strings.errorcode.err_121c = "You have exceeded the number of transactions allowed by your Market level";
g_js_strings.errorcode.err_131 = "Cancellation can not be done at this time";
g_js_strings.errorcode.err_151 = "You cannot destroy this building until it is done being worked on";
g_js_strings.errorcode.err_152 = "You cannot destroy this building while it is in use";
g_js_strings.errorcode.err_201 = "Invalid destination specified";
g_js_strings.errorcode.err_202 = 'No info on starting location<br><br><br><a onclick="HelpDesk.show(4);return false;">See this error a lot? Let us know</a>';
g_js_strings.errorcode.err_203 = 'No info on destination location<br><br><br><a onclick="HelpDesk.show(4);return false;">See this error a lot? Let us know</a>';
g_js_strings.errorcode.err_204 = "Cannot March to yourself";
g_js_strings.errorcode.err_205 = 'Unknown issue. Cannot march to this location.<br><br><br><a onclick="HelpDesk.show(4);return false;">See this error a lot? Let us know</a>';
g_js_strings.errorcode.err_206 = 'Cannot perform this action on target. Please try again later <br><br><br><a onclick="HelpDesk.show(4);return false;">See this error a lot? Let us know</a>';
g_js_strings.errorcode.err_207 = "You cannot Attack or Scout another player City while in Beginner Protection, Truce, or Vacation mode";
g_js_strings.errorcode.err_207b = "You cannot use Dove of Peace while under Beginner Protection or if you are already under Truce mode";
g_js_strings.errorcode.err_207c = "You cannot use Dove of Peace until you have ceased all attacks; recall your troops if you wish to invoke King Arthur's protection.";
g_js_strings.errorcode.err_207d = "You cannot use Dove of Peace while you are under attack.";
g_js_strings.errorcode.err_208 = "You cannot Attack or Scout another player City that is in Beginner Protection, Truce, or Vacation mode.";
g_js_strings.errorcode.err_209 = "You cannot Attack or Scout a member of your alliance.";
g_js_strings.errorcode.err_210 = "Maximum allowed marches reached at current Rally Point level";
g_js_strings.errorcode.err_211 = "Maximum Troops exceeded for current Rally Point level. Use an Aura of Command or Aura of Conquest to increase your Maximum Troops";
g_js_strings.errorcode.err_212 = "Unable to use target Knight. Knight must be idle to be used. If you receive this message in error, please refresh the game";
g_js_strings.errorcode.err_213 = "Unable to use target Knight. Knight must be in the City to be used. If you receive this message in error, please refresh the game";
g_js_strings.errorcode.err_214 = "Friend is already a Knight!";
g_js_strings.errorcode.err_215 = "The selected person does not appear to be your friend according to Facebook. Please try again later";
g_js_strings.errorcode.err_216 = 'The Skill point you are saving are the same or lower than current Skill points. If this disagrees with what the Knight\'s Hall shows you, please refresh the page<br><br><a onclick="HelpDesk.show(4);return false;">See this error a lot? Let us know</a>';
g_js_strings.errorcode.err_217 = "Knight has no Unassigned Skill Points";
g_js_strings.errorcode.err_218 = "Maximum Troops exceeded for current Rally Point Level. Please reduce Troops for this Raid or upgrade your Rally Point.";
g_js_strings.errorcode.err_251 = "Requested March does not exist";
g_js_strings.errorcode.err_252 = "Match info does not match";
g_js_strings.errorcode.err_301 = "Cannot abandon last City!";
g_js_strings.errorcode.err_311 = "Cannot have Troops still on a March";
g_js_strings.errorcode.err_312 = "Cannot have outstanding Market transactions";
g_js_strings.errorcode.err_320 = "You may not build more than 10 Cities at this time";
g_js_strings.errorcode.err_330 = "You may not increase a Knight's loyalty above 100";
g_js_strings.errorcode.err_401 = "Tile info does not match";
g_js_strings.errorcode.err_402 = "No available Plains in the selected Province";
g_js_strings.errorcode.err_403 = "Situation at target Plain has changed";
g_js_strings.errorcode.err_404 = "You must build on a Plain you control";
g_js_strings.errorcode.err_501 = "Please quit the current Alliance before creating an Alliance";
g_js_strings.errorcode.err_601 = "You cannot help with your own project.";
g_js_strings.errorcode.err_602 = "Could not complete request, Player not found.";
g_js_strings.errorcode.err_603 = "%1$s %2$s is not in your alliance.";
g_js_strings.errorcode.err_604 = "%1$s %2$s's Kingdom does not need help.";
g_js_strings.errorcode.err_605 = "%1$s %2$s's project has already been completed.";
g_js_strings.errorcode.err_606 = "%1$s %2$s's project has received the maximum amount of help.";
g_js_strings.errorcode.err_607 = "You already helped with %1$s %2$s's project.";
g_js_strings.errorcode.err_608 = "There is something wrong with your request. Cannot process.";
g_js_strings.errorcode.err_1001 = "Your Facebook session has expired. The page will now refresh to restore your session";
g_js_strings.commonstr = new Object();
g_js_strings.commonstr.abandon = "Abandon";
g_js_strings.commonstr.aborting = "Aborting";
g_js_strings.commonstr.actions = "Actions";
g_js_strings.commonstr.aetherstone = "Aetherstone";
g_js_strings.commonstr.aetherstones = "Aetherstones";
g_js_strings.commonstr.alchemystic = "Alchemystic";
g_js_strings.commonstr.all = "All";
g_js_strings.commonstr.max = "Max";
g_js_strings.commonstr.allianceAtSign = "@Alliance";
g_js_strings.commonstr.alliance = "Alliance";
g_js_strings.commonstr.alliances = "Alliances";
g_js_strings.commonstr.amount = "Amount";
g_js_strings.commonstr.amt = "Amt";
g_js_strings.commonstr.apply = "Apply";
g_js_strings.commonstr.appoint = "Appoint";
g_js_strings.commonstr.approve = "Approve";
g_js_strings.commonstr.assist = "Assist";
g_js_strings.commonstr.assign = "Assign";
g_js_strings.commonstr.attack = "Attack";
g_js_strings.commonstr.attacker = "Attacker";
g_js_strings.commonstr.attackers = "Attackers";
g_js_strings.commonstr.attacking = "Attacking";
g_js_strings.commonstr.army = "Army";
g_js_strings.commonstr.atk = "Atk";
g_js_strings.commonstr.back = "Back";
g_js_strings.commonstr.ballistae = "Ballistae";
g_js_strings.commonstr.barbariancamp = "Barbarian Camp";
g_js_strings.commonstr.barbarians = "Barbarians";
g_js_strings.commonstr.benefits = "Benefits";
g_js_strings.commonstr.bog = "Bog";
g_js_strings.commonstr.build = "Build";
g_js_strings.commonstr.building = "Building";
g_js_strings.commonstr.buildings = "Buildings";
g_js_strings.commonstr.boost = "Boost";
g_js_strings.commonstr.buy = "Buy";
g_js_strings.commonstr.buyitem = "Buy Item";
g_js_strings.commonstr.buymore = "Buy More";
g_js_strings.commonstr.buying = "Buying";
g_js_strings.commonstr.cancel = "Cancel";
g_js_strings.commonstr.cancelconstruct = "Cancel Construction";
g_js_strings.commonstr.cancelled = "Cancelled";
g_js_strings.commonstr.chancellor = "Chancellor";
g_js_strings.commonstr.chat = "Chat";
g_js_strings.commonstr.chest = "Chest";
g_js_strings.commonstr.choose = "Choose";
g_js_strings.commonstr.city = "City";
g_js_strings.commonstr.cities = "Cities";
g_js_strings.commonstr.claim = "Claim";
g_js_strings.commonstr.claimedexc = "Claimed!";
g_js_strings.commonstr.classic = "Classic";
g_js_strings.commonstr.close = "Close";
g_js_strings.commonstr.com = "Com";
g_js_strings.commonstr.combat = "Combat";
g_js_strings.commonstr.completedexc = "Completed!";
g_js_strings.commonstr.compose = "Compose";
g_js_strings.commonstr.conquered = "Conquered";
g_js_strings.commonstr.construction = "Construction";
g_js_strings.commonstr.coordinates = "Coordinates";
g_js_strings.commonstr.cost = "Cost";
g_js_strings.commonstr.count = "Count";
g_js_strings.commonstr.court = "Court";
g_js_strings.commonstr.craft = "Craft";
g_js_strings.commonstr.crest = "Crest";
g_js_strings.commonstr.ccurrent = "Current";
g_js_strings.commonstr.current = "current";
g_js_strings.commonstr.date = "Date";
g_js_strings.commonstr.darkForest = "Dark Forest";
g_js_strings.commonstr.days = "Days";
g_js_strings.commonstr.decontruct = "Deconstruct";
g_js_strings.commonstr.defeat = "Defeat";
g_js_strings.commonstr.defend = "Defend";
g_js_strings.commonstr.defenders = "Defenders";
g_js_strings.commonstr.defending = "Defending";
g_js_strings.commonstr.defense = "Defense";
g_js_strings.commonstr.deletetx = "Delete";
g_js_strings.commonstr.demote = "Demote";
g_js_strings.commonstr.description = "Description";
g_js_strings.commonstr.destroy = "Destroy";
g_js_strings.commonstr.disaster = "Disaster";
g_js_strings.commonstr.dismiss = "Dismiss";
g_js_strings.commonstr.distance = "Distance";
g_js_strings.commonstr.domain = "Domain";
g_js_strings.commonstr.downward = "Downward";
g_js_strings.commonstr.edit = "Edit";
g_js_strings.commonstr.efficiency = "Efficiency";
g_js_strings.commonstr.encamped = "Encamped";
g_js_strings.commonstr.ends = "Ends";
g_js_strings.commonstr.enemy = "Enemy";
g_js_strings.commonstr.enhanced = "Enhanced";
g_js_strings.commonstr.equip = "Equip";
g_js_strings.commonstr.estimatedtime = "Estimated Time";
g_js_strings.commonstr.error = "Error";
g_js_strings.commonstr.experience = "Experience";
g_js_strings.commonstr.eventtx = "Event";
g_js_strings.commonstr.featured = "Featured";
g_js_strings.commonstr.feedback = "Feedback";
g_js_strings.commonstr.first = "First";
g_js_strings.commonstr.food = "Food";
g_js_strings.commonstr.fortx = "For";
g_js_strings.commonstr.forward = "Forward";
g_js_strings.commonstr.foreman = "Foreman";
g_js_strings.commonstr.fortification = "Fortification";
g_js_strings.commonstr.found = "In battle, your forces found a ";
g_js_strings.commonstr.founder = "Founder";
g_js_strings.commonstr.fought = "Fought";
g_js_strings.commonstr.friend = "Friend";
g_js_strings.commonstr.friendly = "Friendly";
g_js_strings.commonstr.friends = "Friends";
g_js_strings.commonstr.from = "From";
g_js_strings.commonstr.gems = "Gems";
g_js_strings.commonstr.general = "General";
g_js_strings.commonstr.get = "Get";
g_js_strings.commonstr.getmore = "Get More";
g_js_strings.commonstr.gift = "Gift";
g_js_strings.commonstr.global = "Global";
g_js_strings.commonstr.glory = "Glory";
g_js_strings.commonstr.glory_leaderboard = "Glory Leaderboard";
g_js_strings.commonstr.might_leaderboard = "Might Leaderboard";
g_js_strings.commonstr.timeRemainingToAchieve = "Time remaining to achieve glory";
g_js_strings.commonstr.gold = "Gold";
g_js_strings.commonstr.goldperhour = "Gold/Hour";
g_js_strings.commonstr.grassland = "Grassland";
g_js_strings.commonstr.happiness = "Happiness";
g_js_strings.commonstr.help = "Help";
g_js_strings.commonstr.hills = "Hills";
g_js_strings.commonstr.hire = "Hire";
g_js_strings.commonstr.host = "Host";
g_js_strings.commonstr.hostile = "Hostile";
g_js_strings.commonstr.idle = "Idle";
g_js_strings.commonstr.ignore = "Ignore";
g_js_strings.commonstr.impending = "Impending";
g_js_strings.commonstr.inbox = "Inbox";
g_js_strings.commonstr.info = "Info";
g_js_strings.commonstr.intabbr = "Int";
g_js_strings.commonstr.intelligence = "Intelligence";
g_js_strings.commonstr.intermediates = "Intermediates";
g_js_strings.commonstr.invalid = "Invalid";
g_js_strings.commonstr.invite = "Invite";
g_js_strings.commonstr.invited = "Invited";
g_js_strings.commonstr.items = "Items";
g_js_strings.commonstr.killed = "Killed";
g_js_strings.commonstr.knight = "Knight";
g_js_strings.commonstr.lady = "Lady";
g_js_strings.commonstr.ladylord = "Lady/Lord";
g_js_strings.commonstr.lake = "Lake";
g_js_strings.commonstr.leaderboard = "Leaderboard";
g_js_strings.commonstr.leaders = "Leaders";
g_js_strings.commonstr.leave = "Leave";
g_js_strings.commonstr.level = "Level";
g_js_strings.commonstr.levels = "Levels";
g_js_strings.commonstr.life = "Life";
g_js_strings.commonstr.limit = "Limit";
g_js_strings.commonstr.loadingddd = "Loading...";
g_js_strings.commonstr.location = "Location";
g_js_strings.commonstr.lord = "Lord";
g_js_strings.commonstr.loot = "Loot";
g_js_strings.commonstr.loyalty = "Loyalty";
g_js_strings.commonstr.lv = "Lv.";
g_js_strings.commonstr.lvl = "Lvl";
g_js_strings.commonstr.manual = "Manual";
g_js_strings.commonstr.march = "March";
g_js_strings.commonstr.marching = "Marching";
g_js_strings.commonstr.marshal = "Marshal";
g_js_strings.commonstr.member = "Member";
g_js_strings.commonstr.members = "Members";
g_js_strings.commonstr.mercenary = "Mercenary";
g_js_strings.commonstr.mercenaries = "Mercenaries";
g_js_strings.commonstr.message = "Message";
g_js_strings.commonstr.messagevb = "Message";
g_js_strings.commonstr.might = "Might";
g_js_strings.commonstr.militiamen = "Militiamen";
g_js_strings.commonstr.max = "Max";
g_js_strings.commonstr.maximum = "Maximum";
g_js_strings.commonstr.mountain = "Mountain";
g_js_strings.commonstr.nametx = "Name";
g_js_strings.commonstr.neutral = "Neutral";
g_js_strings.commonstr.next = "Next";
g_js_strings.commonstr.newString = "New";
g_js_strings.commonstr.no = "No";
g_js_strings.commonstr.noknight = "No Knight";
g_js_strings.commonstr.none = "None";
g_js_strings.commonstr.normal = "Normal";
g_js_strings.commonstr.note = "Note";
g_js_strings.commonstr.nothanks = "No Thanks";
g_js_strings.commonstr.novices = "Novices";
g_js_strings.commonstr.obtain = "Obtain";
g_js_strings.commonstr.of = "of";
g_js_strings.commonstr.officersAtSign = "@Officers";
g_js_strings.commonstr.officer = "Officer";
g_js_strings.commonstr.officers = "Officers";
g_js_strings.commonstr.offline = "Offline";
g_js_strings.commonstr.oftx = "of";
g_js_strings.commonstr.ok = "OK";
g_js_strings.commonstr.online = "online";
g_js_strings.commonstr.options = "Options";
g_js_strings.commonstr.other = "Other";
g_js_strings.commonstr.ore = "Ore";
g_js_strings.commonstr.outbox = "Outbox";
g_js_strings.commonstr.overview = "Overview";
g_js_strings.commonstr.owned = "Owned";
g_js_strings.commonstr.page = "Page";
g_js_strings.commonstr.pending = "Pending";
g_js_strings.commonstr.pikemen = "Pikemen";
g_js_strings.commonstr.plain = "Plain";
g_js_strings.commonstr.player = "Player";
g_js_strings.commonstr.plundered = "Plundered";
g_js_strings.commonstr.pol = "Pol";
g_js_strings.commonstr.politics = "Politics";
g_js_strings.commonstr.population = "Population";
g_js_strings.commonstr.position = "Position";
g_js_strings.commonstr.post = "Post";
g_js_strings.commonstr.posttowall = "Post to Wall";
g_js_strings.commonstr.premier = "Premier";
g_js_strings.commonstr.prev = "Prev";
g_js_strings.commonstr.previous = "Previous";
g_js_strings.commonstr.production = "Production";
g_js_strings.commonstr.profile = "Profile";
g_js_strings.commonstr.promote = "Promote";
g_js_strings.commonstr.province = "Province";
g_js_strings.commonstr.purchase = "Purchase";
g_js_strings.commonstr.purchased = "Purchased";
g_js_strings.commonstr.quantity = "Quantity";
g_js_strings.commonstr.raid = "Raid";
g_js_strings.commonstr.range = "Range";
g_js_strings.commonstr.rank = "Rank";
g_js_strings.commonstr.ranking = "Ranking";
g_js_strings.commonstr.reassign = "Reassign";
g_js_strings.commonstr.recall = "Recall";
g_js_strings.commonstr.reinforce = "Reinforce";
g_js_strings.commonstr.reinforced = "Reinforced";
g_js_strings.commonstr.reject = "Reject";
g_js_strings.commonstr.remove = "Remove";
g_js_strings.commonstr.rename = "Rename";
g_js_strings.commonstr.replace = "Replace";
g_js_strings.commonstr.report = "Report";
g_js_strings.commonstr.reports = "Reports";
g_js_strings.commonstr.reply = "Reply";
g_js_strings.commonstr.requested = "Requested";
g_js_strings.commonstr.required = "Required";
g_js_strings.commonstr.requirement = "Requirement";
g_js_strings.commonstr.requirements = "Requirements";
g_js_strings.commonstr.res = "Res";
g_js_strings.commonstr.research = "Research";
g_js_strings.commonstr.resource = "Resource";
g_js_strings.commonstr.resourcefulness = "Resourcefulness";
g_js_strings.commonstr.resources = "Resources";
g_js_strings.commonstr.returning = "Returning";
g_js_strings.commonstr.reward = "Reward";
g_js_strings.commonstr.roles = "Roles";
g_js_strings.commonstr.ruin = "Ruin";
g_js_strings.commonstr.boss = "Dark Forest";
g_js_strings.commonstr.salary = "Salary";
g_js_strings.commonstr.salaries = "Salaries";
g_js_strings.commonstr.save = "Save";
g_js_strings.commonstr.saveandclose = "Save and Close";
g_js_strings.commonstr.says = "Says";
g_js_strings.commonstr.scout = "Scout";
g_js_strings.commonstr.scouting = "Scouting";
g_js_strings.commonstr.search = "Search";
g_js_strings.commonstr.select = "Select";
g_js_strings.commonstr.sell = "Sell";
g_js_strings.commonstr.selling = "Selling";
g_js_strings.commonstr.send = "Send";
g_js_strings.commonstr.sendtofriends = "Send to Friends";
g_js_strings.commonstr.set = "Set";
g_js_strings.commonstr.get = "Get";
g_js_strings.commonstr.pageshort = "Pg";
g_js_strings.commonstr.share = "Share";
g_js_strings.commonstr.sharetowall = "Share to Wall";
g_js_strings.commonstr.shop = "Shop";
g_js_strings.commonstr.silence = "Silence";
g_js_strings.commonstr.skills = "Skills";
g_js_strings.commonstr.skip = "Skip";
g_js_strings.commonstr.sold = "Sold";
g_js_strings.commonstr.space = "Space";
g_js_strings.commonstr.speed = "Speed";
g_js_strings.commonstr.speedup = "Speed Up";
g_js_strings.commonstr.instantfinish = "Instant Finish";
g_js_strings.commonstr.stable = "Stable";
g_js_strings.commonstr.stat = "Stat";
g_js_strings.commonstr.stats = "Stats";
g_js_strings.commonstr.status = "Status";
g_js_strings.commonstr.steward = "Steward";
g_js_strings.commonstr.stone = "Stone";
g_js_strings.commonstr.subject = "Subject";
g_js_strings.commonstr.submit = "Submit";
g_js_strings.commonstr.subscribe = "Subscribe";
g_js_strings.commonstr.survived = "Survived";
g_js_strings.commonstr.swordsmen = "Swordsmen";
g_js_strings.commonstr.target = "Target";
g_js_strings.commonstr.tech = "Tech";
g_js_strings.commonstr.technology = "Technology";
g_js_strings.commonstr.throneroom = "Throne Room";
g_js_strings.commonstr.time = "Time";
g_js_strings.commonstr.timeremaining = "Time Remaining";
g_js_strings.commonstr.title = "Title";
g_js_strings.commonstr.train = "Train";
g_js_strings.commonstr.totx = "To";
g_js_strings.commonstr.tournament = "Tournament";
g_js_strings.commonstr.train = "Train";
g_js_strings.commonstr.transactions = "Transactions";
g_js_strings.commonstr.transform = "Transform";
g_js_strings.commonstr.transport = "Transport";
g_js_strings.commonstr.transporting = "Transporting";
g_js_strings.commonstr.traps = "Traps";
g_js_strings.commonstr.troops = "Troops";
g_js_strings.commonstr.truce = "Truce";
g_js_strings.commonstr.tutorial = "Tutorial";
g_js_strings.commonstr.type = "Type";
g_js_strings.commonstr.unassign = "Un-Assign";
g_js_strings.commonstr.undefined = "Undefined";
g_js_strings.commonstr.unequip = "Unequip";
g_js_strings.commonstr.upgrade = "Upgrade";
g_js_strings.commonstr.upkeep = "Upkeep";
g_js_strings.commonstr.upward = "Upward";
g_js_strings.commonstr.use = "Use";
g_js_strings.commonstr.vacation = "View";
g_js_strings.commonstr.veterans = "Veterans";
g_js_strings.commonstr.vicechancellor = "Vice Chancellor";
g_js_strings.commonstr.victory = "Victory";
g_js_strings.commonstr.view = "View";
g_js_strings.commonstr.viewcourt = "View Court";
g_js_strings.commonstr.viewmap = "View Map";
g_js_strings.commonstr.visit = "Visit";
g_js_strings.commonstr.wilderness = "Wilderness";
g_js_strings.commonstr.winner = "Winner";
g_js_strings.commonstr.woods = "Woods";
g_js_strings.commonstr.workers = "Workers";
g_js_strings.commonstr.xp = "XP";
g_js_strings.commonstr.yes = "Yes";
g_js_strings.commonstr.yield = "Yield";
g_js_strings.commonstr.youneed = "You Need";
g_js_strings.commonstr.youown = "You Own";
g_js_strings.commonstr.yours = "Yours";
g_js_strings.commonstr.wood = "Wood";
g_js_strings.commonstr.inventory = "Inventory";
g_js_strings.modaltitles = new Object();
g_js_strings.modaltitles.abandoncity = "Abandon City";
g_js_strings.modaltitles.alliance = "Alliance";
g_js_strings.modaltitles.alliancerequest = "Alliance Request";
g_js_strings.modaltitles.appointknight = "Appoint Knight";
g_js_strings.modaltitles.assignrole = "Assign Role";
g_js_strings.modaltitles.assignskills = "Assign Skills";
g_js_strings.modaltitles.blockuser = "Block User";
g_js_strings.modaltitles.buildingnewcity = "Building a New City";
g_js_strings.modaltitles.buildings = "Buildings";
g_js_strings.modaltitles.changedomain = "Change Domain";
g_js_strings.modaltitles.changetaxrate = "Change Tax Rate";
g_js_strings.modaltitles.collectgold = "Collect Gold";
g_js_strings.modaltitles.confirmbuy = "Confirm Buy";
g_js_strings.modaltitles.confirmsale = "Confirm Sale";
g_js_strings.modaltitles.continuesetup = "Continue Setup";
g_js_strings.modaltitles.court = "Court";
g_js_strings.modaltitles.courtlyaction = "Courtly Action";
g_js_strings.modaltitles.deconstructbuild = "Deconstruct Building?";
g_js_strings.modaltitles.cancelconstructbuild = "Cancel Construction?";
g_js_strings.modaltitles.deleteall = "Delete All";
g_js_strings.modaltitles.destroybuild = "Destroy Building?";
g_js_strings.modaltitles.discussion = "Discussion";
g_js_strings.modaltitles.dismissknight = "Dismiss Knight";
g_js_strings.modaltitles.error = "Error!";
g_js_strings.modaltitles.excesstraffic = "Excess Traffic";
g_js_strings.modaltitles.exitbeginnerprotection = "Exit Beginner Protection";
g_js_strings.modaltitles.getmoregems = "Get More Gems";
g_js_strings.modaltitles.giftitem = "Gift an Item";
g_js_strings.modaltitles.helprequest = "Help Request";
g_js_strings.modaltitles.helprequestsent = "Help Request Sent";
g_js_strings.modaltitles.ignoreuser = "Ignore User";
g_js_strings.modaltitles.impatks = "Impending Attacks";
g_js_strings.modaltitles.inchapp = "Increase Happiness";
g_js_strings.modaltitles.knightrewarded = "Knight Rewarded!";
g_js_strings.modaltitles.knightroleassigned = "Knight Assignment";
g_js_strings.modaltitles.leaderboard = "Leaderboard";
g_js_strings.modaltitles.renamecelebration = "Renaming Celebration";
g_js_strings.modaltitles.magiccloak = "Magic Cloak";
g_js_strings.modaltitles.marchinformation = "March Information";
g_js_strings.modaltitles.marchtroops = "March Troops";
g_js_strings.modaltitles.mmb = "Merlin&#39;s Magical Boxes";
g_js_strings.modaltitles.memberdetails = "Member Details";
g_js_strings.modaltitles.messages = "Messages";
g_js_strings.modaltitles.namenewcity = "Name New City";
g_js_strings.modaltitles.notice = "Notice";
g_js_strings.modaltitles.pickavatar = "Pick an Avatar";
g_js_strings.modaltitles.profile = "Profile";
g_js_strings.modaltitles.quests = "Quests";
g_js_strings.modaltitles.renameuser = "Rename User";
g_js_strings.modaltitles.rewardknight = "Reward Knight";
g_js_strings.modaltitles.selectitem = "Select Item";
g_js_strings.modaltitles.sendmessage = "Send Message";
g_js_strings.modaltitles.shop = "Shop";
g_js_strings.modaltitles.silenceuser = "Silence User";
g_js_strings.modaltitles.speedup = "Speed Up";
g_js_strings.modaltitles.speedupmarkettransaction = "Speed up market transaction";
g_js_strings.modaltitles.tournaments = "Tournaments";
g_js_strings.modaltitles.userprofile = "User Profile";
g_js_strings.modaltitles.usersettings = "User Settings";
g_js_strings.modaltitles.wildernessdefense = "Wilderness Defense";
g_js_strings.modal_openBarracks = new Object();
g_js_strings.modal_openBarracks.trainttl = "Train Troops";
g_js_strings.modal_openBarracks.trainingttl = "In Training";
g_js_strings.modal_openBarracks.youown = "You Own";
g_js_strings.modal_openBarracks.dismiss = "Dismiss";
g_js_strings.modal_openBarracks.curintrain = "Currently in Training";
g_js_strings.modal_openBarracks.waittrain = "Troops Waiting to be Trained";
g_js_strings.modal_barracks_dismiss = new Object();
g_js_strings.modal_barracks_dismiss.dismisstroops = "Dismiss Troops";
g_js_strings.modal_barracks_dismiss_confirm = new Object();
g_js_strings.modal_barracks_dismiss_confirm.areyousure = "Dismiss these troops?";
g_js_strings.modal_barracks_dismiss_confirm.confirmttl = "Dismiss Troops Confirmation";
g_js_strings.modal_barracks_train = new Object();
g_js_strings.modal_barracks_train.attack = "Attack";
g_js_strings.modal_barracks_train.speed = "Speed";
g_js_strings.modal_barracks_train.defense = "Defense";
g_js_strings.modal_barracks_train.range = "Range";
g_js_strings.modal_barracks_train.life = "Life";
g_js_strings.modal_barracks_train.load = "Load";
g_js_strings.modal_barracks_train.maximum = "Maximum";
g_js_strings.modal_barracks_train.numtotrain = "# of Troops to Train";
g_js_strings.modal_barracks_train.traintime = "Training Time";
g_js_strings.modal_barracks_train.timereduction = "Time Reduction";
g_js_strings.modal_barracks_train.starttraining = "Start Training";
g_js_strings.modal_barracks_trainingtab = new Object();
g_js_strings.modal_barracks_trainingtab.esttime = "Estimated Time";
g_js_strings.modal_barracks_trainingtab.totaltraintime = "Total Training Time";
g_js_strings.modal_barracks_trainingtab.esttimeremain = "Estimated Time Remaining";
g_js_strings.modal_barracks_trainingtab.completetxt = "Complete";
g_js_strings.modal_barracks_trainingtab.unittypeinfantry = "Infantry";
g_js_strings.modal_barracks_trainingtab.unittyperanged = "Ranged";
g_js_strings.modal_barracks_trainingtab.unittypehorsed = "Horsed";
g_js_strings.modal_barracks_trainingtab.unittypesiege = "Siege";
g_js_strings.modal_barracks_train.gambleLabel0 = "Standard training time";
g_js_strings.modal_barracks_train.gambleLabel = "Reduce training time by %1$s in exchange for %2$sx resources";
g_js_strings.modal_attack = new Object();
g_js_strings.modal_attack.marchtype = "March Type";
g_js_strings.modal_attack.marchtextattack = "This type is used when you are attacking a Wilderness or another player.";
g_js_strings.modal_attack.marchtexttransport = "This type is used when you want to transport resources to a location.";
g_js_strings.modal_attack.marchtextscout = "This type is used when you are scouting a Wilderness or another player.";
g_js_strings.modal_attack.marchtextreinforce = "This type is used when you want to send more Troops or resources to a location.";
g_js_strings.modal_attack.marchtextreassign = "This type is used when you want to move Troops between your Cities.";
g_js_strings.modal_attack.availabletroops = "Available Troops";
g_js_strings.modal_attack.thisisabarbarianraid = "This is a Barbarian Raid";
g_js_strings.modal_attack.thisisabarbarianraidtooltip = "Barbarian Raids can be unlocked at Level 20. Barbarian Raids allow you to loot Barbarian Camps automatically. Raids can be saved by clicking 'Raid and Save' below. The Knight and Troops saved to this raid will be dedicated to raiding the Barbarian Camp location. Raids can be managed from the Rally Point under the 'Barbarian Raids' tab.";
g_js_strings.modal_attack.thisisabarbarianraidtooltipp1 = "Barbarian Raids can be unlocked at Level 20.";
g_js_strings.modal_attack.thisisabarbarianraidtooltipp2 = "Barbarian Raids allow you to loot Barbarian Camps automatically.";
g_js_strings.modal_attack.thisisabarbarianraidtooltipp3 = "Raids can be saved by clicking 'Raid and Save' below.";
g_js_strings.modal_attack.thisisabarbarianraidtooltipp4 = "Saved Raids can be managed from the Rally Point under the 'Barbarian Raids' tab.";
g_js_strings.modal_attack.thisisabarbarianraidtooltipp5 = "Food Guardian march speed boost does not apply to Barbarian Raids.";
g_js_strings.modal_attack.barbarianraidhelpp1 = "Selecting this check box will allow you to save scheduled Raids against a Barbarian Camp of your choosing. Saved Raids can be accessed, managed, and changed via the Rally Point.";
g_js_strings.modal_attack.barbarianraidhelpp2 = "Raids will continuously attack Barbarian Camps, but must be reset at least once a day from the Rally Point for continuous Raiding.";
g_js_strings.modal_attack.barbarianraidhelpp3 = "Beware when you commit your troops for battle in Raids: this strategy can only work against Barbarian Camps, the Troops and Knights dedicated to the Raid will be locked until the Raid is deleted, and all Raids will have a minimum march time of just under 3 minutes. In addition, you can only have as many active Raids and Marches as your Rally Point can allow.";
g_js_strings.modal_attack.selecttroopstext = "Select the number of troops you&#39;d like to send";
g_js_strings.modal_attack.displayscoutonly = "Display Scout Troops only";
g_js_strings.modal_attack.displayingscoutonly = "Displaying Scout Troops only";
g_js_strings.modal_attack.displaysupplyonly = "Display Supply Troops only";
g_js_strings.modal_attack.selectedtroops = "Troops Selected";
g_js_strings.modal_attack.resouresselected = "Resources Selected";
g_js_strings.modal_attack.maxtroops = "Maximum Troops";
g_js_strings.modal_attack.reqfood = "Required Food";
g_js_strings.modal_attack.loadcapacity = "Load Capacity";
g_js_strings.modal_attack.loadvac = "Load Vacancy";
g_js_strings.modal_attack.applyaura = "Apply Aura of Command";
g_js_strings.modal_attack.applyspot = "Apply spot to increase personnel limit by 25%. You own";
g_js_strings.modal_attack.applyauraspot = "Apply Aura of Command to increase your Maximum Troops on this march by 25%.";
g_js_strings.modal_attack.marchto = "March To";
g_js_strings.modal_attack.applyauraconquestspot = "Apply Aura of Conquest to increase your Maximum Troops on this march by 50%.";
g_js_strings.modal_attack.selecttotransport = "Select Items to Transport";
g_js_strings.modal_attack.selecttarget = "Select Target";
g_js_strings.modal_attack.dord = "Or ";
g_js_strings.modal_attack.inpcoor = "input coordinates";
g_js_strings.modal_attack.selbookmark = "select from Bookmarks";
g_js_strings.modal_attack.availableknights = "Available Knights";
g_js_strings.modal_attack.availableAetherstones = "Available Aetherstones";
g_js_strings.modal_attack.availableresources = "Available Resources";
g_js_strings.modal_attack.aetherstoneHint = "Aetherstones are large and strangely heavy, and thus take up more room in soldiers packs.";
g_js_strings.modal_attack.chooseknight = "Choose the knight with the best attack skills.";
g_js_strings.modal_attack.chooseknightlead = "Choose Knight to lead the attack";
g_js_strings.modal_attack.dchooseknightd = "--Choose a Knight--";
g_js_strings.modal_attack.noknightavailable = "--No Knights Available--";
g_js_strings.modal_attack.betterattackhint = "The better the attack skills, the better they will do.";
g_js_strings.modal_attack.speedboosts = "Speed Boosts";
g_js_strings.modal_attack.marchboosts = "March Boosts";
g_js_strings.modal_attack.attackboosts = "Attack Boosts";
g_js_strings.modal_attack.defenseboosts = "Defense Boosts";
g_js_strings.modal_attack.idleknightshint = "Only Idle knights - those not already leading a march and not already assigned to a role - are allowed to lead a march.";
g_js_strings.modal_attack.decreasemarch = "Decrease March Time to Target";
g_js_strings.modal_attack.increaseattack = "Increase Attack Efforts";
g_js_strings.modal_attack.overmarch = "At the current city's rally point level, additional marches cannot be sent out. <br/>Please try a different city, upgrade rally point, or recall and wait for outside marches to return.";
g_js_strings.modal_attack.overmarch21 = "At the current city's rally point level, additional marches and raids cannot be sent out.";
g_js_strings.modal_attack.overmarch22 = "Please try a different city, upgrade rally point, delete raids, or recall and wait for outside marches to return.";
g_js_strings.modal_attack.alliance = "You are unable to scout/attack a member of your alliance.";
g_js_strings.modal_attack.estimatedmarchtime = "Estimated March Time";
g_js_strings.modal_attack.youhave = "You have";
g_js_strings.modal_attack.raidandsave = "Raid and Save";
g_js_strings.modal_attack.useractionwarningtitle = "WARNING!";
g_js_strings.modal_attack.useractionwarningmessage = "Caution! You have been performing this action at a very high rate.  Continuing at this pace may affect your ability to perform this action.";
g_js_strings.modal_attack.useractionwarningiunderstand = "I understand";
g_js_strings.modal_attack.useractioncaptchap1 = "We've noticed you've been performing a large amount of actions in a short period of time. Please confirm that you are still playing by following the instructions below:";
g_js_strings.modal_attack.useractioncaptchap2 = "To avoid seeing these messages in the future, please lower the frequency of these actions.";
g_js_strings.modal_attack_target_dropdown = new Object();
g_js_strings.modal_attack_target_dropdown.choosebookmark = "Choose Bookmark";
g_js_strings.modal_questions = new Object();
g_js_strings.modal_questions.question = "Are you sure?";
g_js_strings.modal_questions.abandon = "Are you sure you want to abandon that ";
g_js_strings.attack_generateincoming = new Object();
g_js_strings.attack_generateincoming.impendingattack = "Impending Attack!";
g_js_strings.attack_generateincoming.estimatedarrival = "Estimated Arrival";
g_js_strings.attack_generateincoming.lostreadguide = "Lost? Read the Guide!";
g_js_strings.attack_generateincoming.protecteddays = "You are protected for %1$s more days and cannot attack or be attacked by players.";
g_js_strings.attack_generateincoming.unprotecteddays = "You are no longer under beginner protection and can be attacked by other players.";
g_js_strings.attack_viewimpending_view = new Object();
g_js_strings.attack_viewimpending_view.upgradetoseeinfo = "Upgrade Watch Tower";
g_js_strings.attack_viewimpending_view.armysize = "Army Size";
g_js_strings.attack_viewimpending_view.knightcomlvl = "Knight Combat Level";
g_js_strings.attack_viewimpending_view.incomingtroops = "Incoming Troops";
g_js_strings.attack_viewimpending_view.techlevels = "Research Levels";
g_js_strings.attack_viewimpending_view.troophideoption = "Remember that you can set your troops to defend or hide them in sanctuary by choosing &#39;Hide troops in sanctuary&#39; or &#39;Order troops to defend city&#39; after you have clicked on your Castle in the City view.";
g_js_strings.attack_viewimpending_view.gotowatchtower = "Go to Watch Tower";
g_js_strings.attack_generatequeue = new Object();
g_js_strings.attack_generatequeue.waitreport = "Waiting for Report";
g_js_strings.attack_generatequeue.raidstopped = "Raid Stopped";
g_js_strings.attack_generatequeue.raidresting = "Raid Resting";
g_js_strings.attack_generatequeue.unloadingloot = "Unloading Loot";
g_js_strings.modal_wilderness_buildcity = new Object();
g_js_strings.modal_wilderness_buildcity.namecity = "Name Your City";
g_js_strings.modal_attack_do = new Object();
g_js_strings.modal_attack_do.sendtroop = "You must send at least one troop on a march";
g_js_strings.modal_attack_do.transportitem = "You must transport something";
g_js_strings.modal_attack_do.sendscout = "You must send at least one Scout";
g_js_strings.modal_attack_do.sendknight = "You must send a Knight on Attack";
g_js_strings.modal_attack_do.specifytarget = "You must specify a valid target for a march";
g_js_strings.modal_attack_do.selectbarbariancamps = "You have selected a target that is not a Barbarian Camp. Barbarian Raids can only be conducted against Barbarian Camps.";
g_js_strings.modal_attack_check = new Object();
g_js_strings.modal_attack_check.warning = "Warning! You are in danger of losing the Mists of Avalon!";
g_js_strings.modal_attack_check.warningdesc = "If you attack or scout a player-controlled territory while you are under the Mists of Avalon, the Mists will dissipate and your territories will be visible to all players. Do you still wish to attack?";
g_js_strings.modal_attack_check.marchon = "March On";
g_js_strings.modal_attack_check.canmarch = "Cancel March";
g_js_strings.modal_build_help_tooltip = new Object();
g_js_strings.modal_build_help_tooltip.friendbuildtimedesc = "For each friend that clicks on your feed, the build time will be reduced by one minute, up to a maximum of a 10 minute reduction.";
g_js_strings.modal_build_help_tooltip.newfriendbuildtimedesc = "For each friend that clicks on your feed, the build time will be reduced by either 1 minute or 1% whichever is greater. Up to 10 friends can speed up your build.";
g_js_strings.modal_build_help_tooltip.newfriendbuildtimedesc1 = "Share a story to your wall asking your friends for help with your build. For each friend that clicks on your wall story, the remaining time will be reduced by either 1 minute or 1% whichever is greater, up to ten times";
g_js_strings.modal_build_demolish = new Object();
g_js_strings.modal_build_demolish.deconstructiondesc = "Deconstruction takes time and gives back few resources for buildings of level higher than 1";
g_js_strings.modal_build_demolish.destroydesc = "Destroy building immediately using Dragon's Stomp. You will not get any resources out of this destruction.";
g_js_strings.modal_build = new Object();
g_js_strings.modal_build.usedragon = "Uses 1 Dragon&#39;s Stomp";
g_js_strings.modal_build.abandoncity = "Abandon City";
g_js_strings.modal_build.divineinsp = "Divine Inspiration";
g_js_strings.modal_build.divineprov = "Divine Providence";
g_js_strings.modal_build.withhelp = "with Help";
g_js_strings.modal_build.andshare = "and Share";
g_js_strings.modal_build.buildandshare = "Build and Share";
g_js_strings.modal_build.upgradeandshare = "Upgrade and Share";
g_js_strings.modal_build.buildandaskhelp = "Build and ask for help";
g_js_strings.modal_build.upgradeandaskhelp = "Upgrade and ask for help";
g_js_strings.modal_build.sharemessagebuildorresearch = "Share a message to your wall and alliance chat asking for help reducing your build or research time.";
g_js_strings.modal_build.manualbuild = "Manual Build";
g_js_strings.modal_build.manualupgrade = "Manual Upgrade";
g_js_strings.modal_build.buildtime = "Build Time";
g_js_strings.modal_build.asquickas = "as quick as";
g_js_strings.modal_build.timeremaining = "Time Remanining";
g_js_strings.modal_build.cancelcurrconstuct = "Cancel Current Construction";
g_js_strings.modal_build.buildoneattime = "You can only build one<br/>building at a time.";
g_js_strings.modal_build.reqnotmet = "Requirements for this<br/>building have not been met.";
g_js_strings.modal_build.reducebuildtimedesc = "Reduce build time when you ask your friends to help. For each friend that clicks on your feed, the build time will be reduced by one minute, up to a maximum of a 10 minute reduction.";
g_js_strings.modal_build.newreducebuildtimedesc = "Reduce build time when you ask your friends to help. For each friend that clicks on your feed, the build time will be reduced by either 1 minute or 1% whichever is greater. Up to 10 friends can speed up your build.";
g_js_strings.modal_build.newbuilding = "New Building";
g_js_strings.modal_build.whatsthis = "what&#39;s this?";
g_js_strings.modal_build.whatsthiscontent = "Reduce build or research time by sharing a story to your Wall and to your Alliance chat asking for help.  For each friend or Alliance member that clicks on the provided link, the build or research time will reduced by one minute or 1% (whichever is greater) up to a maximum of 5 friends and 5 Alliance members.";
g_js_strings.modal_build.mintime = "Min. time";
g_js_strings.modal_build.bonusinfo = "* This will increase if you have bonuses applied ";
g_js_strings.deconstructBuilding = new Object();
g_js_strings.deconstructBuilding.lvl1deconstructdesc = "Level 1 buildings can be deconstructed immediately and no resources are returned back";
g_js_strings.deconstructBuilding.deconstructtakes = "Deconstructing this building takes %1$s and you will get";
g_js_strings.deconstructBuilding.deconstructinvalid = "Deconstruction is not valid";
g_js_strings.destructBuilding = new Object();
g_js_strings.destructBuilding.needtodestruct = "You need %1$s to destroy this building immediately.";
g_js_strings.destructbuildingconfirm = new Object();
g_js_strings.destructbuildingconfirm.builddestroyed = "Building Destroyed!";
g_js_strings.cancelTraining = new Object();
g_js_strings.cancelTraining.canceltrainingtitle = "Cancel Training?";
g_js_strings.cancelTraining.canceltraining = "Cancel Training";
g_js_strings.cancelTraining.canceltrainingtakes = "Cancelling this training will get";
g_js_strings.cancelFortification = new Object();
g_js_strings.cancelFortification.cancelfortificationtitle = "Cancel Fortification?";
g_js_strings.cancelFortification.cancelfortification = "Cancel Fortification";
g_js_strings.cancelFortification.cancelfortificationtakes = "Cancelling this fortification will get";
g_js_strings.cancelconstruction = new Object();
g_js_strings.cancelconstruction.cancelconstructiontitle = "Cancel Construction?";
g_js_strings.cancelconstruction.cancelconstruction = "Cancel Construction";
g_js_strings.cancelconstruction.cancelconstructiontakes = "Cancelling this construction will get";
g_js_strings.cancelconstruction.cancelconstructionloseitem = "Warning: cancelling this construction will NOT return {itemName}!";
g_js_strings.loyalBoost_modal = new Object();
g_js_strings.loyalBoost_modal.rewardknight = "Reward your knight to increase loyalty";
g_js_strings.loyalBoost_modal.rewardwith = "Reward with";
g_js_strings.loyalBoost_modal.rewardknightgolddesc = "Reward knight with %1$s Gold to increase his/her loyalty by 5";
g_js_strings.loyalBoost_modal.notenoughgold = "You don't have enough Gold for this.";
g_js_strings.loyalBoost_modal.skillpointsapplied = "Skill Points applied";
g_js_strings.reward_confirm_modal = new Object();
g_js_strings.reward_confirm_modal.increasedbygold = "%1$s Gold has increased knight's loyalty by %2$s";
g_js_strings.reward_confirm_modal.increasedbytrophy = "%1$s has increased knight's loyalty by %2$s";
g_js_strings.assign_role_modal = new Object();
g_js_strings.assign_role_modal.assignroles = "Assign Roles";
g_js_strings.assign_role_modal.currentrole = "Current Role";
g_js_strings.assign_role_modal.foremandesc = "This Knight will use their Politics to help build your city more quickly.";
g_js_strings.assign_role_modal.marshaldesc = "This Knight will use their Combat to help quicken the training of your troops.";
g_js_strings.assign_role_modal.alchedesc = "This Knight will use their Intelligence to help run your Alchemist Lab.";
g_js_strings.assign_role_modal.stewarddesc = "This Knight will use their Resourcefulness to improve your Resource production.";
g_js_strings.assign_role_modal.roleconfirm = "You have assigned %1$s as %2$s's %3$s.";
g_js_strings.assign_role_modal.keepittoyourself = "Keep it to yourself";
g_js_strings.dismiss_modal = new Object();
g_js_strings.dismiss_modal.dismissknightconfirm = "Are you sure you want to dismiss Knight %1$s?";
g_js_strings.assign_skill_modal = new Object();
g_js_strings.assign_skill_modal.assignedskills = "Assigned Skills";
g_js_strings.assign_skill_modal.skillptsunassigned = "Skill Points Unassigned";
g_js_strings.assign_skill_modal.redistributeskills = "Re-distribute Skills";
g_js_strings.assign_skill_modal.foremantooltip = "Helps your Foreman increase your Construction speed";
g_js_strings.assign_skill_modal.marshaltooltip = "Helps your Marshal increase your Training speed, and helps any Knight involved in combat to better lend their power to your Troops";
g_js_strings.assign_skill_modal.alchetooltip = "Helps your Alchemystic increase your Research speed";
g_js_strings.assign_skill_modal.stewardtooltip = "Helps your Steward increase your Resource Production";
g_js_strings.modal_openAlchemy = new Object();
g_js_strings.modal_openAlchemy.resitms = "Research Items";
g_js_strings.modal_openAlchemy.currentlyres = "Currently being researched.";
g_js_strings.modal_openAlchemy.reshelp = "Research with Help";
g_js_strings.modal_openAlchemy.res_share = "Research and Share";
g_js_strings.modal_openAlchemy.reshelp_tooltip = "Share a story to your wall asking your friends for help with your research. For each friend that clicks on your wall story, the remaining time will be reduced by either 1 minute or 1% whichever is greater, up to ten times!";
g_js_strings.modal_openAlchemy.resalone = "Research Alone";
g_js_strings.modal_openAlchemy.reqnotmet = "Requirements not met.";
g_js_strings.modal_openAlchemy.maxres = "Maximum Research Level.";
g_js_strings.showMyKnights = new Object();
g_js_strings.showMyKnights.unasspts = "Unassigned Skill Points";
g_js_strings.showMyKnights.xpnextlvl = "%1$s XP to next level";
g_js_strings.showMyKnights.increasexp = "Increase XP";
g_js_strings.showMyKnights.assignskill = "Assign Skill";
g_js_strings.showMyKnights.assignrole = "Assign Role";
g_js_strings.openCastle = new Object();
g_js_strings.openCastle.inchappiness = "Increase Happiness";
g_js_strings.openCastle.incgold = "Increase Gold";
g_js_strings.openCastle.chgtaxrate = "Change Tax Rate";
g_js_strings.openCastle.hidesanct = "Hide troops in sanctuary.";
g_js_strings.openCastle.orderdefend = "Order troops to defend city.";
g_js_strings.openCastle.resprod = "Resource Production";
g_js_strings.openCastle.baseprod = "Base Production";
g_js_strings.openCastle.knightbonus = "Knight Bonus";
g_js_strings.openCastle.resbonus = "Research Bonus";
g_js_strings.openCastle.wildbonus = "Wilderness Bonus";
g_js_strings.openCastle.provbonus = "Providence Bonus";
g_js_strings.openCastle.itembonus = "Item Bonus";
g_js_strings.openCastle.totalprod = "Total Production";
g_js_strings.openCastle.guardianbonus = "Guardian Bonus";
g_js_strings.changeTax = new Object();
g_js_strings.changeTax.changetaxdesc = "Change the % of tax that you collect from your population.";
g_js_strings.changeTax.newtaxrate = "New Tax Rate";
g_js_strings.changeTax.entertaxrate = "Enter a Tax Rate between 0 and 100";
g_js_strings.changeTax.taxrate = "Tax Rate";
g_js_strings.modal_change_tax = new Object();
g_js_strings.modal_change_tax.taxratenochangealert = "We were unable to change your tax rate.  Please try again later.";
g_js_strings.modal_change_tax_confirm = new Object();
g_js_strings.modal_change_tax_confirm.yourtaxrate = "Your Tax Rate is now";
g_js_strings.raiseGold = new Object();
g_js_strings.raiseGold.notenoughgold = "You don&#39;t have enough Happiness to raise gold.";
g_js_strings.raiseGold.collectgolddesc = "Collect Gold from your subjects.  This will decrease their Happiness.";
g_js_strings.raiseGold.goldcollected = "Gold to be Collected";
g_js_strings.raiseGold.happdecreased = "Happiness to be Decreased";
g_js_strings.modal_raise_gold_confirm = new Object();
g_js_strings.modal_raise_gold_confirm.yourgoldinc = "Your gold has increased to";
g_js_strings.increaseHappiness = new Object();
g_js_strings.increaseHappiness.increasehappdesc = "Increase the happiness of the people in your kingdom.";
g_js_strings.increaseHappiness.happinc = "Happiness Increase";
g_js_strings.modal_increase_happiness_confirm = new Object();
g_js_strings.modal_increase_happiness_confirm.yourhapp = "Your happiness is now";
g_js_strings.openKnights = new Object();
g_js_strings.openKnights.appknights = "Appoint Knights";
g_js_strings.openKnights.myknights = "My Knights";
g_js_strings.openKnights.resheading = "Resource-<br/>fulness";
g_js_strings.openKnights.intheading = "Intelli-<br/>gence";
g_js_strings.openKnights.goldhourly = "gold hourly";
g_js_strings.openKnights.playerskills = "Knights who are players of the game will gain +5 to all Skills.";
g_js_strings.openKnights.friendsplaykofc = "Friends who play Kingdoms of Camelot make better knights.";
g_js_strings.modal_appoint = new Object();
g_js_strings.modal_appoint.appointasknight = "Appoint this person as a knight?";
g_js_strings.modal_appoint.appointfee = "Appointment Fee";
g_js_strings.modal_appoint.knightskills = "Appointment Fee";
g_js_strings.modal_appoint.knightskillsdesc = "As your knights gain skill points, you can distribute it among their skills.";
g_js_strings.modal_appoint.appointknight = "Appoint as Knight";
g_js_strings.modal_appoint.notplayer = "%1$s is not a player.";
g_js_strings.modal_appoint.notplayerdesc = "Players get +5 to all skill points when they join.";
g_js_strings.modal_appoint.inviteappointknight = "Invite & Appoint as Knight";
g_js_strings.modal_appoint.knightslevelup = "Knights who play will level up twice as fast.";
g_js_strings.inviteKnight = new Object();
g_js_strings.inviteKnight.invitemessageswaves = "Hail friend! Think you have what it takes to be the mightiest Lord or Lady around? Come join me in Kingdoms of Camelot at https://apps.facebook.com/kingdomsofcamelot/?entrypt=swaves, where you can grow your kingdom before your eyes, browse the map for lands to conquer, and strategically grow your army to become the mightiest Lord or Lady in Camelot!";
g_js_strings.inviteKnight.invitemessage = "Hail friend! Think you have what it takes to be the mightiest Lord or Lady around? Come join me in Kingdoms of Camelot at https://apps.facebook.com/kingdomsofcamelot, where you can grow your kingdom before your eyes, browse the map for lands to conquer, and strategically grow your army to become the mightiest Lord or Lady in Camelot!";
g_js_strings.inviteKnight.invitesubj = "Join Kingdoms of Camelot";
g_js_strings.inviteKnight.unabletopay = "Unable to pay the costs";
g_js_strings.appointKnight = new Object();
g_js_strings.appointKnight.knightsuccess = "This person was successfully knighted!";
g_js_strings.modal_buildnew = new Object();
g_js_strings.modal_buildnew.whatbuild = "What do you want to build?";
g_js_strings.modal_buildnew.clicktoview = "Click %1$sSelect%2$s to view requirements and building information";
g_js_strings.modal_buildnew.reqnotmet = "Requirements<br/>not met";
g_js_strings.modal_buildnew.viewinfo = "View Info";
g_js_strings.protect_off_confirm = new Object();
g_js_strings.protect_off_confirm.lvlupwarning = "By upgrading to a Level 5 Castle, you will exit Beginner Protection.  Would you like to build anyway?";
g_js_strings.showMyWilderness = new Object();
g_js_strings.showMyWilderness.conqueredwild = "Conquered Wilds";
g_js_strings.modal_openRallypoint = new Object();
g_js_strings.modal_openRallypoint.mytroops = "My Troops";
g_js_strings.modal_openRallypoint.troopmove = "Troop Movement";
g_js_strings.modal_openRallypoint.raidtooltip = "Unlock at Level 20";
g_js_strings.modal_openRallypoint.marchtroops = "March Troops";
g_js_strings.modal_openRallypoint_movement = new Object();
g_js_strings.modal_openRallypoint_movement.marchtype = "March Type";
g_js_strings.modal_openRallypoint_movement.tgtloc = "Target Location";
g_js_strings.view_march = new Object();
g_js_strings.view_march.rescarr = "Resources carried";
g_js_strings.openEmbassy = new Object();
g_js_strings.openEmbassy.viewall = "View Alliances";
g_js_strings.openEmbassy.encampall = "Encamped Allies";
g_js_strings.openEmbassy.sentfrom = "Sent From";
g_js_strings.openEmbassy.senthome = "Send Home";
g_js_strings.openEmbassy.noallcamp = "No Allies Encamped";
g_js_strings.kickout_allies = new Object();
g_js_strings.kickout_allies.troopshome = "Troops sent home!";
g_js_strings.modal_marketplace = new Object();
g_js_strings.modal_marketplace.currmkt = "Current Market";
g_js_strings.modal_marketplace.youract = "Your Account";
g_js_strings.modal_marketplace.provincedesc = "This market serves all Lords and Ladies in your province";
g_js_strings.modal_marketplace.provincerestr = "Please note, you will only see transactions within this Province.";
g_js_strings.modal_marketplace.resamt = "Resource Amount";
g_js_strings.modal_marketplace.roundingdesc = "Transaction amounts will be rounded down to the nearest 1,000 resources.";
g_js_strings.modal_marketplace.unitprice = "Unit Price";
g_js_strings.modal_marketplace.tradefee = "Market Tax";
g_js_strings.modal_marketplace.percdesc = "0.5% of the Total Price will be charged for every transaction.";
g_js_strings.modal_marketplace.totalcost = "Total Cost";
g_js_strings.modal_marketplace.pendingoffers = "Pending Offers";
g_js_strings.modal_marketplace.tradestatus = "Trading Status";
g_js_strings.modal_marketplace.newpercdesc = "Market Tax: 0.5% of the Sale Price for each posting";
g_js_strings.modal_marketplace_cancel = new Object();
g_js_strings.modal_marketplace_cancel.transcancel = "Transaction Cancelled!";
g_js_strings.modal_marketplace_viewtransactions = new Object();
g_js_strings.modal_marketplace_viewtransactions.totalprice = "Total Price";
g_js_strings.modal_marketplace_viewtransactions.amttraded = "Amount Traded";
g_js_strings.modal_marketplace_viewtransactions.esttime = "Estimated Time";
g_js_strings.modal_marketplace_buysell = new Object();
g_js_strings.modal_marketplace_buysell.totalcost = "Total Cost";
g_js_strings.modal_marketplace_buysell.totalearned = "Total Earned";
g_js_strings.modal_marketplace_changerec = new Object();
g_js_strings.modal_marketplace_changerec.numrequested = "%1$s requested";
g_js_strings.modal_marketplace_changerec.numsale = "%1$s for sale";
g_js_strings.modal_marketplace_bidoffer = new Object();
g_js_strings.modal_marketplace_bidoffer.invalidprice = "Invalid price";
g_js_strings.modal_marketplace_bidoffer.invalidamt = "Invalid amount";
g_js_strings.modal_marketplace_bidoffer.buyink = "You must buy at least 1,000 resources.";
g_js_strings.modal_marketplace_bidoffer.sellink = "You must sell at least 1,000 resources.";
g_js_strings.modal_marketplace_bidoffer.greaterthan = "Unit price must be greater than 0.";
g_js_strings.modal_marketplace_bidoffer.atleast = "Unit price must be at least 0.001.";
g_js_strings.modal_marketplace_bidoffer.tradesub = "Trade Submitted!";
g_js_strings.modal_marketplace_bidoffer.nogold = "Not enough gold for trade.";
g_js_strings.modal_marketplace_bidoffer.noresource = "Not enough resources for trade.";
g_js_strings.modal_marketplace_bidoffer.nogoldfortax = "You do not have enough Gold for the Tax";
g_js_strings.modal_marketplace_bidoffer.noresourceforsale = "You do not have enough %1$s to make this Sale";
g_js_strings.modal_marketplace_bidoffer.nogoldforpurchase = "You do not have enough Gold for this purchase";
g_js_strings.market_update_num_of_transaction = new Object();
g_js_strings.market_update_num_of_transaction.maxtransac = "You cannot engage in any more transactions.";
g_js_strings.market_update_num_of_transaction.upgrademarket = "Upgrade your %1$s to unlock more transactions.";
g_js_strings.modal_quests = new Object();
g_js_strings.modal_quests.enlistfriends = "Enlist Friends";
g_js_strings.modal_quests.askhelp = "Ask for Help";
g_js_strings.modal_quests.buildcott = "Build a Cottage";
g_js_strings.modal_quests.domexpan = "Domain Expansion";
g_js_strings.modal_quests.buildfarm = "Build a Farm";
g_js_strings.modal_quests.questdesc = "Quest Description";
g_js_strings.modal_quests.buildfarmdesc = "Loyal subjects need Food, and a place to work. Build a Farm to solve both problems at once!";
g_js_strings.modal_quests.questobj = "Quest Objective";
g_js_strings.modal_quests.farlvl1 = "Farm reaches level 1";
g_js_strings.modal_quests.questrwd = "Quest Reward";
g_js_strings.modal_quests.getrwd = "Get Reward";
g_js_strings.modal_quests.squireandfood = "Squire&#39;s Hourglass 1<br/>Food 100";
g_js_strings.modal_quests.andshare = "and share";
g_js_strings.modal_quests.andnotshare = "without sharing";
g_js_strings.quest_string_objective = new Object();
g_js_strings.quest_string_objective.areachlvlb = "%1$s reaches level %2$s.";
g_js_strings.quest_string_objective.raisegolda = "Raise gold income to %1$s.";
g_js_strings.quest_string_objective.raisepopa = "Raise population cap to %1$s.";
g_js_strings.quest_string_objective.increaseaprodb = "Increase %1$s Base Production to %2$s.";
g_js_strings.quest_string_objective.conqueraofb = "Conquer a %1$s of Level %2$s or greater.";
g_js_strings.quest_string_objective.constructabbdgs = "Construct a total of %1$s %2$s buildings.";
g_js_strings.quest_string_objective.buildsecond = "Build a second city";
g_js_strings.quest_string_objective.mightreachesa = "Might reaches %1$s.";
g_js_strings.quest_string_objective.appointfriendknight = "Appoint a friend as a Knight in the Knights&#39; Hall";
g_js_strings.quest_string_objective.appointknightrole = "Appoint a Knight as your Foreman, Steward, Marshal, or Alchemystic";
g_js_strings.quest_string_objective.changetaxrate = "Change your Tax Rate to 20%";
g_js_strings.quest_string_objective.secondcity = "Have 10 of your friends playing Kingdoms of Camelot.";
g_js_strings.quest_string_objective.changetaxrate = "Change your Tax Rate to 20%";
g_js_strings.quest_string_objective.obtain4a2b1c = "Obtain 4 %1$s, 2 %2$s, 1 %2$s.";
g_js_strings.quest_string_objective.obtain4a3b1c = "Obtain 4 %1$s, 3 %2$s, 1 %2$s.";
g_js_strings.quest_string_objective.obtain4a3b2c = "Obtain 4 %1$s, 3 %2$s, 2 %2$s.";
g_js_strings.quest_string_objective.citybuildreinforce = "Reinforce a %1$s with 250 %2$s carrying 10,000 each of %3$s, %4$s, %5$s, %6$s, and %7$s.";
g_js_strings.quest_string_objective.collectresource = "Collect %1$s %2$s.";
g_js_strings.quest_string_objective.craftitem = "Craft %1$s %2$s.";
g_js_strings.popOverShareLayer = new Object();
g_js_strings.popOverShareLayer.sharetitle = "You've collected your reward!";
g_js_strings.popOverShareLayer.sharedesc = "Now share a bonus chest with your friends.  Each chest contains 20,000 free resources!";
g_js_strings.modal_tourny_changetab = new Object();
g_js_strings.modal_tourny_changetab.notourny = "There are no tournaments for this tab currently.";
g_js_strings.modal_tourny_changetab.lordladyname = "Lord/Lady Name";
g_js_strings.modal_tourny_changetab.chancellorname = "Chancellor Name";
g_js_strings.modal_tourny_changetab.mightgained = "Might Gained";
g_js_strings.modal_tourny_changetab.rewardperplayer = "Reward per Player";
g_js_strings.changeview_court_content = new Object();
g_js_strings.changeview_court_content.havefeast = "Have a Feast";
g_js_strings.changeview_court_content.gohunt = "Go Hunting";
g_js_strings.changeview_court_content.commsculpt = "Commission Sculpture";
g_js_strings.changeview_court_content.inspectmines = "Inspect Mines";
g_js_strings.changeview_court_content.bonusfood = "bonus to food";
g_js_strings.changeview_court_content.bonuswood = "bonus to wood";
g_js_strings.changeview_court_content.bonusstone = "bonus to stone";
g_js_strings.changeview_court_content.bonusore = "bonus to ore";
g_js_strings.changeview_court_content.numofcities = "# of Cities";
g_js_strings.changeview_court_content.givegift = "Give Gift";
g_js_strings.changeview_court_content.invitealli = "Invite to Alliance";
g_js_strings.changeview_court_content.myitems = "My Items";
g_js_strings.changeview_court_content.courtlyactions = "Courtly Action";
g_js_strings.changeview_court_content.invitedesc = "%1$s %2$s, I cordially invite you to do one of these royal activites with me:";
g_js_strings.changeview_court_content.viewfbprofile = "View Facebook Profile";
g_js_strings.MapObject = new Object();
g_js_strings.MapObject.bcitydesc = "Barbarian Camps contain invaders and can be scouted or attacked.";
g_js_strings.MapObject.lakedesc = "Conquering these Lakes increases your<br/>Food production by ";
g_js_strings.MapObject.woodsdesc = "Conquering these Woods increases your<br/>Wood production by ";
g_js_strings.MapObject.grassdesc = "Conquering these Grasslands increases your<br/>Food production by ";
g_js_strings.MapObject.hillsdesc = "Conquering these Hills increases your<br/>Stone production by ";
g_js_strings.MapObject.mtndesc = "Conquering these Mountains increases your<br/>Ore production by ";
g_js_strings.MapObject.plaindesc = "You can build cities on Plains.";
g_js_strings.MapObject.ruindesc = "Conquering these Ruins increases your<br/>Stone production by ";
g_js_strings.MapObject.bogdesc = "Bogs are impenetrable, and cannot be attacked.";
g_js_strings.MapObject.begprotect = "Beginner Protection";
g_js_strings.MapObject.cityname = "City Name";
g_js_strings.MapObject.bcitydesc2 = "Barbarian Camps contain invaders and can be scouted or attacked.";
g_js_strings.MapObject.lakedesc2 = "Conquer to receive %1$s to food production";
g_js_strings.MapObject.woodsdesc2 = "Conquer to receive %1$s to wood production";
g_js_strings.MapObject.grassdesc2 = "Conquer to receive %1$s to food production";
g_js_strings.MapObject.hillsdesc2 = "Conquer to receive %1$s to stone production";
g_js_strings.MapObject.mtndesc2 = "Conquer to receive %1$s to ore production";
g_js_strings.MapObject.plaindesc2 = "You can build cities on Plains.";
g_js_strings.MapObject.bogdesc2 = "Bogs are impenetrable and cannot be attacked.";
g_js_strings.MapObject.bossdesc2 = "Sinister things are happening in this dark forest...";
g_js_strings.MapObject.ownedby = "Owned By";
g_js_strings.MapObject.ownedbyyou = "Owned By You";
g_js_strings.modal_messages = new Object();
g_js_strings.modal_messages.viewreports = "View Reports";
g_js_strings.modal_messages.backinbox = "Back to Inbox";
g_js_strings.modal_messages.blockuser = "Block this user";
g_js_strings.modal_messages.markread = "Mark as Read";
g_js_strings.modal_messages.markunread = "Mark as Unread";
g_js_strings.modal_messages.deleteall = "Delete All";
g_js_strings.modal_messages.unchkall = "Uncheck All";
g_js_strings.modal_messages.chkall = "Check All";
g_js_strings.modal_messages.msgsettings = "Settings";
g_js_strings.modal_messages.forwardtag = "Forwarded message from";
g_js_strings.modal_messages_send = new Object();
g_js_strings.modal_messages_send.enterexistingname = "Please enter an existing username.";
g_js_strings.modal_messages_send.oopscompose = "Oops - Email Error";
g_js_strings.modal_messages_send.msgsent = "Message Sent!";
g_js_strings.modal_messages_send.msgnotsent = "Message Not Sent!";
g_js_strings.modal_messages_viewtrades_view = new Object();
g_js_strings.modal_messages_viewtrades_view.fromatob = "from %1$s to %2$s";
g_js_strings.modal_messages_viewtrades_view.unitprice = "Unit Price";
g_js_strings.modal_messages_viewtrades_view.costofa = "Cost of %1$s";
g_js_strings.modal_messages_viewtrades_view.mktfee = "Marketplace Fee";
g_js_strings.modal_messages_viewtrades_view.totalgold = "Total Gold Spent";
g_js_strings.modal_messages_viewtrades_view.res30min = "Resources take 30 minutes to arrive.";
g_js_strings.modal_messages_viewtrades_view.goldearned = "Gold earned over this period";
g_js_strings.modal_messages_viewtrades = new Object();
g_js_strings.modal_messages_viewtrades.viewmarch = "View March Reports";
g_js_strings.modal_messages_viewtrades.viewtroop = "View Troop Reports";
g_js_strings.modal_messages_viewtrades.viewdisaster = "View City Reports";
g_js_strings.modal_messages_viewtrades.viewmkt = "Market Trades";
g_js_strings.modal_messages_viewtrades.viewrpt = "View Report";
g_js_strings.modal_messages_viewtrades.notrades = "No Trades!";
g_js_strings.modal_messages_viewdisasterreports = new Object();
g_js_strings.modal_messages_viewdisasterreports.viewmkttrades = "View Market Trades";
g_js_strings.modal_messages_viewdisasterreports.disasterrpts = "City Reports";
g_js_strings.modal_messages_viewdisasterreports.troopsdeserted = "Troops Deserted!";
g_js_strings.modal_messages_viewdisasterreports.troopsrecovered = "Troops Recovered";
g_js_strings.modal_messages_viewdisasterreports.rewardmsg = "Reward bonus for battle on %1$s";
g_js_strings.modal_messages_viewdisasterreports.helpedmsg = "%1$s people helped you search the battlefield and found the following survivors and resources:";
g_js_strings.modal_messages_viewdisasterreports.helpedmsg_1 = "%1$s of your friends helped you search the battlefield and found the following survivors and resources:";
g_js_strings.modal_messages_viewdesertionreports = new Object();
g_js_strings.modal_messages_viewdesertionreports.cityunableprovideenoughfood = "<span class='highlightedText'>Your City, {city.name},</span> was unable to provide enough food to feed your army attached to that city! As a result of your inability to keep your troops rationed, a number of them have <span class='highlightedText'>deserted at {date}.</span>";
g_js_strings.modal_messages_viewdesertionreports.cityunableprovideenoughfoodyourcity = "Your City";
g_js_strings.modal_messages_viewdesertionreports.cityunableprovideenoughfoodmain = "was unable to provide enough food to feed your army attached to that city! As a result of your inability to keep your troops rationed, a number of them have";
g_js_strings.modal_messages_viewdesertionreports.cityunableprovideenoughfooddesertedat = "deserted at";
g_js_strings.modal_messages_viewdesertionreports.lost = "Lost";
g_js_strings.modal_messages_viewdesertionreports.attimeofdesertion = "At time of desertion:";
g_js_strings.modal_messages_viewdesertionreports.produced = "Produced:";
g_js_strings.modal_messages_viewdesertionreports.foodproduced = "Food Produced";
g_js_strings.modal_messages_viewdesertionreports.consumed = "Consumed:";
g_js_strings.modal_messages_viewdesertionreports.foodconsumed = "Food Consumed";
g_js_strings.modal_messages_viewdesertionreports.deficit = "deficit:";
g_js_strings.modal_messages_viewdesertionreports.fooddeficit = "deficit";
g_js_strings.modal_messages_viewdesertionreports.note = "Note:";
g_js_strings.modal_messages_viewdesertionreports.youwillcontinuetolosetroops = "You will continue to lose troops regularly until your food production exceeds your Food consumption for this particular city.";
g_js_strings.modal_messages_viewdesertionreports.waystoimprove = "Ways to improve food production!";
g_js_strings.modal_messages_viewdesertionreports.havehighlevelwilderness = "Make sure you have as many high level Wilderness that provide food bonuses (Grassland and Lakes) as you can.";
g_js_strings.modal_messages_viewdesertionreports.havegoodnumberoffarms = "Make sure you have a good number of farms in any city that has troops attached to it.";
g_js_strings.modal_messages_viewdesertionreports.haveknightassignedsteward = "Make sure your city has a knight assigned to the Steward role with high Resourcefulness.";
g_js_strings.modal_messages_viewdesertionreports.armynottoobig = "Make sure your army isn't too big for your city to sustain.";
g_js_strings.modal_messages_viewdesertionreports.trooptypes = "Troop Types";
g_js_strings.modal_messages_viewdesertionreports.beforedesertion = "Before Desertion";
g_js_strings.modal_messages_viewdesertionreports.afterdesertion = "After Desertion";
g_js_strings.modal_messages_viewdesertionreports.troopslost = "Troop Lost";
g_js_strings.modal_messages_viewreports = new Object();
g_js_strings.modal_messages_viewreports.marchrpt = "March Reports";
g_js_strings.modal_messages_viewreports.trooprpt = "Troop Reports";
g_js_strings.modal_messages_viewreports.attackedby = "Attacked By";
g_js_strings.modal_messages_viewreports.nomarchrpts = "You do not have any march reports";
g_js_strings.modal_messages_viewreports_view = new Object();
g_js_strings.modal_messages_viewreports_view.scoutingat = "Scouting at";
g_js_strings.modal_messages_viewreports_view.antiscoutingat = "Anti-Scouting at ";
g_js_strings.modal_messages_viewreports_view.from = "Transport from";
g_js_strings.modal_messages_viewreports_view.transpto = "Transport to";
g_js_strings.modal_messages_viewreports_view.battleat = "Battle at";
g_js_strings.modal_messages_viewreports_view.cannotbeconq = "This wilderness cannot be conquered because you must upgrade your Castle or abandon another wilderness";
g_js_strings.modal_messages_viewreports_view.scoutrpt = "Scouting Report";
g_js_strings.modal_messages_viewreports_view.nounits = "No Units";
g_js_strings.modal_messages_viewreports_view.scoutfail = "Scouting Failed";
g_js_strings.modal_messages_viewreports_view.eagleeyes = "Research higher levels of Eagle Eyes to get more detailed information";
g_js_strings.modal_messages_viewreports_view.battlerpt = "Battle Report";
g_js_strings.modal_messages_viewreports_view.nowallbreach = "Attackers did not breach the walls.";
g_js_strings.modal_messages_viewreports_view.nosecuredwilderness = "The Attackers did not secure the Wilderness.";
g_js_strings.modal_messages_viewreports_view.wallbreach = "Attackers breached the walls.";
g_js_strings.modal_messages_viewreports_view.securedwilderness = "The Attackers secured the Wilderness.";
g_js_strings.modal_messages_viewreports_view.percdamage = "% damage done to walls.";
g_js_strings.modal_messages_viewreports_view.wildernesspercsec = "% of the Wilderness has been secured";
g_js_strings.modal_messages_viewreports_view.pendingcancel = "All pending Market transactions have been canceled";
g_js_strings.modal_messages_viewreports_view.knightskills = "Knight Combat Skill";
g_js_strings.modal_messages_viewreports_view.attackboosted = "Attack Boosted";
g_js_strings.modal_messages_viewreports_view.defenseboosted = "Defense Boosted";
g_js_strings.modal_messages_viewreports_view.overwhelmedinbattle = "Your troops were overwhelmed in battle. Unable to determine enemy strength.";
g_js_strings.modal_messages_viewreports_view.notroopsdef = "No Troops Defended";
g_js_strings.modal_messages_viewreports_view.reportno = "Report No:";
g_js_strings.modal_messages_viewreports_view.lastlogin = "Last Login";
g_js_strings.modal_messages_viewreports_view.knightcomabtlv = "Knight Combat Level";
g_js_strings.modal_messages_viewreports_view.sharevictory = "Share Victory";
g_js_strings.modal_messages_viewreports_view.recovertroops = "Recover Troops";
g_js_strings.modal_messages_viewreports_view.sharetorecovertroops = "Share to Recover Troops";
g_js_strings.modal_messages_viewreports_view.getmoreloot = "Get more loot";
g_js_strings.modal_messages_viewreports_view.findlosttroops = "Find lost troops";
g_js_strings.modal_messages_viewreports_view.searchthebattlefield = "Search the battlefield";
g_js_strings.modal_messages_viewreports_view.soundthecall = "Sound the Call!";
g_js_strings.modal_messages_viewreports_view.backtoreports = "Back to Reports";
g_js_strings.modal_messages_viewreports_view.askforhelp = "Ask for Help";
g_js_strings.modal_messages_viewreports_view.deletereport = "Delete";
g_js_strings.modal_messages_viewreports_view.guardian_attackboosted = "Attack Boost (Guardian)";
g_js_strings.modal_messages_viewreports_view.guardian_marchboosted = "March Boost (Guardian)";
g_js_strings.modal_messages_viewreports_view.guardian_defenseboosted = "Defense Boost (Guardian)";
g_js_strings.modal_messages_viewreports_view.guardian_lifeboosted = "Health Boost (Guardian)";
g_js_strings.modal_messages_viewreinforcedreports = new Object();
g_js_strings.modal_messages_viewreinforcedreports.reinforcementreceived = "You've Received Reinforcements!";
g_js_strings.modal_messages_viewreinforcedreports.alliancemember = "Alliance member:";
g_js_strings.modal_messages_viewreinforcedreports.reinforcedyouwith = "Reinforced you with:";
g_js_strings.modal_messages_viewreinforcedreports.number = "Number";
g_js_strings.modal_messages_viewreinforcedreports.note = "<p>Note: Reinforcements will consume your city's food as if they were your own troops. If your city runs out of food, reinforcements will leave and your troops will desert.</p><p>Reinforcement troops can be sent home to conserve food.</p>";
g_js_strings.modal_messages_viewreinforcedreports.sendtroopshome = "Send Troops Home";
g_js_strings.modal_messages_viewreinforcedreports.sendtroopshomeconfirm = "%1$s troops from player %2$s will be sent home to City %3$s";
g_js_strings.modal_messages_viewreports_view.incentive_paragraph = "Share word of your glorious success! Lament your army's defeat! Ask your friends to help you search the battlefield for troops and war machines that were destroyed or for resources your soldiers missed the first time around. Up to 5 Facebook friends can help you search over the 24 hour period following the battle. After a day has passed, your troops will arrive bearing their spoils of war. (In order to receive a bonus, you have to have lost at least a certain number of troops and/or gotten some resources in the battle.)";
g_js_strings.modal_messages_viewreports_view.incentive_msg_default = "Search the battlefield with your friends for lost troops!  When friends click on the Feed in your Facebook Stream they will help you search for troops that were missing in action after the battle.  You'll recover a portion of the killed troops up to five times The troops will arrive home 1 day after the battle occurred.";
g_js_strings.modal_messages_viewreports_view.incentive_msg_attack_wilderness_barbarian_win = "Search the battlefield with your friends for lost troops and extra loot!  When friends click on the Feed in your Facebook Stream they will help you search for troops that were missing in action after the battle.  You'll recover a portion of the killed troops and a % of the resources you received for every friend who helps you search, up to five times. The troops and loot will arrive home 1 day after the battle occurred.";
g_js_strings.modal_messages_viewreports_view.incentive_msg_attack_wilderness_barbarian_lose = "Search the battlefield with your friends!  When friends click on the Feed in your Facebook Stream they will help you search for troops that were missing in action after the battle.  You'll recover a portion of the killed troops for every friend who helps you search, up to five times.  The troops will arrive home 1 day after the battle occurred.";
g_js_strings.modal_messages_viewreports_view.incentive_msg_attacked_enemy_win = "Search the battlefield with your friends for extra loot and any lost troops!  When friends click on the Feed in your Facebook Stream they will help you search for troops that were missing in action after the battle.  You'll recover a portion of the killed troops and a % of the resources you received for every friend who helps you search, up to five times.  The troops and loot will arrive home 1 day after the battle occurred.";
g_js_strings.modal_messages_viewreports_view.incentive_msg_attacked_enemy_lose = "Search the battlefield with your friends for lost troops!  When friends click on the Feed in your Facebook Stream they will help you search for troops that were missing in action after the battle.  You'll recover a portion of the killed troops up to five times The troops will arrive home 1 day after the battle occurred.";
g_js_strings.modal_messages_viewreports_view.incentive_msg_attack_by_enemy_win = "Search the battlefield with your friends for lost troops!  When friends click on the Feed in your Facebook Stream they will help you search for troops that were missing in action after the battle.  You'll recover a portion of the killed troops up to five times The troops will arrive home 1 day after the battle occurred.";
g_js_strings.modal_messages_viewreports_view.incentive_msg_attack_by_enemy_lose = "Search the battlefield with your friends for lost troops!  When friends click on the Feed in your Facebook Stream they will help you search for troops that were missing in action after the battle.  You'll recover a portion of the killed troops up to five times The troops will arrive home 1 day after the battle occurred.";
g_js_strings.modal_messages_viewreports_view.incentive_msg_main_norec = "Ask your friends to help you search the battlefield for lost troops!";
g_js_strings.modal_messages_viewreports_view.incentive_msg_main_sharestory = "Share a story to your wall asking your friends to help you search the battlefield for lost troops!";
g_js_strings.modal_messages_viewreports_view.incentive_msg_main_winwithrec = "Ask your friends to help you search for extra loot or recover lost troops!";
g_js_strings.modal_messages_viewreports_view.incentive_msg_main_sharestorywithrec = "Share a story to your wall asking your friends to help you search for extra loot or recover lost troops!";
g_js_strings.modal_messages_viewreports_view.incentive_msg_hover_numassist = "Up to 5 friends can assist you in searching the battlefield.";
g_js_strings.modal_messages_viewreports_view.incentive_msg_hover_norec = "Any troops recovered will arrive one day after the battle occurred.";
g_js_strings.modal_messages_viewreports_view.incentive_msg_hover_winwithrec = "Any resources or troops found will arrive one day after the battle occurred!";
g_js_strings.modal_messages_viewreports_view.attack_result_wilderness_barbarian_win = "You were victorious!";
g_js_strings.modal_messages_viewreports_view.attack_result_wilderness_barbarian_lose = "You have been defeated!";
g_js_strings.modal_messages_viewreports_view.attack_result_attacked_enemy_win = "You were victorious!";
g_js_strings.modal_messages_viewreports_view.attack_result_attacked_enemy_lose = "You were defeated!";
g_js_strings.modal_messages_viewreports_view.attack_result_attack_by_enemy_win = "You defended successfully!";
g_js_strings.modal_messages_viewreports_view.attack_result_attack_by_enemy_lose = "You were defeated!";
g_js_strings.modal_messages_listshow = new Object();
g_js_strings.modal_messages_listshow.nosubject = "&lt;No Subject&gt;";
g_js_strings.modal_messages_listshow.nomsg = "Currently you do not have any messages";
g_js_strings.modal_block_user_confirm = new Object();
g_js_strings.modal_block_user_confirm.blockuserconfirm = "Are you sure you want to block this user permanently?";
g_js_strings.tutorialDecree = new Object();
g_js_strings.tutorialDecree.getrwd = "Get Reward";
g_js_strings.tutorialDecree.donotshowtut = "Do not show me the Tutorial again.";
g_js_strings.tutorialCheck = new Object();
g_js_strings.tutorialCheck.clickforcott = "Click here to build a Cottage";
g_js_strings.tutorialCheck.clickforcott_a = "First, let's build a cottage. <br/><br/>Cottages house people to work your fields and train as troops.<br/><br/> Click here to begin.";
g_js_strings.tutorialCheck.clickforquests = "Complete Quests to build a mighty Kingdom. Click here to claim your Reward for building a Sawmill.";
g_js_strings.tutorialCheck.clickforquests_a = "By building a sawmill you've completed a quest<br/><br/>This has earned you a reward.<br/><br/>Click &#34;Quests&#34; to claim it.";
g_js_strings.tutorialCheck.clickforfield = "Click here for the Field View where you can build Farms, Sawmills, Quarries, and Mines to gather Resources, which are used to Build your City, Train new Troops, and conduct Research.";
g_js_strings.tutorialCheck.clickforsawmill = "Click here, then choose the Sawmill";
g_js_strings.tutorialCheck.clickforsawmill_a = "Generating resources lets you construct buildings and train troops.<br/><br/>Lets generate wood by constructing a sawmill.<br/><br/>Click here to build a sawmill.";
g_js_strings.tutorialCheck.clickformyitems = "Click here to view the Items you own.";
g_js_strings.tutorialCheck.clickopenchest = "Click here to open the Chest and claim your Items. To gain more Items in the future, visit the Shop!";
g_js_strings.tutorialCheck.clickheresawmill = "Click here to choose a sawmill.";
g_js_strings.tutorialCheck.clickheresawmill_a = "Click &#34;Select&#34; to choose a sawmill.";
g_js_strings.tutorialCheck.buildingtimeline = "Below is the building timer.<br/><br/>Your sawmill takes 15 seconds to construct.<br/><br/>Later on, you can use hourglasses from the shop to speed up builds.";
g_js_strings.tutorialCheck.clickherecottage = "Click here to choose a cottage.";
g_js_strings.tutorialCheck.clickherecottage_a = "Click &#34;Select&#34; to choose a cottage.";
g_js_strings.tutorialCheck.clickbuildhelp = "Click on Build with Help to get help from your Friends and shorten your build time.";
g_js_strings.tutorialCheck.clickbuildnohelp = "Click the Manual Build button to construct your Sawmill.";
g_js_strings.tutorialCheck.clickbuildnohelp_a = "Click &#34;Build&#34; to construct your sawmill.";
g_js_strings.tutorialCheck.clickforcity = "Click here for the City View, where you can Train your Troops, Raise your Knights, Populate your City, Research in the Alchemy lab, and more!";
g_js_strings.tutorialCheck.clickforcity_a = "Now let's use your resources to expand your city.<br/><br/>Click &#34;City&#34; to see your castle and its buildings.";
g_js_strings.tutorialCheck.clickforshare = "Use this option to show off your progress and get your Reward!";
g_js_strings.tutorialCheck.clickforreward = "Claim your quest reward!";
g_js_strings.tutorialCheck.clickclosetofieldview = "Click &#34;Close&#34; to return to the field view.";
g_js_strings.tutorialCheck.clickbuildnohelpcottage = "Click &#34;Build&#34; to construct your cottage.";
g_js_strings.tutorialDecreeCheck = new Object();
g_js_strings.tutorialDecreeCheck.scoutdecree = "You've been scouted by enemy troops! When you&#39;ve been successfully scouted, the enemy is able to see your Troop levels, as well as how many resources you currently have. Scouting often comes just before an attack, so now may be a good time to upgrade your Storehouse, prepare your Defenses, and train your Troops. Click on the Wall to build defensive units, such as traps to stop your enemy&#39;s melee Troops.";
g_js_strings.tutorialDecreeCheck.plunderdecree = "Your put up a valiant defense, but your enemy was able to overtake your Walls! This means that the enemy has taken your Gold and Resources, and destroyed your Defensive units. If your gates were open, this also means that all of your Troops were killed. To prevent this in the future, be sure to upgrade your Walls, build more Defensive units, and protect your Resources with higher level Storehouses.";
g_js_strings.tutorialDecreeCheck.courtdecree = "The Court is the reception area for other Lords. When visiting another Lord, youcan take Courtly Actions with your host, such as Hunting or Inspecting the Mines. Taking these Courtly Actions will grant both you and the host a gift of the appropriate Resource for the action. You may decorate your own Court with items that enhance the look of your Court for visiting Lords, and items that will increase the gifts received from Courtly Actions. Items are available for purchase in the Shop.";
g_js_strings.tutorialFTE = new Object();
g_js_strings.tutorialFTE.clickforsawmill = "Click here to build a sawmill";
g_js_strings.tutorialFTE.clickforquests = "Click here for Quests";
g_js_strings.tutorialFTE.clickforcity = "Click here for the City view";
g_js_strings.tutorialFTE.clickforcott = "Click here to build a Cottage";
g_js_strings.tutorialMerlinTutorial = new Object();
g_js_strings.tutorialMerlinTutorial.merlin0 = "I am Merlin, and Arthur has sent me to guide you in becoming a mighty %1$s!";
g_js_strings.tutorialMerlinTutorial.merlin0a = "<span class='descTitle'>Welcome to your kingdom my %1$s.</span><br/><br/>I will show how to construct buildings and obtain resources, which will allow you to build an army and rule the realm!";
g_js_strings.tutorialMerlinTutorial.merlin1 = "Increase your Might by Building and Upgrading Buildings, Training your Troops in the Barracks, and Researching in the Alchemy Lab.";
g_js_strings.tutorialMerlinTutorial.merlin2 = "To begin your new Kingdom, I have awarded you a New City Chest, and 10 Gems. Go to My Items to open the Chest.";
g_js_strings.tutorialMerlinTutorial.merlin3 = "This is the Map View. Your City is in the center, and around you are Wildernesses to conquer, other Cities to ally with or Attack, and Barbarian Camps to be plundered and driven from our lands.";
g_js_strings.tutorialMerlinTutorial.merlin4 = "Let's follow the recommended quest and build a Cottage for your subjects.";
g_js_strings.tutorialMerlinTutorial.merlin5 = "Congratulations, you have reached enough Might to become Level Two! You are now on your way to running a mighty Kingdom.";
g_js_strings.tutorialMerlinTutorial.merlin5a = "<span class='descTitle'>Congratulations, you've got the basics for building a kingdom!</span><br/><br/>Now, follow the <b>Quest</b> recommendations to expand your city and train an army. <br/><br/> Once you have an army, you can explore the <b>Map</b> view and conquer new territories!";
g_js_strings.tutorialMerlinTutorial.merlin6 = "If you ever get lost, remember to follow the Quests. Now claim your title and Quest Reward, and grow strong enough to gain Arthur's favor!";
g_js_strings.tutorialMerlinTutorial.merlin6b = "If are ever lost, check the Recommended Quest. Now, you should continue adding new buildings to make a strong castle and gain Arthur's favor!";
g_js_strings.tutorialMerlinTutorial.merlin7 = "If you are ever lost, check the Recommended Quest. Now, you should continue adding new buildings to make a strong castle and gain Arthur's favor!";
g_js_strings.tutorialMerlinTutorial.merlin10 = "This will end Merlin's help in building your City. Are you sure?";
g_js_strings.tutorialMerlinTutorial.merlin10a = "<span class='descTitle'>Are you sure you want to skip?</span><br/>This will end my help in building your City!";
g_js_strings.tutorialMerlinTutorial.skiptutorial = "Skip Tutorial";
g_js_strings.modal_openWalls = new Object();
g_js_strings.modal_openWalls.builddefenses = "Build Defenses";
g_js_strings.modal_openWalls.defqueue = "Defenses Queue";
g_js_strings.modal_openWalls.walldef = "Wall Defense";
g_js_strings.modal_openWalls.fielddef = "Field Defense";
g_js_strings.modal_openWalls.underconstruct = "Currently under construction";
g_js_strings.modal_openWalls.waitforconstruct = "Waiting to be Constructed";
g_js_strings.modal_walls_trainingtab = new Object();
g_js_strings.modal_walls_trainingtab.estdtime = "Estimated Time";
g_js_strings.modal_walls_train = new Object();
g_js_strings.modal_walls_train.numdefbuild = "# of Def to Build";
g_js_strings.modal_walls_train.consttime = "Construction Time";
g_js_strings.modal_walls_train.usesiege = "Use Siege Master's Tools and reduce this by";
g_js_strings.modal_walls_train.starttrain = "Start Training";
g_js_strings.modal_myitems = new Object();
g_js_strings.modal_myitems.getmoreitems = "Get More Items";
g_js_strings.modal_myitems.ownnogeneral = "You own no General Items. These items will help increase your power.";
g_js_strings.modal_myitems.ownnoattack = "You own no Combat Items. These items will help combat abilities.";
g_js_strings.modal_myitems.ownnospeedup = "You own no Speedup Items. These items will help reduce your build and research time.";
g_js_strings.modal_myitems.ownnoprod = "You own no Resource Items. These items will help increase your resource production rate.";
g_js_strings.modal_myitems.ownnochest = "You own no Chest Items. These items are packages of items that help you in the game.";
g_js_strings.modal_myitems.ownnocourt = "You own no Court Items. These items are for your court and guests to enjoy.";
g_js_strings.modal_myitems.myitems = "My Items";
g_js_strings.modal_myitems_use_teleportprovince = new Object();
g_js_strings.modal_myitems_use_teleportprovince.yourcurrentprov = "Your Current Province";
g_js_strings.modal_myitems_use_teleportprovince.newprov = "New Province";
g_js_strings.modal_myitems_use_teleportprovince_do = new Object();
g_js_strings.modal_myitems_use_teleportprovince_do.aused = "%1$s used!";
g_js_strings.modal_myitems_use_teleportprovince_do.teleportto = "Teleported to";
g_js_strings.modal_myitems_use_teleportprovince_do.teleportto = "Teleported to";
g_js_strings.modal_myitems_use_teleport = new Object();
g_js_strings.modal_myitems_use_teleport.teleport = "Portal Here";
g_js_strings.modal_myitems_use_teleport.currentcoor = "Your Current Coordinates";
g_js_strings.modal_rename_celebration = new Object();
g_js_strings.modal_rename_celebration.currentcity = "Current City Name";
g_js_strings.modal_rename_celebration.newcityname = "New City Name";
g_js_strings.modal_rename_celebration.entername = "Please enter a character name that has 3-15 letters with no spaces.";
g_js_strings.modal_get_cloak_name = new Object();
g_js_strings.modal_get_cloak_name.yourcurrentname = "Your Current name is";
g_js_strings.modal_get_cloak_name.newname = "New Name";
g_js_strings.setNewDisplayName = new Object();
g_js_strings.setNewDisplayName.entername = "Please enter a character name that has 3-15 letters with no spaces.";
g_js_strings.modal_chest_itemusage = new Object();
g_js_strings.modal_chest_itemusage.itemsgained = "Items Gained";
g_js_strings.modal_volunteer_gain = new Object();
g_js_strings.modal_volunteer_gain.unitsgained = "Units Gained";
g_js_strings.modal_knight_info = new Object();
g_js_strings.modal_knight_info.knightname = "Knight Name";
g_js_strings.modal_knight_info.knightskills = "Knight Skills";
g_js_strings.modal_knight_info.entername = "Enter name for the knight (3-15 characters)";
g_js_strings.modal_myitems_use = new Object();
g_js_strings.modal_myitems_use.aadded = "%1$s added!";
g_js_strings.modal_myitems_use.uused = "%1$s used!";
g_js_strings.modal_shop_buy_banner = new Object();
g_js_strings.modal_shop_buy_banner.banner_7thcitycomingsoon = "7th City Coming Soon!";
g_js_strings.modal_shop_buy_banner.banner_8thcitycomingsoon = "8th City Coming Soon!";
g_js_strings.modal_shop_buy_banner.banner_feycitycomingsoon = "Fey City Coming Soon!";
g_js_strings.modal_shop_buy_banner.banner_exclusiveitemsonkabam = "Buy new and exclusive items on Kabam.com!";
g_js_strings.modal_shop_buy = new Object();
g_js_strings.modal_shop_buy.purchasealert = "1 %1$s Purchased!";
g_js_strings.modal_shop_buy.nolongersale = "You just missed the sale! Continue to buy for %1$s?";
g_js_strings.modal_shop_buy_notenough = new Object();
g_js_strings.modal_shop_buy_notenough.notenoughgems = "You don&#39;t have enough gems to get that.";
g_js_strings.modal_shop_buy_notenough.thatsokay = "That&#39;s okay...";
g_js_strings.modal_shop_buy_notenough.getmoregems = "Get More Gems";
g_js_strings.modal_getgems = new Object();
g_js_strings.modal_getgems.purchasegems = "Purchase gems by Credit Card or PayPal";
g_js_strings.modal_getgems.purchasegemsa = "Purchase gems by %1$s";
g_js_strings.modal_getgems.purchasegemstitle = "Buy a Gem Package";
g_js_strings.modal_getgems.purchasegemsdescription = "Use Gems to purchase in-game items. Buy Gem packages with %1$s.";
g_js_strings.modal_getgems.selectbundle = "Select one of these bundles for a bonus";
g_js_strings.modal_getgems.purchaseaforb = "Buy %1$s gems for %3$s%2$s";
g_js_strings.modal_getgems.purchaseafordiscount = "Buy %1$s gems for <span class='originalprice'>%3$s%2$s</span> <span class='finalprice'>%3$s%4$s</span>";
g_js_strings.modal_getgems.bonusgems = "Bonus Gems";
g_js_strings.modal_getgems.singletransact = "In a single transaction";
g_js_strings.modal_getgems.gemsdirect = "Purchase Gems Directly";
g_js_strings.modal_getgems.gems1 = "50 Gems ($5)";
g_js_strings.modal_getgems.gems2 = "100 Gems ($10)";
g_js_strings.modal_getgems.gems3 = "200 Gems ($20)";
g_js_strings.modal_getgems.gems4 = "300 Gems ($30)";
g_js_strings.modal_getgems.gems5 = "525 Gems ($50)";
g_js_strings.modal_getgems.gems6 = "1100 Gems ($100)";
g_js_strings.modal_getgems.gems7 = "2800 Gems ($250)";
g_js_strings.modal_getgems.gems8 = "5750 Gems ($500)";
g_js_strings.modal_getgems.purchasenow = "Purchase Now";
g_js_strings.modal_getgems.obtaindesc = "Earn Gems from special offers";
g_js_strings.modal_getgems.gemoffer = "Other Ways to Get Gems";
g_js_strings.modal_getgems.obtainmobiledesc = "Obtain gems through Offers!";
g_js_strings.modal_getgems.obtainmobile = "Pay with Mobile";
g_js_strings.modal_getgems.linkcreditcards = "Credit Cards";
g_js_strings.modal_getgems.linkdebitcards = "Debit Cards";
g_js_strings.modal_getgems.linkgashmycard = "GASH & MyCard";
g_js_strings.modal_getgems.linkpaypal = "PayPal";
g_js_strings.modal_getgems.linkmobile = "Pay With Mobile";
g_js_strings.modal_getgems.linkoffers = "Offers";
g_js_strings.modal_getgems.pricesshown = "Prices shown in %1$s";
g_js_strings.modal_getgems.ordash = "-or-";
g_js_strings.modal_getgems.itemseparator = ", ";
g_js_strings.modal_getgems.itemseparatorlast = " or ";
g_js_strings.modal_getgems_direct = new Object();
g_js_strings.modal_getgems_direct.backtogem = "&lt;&lt;Back to Gem purchase options";
g_js_strings.modal_getgems_direct.clickforpaypal = "Click here to purchase by PayPal";
g_js_strings.modal_getgems_direct.needassistance = "Need Billing Assistance?";
g_js_strings.modal_getgems_check = new Object();
g_js_strings.modal_getgems_check.gemsupdated = "Gems Updated! If you are expecting a bonus chest, please refresh and check the Chest tab within My Items.";
g_js_strings.modal_shop_buy_gift = new Object();
g_js_strings.modal_shop_buy_gift.entername = "Please enter the Lord or Lady name of the person you wish to gift Offering of Affection to";
g_js_strings.modal_shop_buy_gift.nameerror = "Please enter a valid player name.";
g_js_strings.modal_shop_buy_gift_player_check = new Object();
g_js_strings.modal_shop_buy_gift_player_check.confirmgift = "Are you sure you want to purchase and send this gift to Lord/Lady %1$s?";
g_js_strings.modal_myitems_confirm_potion_mist = new Object();
g_js_strings.modal_myitems_confirm_potion_mist.mistwarning = "Please note: Using the Mists of Avalon while you are engaged in attack will still reveal your location to the person you are attacking in their Battle Report. Do you still wish to use the Mists?";
g_js_strings.modal_myitems_confirm_potion_mist.usemists = "Use Mists";
g_js_strings.modal_myitems_warning = "Warning!";
g_js_strings.vacationMode = {};
g_js_strings.vacationMode.modal_myitems_confirm_vacation3_msg = "You will be entering vacation mode for 3 days.  You will not be able to march (attack, reinforce, scout, reassign, transport) without ending vacation mode.  Once vacation mode has ended, you will not be able to restart it without using another item.   Do you still wish to continue?";
g_js_strings.vacationMode.modal_myitems_confirm_vacation7_msg = "You will be entering vacation mode for 7 days.  You will not be able to march (attack, reinforce, scout, reassign, transport) without ending vacation mode.  Once vacation mode has ended, you will not be able to restart it without using another item.   Do you still wish to continue?";
g_js_strings.vacationMode.modal_myitems_confirm_vacation3 = "<span class='warning'>Warning!</span> You will be entering vacation mode for 3 days.  You will not be able to march (attack, reinforce, scout, reassign, transport) without ending vacation mode.  Once vacation mode has ended, you will not be able to restart it without using another item.   Do you still wish to continue?";
g_js_strings.vacationMode.modal_myitems_confirm_vacation7 = "<span class='warning'>Warning!</span> You will be entering vacation mode for 7 days.  You will not be able to march (attack, reinforce, scout, reassign, transport) without ending vacation mode.  Once vacation mode has ended, you will not be able to restart it without using another item.   Do you still wish to continue?";
g_js_strings.vacationMode.modal_attack_vacation = "<span class='warning'>Warning!</span> By  sending out a march, you will end vacation mode immediately and you will not be able to restart it without using another item.  All benefits will immediately cease. You may be attacked. You will no longer be under the Mists of Avalon. You will no longer have reduced upkeep.   Do you still wish to continue?";
g_js_strings.modal_myitems_confirm_potion_mist.usevacation = "Enter Vacation Mode";
g_js_strings.modal_myitems_confirm_vacation_continue_button = "Continue";
g_js_strings.ignoreUserConfirm = new Object();
g_js_strings.ignoreUserConfirm.ignoreuser = "Are you sure you want to ignore this user?";
g_js_strings.silenceUserConfirm = new Object();
g_js_strings.silenceUserConfirm.silenceuser = "Are you sure you want to silence this user?";
g_js_strings.renameUserConfirm = new Object();
g_js_strings.renameUserConfirm.renameuser = "Are you sure you want to rename this user?";
g_js_strings.renameUser = new Object();
g_js_strings.renameUser.didnotwork = "Did not work, likely duplicate";
g_js_strings.getChat = new Object();
g_js_strings.getChat.whisperstoyou = "whispers to you";
g_js_strings.getChat.saystoalliance = "says to the alliance";
g_js_strings.getChat.chatrules = "Chat Rules";
g_js_strings.getChat.nobadlang = "No bad language. No personal attacks. No links. Use /username to whisper to another player. Respect the mods and each other and most importantly, have fun!";
g_js_strings.getChat.inactivemessage = "Hey! Your chat has gone idle and you've stopped receiving chats. Scroll over chat to retrieve chats and stay active.";
g_js_strings.sendChat = new Object();
g_js_strings.sendChat.talkingtoyourself = "You are talking to yourself because you are not in an alliance.";
g_js_strings.sendChat.joinorcreate = "Join or Create an Alliance!";
g_js_strings.sendChat.youtoalliance = "You say to your alliance";
g_js_strings.sendChat.saystoalliance = "says to the alliance";
g_js_strings.sendChat.maybenotonline = "may not be online.";
g_js_strings.sendChat.whispersto = "whispers to";
g_js_strings.comingsoon = new Object();
g_js_strings.comingsoon.comingsoon = "Coming Soon!";
g_js_strings.boosts_tooltip_fog = new Object();
g_js_strings.boosts_tooltip_fog.fog = "You are under Mists of Avalon";
g_js_strings.boosts_tooltip_production = new Object();
g_js_strings.boosts_tooltip_production.goldprodincrease = "Gold production increased by 100%";
g_js_strings.boosts_tooltip_production.aprodincrease = "%1$s production increased by 25%";
g_js_strings.boosts_tooltip_production.aleft = "%1$s left.";
g_js_strings.boosts_tooltip_combat = new Object();
g_js_strings.boosts_tooltip_combat.troopatkinc = "Troop attack increased by 20%";
g_js_strings.boosts_tooltip_combat.troopdefinc = "Troop defense increased by 20%";
g_js_strings.boosts_tooltip_combat.troopatkinc2 = "Troop attack increased by 50%";
g_js_strings.boosts_tooltip_combat.troopdefinc2 = "Troop defense increased by 50%";
g_js_strings.boosts_tooltip_combat.cityinpeace = "City in peacetime. You cannot attack or be attacked.";
g_js_strings.boosts_tooltip_combat.troopupkeepreduct = "Troop food upkeep reduced by 50%";
g_js_strings.boosts_tooltip_combat.loadincrease = "Troop load increased by 25%";
g_js_strings.boosts_tooltip_combat.troopreturnreduct = "Troop return time reduced by 50%";
g_js_strings.boosts_tooltip_combat.troophealthincrease = "Troop health increased by 10%";
g_js_strings.boosts_tooltip_combat.awesomeaura = "Troop march size increased by 15%";
g_js_strings.boosts_tooltip_combat.awesomeauraextreme = "Troop march size increased by 30%";
g_js_strings.modal_addcityhelp = new Object();
g_js_strings.modal_addcityhelp.secondcityneed = "To build a second city you need to";
g_js_strings.modal_addcityhelp.secondcityitem1 = "Reach of title of Baronet (7) or higher.";
g_js_strings.modal_addcityhelp.secondcityitem2 = "Control a Plain";
g_js_strings.modal_addcityhelp.secondcityitem3 = "Have 250 Supply Troops encamped (reinforce) at that location";
g_js_strings.modal_addcityhelp.secondcityitem4 = "Have 10,000 EACH of Gold, Food, Wood, Stone, and Ore at that location (reinforce)";
g_js_strings.modal_addcityhelp.secondcityitem5 = "Click on that location to build city";
g_js_strings.modal_addcityhelp.secondcityitem6 = "Obtain a &#39;Second City Deed&#39; by completing the necessary quest or purchasing it in the shop.";
g_js_strings.modal_addcityhelp.thirdcityneed = "To build a third city you need to";
g_js_strings.modal_addcityhelp.thirdcityitem1 = "Obtain a &#39;Third City Deed&#39; by completing the necessary quest.";
g_js_strings.modal_addcityhelp.thirdcityitem2 = "Control a Plain";
g_js_strings.modal_addcityhelp.thirdcityitem3 = "Have 250 Supply Troops encamped (reinforce) at that location";
g_js_strings.modal_addcityhelp.thirdcityitem4 = "Have 10,000 EACH of Gold, Food, Wood, Stone, and Ore at that location (reinforce)";
g_js_strings.modal_addcityhelp.thirdcityitem5 = "Click on that location to build city";
g_js_strings.modal_addcityhelp.fourthcityneed = "To build a fourth city you need to";
g_js_strings.modal_addcityhelp.fourthcityitem1 = "Obtain a &#39;%1$s&#39; by completing the necessary quest.";
g_js_strings.modal_maptile = new Object();
g_js_strings.modal_maptile.bookmarkloc = "Bookmark Location";
g_js_strings.modal_maptile.viewcity = "View City";
g_js_strings.modal_maptile.visitcourt = "Visit Court";
g_js_strings.modal_maptile.barbarianinvasion = "Invasions of barbarians have become a threat to this province.  Conquer this city and you may receive a trophy!";
g_js_strings.modal_maptile.buildcity = "Build City";
g_js_strings.modal_maptile.viewtroops = "View Troops";
g_js_strings.modal_maptile.viewreinforcements = "View Reinforcements";
g_js_strings.modal_maptile.ownermisted = "The owner of this Wilderness is hidden in the Mists of Avalon.";
g_js_strings.modal_maptile.cantportal = "Cannot portal to an owned plain";
g_js_strings.modal_maptile.boghint = "No creatures roam this land.";
g_js_strings.modal_maptile.bosshint = "Unknown creatures dominate this dark space...";
g_js_strings.modal_maptile.portalmodalTitle = "Portal Your City";
g_js_strings.modal_maptile.portalmodalOkButton = "Use Portal of Order";
g_js_strings.modal_maptile.portalmodalNotification = "Do you want to portal %1$s to";
g_js_strings.modal_mmb = new Object();
g_js_strings.modal_mmb.playmmb = "Play Merlin&#39;s Magical Boxes";
g_js_strings.modal_mmb.gamechance = "The game of chance that could have you winning more than you could ever earn!";
g_js_strings.modal_mmb.everyonewins = "Everyone is a winner!";
g_js_strings.modal_mmb.usetokens = "Use Merlin&#39;s Magical Tokens to Play!";
g_js_strings.modal_mmb.magicaltokens = "Merlin&#39;s Magical Token";
g_js_strings.modal_mmb.playnow = "Play Now";
g_js_strings.modal_mmb.playlater = "Play Later";
g_js_strings.modal_mmb.youwon = "You Won!";
g_js_strings.modal_mmb.spin = "Spin!";
g_js_strings.modal_mmb.buymoregems = "Buy More Gems!";
g_js_strings.modal_mmb.playonfb = "Play on Kabam.com for one additional FREE token!";
g_js_strings.modal_mmb.playonkabam = "Playing on Kabam.com gives two tokens per day!";
g_js_strings.modal_mmb_game = new Object();
g_js_strings.modal_mmb_game.playfreedesc = "Play for FREE NOW or use tokens later to try your luck at winning items!";
g_js_strings.modal_mmb_game.pickbox = "Pick a box...  Any box...";
g_js_strings.modal_mmb_game.unlockgifts = "Send a gift to your friends to unlock more valuable prizes!";
g_js_strings.mmb_modal_confirm = new Object();
g_js_strings.mmb_modal_confirm.youwon = "You won...";
g_js_strings.mmb_modal_confirm.addedto = "This has been added to";
g_js_strings.mmb_modal_confirm.myitems = "My Items.";
g_js_strings.mmb_modal_confirm.beselfish = "Be Selfish";
g_js_strings.mmb_modal_confirm.shareupsell = "Share your good fortune with your friends and let them try their luck with FREE %1$s.";
g_js_strings.mmb_modal_confirm.sharemmtoken = "Share a free Merlin&#39;s Magical Token with your friends!";
g_js_strings.mmb_modal_confirm.sharefreetoken = "Share Free Token";
g_js_strings.modal_mmb_openbox = new Object();
g_js_strings.modal_mmb_openbox.youvewon = "You&#39;ve won...";
g_js_strings.modal_mmb_openbox.redtapestry = "Red Tapestry";
g_js_strings.showResourceTooltip = new Object();
g_js_strings.showResourceTooltip.caplimit = "Capacity Limit";
g_js_strings.showResourceTooltip.hrprod = "Hourly Production";
g_js_strings.showResourceTooltip.troopsupkeep = "Troops Upkeep";
g_js_strings.showResourceTooltip.foodrunningout = "Food will run out";
g_js_strings.showResourceTooltip.foodrunningoutunit_m = "hours";
g_js_strings.showResourceTooltip.foodrunningoutunit_s = "hour";
g_js_strings.showHappyTooltip = new Object();
g_js_strings.showHappyTooltip.taxrate = "Tax Rate";
g_js_strings.showGoldTooltip = new Object();
g_js_strings.showGoldTooltip.taxrev = "Tax Revenue";
g_js_strings.showGoldTooltip.knsal = "Knights&#39; Salary";
g_js_strings.showGoldTooltip.netincome = "Net Income";
g_js_strings.showPopTooltip = new Object();
g_js_strings.showPopTooltip.poplimit = "Population Limit";
g_js_strings.showPopTooltip.currpop = "Current Population";
g_js_strings.showPopTooltip.lbrforce = "Labor Force";
g_js_strings.showPopTooltip.idlepop = "Idle Population";
g_js_strings.showPopTooltip.poptrend = "Population Trend";
g_js_strings.showAddCityTooltip = new Object();
g_js_strings.showAddCityTooltip.addcities = "Add cities to increase resources.";
g_js_strings.showCityTooltip = new Object();
g_js_strings.showCityTooltip.foodsupply = "Food Supply";
g_js_strings.directory_changetab = new Object();
g_js_strings.directory_changetab.tourncoming = "Tournaments are coming soon.";
g_js_strings.directory_changetab.viewdet = "View Details";
g_js_strings.directory_changetab.generousgifts = "Be a generous Lord or Lady<br/>and send gifts to your friends!";
g_js_strings.directory_changetab.sendgifts = "Send Gifts";
g_js_strings.directory_changetab.updateinterval = "List updated every 1~2 hours";
g_js_strings.getMessageWindow = new Object();
g_js_strings.getMessageWindow.sendmessage = "Send Message";
g_js_strings.sendMessageModule = new Object();
g_js_strings.sendMessageModule.msgsent = "Message sent";
g_js_strings.sendMessageModule.retrydesc = "Problem in sending the message. Please Retry";
g_js_strings.modal_speedup = new Object();
g_js_strings.modal_speedup.askhelp = "Ask for Help";
g_js_strings.modal_speedup.askhelpdesc = "For every friend that gives you help, 1 min will be taken off the remaining time.";
g_js_strings.modal_speedup.newaskhelpdesc = "Every friend who helps will reduce the build time by 1 minute or 1%, whichever is greater.";
g_js_strings.modal_speedup.buildresearchaskhelpdesc = "Every friend who helps will reduce the build or research time by 1 minute or 1%, whichever is greater.";
g_js_strings.cityaction_abandonprompt = new Object();
g_js_strings.cityaction_abandonprompt.abandona = "Are you sure you want to abandon %1$s?";
g_js_strings.cityaction_abandonprompt.confirmdesc = "To confirm that you <b>REALLY</b> want to abandon this city,<br/>please type the name of this city backwards.";
g_js_strings.cityaction_abandonprompt_confirm = new Object();
g_js_strings.cityaction_abandonprompt_confirm.typename = "Please type the name of this city backwards to abandon it";
g_js_strings.changedomain_prompt = new Object();
g_js_strings.changedomain_prompt.selectdomain = "Select an Existing Domain";
g_js_strings.changedomain_prompt.enterdomain = "Enter Domain";
g_js_strings.changedomain_prompt.dord = "- or -";
g_js_strings.changedomain_prompt.createcity = "Create a city on another domain";
g_js_strings.getUserSettings = new Object();
g_js_strings.getUserSettings.userset = "User Settings";
g_js_strings.getUserSettings.defaultchat = "Default Chat Tab";
g_js_strings.getUserSettings.chatignore = "Chat Ignore List";
g_js_strings.getUserSettings.msgblock = "Message Block List";
g_js_strings.getUserSettings.changelang = "Change Language";
g_js_strings.getUserSettings.savelang = "Save Language";
g_js_strings.modal_help_request = new Object();
g_js_strings.modal_help_request.choosecat = "Please choose a category";
g_js_strings.modal_help_request.dsetcatd = "-- Select Category --";
g_js_strings.modal_help_request.billissue = "Billing Issues";
g_js_strings.modal_help_request.bugreport = "Bug Report";
g_js_strings.modal_help_request.gamequestion = "Game Question";
g_js_strings.modal_help_request.featsugg = "Feature Suggestion";
g_js_strings.modal_help_request.report = "Report Abuse / Cheating";
g_js_strings.modal_help_request.gemsbill = "";
g_js_strings.modal_help_request.userrpt = "User Report";
g_js_strings.modal_help_request.selcat = "You must select a category";
g_js_strings.modal_help_request.descprob = "Please describe your problem";
g_js_strings.modal_help_request.mustdescprob = "You must describe your problem";
g_js_strings.modal_help_request.enterem = "Please enter your email address";
g_js_strings.modal_help_request.mustenterem = "You must enter a valid email address";
g_js_strings.sendHelpRequest = new Object();
g_js_strings.sendHelpRequest.thankyou = "Your help request has been sent. Due to the high volume of tickets we receive, you may experience a delay of a few days before you receive a response.<br/><br/>Please check out our support site for answers to many commonly asked questions and to check the status of your report.";
g_js_strings.pop_action_feed_modal = new Object();
g_js_strings.pop_action_feed_modal.fairedesc2 = "Send a Travelling Faire to a Friend's Kingdom and all of their cities will get +50 Happiness!";
g_js_strings.pop_action_feed_modal.faireShareButton = "Share Travelling Faire";
g_js_strings.pop_action_feed_modal.cordialvisitcourtdesc = "%1$s has cordially invited you to visit their Court!";
g_js_strings.pop_treasure_chest_modal = new Object();
g_js_strings.pop_treasure_chest_modal.chestdesc = "You found a treasure chest! Unfortunately, you don't have anyone in your employ who can break the lock. One of your friends may have just the person!";
g_js_strings.pop_treasure_chest_modal.givefriend = "Give to a Friend";
g_js_strings.pop_treasure_chest_modal.sharewithfriends = "Share with Friends";
g_js_strings.getNextAvailableCase = new Object();
g_js_strings.getNextAvailableCase.allidesc = "Defending your city is much easier as part of an Alliance! Band together with your fellow players for mutual help. Click the Alliance button to see current alliances, or start your own!";
g_js_strings.getNextAvailableCase.frienddesc = "Getting a Second City is important to provide resources, give you more troops and to raise your might! Invite your friends to play and help you get your Second City Deed today!";
g_js_strings.getNextAvailableCase.expanddesc = "Expansion is important! You should consider building a new city to expand your glorious empire!";
g_js_strings.getNextAvailableCase.resourcedesc = "To increase your Resource production, take over Wildernesses around you! Go to the Map View and click on the Woods, Hills, etc. around your City to learn more. Lower level Wildernesses have fewer protectors, and require you to send fewer Troops when you attack.";
g_js_strings.getNextAvailableCase.appointdesc = "Appoint your Friends as Knights to help grow your city! Knights can be assigned to Roles to speed up your city's growth, and are necessary to lead attacks against Wildernesses, Barbarian Camps, and your enemies. Appoint Knights in your Knights' Hall.";
g_js_strings.getNextAvailableCase.troopdesc = "In order to grow your Kingdom, you need Troops! Troops can be trained in the Barracks, and will let you take over Wildernesses, plunder Barbarian Camps, set up new cities, and destroy your enemies.";
g_js_strings.getNextAvailableCase.researchdesc = "Research in the Alchemy Lab to improve your city! Research can improve your Resource production, unlock new Troops, increase your combat abilities, and more.";
g_js_strings.getNextAvailableCase.invitefriends = "Invite Friends";
g_js_strings.pop_castle_two_modal = new Object();
g_js_strings.pop_castle_two_modal.castledesc = "Your Kingdom is advancing nicely! Why not recommend Kingdoms of Camelot to some friends? You can grow your might alongside each other and band together for help.";
g_js_strings.pop_castle_two_modal.castlerecommend = "Recommend to Friends";
g_js_strings.popViralModalUEP = new Object();
g_js_strings.popViralModalUEP.inviteyourfriends = "Invite your Friends";
g_js_strings.popViralModalUEP.sendfreegifts = "Send Free Gifts";
g_js_strings.popViralModalUEP.invitedesc = "Ask Your friends to play Kingdoms of Camelot with you! It's more fun to compete against your Friends.";
g_js_strings.popViralModalUEP.attractalliesdesc = "Allies will protect you as your Kingdom grows in might. Invite your Friends to build their own Kingdoms!";
g_js_strings.popViralModalUEP.giftreminddesc = "Send free Gifts to your friends everyday to get ahead of your enemies.";
g_js_strings.pop_suggest_invite_modal = new Object();
g_js_strings.pop_suggest_invite_modal.invitedesc = "Like Kingdoms of Camelot? Invite some friends to play with you.";
g_js_strings.pop_suggest_invite_modal.invitefriend = "Invite Friends";
g_js_strings.postToAllianceChat = new Object();
g_js_strings.postToAllianceChat.helpmebuild = "I need help building my lv. %1$s %2$s.";
g_js_strings.postToAllianceChat.helpmersch = "I need help advancing my %1$s research to lv. %2$s";
g_js_strings.postToAllianceChat.clicktobuild = "Click here to reduce the build time.";
g_js_strings.postToAllianceChat.clicktorsch = "Click here to reduce the research time.";
g_js_strings.claimAllianceChatHelp = new Object();
g_js_strings.claimAllianceChatHelp.helpCount = "You are # %1$s of 5 to help %2$s %3$s!";
g_js_strings.timestr = new Object();
g_js_strings.timestr.times = "s";
g_js_strings.timestr.timesec = "sec";
g_js_strings.timestr.timemin = "min";
g_js_strings.timestr.timem = "m";
g_js_strings.timestr.timehr = "hr";
g_js_strings.timestr.timeh = "h";
g_js_strings.timestr.timeday = "day";
g_js_strings.timestr.timed = "d";
g_js_strings.checkoutofdate = new Object();
g_js_strings.checkoutofdate.reloadconfirm = "Your game may be out of date. Reload Kingdoms of Camelot?";
g_js_strings.upg_tch = new Object();
g_js_strings.upg_tch.unableres = "unable to research";
g_js_strings.buildaction = new Object();
g_js_strings.buildaction.cannotbuild = "cannot build";
g_js_strings.deleteaction = new Object();
g_js_strings.deleteaction.somethingwentwrong = "Something went wrong please retry";
g_js_strings.deleteaction.craftQueueFull = "You cannot deconstuct your Fey Spire while it's crafting something; please cancel your current crafting project.";
g_js_strings.update_queue = new Object();
g_js_strings.update_queue.frhelp = "Friends helping";
g_js_strings.update_queue.allihelp = "Alliance helping";
g_js_strings.update_queue.akbatc = "%1$sk %2$s at %3$s";
g_js_strings.update_queue.troopqueue = "Troop Groups Queued";
g_js_strings.init = new Object();
g_js_strings.init.tutorialcont = "You may be in the middle of a tutorial. Continue?";
g_js_strings.init.main_beginnnerupsell_hoverexc = "Get the %1$s to start your City on the winning path!";
g_js_strings.recommendFriendsModule = new Object();
g_js_strings.recommendFriendsModule.recommendmember = "Recommend an Alliance Member";
g_js_strings.recommendFriendsModule.selectfromfriend = "Select from your friends";
g_js_strings.recommendFriendsModule.yourfriendsona = "These are your friends on %1$s";
g_js_strings.recommendFriendsModule.sorrynofriends = "Sorry none of your friends are playing on this server";
g_js_strings.recommendFriendsModule.searchplayers = "Search For Players";
g_js_strings.recommendFriendsModule.selectedplayers = "Selected Players";
g_js_strings.recommendFriendsModule.recselplayers = "Recommend Selected Players";
g_js_strings.recommendSelectedFriends = new Object();
g_js_strings.recommendSelectedFriends.aalreadyrec = "%1$s have already been recommended.";
g_js_strings.recommendSelectedFriends.recsuccess = "Recommendation Successful";
g_js_strings.recommendSelectedFriends.sorrynorec = "Sorry can not make recommendation at this moment.";
g_js_strings.recommendSelectedFriends.playersrch = "Player Search";
g_js_strings.friendsTabInAllianceInvite = new Object();
g_js_strings.friendsTabInAllianceInvite.makealliancestrong = "Make your alliance strong with your friends.";
g_js_strings.friendsTabInAllianceInvite.subjecttxt = "Invitation to join %1$s alliance in Kingdoms of Camelot";
g_js_strings.friendsTabInAllianceInvite.msgtxt = "%1$s has invited you to join his alliance %2$s on %3$s&#39;s domain in Kingdoms of Camelot! Click here to join the alliance %4$s";
g_js_strings.friendsTabInAllianceInvite.existingplayers = "Existing Players";
g_js_strings.friendsTabInAllianceInvite.pendinginv = "Pending Invitation";
g_js_strings.searchTabInAllianceInvite = new Object();
g_js_strings.searchTabInAllianceInvite.messagetoinvite = "Message Players you want to Invite<br/>";
g_js_strings.searchPlayersByName = new Object();
g_js_strings.searchPlayersByName.atleast3char = "Player name must have alteast 3 characters in length";
g_js_strings.searchPlayersByName.allinvite = "Alliance Invite";
g_js_strings.searchPlayersByName.youareinvited = "You have been invited to join my alliance";
g_js_strings.searchPlayersByName.abinkocjoinc = "%1$s %2$s in Kingdoms of Camelot. Join Alliance: %3$s";
g_js_strings.searchPlayersByName.mbrofall = "Member of your alliance";
g_js_strings.searchPlayersByName.srynoplayers = "Sorry no players found on the name %1$s";
g_js_strings.searchPlayersByName.nouserfound = "No user found";
g_js_strings.showCreateAlliance = new Object();
g_js_strings.showCreateAlliance.allinameinstruct = "Alliance Name can only contain letters, numbers, spaces and &quot;_&quot;.";
g_js_strings.showCreateAlliance.alliname = "Alliance Name";
g_js_strings.showCreateAlliance.createalli = "Create An Alliance";
g_js_strings.showCreateAlliance.networkinvitationbody = "I have created the alliance %1$s on the domain %2$s. Please Join!";
g_js_strings.allianceInfo = new Object();
g_js_strings.allianceInfo.leavealli = "Leave Alliance";
g_js_strings.allianceInfo.curralli = "Current Alliance";
g_js_strings.allianceInfo.recommby = "Recommended By";
g_js_strings.allianceInfo.allidiplomacy = "Alliance Diplomacy";
g_js_strings.allianceInfo.setdiplomacy = "Set Diplomacy";
g_js_strings.allianceInfo.allicreated = "Alliance Created";
g_js_strings.allianceInfo.currentlynoalli = "You currently aren't in any Alliance.";
g_js_strings.allianceInfo.alliprotectdesc = "Alliances will help you protect your city during war.";
g_js_strings.allianceInfo.browsealli = "Browse Alliances";
g_js_strings.allianceInfo.musthaveembassylvl2 = "You must have an Embassy of Level 2 to create your own Alliance";
g_js_strings.allianceInfo.andlvl1tojoin = "and Level 1 to join any Alliance";
g_js_strings.allianceInfo.createalli = "Create An Alliance";
g_js_strings.allianceInfo.startown = "Want to start your own?";
g_js_strings.allianceInfo.alliinvites = "Alliance Invites";
g_js_strings.allianceInfo.pendingreq = "Pending Requests";
g_js_strings.allianceInfo.cancelreq = "Cancel Request";
g_js_strings.allianceInfo.reqdon = "Requested on";
g_js_strings.allianceInfo.joinalli = "Join Alliance";
g_js_strings.allianceInfo.nothanks = "No Thanks";
g_js_strings.allianceInfo.ainvitedyoutob = "%1$s invited you to %2$s";
g_js_strings.allianceInfo.pendmbrs = "Pending Members";
g_js_strings.allianceInfo.gemGiftButton = "Gift Gems";
g_js_strings.allianceInfo.gemGiftHeader = "Gift Gems to Alliance Members!";
g_js_strings.getDiplomacy = new Object();
g_js_strings.getDiplomacy.sorrynoalli = "Sorry no alliances found for this type";
g_js_strings.getDiplomacy.alliname = "Alliance Name";
g_js_strings.getDiplomacy.friendlytowardsthem = "Friendly Towards Them";
g_js_strings.getDiplomacy.friendlytoyou = "Friendly To You";
g_js_strings.getDiplomacy.awaitingtheiracceptance = "Awaiting their acceptance";
g_js_strings.getDiplomacy.awaitingleaderacceptance = "Awaiting your leader's acceptance";
g_js_strings.getDiplomacy.acceptancepending = "Acceptance pending";
g_js_strings.getDiplomacy.leaderacceptancepending = "Leader's acceptance pending";
g_js_strings.actionOnAllianceInvitations = new Object();
g_js_strings.actionOnAllianceInvitations.leavecurralli = "Leave your current alliance before you join a new alliance<br/>";
g_js_strings.actionOnAllianceInvitations.congratsyoujoinedalli = "Congratulations, You have joined the alliance %1$s";
g_js_strings.leaveAllianceConfirmationContent = new Object();
g_js_strings.leaveAllianceConfirmationContent.curralli = "Current Alliance";
g_js_strings.leaveAllianceConfirmationContent.chancellorsnotleave = "Chancellors can not leave the alliance when there are members in it. You must resign your position as chancellor in order to leave the alliance <br/>";
g_js_strings.leaveAllianceConfirmationContent.resignchancellors = "Resign as Chancellor";
g_js_strings.leaveAllianceConfirmationContent.noteonlyperson = "Note: You are the only person in this alliance, leaving this alliance will cause the alliance to be deleted.<br/>";
g_js_strings.leaveAllianceConfirmationContent.liketoleave = "Would you like to leave?";
g_js_strings.resignAlliance = new Object();
g_js_strings.resignAlliance.chancellorresignation = "Chancellor Resignation Process";
g_js_strings.resignAlliance.selectnewchancellor = "Select any one of the alliance members to become a chancellor.";
g_js_strings.resignAlliance.youvicechancellor = "You will become vice chancellor";
g_js_strings.resignAlliance.assignnewchancellor = "Assign new chancellor";
g_js_strings.leaveAlliance = new Object();
g_js_strings.leaveAlliance.allianceaterminated = "Your alliance with %1$s has been terminated";
g_js_strings.assignNewChancellor = new Object();
g_js_strings.assignNewChancellor.newchancellorisa = "You have been resigned as a chancellor. The new chancellor is alliance with %1$s";
g_js_strings.cancelCurrentAllianceRequest = new Object();
g_js_strings.cancelCurrentAllianceRequest.suretocancel = "Are you sure you want to cancel this request?";
g_js_strings.getDirectoryTabAllianceMembers = new Object();
g_js_strings.getDirectoryTabAllianceMembers.viewallmbrs = "View all members";
g_js_strings.getDirectoryTabAllianceMembers.sorrynoofficersa = "Sorry no officers found for the alliance %1$s";
g_js_strings.getDirectoryTabAllianceMembers.jointosee = "Join an alliance to view officers of that alliance here.";
g_js_strings.membersInfo = new Object();
g_js_strings.membersInfo.allilarger = "Want to make the alliance larger?";
g_js_strings.membersInfo.recommalli = "Recommend Friends to Alliance";
g_js_strings.membersInfo.invitealli = "Invite to Alliance";
g_js_strings.membersInfo.msgeveryone = "Message Everyone";
g_js_strings.membersInfo.allilimit = "Your alliance has reached the member limit of 100";
g_js_strings.membersInfo.lastonline = "Last Online";
g_js_strings.membersInfo.youmustbelong = "You need to belong to an alliance to view the members in it.";
g_js_strings.showMemberInfo = new Object();
g_js_strings.showMemberInfo.fbname = "Facebook Name";
g_js_strings.showMemberInfo.datejoinedalli = "Date Joined in Alliance";
g_js_strings.showMemberInfo.daysincurrpos = "Days in the current position";
g_js_strings.confirmActionOnMember = new Object();
g_js_strings.confirmActionOnMember.promoteatob = "Promote %1$s to %2$s";
g_js_strings.confirmActionOnMember.demotetovicechancellor = "This action will demote you to vice chancellor";
g_js_strings.confirmActionOnMember.demoteatob = "Promote %1$s to %2$s";
g_js_strings.confirmActionOnMember.wanttoremovea = "Are you sure you want to remove %1$s from the alliance";
g_js_strings.allianceList = new Object();
g_js_strings.allianceList.reqjoin = "Request To Join";
g_js_strings.allianceList.allifull = "Alliance is Full";
g_js_strings.confirmRequestToJoin = new Object();
g_js_strings.confirmRequestToJoin.youhaverequestwitha = "You have an existing request with this alliance %1$s";
g_js_strings.confirmRequestToJoin.cancelwithaandreqb = "You may only request to join one Alliance at a time. Do you want to cancel your current request with the alliance %1$s and request to join the alliance %2$s ";
g_js_strings.htmlAllianceRequest = new Object();
g_js_strings.htmlAllianceRequest.sendrequest = "Send your request to join alliance";
g_js_strings.htmlAllianceRequest.pendingdrop = "Any pending requests will be dropped";
g_js_strings.htmlAllianceRequest.reqtojoinallia = "Request to join your alliance %1$s";
g_js_strings.htmlAllianceRequest.interestinjoining = "I am interested in joining your alliance";
g_js_strings.htmlAllianceRequest.mystandings = "My Standings";
g_js_strings.htmlAllianceRequest.thanksforconsidering = "Thanks for considering my request";
g_js_strings.showAllianceInfo = new Object();
g_js_strings.showAllianceInfo.backtolist = "Back to Alliance List";
g_js_strings.optionsInAlliance = new Object();
g_js_strings.optionsInAlliance.optionsapply = "Options are applied only to alliance member";
g_js_strings.optionsInAlliance.leavealli = "Leave Alliance";
g_js_strings.getInfoForAnUser = new Object();
g_js_strings.getInfoForAnUser.visitcourt = "Visit Court";
g_js_strings.getInfoForAnUser.sorryprobs = "Sorry, problem in getting player details";
g_js_strings.getInfoForAnUser.plsSelectPlayer = "Please select a player";
g_js_strings.setDiplomacyWindow = new Object();
g_js_strings.setDiplomacyWindow.backalli = "Back to Alliance";
g_js_strings.setDiplomacyWindow.srchalli = "Search for alliance";
g_js_strings.setDiplomacyWindow.setalli = "Set Alliance to";
g_js_strings.setDiplomacyWindow.setdiplo = "Set Diplomacy";
g_js_strings.getAllianceSearchResults = new Object();
g_js_strings.getAllianceSearchResults.entryatleast3 = "Your search entry must be at least 3 characters.";
g_js_strings.getAllianceSearchResults.currdiplo = "Current Diplomacy";
g_js_strings.getAllianceSearchResults.noresults = "There were no results for your search";
g_js_strings.setAllianceDiplomacies = new Object();
g_js_strings.setAllianceDiplomacies.choosediplo = "Please choose a diplomacy status";
g_js_strings.setAllianceDiplomacies.selectatleastone = "Select at least one alliance";
g_js_strings.setAllianceDiplomacies.diplosuccess = "Alliance diplomacy successfully changed";
g_js_strings.modal_alliance = new Object();
g_js_strings.modal_alliance.alliinfo = "Alliance Info";
g_js_strings.modal_alliance.allilist = "Alliance List";
g_js_strings.showClearingTooltip = new Object();
g_js_strings.showClearingTooltip.bdgsite = "Building Site";
g_js_strings.modal_fow_leaderboard = new Object();
g_js_strings.modal_fow_leaderboard.nomatcherr = "No matches were found.  Try Again.";
g_js_strings.modal_fow_leaderboard.searchuser = "Search for User";
g_js_strings.modal_fow_leaderboard.finduser = "Find User";
g_js_strings.modal_fow_leaderboard.searchalli = "Search for Alliance";
g_js_strings.modal_fow_leaderboard.findalli = "Find Alliance";
g_js_strings.modal_fow_leaderboard.backtoleader = "Back to Leaderboard";
g_js_strings.modal_fow_leaderboard.updatemsg = "Leaderboard updated daily";
g_js_strings.modal_fow_leaderboard.emptyessage = "Leaderboard coming soon!";
g_js_strings.getAllianceSearch = new Object();
g_js_strings.getAllianceSearch.searcherrmsg = "You must enter an alliance name that is at least 3 characters.";
g_js_strings.modal_list_alliance = new Object();
g_js_strings.modal_list_alliance.playername = "Player Name";
g_js_strings.modal_list_alliance.offrank = "Officer Rank";
g_js_strings.getUserSearch = new Object();
g_js_strings.getUserSearch.searcherrmsg = "You must enter a user name with at least 3 characters.";
g_js_strings.initializeProgressBar = new Object();
g_js_strings.initializeProgressBar.get12 = "Get <b>TWELVE</b> free Gems just for completing the setup process!";
g_js_strings.initializeProgressBar.get12gems = "Get <b>12 FREE Gems</b> just for completing the setup process!";
g_js_strings.initializeProgressBar.completetxt = "complete!";
g_js_strings.initializeProgressBar.contsetup = "Continue<br>Setup";
g_js_strings.initializeProgressBar.install = "Install";
g_js_strings.initializeProgressBar.bookmark = "Bookmark";
g_js_strings.initializeProgressBar.fan = "Fan";
g_js_strings.initializeProgressBar.permissions = "Permissions";
g_js_strings.initializeProgressBar.subscribe = "Subscribe";
g_js_strings.initializeProgressBar.joinAlliance = "Join An Alliance";
g_js_strings.modal_progress_actions = new Object();
g_js_strings.modal_progress_actions.subscribetxt = "Subscribe to the Kingdoms of Camelot newsletter";
g_js_strings.modal_progress_actions.publishper = "Publish Permission";
g_js_strings.modal_progress_actions.enabletxt = "Enable permissions for Kingdoms of Camelot";
g_js_strings.modal_progress_actions.becomefan = "Become a Fan";
g_js_strings.modal_progress_actions.becometxt = "Become a fan of Kingdoms of Camelot";
g_js_strings.modal_progress_actions.addbook = "Add Bookmark";
g_js_strings.modal_progress_actions.bookmarktxt = "Bookmark Kingdoms of Camelot";
g_js_strings.modal_progress_actions.installtxt = "Install Kingdoms of Camelot";
g_js_strings.modal_progress_actions.updatestatus = "Update Status";
g_js_strings.modal_progress_actions.remindlater = "Remind Me Later";
g_js_strings.modal_progress_actions.pressbutton = "* Press the &quot;%1$s&quot; button to check your setup status.";
g_js_strings.modal_progress_actions.upto24 = "** Status may take up to 24 hours to update.";
g_js_strings.modal_progress_actions.joinAlliance = "Build an Embassy and Join an Alliance";
g_js_strings.modal_gems_gained = new Object();
g_js_strings.modal_gems_gained.msg1 = "You got a gem! Great work! Keep it up!";
g_js_strings.modal_gems_gained.msg2 = "Good work! You got two gems! Keep going!";
g_js_strings.modal_gems_gained.msg3 = "Nearly there! You got three gems! Only one step left!";
g_js_strings.modal_gems_gained.msg4 = "Well done! You completed the setup process and gained six gems!";
g_js_strings.modal_gems_not_gained = new Object();
g_js_strings.modal_gems_not_gained.uhoh = "Uh oh. You didn't get any gems. If you completed a step, this means that either you hit &quot;Cancel&quot; instead of accept, or Facebook simply hasn't updated yet and you should try again in a few hours.";
g_js_strings.barbarian = new Object();
g_js_strings.barbarian.atthegates = "Barbarians at the Gates!";
g_js_strings.barbarian.atthegatesdesc = "The Barbarians have attacked this city! For each Player who helps defend, the defending Player stands a better chance of repelling the Barbarians. When ten Players are helping to defend, or the clock hits zero, the Barbarians and defending forces will battle!";
g_js_strings.barbarian.lendaid = "Lend Aid";
g_js_strings.barbarian.giveaid = "Players Giving Aid";
g_js_strings.barbarian.sendtroops = "Send Troops";
g_js_strings.barbarian.capped = "Your troops losses, win or lose, are capped at 25%.";
g_js_strings.barbarian.foreignaid = "Foreign Aid";
g_js_strings.barbarian.foreignaiddesc = "Foreign Aid is help from other Domains.";
g_js_strings.barbarian.invasionreport = "Barbarian Invasion Report";
g_js_strings.barbarian.invasionreportdesc = " 	From here you can track the progress of the Barbarians rampaging throughout the Domain. You can see your Allies and Friends who have cities in need of aid. You can also check and see if you have a City under attack! Lend them a hand to help slow the spread of the Barbarians in your Domain!";
g_js_strings.barbarian.invasionreportnote = "Your troops loses, win or lose, are capped at 25%.";
g_js_strings.barbarian.numofattacks = "%1$s Attacks";
g_js_strings.barbarian.barbarianprogress = "BARBARIAN PROGRESS";
g_js_strings.barbarian.youareunderattack = "You're Under Attack!";
g_js_strings.barbarian.clickheretodefend = "Click here to defend!";
g_js_strings.barbarian.alliesunderattack = "Allies under Attack";
g_js_strings.barbarian.friendsunderattack = "Friends under Attack";
g_js_strings.barbarian.kingarthurbrokerspeace = "King Arthur brokers peace!";
g_js_strings.barbarian.kingarthurbrokerspeacedesc = "King Arthur has worked to reach a peace accord with the Barbarians who have been rampaging throughout the Domain recently. For now, things are quiet, but the Barbarians are violent by their very nature, and the threat of invasion could return again at any time. Remain vigilant.";
g_js_strings.barbarian.attacksrepelled = "Attacks Repelled!";
g_js_strings.barbarian.attacksyourepelled = "Attacks you repelled!";
g_js_strings.barbarian.attacksalliancerepelled = "Attacks your Alliance repelled!";
g_js_strings.barbarian.attacksyouhelpedrepel = "Attacks you helped repel!";
g_js_strings.barbarian.mercenariesdispatched = "You've dispatched a small band of Mercenaries to help!";
g_js_strings.barbarian.helpmore = "Would you like to help more ?";
g_js_strings.barbarian.hiremercenaries = "Hire Mercenaries";
g_js_strings.barbarian.defendmyself = "Defend Myself";
g_js_strings.barbarian.troopfromcity = "What City do you want to take troops from?";
g_js_strings.barbarian.goldfromcity = "What City do you want to take the gold for the Mercenaries from?";
g_js_strings.barbarian.selectacity = "Select a City";
g_js_strings.barbarian.whatlevelofmercenaries = "What level of Mercenaries would you like to send?";
g_js_strings.barbarian.lightmercenaries = "Light Mercenaries";
g_js_strings.barbarian.lightmercenariesdesc = "Made up of mostly low-level troops, something is certainly better than nothing. Every bit helps defend.";
g_js_strings.barbarian.mediummercenaries = "Medium Mercenaries";
g_js_strings.barbarian.mediummercenariesdesc = "A bit more hardened of troops who have seen their share of battles and offer real help.";
g_js_strings.barbarian.heavymercenaries = "Heavy Mercenaries";
g_js_strings.barbarian.heavymercenariesdesc = "The elite of the elite, soldiers of fortune who turn the tide of any battle ... for a high price.";
g_js_strings.barbarian.selecttroops = "Select the number of troops you'd like to send";
g_js_strings.barbarian.cannotexceed = "The number of troops cannot exceed 100,000";
g_js_strings.barbarian.totaltroopsbeingdeployed = "Total troops being deployed:";
g_js_strings.barbarian.youhavedefended = "You have defended your city!";
g_js_strings.barbarian.mustsendatleast = "You must send at least 1 troop";
g_js_strings.barbarian.erroroccured = "Error occured";
g_js_strings.barbarian.callforhelp = "Call For Help!";
g_js_strings.barbarian.barbarianscomming = "Barbarians are coming!";
g_js_strings.barbarian.barbariansatthegates = "Barbarians At The Gates";
g_js_strings.barbarian.peacedeclared = "Peace";
g_js_strings.barbarian.buttoninvasionreport = "Invasion Report";
g_js_strings.barbarian.cannotgetalliesfriends = "Cannot get Allies and friends under attack";
g_js_strings.barbarian.havesenttroops = "You have sent troops to help your friend";
g_js_strings.barbarian.havesentmercenaries = "You have sent Mercenaries to help your friend";
g_js_strings.barbarian.errorcode = "Error Code: %1$s";
g_js_strings.barbarian.barbarianwin = "Barbarians defeated you";
g_js_strings.barbarian.barbarianlose = "You defeated Barbarians";
g_js_strings.barbarian.notenoughgold = "You do not have enough gold to send Mercenaries";
g_js_strings.barbarian.backtogame = "Back to Game";
g_js_strings.barbarian.youwereattackedrecently = "You were attacked recently.";
g_js_strings.barbarian.safeforatleast = "You are safe for at least:";
g_js_strings.barbarian.troopscapped = "Your troop losses, regardless of outcome, are capped at 25%.";
g_js_strings.barbarian.cityname = "City name";
g_js_strings.barbarian.playername = "Player name";
g_js_strings.modal_myitems_use_escape = new Object();
g_js_strings.modal_myitems_use_escape.currentcoor = "Your Current Coordinates";
g_js_strings.modal_myitems_use_escape.newcoor = "New Coordinates:";
g_js_strings.modal_myitems_use_escape.yourcurrentname = "Your Current name is";
g_js_strings.modal_myitems_use_escape.newname = "New Name";
g_js_strings.modal_myitems_use_escape_do = new Object();
g_js_strings.modal_myitems_use_escape_do.aused = "%1$s used!";
g_js_strings.modal_myitems_use_escape_do.teleportto = "Teleported to";
g_js_strings.modal_myitems_use_escape_do.namechangedto = "Name changed to";
g_js_strings.WildDefense = new Object();
g_js_strings.WildDefense.trapdesc = "Much like the modern land mine, these traps are buried around the wilderness, and deal damage to unsuspecting enemy attackers. Traps are destroyed when triggered, and will need to be rebuilt manually. Traps built in wildernesses are built immediately, and only cost Gold, not other resources.";
g_js_strings.WildDefense.mercdesc = "Soldiers of fortune who will defend your lands for you while your troops are away. The number of Mercenaries is determined by the level of the Wilderness they are defending. They automatically replenish hourly, and will completely desert if they cannot be paid.";
g_js_strings.WildDefense.costeach = "%1$s Gold each";
g_js_strings.WildDefense.costhour = "%1$s Gold/hr";
g_js_strings.WildDefense.nogold = "You do not have enough Gold to purchase those Traps.";
g_js_strings.WildDefense.nochange = "You did not change your Mercenary setting.";
g_js_strings.WildDefense.overmax = "You cannot build more than 1000 Traps per Wilderness.";
g_js_strings.WildDefense.validnumber = "Please enter a valid number.";
g_js_strings.WildDefense.mercnone = "None Hired";
g_js_strings.WildDefense.mercconfirm = "By hiring these mercenaries, you will be charged %1$s Gold immediately, and then %2$s Gold every hour. Do you still wish to hire %3$s Mercenaries?";
g_js_strings.WildDefense.mercconfirmnone = "Setting your Mercenaries to None will immediately dismiss your Mercenaries. Do you still wish to set your Mercenaries to None?";
g_js_strings.WildDefense.youhave = "You Have";
g_js_strings.WildDefense.atraps = "%1$s Traps";
g_js_strings.WildDefense.agold = "%1$s Gold";
g_js_strings.WildDefense.tobuild = "Traps to Build:";
g_js_strings.AddCity = new Object();
g_js_strings.AddCity.tobuilda = "To build your %1$s, you need to:";
g_js_strings.AddCity.obtainadeed = "Obtain a %1$s Deed";
g_js_strings.AddCity.controlplain = "Control a Plain";
g_js_strings.AddCity.reachlvl = "Reach Level 7 or Higher";
g_js_strings.AddCity.noqualseconddeed = "You do not own a Second City Deed. Invite more friends or purchase a Second City Deed from the shop.";
g_js_strings.AddCity.qualseconddeed = "You do not own a Second City Deed, but have the friends needed to obtain one. Click on Claim to get your Second City Deed.";
g_js_strings.AddCity.noqualthirddeed = "You do not own a Third City Deed. You need to obtain more Crests. Get Crests by attacking unowned Level 5 to 10 Wildernesses, or by purchasing Squire&#39;s Chests in the shop. Here is your current Crest count towards your Third City Deed:";
g_js_strings.AddCity.qualthirddeed = "You do not own a Third City Deed. You have obtained all the Crests you need, but have not claimed your Third City Deed. Click on Claim to get your Third City Deed.";
g_js_strings.AddCity.noqualfourthdeed = "You do not own a Fourth City Deed. You need to obtain more Crests. Get Crests by attacking unowned Level 6 to 10 Wildernesses, or by purchasing Squire&#39;s and Knight&#39;s Chests in the shop. Here is your current Crest count towards your Fourth City Deed:";
g_js_strings.AddCity.qualfourthdeed = "You do not own a Fourth City Deed. You have obtained all the Crests you need, but have not claimed your Fourth City Deed. Click on Claim to get your Fourth City Deed.";
g_js_strings.AddCity.noqualfifthdeed = "You do not own a Fifth City Deed. You need to obtain more Crests. Get Crests by attacking unowned Level 8 to 10 Wildernesses, or by purchasing Knight's and Lord's Chests in the shop. Here is your current Crest count towards your Fifth City Deed:";
g_js_strings.AddCity.qualfifthdeed = "You do not own a Fifth City Deed. You have obtained all the Crests you need, but have not claimed your Fifth City Deed. Click on Claim to get your Fifth City Deed.";
g_js_strings.AddCity.noqualsixthdeed = "You do not own a Sixth City Deed. You need to obtain more Crests and Seals. Get Seals by attacking unowned Level 8 to 10 Wildernesses, or by purchasing Fay's Chests in the shop. Here is your current Seal count towards your Sixth City Deed:";
g_js_strings.AddCity.qualsixthdeed = "You do not own a Sixth City Deed. You have obtained all the Crests you need, but have not claimed your Sixth City Deed. Click on Claim to get your Sixth City Deed.";
g_js_strings.AddCity.noqualseventhdeed = "You do not own a Seventh City Deed. You need to obtain more Seals. Get Seals by attacking unowned Level 8 to 10 Wildernesses, or by purchasing Chests in the shop. Here is your current Seal count towards your Seventh City Deed:";
g_js_strings.AddCity.qualseventhdeed = "You do not own a Seventh City Deed. You have obtained all the Crests you need, but have not claimed your Seventh City Deed. Click on Claim to get your Seventh City Deed.";
g_js_strings.AddCity.noqualeighthdeed = "You do not own an Eighth City Deed. You need to obtain more Seals. Get Seals by attacking Dark Forests, or by purchasing Chests in the shop. Here is your current Seal count towards your Eighth City Deed:";
g_js_strings.AddCity.qualeighthdeed = "You do not own an Eighth City Deed. You have obtained all the Seals you need, but have not claimed your Eighth City Deed. Click on Claim to get your Eighth City Deed.";
g_js_strings.AddCity.noqualfeydeed = "You do not own an Fey Deed. You need to obtain more Seals. Get Seals by attacking Dark Forests, or by purchasing Chests in the shop. Here is your current Seal count towards your Fey Deed:";
g_js_strings.AddCity.qualfeydeed = "You do not own an Fey Deed. You have obtained all the Seals you need, but have not claimed your Fey Deed. Click on Claim to get your Fey Deed.";
g_js_strings.AddCity.nolvlqual = "You are not yet Level 7 or higher.";
g_js_strings.AddCity.reachlvl = "Reach Level 7 or Higher";
g_js_strings.AddCity.noplainqual = "You do not control a Plain. Go to the map and conquer a Plain to build your New City upon it.";
g_js_strings.AddCity.selectplain = "Select the Plain and choose Build to start your New City!";
g_js_strings.postToProfile = new Object();
g_js_strings.postToProfile.textboxtitle = "Add a personal message for your friends";
g_js_strings.payment = new Object();
g_js_strings.payment.payment_heading = "Add Coins & Cash";
g_js_strings.payment.buy_epic_cash = "Buy Epic Cash";
g_js_strings.payment.buy_epic_coins = "Buy Epic Coins";
g_js_strings.payment.buy_coins = "Buy Coins";
g_js_strings.payment.back_to_purchase_options = "Back to Epic Cash and Coins purchase options";
g_js_strings.payment.epic_cash_for_cur_symbol = "Epic Cash for $";
g_js_strings.payment.coins_for_cur_symbol = "Coins for $";
g_js_strings.payment.get_better_stuff = "Get better stuff with your Epic Cash";
g_js_strings.payment.want_more_coins = "Want more coins? Buy some now!";
g_js_strings.payment.get_epic_cash_directly = "Get Epic Cash Directly";
g_js_strings.payment.other_ways_to_get_epic_cash = "Other Ways to get Epic Cash";
g_js_strings.payment.in_single_txn = "in a single transaction";
g_js_strings.towncrier = new Object();
g_js_strings.towncrier.newannoucement = "New Announcement!";
g_js_strings.towncrier.annoucementcaravan = "Announcement Caravan";
g_js_strings.towncrier.noannouncements = "There are no announcements.";
g_js_strings.recall = {};
g_js_strings.recall.header = "Recall Troops?";
g_js_strings.recall.ask = "Recalling troops will add 25% of the time they have been marching to their return march.  Are you sure you want to recall your troops?";
g_js_strings.recall.error = "Sorry! You cannot recall your troops with less than 1 minute remaining on the march.";
g_js_strings.shop = {};
g_js_strings.shop.newitem = "New!";
g_js_strings.shop.saleitem = "Sale!";
g_js_strings.incomingattack = {};
g_js_strings.incomingattack.attackrecalled = "Attack Recalled!";
g_js_strings.incomingattack.attackfromattackerrecalled = "Attack from %1$s has been recalled";
g_js_strings.incomingattack.unknown = "unknown";
g_js_strings.modal_auto_attack = {};
g_js_strings.modal_auto_attack.barbarianraids = "Barbarian Raids";
g_js_strings.modal_auto_attack.restartraidtimer = "Restart Raid Timer";
g_js_strings.modal_auto_attack.stopraidingiftrooplevelsarelessthan = "Stop Raiding if Troop levels are less than";
g_js_strings.modal_auto_attack.autodeletebattlereports = "Auto Delete Battle Reports";
g_js_strings.modal_auto_attack.addraid = "Add Raid";
g_js_strings.modal_auto_attack.resume = "Resume";
g_js_strings.modal_auto_attack.stopall = "Stop All";
g_js_strings.modal_auto_attack.resumeall = "Resume All";
g_js_strings.modal_auto_attack.youdonothaveanysavedraids = "You do not have any saved Raids";
g_js_strings.modal_auto_attack.addaraid = "Add a Raid";
g_js_strings.modal_auto_attack.now = "now";
g_js_strings.modal_auto_attack.stop = "Stop";
g_js_strings.modal_auto_attack.deleteraidconfirmtitle = "Delete Barbarian Raid";
g_js_strings.modal_auto_attack.deleteraidconfirmcontent = "Are you sure you want to delete this Barbarian Raid";
g_js_strings.modal_auto_attack.lastmarch = "Last March";
g_js_strings.modal_auto_attack.roundtrip = "Round Trip";
g_js_strings.modal_auto_attack.stopped = "Stopped";
g_js_strings.modal_auto_attack.insufficienttroops = "Insufficient Troops";
g_js_strings.modal_auto_attack.maxraidsexceeded = "Max Raids Exceeded";
g_js_strings.modal_auto_attack.timedout = "Timed Out";
g_js_strings.modal_auto_attack.resting = "Resting";
g_js_strings.modal_auto_attack.pausehelp = "This feature will cause that Raid to stop if the number of current troops within a Raid is less than the percentage of total troops originally committed to that Raid. This can happen if troops are lost during a Raid against the Barbarians. Setting this percentage lower will allow your Raid to continue with greater troop loses.";
g_js_strings.modal_auto_attack.unavailableknight = "Knight Unavailable";
g_js_strings.modal_auto_attack.rplimitreached = "Rally Point Limit Reached";
g_js_strings.modal_auto_attack.raidtimertooltip = "Raid Timer allows you to Raid Barbarian camps continuously for up to 24 hours. Barbarian Raids can only be active when the timer is running. Once the Raid Timer times-out, all Barbarian Raids will be stopped until the timer is restarted and raids are resumed.";
g_js_strings.modal_auto_attack.autodeletereporttooltip = "Note that while you are not logged in no Barbarian Raid reports will be generated, and all Raid reports will be cleared after 3 days. Checking this option will allow auto delete of all battle reports from Barbarian Raids.";
g_js_strings.modal_auto_attack.stopallconfirmbutton = "Stop All Barbarian Raidings";
g_js_strings.modal_auto_attack.stopallconfirmbuttonmessage = "Raids will stop after march has been completed and troops have returned.";
g_js_strings.modal_auto_attack.stopallconfirmtitle = "Stop All Barbarian Raidings";
g_js_strings.modal_auto_attack.stopallconfirmmessage = "Are you sure you want to stop all Barbarian Raids?";
g_js_strings.modal_auto_attack.stopconfirmbutton = "Stop After Troops Return";
g_js_strings.modal_auto_attack.stopconfirmbuttonmessage = "Raid will stop after march has been completed and troops have returned.";
g_js_strings.modal_auto_attack.stopconfirmtitle = "Stop after Raiding";
g_js_strings.modal_auto_attack.stopconfirmmessage = "Are you sure you want to stop this Barbarian Raid?";
g_js_strings.modal_auto_attack.stopping = "Stopping";
g_js_strings.modal_auto_attack.barbarianraidoptions = "Barbarian Raid Options";
g_js_strings.modal_auto_attack.troopoptions = "Troop Options";
g_js_strings.modal_auto_attack.autostopraid = "If troops were lost during a Barbarian Raid, stop raiding when remaining troop levels are less than";
g_js_strings.modal_auto_attack.autostopraiddescription = "Using this option will limit troop losses to only the number of troops saved into a Barbarian Raid.";
g_js_strings.modal_auto_attack.autorefilltroop = "If troops were lost during a Barbarian Raid, continue raiding and allow Raids to be replenished to saved levels with troops from your city.";
g_js_strings.modal_auto_attack.autorefilltroopexception = "Do not replenish troops if the battle was lost.";
g_js_strings.modal_auto_attack.autorefilltroopdescription = "Caution: this option can maximize loot yield, but will cause losses in your city beyond what is saved into a Barbarian Raid.";
g_js_strings.modal_auto_attack.reportoptions = "Report Options";
g_js_strings.modal_auto_attack.reportlifetimedescription = "Barbarian Raid reports will be kept for 3 days unless otherwise specified.";
g_js_strings.modal_auto_attack.autodeleteallreport = "Automatically delete all Barbarian Raid reports.";
g_js_strings.modal_auto_attack.whatisabarbarianraid = "What is a Barbarian Raid?";
g_js_strings.modal_auto_attack.whatisabarbarianraidtooltip = "Barbarian Raids allow you to loot Barbarian Camps automatically. Add a Raid by clicking + Add Raid button on the left. You can select save a Knight, Troops, and a Barbarian Camp location to a Raid.";
g_js_strings.LevelUp = {};
g_js_strings.LevelUp.levelUp = "Level Up!";
g_js_strings.LevelUp.congratulations = "Congratulations! You reached Level %1$s";
g_js_strings.LevelUp.yourReward = "Your Reward";
g_js_strings.LevelUp.celebrate = "Celebrate";
g_js_strings.LevelUp.failedToClaimReward = "Failed to claim the reward, please try again later.";
g_js_strings.guardian = {};
g_js_strings.guardian.askForHelp = "Ask for help from friends";
g_js_strings.guardian.timeStr = "Time";
g_js_strings.guardian.upgradeStr = "Upgrade time left";
g_js_strings.guardian.cl1 = "Current Level";
g_js_strings.guardian.ul1 = "Upgrade Level";
g_js_strings.guardian.divineinsp = "Divine Ins.";
g_js_strings.guardian.description = "Your Guardian is the protector of your city. Its elemental powers increase your resource capabilities and strengthen the attributes of your troops.";
g_js_strings.guardian.cancel = "Guardian Construction canceled.";
g_js_strings.guardian.getResources = "You get the following resources when you cancel your guardian: (Note: your Divine Inspiration will not be returned) ";
g_js_strings.guardian.nameEmpty = "You need to enter a name before proceeding.";
g_js_strings.guardian.inventory = "Inventory";
g_js_strings.guardian.unlock = "Unlock";
g_js_strings.guardian.transformCost = "Cost: 1X Element Rebirth";
g_js_strings.guardian.level = "Level";
g_js_strings.wood_guardian = {};
g_js_strings.wood_guardian.description = "Your Guardian is the protector of your city. The Weald Fenrir increases your Wood resource capabilities and strengthens the HP attribute of your troops.";
g_js_strings.ore_guardian = {};
g_js_strings.ore_guardian.description = "Your Guardian is the protector of your city. The Iron Indrik increases your Ore resource capabilities and strengthens the Attack attribute of your troops.";
g_js_strings.food_guardian = {};
g_js_strings.food_guardian.description = "Your Guardian is the protector of your city.  The Viand Kraken increases your Food resource capabilities and increases the Marching Speed attribute of your troops.";
g_js_strings.stone_guardian = {};
g_js_strings.stone_guardian.description = "Your Guardian is the protector of your city. The Emet Golem increases your Stone resource capabilities and increases the training speed of your troops.";
g_js_strings.guardian_item = {};
g_js_strings.guardian_item.title = "Change Name";
g_js_strings.guardian_item.description = "Choose a name for your guardian.  Names must be 15 characters or less.";
g_js_strings.guardian_item.use = "Use";
g_js_strings.guardian.create = "Please create a name that is only 1 - 15 letters and/or characters.";
g_js_strings.guardian.nospace = "Please create a name that is only 1 - 15 letters and/or characters, no spaces.";
g_js_strings.guardian.tooltipName = "Click here to change the name of your Guardian.";
g_js_strings.guardian.changeName = "First summon a Guardian and then click here to change its name.";
g_js_strings.guardian.tooltip = "Summon a Guardian to Protect Your City and Help You in Battle";
g_js_strings.guardian.donthave = "Renaming Ritual is required to change your Guardian's name. You can purchase this from the General section of the Shop.";
g_js_strings.guardian.release = "Are you sure you want to release your Guardian?  This will remove your Guardian and make your Guardian tile level 0.";
g_js_strings.guardian.release_text = "Release";
g_js_strings.guardian.buy_transform = "Buy and Transform";
g_js_strings.guardian.buy_unlock = "Buy and Unlock";
g_js_strings.guardian.summonWarningOre = "Are you sure you want to change your Ore Guardian? The Attack boost for active marches will no longer be applied.";
g_js_strings.guardian.summonWarningWood = "Are you sure you want to change your Wood Guardian? The Health boost for defending troops will no longer be applied.";
g_js_strings.guardian.summonWarningFood = "Are you sure you want to change your Food Guardian?  The March Speed boost for active marches will no longer be applied.";
g_js_strings.guardian.tooltipFigure_0 = "Upgrade to level 1 to summon your Guardian. You receive resource bonuses from all your Guardians but only troop bonuses from your active Guardian.";
g_js_strings.guardian.tooltipFigure_1 = "This is your active Guardian. You receive resource bonuses from all your Guardians but only troop bonuses from your active Guardian";
g_js_strings.guardian.tooltipResource = "These are requirements to upgrade your active Guardian.";
g_js_strings.guardian.tooltipAttr = "These are the resource bonuses you receive from all of your Guardians.";
g_js_strings.guardian.tooltipAttrReceived = "This is the troop attribute bonus you receive from your active Guardian.";
g_js_strings.guardian.tooltipSetBonus = "Once you have unlocked all the Guardians you will be granted a special bonus.";
g_js_strings.guardian.tooltipSummon_wood = "The Weald Fenrir increases your wood production, capacity and boosts the HP attribute of your troops on defense.";
g_js_strings.guardian.tooltipSummon_ore = "The Iron Indrik increases your ore production, capacity and boosts the Attack attribute of your troops in marches.";
g_js_strings.guardian.tooltipSummon_food = "The Viand Kraken increases your food production, capacity and boosts the Marching Speed attribute of your troops in marches.";
g_js_strings.guardian.tooltipSummon_stone = "The Emet Golem increases your stone production, capacity and boosts the training speed of your troops.";
g_js_strings.guardian.tooltipSummon_comingsoon = "This Guardian will be released soon.";
g_js_strings.guardian_err = {};
g_js_strings.guardian_err.missItemFrInvt = "Item not in the inventory.";
g_js_strings.guardian_err.missItemFrEquip = "Item not in the equipment.";
g_js_strings.guardian_err.upgrading = "You cannot equip or unequip armor while your Guardian is upgrading.";
g_js_strings.guardian_err.invtFullWhenEquip = "You need to discard excess armor or purchase additional inventory slots before equipping your Guardian.";
g_js_strings.guardian_err.invtFullWhenUnequip = "You need to discard excess armor or purchase additional inventory slots before unequipping your Guardian.";
g_js_strings.guardian_err.notEnoughGems = "You do not have enough Gems to purchase this item.";
g_js_strings.guardian_err.getMore = "Get More Gems.";
g_js_strings.guardian.setBonus = "Set Bonus!";
g_js_strings.guardian.setBonusAchieved = "Set Bonus is currently active.";
g_js_strings.guardian.setBonusAchievedTooltip = "Increases the Active Guardian&#146;s bonuses by 50%.  Additionally, it grants 50% of the Troop Bonuses for all Inactive Guardians.";
g_js_strings.guardian.setBonus_notavailable = "No set bonus";
g_js_strings.guardian.setBonus_simple_sustenance = "All Resource Production +2%";
g_js_strings.guardian.setBonus_durable_offense = "Troop Attack +5%";
g_js_strings.guardian.wood_name = "Weald Fenrir";
g_js_strings.guardian.wood_fullName = "Weald Fenrir(Wood Guardian)";
g_js_strings.guardian.wood_attr = "Attribute: Troop HP";
g_js_strings.guardian.wood_res0 = "Resource: Wood";
g_js_strings.guardian.wood_res1 = "(Production + Cap)";
g_js_strings.guardian.wood_desc = "A towering beast of timber and tightly controlled fury, the Weald Fenrir stalks the borders of his territory.  His stolid presence inspires fortitude in allies and terror in foes.  When he lifts his paws, vines and flowers spring up beneath the shadow, and leave terrible gashes in his enemies.";
g_js_strings.guardian.choose_a_guardian = "Choose a Guardian";
g_js_strings.guardian.unlock_a_guardian = "Unlock a Guardian";
g_js_strings.guardian.transform_a_guardian = "Transform a Guardian";
g_js_strings.guardian.are_you_sure = "Are you sure you want to use a Divine Inspiration?";
g_js_strings.guardian.ore_name = "Iron Indrik";
g_js_strings.guardian.ore_fullName = "Iron Indrik(Ore Guardian)";
g_js_strings.guardian.ore_attr = "Attribute: Troop Attack";
g_js_strings.guardian.ore_res0 = "Resource: Ore";
g_js_strings.guardian.ore_res1 = "(Production + Cap)";
g_js_strings.guardian.ore_desc = "Magma flows in the Iron Indriks veins and where other creatures would have a streaming mane, the Indrik wears flame.  Black smoke billows and lava drips from his maw.  Spears cannot pierce his hematite hide.  Its fiery retaliation makes it a difficult beast to befriend and a dangerous enemy.";
g_js_strings.guardian.ore_unlock = "Unlock ore guardian";
g_js_strings.guardian.ore_unlockCost = "Cost: 1X Obsidian Rune";
g_js_strings.guardian.food_name = "Viand Kraken";
g_js_strings.guardian.food_fullName = "Viand Kraken(Food Guardian)";
g_js_strings.guardian.food_attr = "Attribute: Marching Speed";
g_js_strings.guardian.food_res0 = "Resource: Food";
g_js_strings.guardian.food_res1 = "(Production + Cap)";
g_js_strings.guardian.food_desc = "The Viand Kraken rises from the depths, a carapace covering its backside and its many-fanged mouth jutting from a blunt face.  Ink-black eyes dot the sides of the creatures head, and arm-like tentacles spring from below the head.  The murky water of its pool seems far deeper than any know; investigating the pond enrages the Kraken.";
g_js_strings.guardian.food_unlock = "Unlock food guardian";
g_js_strings.guardian.food_unlockCost = "Cost: 1X Deluge Rune";
g_js_strings.guardian.stone_name = "Emet Golem";
g_js_strings.guardian.stone_fullName = "Emet Golem(Stone Guardian)";
g_js_strings.guardian.stone_attr = "Attribute: Training Speed";
g_js_strings.guardian.stone_res0 = "Resource: Stone";
g_js_strings.guardian.stone_res1 = "(Production + Cap)";
g_js_strings.guardian.stone_desc = "The Emet Golem is a hulking creation of stone and crystal dimly representing a human.  The Golem is a motionless observer to all around it, save for its crystalline eyes.  When given orders, the Emet Golem carries out its duties unquestioningly.  Its stone body makes it an excellent training dummy and stalwart defender.";
g_js_strings.guardian.stone_unlock = "Unlock stone guardian";
g_js_strings.guardian.stone_unlockCost = "Cost: 1X Stone Rune";
g_js_strings.ImpendingAttacks = {};
g_js_strings.ImpendingAttacks.marchTypeFrom = "{marchType} from {genderTitle} {name}";
g_js_strings.ImpendingAttacks.targetCity = "{cityName} at {coordinate}";
g_js_strings.ImpendingAttacks.targetWilderness = "{wilderness} at {coordinate}";
g_js_strings.ImpendingAttacks.clickHereForMoreInfo = "click here for more info";
g_js_strings.ImpendingAttacks.clickHere = "Click Here";
g_js_strings.ImpendingAttacks.noIncomingAttacks = "No incoming attacks.";
g_js_strings.ImpendingAttacks.impengingAttackGoToCity = "Impending Attack! Go to city";
g_js_strings.ImpendingAttacks.recalled = "Recalled";
g_js_strings.ImpendingAttacks.incoming = "Incoming";
g_js_strings.ImpendingAttacks.askAllianceForHelpCity = "Help! My city {cityName} is under attack! Please send reinforcements to {coordinate}";
g_js_strings.ImpendingAttacks.askAllianceForHelpWilderness = "Help! My {wilderness} is under attack! Please send reinforcements to {coordinate}";
g_js_strings.ImpendingAttacks.watchTowerReport = "Watch Tower Report";
g_js_strings.ImpendingAttacks.takeAction = "Take action to give yourself the best advantage during an attack";
g_js_strings.ImpendingAttacks.buffs = "Buffs";
g_js_strings.ImpendingAttacks.fight = "Fight";
g_js_strings.ImpendingAttacks.troopSettings = "Troop Settings";
g_js_strings.ImpendingAttacks.troopSettingsTip = "This will bring you to the Castle, where you are able to order your troops to defend or hide.";
g_js_strings.ImpendingAttacks.buildDefensesTip = "This will bring you to the Wall, where you can begin building defensive units in anticipation of this attack.";
g_js_strings.ImpendingAttacks.trainTroopsTip = "This will bring you to the Barracks, where you can begin training troops in anticipation of this attack.";
g_js_strings.ImpendingAttacks.askForHelpTip = "This will automatically create a chat message to your alliance asking them to send reinforcements to this city.";
g_js_strings.guardian.guardians = "Guardians";
g_js_strings.guardian.summoning = "Summoning Guardian in ";
g_js_strings.guardian.permanentlyReduce = "Summon all Guardians to unlock";
g_js_strings.gemGifting = {};
g_js_strings.gemGifting.congratulations = "Congratulations!";
g_js_strings.gemGifting.notificationMessage = "You have received <b>{gemAmount}</b> gems from <b>{gifter.name}</b>!";
g_js_strings.gemGifting.notificationMessageAlliance = "You have received <b>{gemAmount}</b> gems from <b>{gifter.name}</b> in <b>{gifter.alliance}</b> from <b>{gifter.world}</b>!";
g_js_strings.DailyRewards = {};
g_js_strings.DailyRewards.title = "Daily Reward";
g_js_strings.DailyRewards.notification = "My Lord, I have been sent to reward you for your prowess on the battlefield. Return daily for better rewards.";
g_js_strings.DailyRewards.itemAdded = "This item has been added to your inventory";
g_js_strings.DailyRewards.itemNotification = " has been added to your inventory";
g_js_strings.DailyRewards.day = "Day";
g_js_strings.DailyRewards.button = "OK";
g_js_strings.DailyRewards.share = "Claim & Share with Friends";
g_js_strings.messages = {};
g_js_strings.messages.moreActions = "More Actions";
g_js_strings.messages.selectGroup = "Select Group";
g_js_strings.messages.youarenot = "You are not in an alliance.";
g_js_strings.beginnerPackage = {};
g_js_strings.beginnerPackage.title = "Beginner's Sale!!";
g_js_strings.beginnerPackage.titleDollar = "Beginner's Sale!! {percentOff}% Off!";
g_js_strings.beginnerPackage.gems = "200 Gems for <div class='red'>{percentOff}% Off!</div>";
g_js_strings.beginnerPackage.gemsDollar = "200 Gems for only <span class='oldPri'> ${dollarAmountFull} </span><div class='red'>${dollarAmount}!</div>";
g_js_strings.beginnerPackage.itemsTitle = "Includes a FREE Chest with 39 Bonus Items!";
g_js_strings.beginnerPackage.itemText0 = "Speed Ups<br/>x9";
g_js_strings.beginnerPackage.itemText1 = "Resources<br/>x20";
g_js_strings.beginnerPackage.itemText2 = "Boosts<br/>x9";
g_js_strings.beginnerPackage.itemText3 = "Game Tokens<br/>x1";
g_js_strings.beginnerPackage.timeLeft = "Offer ends in: <span class='red'>{timeLeft.days}d {timeLeft.hours}h {timeLeft.minutes}m</span>";
g_js_strings.beginnerPackage.buynow = "<div class='text'>BUY NOW</div>";
g_js_strings.beginnerPackage.countDownText = "Beginner's Sale Time Left: {days}d {hours}h {minutes}m";
g_js_strings.title = {};
g_js_strings.title.text = "Share Kingdoms of Camelot on Facebook!";
g_js_strings.salesPromotion = {};
g_js_strings.salesPromotion.title = "Welcome Back!!";
g_js_strings.salesPromotion.comingBackSale = "Just for coming back, we're offering you a huge sale on %1$s.";
g_js_strings.salesPromotion.percentOff = "%1$s% Off!";
g_js_strings.salesPromotion.freeItemsForReturning = "Also, here are some FREE items for returning!";
g_js_strings.salesPromotion.offerEnds = "Offer ends in: ";
g_js_strings.salesPromotion.saleTimeLeft = "Sale Time Left:";
g_js_strings.salesPromotion.goToShop = "Go to Shop";
g_js_strings.monsterUnitsNames = {};
g_js_strings.monsterUnitsNames.m101 = "Wanderer of Din";
g_js_strings.monsterUnitsNames.m102 = "Blade of Netzekt";
g_js_strings.monsterUnitsNames.m103 = "Arm of Gevrah";
g_js_strings.monsterUnitsNames.m104 = "Priest of Yeshod";
g_js_strings.monsterUnitsNames.m105 = "Sahereen Hound";
g_js_strings.monsterUnitsNames.m106 = "Remez Banshee";
g_js_strings.monsterUnitsNames.m107 = "Son of Ysbadden";
g_js_strings.monsterUnitsNames.m108 = "Atzmus Rider";
g_js_strings.monsterUnitsNames.m109 = "Sidhe Scorpion";
g_js_strings.monsterUnitsNames.m110 = "Sidhe Templar";
g_js_strings.battleReport = {};
g_js_strings.battleReport.wasCrushed = "The %1$s was crushed by the %2$s";
g_js_strings.battleReport.noMatch = "The %1$s was no match against the %2$s";
g_js_strings.battleReport.struggled = "The %1$s struggled against the %2$s";
g_js_strings.battleReport.valiantly = "The %1$s fought valiantly against the %2$s";
g_js_strings.battleReport.upperHand = "The %1$s gained a significant upper hand against the %2$s";
g_js_strings.battleReport.dominated = "The %1$s dominated against the %2$s";
g_js_strings.battleReport.crushed = "The %1$s crushed the %2$s";
g_js_strings.battleReport.loserNoHint = "Your forces were overwhelmed...";
g_js_strings.battleReport.winnerNoHint = "Your forces overwhelmed their foes!";
g_js_strings.crafting = {};
g_js_strings.crafting.title = "Crafting Recipes";
g_js_strings.crafting.currentLevelHint = "Craft level %1$s recipes";
g_js_strings.crafting.nextLevelHint = "Unlock level %1$s recipes";
g_js_strings.crafting.notEnoughIngredients = "You don't have all the necessary ingredients to craft this item";
g_js_strings.crafting.notEnoughSlots = "You cannot craft more items at this time.";
g_js_strings.crafting.notEnoughGems = "You don't have enough gems to purchase";
g_js_strings.crafting.craftingDisabled = "Crafting is currently disabled on this domain.  Check back later!";
g_js_strings.crafting.insuranceLabel = "Chance of Failure";
g_js_strings.crafting.insuranceHint = "Purchasing insurance will guarantee 100% success when crafting";
g_js_strings.crafting.hoverOutputMessage = "If successful, you will receive a %1$s";
g_js_strings.crafting.hoverConsolationMessage = "If failed, you will receive a %1$s";
g_js_strings.crafting.hoverConsolationMessage2 = "If failed, you will not receive anything";
g_js_strings.returned = {};
g_js_strings.returned.twisted = "The forests twisted and changed; your men have returned with new intelligence.";
g_js_strings.returned.not_engaged = "The forests twisted and changed; your forces did not engage the enemy in combat.";
g_js_strings.returned.avoided = "Your forces avoided combat.";
g_js_strings.choosegiftmodal = {};
g_js_strings.choosegiftmodal.title = "Select a FREE gift to send to your friends!";
g_js_strings.choosegiftmodal.description = "Lords and Ladies were always known to be generous and kind to their friends. Choose a gift to send to a friend. You may be greatly rewarded by Merlin.";
g_js_strings.choosegiftmodal.proceedtosend = "Proceed to Send";
g_js_strings.report_view = {};
g_js_strings.report_view.back_to_reports = "Back to Reports";
g_js_strings.report_view.knight_combat_skill = "Knight Combat Skill";
g_js_strings.report_view.knight_combat_level = "Knight Level";
g_js_strings.report_view.loot_acquired = "Loot Acquired";
g_js_strings.report_view.aetherstone = "Aether stone";
g_js_strings.report_view.throne_room = "Throne Room";
g_js_strings.report_view.inventory = "Inventory";
g_js_strings.throneRoom = {};
g_js_strings.throneRoom.simple = "Simple";
g_js_strings.throneRoom.common = "Common";
g_js_strings.throneRoom.uncommon = "Uncommon";
g_js_strings.throneRoom.rare = "Rare";
g_js_strings.throneRoom.epic = "Epic";
g_js_strings.throneRoom.wondrous = "Wondrous";
g_js_strings.throneRoom.unique = "Unique";
g_js_strings.throneRoom.locked = "Locked";
g_js_strings.throneRoom.empty = "Empty";
g_js_strings.throneRoom.title_throneRoom = "Throne Room";
g_js_strings.throneRoom.button_enhance = "Enhance";
g_js_strings.throneRoom.button_upgrade = "Upgrade";
g_js_strings.throneRoom.button_modify = "Modify";
g_js_strings.throneRoom.button_repair = "Repair";
g_js_strings.throneRoom.label_timeRemaining = "Time Remaining";
g_js_strings.throneRoom.button_instantRepair = "Instant Repair";
g_js_strings.throneRoom.button_startRepair = "Start Repair";
g_js_strings.throneRoom.button_speedUp = "Speed Up";
g_js_strings.throneRoom.description_chair = "From here the lord sits and manages his kingdom.";
g_js_strings.throneRoom.description_advisor = "The Seneschal's symbol of office; the Seneschal offers advice and carries out his liege-lord's commands.";
g_js_strings.throneRoom.description_window = "A lord must survey his kingdom; how can he understand the needs of his people if he cannont see their plight?";
g_js_strings.throneRoom.description_banner = "Tapestries chronicles great legends of the past and mighty deeds of the present.";
g_js_strings.throneRoom.description_table = "The reliquary stand is where the rarest, most powerful, and holiest artifacts and relics are put on display.";
g_js_strings.throneRoom.buff_none = "No items";
g_js_strings.throneRoom.buff_lesserProtectionRune = "Lesser Protection Stone";
g_js_strings.throneRoom.buff_protectionRune = "Protection Stone";
g_js_strings.throneRoom.buff_lesserAlchemyRune = "Lesser Mystics Orb";
g_js_strings.throneRoom.buff_alchemyRune = "Mystics Orb";
g_js_strings.throneRoom.buff_lesserLuckRune = "Lesser Luck Token";
g_js_strings.throneRoom.buff_luckRune = "Luck Token";
g_js_strings.throneRoom.req_title = "Requirements";
g_js_strings.throneRoom.risk_title = "Success Rate";
g_js_strings.throneRoom.label_low = "Low";
g_js_strings.throneRoom.label_high = "High";
g_js_strings.throneRoom.upgrade_instr1 = "Upgrading an item has a chance to increase the power of its Effects";
g_js_strings.throneRoom.upgrade_instr2 = "A successful Upgrade will increase the item's Upgrade Level by one";
g_js_strings.throneRoom.upgrade_instr3 = "An unsuccessful Upgrade will cause the item to break";
g_js_strings.throneRoom.upgrade_instr4 = "Optional items below negate unsuccessful effects and increase success rate";
g_js_strings.throneRoom.enhance_instr1 = "Enhancing an item has a chance to increase its Quality";
g_js_strings.throneRoom.enhance_instr2 = "A successful Enhance will increase the item's Quality by one";
g_js_strings.throneRoom.enhance_instr3 = "An unsuccessful Enhance breaks the item, but doesn't decrease Quality";
g_js_strings.throneRoom.enhance_instr4 = "Optional items below negate unsuccessful effects and increase success rate";
g_js_strings.report_view.tab0 = "Troops";
g_js_strings.report_view.tab1 = "Troop Stats";
g_js_strings.report_view.tab2 = "Bonuses";
g_js_strings.report_view.winner = "Winner";
g_js_strings.report_view.won = "You were Victorious!";
g_js_strings.report_view.lost = "You Lost!";
g_js_strings.report_view.troops = "Troops";
g_js_strings.report_view.fought = "Fought";
g_js_strings.report_view.survived = "Survived";
g_js_strings.report_view.throne_room = "Throne Room";
g_js_strings.report_view.knights = "Knights";
g_js_strings.report_view.research = "Research";
g_js_strings.report_view.items = "Items";
g_js_strings.report_view.guardian = "Guardian";
g_js_strings.report_view.attack = "Attack";
g_js_strings.report_view.transport_success = "Transport Successful";
g_js_strings.report_view.darkForestConflict = "The forests twisted and changed.";
g_js_strings.report_view.scout_score = "Scout Score";
g_js_strings.report_view.knight_level = "Knight Level";
g_js_strings.report_view.scout_level = "Scout Level";
g_js_strings.report_view.troop0 = "Troops";
g_js_strings.report_view.defenses = "Defenses";
g_js_strings.report_view.buildings = "Buildings";
g_js_strings.report_view.research = "Research";
g_js_strings.report_view.resources = "Resources";
g_js_strings.report_view.noTroops = "No troops defended";
g_js_strings.report_view.no_scouting_info = "None.  You may need to increase your Eagle Eyes research level to see more info.";
g_js_strings.report_view.enemies_last_login = "Enemy's last login";
g_js_strings.newGame = {};
g_js_strings.newGame.howBeKnown = "How Will You Be Known?";
g_js_strings.newGame.settingChangedAnytime = "The following setting can be changed at anytime in the game.";
g_js_strings.newGame.chooseNameStature = "Choose a name that befits your great stature";
g_js_strings.newGame.nameValidationMsg = "3-15 letters or numbers with no spaces";
g_js_strings.newGame.yourCityLocated = "Your city will be located in the";
g_js_strings.newGame.notChosen = "Not Chosen";
g_js_strings.newGame.welcome = "Welcome!";
g_js_strings.newGame.placedUnderProtection = "You have been placed under protection for a short time.";
g_js_strings.newGame.lastStepBullet1 = "Construct buildings to unlock new features";
g_js_strings.newGame.lastStepBullet2 = "Train troops in the Barracks to grow your Might";
g_js_strings.newGame.lastStepBullet3 = "Join an Alliance for protection";
g_js_strings.newGame.foundedKingdom = "has founded a kingdom!";
g_js_strings.changeDomain = {};
g_js_strings.changeDomain.enterYourDomain = "Enter Your Domain";
g_js_strings.changeDomain.filterBy = "Filter by";
g_js_strings.changeDomain.serverType = "Server Type";
g_js_strings.changeDomain.tournamentOfGlory = "Tournament of Glory";
g_js_strings.changeDomain.tournamentOfmight = "Tournament of Might";
g_js_strings.changeDomain.createNewCity = "Create new City";
g_js_strings.changeDomain.newDescription = "This is a new domain that has recently opened.";
g_js_strings.changeDomain.enhancedDescription = "This is an Enhanced domain with altered game rules.";
g_js_strings.changeDomain.tournamentDescription = "A Tournament is running on this domain.";
g_js_strings.serverUpgraded = {};
g_js_strings.serverUpgraded.youreSelectedEnchanced = "Your domain has been selected to participate in a new Enhanced Domain Beta program.";
g_js_strings.serverUpgraded.newEnhancedFeaturesAre = "The new features included in the Enahnced domain are:";
g_js_strings.serverUpgraded.enhancedBullet1 = "Build Time and Training Times reduced by 25%";
g_js_strings.serverUpgraded.enhancedBullet2 = "Upkeep has been reduced on all troop units";
g_js_strings.serverUpgraded.enhancedBullet3 = "Improved Server Performance";
g_js_strings.serverUpgraded.enhancedBullet4 = "A Gift Package with additional items";
g_js_strings.serverUpgraded.goContinueToKabam = "Go continue to build your kingdom now on Kabam.com!";
var buildingcost = {
    bdg0: ["Castle", 0, 0, 0, 0, 0, 0, 0,
    {
        b19: [0, -2]
    }, [], "The Castle is the center of your City! You can view and modify your Production Rates and Tax Rates, and Comfort or Levy your subjects. Each upgrade of the Castle allows you to conquer one more Wilderness and use three new Resource fields."],
    bdg1: ["Farm", 0, 0, 0, 0, 0, 0, 0, [],
        [], "Farms produce Food, important for buildings and for feeding your troops. Higher levels produce more Food."],
    bdg2: ["Sawmill", 0, 0, 0, 0, 0, 0, 0, [],
        [], "Sawmills produce Wood, necessary for buildings and for training troops."],
    bdg3: ["Quarry", 0, 0, 0, 0, 0, 0, 0, [],
        [], "Quarries produce Stone. Stone is the foundation of your buildings, allowing them to withstand attacks and time"],
    bdg4: ["Mine", 0, 0, 0, 0, 0, 0, 0, [],
        [], "Mines produce Ore, which is necessary to create any metal your city needs, from weapons to nails."],
    bdg5: ["Cottage", 0, 0, 0, 0, 0, 0, 0,
    {
        b0: [0, -1]
    }, [], "Cottages provide a place for your subjects to live. Upgrade to provide better cottages, and raise your Population."],
    bdg6: ["Tavern", 0, 0, 0, 0, 0, 0, 0,
    {
        b5: [1, 2]
    }, [], "The Tavern provides your subjects with a place to relax, and raises your city&#39;s Happiness, though never above 100%. Higher levels of Tavern provide greater benefits."],
    bdg7: ["Knights&#39; Hall", 0, 0, 0, 0, 0, 0, 0, [],
        [], "The Knights&#39; Hall is where you hire new Knights, appoint Knights to roles, and raise your Knights&#39; skills. Upgrade to increase the experience gained by your Knights each hour."],
    bdg8: ["Embassy", 0, 0, 0, 0, 0, 0, 0, [],
        [], "The Embassy allows you to join and create Alliances, and to house allied troops sent to help you. Your Embassy must be level 2 to create an Alliance. A higher level Embassy will allow more troops to be garrisoned."],
    bdg9: ["Storehouse", 0, 0, 0, 0, 0, 0, 0, [],
        [], "The Storehouse protects your Food, Wood, Stone, and Ore from being Plundered by your enemies. Upgrade your Storehouse to protect more Resources."],
    bdg10: ["Market", 0, 0, 0, 0, 0, 0, 0, [],
        [], "The Market is a gathering spot for buying and selling Resources between players. Upgrade your Market to enact multiple transactions at the same time."],
    bdg11: ["Alchemy Lab", 0, 0, 0, 0, 0, 0, 0, [],
        [], "The Alchemy Lab is where to research new and better Technologies. Upgrading the Alchemy Lab allows your alchemists to engage in more complicated research."],
    bdg12: ["Rally Point", 0, 0, 0, 0, 0, 0, 0, [],
        [], "Assemble your troops at the Rally Point to send out an Attack, Reinforce another city, or Scout and enemy location. Upgrade to send more troops."],
    bdg13: ["Barracks", 0, 0, 0, 0, 0, 0, 0, [],
        [], "Train your troops in the Barracks. Stronger troops require a higher level of Barracks. Building more Barracks will speed up Training."],
    bdg14: ["Watch Tower", 0, 0, 0, 0, 0, 0, 0,
    {
        b13: [1, 2]
    }, [], "The Watch Tower is used to send early warnings of invasions. The higher its level, the more detailed information you gain."],
    bdg15: ["Blacksmith", 0, 0, 0, 0, 0, 0, 0,
    {
        b4: [1, 3]
    }, [], "The Blacksmith creates all the metal weapons and armor for your troops. A higher level Blacksmith is needed for more advanced weaponry and armor."],
    bdg16: ["Workshop", 0, 0, 0, 0, 0, 0, 0, [],
        [], "The Workshop is necessary to build siege weapons, such as Ballistae, Trebuchets, and Catapults."],
    bdg17: ["Stable", 0, 0, 0, 0, 0, 0, 0,
    {
        b1: [1, 5]
    }, [], "Stables are necessary to house the horses used by Cavalry and Heavy Cavalry. Upgrade your Stables to research higher levels of Alloy Horseshoes."],
    bdg18: ["Relief Station", 0, 0, 0, 0, 0, 0, 0,
    {
        b17: [1, 1]
    }, {
        t12: [0, 0]
    }, "The Relief Station helps your troops&#39; Speed when you&#39;re moving between your own and allies&#39; cities. Upgrade for better speed improvements."],
    bdg19: ["Wall", 0, 0, 0, 0, 0, 0, 0,
    {
        b16: [0, -1]
    }, [], "Walls provide your city with protection. Your Defensive units are built on your Wall. Higher levels allow you to build better Defensive units and increase your city&#39;s protection."],
    bdg50: ["Wood Guardian", 0, 0, 0, 0, 0, 0, 0, [],
        [], ""],
    bdg51: ["Ore Guardian", 0, 0, 0, 0, 0, 0, 0, [],
        [], ""],
    bdg52: ["Food Guardian", 0, 0, 0, 0, 0, 0, 0, [],
        [], ""],
    bdg53: ["Stone Guardian", 0, 0, 0, 0, 0, 0, 0, [],
        [], ""],
    bdg20: ["Fey Spire", 0, 0, 0, 0, 0, 0, 0,
    {
        b0: [1, 5]
    }, [], "The warlocks of the Fey Spire can combine your treasures to make new items."]
};
var techcost = {
    tch1: ["Fertilizer", 500, 0, 0, 100, 1000, 0, 400,
    {
        b11: [1, 1],
        b1: [0, 0]
    }, [], "Each upgrade increases your Food production by 10%\r\n"],
    tch2: ["Logging", 0, 500, 0, 100, 1200, 0, 500,
    {
        b11: [1, 1],
        b2: [0, 0]
    }, [], "Each upgrade increases your Wood production by 10%\r\n"],
    tch3: ["Stoneworking", 0, 0, 500, 200, 1500, 0, 600,
    {
        b11: [1, 1],
        b3: [0, 0]
    }, [], "Each upgrade increases your Stone production by 10%\r\n"],
    tch4: ["Mining", 0, 0, 0, 800, 2000, 0, 700,
    {
        b11: [1, 1],
        b4: [0, 0]
    }, [], "Each upgrade increases your Ore production by 10%\r\n"],
    tch5: ["Geometry", 0, 500, 0, 500, 5000, 0, 900,
    {
        b11: [1, 3],
        b16: [0, 0]
    }, {
        t3: [1, 2]
    }, "Each upgrade increases the speed of construction on Siege Weapons by 10%\r\n"],
    tch6: ["Eagle Eyes", 300, 0, 0, 0, 2000, 0, 300,
    {
        b11: [1, 3]
    }, [], "Higher levels give you more detailed information when scouting\r\n"],
    tch8: ["Poisoned Edge", 800, 120, 200, 3000, 3000, 0, 1200,
    {
        b11: [1, 2],
        b13: [1, 2]
    }, [], "Each upgrade increases your troops&#39; attack by 5%\r\n"],
    tch9: ["Metal Alloys", 700, 150, 0, 300, 3500, 0, 1500,
    {
        b11: [1, 3],
        b15: [0, 0]
    }, {
        t4: [0, 0]
    }, "Each upgrade increases your troops&#39; defense by 5%\r\n"],
    tch10: ["Featherweight Powder", 500, 0, 200, 0, 3000, 0, 1600,
    {
        b11: [1, 4]
    }, [], "Each upgrade increases your troops&#39; load by 10%\r\n"],
    tch11: ["Magical Mapping", 600, 0, 0, 0, 3000, 0, 1800,
    {
        b11: [1, 4]
    }, [], "Each upgrade increases your infantry troops&#39; marching speed by 10%\r\n"],
    tch12: ["Alloy Horseshoes", 1000, 0, 0, 1000, 6000, 0, 2000,
    {
        b11: [1, 5],
        b17: [0, 0]
    }, {
        t9: [0, 0]
    }, "Each upgrade increases your horseback and siege weapon troops marching speed by 5%\r\n"],
    tch13: ["Fletching", 0, 800, 500, 600, 5000, 0, 2400,
    {
        b11: [1, 4]
    }, {
        t2: [1, 4]
    }, "Each upgrade increases your projectiles&#39; range by 5%\r\n"],
    tch14: ["Shrinking Powder", 0, 1200, 1000, 800, 2000, 0, 900,
    {
        b11: [1, 6],
        b9: [0, 0]
    }, {
        t2: [1, 3]
    }, "Each upgrade increases your Storehouse capacity by 10%\r\n"],
    tch15: ["Healing Potions", 1500, 0, 0, 0, 3600, 0, 1800,
    {
        b11: [1, 6]
    }, {
        t10: [1, 3]
    }, "Each upgrade increases your troops&#39; health by 5%\r\n"],
    tch16: ["Giant&#39;s Strength", 0, 2000, 2000, 2000, 5000, 0, 1800,
    {
        b11: [1, 5]
    }, {
        t2: [1, 5],
        t5: [1, 2]
    }, "Each upgrade increases your construction speed by 10%\r\n"]
};
var unitnamedesctranslated = {
    unt1: ["Supply Troop", "Supply Troops are not very good at fighting, but can carry resources to your other cities or friends, or carry loot back when you plunder enemy cities."],
    unt2: ["Militiaman", "Militiamen are citizens of your city who have some military training. They are a good beginning for your army, but no match for troops with true training."],
    unt3: ["Scout", "Scouts move quickly, and bring back information about enemy positions and numbers, but are not strong fighters"],
    unt4: ["Pikeman", "Pikemen are the most basic heavily trained troops. Their long pikes are very effective against horses."],
    unt5: ["Swordsman", "Swordsmen are well armored, and are the strongest melee troops. Their shields make them effective against Archers."],
    unt6: ["Archer", "Archers can destroy the enemy&#39;s troops from a distance, but are vulnerable up close."],
    unt7: ["Cavalry", "Cavalry troops move very quickly on horseback, and have devastating attacks."],
    unt8: ["Heavy Cavalry", "Heavy Cavalry are far more armored than regular Cavalry. This armor provides them defense and more power to their attacks, but costs them some speed."],
    unt9: ["Supply Wagon", "Supply Wagons are heavily fortified to carry anything you need through a raging battle, and not lose the cargo."],
    unt10: ["Ballista", "Ballistae fire huge arrow-like bolts at long ranges. They are effective against other siege weapons."],
    unt11: ["Battering Ram", "A Battering Ram is a large log-like object, used for knocking down the enemy&#39;s defenses."],
    unt12: ["Catapult", "Catapults throw large rocks from a huge distance. They are most effective against the enemy&#39;s defenses."]
};
var fortcost = {
    frt53: ["Wall-Mounted Crossbows", 250, 2000, 750, 500, 0, 0, 180,
    {
        b19: [1, 6],
        b15: [1, 6]
    }, {
        t13: [1, 5]
    }, "High powered crossbows mounted at the best vantage point for shooting enemies"],
    frt55: ["Defensive Trebuchet", 500, 3500, 1800, 1200, 0, 0, 135,
    {
        b19: [1, 8],
        b15: [1, 8]
    }, {
        t13: [1, 7],
        t5: [1, 7]
    }, "Excellent at destroying enemy siege weapons, a trebuchet will only get one shot per battle and must then be rebuilt and reloaded"],
    frt60: ["Trap", 400, 800, 200, 400, 0, 0, 90,
    {
        b19: [1, 4],
        b15: [1, 4]
    }, {
        t8: [1, 2]
    }, "Much like the modern land mine, these traps are buried around the castle, and deal damage to unsuspecting enemy attackers"],
    frt61: ["Caltrops", 100, 0, 0, 400, 0, 0, 30,
    {
        b19: [1, 1]
    }, {
        t9: [1, 1]
    }, "Stops infantry troops from advancing until they are cleared.  Positioned at the maximum attack range of the defenders."],
    frt62: ["Spiked Barrier", 150, 750, 50, 0, 0, 0, 60,
    {
        b19: [1, 2],
        b15: [1, 2]
    }, {
        t2: [1, 2]
    }, "Stops horse units (including siege weapons) from advancing until they are cleared. Positioned at the maximum attack range of the defenders."]
};
var fortstats = {
    unt53: [2000, 600, 80, 0, 1300, 2],
    unt55: [0, 2550, 0, 0, 5000, 4],
    unt60: [0, 5000, 0, 0, 0, 4],
    unt61: [150, 650, 0, 0, 0, 1],
    unt62: [100, 1000, 50, 0, 0, 3]
};
var buildingmulti = {
    b1: 1,
    b2: 1,
    b3: 1,
    b4: 1,
    b5: 1,
    b13: 1
};
var resourceinfo = {
    "0": "Gold",
    "1": "Food",
    "2": "Wood",
    "3": "Stone",
    "4": "Ore",
    "5": "Population",
    "6": "Time",
    "7": "Aetherstone",
    rec0: "Gold",
    rec1: "Food",
    rec2: "Wood",
    rec3: "Stone",
    rec4: "Ore",
    rec5: "Population",
    rec6: "Time"
};
var itemlist = {
    i1: {
        name: "Squire's Hourglass",
        description: "Shorten time by 1 minute.",
        price: 1,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i2: {
        name: "Knight's Hourglass",
        description: "Shorten time by 15 minute.",
        price: 5,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i3: {
        name: "Guinevere's Hourglass",
        description: "Shorten time by 1 hour.",
        price: 10,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i4: {
        name: "Morgana's Hourglass",
        description: "Shorten time by 2.5 hours.",
        price: 20,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i5: {
        name: "Arthur's Hourglass",
        description: "Shorten time by 8 hours.",
        price: 50,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i6: {
        name: "Merlin's Hourglass",
        description: "Shorten time by 15 hours.",
        price: 80,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i7: {
        name: "Divine Hourglass",
        description: "Shorten time by 24 hours.",
        price: 120,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i8: {
        name: "Epic Hourglass",
        description: "Shorten time by 2.5 days.",
        price: 275,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i9: {
        name: "Dragon's Stomp",
        description: "Demolish one of your buildings immediately.",
        price: 12,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i10: {
        name: "Legendary Hourglass",
        description: "Shorten time by 4 days.",
        price: 430,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i26: {
        name: "Siege Master's Tools",
        description: "Shorten the remaining time of construction of Defensive units by 30%.",
        price: 35,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i36: {
        name: "Lancelot's Tutelage",
        description: "Shorten the remaining time of troop training by 30%.",
        price: 30,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i37: {
        name: "Arthur's Tutelage",
        description: "Shorten the remaining time of troop training by 50%.",
        price: 100,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i38: {
        name: "Merlin's Tutelage",
        description: "Shorten the remaining time of troop training by 70%.",
        price: 150,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i49: {
        name: "Caravan Portal",
        description: "Completes one Market transportation.",
        price: 8,
        tradable: null,
        category: 2,
        subCategory: 0
    },
    i55: {
        name: "Green Griffin Wings",
        description: "Decreases the time of one March by 25%.",
        price: 8,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i57: {
        name: "Red Dragon Wings",
        description: "Decreases the time of one March by 50%.",
        price: 20,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i69: {
        name: "instant scout",
        description: "reserved by Rome",
        price: null,
        tradable: null,
        category: 0,
        subCategory: 0
    },
    i101: {
        name: "Day of Prosperity",
        description: "Increases gold from taxes by 100% for 24 hours.",
        price: 45,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i102: {
        name: "Week of Prosperity",
        description: "Increases gold from taxes by 100% for 7 days.",
        price: 280,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i111: {
        name: "Harvest Prayer",
        description: "Increases Food production by 25% for 24 hours.",
        price: 9,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i112: {
        name: "Harvest Sacrifice",
        description: "Increases Food production by 25% for 7 days.",
        price: 50,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i121: {
        name: "Druidic Blessing",
        description: "Increases Wood production by 25% for 24 hours.",
        price: 9,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i122: {
        name: "Druidic Ceremony",
        description: "Increases Wood production by 25% for 7 days.",
        price: 50,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i131: {
        name: "Gnomish Stone Cutter",
        description: "Increases Stone production by 25% for 24 hours.",
        price: 9,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i132: {
        name: "Gnomish Quarrying Team",
        description: "Increases Stone production by 25% for 7 days.",
        price: 50,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i141: {
        name: "Dwarven Mining Tools",
        description: "Increases Ore production by 25% for 24 hours.",
        price: 9,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i142: {
        name: "Dwarven Assistance",
        description: "Increases Ore production by 25% for 7 days.",
        price: 50,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i211: {
        name: "Rose of Charisma",
        description: "Increases a Knight's Politics by 25% when rewarded. Lasts for 7 days.",
        price: 40,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i221: {
        name: "Gauntlet of Courage",
        description: "Increases a Knight's Combat by 25% when rewarded. Lasts for 7 days.",
        price: 40,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i231: {
        name: "Mirror of Knowledge",
        description: "Increases a Knight's Intelligence by 25% when rewarded. Lasts for 7 days.",
        price: 40,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i241: {
        name: "Gloves of Gathering",
        description: "Increases a Knight's Resourcefulness by 25% when rewarded. Lasts for 7 days.",
        price: 40,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i261: {
        name: "Blood Lust",
        description: "Increases Attack of troops by 20% for 24 hours.",
        price: 10,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i262: {
        name: "Blood Frenzy",
        description: "Increases Attack of troops by 20% for 7 days.",
        price: 60,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i271: {
        name: "Barkskin",
        description: "Increases Defense of troops by 20% for 24 hours.",
        price: 10,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i272: {
        name: "Stoneskin",
        description: "Increases Defense of troops by 20% for 7 days.",
        price: 60,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i273: {
        name: "Horn of Plenty",
        description: "Reduce the Food Upkeep from Troops by 50% for 8 hours.",
        price: 40,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i274: {
        name: "Horn of Bounty",
        description: "Reduces the Food upkeep from Troops by 50% for 24 hours.",
        price: 110,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i275: {
        name: "Horn of Majesty",
        description: "Reduces the Food upkeep from Troops by 50% for 3 days.",
        price: 320,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i276: {
        name: "Reinforced Bags",
        description: "Increases troop carrying capacity by 25% for all marches that complete in the next hour.",
        price: 15,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i277: {
        name: "Sturdy Reinforced Bags",
        description: "Increases troop carrying capacity by 25% for all marches that complete in the next 2 hours.",
        price: 22,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i278: {
        name: "Heavily Reinforced Bags",
        description: "Increases troop carrying capacity by 25% for all marches that complete in the next 4 hours.",
        price: 40,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i279: {
        name: "Blue Eagle Wings",
        description: "Decreases the return time of troop marches by 50% for 1 hour. Only applies to return marches started during the 1 hour window.",
        price: 15,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i280: {
        name: "Blood Fury",
        description: "Increase Attack of troops by 50% for 4 hours.",
        price: 90,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i281: {
        name: "Iron Skin",
        description: "Increase Defense of troops by 50% for 4 hours.",
        price: 90,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i282: {
        name: "Staunch Banner",
        description: "Increase Health of troops by 10% for 24 hours",
        price: 12,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i283: {
        name: "Banner of Vigor",
        description: "Increase Health of troops by 10% for 7 days",
        price: 70,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i284: {
        name: "Horn of Samhain",
        description: "Reduce the Food Upkeep from Troops by 50% for 7 days",
        price: 735,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i285: {
        name: "Auras of Authority",
        description: "Increases the maximum number of troops per march by 15% for 1 hour.",
        price: 80,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i286: {
        name: "Auras of Dominion",
        description: "Increases the maximum number of troops per march by 30% for 1 hour.",
        price: 160,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i351: {
        name: "Fertile Winds",
        description: "Adds 20% of your Population Limit or 100 Population, whichever is higher. Does not work if the current Population reaches the Population Limit.",
        price: 40,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i355: {
        name: "Mass Hypnosis",
        description: "Increases Happiness to 100.",
        price: 100,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i361: {
        name: "Train with Kay",
        description: "Increase Knight's experience by 1,000 or 8% of current level cap, whichever is greater.",
        price: 8,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i362: {
        name: "Train with Galahad",
        description: "Increase Knight's experience by 10,000 or 30% of current level cap, whichever is greater.",
        price: 30,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i363: {
        name: "Train with Arthur",
        description: "Increase Knight's experience by 100,000 or 100% of current level cap, whichever is greater",
        price: 100,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i401: {
        name: "Divine Inspiration",
        description: "Allows you to upgrade a building from lvl. 9 to lvl. 10, and some buildings to lvl. 11",
        price: 45,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i402: {
        name: "Divine Providence",
        description: "Allows you to upgrade your Castle from level 10 to 11",
        price: 200,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i403: {
        name: "Sacred Inspiration",
        description: "Allows you to upgrade your buildings from level 11 to 12",
        price: 55,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i404: {
        name: "Sacred Providence",
        description: "Allows you to upgrade your Castle from level 11 to 12",
        price: 220,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i501: {
        name: "Squire's Chest",
        description: "Contains between 1 and 3 Sir Bor's Crests, 1 and 3 Sir Ector's Crests, and 1 and 3 Sir Kay's Crests.",
        price: 90,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i502: {
        name: "Knight's Chest",
        description: "Contains between 1 and 3 Sir Bedivere's Crests, 1 and 3 Sir Gawain's Crests, and 1 and 3 Sir Percival's Crests.",
        price: 150,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i503: {
        name: "Lord's Chest",
        description: "Contains between 1 and 3 Sir Galahad's Crests, 1 and 3 Sir Lancelot's Crests, and 1 and 3 King Arthur's Crests.",
        price: 250,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i504: {
        name: "Fey's Chest",
        description: "Contains between 1 and 3 Morgana's Seals, 1 and 3 Mordred's Seals, and 1 and 3 Stag King's Seals.",
        price: 350,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i505: {
        name: "Avalon's Chest",
        description: "Contains between 1 and 3 Pendragon Seals, 1 and 3 Lady of the Lake's Seals, and 1 and 3 Merlin's Seals.",
        price: 400,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i511: {
        name: "Red Knight",
        description: "Grants you a Knight automatically raised to level 10-15 with skills randomly assigned.",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i512: {
        name: "Blue Knight",
        description: "Grants you a Knight automatically raised to level 16-25 with skills randomly assigned.",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i513: {
        name: "Black Knight",
        description: "Grants you a Knight automatically raised to level 26-35 with skills randomly assigned.",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i514: {
        name: "Green Knight",
        description: "Grants you a Knight automatically raised to level 36-50 with skills randomly assigned.",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i521: {
        name: "Young Volunteers",
        description: "Summons 100-250 Supply Troopers and 100-250 Militiamen.",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i522: {
        name: "Experienced Volunteers",
        description: "Summons 200-250 Scouts, 200-300 Pikemen, 150-250 Swordsmen, and 100-200 Archers.",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i523: {
        name: "Veteran Volunteers",
        description: "Summons 100-300 Cavalry, 100-200 Heavy Cavalry, and 200-450 Supply Wagons.",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i524: {
        name: "Siege Volunteers",
        description: "Summons 100-200 Ballistae, 100-200 Battering Rams, and 150-350 Catapults.",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i531: {
        name: "Mysterious Bounty",
        description: "Summons 2 bundles of 10,000 Gold, Food, Wood, Stone or Ore for your Kingdom.",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i598: {
        name: "Wheel Game Direct Play",
        description: "Used to track direct play for the wheel game in KoC, don't display on the frontend",
        price: 25,
        tradable: null,
        category: 0,
        subCategory: 0
    },
    i599: {
        name: "Merlin's Magical Tokens",
        description: "Gives you one chance to randomly win a rare item in Merlin's Magical Boxes.",
        price: 5,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i601: {
        name: "Sealed Orders",
        description: "Allows you to designate a building to be build or upgraded after your current construction completes.",
        price: null,
        tradable: null,
        category: 7,
        subCategory: 0
    },
    i610: {
        name: "Shifting Stones",
        description: "Rearrange the location of your buildings",
        price: null,
        tradable: null,
        category: 7,
        subCategory: 0
    },
    i711: {
        name: "Court Jester",
        description: "Improves the Food you get when players visit your Court",
        price: 100,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i721: {
        name: "Hunting Dogs",
        description: "Improves the Wood you get when players visit your Court",
        price: 100,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i731: {
        name: "Professional Sculptor",
        description: "Improves the Stone you get when players visit your Court",
        price: 100,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i741: {
        name: "Metallurgist",
        description: "Improves the Ore you get when players visit your Court",
        price: 100,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i801: {
        name: "Stained Glass Window 1",
        description: "A blue and red heart",
        price: 60,
        tradable: null,
        category: 6,
        subCategory: 800
    },
    i802: {
        name: "Stained Glass Window 2",
        description: "A gold cross",
        price: 60,
        tradable: null,
        category: 6,
        subCategory: 800
    },
    i803: {
        name: "Stained Glass Window 3",
        description: "A green griffon",
        price: 60,
        tradable: null,
        category: 6,
        subCategory: 800
    },
    i804: {
        name: "Stained Glass Window 4",
        description: "An apple tree",
        price: 60,
        tradable: null,
        category: 6,
        subCategory: 800
    },
    i805: {
        name: "Stained Glass Window 5",
        description: "A fire breathing dragon",
        price: 60,
        tradable: null,
        category: 6,
        subCategory: 800
    },
    i811: {
        name: "War Banner 1",
        description: "A coat of arms with crossed weapons",
        price: 50,
        tradable: null,
        category: 6,
        subCategory: 810
    },
    i812: {
        name: "War Banner 2",
        description: "A rearing lion",
        price: 50,
        tradable: null,
        category: 6,
        subCategory: 810
    },
    i813: {
        name: "War Banner 3",
        description: "A fleur-de-lis",
        price: 50,
        tradable: null,
        category: 6,
        subCategory: 810
    },
    i814: {
        name: "War Banner 4",
        description: "A double-headed eagle with laurels",
        price: 50,
        tradable: null,
        category: 6,
        subCategory: 810
    },
    i815: {
        name: "War Banner 5",
        description: "ITEM_TYPE_COURT_DECOR_BANNER5",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i821: {
        name: "Painting 1",
        description: "A queen in her royal robes",
        price: 50,
        tradable: null,
        category: 6,
        subCategory: 820
    },
    i822: {
        name: "Painting 2",
        description: "A boat on the ocean",
        price: 50,
        tradable: null,
        category: 6,
        subCategory: 820
    },
    i823: {
        name: "Painting 3",
        description: "A roaring dragon",
        price: 50,
        tradable: null,
        category: 6,
        subCategory: 820
    },
    i824: {
        name: "Painting 4",
        description: "A monk and nobleman walking",
        price: 50,
        tradable: null,
        category: 6,
        subCategory: 820
    },
    i825: {
        name: "Painting 5",
        description: "A knight on his steed",
        price: 50,
        tradable: null,
        category: 6,
        subCategory: 820
    },
    i831: {
        name: "Red Curtains",
        description: "Red Curtains to decorate your Court. Will change the banners on some of your City buildings",
        price: 25,
        tradable: null,
        category: 6,
        subCategory: 830
    },
    i832: {
        name: "Blue Curtains",
        description: "Blue Curtains to decorate your Court. Will change the banners on some of your City buildings",
        price: 25,
        tradable: null,
        category: 6,
        subCategory: 830
    },
    i833: {
        name: "Purple Curtains",
        description: "Purple Curtains to decorate your Court. Will change the banners on some of your City buildings",
        price: 25,
        tradable: null,
        category: 6,
        subCategory: 830
    },
    i834: {
        name: "Green Curtains",
        description: "Green Curtains to decorate your Court. Will change the banners on some of your City buildings",
        price: 25,
        tradable: null,
        category: 6,
        subCategory: 830
    },
    i835: {
        name: "Yellow Curtains",
        description: "Yellow Curtains to decorate your Court. Will change the banners on some of your City buildings",
        price: 25,
        tradable: null,
        category: 6,
        subCategory: 830
    },
    i841: {
        name: "Throne 1",
        description: "Small wooden throne",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 840
    },
    i842: {
        name: "Throne 2",
        description: "Medium wooden throne",
        price: 40,
        tradable: null,
        category: 6,
        subCategory: 840
    },
    i843: {
        name: "Throne 3",
        description: "Large wooden throne",
        price: 60,
        tradable: null,
        category: 6,
        subCategory: 840
    },
    i844: {
        name: "Throne 4",
        description: "Silver throne",
        price: 80,
        tradable: null,
        category: 6,
        subCategory: 840
    },
    i845: {
        name: "Throne 5",
        description: "Gold throne",
        price: 100,
        tradable: null,
        category: 6,
        subCategory: 840
    },
    i851: {
        name: "Weapons Rack 1",
        description: "A small amount of weapons",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 850
    },
    i852: {
        name: "Weapons Rack 2",
        description: "A small amount of weapons, including swords",
        price: 40,
        tradable: null,
        category: 6,
        subCategory: 850
    },
    i853: {
        name: "Weapons Rack 3",
        description: "A few  weapons",
        price: 60,
        tradable: null,
        category: 6,
        subCategory: 850
    },
    i854: {
        name: "Weapons Rack 4",
        description: "A large cache of weapons",
        price: 80,
        tradable: null,
        category: 6,
        subCategory: 850
    },
    i855: {
        name: "Weapons Rack 5",
        description: "Overflowing weapons racks",
        price: 100,
        tradable: null,
        category: 6,
        subCategory: 850
    },
    i860: {
        name: "USA Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i861: {
        name: "United Kingdom Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i862: {
        name: "Canada Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i863: {
        name: "Australia Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i864: {
        name: "Sweden Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i865: {
        name: "Denmark Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i866: {
        name: "Norway Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i867: {
        name: "Italy Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i868: {
        name: "Germany Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i869: {
        name: "France Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i870: {
        name: "Austria Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i871: {
        name: "Greece Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i872: {
        name: "Ireland Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i873: {
        name: "Brazil Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i874: {
        name: "Switzerland Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i875: {
        name: "Finland Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i876: {
        name: "Netherlands Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i877: {
        name: "China Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i878: {
        name: "Russia Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i879: {
        name: "South Korea Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i880: {
        name: "Pirate Flag",
        description: "Yarrr! This flag will appear in your Court and in Chat to show your Pirate pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i881: {
        name: "Taiwan (R.O.C.) Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i882: {
        name: "Japan Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i883: {
        name: "Spain Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i884: {
        name: "Turkey Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i885: {
        name: "England Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i886: {
        name: "Scotland Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i887: {
        name: "Wales Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i888: {
        name: "Philippines Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i889: {
        name: "Mexico Flag",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i890: {
        name: "Banner of Darkness",
        description: "This flag will appear in your Court and in Chat to show your pride!",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i891: {
        name: "Hallowed Curtains",
        description: "Hallowed Curtains to decorate your Court. Will change the banners on your castle.",
        price: 25,
        tradable: null,
        category: 6,
        subCategory: 830
    },
    i892: {
        name: "Flag of Giving",
        description: "This flag will appear in your Couty and in Chat to show your pride",
        price: null,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i893: {
        name: "Fey Flag",
        description: "The Fey are coming to Camelot.  Are they Friend or Foe?",
        price: 20,
        tradable: null,
        category: 6,
        subCategory: 860
    },
    i901: {
        name: "Dove of Peace",
        description: "Grants your city 12 hours of peacetime. While at peace, you cannot attack or be attacked. You cannot use this item if you are currently being attacked or your troops are currently marching.",
        price: 30,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i902: {
        name: "Vacation Mode 3 days",
        description: "For a limited time only! Need to take a break? Deploy 3 days of vacation mode. Grants all your cities 3 days of peacetime, 50% reduction of troop upkeep, and deploys the Mists of Avalon.  Vacation Mode will end if you send out any type of march.",
        price: 445,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i903: {
        name: "Vacation Mode 7 days",
        description: "For a limited time only! Deploy 7 days of vacation mode. Grants all your cities 7 days of peacetime, 50% reduction of troop upkeep, and deploys the Mists of Avalon. Vacation Mode will end if you send out any type of march.",
        price: 970,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i911: {
        name: "Portal of Refuge",
        description: "Teleport your city to another location on the Map at random and places your Cities under Mists of Avalon for 7 days.",
        price: 30,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i912: {
        name: "Portal of Order",
        description: "Teleport your city to a specific location on the Map and places your Cities under Mists of Avalon for 7 days",
        price: 90,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i913: {
        name: "reserve for rome",
        description: "reserv for rome",
        price: null,
        tradable: null,
        category: 0,
        subCategory: 0
    },
    i914: {
        name: "no scout",
        description: "reserved by Rome",
        price: null,
        tradable: null,
        category: 0,
        subCategory: 0
    },
    i922: {
        name: "Merlin's Cloak",
        description: "Change your Lord or Lady name.",
        price: 90,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i923: {
        name: "Renaming Celebration",
        description: "Change the name of one of your Cities",
        price: 10,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i924: {
        name: "Merlin's Escape",
        description: "Teleport your city to a specific location and change your Lord or Lady name.",
        price: 150,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i925: {
        name: "diety changer",
        description: "RESERVED BY GOR",
        price: null,
        tradable: null,
        category: 0,
        subCategory: 0
    },
    i926: {
        name: "diety changer 2",
        description: "RESERVED BY GOR",
        price: null,
        tradable: null,
        category: 0,
        subCategory: 0
    },
    i931: {
        name: "Aura of Command",
        description: "Increases the maximum number of troops by 25% for one March.",
        price: 20,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i932: {
        name: "Aura Of Conquest",
        description: "Increases the maximum number of troops by 50% for one March.",
        price: 40,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i941: {
        name: "Fountain of Youth",
        description: "Allows you to re-allocate all of a single Knight's skill points gained since level 1. One Fountain of Youth is needed for every 10 levels.",
        price: 20,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i942: {
        name: "Fountain of Youth x5",
        description: "Allows you to re-allocate all of a single Knight's skill points gained since level 1. One Fountain of Youth is needed for every 10 levels.",
        price: 90,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i943: {
        name: "energy recharger",
        description: "RESERVED BY GOR",
        price: null,
        tradable: null,
        category: 0,
        subCategory: 0
    },
    i1001: {
        name: "1,000 Gold",
        description: "Deposits1,000 Gold into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1002: {
        name: "5,000 Gold",
        description: "Deposits 5,000 Gold into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1003: {
        name: "10,000 Gold",
        description: "Deposits 10,000 Gold into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1004: {
        name: "20,000 Gold",
        description: "Deposits 20,000 Gold into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1005: {
        name: "40,000 Gold",
        description: "Deposits 40,000 Gold into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1006: {
        name: "60,000 Gold",
        description: "Deposits 60,000 Gold into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1007: {
        name: "80,000 Gold",
        description: "Deposits 80,000 Gold into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1008: {
        name: "100,000 Gold",
        description: "Deposits 100,000 Gold into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1011: {
        name: "1,000 Food",
        description: "Deposits 1,000 Food into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1012: {
        name: "5,000 Food",
        description: "Deposits 5,000 Food into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1013: {
        name: "10,000 Food",
        description: "Deposits 10,000 Food into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1014: {
        name: "20,000 Food",
        description: "Deposits 20,000 Food into your city.",
        price: 6,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1015: {
        name: "40,000 Food",
        description: "Deposits 40,000 Food into your city.",
        price: 10,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1016: {
        name: "60,000 Food",
        description: "Deposits 60,000 Food into your city.",
        price: 14,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1017: {
        name: "80,000 Food",
        description: "Deposits 80,000 Food into your city.",
        price: 18,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1018: {
        name: "100,000 Food",
        description: "Deposits 100,000 Food into your city.",
        price: 20,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1021: {
        name: "1,000 Wood",
        description: "Deposits 1,000 Wood into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1022: {
        name: "5,000 Wood",
        description: "Deposits 5,000 Wood into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1023: {
        name: "10,000 Wood",
        description: "Deposits 10,000 Wood into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1024: {
        name: "20,000 Wood",
        description: "Deposits 20,000 Wood into your city.",
        price: 6,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1025: {
        name: "40,000 Wood",
        description: "Deposits 40,000 Wood into your city.",
        price: 10,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1026: {
        name: "60,000 Wood",
        description: "Deposits 60,000 Wood into your city.",
        price: 14,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1027: {
        name: "80,000 Wood",
        description: "Deposits 80,000 Wood into your city.",
        price: 18,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1028: {
        name: "100,000 Wood",
        description: "Deposits 100,000 Wood into your city.",
        price: 20,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1031: {
        name: "1,000 Stone",
        description: "Deposits 1,000 Stone into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1032: {
        name: "5,000 Stone",
        description: "Deposits 5,000 Stone into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1033: {
        name: "10,000 Stone",
        description: "Deposits 10,000 Stone into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1034: {
        name: "20,000 Stone",
        description: "Deposits 20,000 Stone into your city.",
        price: 6,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1035: {
        name: "40,000 Stone",
        description: "Deposits 40,000 Stone into your city.",
        price: 10,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1036: {
        name: "60,000 Stone",
        description: "Deposits 60,000 Stone into your city.",
        price: 14,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1037: {
        name: "80,000 Stone",
        description: "Deposits 80,000 Stone into your city.",
        price: 18,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1038: {
        name: "100,000 Stone",
        description: "Deposits 100,000 Stone into your city.",
        price: 20,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1041: {
        name: "1,000 Ore",
        description: "Deposits 1,000 Ore into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1042: {
        name: "5,000 Ore",
        description: "Deposits 5,000 Ore into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1043: {
        name: "10,000 Ore",
        description: "Deposits 10,000 Ore into your city.",
        price: null,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1044: {
        name: "20,000 Ore",
        description: "Deposits 20,000 Ore into your city.",
        price: 6,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1045: {
        name: "40,000 Ore",
        description: "Deposits 40,000 Ore into your city.",
        price: 10,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1046: {
        name: "60,000 Ore",
        description: "Deposits 60,000 Ore into your city.",
        price: 14,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1047: {
        name: "80,000 Ore",
        description: "Deposits 80,000 Ore into your city.",
        price: 18,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1048: {
        name: "100,000 Ore",
        description: "Deposits 100,000 Ore into your city.",
        price: 20,
        tradable: null,
        category: 4,
        subCategory: 0
    },
    i1061: {
        name: "N/A",
        description: "ITEM_TYPE_INSTANT_GEM",
        price: null,
        tradable: null,
        category: 0,
        subCategory: 0
    },
    i1062: {
        name: "100 Gems",
        description: "100 Gems",
        price: 100,
        tradable: null,
        category: 0,
        subCategory: 0
    },
    i1101: {
        name: "Sir Bor's Crest",
        description: "Increases your Knight's loyalty by 5",
        price: 25,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1102: {
        name: "Sir Ector's Crest",
        description: "Increases your Knight's loyalty by 10",
        price: 50,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1103: {
        name: "Sir Kay's Crest",
        description: "Increases your Knight's loyalty by 15",
        price: 75,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1104: {
        name: "Sir Bedivere's Crest",
        description: "Increases your Knight's loyalty by 20",
        price: 70,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1105: {
        name: "Sir Gawain's Crest",
        description: "Increases your Knight's loyalty by 25",
        price: 200,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1106: {
        name: "Sir Percival's Crest",
        description: "Increases your Knight's loyalty by 30",
        price: 75,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1107: {
        name: "Sir Galahad's Crest",
        description: "Increases your Knight's loyalty by 40",
        price: 100,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1108: {
        name: "Sir Lancelot's Crest",
        description: "Increases your Knight's loyalty by 50",
        price: 150,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1109: {
        name: "King Arthur's Crest",
        description: "Increases your Knight's loyalty by 60",
        price: 85,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1110: {
        name: "Morgana's Seal",
        description: "Morgana's Seal",
        price: 115,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1111: {
        name: "Mordred's Seal",
        description: "Mordred's Seal",
        price: 170,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1112: {
        name: "Stag King's Seal",
        description: "Stag King's Seal",
        price: 90,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1113: {
        name: "Pendragon Seal",
        description: "Pendragon Seal",
        price: 120,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1114: {
        name: "Lady of the Lake's Seal",
        description: "Lady of the Lake's Seal",
        price: 180,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1115: {
        name: "Merlin's Seal",
        description: "Merlin's Seal",
        price: null,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1120: {
        name: "Aetherseal",
        description: "Aetherseal",
        price: null,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1121: {
        name: "Ysbadden Seal",
        description: "Ysbadden Seal",
        price: null,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1122: {
        name: "Sidhe Seal",
        description: "Sidhe Seal",
        price: null,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1199: {
        name: "Vellum Scroll",
        description: "A Vellum Scroll is marked with the secrets of raising a druid Stone Circle. The Stone Circle allows you to expend Aetherstones and train Kerns",
        price: 10,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i1202: {
        name: "Second City Deed",
        description: "Required to build a Second City.",
        price: 150,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i1203: {
        name: "Third City Deed",
        description: "Required to build a Third City.",
        price: 250,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i1204: {
        name: "Fourth City Deed",
        description: "Required to build a Fourth City.",
        price: 500,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i1205: {
        name: "Fifth City Deed",
        description: "Required to build a Fifth City.",
        price: 750,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i1206: {
        name: "Sixth City Deed",
        description: "Required to build a Sixth City.",
        price: 850,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i1207: {
        name: "Seventh City Deed",
        description: "Required to build a Seventh City.",
        price: 900,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i1208: {
        name: "Eighth City Deed",
        description: "Required to build a Eighth City.",
        price: 950,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i1209: {
        name: "Ninth City Deed",
        description: "A deed that allows you to build a Ninth city. This item does not get consumed.",
        price: null,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i1210: {
        name: "Tenth City Deed",
        description: "A deed that allows you to build a Tenth city. This item does not get consumed.",
        price: null,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i1211: {
        name: "Fey Deed",
        description: "Required to build a Fey City.",
        price: 950,
        tradable: null,
        category: 6,
        subCategory: 0
    },
    i1300: {
        name: "200 Supply Troops",
        description: "Summons 200 Supply Troops",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1301: {
        name: "1000 Supply Troops",
        description: "Summons 1,000 Supply Troops",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1310: {
        name: "200 Militiamen",
        description: "Summons 200 Miltiamen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1311: {
        name: "1000 Militiamen",
        description: "Summons 1,000 Miltiamen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1320: {
        name: "200 Scouts",
        description: "Summons 200 Scouts",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1321: {
        name: "1000 Scouts",
        description: "Summons 1,000 Scouts",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1330: {
        name: "200 Pikemen",
        description: "Summons 200 Pikemen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1331: {
        name: "1000 Pikemen",
        description: "Summons 1,000 Pikemen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1340: {
        name: "150 Swordsmen",
        description: "Summons 150 Swordsmen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1341: {
        name: "750 Swordsmen",
        description: "Summons 750 Swordsmen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1350: {
        name: "150 Archers",
        description: "Summons 150 Archers",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1351: {
        name: "750 Archers",
        description: "Summons 750 Archers",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1360: {
        name: "150 Cavalry",
        description: "Summons 150 Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1361: {
        name: "750 Cavalry",
        description: "Summons 750 Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1370: {
        name: "100 Heavy Cavalry",
        description: "Summons 100 Heavy Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1371: {
        name: "500 Heavy Cavalry",
        description: "Summons 500 Heavy Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1380: {
        name: "100 Supply Wagons",
        description: "Summons 100 Supply Wagons",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1381: {
        name: "500 SupplyWagons",
        description: "Summons 500 Supply Wagons",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1390: {
        name: "100 Ballistae",
        description: "Summons 100 Ballistae",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1391: {
        name: "500 Ballistae",
        description: "Summons 500 Ballistae",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1400: {
        name: "50 Battering Rams",
        description: "Summons 50 Battering Rams",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1401: {
        name: "200 Battering Rams",
        description: "Summons 200 Battering Rams",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1410: {
        name: "50 Catapults",
        description: "Summons 50 Catapults",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1411: {
        name: "200 Catapults",
        description: "Summons 200 Catapults",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1412: {
        name: "10 Supply Troops",
        description: "Summons 10 Supply Troops",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1413: {
        name: "25 Supply Troops",
        description: "Summons 25 Supply Troops",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1414: {
        name: "50 Supply Troops",
        description: "Summons 50 Supply Troops",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1415: {
        name: "75 Supply Troops",
        description: "Summons 75 Supply Troops",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1416: {
        name: "100 Supply Troops",
        description: "Summons 100 Supply Troops",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1417: {
        name: "150 Supply Troops",
        description: "Summons 150 Supply Troops",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1418: {
        name: "10 Militiamen",
        description: "Summons 10 Militiamen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1419: {
        name: "25 Militiamen",
        description: "Summons 25 Militiamen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1420: {
        name: "50 Militiamen",
        description: "Summons 50 Militiamen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1421: {
        name: "75 Militiamen",
        description: "Summons 75 Militiamen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1422: {
        name: "100 Militiamen",
        description: "Summons 100 Militiamen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1423: {
        name: "150 Militiamen",
        description: "Summons 150 Militiamen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1424: {
        name: "10 Scouts",
        description: "Summons 10 Scouts",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1425: {
        name: "25 Scouts",
        description: "Summons 25 Scouts",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1426: {
        name: "50 Scouts",
        description: "Summons 50 Scouts",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1427: {
        name: "75 Scouts",
        description: "Summons 75 Scouts",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1428: {
        name: "100 Scouts",
        description: "Summons 100 Scouts",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1429: {
        name: "150 Scouts",
        description: "Summons 150 Scouts",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1430: {
        name: "10 Pikemen",
        description: "Summons 10 Pikemen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1431: {
        name: "25 Pikemen",
        description: "Summons 25 Pikemen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1432: {
        name: "50 Pikemen",
        description: "Summons 50 Pikemen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1433: {
        name: "75 Pikemen",
        description: "Summons 75 Pikemen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1434: {
        name: "100 Pikemen",
        description: "Summons 100 Pikemen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1435: {
        name: "150 Pikemen",
        description: "Summons 150 Pikemen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1436: {
        name: "10 Swordsmen",
        description: "Summons 10 Swordsmen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1437: {
        name: "25 Swordsmen",
        description: "Summons 25 Swordsmen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1438: {
        name: "50 Swordsmen",
        description: "Summons 50 Swordsmen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1439: {
        name: "75 Swordsmen",
        description: "Summons 75 Swordsmen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1440: {
        name: "100 Swordsmen",
        description: "Summons 100 Swordsmen",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1441: {
        name: "10 Archers",
        description: "Summons 10 Archers",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1442: {
        name: "25 Archers",
        description: "Summons 25 Archers",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1443: {
        name: "50 Archers",
        description: "Summons 50 Archers",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1444: {
        name: "75 Archers",
        description: "Summons 75 Archers",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1445: {
        name: "100 Archers",
        description: "Summons 100 Archers",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1446: {
        name: "10 Cavalry",
        description: "Summons 10 Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1447: {
        name: "25 Cavalry",
        description: "Summons 25 Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1448: {
        name: "50 Cavalry",
        description: "Summons 50 Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1449: {
        name: "75 Cavalry",
        description: "Summons 75 Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1450: {
        name: "100 Cavalry",
        description: "Summons 100 Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1451: {
        name: "10 Heavy Cavalry",
        description: "Summons 10 Heavy Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1452: {
        name: "25 Heavy Cavalry",
        description: "Summons 25 Heavy Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1453: {
        name: "50 Heavy Cavalry",
        description: "Summons 50 Heavy Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1454: {
        name: "75 Heavy Cavalry",
        description: "Summons 75 Heavy Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1455: {
        name: "150 Heavy Cavalry",
        description: "Summons 150 Heavy Cavalry",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1456: {
        name: "10 Supply Wagons",
        description: "Summons 10 Supply Wagons",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1457: {
        name: "25 Supply Wagons",
        description: "Summons 25 Supply Wagons",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1458: {
        name: "50 Supply Wagons",
        description: "Summons 50 Supply Wagons",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1459: {
        name: "75 Supply Wagons",
        description: "Summons 75 Supply Wagons",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1460: {
        name: "150 Supply Wagons",
        description: "Summons 150 Supply Wagons",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1461: {
        name: "10 Ballistae",
        description: "Summons 10 Ballistae",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1462: {
        name: "25 Ballistae",
        description: "Summons 25 Ballistae",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1463: {
        name: "50 Ballistae",
        description: "Summons 50 Ballistae",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1464: {
        name: "75 Ballistae",
        description: "Summons 75 Ballistae",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1465: {
        name: "150 Ballistae",
        description: "Summons 150 Ballistae",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1466: {
        name: "10 Battering Rams",
        description: "Summons 10 Battering Rams",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1467: {
        name: "25 Battering Rams",
        description: "Summons 25 Battering Rams",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1468: {
        name: "75 Battering Rams",
        description: "Summons 75 Battering Rams",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1469: {
        name: "100 Battering Rams",
        description: "Summons 100 Battering Rams",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1470: {
        name: "150 Battering Rams",
        description: "Summons 150 Battering Rams",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1471: {
        name: "10 Catapults",
        description: "Summons 10 Catapults",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1472: {
        name: "25 Catapults",
        description: "Summons 25 Catapults",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1473: {
        name: "75 Catapults",
        description: "Summons 75 Catapults",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1474: {
        name: "100 Catapults",
        description: "Summons 100 Catapults",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1475: {
        name: "150 Catapults",
        description: "Summons 150 Catapults",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1476: {
        name: "1000 Catapults",
        description: "Summons 1000 Catapults",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i1477: {
        name: "5000 Catapults",
        description: "Summons 5000 Catapults",
        price: null,
        tradable: null,
        category: 3,
        subCategory: 0
    },
    i2000: {
        name: "Renaming Ritual",
        description: "Change the name of your Guardian.",
        price: 10,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i2001: {
        name: "Elemental Rebirth",
        description: "Change the current Guardian, but maintain the current level",
        price: 10,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i2002: {
        name: "Obsidian Rune",
        description: "This rune allows you to summon the Iron Indrik to your city.  The Iron Indrik boosts your Ore production, capacity and increases the Attack attribute of your marching troops.",
        price: 50,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i2003: {
        name: "Deluge Rune",
        description: "This rune allows you to summon the Viand Asherah to your city.  The Viand Asherah boosts your Food production and capacity, and increases troop march speed.",
        price: 50,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i2004: {
        name: "Stone Rune",
        description: "This rune allows you to summon the Emet Golem to your city.  The Emet Golem boosts your Stone production and capacity, and decreases troop training time.",
        price: 50,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i3000: {
        name: "Ohrstone",
        description: "A brittle, white rock with many small facets.",
        price: 2,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i3001: {
        name: "Flax Wing",
        description: "Spun flax in the shape of a great bird's wing.",
        price: 1,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i3002: {
        name: "Animal Hide",
        description: "The skin of an animal, ready for tanning.",
        price: 1,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i3003: {
        name: "Keterstone",
        description: "A smooth, golden rock that is incredibly hard.",
        price: 2,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i3004: {
        name: "Scroll of Blessing",
        description: "A scroll of holy writings, describing the way to bless water.",
        price: 16,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i3005: {
        name: "Blessed Water",
        description: "A vial of holy water.",
        price: 27,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i3006: {
        name: "Divine Sacrament",
        description: "Incense, blessed water, wine, bread - all the necessary things to perform a holy ritual.",
        price: 40,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i3007: {
        name: "Bloodstone",
        description: "A scarlet rock that pulses with warmth.",
        price: 1,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i3008: {
        name: "Lodestone",
        description: "A blue-grey rock that is far heavier than it looks.",
        price: 1,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i3009: {
        name: "Tiferstone",
        description: "A malleable, dun rock.",
        price: 1,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i3010: {
        name: "Vellum Scroll",
        description: "A scroll made of tanned animal hides.",
        price: 8,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i3011: {
        name: "Guinevere's Favor",
        description: "A lady's silk kerchief.",
        price: 3,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i10000: {
        name: "Beginner's Package",
        description: "This Package contains items to grow your City!",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10001: {
        name: "Page's Package.",
        description: "contains over 230 Gems worth of items to grow your City!",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10002: {
        name: "Squire's Package.",
        description: "This Package contains items to grow your City!",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10003: {
        name: "Knight's Package.",
        description: "This Package contains items to grow your City!",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10004: {
        name: "Harvest Gift",
        description: "Arthur has rewarded your contribution with a gift of his own to help you this Harvest Season.",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10005: {
        name: "Harvest Prize",
        description: "Arthur has rewarded your contribution with a prize to help you this Harvest Season.",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10006: {
        name: "Harvest Bounty",
        description: "Arthur has rewarded your generous contribution with a package to ensure a bountiful Harvest Season.",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10007: {
        name: "Get Me Out of Here!",
        description: "For a quick escape, nothing beats Portals of Refuge and Doves of Peace. Contains: x2 Portal of Refuge, x2 Dove of Peace",
        price: 100,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10008: {
        name: "Gaia's Bounty",
        description: "A collection of items sure to bestow Gaia's blessing upon your Resources. Contains: x5 Harvest Prayer, x5 Druidic Blessing, x5 Gnomish Stone Cutter, x5 Dwarven Mining Tools",
        price: 120,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10009: {
        name: "Divine Ascension",
        description: "Let the Divine light shine upon your powerful City. Contains: x5 Divine Inspiration",
        price: 180,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10010: {
        name: "Bountiful Season",
        description: "Increase your Resources for an entire fortnight! Contains: x2 Harvest Sacrifice, x2 Druidic Ceremony, x2 Gnomish Quarrying Team, x2 Dwarven Assistance",
        price: 340,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10011: {
        name: "Magical Restoration",
        description: "Sometimes the only way to build up, is to first tear down. Dragon's Stomps and many Hourglasses are available here. Contains: x5 Dragon's Stomp, x10 Squire's Hourglass, x5 Knight's Hourglass, x5 Guinevere's Hourglass, x5 Morgana's Hourglass, x3 Arthur's Hourglass, x2 Merlin's Hourglass",
        price: 450,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10012: {
        name: "Ice Storm Battle Chest",
        description: "This package contains some of Arthur's favorite items for the Winter Battle Season",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10013: {
        name: "Frost Battle Chest",
        description: "This package contains some useful items for the Winter Battle Season",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10014: {
        name: "Blizzard Battle Chest",
        description: "This package contains some of Arthur's most treasured items for the Winter Battle Season",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10015: {
        name: "Page's Package",
        description: "This Package contains over 230 Gems worth of items to grow your City!",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10016: {
        name: "Squire's Package",
        description: "This Package contains items to grow your City!",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10017: {
        name: "Knight's Package",
        description: "This Package contains items to grow your City!",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10018: {
        name: "Haitian Relief Package",
        description: "100% of proceeds to be donated to the American Red Cross Haiti Relief and Development Fund. Includes 1 Young  Volunteers, 2 Merlin's Magical Tokens, and 5,000 of each Resource",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10019: {
        name: "Offering of Affection",
        description: "A token of love that can be gifted to another player. Contains: X1 Rose of Charisma, X1 Dove of Peace, x1 Day of Prosperity, x1 Fountain of Youth, x1 Red Curtains",
        price: null,
        tradable: 1,
        category: 5,
        subCategory: 0
    },
    i10020: {
        name: "New City Chest",
        description: "A gift from Merlin to start building a mighty City",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10021: {
        name: "Potion of Mist",
        description: "Covers your cities in the Mists of Avalon for one week; under the cover of Mists, your cities are harder to identify, but can still be attacked. Attacking players will clear the Mists from your cities.",
        price: 10,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i10022: {
        name: "Inactive Resource Chest",
        description: "Contains 1,000 of each Resource",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10023: {
        name: "5th City Package",
        description: "Build up your 5th city faster!  Contains 5th city deed, x5 Divine Hourglass, x2 Knights Hourglass, x1 Merlin's Magical Token",
        price: 1250,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10024: {
        name: "Wages of War",
        description: "Build your army to conquer your foes.  Contains x3 Dove of Peace, x3 Lancelot's Tutelage, x1 Horn of Majesty, x1 Divine Inspiration",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10026: {
        name: "Chest of Charity",
        description: "Help those in need. 100% of proceeds will be donated to the Child\u2019s Play charity.  Contains x2 Merlin's Magical Token, x1 40,000 Ore, x1 Young Volunteers",
        price: 30,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10027: {
        name: "6th City Package",
        description: "Build up your 6th city faster!  Contains x1 6th city deed, x1 Blue Eagle Wings, x1 Reinforced Bags, x1 Fey Flag, x1 Potions of Mist, x1 Divine Hourglass, x1 Portal of Order",
        price: 1080,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10028: {
        name: "Call to Arms",
        description: "For a limited time only! Summons an army of over 2,000 troops to aid you in battle, including catapults and a random assortment of other units.",
        price: 350,
        tradable: null,
        category: 3,
        subCategory: 100
    },
    i10029: {
        name: "Mystery Chest",
        description: "Take a chance to obtain a powerful item.  You can win a Divine Inspiration, Horn of Bounty, Divine Hourglass or one of many other great items.",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10030: {
        name: "7th City Package",
        description: "Build up your 7th city and prepare for battle! Contains x1 7th City Deed, x1 Blood Fury, x1 Ironskin, x1 Potion of Mist, x1 Portal of Order",
        price: 1080,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10031: {
        name: "Chest of Order",
        description: "Establish order in your Kingdom: x3 Portal of Order",
        price: 240,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10032: {
        name: "Divine Evocation",
        description: "Light up the Kingdom by building your cities to their maximum potential! Contains x1 Divine Providence, x2 Divine Inspirations, and x3 Divine Hourglasses.",
        price: 600,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10033: {
        name: "Prince's Package",
        description: "This Package contains items to grow your City!",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10034: {
        name: "King's Package",
        description: "This Package contains items to grow your City!",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10035: {
        name: "Herald's Package",
        description: "This Package contains items to grow your City!",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10036: {
        name: "Fey City Premier Package",
        description: "LIMITED TIME ONLY! Be the first to get a Fey City and Summon the Viand Kraken! Contains x1 Fey City Deed, x1 Deluge Rune, x1 Portal of Order, x1 Sacred Providence, x2 Sacred Inspiration, x1 Divine Hourglass, x1 Potion of Mist.",
        price: 1750,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10037: {
        name: "Fey City Package",
        description: "Build up your Fey City and continue your conquest! Contains x1 Fey City Deed, x1 Portal of Order, x1 Sacred Providence, x1 Potion of Mist",
        price: 1150,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10038: {
        name: "Dark Forest Chest",
        description: "Contains between 1 and 3 Aetherseals, 1 and 3 Ysbadden Seals, and 1 and 3 Sidhe Seals.",
        price: 450,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10043: {
        name: "Super Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!",
        price: 50,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10044: {
        name: "New City Mystery Box",
        description: "Limited time! Take a chance to win the new city deed or other exclusive items!",
        price: 55,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10045: {
        name: "Combat Mystery Box",
        description: "Do you feel lucky? Dominate your opponents with one of many great combat items!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10046: {
        name: "Builder Mystery Box",
        description: "Take a chance to win a powerful building item like Divine/Sacred Items, hourglasses, or others that will help you build the greatest Kingdom in Camelot!",
        price: 45,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10047: {
        name: "City Mystery Chest",
        description: "Take a chance to win a crest or seal for your next city!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10048: {
        name: "Mini Mystery Box",
        description: "Need a useful item like a Red Dragon Wings or one of the Horns? Here's your chance to win for a great price!",
        price: 15,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10049: {
        name: "Morgana's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10050: {
        name: "Arthur's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10051: {
        name: "Morien's Mystery Box",
        description: "Take a chance to win a great item!  Check today's message for more details!",
        price: 25,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10052: {
        name: "Kabam Card Mystery Box",
        description: "",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10053: {
        name: "Gawain's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 1,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10054: {
        name: "Galahad's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 2,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10055: {
        name: "Erec's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 5,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10056: {
        name: "Gareth's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 10,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10057: {
        name: "Gaheris' Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 15,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10058: {
        name: "Bors' Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 15,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10059: {
        name: "Bedivere's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 30,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10060: {
        name: "Perceval's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 30,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10061: {
        name: "Kay's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10062: {
        name: "Lamorak's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10063: {
        name: "Tristan's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 40,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10064: {
        name: "Yvain's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 40,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10065: {
        name: "Balin's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 45,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10066: {
        name: "Mordred's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 45,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10067: {
        name: "Guinevere's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 50,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10068: {
        name: "Pellinore's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 50,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10069: {
        name: "Lionel's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 50,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10070: {
        name: "Merlin's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 75,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10071: {
        name: "Giles' Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 75,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10072: {
        name: "Green Knight's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 100,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10073: {
        name: "Excalibur Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 500,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10074: {
        name: "Festive Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10075: {
        name: "Celebration Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10076: {
        name: "Summer Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10077: {
        name: "Love Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10078: {
        name: "Holiday Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10079: {
        name: "Spring Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10080: {
        name: "Autumn Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10081: {
        name: "Independence Day Mystery Chest",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10082: {
        name: "Winter Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10083: {
        name: "New Year's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10084: {
        name: "Santa's Mystery Box",
        description: "Take a chance to win one of the most powerful items in Camelot!  Check today's message for more details!",
        price: 25,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10085: {
        name: "Barbury Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 10,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10086: {
        name: "Bratton Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 15,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10087: {
        name: "Liddington Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 20,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10088: {
        name: "Uffington Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 20,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10089: {
        name: "Richborough Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 25,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10090: {
        name: "Whitley Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 25,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10091: {
        name: "Dover Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 30,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10092: {
        name: "Norwich Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 30,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10093: {
        name: "Orford Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10094: {
        name: "Restormel Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 35,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10095: {
        name: "Launceston Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 40,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10096: {
        name: "Wallingford Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 40,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10097: {
        name: "Malbork Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 45,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10098: {
        name: "Bodiam Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 50,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10099: {
        name: "Reveril Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 50,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10100: {
        name: "Spis Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 60,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10101: {
        name: "Tintagel Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 75,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10102: {
        name: "Citadel Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 100,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10103: {
        name: "Himeji Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 320,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10104: {
        name: "Bodiam Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 500,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10105: {
        name: "Camelot Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 850,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10106: {
        name: "Shamrock Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 40,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10107: {
        name: "Summer Solstice Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 40,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10108: {
        name: "Santa's Gift Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 25,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10109: {
        name: "Holiday Chest",
        description: "Contains a bundle of Camelot's most valuable items!  Check today's message for item list.",
        price: 50,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10110: {
        name: "Divine Domination",
        description: "Contains 10 Divine Inspirations for a great price!",
        price: 345,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10111: {
        name: "Super Portal Chest",
        description: "Contains 10 Portal of Orders for a great price!",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10112: {
        name: "Gold Merlin Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10113: {
        name: "Gold Arthur Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10114: {
        name: "Gold Morgana Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10115: {
        name: "Gold Guinevere Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10116: {
        name: "Gold Knight's Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10117: {
        name: "Gold Squire's Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10118: {
        name: "Silver Merlin Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10119: {
        name: "Silver Arthur Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10120: {
        name: "Silver Morgana Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10121: {
        name: "Silver Guinevere Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10122: {
        name: "Silver Knight's Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10123: {
        name: "Silver Squire's Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10124: {
        name: "Bronze Merlin Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10125: {
        name: "Bronze Arthur Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10126: {
        name: "Bronze Morgana Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10127: {
        name: "Bronze Guinevere Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10128: {
        name: "Bronze Knight's Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10129: {
        name: "Bronze Squire's Mystery Box",
        description: "Check the Tournament Tab for item description",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10130: {
        name: "Prince's Mystery Box",
        description: "Contains a chance to win one of Camelot's most powerful items!",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10131: {
        name: "King's Mystery Box",
        description: "Contains a chance to win one of Camelot's most powerful items!",
        price: null,
        tradable: null,
        category: 5,
        subCategory: 100
    },
    i10132: {
        name: "Appreciation Package",
        description: "Our gift to you as a player and participant in our Beta program.",
        price: 0,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i10133: {
        name: "Premium Player Package",
        description: "Our gift to you as a player and participant in our Beta program.",
        price: 0,
        tradable: null,
        category: 5,
        subCategory: 0
    },
    i20001: {
        name: "Lesser Protection Stone",
        description: "50% chance that a Failure will not break the item.  Will be consumed with each Enhance/Upgrade attempt.",
        price: 1,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i20002: {
        name: "Protection Stone",
        description: "Completely prevents an item from breaking if the Enhance/Upgrade is not successful.  Will be consumed with each Enhance/Upgrade attempt.",
        price: 2,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i20003: {
        name: "Lesser Mystics Orb",
        description: "Prevents an item from breaking and prevents the Quality from being reduced if the Enhance is not successful.  Will be consumed with each Enhance attempt.",
        price: 5,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i20004: {
        name: "Mystics Orb",
        description: "Prevents an item from breaking, prevents Quality downgrade and increases chance of success by 2x.  Will be consumed with each Enhance attempt.",
        price: 12,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i20005: {
        name: "Lesser Lucky Token",
        description: "Prevents an item from breaking and increases chance of success by 2x.  WIll be consumed with each Upgrade attempt.",
        price: 5,
        tradable: null,
        category: 1,
        subCategory: 0
    },
    i20006: {
        name: "Lucky Token",
        description: "Prevents an item from breaking and increases the chance of success by 4x.  Will be consumed with each Upgrade attempt.",
        price: 15,
        tradable: null,
        category: 1,
        subCategory: 0
    }
};
var shopOrder = [505, 599, 10021, 10029, 401, 911, 912, 924, 361, 362, 363, 231, 923, 355, 221, 922, 351, 941, 1, 211, 241, 2, 3, 4, 5, 6, 7, 8, 10, 9, 26, 49, 276, 277, 278, 273, 274, 275, 261, 262, 271, 272, 55, 57, 931, 901, 1015, 1025, 1035, 1045, 101, 102, 111, 112, 121, 122, 131, 132, 141, 142, 501, 502, 503, 504, 10023, 10027, 942, 10007, 10008, 10009, 10010, 10011, 1202, 1203, 1204, 1205, 1206, 711, 721, 731, 741, 801, 802, 803, 804, 805, 811, 812, 813, 814, 821, 822, 823, 824, 825, 831, 832, 833, 834, 835, 841, 842, 843, 844, 845, 851, 852, 853, 854, 855, 893, 860, 861, 885, 886, 887, 888, 889, 862, 863, 864, 865, 866, 867, 868, 869, 870, 871, 872, 873, 874, 875, 876, 877, 878, 879, 880, 881, 882, 883, 884];
var questlist = {
    q1002: {
        heading: "Build Your City",
        category: "City Expansion",
        name: "Castle Upgrade",
        preferredorder: "18",
        prerequisite: "1042",
        description: "Your City is growing in stature, and you need a Castle that reflects your new power! Upgrade your Castle to be able to upgrade your other buildings to a higher level. This is also a great time to test out using Speed Ups! Use your Squire&#39;s or Knight&#39;s Hourglass to reduce the time it takes to upgrade your Castle.",
        objective: ["1", "0", 2],
        reward: [
            [0, 2500, 12000, 5500, 2500, 0],
            [],
            [
                [2, 1]
            ],
            [0, 0, 0]
        ]
    },
    q1003: {
        heading: "Build Your City",
        category: "City Expansion",
        name: "Castle Upgrade",
        preferredorder: "35",
        prerequisite: "1002",
        description: "Your City is growing in stature, and you need a Castle that reflects your new power! Upgrade your Castle to be able to upgrade your other buildings to a higher level, open more Fields, and control more Wildernesses",
        objective: ["1", "0", 3],
        reward: [
            [0, 5000, 13000, 11000, 5000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1004: {
        heading: "Build Your City",
        category: "City Expansion",
        name: "Castle Upgrade",
        preferredorder: "52",
        prerequisite: "1003",
        description: "Your City is growing in stature, and you need a Castle that reflects your new power! Upgrade your Castle to be able to upgrade your other buildings to a higher level, open more Fields, and control more Wildernesses",
        objective: ["1", "0", 4],
        reward: [
            [0, 10000, 26000, 22000, 10000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1005: {
        heading: "Build Your City",
        category: "City Expansion",
        name: "Castle Upgrade",
        preferredorder: "61",
        prerequisite: "1004",
        description: "Your City is growing in stature, and you need a Castle that reflects your new power! Upgrade your Castle to be able to upgrade your other buildings to a higher level, open more Fields, and control more Wildernesses",
        objective: ["1", "0", 5],
        reward: [
            [0, 20000, 50000, 50000, 20000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1006: {
        heading: "Build Your City",
        category: "City Expansion",
        name: "Castle Upgrade",
        preferredorder: "65",
        prerequisite: "1005",
        description: "Your City is growing in stature, and you need a Castle that reflects your new power! Upgrade your Castle to be able to upgrade your other buildings to a higher level, open more Fields, and control more Wildernesses",
        objective: ["1", "0", 6],
        reward: [
            [0, 15000, 25000, 50000, 15000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1007: {
        heading: "Build Your City",
        category: "City Expansion",
        name: "Castle Upgrade",
        preferredorder: "67",
        prerequisite: "1006",
        description: "Your City is growing in stature, and you need a Castle that reflects your new power! Upgrade your Castle to be able to upgrade your other buildings to a higher level, open more Fields, and control more Wildernesses",
        objective: ["1", "0", 7],
        reward: [
            [0, 20000, 50000, 50000, 20000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1008: {
        heading: "Build Your City",
        category: "City Expansion",
        name: "Castle Upgrade",
        preferredorder: "71",
        prerequisite: "1007",
        description: "Your City is growing in stature, and you need a Castle that reflects your new power! Upgrade your Castle to be able to upgrade your other buildings to a higher level, open more Fields, and control more Wildernesses",
        objective: ["1", "0", 8],
        reward: [
            [0, 20000, 50000, 50000, 20000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1009: {
        heading: "Build Your City",
        category: "City Expansion",
        name: "Castle Upgrade",
        preferredorder: "80",
        prerequisite: "1008",
        description: "Your City is growing in stature, and you need a Castle that reflects your new power! Upgrade your Castle to be able to upgrade your other buildings to a higher level, open more Fields, and control more Wildernesses",
        objective: ["1", "0", 9],
        reward: [
            [0, 20000, 50000, 50000, 20000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1000: {
        heading: "Build Your City",
        category: "City Expansion",
        name: "Castle Upgrade",
        preferredorder: "88",
        prerequisite: "1009",
        description: "Your City is growing in stature, and you need a Castle that reflects your new power! Upgrade your Castle to be able to upgrade your other buildings to a higher level, open more Fields, and control more Wildernesses",
        objective: ["1", "0", 10],
        reward: [
            [0, 20000, 50000, 50000, 20000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1011: {
        heading: "Grow Your Resources",
        category: "Resource Gathering",
        name: "Farming",
        preferredorder: "4",
        prerequisite: "1021",
        description: "Food is used to keep your troops full, healthy, and ready to fight, and to feed your workers while they work on your buildings. <b>Go to the Field View</b> and build a Farm now to begin growing Food for your city.",
        objective: ["1", "1", 1],
        reward: [
            [0, 300, 2000, 1500, 1000, 0],
            [],
            [
                [1, 1]
            ],
            [0, 0, 0]
        ]
    },
    q1013: {
        heading: "Grow Your Resources",
        category: "Resource Gathering",
        name: "Greater Farming",
        preferredorder: "13",
        prerequisite: "1524",
        description: "While one Farm is enough to get your City started, you&#39;ll need more as your City grows. Build two more Farms to ensure you have a plentiful supply of Food. ",
        objective: ["15", "1", 3],
        reward: [
            [0, 600, 2000, 1500, 1000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1015: {
        heading: "Grow Your Resources",
        category: "Resource Gathering",
        name: "Upgrade Your Farm",
        preferredorder: "24",
        prerequisite: "1041",
        description: "Upgrade your Farms to level 3 to produce greater amounts of Food.",
        objective: ["1", "1", 3],
        reward: [
            [0, 1000, 5000, 3000, 2500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1021: {
        heading: "Grow Your Resources",
        category: "Resource Gathering",
        name: "Logging",
        preferredorder: "1",
        prerequisite: "",
        description: "You will need Wood to build more buildings and defenses, and train new troops. To gather usable Wood, build a Sawmill. Click on the Field view, then click on an empty lot and choose to build a Sawmill.",
        objective: ["1", "2", 1],
        reward: [
            [0, 600, 1000, 1500, 1500, 0],
            [],
            [
                [1, 1]
            ],
            [0, 0, 0]
        ]
    },
    q1025: {
        heading: "Grow Your Resources",
        category: "Resource Gathering",
        name: "Upgrade Your Sawmill",
        preferredorder: "26",
        prerequisite: "1041",
        description: "Upgrade your Sawmills to level 3 to produce greater amounts of Wood.",
        objective: ["1", "2", 3],
        reward: [
            [0, 2000, 2000, 3000, 3000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1031: {
        heading: "Grow Your Resources",
        category: "Resource Gathering",
        name: "Quarrying",
        preferredorder: "5",
        prerequisite: "1011",
        description: "Stone is the foundation of your buildings, allowing them to withstand attacks and time. To gather usable Stone, build a Quarry.",
        objective: ["1", "3", 1],
        reward: [
            [0, 900, 2250, 900, 1500, 0],
            [],
            [
                [1, 1]
            ],
            [0, 0, 0]
        ]
    },
    q1033: {
        heading: "Grow Your Resources",
        category: "Resource Gathering",
        name: "Greater Quarrying",
        preferredorder: "15",
        prerequisite: "1013",
        description: "While one Quarry is enough to get your City started, you&#39;ll need more as your City grows. Build two more Quarries to ensure you have a plentiful supply of Stone. ",
        objective: ["15", "3", 3],
        reward: [
            [0, 900, 2250, 900, 1500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1035: {
        heading: "Grow Your Resources",
        category: "Resource Gathering",
        name: "Quarry Upgrade",
        preferredorder: "22",
        prerequisite: "1041",
        description: "Upgrade your Quarries to level 3 to produce greater amounts of Stone.\n",
        objective: ["1", "3", 3],
        reward: [
            [0, 3000, 6000, 2000, 3000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1041: {
        heading: "Grow Your Resources",
        category: "Resource Gathering",
        name: "Mining",
        preferredorder: "6",
        prerequisite: "1031",
        description: "Ore is necessary to create any metal, from weapons to nails. To gather usable Ore, build a Mine.",
        objective: ["1", "4", 1],
        reward: [
            [0, 1500, 2400, 2250, 1500, 0],
            [],
            [
                [1, 1]
            ],
            [0, 0, 0]
        ]
    },
    q1042: {
        heading: "Grow Your Resources",
        category: "Resource Gathering",
        name: "Greater Mining",
        preferredorder: "17",
        prerequisite: "1033",
        description: "While one Mine is enough to get your City started, you&#39;ll need more as your City grows. Build one more Mine to ensure you have a plentiful supply of Ore. ",
        objective: ["15", "4", 2],
        reward: [
            [0, 1500, 2500, 2250, 1500, 0],
            [],
            [
                [1, 1]
            ],
            [0, 0, 0]
        ]
    },
    q1045: {
        heading: "Grow Your Resources",
        category: "Resource Gathering",
        name: "Ore Mine Upgrade",
        preferredorder: "28",
        prerequisite: "1041",
        description: "Upgrade your Mines to level 3 to produce greater amounts of Ore.",
        objective: ["1", "4", 3],
        reward: [
            [0, 4000, 6000, 5000, 3000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1051: {
        heading: "Build Your City",
        category: "Establish Your City",
        name: "Housing Subjects",
        preferredorder: "2",
        prerequisite: "1021",
        description: "Now that King Arthur has granted you a City, you&#39;ll need a place for your subjects to live! Build a Cottage to increase your Population.",
        objective: ["1", "5", 1],
        reward: [
            [0, 200, 1000, 200, 100, 0],
            [],
            [
                [1, 1],
                [599, 1]
            ],
            [0, 0, 0]
        ]
    },
    q1052: {
        heading: "Build Your City",
        category: "Establish Your City",
        name: "Upgrade Your Cottage",
        preferredorder: "21",
        prerequisite: "1071",
        description: "Now that you have more jobs to be done, you need more workers! Upgrade your cottage to increase your Population. Click on one of your Cottages and choose Upgrade.",
        objective: ["1", "5", 3],
        reward: [
            [50, 500, 2000, 500, 500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1061: {
        heading: "Build Your City",
        category: "Administration",
        name: "Improve Happiness",
        preferredorder: "25",
        prerequisite: "1041",
        description: "The Tavern provides your subjects with a place to relax, and increases your Happiness. Higher levels of Tavern provide larger reductions, but your Happiness can never exceed 100.",
        objective: ["1", "6", 1],
        reward: [
            [0, 1000, 15000, 1000, 750, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1071: {
        heading: "Build Your City",
        category: "Knight Recruitment",
        name: "Knights&#39; Hall",
        preferredorder: "8",
        prerequisite: "1041",
        description: "Your City must have defenses to keep your people safe! Before you raise an army, you need people to lead it.  Go to the City View and Build a Knights&#39; Hall to be able to hire your friends as Knights.",
        objective: ["1", "7", 1],
        reward: [
            [0, 500, 2000, 1000, 500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1081: {
        heading: "Build Your City",
        category: "Alliance",
        name: "Embassy",
        preferredorder: "12",
        prerequisite: "1041",
        description: "An Embassy is necessary to join or create an Alliance, and to give Reinforcing Troops a place to stay.",
        objective: ["1", "8", 1],
        reward: [
            [0, 500, 2000, 1000, 5000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1091: {
        heading: "Build Your City",
        category: "Resource Management",
        name: "Storehouse",
        preferredorder: "31",
        prerequisite: "1041",
        description: "Upgrade your Storehouse to protect more Resources from being Plundered by your enemies.",
        objective: ["1", "9", 1],
        reward: [
            [0, 500, 2000, 1500, 500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1101: {
        heading: "Build Your City",
        category: "Trading",
        name: "Market",
        preferredorder: "30",
        prerequisite: "1071",
        description: "The Market is a gathering spot for buying and selling Resources between players. Upgrade your Market to enact multiple transactions at the same time.",
        objective: ["1", "10", 1],
        reward: [
            [0, 1500, 1500, 1500, 1500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1111: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Alchemy Lab",
        preferredorder: "14",
        prerequisite: "1041",
        description: "Alchemy is the study of natural properties, and how to bend them to your will.  An alchemist can make Farms produce more Food, arrows fly further, and supplies to be lighter. Any good alchemist must have an Alchemy Lab, so build one now!",
        objective: ["1", "11", 1],
        reward: [
            [0, 150, 2500, 1500, 200, 0],
            [],
            [
                [2, 1]
            ],
            [0, 0, 0]
        ]
    },
    q1112: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Alchemy Lab Upgrade",
        preferredorder: "27",
        prerequisite: "1111",
        description: "A higher level Alchemy Lab allows your alchemists to engage in more complicated research.",
        objective: ["1", "11", 2],
        reward: [
            [0, 300, 5000, 3000, 400, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1113: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Alchemy Lab Upgrade",
        preferredorder: "46",
        prerequisite: "1112",
        description: "A higher level Alchemy Lab allows your alchemists to engage in more complicated research.",
        objective: ["1", "11", 3],
        reward: [
            [0, 1000, 10000, 5000, 1000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1114: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Alchemy Lab Upgrade",
        preferredorder: "51",
        prerequisite: "1113",
        description: "A higher level Alchemy Lab allows your alchemists to engage in more complicated research.",
        objective: ["1", "11", 4],
        reward: [
            [0, 1500, 15000, 7500, 1500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1115: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Alchemy Lab Upgrade",
        preferredorder: "54",
        prerequisite: "1114",
        description: "A higher level Alchemy Lab allows your alchemists to engage in more complicated research.",
        objective: ["1", "11", 5],
        reward: [
            [0, 2000, 20000, 10000, 2000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1116: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Alchemy Lab Upgrade",
        preferredorder: "58",
        prerequisite: "1115",
        description: "A higher level Alchemy Lab allows your alchemists to engage in more complicated research.",
        objective: ["1", "11", 6],
        reward: [
            [0, 2000, 20000, 10000, 2000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1117: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Alchemy Lab Upgrade",
        preferredorder: "69",
        prerequisite: "1116",
        description: "A higher level Alchemy Lab allows your alchemists to engage in more complicated research.",
        objective: ["1", "11", 7],
        reward: [
            [0, 2000, 20000, 10000, 2000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1118: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Alchemy Lab Upgrade",
        preferredorder: "76",
        prerequisite: "1117",
        description: "A higher level Alchemy Lab allows your alchemists to engage in more complicated research.",
        objective: ["1", "11", 8],
        reward: [
            [0, 2000, 20000, 10000, 2000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1119: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Alchemy Lab Upgrade",
        preferredorder: "81",
        prerequisite: "1118",
        description: "A higher level Alchemy Lab allows your alchemists to engage in more complicated research.",
        objective: ["1", "11", 9],
        reward: [
            [0, 2000, 20000, 10000, 2000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1110: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Alchemy Lab Upgrade",
        preferredorder: "86",
        prerequisite: "1119",
        description: "A higher level Alchemy Lab allows your alchemists to engage in more complicated research.",
        objective: ["1", "11", 10],
        reward: [
            [0, 2000, 20000, 10000, 2000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1121: {
        heading: "Raise Your Army",
        category: "Marching",
        name: "Rally Point",
        preferredorder: "32",
        prerequisite: "1131",
        description: "Your troops gather at the Rally Point before Marching out at your command. Upgrade your Rally Point to send more troops with each March, and to send more Marches at a time.",
        objective: ["1", "12", 1],
        reward: [
            [0, 500, 1000, 2000, 500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1131: {
        heading: "Raise Your Army",
        category: "Training",
        name: "Barracks",
        preferredorder: "16",
        prerequisite: "1041",
        description: "Your City is growing, and needs troops to defend and grow your land. Troops are trained at the Barracks.",
        objective: ["1", "13", 1],
        reward: [
            [0, 1000, 1200, 1500, 1000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1132: {
        heading: "Raise Your Army",
        category: "Improve Training",
        name: "Barracks Upgrade",
        preferredorder: "36",
        prerequisite: "1131",
        description: "Upgraded Barracks allow you to train more powerful Troops and speed up Training.",
        objective: ["1", "13", 2],
        reward: [
            [0, 2000, 2400, 3000, 2000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1133: {
        heading: "Raise Your Army",
        category: "Improve Training",
        name: "Barracks Upgrade",
        preferredorder: "49",
        prerequisite: "1132",
        description: "Upgraded Barracks allow you to train more powerful Troops and speed up Training.",
        objective: ["1", "13", 3],
        reward: [
            [0, 4000, 4800, 6000, 4000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1134: {
        heading: "Raise Your Army",
        category: "Improve Training",
        name: "Barracks Upgrade",
        preferredorder: "50",
        prerequisite: "1133",
        description: "Upgraded Barracks allow you to train more powerful Troops and speed up Training.",
        objective: ["1", "13", 4],
        reward: [
            [0, 6000, 8000, 8000, 6000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1135: {
        heading: "Raise Your Army",
        category: "Improve Training",
        name: "Barracks Upgrade",
        preferredorder: "55",
        prerequisite: "1134",
        description: "Upgraded Barracks allow you to train more powerful Troops and speed up Training.",
        objective: ["1", "13", 5],
        reward: [
            [0, 8000, 10000, 10000, 8000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1136: {
        heading: "Raise Your Army",
        category: "Improve Training",
        name: "Barracks Upgrade",
        preferredorder: "62",
        prerequisite: "1135",
        description: "Upgraded Barracks allow you to train more powerful Troops and speed up Training.",
        objective: ["1", "13", 6],
        reward: [
            [0, 8000, 10000, 10000, 8000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1137: {
        heading: "Raise Your Army",
        category: "Improve Training",
        name: "Barracks Upgrade",
        preferredorder: "70",
        prerequisite: "1136",
        description: "Upgraded Barracks allow you to train more powerful Troops and speed up Training.",
        objective: ["1", "13", 7],
        reward: [
            [0, 8000, 10000, 10000, 8000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1138: {
        heading: "Raise Your Army",
        category: "Improve Training",
        name: "Barracks Upgrade",
        preferredorder: "75",
        prerequisite: "1137",
        description: "Upgraded Barracks allow you to train more powerful Troops and speed up Training.",
        objective: ["1", "13", 8],
        reward: [
            [0, 8000, 10000, 10000, 8000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1139: {
        heading: "Raise Your Army",
        category: "Improve Training",
        name: "Barracks Upgrade",
        preferredorder: "83",
        prerequisite: "1138",
        description: "Upgraded Barracks allow you to train more powerful Troops and speed up Training.",
        objective: ["1", "13", 9],
        reward: [
            [0, 8000, 10000, 10000, 8000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1130: {
        heading: "Raise Your Army",
        category: "Improve Training",
        name: "Barracks Upgrade",
        preferredorder: "85",
        prerequisite: "1139",
        description: "Upgraded Barracks allow you to train more powerful Troops and speed up Training.",
        objective: ["1", "13", 10],
        reward: [
            [0, 8000, 10000, 10000, 8000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1141: {
        heading: "Defend Your City",
        category: "Alarming",
        name: "Watch Tower",
        preferredorder: "45",
        prerequisite: "1191",
        description: "Your Watch Tower allows you to see Incoming Attacks, and have time to prepare your defenses. Build your Watch Tower now!",
        objective: ["1", "14", 1],
        reward: [
            [0, 300, 2000, 6000, 600, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1142: {
        heading: "Defend Your City",
        category: "Alarming",
        name: "Watch Tower",
        preferredorder: "53",
        prerequisite: "1141",
        description: "A higher level Watch Tower gives you more information on your attackers. Upgrade your Watch Tower now!",
        objective: ["1", "14", 2],
        reward: [
            [0, 300, 2000, 6000, 600, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1143: {
        heading: "Defend Your City",
        category: "Alarming",
        name: "Watch Tower",
        preferredorder: "59",
        prerequisite: "1142",
        description: "A higher level Watch Tower gives you more information on your attackers. Upgrade your Watch Tower now!",
        objective: ["1", "14", 3],
        reward: [
            [0, 500, 4000, 8500, 1000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1144: {
        heading: "Defend Your City",
        category: "Alarming",
        name: "Watch Tower",
        preferredorder: "63",
        prerequisite: "1143",
        description: "A higher level Watch Tower gives you more information on your attackers. Upgrade your Watch Tower now!",
        objective: ["1", "14", 4],
        reward: [
            [0, 750, 6000, 12000, 2000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1145: {
        heading: "Defend Your City",
        category: "Alarming",
        name: "Watch Tower",
        preferredorder: "68",
        prerequisite: "1144",
        description: "A higher level Watch Tower gives you more information on your attackers. Upgrade your Watch Tower now!",
        objective: ["1", "14", 5],
        reward: [
            [0, 1000, 8000, 16000, 4000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1146: {
        heading: "Defend Your City",
        category: "Alarming",
        name: "Watch Tower",
        preferredorder: "73",
        prerequisite: "1145",
        description: "A higher level Watch Tower gives you more information on your attackers. Upgrade your Watch Tower now!",
        objective: ["1", "14", 6],
        reward: [
            [0, 1000, 10000, 20000, 5000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1147: {
        heading: "Defend Your City",
        category: "Alarming",
        name: "Watch Tower",
        preferredorder: "77",
        prerequisite: "1146",
        description: "A higher level Watch Tower gives you more information on your attackers. Upgrade your Watch Tower now!",
        objective: ["1", "14", 7],
        reward: [
            [0, 1000, 10000, 20000, 5000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1148: {
        heading: "Defend Your City",
        category: "Alarming",
        name: "Watch Tower",
        preferredorder: "79",
        prerequisite: "1147",
        description: "A higher level Watch Tower gives you more information on your attackers. Upgrade your Watch Tower now!",
        objective: ["1", "14", 8],
        reward: [
            [0, 1000, 10000, 20000, 5000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1149: {
        heading: "Defend Your City",
        category: "Alarming",
        name: "Watch Tower",
        preferredorder: "84",
        prerequisite: "1148",
        description: "A higher level Watch Tower gives you more information on your attackers. Upgrade your Watch Tower now!",
        objective: ["1", "14", 9],
        reward: [
            [0, 1000, 10000, 20000, 5000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1140: {
        heading: "Defend Your City",
        category: "Alarming",
        name: "Watch Tower",
        preferredorder: "89",
        prerequisite: "1149",
        description: "A higher level Watch Tower gives you more information on your attackers. Upgrade your Watch Tower now!",
        objective: ["1", "14", 10],
        reward: [
            [0, 1000, 10000, 20000, 5000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1151: {
        heading: "Build Your City",
        category: "Metals",
        name: "Blacksmith",
        preferredorder: "33",
        prerequisite: "1041",
        description: "In order to use more advanced metalworking techniques, you must build a Blacksmith. Build a Blacksmith to Research Metal Alloys, and to train Troops that require extensive armor.",
        objective: ["1", "15", 1],
        reward: [
            [0, 500, 1500, 2000, 1500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1161: {
        heading: "Defend Your City",
        category: "Defenses",
        name: "Workshop",
        preferredorder: "34",
        prerequisite: "1151",
        description: "In order to Upgrade your Walls, build a Workshop. The Workshop also allows you to build siege weapons such as Crossbows, Ballistae, and Catapults.",
        objective: ["1", "16", 1],
        reward: [
            [0, 1500, 5000, 5000, 5000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1171: {
        heading: "Build Your City",
        category: "Transportation",
        name: "Stable",
        preferredorder: "47",
        prerequisite: "1015",
        description: "Stables are necessary to house the horses used by Cavalry and Heavy Cavalry. Upgrade your Stables to research higher levels of Alloy Horseshoes.",
        objective: ["1", "17", 1],
        reward: [
            [0, 1500, 2000, 1000, 1000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1181: {
        heading: "Build Your City",
        category: "Transportation",
        name: "Relief Station",
        preferredorder: "56",
        prerequisite: "1171",
        description: "The Relief Station helps your Troops&#39; Speed when you are moving between your own and allied Cities. Upgrade for better Speed improvements.",
        objective: ["1", "18", 1],
        reward: [
            [0, 2000, 5000, 5000, 1000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1191: {
        heading: "Defend Your City",
        category: "Defenses",
        name: "Walls",
        preferredorder: "23",
        prerequisite: "1002",
        description: "Now is the time to erect your Walls!  They may not start out as much, but upgrading your Walls will provide your city with a better innate defense, and allow you to build better Defensive Units, such as Traps and Caltrops.",
        objective: ["1", "19", 1],
        reward: [
            [0, 3000, 2000, 10000, 2000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1192: {
        heading: "Defend Your City",
        category: "Defenses",
        name: "Walls Reinforcement",
        preferredorder: "33",
        prerequisite: "1191",
        description: "Upgrading your Walls will provide your city with a better innate defense, and allow you to build more and better Defensive Units.",
        objective: ["1", "19", 2],
        reward: [
            [0, 5000, 5000, 20000, 5000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1193: {
        heading: "Defend Your City",
        category: "Defenses",
        name: "Walls Reinforcement",
        preferredorder: "48",
        prerequisite: "1192",
        description: "Upgrading your Walls will provide your city with a better innate defense, and allow you to build more and better Defensive Units.",
        objective: ["1", "19", 3],
        reward: [
            [0, 10000, 10000, 50000, 10000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1194: {
        heading: "Defend Your City",
        category: "Defenses",
        name: "Walls Reinforcement",
        preferredorder: "60",
        prerequisite: "1193",
        description: "Upgrading your Walls will provide your city with a better innate defense, and allow you to build more and better Defensive Units.",
        objective: ["1", "19", 4],
        reward: [
            [0, 10000, 10000, 50000, 10000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1195: {
        heading: "Defend Your City",
        category: "Defenses",
        name: "Walls Reinforcement",
        preferredorder: "64",
        prerequisite: "1194",
        description: "Upgrading your Walls will provide your city with a better innate defense, and allow you to build more and better Defensive Units.",
        objective: ["1", "19", 5],
        reward: [
            [0, 10000, 10000, 50000, 10000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1196: {
        heading: "Defend Your City",
        category: "Defenses",
        name: "Walls Reinforcement",
        preferredorder: "66",
        prerequisite: "1195",
        description: "Upgrading your Walls will provide your city with a better innate defense, and allow you to build more and better Defensive Units.",
        objective: ["1", "19", 6],
        reward: [
            [0, 10000, 10000, 50000, 10000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1197: {
        heading: "Defend Your City",
        category: "Defenses",
        name: "Walls Reinforcement",
        preferredorder: "74",
        prerequisite: "1196",
        description: "Upgrading your Walls will provide your city with a better innate defense, and allow you to build more and better Defensive Units.",
        objective: ["1", "19", 7],
        reward: [
            [0, 10000, 10000, 50000, 10000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1198: {
        heading: "Defend Your City",
        category: "Defenses",
        name: "Walls Reinforcement",
        preferredorder: "78",
        prerequisite: "1197",
        description: "Upgrading your Walls will provide your city with a better innate defense, and allow you to build more and better Defensive Units.",
        objective: ["1", "19", 8],
        reward: [
            [0, 10000, 10000, 50000, 10000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1199: {
        heading: "Defend Your City",
        category: "Defenses",
        name: "Walls Reinforcement",
        preferredorder: "82",
        prerequisite: "1198",
        description: "Upgrading your Walls will provide your city with a better innate defense, and allow you to build more and better Defensive Units.",
        objective: ["1", "19", 9],
        reward: [
            [0, 10000, 10000, 50000, 10000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1190: {
        heading: "Defend Your City",
        category: "Defenses",
        name: "Walls Reinforcement",
        preferredorder: "87",
        prerequisite: "1199",
        description: "Upgrading your Walls will provide your city with a better innate defense, and allow you to build more and better Defensive Units.",
        objective: ["1", "19", 10],
        reward: [
            [0, 10000, 10000, 50000, 10000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1201: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Welcome Your Guardian",
        preferredorder: "",
        prerequisite: "1201",
        description: "Summon a powerful Guardian to help strengthen your resources and troops",
        objective: ["1", "50", 1],
        reward: [
            [0, 2000, 2000, 2000, 2000, 0],
            [],
            [2000, 1],
            [0, 0, 0]
        ]
    },
    q1202: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Strengthen Your Guardian",
        preferredorder: "",
        prerequisite: "1202",
        description: "A higher level Guardian can bestow more power to your resource production and troop strength",
        objective: ["1", "50", 2],
        reward: [
            [0, 4000, 4000, 4000, 4000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1203: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Strengthen Your Guardian",
        preferredorder: "",
        prerequisite: "1203",
        description: "A higher level Guardian can bestow more power to your resource production and troop strength",
        objective: ["1", "50", 3],
        reward: [
            [0, 8000, 8000, 2000, 8000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1204: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Strengthen Your Guardian",
        preferredorder: "",
        prerequisite: "1204",
        description: "A higher level Guardian can bestow more power to your resource production and troop strength",
        objective: ["1", "50", 4],
        reward: [
            [0, 14000, 14000, 14000, 14000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1205: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Strengthen Your Guardian",
        preferredorder: "",
        prerequisite: "1205",
        description: "A higher level Guardian can bestow more power to your resource production and troop strength",
        objective: ["1", "50", 5],
        reward: [
            [0, 26000, 26000, 26000, 26000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1206: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Strengthen Your Guardian",
        preferredorder: "",
        prerequisite: "1206",
        description: "A higher level Guardian can bestow more power to your resource production and troop strength",
        objective: ["1", "50", 6],
        reward: [
            [0, 50000, 50000, 50000, 50000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1207: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Strengthen Your Guardian",
        preferredorder: "",
        prerequisite: "1207",
        description: "A higher level Guardian can bestow more power to your resource production and troop strength",
        objective: ["1", "50", 7],
        reward: [
            [0, 95000, 95000, 95000, 95000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1208: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Strengthen Your Guardian",
        preferredorder: "",
        prerequisite: "1208",
        description: "A higher level Guardian can bestow more power to your resource production and troop strength",
        objective: ["1", "50", 8],
        reward: [
            [0, 180000, 180000, 180000, 180000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1209: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Strengthen Your Guardian",
        preferredorder: "",
        prerequisite: "1209",
        description: "A higher level Guardian can bestow more power to your resource production and troop strength",
        objective: ["1", "50", 9],
        reward: [
            [0, 340000, 340000, 340000, 340000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1210: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Strengthen Your Guardian",
        preferredorder: "",
        prerequisite: "1210",
        description: "A higher level Guardian can bestow more power to your resource production and troop strength",
        objective: ["1", "50", 10],
        reward: [
            [0, 648000, 648000, 648000, 648000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1212: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Welcome Your Guardian",
        preferredorder: "",
        prerequisite: "1212",
        description: "Summon more Guardians to help strengthen your resources and troops",
        objective: ["999", ""],
        reward: [
            [0, 5000, 5000, 5000, 5000, 0],
            [],
            [2000, 1],
            [0, 0, 0]
        ]
    },
    q1213: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Welcome Your Guardian",
        preferredorder: "",
        prerequisite: "1213",
        description: "Summon more Guardians to help strengthen your resources and troops",
        objective: ["999", ""],
        reward: [
            [0, 5000, 5000, 5000, 5000, 0],
            [],
            [2000, 1],
            [0, 0, 0]
        ]
    },
    q1214: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Welcome Your Guardian",
        preferredorder: "",
        prerequisite: "1214",
        description: "Summon more Guardians to help strengthen your resources and troops",
        objective: ["999", ""],
        reward: [
            [0, 5000, 5000, 5000, 5000, 0],
            [],
            [2000, 1],
            [0, 0, 0]
        ]
    },
    q1215: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Welcome Your Guardian",
        preferredorder: "",
        prerequisite: "1215",
        description: "Summon more Guardians to help strengthen your resources and troops",
        objective: ["999", ""],
        reward: [
            [0, 5000, 5000, 5000, 5000, 0],
            [],
            [2000, 1],
            [0, 0, 0]
        ]
    },
    q1216: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Welcome Your Guardian",
        preferredorder: "",
        prerequisite: "1216",
        description: "Summon more Guardians to help strengthen your resources and troops",
        objective: ["999", ""],
        reward: [
            [0, 5000, 5000, 5000, 5000, 0],
            [],
            [2000, 1],
            [0, 0, 0]
        ]
    },
    q1217: {
        heading: "Build Your City",
        category: "Guardian",
        name: "Welcome Your Guardian",
        preferredorder: "",
        prerequisite: "1217",
        description: "Summon more Guardians to help strengthen your resources and troops",
        objective: ["999", ""],
        reward: [
            [0, 5000, 5000, 5000, 5000, 0],
            [],
            [2000, 1],
            [0, 0, 0]
        ]
    },
    q1301: {
        heading: "Build Your City",
        category: "Crafting",
        name: "Fey Spire",
        preferredorder: "",
        prerequisite: "1005",
        description: "A Fey Spire is essential for improving your items, build a Fey Spire now to start crafting items.",
        objective: ["1", "20", 1],
        reward: [
            [0, 0, 0, 0, 0, 0, 500],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1302: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Aetherstone Gathering",
        preferredorder: "",
        prerequisite: "1005",
        description: "Aetherstones are the foundation for crafting, attack dark forests to acquire aetherstones.",
        objective: ["999", "5", 5000],
        reward: [
            [0, 0, 0, 0, 0, 0, 500],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1303: {
        heading: "Improve Your Inventory",
        category: "Crafting",
        name: "Craft a Bloodstone",
        preferredorder: "",
        prerequisite: "1005",
        description: "Crafting can transform ordinary items into extraordinary ones.",
        objective: ["999", "3007", 1],
        reward: [
            [0, 0, 0, 0, 0, 0, 500],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1502: {
        heading: "Expand Your Kingdom",
        category: "Second City",
        name: "Build Your Second City",
        preferredorder: "43",
        prerequisite: "7501",
        description: 'It is time to Build your Second City! Click the Plain you control in the Map View, then click the "Build City" button. Your Second City will use its own queue, so you may build in both cities at once!',
        objective: ["999", "", 2],
        reward: [
            [0, 50000, 0, 0, 0, 0],
            [],
            [],
            [0, 100, 0]
        ]
    },
    q1524: {
        heading: "Build Your City",
        category: "Resource Gathering",
        name: "Greater Logging",
        preferredorder: "11",
        prerequisite: "999002",
        description: "While one Sawmill is enough to get your City started, you&#39;ll need more as your City grows. Build three more Sawmills to ensure you have a plentiful supply of Wood. ",
        objective: ["15", "2", 4],
        reward: [
            [0, 2000, 3000, 4500, 4500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1553: {
        heading: "Build Your City",
        category: "Establish Your City",
        name: "Expand Your Cottages",
        preferredorder: "20",
        prerequisite: "1011",
        description: "Now that you have more jobs to be done, you need more workers! Build two more Cottages to increase your Population.",
        objective: ["15", "5", 3],
        reward: [
            [1000, 500, 2000, 500, 500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1632: {
        heading: "Raise Your Army",
        category: "Improve Training",
        name: "Expand Barracks",
        preferredorder: "44",
        prerequisite: "1131",
        description: "Additional Barracks increase the rate at which you Train your Troops, and increase your Training Queue size.",
        objective: ["15", "13", 2],
        reward: [
            [0, 1000, 1200, 1500, 1000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1633: {
        heading: "Building",
        category: "Improve Training",
        name: "Expand Barracks",
        preferredorder: "57",
        prerequisite: "1632",
        description: "Additional Barracks increase the rate at which you Train your Troops, and increase your Training Queue size.",
        objective: ["15", "13", 3],
        reward: [
            [0, 1000, 1200, 1500, 1000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q1634: {
        heading: "Building",
        category: "Improve Training",
        name: "Expand Barracks",
        preferredorder: "72",
        prerequisite: "1633",
        description: "Additional Barracks increase the rate at which you Train your Troops, and increase your Training Queue size.",
        objective: ["15", "13", 4],
        reward: [
            [0, 1000, 1200, 1500, 1000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2011: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Fertilizer",
        preferredorder: "",
        prerequisite: "1111",
        description: "Fertilizer will increase your Food Production. Order your alchemists to begin working with different mixtures!",
        objective: ["2", "1", 1],
        reward: [
            [2000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2021: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Logging",
        preferredorder: "",
        prerequisite: "1111",
        description: "Engage your Alchemists in discovering better Logging techniques and tools to increase your Wood Production.",
        objective: ["2", "2", 1],
        reward: [
            [2000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2031: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Stoneworking",
        preferredorder: "",
        prerequisite: "1111",
        description: "Stone can be softened with potions, or exploded with powders. Have your Alchemists get to work increasing your Stone Production!",
        objective: ["2", "3", 1],
        reward: [
            [3000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2041: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Smelting",
        preferredorder: "",
        prerequisite: "1111",
        description: "Improving your Ore Production requires many arcane chemicals. Start your Alchemists down the path to purer metals!",
        objective: ["2", "4", 1],
        reward: [
            [4000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2051: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Geometry",
        preferredorder: "",
        prerequisite: "1113",
        description: "Alchemists are not only early scientists, but mathematicians as well! A better understanding of Geometry will guide your Catapults and Ballistae to the enemy&#39;s most vulnerable point.",
        objective: ["2", "5", 1],
        reward: [
            [6000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2061: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Eagle Eyes",
        preferredorder: "",
        prerequisite: "1113",
        description: "It is well known that salves placed on the eyes can give Scouts the eyes of eagles. Have your alchemists start concocting these potions!",
        objective: ["2", "6", 1],
        reward: [
            [7000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2081: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Poisoned Edge",
        preferredorder: "",
        prerequisite: "1112",
        description: "Weapons are much more effective with the application of poison. Start the development of new poisons to destroy your enemies!",
        objective: ["2", "8", 1],
        reward: [
            [6000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2091: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Metal Alloys",
        preferredorder: "",
        prerequisite: "1113",
        description: "Each metal has its own strengths and weaknesses. When properly combined, the strengths can be multiplied and the weaknesses diminished. Start your alchemists researching better Alloys for armor materials!",
        objective: ["2", "9", 1],
        reward: [
            [7000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2101: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Featherweight Powder",
        preferredorder: "",
        prerequisite: "1114",
        description: "Lighter objects are easier to carry. Finding just the right combination of ingredients, your Alchemists can make items light as a feather.",
        objective: ["2", "10", 1],
        reward: [
            [6000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2111: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Magical Mapping",
        preferredorder: "",
        prerequisite: "1114",
        description: "A properly prepared piece of parchment wants to become an accurate map. Have your Alchemists learn the art of creating better maps to help your Troops move more quickly across the Map!",
        objective: ["2", "11", 1],
        reward: [
            [6000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2121: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Alloy Horseshoes",
        preferredorder: "",
        prerequisite: "1115",
        description: "A horse can break a leg by losing or breaking a shoe. Your Alchemists can develop new Alloy Horseshoes to keep your horses running faster, longer.",
        objective: ["2", "12", 1],
        reward: [
            [8000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2131: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Fletching",
        preferredorder: "",
        prerequisite: "1114",
        description: "Fletching is the art of tying feathers to arrows. While duck feathers work well, have your Alchemists experiment with more interesting feathers, like those from a griffin or phoenix!",
        objective: ["2", "13", 1],
        reward: [
            [6000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2141: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Shrinking Powder",
        preferredorder: "",
        prerequisite: "1116",
        description: "Is your Storehouse running out of room? Shrinking Powder will allow you to squeeze more resources into the same space. Start the research and protect your resources from attack.",
        objective: ["2", "14", 1],
        reward: [
            [4000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2151: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Healing Potions",
        preferredorder: "",
        prerequisite: "1116",
        description: "Healing Potions will help your Troops keep fighting through terrible injuries. Have your Alchemists begin brewing now!",
        objective: ["2", "15", 1],
        reward: [
            [7200, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q2161: {
        heading: "Research",
        category: "Alchemical Research",
        name: "Giant&#39;s Strength",
        preferredorder: "",
        prerequisite: "1115",
        description: "Engage your Alchemists is distilling the Strength of Giants into a potion for your workers.",
        objective: ["2", "16", 1],
        reward: [
            [10000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q3011: {
        heading: "Raise Your Army",
        category: "Train Your Troops",
        name: "Supply Troops",
        preferredorder: "",
        prerequisite: "1131",
        description: "Supply Troops are not very good at fighting, but can carry resources to other cities you and your friends own, or carry loot back when you plunder enemy cities. Click on the Barracks and train 10 Supply Troops.",
        objective: ["3", "1", 10],
        reward: [
            [0, 500, 1500, 0, 100, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q3012: {
        heading: "Expand Your Kingdom",
        category: "Second City",
        name: "Train 100 Supply Troops",
        preferredorder: "",
        prerequisite: "9999",
        description: "To begin building a Second City, you will need to take over a Plain on the Map. First, you must build an army! Start your army by training <b>100 Supply Troops</b> in your Barracks.",
        objective: ["3", "1", 100],
        reward: [
            [0, 0, 10000, 0, 0, 0],
            [
                [1, 100]
            ],
            [],
            [0, 0, 0]
        ]
    },
    q3013: {
        heading: "",
        category: "",
        name: "",
        preferredorder: "",
        prerequisite: "9999",
        description: "",
        objective: ["3", "1", 125],
        reward: [
            [0, 5000, 3000, 0, 0, 0],
            [
                [1, 125]
            ],
            [],
            [0, 0, 0]
        ]
    },
    q3021: {
        heading: "Raise Your Army",
        category: "Train Your Troops",
        name: "Militiamen",
        preferredorder: "",
        prerequisite: "1131",
        description: "Militiamen are citizens of your city who have some military training. They are a good beginning for your army, but no match for troops with true training. Click on the Barracks and train 10 Militiamen.",
        objective: ["3", "2", 10],
        reward: [
            [0, 800, 1000, 0, 500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q3022: {
        heading: "Expand Your Kingdom",
        category: "Second City",
        name: "Train 50 Militiamen",
        preferredorder: "38",
        prerequisite: "8002",
        description: "To begin building a Second City, you will need to take over a Plain on the Map. First, you must build an army! Train <b>50 Militiamen</b> to continue building your army to take over a Plain for your Second City!",
        objective: ["3", "2", 50],
        reward: [
            [0, 5000, 0, 0, 0, 0],
            [
                [2, 50]
            ],
            [],
            [0, 0, 0]
        ]
    },
    q3031: {
        heading: "Raise Your Army",
        category: "Train Your Troops",
        name: "Scouts",
        preferredorder: "",
        prerequisite: "1132",
        description: "Scouts move quickly, and bring back information about enemy positions and numbers, but are not strong fighters. Click on the Barracks and train 10 Scouts.",
        objective: ["3", "3", 10],
        reward: [
            [0, 1200, 2000, 0, 1500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q3032: {
        heading: "",
        category: "",
        name: "",
        preferredorder: "",
        prerequisite: "9999",
        description: "",
        objective: ["999", ""],
        reward: [
            [0, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q3041: {
        heading: "Raise Your Army",
        category: "Train Your Troops",
        name: "Pikemen",
        preferredorder: "",
        prerequisite: "1132",
        description: "Pikemen are the most basic heavily trained troops. Their long pikes are very effective against horses. Click on the Barracks and train 10 Pikemen. ",
        objective: ["3", "4", 10],
        reward: [
            [0, 1500, 5000, 0, 1000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q3042: {
        heading: "Expand Your Kingdom",
        category: "Second City",
        name: "Train 25 Pikemen",
        preferredorder: "",
        prerequisite: "9999",
        description: "Train <b>25 Pikemen</b> to continue building your army to take over a Plain for your Second City! Please notice in the Training window that you must research Poisoned Edge to level 1 in order to train Pikemen.",
        objective: ["3", "4", 25],
        reward: [
            [0, 0, 10000, 0, 0, 0],
            [
                [4, 25]
            ],
            [],
            [0, 0, 0]
        ]
    },
    q3051: {
        heading: "Raise Your Army",
        category: "Train Your Troops",
        name: "Swordsmen",
        preferredorder: "",
        prerequisite: "1133",
        description: "Swordsmen are well armored, and are the strongest melee troops. Their shields make them effective against Archers. Click on the Barracks and train 10 Swordsmen.",
        objective: ["3", "5", 10],
        reward: [
            [0, 2000, 1500, 0, 4000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q3061: {
        heading: "Raise Your Army",
        category: "Train Your Troops",
        name: "Archers",
        preferredorder: "",
        prerequisite: "1134",
        description: "Archers can destroy the enemy&#39;s troops from a distance, but are vulnerable up close. Click on the Barracks and train 10 Archers.",
        objective: ["3", "6", 10],
        reward: [
            [0, 3000, 3500, 3000, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q3071: {
        heading: "Raise Your Army",
        category: "Train Your Troops",
        name: "Cavalry",
        preferredorder: "",
        prerequisite: "1135",
        description: "Cavalry troops move very quickly on horseback, and have devastating attacks. Click on the Barracks and train 10 Cavalry.",
        objective: ["3", "7", 10],
        reward: [
            [0, 10000, 6000, 0, 5000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q3081: {
        heading: "Raise Your Army",
        category: "Train Your Troops",
        name: "Heavy Cavalry",
        preferredorder: "",
        prerequisite: "1137",
        description: "Heavy Cavalry are far more armored than regular Cavalry. This armor provides them defense and more power to their attacks, but costs them some speed. Click on the Barracks and train 10 Heavy Cavalry.",
        objective: ["3", "8", 10],
        reward: [
            [0, 20000, 5000, 0, 25000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q3091: {
        heading: "Raise Your Army",
        category: "Train Your Troops",
        name: "Supply Wagon",
        preferredorder: "",
        prerequisite: "1136",
        description: "Supply Wagons are heavily fortified to carry anything you need through a raging battle, and not lose the cargo. Click on the Barracks and train 10 Supply Wagons",
        objective: ["3", "9", 10],
        reward: [
            [0, 6000, 15000, 0, 3500, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q3101: {
        heading: "Raise Your Army",
        category: "Train Your Troops",
        name: "Ballistae",
        preferredorder: "",
        prerequisite: "1138",
        description: "Ballistae fire huge arrow-like bolts at long ranges. They are effective against other siege weapons. Click on the Barracks and train 10 Ballistae.",
        objective: ["3", "10", 10],
        reward: [
            [0, 25000, 30000, 0, 18000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q3111: {
        heading: "Raise Your Army",
        category: "Train Your Troops",
        name: "Battering Ram",
        preferredorder: "",
        prerequisite: "1139",
        description: "A Battering Ram is a large log-like object, used for knocking down the enemy&#39;s defenses. Click on the Barracks and train 10 Battering Rams.",
        objective: ["3", "11", 10],
        reward: [
            [0, 40000, 60000, 0, 16000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q3121: {
        heading: "Raise Your Army",
        category: "Train Your Troops",
        name: "Catapult",
        preferredorder: "",
        prerequisite: "1130",
        description: "Catapults throw large rocks from a huge distance. They are most effective against the enemy&#39;s defenses. Click on the Barracks and train 10 Catapults.",
        objective: ["3", "12", 10],
        reward: [
            [0, 50000, 50000, 80000, 12000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q5051: {
        heading: "Build Your City",
        category: "Population",
        name: "Population Growth",
        preferredorder: "",
        prerequisite: "1051",
        description: "As your city grows, so will your need for workers on your Resource fields and men to be Trained for battle. Your current Population is determined by your Population Limit and your Happiness. Build and upgrade your Cottages, build and upgrade your Tavern, or reduce your Tax Rate to increase your Population.\n",
        objective: ["5", "5", 150],
        reward: [
            [100, 100, 0, 0, 0, 0],
            [],
            [],
            [0, 10, 0]
        ]
    },
    q5052: {
        heading: "Build Your City",
        category: "Population",
        name: "Population Growth",
        preferredorder: "",
        prerequisite: "5051",
        description: "As your city grows, so will your need for workers on your Resource fields and men to be Trained for battle. Your current Population is determined by your Population Limit and your Happiness. Build and upgrade your Cottages, build and upgrade your Tavern, or reduce your Tax Rate to increase your Population.\n",
        objective: ["5", "5", 250],
        reward: [
            [200, 200, 0, 0, 0, 0],
            [],
            [],
            [0, 20, 0]
        ]
    },
    q5053: {
        heading: "Build Your City",
        category: "Population",
        name: "Population Growth",
        preferredorder: "",
        prerequisite: "5052",
        description: "As your city grows, so will your need for workers on your Resource fields and men to be Trained for battle. Your current Population is determined by your Population Limit and your Happiness. Build and upgrade your Cottages, build and upgrade your Tavern, or reduce your Tax Rate to increase your Population.\n",
        objective: ["5", "5", 500],
        reward: [
            [500, 500, 0, 0, 0, 0],
            [],
            [],
            [0, 20, 0]
        ]
    },
    q5054: {
        heading: "Build Your City",
        category: "Population",
        name: "Population Growth",
        preferredorder: "",
        prerequisite: "5053",
        description: "As your city grows, so will your need for workers on your Resource fields and men to be Trained for battle. Your current Population is determined by your Population Limit and your Happiness. Build and upgrade your Cottages, build and upgrade your Tavern, or reduce your Tax Rate to increase your Population.\n",
        objective: ["5", "5", 1000],
        reward: [
            [1000, 1000, 0, 0, 0, 0],
            [],
            [],
            [0, 100, 0]
        ]
    },
    q5055: {
        heading: "Build Your City",
        category: "Population",
        name: "Population Growth",
        preferredorder: "",
        prerequisite: "5054",
        description: "As your city grows, so will your need for workers on your Resource fields and men to be Trained for battle. Your current Population is determined by your Population Limit and your Happiness. Build and upgrade your Cottages, build and upgrade your Tavern, or reduce your Tax Rate to increase your Population.",
        objective: ["5", "5", 5000],
        reward: [
            [5000, 5000, 0, 0, 0, 0],
            [],
            [],
            [0, 500, 0]
        ]
    },
    q5056: {
        heading: "Build Your City",
        category: "Population",
        name: "Population Growth",
        preferredorder: "",
        prerequisite: "5055",
        description: "As your city grows, so will your need for workers on your Resource fields and men to be Trained for battle. Your current Population is determined by your Population Limit and your Happiness. Build and upgrade your Cottages, build and upgrade your Tavern, or reduce your Tax Rate to increase your Population.",
        objective: ["5", "5", 10000],
        reward: [
            [10000, 10000, 0, 0, 0, 0],
            [],
            [],
            [0, 1000, 0]
        ]
    },
    q5057: {
        heading: "Build Your City",
        category: "Population",
        name: "Population Growth",
        preferredorder: "",
        prerequisite: "5056",
        description: "As your city grows, so will your need for workers on your Resource fields and men to be Trained for battle. Your current Population is determined by your Population Limit and your Happiness. Build and upgrade your Cottages, build and upgrade your Tavern, or reduce your Tax Rate to increase your Population.\n",
        objective: ["5", "5", 40000],
        reward: [
            [50000, 50000, 0, 0, 0, 0],
            [],
            [],
            [0, 5000, 0]
        ]
    },
    q6001: {
        heading: "Administration",
        category: "Resource Management",
        name: "Tax Revenue",
        preferredorder: "",
        prerequisite: "999010",
        description: "Your Tax Revenue depends on your Tax Rate and your Population. Increase your Population to grow your tax base.",
        objective: ["6", "0", 500],
        reward: [
            [1000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6002: {
        heading: "Administration",
        category: "Resource Management",
        name: "Tax Revenue",
        preferredorder: "",
        prerequisite: "6001",
        description: "Your Tax Revenue depends on your Tax Rate and your Population. Increase your Population to grow your tax base.",
        objective: ["6", "0", 1000],
        reward: [
            [5000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6003: {
        heading: "Administration",
        category: "Resource Management",
        name: "Tax Revenue",
        preferredorder: "",
        prerequisite: "6002",
        description: "Your Tax Revenue depends on your Tax Rate and your Population. Increase your Population to grow your tax base.",
        objective: ["6", "0", 5000],
        reward: [
            [0, 10000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6004: {
        heading: "Administration",
        category: "Resource Management",
        name: "Tax Revenue",
        preferredorder: "",
        prerequisite: "6003",
        description: "Your Tax Revenue depends on your Tax Rate and your Population. Increase your Population to grow your tax base.",
        objective: ["6", "0", 10000],
        reward: [
            [0, 25000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6005: {
        heading: "Administration",
        category: "Resource Management",
        name: "Tax Revenue",
        preferredorder: "",
        prerequisite: "6004",
        description: "Your Tax Revenue depends on your Tax Rate and your Population. Increase your Population to grow your tax base.",
        objective: ["6", "0", 40000],
        reward: [
            [0, 100000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6011: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Food Production",
        preferredorder: "",
        prerequisite: "1011",
        description: "Increase your base production of Food to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Farms to increase your base production.",
        objective: ["6", "1", 1000],
        reward: [
            [0, 1000, 0, 0, 0, 0],
            [],
            [
                [111, 1]
            ],
            [0, 0, 0]
        ]
    },
    q6012: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Food Production",
        preferredorder: "",
        prerequisite: "6011",
        description: "Increase your base production of Food to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Farms to increase your base production.",
        objective: ["6", "1", 5000],
        reward: [
            [0, 5000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6013: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Food Production",
        preferredorder: "",
        prerequisite: "6012",
        description: "Increase your base production of Food to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Farms to increase your base production.",
        objective: ["6", "1", 10000],
        reward: [
            [0, 10000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6014: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Food Production",
        preferredorder: "",
        prerequisite: "6013",
        description: "Increase your base production of Food to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Farms to increase your base production.",
        objective: ["6", "1", 50000],
        reward: [
            [0, 50000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6021: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Wood Production",
        preferredorder: "",
        prerequisite: "1021",
        description: "Increase your base production of Wood to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Sawmills to increase your base production.",
        objective: ["6", "2", 1000],
        reward: [
            [0, 0, 1000, 0, 0, 0],
            [],
            [
                [121, 1]
            ],
            [0, 0, 0]
        ]
    },
    q6022: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Wood Production",
        preferredorder: "",
        prerequisite: "6021",
        description: "Increase your base production of Wood to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Sawmills to increase your base production.",
        objective: ["6", "2", 5000],
        reward: [
            [0, 0, 5000, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6023: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Wood Production",
        preferredorder: "",
        prerequisite: "6022",
        description: "Increase your base production of Wood to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Sawmills to increase your base production.",
        objective: ["6", "2", 10000],
        reward: [
            [0, 0, 10000, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6024: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Wood Production",
        preferredorder: "",
        prerequisite: "6023",
        description: "Increase your base production of Wood to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Sawmills to increase your base production.",
        objective: ["6", "2", 50000],
        reward: [
            [0, 0, 50000, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6031: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Stone Production",
        preferredorder: "",
        prerequisite: "1031",
        description: "Increase your base production of Stone to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Quarries to increase your base production.",
        objective: ["6", "3", 1000],
        reward: [
            [0, 0, 0, 1000, 0, 0],
            [],
            [
                [131, 1]
            ],
            [0, 0, 0]
        ]
    },
    q6032: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Stone Production",
        preferredorder: "",
        prerequisite: "6031",
        description: "Increase your base production of Stone to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Quarries to increase your base production.",
        objective: ["6", "3", 5000],
        reward: [
            [0, 0, 0, 5000, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6033: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Stone Production",
        preferredorder: "",
        prerequisite: "6032",
        description: "Increase your base production of Stone to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Quarries to increase your base production.",
        objective: ["6", "3", 10000],
        reward: [
            [0, 0, 0, 10000, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6034: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Stone Production",
        preferredorder: "",
        prerequisite: "6033",
        description: "Increase your base production of Stone to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Quarries to increase your base production.",
        objective: ["6", "3", 50000],
        reward: [
            [0, 0, 0, 50000, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6041: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Ore Production",
        preferredorder: "",
        prerequisite: "1041",
        description: "Increase your base production of Ore to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Mines to increase your base production.",
        objective: ["6", "4", 1000],
        reward: [
            [0, 0, 0, 0, 1000, 0],
            [],
            [
                [141, 1]
            ],
            [0, 0, 0]
        ]
    },
    q6042: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Ore Production",
        preferredorder: "",
        prerequisite: "6041",
        description: "Increase your base production of Ore to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Mines to increase your base production.",
        objective: ["6", "4", 5000],
        reward: [
            [0, 0, 0, 0, 5000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6043: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Ore Production",
        preferredorder: "",
        prerequisite: "6042",
        description: "Increase your base production of Ore to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Mines to increase your base production.",
        objective: ["6", "4", 10000],
        reward: [
            [0, 0, 0, 0, 10000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6044: {
        heading: "Grow Your Resources",
        category: "Resource Management",
        name: "Ore Production",
        preferredorder: "",
        prerequisite: "6043",
        description: "Increase your base production of Ore to allow you to Train and feed troops and to construct more buildings. Build and Upgrade your Mines to increase your base production.",
        objective: ["6", "4", 50000],
        reward: [
            [0, 0, 0, 0, 50000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6051: {
        heading: "Build Your City",
        category: "Establish Your City",
        name: "Population Limit",
        preferredorder: "",
        prerequisite: "1051",
        description: "Your Population is used to work your Resource fields and become your troops. Build and Upgrade your Cottages to increase your Population Limit.",
        objective: ["6", "5", 1000],
        reward: [
            [1000, 100, 4000, 1000, 1000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6052: {
        heading: "Build Your City",
        category: "Establish Your City",
        name: "Population Limit",
        preferredorder: "",
        prerequisite: "6051",
        description: "Your Population is used to work your Resource fields and become your troops. Build and Upgrade your Cottages to increase your Population Limit.",
        objective: ["6", "5", 5000],
        reward: [
            [2500, 3000, 7000, 3000, 3000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6053: {
        heading: "Build Your City",
        category: "Establish Your City",
        name: "Population Limit",
        preferredorder: "",
        prerequisite: "6052",
        description: "Your Population is used to work your Resource fields and become your troops. Build and Upgrade your Cottages to increase your Population Limit.",
        objective: ["6", "5", 10000],
        reward: [
            [5000, 5000, 10000, 5000, 5000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q6054: {
        heading: "Build Your City",
        category: "Establish Your City",
        name: "Population Limit",
        preferredorder: "",
        prerequisite: "6053",
        description: "Your Population is used to work your Resource fields and become your troops. Build and Upgrade your Cottages to increase your Population Limit.",
        objective: ["6", "5", 40000],
        reward: [
            [10000, 10000, 20000, 10000, 10000, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q7001: {
        heading: "Combat",
        category: "Expand Your City",
        name: "Conquer a Level 1 Wilderness",
        preferredorder: "",
        prerequisite: "3031",
        description: "Now that you&#39;ve scouted a Wilderness, you now know what you&#39;re up against. Send in enough Troops to take it over, and you&#39;ll gain a bonus to your Resource Production.",
        objective: ["7", "-1", 1],
        reward: [
            [0, 1000, 0, 0, 0, 0],
            [],
            [
                [261, 1]
            ],
            [0, 0, 0]
        ]
    },
    q7002: {
        heading: "Combat",
        category: "Expand Your City",
        name: "Conquer a Level 2 Wilderness",
        preferredorder: "",
        prerequisite: "7001",
        description: "Higher level Wildernesses give greater bonuses to Production, but are protected by more Troops.",
        objective: ["7", "-1", 2],
        reward: [
            [0, 2000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q7003: {
        heading: "Combat",
        category: "Expand Your City",
        name: "Conquer a Level 3 Wilderness",
        preferredorder: "",
        prerequisite: "7001",
        description: "Higher level Wildernesses give greater bonuses to Production, but are protected by more Troops.",
        objective: ["7", "-1", 3],
        reward: [
            [0, 3000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q7004: {
        heading: "Combat",
        category: "Expand Your City",
        name: "Conquer a Level 4 Wilderness",
        preferredorder: "",
        prerequisite: "7001",
        description: "Higher level Wildernesses give greater bonuses to Production, but are protected by more Troops.",
        objective: ["7", "-1", 4],
        reward: [
            [0, 4000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q7005: {
        heading: "Combat",
        category: "Expand Your City",
        name: "Conquer a Level 5 Wilderness",
        preferredorder: "",
        prerequisite: "7001",
        description: "Higher level Wildernesses give greater bonuses to Production, but are protected by more Troops.",
        objective: ["7", "-1", 5],
        reward: [
            [0, 5000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q7006: {
        heading: "Combat",
        category: "Expand Your City",
        name: "Conquer a Level 6 Wilderness",
        preferredorder: "",
        prerequisite: "7001",
        description: "Higher level Wildernesses give greater bonuses to Production, but are protected by more Troops.",
        objective: ["7", "-1", 6],
        reward: [
            [0, 10000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q7007: {
        heading: "Combat",
        category: "Expand Your City",
        name: "Conquer a Level 7 Wilderness",
        preferredorder: "",
        prerequisite: "7001",
        description: "Higher level Wildernesses give greater bonuses to Production, but are protected by more Troops.",
        objective: ["7", "-1", 7],
        reward: [
            [0, 20000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q7008: {
        heading: "Combat",
        category: "Expand Your City",
        name: "Conquer a Level 8 Wilderness",
        preferredorder: "",
        prerequisite: "7001",
        description: "Higher level Wildernesses give greater bonuses to Production, but are protected by more Troops.",
        objective: ["7", "-1", 8],
        reward: [
            [0, 50000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q7009: {
        heading: "Combat",
        category: "Expand Your City",
        name: "Conquer a Level 9 Wilderness",
        preferredorder: "",
        prerequisite: "7001",
        description: "Higher level Wildernesses give greater bonuses to Production, but are protected by more Troops.",
        objective: ["7", "-1", 9],
        reward: [
            [0, 100000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q7000: {
        heading: "Combat",
        category: "Expand Your City",
        name: "Conquer a Level 10 Wilderness",
        preferredorder: "",
        prerequisite: "7001",
        description: "Higher level Wildernesses give greater bonuses to Production, but are protected by more Troops.",
        objective: ["7", "-1", 10],
        reward: [
            [0, 200000, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q7501: {
        heading: "Combat",
        category: "Expand Your City",
        name: "Conquer a Plain",
        preferredorder: "40",
        prerequisite: "3022",
        description: "Your Second City can only be built on a Plain. Use all of the Troops you trained to <b>conquer an unowned level 1 or 2 Plain</b> and continue your path to your Second City! To see if a Plain is unowned, click on it in the Map View, and see if another Lord or Lady has already laid claim.",
        objective: ["7", "50", 1],
        reward: [
            [5000, 5000, 5000, 5000, 5000, 0],
            [],
            [],
            [0, 100, 0]
        ]
    },
    q7652: {
        heading: "",
        category: "",
        name: "",
        preferredorder: "",
        prerequisite: "9999",
        description: "",
        objective: ["999", ""],
        reward: [
            [0, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q7901: {
        heading: "",
        category: "",
        name: "",
        preferredorder: "",
        prerequisite: "9999",
        description: "",
        objective: ["999", ""],
        reward: [
            [10000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q8002: {
        heading: "Expand Your Kingdom",
        category: "Second City",
        name: "Earn Your Second City Deed",
        preferredorder: "37",
        prerequisite: "11007",
        description: "Arthur wants to give you a Second City Deed, which will allow you to build a Second City! In order to earn the Deed, you will need <b>ten friends</b> playing Kingdoms of Camelot. Invite your friends now to double your building efforts! You may also purchase a Second City Deed in the Court section of the Shop.",
        objective: ["999", "", 10],
        reward: [
            [1000, 1000, 1000, 1000, 1000, 0],
            [],
            [
                [1202, 1]
            ],
            [0, 0, 0]
        ]
    },
    q8003: {
        heading: "Expand Your Kingdom",
        category: "Third City",
        name: "Earn Your Third City Deed",
        preferredorder: "",
        prerequisite: "8002",
        description: "Arthur wants to give you a <b>Third City Deed</b>, which will allow you to build a <b>Third City</b>! In order to earn the Deed, you will need to gain <b>4 Sir Bor&#39;s Crests, 2 Sir Ector&#39;s Crests, and 1 Sir Kay&#39;s Crest</b>. Find these Crests by attacking unowned Wildernesses level 5 and higher, or by opening a <b>Squire&#39;s Chest</b>, found in the <b>Chest</b> section of the <b>Shop</b>. These Crests will be consumed when you complete this Quest. You may also buy this Deed in the Court section of the Shop.",
        objective: ["999", ""],
        reward: [
            [0, 0, 0, 0, 0, 0],
            [],
            [
                [1203, 1]
            ],
            [0, 0, 0]
        ]
    },
    q8004: {
        heading: "Expand Your Kingdom",
        category: "Fourth City",
        name: "Earn Your Fourth City Deed",
        preferredorder: "",
        prerequisite: "8003",
        description: "Arthur wants to give you a <b>Fourth City Deed</b>, which will allow you to build a <b>Fourth City</b>! In order to earn the Deed, you will need to gain <b>4 Sir Kay&#39;s Crests, 3 Sir Bedivere&#39;s Crests, and 1 Sir Gawain&#39;s Crest</b>. Find these Crests by attacking unowned Wildernesses level 6 and higher, or by opening a <b>Knight&#39;s Chest</b>, found in the <b>Chest</b> section of the <b>Shop</b>. These Crests will be consumed when you complete this Quest. You may also buy this Deed in the Court section of the Shop.",
        objective: ["999", ""],
        reward: [
            [0, 0, 0, 0, 0, 0],
            [],
            [
                [1204, 1]
            ],
            [0, 0, 0]
        ]
    },
    q8005: {
        heading: "Expand Your Kingdom",
        category: "Fifth City",
        name: "Earn Your Fifth City Deed",
        preferredorder: "",
        prerequisite: "8004",
        description: "Arthur wants to give you a <b>Fifth City Deed</b>, which will allow you to build a <b>Fifth City</b>! In order to earn the Deed, you will need to gain <b>4 Sir Percival&#39;s Crests, 3 Sir Galahad&#39;s Crests, and 2 Sir Lancelot&#39;s Crests</b>. Find these Crests by attacking unowned Wildernesses level 8 and higher, or by opening <b>Knight&#39;s Chests</b> or <b>Lord&#39;s Chests</b>, found in the <b>Chest</b> section of the <b>Shop</b>. These Crests will be consumed when you complete this Quest.",
        objective: ["999", ""],
        reward: [
            [0, 0, 0, 0, 0, 0],
            [],
            [
                [1205, 1],
                [401, 1]
            ],
            [0, 0, 0]
        ]
    },
    q8006: {
        heading: "Expand Your Kingdom",
        category: "Sixth City",
        name: "Earn Your Sixth City Deed",
        preferredorder: "",
        prerequisite: "8005",
        description: "The mysterious Fey have returned to Camelot... and with them, their ancient cities. You must prove to King Arthur that you are worthy of controlling such a powerful city. You will need to acquire <b>3 Morgana&#39;s Seals, 2 Mordred&#39;s Seals and 4 King Arthur&#39;s Crests</b> by conquering unowned Wildernesses of level 8 and higher. Then you can complete this quest to earn a <b>Sixth City Deed</b> and build a Fey City. You can also buy a Sixth City Deed directly from the <b>Court</b> section of the <b>Shop</b> or buy <b>Fey&#39;s Chests</b> and <b>Lord&#39;s Chests</b> from the Shop that contain Seals and Crests.",
        objective: ["999", ""],
        reward: [
            [0, 0, 0, 0, 0, 0],
            [],
            [
                [1206, 1],
                [401, 1]
            ],
            [0, 0, 0]
        ]
    },
    q8007: {
        heading: "Expand Your Kingdom",
        category: "Seventh City",
        name: "Earn Your Seventh City Deed",
        preferredorder: "",
        prerequisite: "8006",
        description: "The Fey have brought the wrath of Nature to Camelot, which has enchanted ancient cities. You must prove to King Arthur that you are worthy of controlling such a powerful city. You will need to acquire <b>4 Stag King&#39;s Seals, 3 Pendragon Seals and 2 Lady of the Lake&#39;s Seals</b> by conquering unowned Wildernesses of level 8 and higher. Then you can complete this quest to earn a <b>Seventh City Deed</b> and build a magical City. You can also buy a <b>Seventh City Deed</b> directly from the Court section of the Shop or buy <b>Avalon&#39;s Chests</b> and <b>Fey&#39;s Chests</b> from the Shop to obtain additional Seals. ",
        objective: ["999", ""],
        reward: [
            [0, 0, 0, 0, 0, 0],
            [],
            [
                [1207, 1],
                [401, 1]
            ],
            [0, 0, 0]
        ]
    },
    q8008: {
        heading: "Expand Your Kingdom",
        category: "Fey City",
        name: "Earn Your Fey Deed",
        preferredorder: "",
        prerequisite: "8007",
        description: "Morgana has summoned Dark Forests to Camelot, which have corrupted mighty cities. You must prove to King Arthur that you are worthy of reclaiming a city from such a powerful force. You will need to acquire 4 Merlin&#39;s Seals, 3 Aetherseals, and 2 Ysbadden Seals by conquering Dark Forests. Then you can complete this quest to earn a Fey City Deed. You can also buy an Fey City Deed directly from the Court section of the Shop.",
        objective: ["999", ""],
        reward: [
            [0, 0, 0, 0, 0, 0],
            [],
            [
                [1211, 1],
                [403, 1]
            ],
            [0, 0, 0]
        ]
    },
    q8009: {
        heading: "",
        category: "",
        name: "",
        preferredorder: "",
        prerequisite: "9999",
        description: "",
        objective: ["999", ""],
        reward: [
            [0, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q8010: {
        heading: "",
        category: "",
        name: "",
        preferredorder: "",
        prerequisite: "9999",
        description: "",
        objective: ["999", ""],
        reward: [
            [0, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q11002: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 2 (Lord)",
        preferredorder: "3",
        prerequisite: "1021",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 65],
        reward: [
            [1000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 2]
        ]
    },
    q11003: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 3 (Lord)",
        preferredorder: "",
        prerequisite: "11002",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 100],
        reward: [
            [1000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 3]
        ]
    },
    q11004: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 4 (Esquire)",
        preferredorder: "",
        prerequisite: "11003",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 150],
        reward: [
            [1000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 4]
        ]
    },
    q11005: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 5 (Esquire)",
        preferredorder: "",
        prerequisite: "11004",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 300],
        reward: [
            [1000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 5]
        ]
    },
    q11006: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 6 (Esquire)",
        preferredorder: "",
        prerequisite: "11005",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 500],
        reward: [
            [5000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 6]
        ]
    },
    q11007: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 7 (Baronet)",
        preferredorder: "",
        prerequisite: "11006",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 800],
        reward: [
            [5000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 7]
        ]
    },
    q11008: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 8 (Baronet)",
        preferredorder: "",
        prerequisite: "11007",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 1100],
        reward: [
            [5000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 8]
        ]
    },
    q11009: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 9 (Baronet)",
        preferredorder: "",
        prerequisite: "11008",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 1450],
        reward: [
            [10000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 9]
        ]
    },
    q11010: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 10 (Baron)",
        preferredorder: "",
        prerequisite: "11009",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 1800],
        reward: [
            [10000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 10]
        ]
    },
    q11011: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 11 (Baron)",
        preferredorder: "",
        prerequisite: "11010",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 2200],
        reward: [
            [10000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 11]
        ]
    },
    q11012: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 12 (Baron)",
        preferredorder: "",
        prerequisite: "11011",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 2600],
        reward: [
            [20000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 12]
        ]
    },
    q11013: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 13 (Viscount)",
        preferredorder: "",
        prerequisite: "11012",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly display your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 3050],
        reward: [
            [20000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 13]
        ]
    },
    q11014: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 14 (Viscount)",
        preferredorder: "",
        prerequisite: "11013",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 3500],
        reward: [
            [20000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 14]
        ]
    },
    q11015: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 15 (Viscount)",
        preferredorder: "",
        prerequisite: "11014",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 4000],
        reward: [
            [30000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 15]
        ]
    },
    q11016: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 16 (Count)",
        preferredorder: "",
        prerequisite: "11015",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 4500],
        reward: [
            [30000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 16]
        ]
    },
    q11017: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 17 (Count)",
        preferredorder: "",
        prerequisite: "11016",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 5100],
        reward: [
            [30000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 17]
        ]
    },
    q11018: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 18 (Count)",
        preferredorder: "",
        prerequisite: "11017",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 5850],
        reward: [
            [40000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 18]
        ]
    },
    q11019: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 19 (Vice Earl)",
        preferredorder: "",
        prerequisite: "11018",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 7000],
        reward: [
            [40000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 19]
        ]
    },
    q11020: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 20 (Vice Earl)",
        preferredorder: "",
        prerequisite: "11019",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 8250],
        reward: [
            [40000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 20]
        ]
    },
    q11021: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 21 (Vice Earl)",
        preferredorder: "",
        prerequisite: "11020",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 9500],
        reward: [
            [50000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 21]
        ]
    },
    q11022: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 22 (Earl)",
        preferredorder: "",
        prerequisite: "11021",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 11000],
        reward: [
            [50000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 22]
        ]
    },
    q11023: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 23 (Earl)",
        preferredorder: "",
        prerequisite: "11022",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 12900],
        reward: [
            [50000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 23]
        ]
    },
    q11024: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 24 (Earl)",
        preferredorder: "",
        prerequisite: "11023",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 14800],
        reward: [
            [60000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 24]
        ]
    },
    q11025: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 25 (Marquis)",
        preferredorder: "",
        prerequisite: "11024",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 16750],
        reward: [
            [60000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 25]
        ]
    },
    q11026: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 26 (Marquis)",
        preferredorder: "",
        prerequisite: "11025",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 19500],
        reward: [
            [60000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 26]
        ]
    },
    q11027: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 27 (Marquis)",
        preferredorder: "",
        prerequisite: "11026",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 22250],
        reward: [
            [70000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 27]
        ]
    },
    q11028: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 28 (Grand Marquis)",
        preferredorder: "",
        prerequisite: "11027",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 25000],
        reward: [
            [70000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 28]
        ]
    },
    q11029: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 29 (Grand Marquis)",
        preferredorder: "",
        prerequisite: "11028",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 29000],
        reward: [
            [70000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 29]
        ]
    },
    q11030: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 30 (Grand Marquis)",
        preferredorder: "",
        prerequisite: "11029",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 33000],
        reward: [
            [80000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 30]
        ]
    },
    q11031: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 31 (Duke)",
        preferredorder: "",
        prerequisite: "11030",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 37000],
        reward: [
            [80000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 31]
        ]
    },
    q11032: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 32 (Duke)",
        preferredorder: "",
        prerequisite: "11031",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 43000],
        reward: [
            [80000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 32]
        ]
    },
    q11033: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 33 (Duke)",
        preferredorder: "",
        prerequisite: "11032",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 49000],
        reward: [
            [90000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 33]
        ]
    },
    q11034: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 34 (Grand Duke)",
        preferredorder: "",
        prerequisite: "11033",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 55000],
        reward: [
            [90000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 34]
        ]
    },
    q11035: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 35 (Grand Duke)",
        preferredorder: "",
        prerequisite: "11034",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 63000],
        reward: [
            [90000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 35]
        ]
    },
    q11036: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 36 (Grand Duke)",
        preferredorder: "",
        prerequisite: "11035",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 71000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 36]
        ]
    },
    q11037: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 37 (Archduke)",
        preferredorder: "",
        prerequisite: "11036",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 81000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 37]
        ]
    },
    q11038: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 38 (Archduke)",
        preferredorder: "",
        prerequisite: "11037",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 93000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 38]
        ]
    },
    q11039: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 39 (Archduke)",
        preferredorder: "",
        prerequisite: "11038",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 105000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 39]
        ]
    },
    q11040: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 40 (Grand Knight)",
        preferredorder: "",
        prerequisite: "11039",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 118000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 40]
        ]
    },
    q11041: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 41 (Grand Knight)",
        preferredorder: "",
        prerequisite: "11040",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 135000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 41]
        ]
    },
    q11042: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 42 (Grand Knight)",
        preferredorder: "",
        prerequisite: "11041",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 152000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 42]
        ]
    },
    q11043: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 43 (Knight of Camelot)",
        preferredorder: "",
        prerequisite: "11042",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 170000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 43]
        ]
    },
    q11044: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 44 (Knight of Camelot)",
        preferredorder: "",
        prerequisite: "11043",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 196000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 44]
        ]
    },
    q11045: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 45 (Knight of Camelot)",
        preferredorder: "",
        prerequisite: "11044",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 222000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 45]
        ]
    },
    q11046: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 46 (Knight of the Round)",
        preferredorder: "",
        prerequisite: "11045",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 250000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 46]
        ]
    },
    q11047: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 47 (Knight of the Round)",
        preferredorder: "",
        prerequisite: "11046",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 261000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 47]
        ]
    },
    q11048: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 48 (Knight of the Round)",
        preferredorder: "",
        prerequisite: "11047",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 310000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 48]
        ]
    },
    q11049: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 49 (Grail Knight)",
        preferredorder: "",
        prerequisite: "11048",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 375000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 49]
        ]
    },
    q11050: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 50 (Grail Knight)",
        preferredorder: "",
        prerequisite: "11049",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 441000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 50]
        ]
    },
    q11051: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 51 (Grail Knight)",
        preferredorder: "",
        prerequisite: "11050",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 507000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 51]
        ]
    },
    q11052: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 52 (Head Knight)",
        preferredorder: "",
        prerequisite: "11051",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 575000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 52]
        ]
    },
    q11053: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 53 (Head Knight)",
        preferredorder: "",
        prerequisite: "11052",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 665000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 53]
        ]
    },
    q11054: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 54 (Head Knight)",
        preferredorder: "",
        prerequisite: "11053",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 755000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 54]
        ]
    },
    q11055: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 55 (Prince)",
        preferredorder: "",
        prerequisite: "11054",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 850000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 55]
        ]
    },
    q11056: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 56 (Prince)",
        preferredorder: "",
        prerequisite: "11055",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 983000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 56]
        ]
    },
    q11057: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 57 (Prince)",
        preferredorder: "",
        prerequisite: "11056",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 1116000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 57]
        ]
    },
    q11058: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 58 (High Prince)",
        preferredorder: "",
        prerequisite: "11057",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 1250000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 58]
        ]
    },
    q11059: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 59 (High Prince)",
        preferredorder: "",
        prerequisite: "11058",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 1400000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 59]
        ]
    },
    q11060: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 60 (High Prince)",
        preferredorder: "",
        prerequisite: "11059",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 2000000],
        reward: [
            [100000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 60]
        ]
    },
    q11061: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 61 (Grand Prince)",
        preferredorder: "",
        prerequisite: "11060",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 2140000],
        reward: [
            [200000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 61]
        ]
    },
    q11062: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 62 (Grand Prince)",
        preferredorder: "",
        prerequisite: "11061",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 2280000],
        reward: [
            [200000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 62]
        ]
    },
    q11063: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 63 (Grand Prince)",
        preferredorder: "",
        prerequisite: "11062",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 2420000],
        reward: [
            [200000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 63]
        ]
    },
    q11064: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 64 (Ayer Prince)",
        preferredorder: "",
        prerequisite: "11063",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 2560000],
        reward: [
            [200000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 64]
        ]
    },
    q11065: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 65 (Ayer Prince)",
        preferredorder: "",
        prerequisite: "11064",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 2700000],
        reward: [
            [200000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 65]
        ]
    },
    q11066: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 66 (Ayer Prince)",
        preferredorder: "",
        prerequisite: "11065",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 2860000],
        reward: [
            [200000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 66]
        ]
    },
    q11067: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 67 (Protector)",
        preferredorder: "",
        prerequisite: "11066",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 3020000],
        reward: [
            [200000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 67]
        ]
    },
    q11068: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 68 (Protector)",
        preferredorder: "",
        prerequisite: "11067",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 3180000],
        reward: [
            [200000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 68]
        ]
    },
    q11069: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 69 (Protector)",
        preferredorder: "",
        prerequisite: "11068",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 3340000],
        reward: [
            [200000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 69]
        ]
    },
    q11070: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 70 (High Protector)",
        preferredorder: "",
        prerequisite: "11069",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 3500000],
        reward: [
            [200000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 70]
        ]
    },
    q11071: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 71 (High Protector)",
        preferredorder: "",
        prerequisite: "11070",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 3660000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 71]
        ]
    },
    q11072: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 72 (High Protector)",
        preferredorder: "",
        prerequisite: "11071",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 3820000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 72]
        ]
    },
    q11073: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 73 (Grand Protector)",
        preferredorder: "",
        prerequisite: "11072",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 3980000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 73]
        ]
    },
    q11074: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 74 (Grand Protector)",
        preferredorder: "",
        prerequisite: "11073",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 4140000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 74]
        ]
    },
    q11075: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 75 (Grand Protector)",
        preferredorder: "",
        prerequisite: "11074",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 4300000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 75]
        ]
    },
    q11076: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 76 (Vice Regent)",
        preferredorder: "",
        prerequisite: "11075",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 4460000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 76]
        ]
    },
    q11077: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 77 (Vice Regent)",
        preferredorder: "",
        prerequisite: "11076",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 4620000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 77]
        ]
    },
    q11078: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 78 (Vice Regent)",
        preferredorder: "",
        prerequisite: "11077",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 4780000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 78]
        ]
    },
    q11079: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 79 (Regent)",
        preferredorder: "",
        prerequisite: "11078",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 4940000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 79]
        ]
    },
    q11080: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 80 (Regent)",
        preferredorder: "",
        prerequisite: "11079",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 5100000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 80]
        ]
    },
    q11081: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 81 (Regent)",
        preferredorder: "",
        prerequisite: "11080",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 5240000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 81]
        ]
    },
    q11082: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 82 (High Regent)",
        preferredorder: "",
        prerequisite: "11081",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 5380000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 82]
        ]
    },
    q11083: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 83 (High Regent)",
        preferredorder: "",
        prerequisite: "11082",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 5520000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 83]
        ]
    },
    q11084: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 84 (High Regent)",
        preferredorder: "",
        prerequisite: "11083",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 5660000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 84]
        ]
    },
    q11085: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 85 (Monarch-Errant)",
        preferredorder: "",
        prerequisite: "11084",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 5800000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 85]
        ]
    },
    q11086: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 86 (Monarch-Errant)",
        preferredorder: "",
        prerequisite: "11085",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 5940000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 86]
        ]
    },
    q11087: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 87 (Monarch-Errant)",
        preferredorder: "",
        prerequisite: "11086",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 6080000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 87]
        ]
    },
    q11088: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 88 (Monarch)",
        preferredorder: "",
        prerequisite: "11087",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 6220000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 88]
        ]
    },
    q11089: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 89 (Monarch)",
        preferredorder: "",
        prerequisite: "11088",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 6360000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 89]
        ]
    },
    q11090: {
        heading: "Improve Your Title",
        category: "Improve Title",
        name: "Become Level 90 (Monarch)",
        preferredorder: "",
        prerequisite: "11089",
        description: "As your Might increases, King Arthur will reward you with a new Title that properly displays your prowess. You will not lose this Title if your Might decreases.",
        objective: ["999", "", 6500000],
        reward: [
            [400000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 90]
        ]
    },
    q12001: {
        heading: "Build Your City",
        category: "Building Speedups",
        name: "Speedy Progress",
        preferredorder: "7",
        prerequisite: "1031",
        description: "Time and tide wait for no man. Fortunately, you can speed things along! Use your an Hourglass to complete this quest. You can access your items by clicking on the &#39;Inventory&#39; button at the top of the main screen.",
        objective: ["999", ""],
        reward: [
            [1000, 0, 0, 0, 0, 0],
            [],
            [
                [1, 1]
            ],
            [0, 0, 0]
        ]
    },
    q12002: {
        heading: "Build Your City",
        category: "Building Speedups",
        name: "The Speed of Knight",
        preferredorder: "19",
        prerequisite: "1042",
        description: "Not all that glitters is gold. With Gems, you may purchase amazing items to speed up your buildings and other wonders. To complete this quest, purchase a Knight&#39;s Hourglass, which will speed up your building or research time by up to 15 minutes. You must purchase the item from the store by clicking the &#39;Shop&#39; button on the main screen. Once you have purchased the Knight&#39;s Hourglass, you can use it by clicking &#39;Speedup&#39; when you are creating or upgrading a building or researching.",
        objective: ["999", ""],
        reward: [
            [2500, 0, 0, 0, 0, 0],
            [],
            [
                [2, 1]
            ],
            [0, 0, 0]
        ]
    },
    q999001: {
        heading: "Raise Your Army",
        category: "Knight Recruitment",
        name: "Appoint a Knight",
        preferredorder: "9",
        prerequisite: "1071",
        description: "Knights are the leaders of your armies and your city. Knights can be recruited from your Facebook friends. Your Knights will level up over time, and become more powerful. <b>Click on the Knights&#39; Hall</b> to Appoint a Knight to lead your people. <a onclick=openKnightsHall()>Go to Knights&#39; Hall</a>. ",
        objective: ["999", ""],
        reward: [
            [1000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q999002: {
        heading: "Raise Your Army",
        category: "Knight Recruitment",
        name: "Assign a Knight to a Role",
        preferredorder: "10",
        prerequisite: "999001",
        description: "Knights can be assigned to Roles to oversee and improve various parts of your city. The Foreman speeds up Building, the Steward improves Resource production, the Marshal speeds up Troop Training, and the Alchemystic speeds up Researching. Click on the <b>My Knights</b> tab in the <b>Knights&#39; Hall</b> to Assign a Knight to a Role.",
        objective: ["999", ""],
        reward: [
            [1000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    },
    q999010: {
        heading: "Administration",
        category: "Administration",
        name: "Adjust Tax Rate",
        preferredorder: "29",
        prerequisite: "1041",
        description: "Your Tax Rate determines how much Gold you earn each hour. Raising your Tax Rate increases your Gold production, but decreases your Happiness and Population. <b>Go to your Castle,</b> and change your Tax Rate to 20%.",
        objective: ["999", ""],
        reward: [
            [1000, 0, 0, 0, 0, 0],
            [],
            [],
            [0, 0, 0]
        ]
    }
};
var knighttemplate = [{
    knightId: 0,
    knightFbuid: 0,
    knightLordUserid: 0,
    knightName: "",
    knightLevel: 1,
    skillPointsApplied: 0,
    baseResourcefullness: 55,
    basePolitics: 55,
    baseCombat: 55,
    baseIntelligence: 55,
    experience: 0,
    resourcefulness: 55,
    politics: 55,
    combat: 55,
    intelligence: 55,
    resourcefulnessBoostExpireUnixtime: 0,
    politicsBoostExpireUnixtime: 0,
    combatBoostExpireUnixtime: 0,
    intelligenceBoostExpireUnixtime: 0,
    loyalty: 70,
    loyaltyUnixtime: 0,
    knightStatus: 1,
    cityId: 0,
    pic_square: ""
}, {
    knightId: 0,
    knightFbuid: 0,
    knightLordUserid: 0,
    knightName: "",
    knightLevel: 1,
    skillPointsApplied: 0,
    baseResourcefullness: 50,
    basePolitics: 50,
    baseCombat: 50,
    baseIntelligence: 50,
    experience: 0,
    resourcefulness: 50,
    politics: 50,
    combat: 50,
    intelligence: 50,
    resourcefulnessBoostExpireUnixtime: 0,
    politicsBoostExpireUnixtime: 0,
    combatBoostExpireUnixtime: 0,
    intelligenceBoostExpireUnixtime: 0,
    loyalty: 70,
    loyaltyUnixtime: 0,
    knightStatus: 1,
    cityId: 0,
    pic_square: ""
}];
var wilddeftemplate = {
    tileId: 0,
    mercLevel: 0,
    unit1Count: 0,
    unit2Count: 0,
    unit3Count: 0,
    unit4Count: 0,
    unit5Count: 0,
    unit6Count: 0,
    unit7Count: 0,
    unit8Count: 0,
    unit9Count: 0,
    unit10Count: 0,
    unit11Count: 0,
    unit12Count: 0,
    fort60Count: 0
};
var titlenames = {
    "1": "Lord",
    "2": "Lord",
    "3": "Lord",
    "4": "Esquire",
    "5": "Esquire",
    "6": "Esquire",
    "7": "Baronet",
    "8": "Baronet",
    "9": "Baronet",
    "10": "Baron",
    "11": "Baron",
    "12": "Baron",
    "13": "Viscount",
    "14": "Viscount",
    "15": "Viscount",
    "16": "Count",
    "17": "Count",
    "18": "Count",
    "19": "Vice Earl",
    "20": "Vice Earl",
    "21": "Vice Earl",
    "22": "Earl",
    "23": "Earl",
    "24": "Earl",
    "25": "Marquis",
    "26": "Marquis",
    "27": "Marquis",
    "28": "Grand Marquis",
    "29": "Grand Marquis",
    "30": "Grand Marquis",
    "31": "Duke",
    "32": "Duke",
    "33": "Duke",
    "34": "Grand Duke",
    "35": "Grand Duke",
    "36": "Grand Duke",
    "37": "Archduke",
    "38": "Archduke",
    "39": "Archduke",
    "40": "Grand Knight",
    "41": "Grand Knight",
    "42": "Grand Knight",
    "43": "Knight of Camelot",
    "44": "Knight of Camelot",
    "45": "Knight of Camelot",
    "46": "Knight of the Round",
    "47": "Knight of the Round",
    "48": "Knight of the Round",
    "49": "Grail Knight",
    "50": "Grail Knight",
    "51": "Grail Knight",
    "52": "Head Knight",
    "53": "Head Knight",
    "54": "Head Knight",
    "55": "Prince",
    "56": "Prince",
    "57": "Prince",
    "58": "High Prince",
    "59": "High Prince",
    "60": "High Prince",
    "61": "Grand Prince",
    "62": "Grand Prince",
    "63": "Grand Prince",
    "64": "Ayer Prince",
    "65": "Ayer Prince",
    "66": "Ayer Prince",
    "67": "Protector",
    "68": "Protector",
    "69": "Protector",
    "70": "High Protector",
    "71": "High Protector",
    "72": "High Protector",
    "73": "Grand Protector",
    "74": "Grand Protector",
    "75": "Grand Protector",
    "76": "Vice Regent",
    "77": "Vice Regent",
    "78": "Vice Regent",
    "79": "Regent",
    "80": "Regent",
    "81": "Regent",
    "82": "High Regent",
    "83": "High Regent",
    "84": "High Regent",
    "85": "Monarch-Errant",
    "86": "Monarch-Errant",
    "87": "Monarch-Errant",
    "88": "Monarch",
    "89": "Monarch",
    "90": "Monarch"
};
var buildingmight = {
    "0": [50, 100, 200, 400, 800, 1600, 3200, 6400, 12800, 25600, 51200, 102400],
    "1": [5, 10, 20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240],
    "2": [5, 10, 20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240],
    "3": [5, 10, 20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240],
    "4": [5, 10, 20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240],
    "5": [10, 20, 40, 80, 160, 320, 640, 1280, 2560, 5120],
    "6": [30, 60, 120, 240, 480, 960, 1920, 3840, 7680, 15360],
    "7": [30, 60, 120, 240, 480, 960, 1920, 3840, 7680, 15360],
    "8": [20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240, 20480],
    "9": [20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240, 20480],
    "10": [20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240],
    "11": [30, 60, 120, 240, 480, 960, 1920, 3840, 7680, 15360, 30720],
    "12": [30, 60, 120, 240, 480, 960, 1920, 3840, 7680, 15360, 30720, 61440],
    "13": [10, 20, 40, 80, 160, 320, 640, 1280, 2560, 5120],
    "14": [20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240],
    "15": [20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240],
    "16": [20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240],
    "17": [20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240],
    "18": [20, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240, 20480],
    "19": [50, 100, 200, 400, 800, 1600, 3200, 6400, 12800, 25600, 51200, 102400],
    "50": [50, 100, 200, 400, 800, 1600, 3200, 6400, 12800, 25600],
    "51": [50, 100, 200, 400, 800, 1600, 3200, 6400, 12800, 25600],
    "52": [50, 100, 200, 400, 800, 1600, 3200, 6400, 12800, 25600],
    "53": [50, 100, 200, 400, 800, 1600, 3200, 6400, 12800, 25600],
    "20": [10, 20, 40, 80, 160, 320, 640, 1280, 2560, 5120]
};
var buildingmaxlvl = {
    "0": 12,
    "1": 12,
    "2": 12,
    "3": 12,
    "4": 12,
    "5": 10,
    "6": 10,
    "7": 10,
    "8": 11,
    "9": 11,
    "10": 10,
    "11": 11,
    "12": 12,
    "13": 10,
    "14": 10,
    "15": 10,
    "16": 10,
    "17": 10,
    "18": 11,
    "19": 12,
    "50": 10,
    "51": 10,
    "52": 10,
    "53": 10,
    "20": 10
};
var buildingupgradedesc = {
    "0": ["Control one Wilderness and build Level 2 Cottages", "Control two Wildernesses, build Level 3 Cottages, and gain 3 more Resource Fields", "Control three Wildernesses, build Level 4 Cottages, and gain 3 more Resource Fields", "Control four Wildernesses, build Level 5 Cottages, and gain 3 more Resource Fields", "Control five Wildernesses, build Level 6 Cottages, and gain 3 more Resource Fields", "Control six Wildernesses, build Level 7 Cottages, and gain 3 more Resource Fields", "Control seven Wildernesses, build Level 8 Cottages, and gain 3 more Resource Fields", "Control eight Wildernesses, build Level 9 Cottages, and gain 3 more Resource Fields", "Control nine Wildernesses, build Level 10 Cottages, and gain 3 more Resource Fields", "Control ten Wildernesses, build Level 10 Cottages, and gain 3 more Resource Fields", "Control twelve Wildernesses and build Level 11 Buildings", "Control fourteen Wildernesses and build Level 12 Buildings"],
    "1": ["Uses 10 workers, produces 100 Food per hour, with a capacity of 10,000", "Uses 30 workers, and produces 300 Food per hour, with a capacity of 30,000", "Uses 60 workers, and produces 600 Food per hour, with a capacity of 60,000", "Uses 100 workers, and produces 1,000 Food per hour, with a capacity of 100,000", "Uses 150 workers, and produces 1,500 Food per hour, with a capacity of 150,000", "Uses 200 workers, and produces 2,100 Food per hour, with a capacity of 210,000", "Uses 280 workers, and produces 2,800 Food per hour, with a capacity of 280,000", "Uses 360 workers, and produces 4,000 Food per hour, with a capacity of 400,000", "Uses 450 workers, and produces 5,750 Food per hour, with a capacity of 575,000", "Uses 550 workers, and produces 7,700 Food per hour, with a capacity of 770,000", "Uses 660 workers, and produces 9,850 Food per hour, with a capacity of 985,000", "Uses 780 workers, and produces 12,200 Food per hour, with a capacity of 1,220,000"],
    "2": ["Uses 10 workers, produces 100 Wood per hour, with a capacity of 10,000", "Uses 30 workers, and produces 300 Wood per hour, with a capacity of 30,000", "Uses 60 workers, and produces 600 Wood per hour, with a capacity of 60,000", "Uses 100 workers, and produces 1,000 Wood per hour, with a capacity of 100,000", "Uses 150 workers, and produces 1,500 Wood per hour, with a capacity of 150,000", "Uses 200 workers, and produces 2,100 Wood per hour, with a capacity of 210,000", "Uses 280 workers, and produces 2,800 Wood per hour, with a capacity of 280,000", "Uses 360 workers, and produces 4,000 Wood per hour, with a capacity of 400,000", "Uses 450 workers, and produces 5,750 Wood per hour, with a capacity of 575,000", "Uses 550 workers, and produces 7,700 Wood per hour, with a capacity of 770,000", "Uses 660 workers, and produces 9,850 Wood per hour, with a capacity of 985,000", "Uses 780 workers, and produces 12,200 Wood per hour, with a capacity of 1,220,000"],
    "3": ["Uses 10 workers, produces 100 Stone per hour, with a capacity of 10,000", "Uses 30 workers, and produces 300 Stone per hour, with a capacity of 30,000", "Uses 60 workers, and produces 600 Stone per hour, with a capacity of 60,000", "Uses 100 workers, and produces 1,000 Stone per hour, with a capacity of 100,000", "Uses 150 workers, and produces 1,500 Stone per hour, with a capacity of 150,000", "Uses 200 workers, and produces 2,100 Stone per hour, with a capacity of 210,000", "Uses 280 workers, and produces 2,800 Stone per hour, with a capacity of 280,000", "Uses 360 workers, and produces 4,000 Stone per hour, with a capacity of 400,000", "Uses 450 workers, and produces 5,750 Stone per hour, with a capacity of 575,000", "Uses 550 workers, and produces 7,700 Stone per hour, with a capacity of 770,000", "Uses 660 workers, and produces 9,850 Stone per hour, with a capacity of 985,000", "Uses 780 workers, and produces 12,200 Stone per hour, with a capacity of 1,220,000"],
    "4": ["Uses 10 workers, produces 100 Ore per hour, with a capacity of 10,000", "Uses 30 workers, and produces 300 Ore per hour, with a capacity of 30,000", "Uses 60 workers, and produces 600 Ore per hour, with a capacity of 60,000", "Uses 100 workers, and produces 1,000 Ore per hour, with a capacity of 100,000", "Uses 150 workers, and produces 1,500 Ore per hour, with a capacity of 150,000", "Uses 200 workers, and produces 2,100 Ore per hour, with a capacity of 210,000", "Uses 280 workers, and produces 2,800 Ore per hour, with a capacity of 280,000", "Uses 360 workers, and produces 4,000 Ore per hour, with a capacity of 400,000", "Uses 450 workers, and produces 5,750 Ore per hour, with a capacity of 575,000", "Uses 550 workers, and produces 7,700 Ore per hour, with a capacity of 770,000", "Uses 660 workers, and produces 9,850 Ore per hour, with a capacity of 985,000", "Uses 780 workers, and produces 12,200 Ore per hour, with a capacity of 1,220,000"],
    "5": ["Raises your Population Limit by 100", "Raises your Population Limit by 300", "Raises your Population Limit by 600", "Raises your Population Limit by 1,000", "Raises your Population Limit by 1,500", "Raises your Population Limit by 2.100", "Raises your Population Limit by 2,800", "Raises your Population Limit by 3,600", "Raises your Population Limit by 4,500", "Raises your Population Limit by 5,500"],
    "6": ["Negates the penalty on Happiness caused by your Tax Rate by 1 point", "Negates the penalty on Happiness caused by your Tax Rate by 2 points", "Negates the penalty on Happiness caused by your Tax Rate by 3 points", "Negates the penalty on Happiness caused by your Tax Rate by 4 points", "Negates the penalty on Happiness caused by your Tax Rate by 5 points", "Negates the penalty on Happiness caused by your Tax Rate by 6 points", "Negates the penalty on Happiness caused by your Tax Rate by 7 points", "Negates the penalty on Happiness caused by your Tax Rate by 8 points", "Negates the penalty on Happiness caused by your Tax Rate by 9 points", "Negates the penalty on Happiness caused by your Tax Rate by 10 points"],
    "7": ["Increase your Knights&#39; experience by 10 per hour", "Increase your Knights&#39; experience by 20 per hour", "Increase your Knights&#39; experience by 30 per hour", "Increase your Knights&#39; experience by 40 per hour", "Increase your Knights&#39; experience by 50 per hour", "Increase your Knights&#39; experience by 60 per hour", "Increase your Knights&#39; experience by 70 per hour", "Increase your Knights&#39; experience by 80 per hour", "Increase your Knights&#39; experience by 90 per hour", "Increase your Knights&#39; experience by 100 per hour"],
    "8": ["Join an Alliance, and house one ally&#39;s troops", "Create an Alliance, and house two allies&#39; troops", "House three allies&#39; troops", "House four allies&#39; troops", "House five allies&#39; troops", "House six allies&#39; troops", "House seven allies&#39; troops", "House eight allies&#39; troops", "House nine allies&#39; troops", "House ten allies&#39; troops", "House eleven allies&#39; troops"],
    "9": ["Allows you to protect up to 100,000 of each resource", "Allows you to protect up to 200,000 of each resource", "Allows you to protect up to 300,000 of each resource", "Allows you to protect up to 400,000 of each resource", "Allows you to protect up to 500,000 of each resource", "Allows you to protect up to 600,000 of each resource", "Allows you to protect up to 700,000 of each resource", "Allows you to protect up to 800,000 of each resource", "Allows you to protect up to 900,000 of each resource", "Allows you to protect up to 1,000,000 of each resource", "Allows you to protect up to 5,000,000 of each resource"],
    "10": ["Engage in one transaction at a time", "Engage in two transaction at a time", "Engage in three transaction at a time", "Engage in four transaction at a time", "Engage in five transaction at a time", "Engage in six transaction at a time", "Engage in seven transaction at a time", "Engage in eight transaction at a time", "Engage in nine transaction at a time", "Engage in ten transaction at a time"],
    "11": ["Research Fertilizer, Logging, Stoneworking, and Mining, and raise your research cap to Level 1", "Research Poisoned Edged, and raise your research cap to Level 2", "Research Geometry, Eagle Eyes, and Metal Alloys, and raise your research cap to Level 3", "Research Featherweight Powder, Magical Mapping, and Fletching, and raise your research cap to Level 4", "Research Alloy Horseshoes and Giant&#39;s Strength, and raise your research cap to Level 5", "Research Shrinking Powder and Healing Potions, and raise your research cap to Level 6", "Raise your research cap to Level 7", "Raise your research cap to Level 8", "Raise your research cap to Level 9", "Raise your research cap to Level 10", "Raise your research cap to Level 11"],
    "12": ["Send one army at a time, with up to 10,000 troops", "Send two armies at a time, with up to 20,000 troops each", "Send three armies at a time, with up to 30,000 troops each", "Send four armies at a time, with up to 40,000 troops each", "Send five armies at a time, with up to 50,000 troops each", "Send six armies at a time, with up to 60,000 troops each", "Send seven armies at a time, with up to 70,000 troops each", "Send eight armies at a time, with up to 80,000 troops each", "Send nine armies at a time, with up to 90,000 troops each", "Send ten armies at a time, with up to 100,000 troops each", "Send eleven armies at a time, with up to 150,000 troops each", "Send eleven armies at a time, with up to 200,000 troops each"],
    "13": ["Train Supply Troopers and Militiamen", "Train Scouts and Pikemen, and increase your training speed", "Train Swordsmen, and increase your training speed", "Train Archers, and increase your training speed", "Train Cavalry, and increase your training speed", "Train Supply Wagons, and increase your training speed", "Train Heavy Cavalry, and increase your training speed", "Train Ballistae, and increase your training speed", "Train Battering Rams, and increase your training speed", "Train Catapults, and increase your training speed"],
    "14": ["Warns you of an impending attack", "Tells you the purpose of an impending attack (Plunder or Scout)", "Tells you the arrival time of an impending attack", "Tells you the Title and Alliance of the Player sending an impending attack", "Gives you an estimate of the total Troops in an impending attack", "Tells you the Troop types in an impending attack", "Gives you an estimate of how many of each Troop type in an impending attack", "Tells you the exact number of Troops in an impending attack", "Tells you the Combat Skill of the Knight leading an impending attack", "Tells you the Research levels of the Player sending an impending attack"],
    "15": ["Allows you to research Level 1 Metal Alloys and Train Swordsmen", "Allows you to research Level 2 Metal Alloys", "Allows you to research Level 3 Metal Alloys", "Allows you to research Level 4 Metal Alloys", "Allows you to research Level 5 Metal Alloys and Train Battering Rams and Heavy Cavalry", "Allows you to research Level 6 Metal Alloys", "Allows you to research Level 7 Metal Alloys", "Allows you to research Level 8 Metal Alloys", "Allows you to research Level 9 Metal Alloys", "Allows you to research Level 10 Metal Alloys"],
    "16": ["Research Level 1 Geometry and Build Level 2 Walls", "Research Level 2 Geometry and Build Level 3 Walls", "Research Level 3 Geometry and Build Level 4 Walls and Train Supply Wagons", "Research Level 4 Geometry and Build Level 5 Walls", "Research Level 5 Geometry and Build Level 6 Walls and Train Ballistae", "Research Level 6 Geometry and Build Level 7 Walls", "Research Level 7 Geometry and Build Level 8 Walls and Train Battering Rams", "Research Level 8 Geometry and Build Level 9 Walls", "Research Level 9 Geometry and Build Level 10 Walls and Train Catapults", "Research Level 10 Geometry"],
    "17": ["Research Level 1 Alloy Horseshoes, and Train horsed troops faster", "Research Level 2 Alloy Horseshoes, and Train horsed troops faster", "Research Level 3 Alloy Horseshoes, and Train horsed troops faster", "Research Level 4 Alloy Horseshoes, and Train horsed troops faster", "Research Level 5 Alloy Horseshoes, and Train horsed troops faster", "Research Level 6 Alloy Horseshoes, and Train horsed troops faster", "Research Level 7 Alloy Horseshoes, and Train horsed troops faster", "Research Level 8 Alloy Horseshoes, and Train horsed troops faster", "Research Level 9 Alloy Horseshoes, and Train horsed troops faster", "Research Level 10 Alloy Horseshoes, and Train horsed troops faster"],
    "18": ["Causes troops to move 1.5x normal speed between your own and allied Cities", "Causes troops to move 2x normal speed between your own and allied Cities", "Causes troops to move 2.5x normal speed between your own and allied Cities", "Causes troops to move 3x normal speed between your own and allied Cities", "Causes troops to move 3.5x normal speed between your own and allied Cities", "Causes troops to move 4x normal speed between your own and allied Cities", "Causes troops to move 4.5x normal speed between your own and allied Cities", "Causes troops to move 5x normal speed between your own and allied Cities", "Causes troops to move 5.5x normal speed between your own and allied Cities", "Causes troops to move 6x normal speed between your own and allied Cities", "Causes troops to move 6.5x normal speed between your own and allied Cities"],
    "19": ["Provides 100,000 Durability and 1,000 Defensive Unit Spaces", "Provides 300,000 Durability and 3,000 Defensive Unit Spaces", "Provides 600,000 Durability and 6,000 Defensive Unit Spaces", "Provides 1,000,000 Durability and 10,000 Defensive Unit Spaces", "Provides 1,500,000 Durability and 15,000 Defensive Unit Spaces", "Provides 2,100,000 Durability and 21,000 Defensive Unit Spaces", "Provides 2,800,000 Durability and 28,000 Defensive Unit Spaces", "Provides 3,600,000 Durability and 36,000 Defensive Unit Spaces", "Provides 4,500,000 Durability and 45,000 Defensive Unit Spaces", "Provides 5,500,000 Durability and 55,000 Defensive Unit Spaces", "Provides 6,600,000 Durability and 66,000 Defensive Unit Spaces", "Provides 7,800,000 Durability and 78,000 Defensive Unit Spaces"],
    "50": ["", "", "", "", "", "", "", "", "", ""],
    "51": ["", "", "", "", "", "", "", "", "", ""],
    "52": ["", "", "", "", "", "", "", "", "", ""],
    "53": ["", "", "", "", "", "", "", "", "", ""],
    "20": ["Allows you to craft items using level 1 recipes.", "Allows you to craft items using level 2 recipes.", "Allows you to craft items using level 3 recipes.", "Allows you to craft items using level 4 recipes.", "Allows you to craft items using level 5 recipes.", "Allows you to craft items using level 6 recipes.", "Allows you to craft items using level 7 recipes.", "Allows you to craft items using level 8 recipes.", "Allows you to craft items using level 9 recipes.", "Allows you to craft items using level 10 recipes."]
};
var provincenames = {
    p1: "Tintagel",
    p2: "Cornwall",
    p3: "Astolat",
    p4: "Lyonesse",
    p5: "Corbenic",
    p6: "Paimpont",
    p7: "Cameliard",
    p8: "Sarras",
    p9: "Canoel",
    p10: "Avalon",
    p11: "Carmathen",
    p12: "Shallott",
    p13: "Cadbury",
    p14: "Glastonbury",
    p15: "Camlann",
    p16: "Orkney",
    p17: "Dore",
    p18: "Logres",
    p19: "Caerleon",
    p20: "Parmenie",
    p21: "Bodmin Moor",
    p22: "Cellwig",
    p23: "Listeneise",
    p24: "Albion"
};
var cm = cm || {};
cm.FETemplates = {
    Modal: {
        largeModal1: '<div class="curtainMM curtainNum#{curtainId}" style="z-index: #{curtainZ}"></div><div class="cmModalContainer #{modalClasses}" style="#{modalStyles}"><div class="bordertop"></div><div class="borderbody"><div class="primarytitlebar"><div class="gemContainer"><span class="amount">#{gem}</span><a class="buttonv2 green h20">Get More</a></div><span>#{primaryTitle}</span><div class="close"></div></div><div class="primarycontent">#{primaryBody}</div></div><div class="borderbottom"></div></div>',
        largeModal2: '<div class="curtainMM curtainNum#{curtainId}" style="z-index: #{curtainZ}"></div><div class="cmModalContainer #{modalClasses}" style="#{modalStyles}"><div class="bordertop"></div><div class="borderbody"><div class="primarytitlebar">#{primaryTitle}</div><div class="primarycontent">#{primaryBody}</div><div class="secondaryContainer"><div class="divider"></div><div class="bordertop"></div><div class="borderbody"><div class="secondarytitlebar">#{secondaryTitle}</div><div class="secondarycontent">#{secondaryBody}</div></div><div class="borderbottom"></div></div></div><div class="borderbottom"></div></div>',
        mediumModal: '<div class="curtainMM curtainNum#{curtainId}" style="z-index: #{curtainZ}"></div><div class="cmModalContainer #{modalClasses}" style="#{modalStyles}"><div class="bordertop"></div><div class="borderbody"><div class="primarytitlebar"><div class="close"></div><div class="hint"></div>#{primaryTitle}</div><div class="primarycontent">#{primaryBody}</div></div><div class="borderbottom"></div></div>'
    },
    Profile: {
        mainProfile: '<div class="avatar avatar_260 #{avatarClass}">#{changeAvatarButton}</div><div class="info"><div class="miniactions">#{miniActionButtons}</div><h2 class="name">#{playerTitle} <br/>#{playerName}</h2><hr><ul><li><span class="label">#{mightLabel}:</span> <span class="value">#{mightValue}</span></li><li><div class="glory"><span class="label">#{gloryLabel}:</span></div><div>#{gloryIcons}</div><div><span class="value">#{gloryValue}</span></div></li><li><span class="label">#{titleLabel}:</span> <span class="value">#{titleValue}</span></li><li><span class="label">#{allianceLabel}:</span> <span class="value">#{allianceValue}</span></li><li><span class="label">#{statusLabel}:</span> <span class="value">#{statusValue}</span></li></ul><div class="actions">#{actionButtons}</div></div>',
        actionButton: '<a class="buttonv2 #{className}">#{label}</a>',
        miniActionButton: '<a class="button #{className}"> </a>'
    },
    NewGame: {
        modalShell: '<div class="primarytitlebar">#{titleBar}</div><div class="primarycontent clearfix">#{body}</div><div class="#{logoClass}"></div>',
        parchmentShell: '<div class="parchment_wrapper"><div id="newGamePortrait" class="avatar_246 #{avatarId}"></div><div class="parchment"><div class="player_display"><h1 id="newGameLordyHeader" class="lordy">#{lordyText}</h1><h2 id="newGameNameHeader" class="name">#{playerName}</h2></div><div class="main_panel"><div class="titlebar">#{panelTitle}</div><div class="content">#{panelBody}</div></div></div></div>',
        newPlayerPanel: '<div class="avatar_instruct">#{avatarSelectionText}</div><div class="avatar_selection">#{avatarChoices}</div><div class="name_instruct">#{nameSelectionText}</div><div class="name_selection"><label for="newGameNameInput" id="newGameLordyLabel">#{lordyText}</label><input id="newGameNameInput" class="selectable" type="text" maxlength="15" autocomplete="off" value="#{playerName}"/><div id="newGameNameStatus"></div></div><div id="nameHint" class="name_hint">#{nameHintText}</div><div class="domain_selection"><div class="city_location_text">#{cityLocationText}</div><div class="domain">#{domainText} <span id="newGameDomain" class="selectable">#{domain}</span></div></div><div class="action_buttons">#{actionButtons}</div>',
        actionButton: '<a class="buttonv2 #{className}">#{label}</a>',
        miniActionButton: '<a class="button #{className}"> </a>',
        playConfirmPanel: '<h2 class="player_name">#{lordyText} #{playerName}</h2><h3 class="founded_kingdom">#{foundedKingdom}</h3><div class="placed_under_protection">#{placedUnderProtection}</div><ul class="player_hints">#{playerHints}</ul><h3 class="placed_under_protection">#{callToAction}</h3><div class="action_buttons">#{actionButtons}</div>'
    },
    desertionReport_24: {
        self: '<div class="desertionReport"><div class="summarySection"><div class="sectionTitle">{PRESENTATION_MODEL.troopsdeserted}</div><div class="sectionBody"><span class="highlightedText">{PRESENTATION_MODEL.cityunableprovideenoughfoodyourcity}, {city.name},</span> {PRESENTATION_MODEL.cityunableprovideenoughfoodmain} <span class="highlightedText">{PRESENTATION_MODEL.cityunableprovideenoughfooddesertedat} {date}.</span></div></div><div class="detailSection"><div class="detailTable"><div class="detailTableHeader"><div class="headerTitle"><span class="cityNumber">{city.number}</span> {city.name} {date} </div><div class="foodTitleRow"><div class="producedColumn">{PRESENTATION_MODEL.foodproduced}</div><div class="consumedColumn">{PRESENTATION_MODEL.foodconsumed}</div><div class="deficitColumn">{PRESENTATION_MODEL.fooddeficit}</div></div><div class="foodRow"><div class="producedColumn">{food.produced}</div><div class="consumedColumn">{food.consumed}</div><div class="deficitColumn">{food.deficit}</div></div></div>{lostTroops}<div class="detailTableFooter"></div></div></div><div class="tipSection"><div class="tipNote"><span class="highlightedText uppercaseText">{PRESENTATION_MODEL.note}</span> {PRESENTATION_MODEL.youwillcontinuetolosetroops}</div><div class="tipTable"><div class="tipTableBody"><div class="tipRow1 tipRowTitle">{PRESENTATION_MODEL.waystoimprove}</div><div class="tipRow2">{PRESENTATION_MODEL.havehighlevelwilderness}</div><div class="tipRow1">{PRESENTATION_MODEL.havegoodnumberoffarms}</div><div class="tipRow2">{PRESENTATION_MODEL.haveknightassignedsteward}</div><div class="tipRow1">{PRESENTATION_MODEL.armynottoobig}</div></div><div class="tipTableFooter"></div></div></div><div class="desertionReportFooter"><a name="desertionReportBackButton" class=\'button20\'><span>{PRESENTATION_MODEL.backtoreports}</span></a></div></div>'
    },
    MarchReport: {
        marchReport: '<div class="marchReport">#{info}#{title}<div class="sceneContainer">#{loot}#{scene}</div><div class="buttonsContainer"></div><div class="unitsContainer">#{units}</div><div class="buttonsContainer"></div></div>',
        marchReportInfo: '<div id="marchReportInfo"><div class="location">#{location}</div><div class="time">#{time}</div></div>',
        marchReportTitle: '<div id="marchReportTitle"><p class="status">#{status}</p><p class="hint">#{hint}</p>#{maxWilderness}</div>',
        marchReportLoot: '<div id="marchReportLoot"><ul>#{lis}</ul></div>',
        marchReportScenery: '<div id="marchReportScenery"><img src="#{image}" />#{hint}</div>',
        marchReportUnits: '<div id="marchReportUnits"><div class="unitContainer attacker"><div class="roleInfo">#{attackerRole}</div><div class="knightInfo">#{attackerBoosts}</div><div class="unitsContainer">#{attackerUnits}</div></div><div class="unitContainer defender"><div class="roleInfo">#{defenderRole}</div><div class="knightInfo">#{defenderBoosts}</div><div class="unitsContainer">#{defenderUnits}</div></div></div>',
        marchReportUnitsOverwhelmedTable: "<table><thead><tr><th>#{troopHeader}</th><th>#{killedHeader}</th></tr></thead><tbody>#{units}</tbody></table>",
        marchReportUnitsTable: "<table><thead><tr><th>#{troopHeader}</th><th>#{foughtHeader}</th><th>#{survivedHeader}</th></tr></thead><tbody>#{units}</tbody></table>"
    },
    Barracks: {
        unit_training_modal: '<div id="barracks_train"><div class="imageContainer"><img src="#{unitImage}"/></div><div class="unitInfoContainer"><div class="unitDescription">#{unitDescription}</div><div class="unitStats"><ul><li> <span class="label">#{attackLabel}</span> <span class="value">#{attackValue}</span></li><li> <span class="label">#{speedLabel}</span> <span class="value">#{speedValue}</span></li><li> <span class="label">#{defenseLabel}</span> <span class="value">#{defenseValue}</span></li><li> <span class="label">#{rangeLabel}</span> <span class="value">#{rangeValue}</span></li><li> <span class="label">#{lifeLabel}</span> <span class="value">#{lifeValue}</span></li><li> <span class="label">#{loadLabel}</span> <span class="value">#{loadValue}</span></li><li class="bottom"> <span class="label">#{upkeepLabel}</span> <span class="value">#{upkeepValue}</span></li><li class="bottom"> <span class="label">#{typeLabel}</span> <span class="value">#{typeValue}</span></li></ul></div><div class="unitReqs"><table><thead><tr><td>#{resourceHeader}</td><td>#{requiredHeader}</td><td>#{youOwnHeader}</td></tr></thead><tbody>#{reqs}</tbody></table></div><div class="unitsQuantity"><div class="youOwnContainer"><span class="label">#{youOwnLabel}:</span> <span class="value">#{youOwnValue}</span></div><div class="maxContainer"><span class="label">#{maxLabel}:</span> <span id="modal_barracks_max_num" class="value">#{maxValue}</span></div></div><div class="unitsTrainingQuantity"><p>#{troopTrainLabel}</p><input type="text" id="modal_barracks_num" onkeyup="modal_barracks_train_timecalc(this, #{unitId});" /><a class="inlineButton blue14" onclick="modal_barracks_train_maxbtn(#{unitId});return false;"> <span>#{maxLabel}</span> </a></div><div class="unitsTrainingTime"><span class="label">#{trainTimeLabel} </span><span class="value" id="modal_barracks_traintime"></span></div>#{misc}<div class="buttonContainer"><a onclick="modal_barracks_train_action(#{unitId});" class="button25" id="unit_btns_start"><span>#{buttonLabel}</span></a></div></div></div>',
        unit_training_boost: '<div id="trainingBoostContainer" class="trainingBoostContainer"><input type="checkbox" name="trainingBoost" id="#{inputId}" onclick="clearOtherTuts(#{index});" #{isDisabled} /><div class="trainingBoostInfoContainer"><img src="#{imgSource}" /><div class="trainingBoostInfo"><div class="name">#{name}</div><div class="time"><span class="timeLabel">#{timeLabel}:</span><span id="#{timeId}" class="timeAmount">0 #{secLabel}</span></div><div class="quantity"><span class="quantityAmount">#{youOwnLabel}: #{youOwnValue}.</span><a onclick="modal_barracks_getmoreshop();">#{getMoreLabel}</a></div></div></div></div>',
        unit_training_gamble: '<div id="unitGambleOption" class="unitGambleOption"><ul><li><input type="radio" name="gambleOption" id="gambleOption0" checked="checked" onclick="chooseGambleOptions(0, #{unitId});" /><p>#{label0}</p></li><li><input type="radio" name="gambleOption" id="gambleOption1" onclick="chooseGambleOptions(1, #{unitId});" /><p>#{label1}</p></li><li><input type="radio" name="gambleOption" id="gambleOption2" onclick="chooseGambleOptions(2, #{unitId});" /><p>#{label2}</p></li></ul></div>',
        unit_training_gamble_option: '<li><input type="radio" name="gambleOption" id="gambleOption#{index}" /><p>#{label}</p></li>'
    },
    Inventory: {
        inventoryModal: "<div id='inventoryModalContainer'><div id='inventoryModalHeader'><a class='button20' onclick='Modal.hideModalAll(); cm.ShopView.openShop();'><span> #{getmoreitemsString} </span></a><div id='gemsContainer'><span class='label'> #{gemsString} </span><span id='inventoryGemQuantity' class='gemsQuantity'> </span><img src='img/gem.png' /><a class='buttonGreen20' onclick='cm.ConversionTracker.track(\"payments\", \"MORE_GEMS_MY_ITEMS\", \"\"); modal_getgems();return false;'><span> + #{getmoregemsString} </span></a></div></div><div id='inventoryModalBody'><div id='inventoryTabs'><ul><li id='inventoryTab1' class='selected'><a onclick='cm.InventoryView.openTab(1);'> #{generalString} </a></li><li id='inventoryTab2'><a onclick='cm.InventoryView.openTab(2);'> #{speedupString} </a></li><li id='inventoryTab3'><a onclick='cm.InventoryView.openTab(3);'> #{combatString} </a></li><li id='inventoryTab4'><a onclick='cm.InventoryView.openTab(4);'> #{resourcesString} </a></li><li id='inventoryTab5'><a onclick='cm.InventoryView.openTab(5);'> #{chestString} </a></li><li id='inventoryTab6'><a onclick='cm.InventoryView.openTab(6);'> #{courtString} </a></li></ul></div><div id='inventoryMessage'></div><div id='inventoryBanner'></div><div id='inventoryItemsContainer'><a id='inventoryPrevPageButton' onclick='cm.InventoryView.goPrevPage();'></a><a id='inventoryNextPageButton' onclick='cm.InventoryView.goNextPage();'></a><ul id='inventoryItemsContainerList'></ul></div></div></div>",
        itemButton: "<a class='button20' onclick='cm.ItemController.use(#{id});'><span id='item#{id}ButtonText'> #{actionString} </span></a>",
        itemContainer: "<li><div id='item#{id}' class='item' name=\"#{description}\" onmouseover='cm.InventoryView.showItemTooltip(this, event);' onmouseout='removeTooltip();'><div class='name'>#{name}</div><div class='info'><img src='#{imageSource}' />#{actionbutton}<div class='ownedContainer'><span class='label'> #{ownedString}:</span><span id='item#{id}Count'>#{count}</span></div></div></div></li>",
        itemsInChestModal: "<div id='itemsInChestContainer'><div class='title'> #{itemsGainedString} </div><ul id='itemsInChestContainerList'></ul><a class='button20' onclick='Modal.hideModal();'><span> #{okString} </span></a></div>",
        itemsInChestContainer: "<li><img src='img/items/70/#{id}.jpg'/><span class='name'>#{name}</span><span class='count'>#{count}</span></li>",
        portalOfRefugeModal: "<div id='portalOfRefugeContainer'><div id='provinceContainer'><div id='currentProvinceContainer'><span class='label'>#{currentProvString}</span> - <span id='currentProvinceName' class='name'></span></div><div id='newProvinceContainer'><span class='label'>#{newProvString}</span> <select id='provinceNamesList'> </select></div><div id='teleportError' style='display: none;'></div></div><div class='buttonContainer'><a class='button20' onclick='cm.ItemController.usePortalOfRefuge(911);'><span>#{submitString}</span></a><a onclick='Modal.hideModal();'>#{cancelString}</a></div></div>",
        provinceNameContainer: "<option value='#{value}'>#{name}</option>",
        portalConfirmModal: "<div id='portalConfirmContainer'><div id='portalConfirmInfoContainer'><div id='portalItemNameContainer'></div><div id='teleportCoordinateContainer'></div></div><div class='buttonContainer'><a id='portalConfirmOKButton' class='button20'><span>#{okString}</span></a></div></div>",
        portalOfOrderModal: "<div id='portalOfOrderContainer'><div id='coordinatesContainer'><div id='currentCoordinatesContainer'><span class='label'>#{currentCoordString} - </span>X: <span id='xCoordinate'></span> Y: <span id='yCoordinate'></span></div><div id='newCoordinatesContainer'><span class='label'>#{newCoordString}</span><div id='newCoordinatesInputsContainer'>X: <input type='text' id='newXCoordinate' maxLength='3'/> Y: <input type='text' id='newYCoordinate' maxLength='3'/></div></div><div id='teleportError' style='display: none;'></div></div><div class='buttonContainer'><a class='button20' onclick='cm.ItemController.usePortalOfOrder(912);'><span>#{submitString}</span></a><a onclick='Modal.hideModal();'>#{cancelString}</a></div></div>",
        renamingCelebrationModal: "<div id='renamingCelebrationContainer'><div id='nameContainer'><div id='currentCityContainer'><span class='label'>#{currentCityString}: </span><span id='currentCityName'></span></div><div id='newCityContainer'><span class='label'>#{newCityNameString}</span><input type='text' id='newCityName'/></div><div id='cityNameError'></div></div><div class='buttonContainer'><a class='button20' onclick='cm.ItemController.useRenamingCelebration(923);'><span>#{submitString}</span></a><a onclick='Modal.hideModal();'>#{cancelString}</a></div></div>",
        renamingCelebrationConfirmModal: "<div id='renamingCelebrationConfirmContainer'><div class='confirmContainer'><p id='confirmMessage'></p><div><span class='label'>#{newCityNameString}: </span><span id='newCityName'></span></div></div><a id='renamingCelebrationConfirmOKButton' class='button20' onclick=''><span>#{okString}</span></a></div>",
        merlinsCloakModal: "<div id='merlinsCloakContainer'><div id='merlinsCloakNameContainer'><div id='currentNameContainer'><span class='label'>#{yourCurrentNameString}</span> <span id='merlinsCloakCurrentName'></span></div><div id='newNameContainer'><span id='newNamePrefix' class='label'>#{newNameString}</span> <input type='text' id='merlinsCloakNewName'/></div><div id='merlinsCloakError'></div></div><div class='buttonContainer'><a class='button20' onclick='cm.ItemController.useMerlinsCloak(922);'><span>#{submitString}</span></a><a onclick='Modal.hideModal();'>#{cancelString}</a></div></div>",
        merlinsEscapeModal: "<div id='merlinsEscapeContainer'><div id='nameContainer'><div id='currentNameContainer'><span class='label'>#{yourCurrentNameString}</span>: <span id='merlinsCloakCurrentName'></span></div><div id='newNameContainer'><span id='newNamePrefix' class='label'>#{newNameString}</span> <input type='text' id='merlinsEscapeNewName'/></div></div><div id='coordinatesContainer'><div id='currentCoordinatesContainer'><span class='label'>#{currentCoordString} - </span>X: <span id='xCoordinate'></span> Y: <span id='yCoordinate'></span></div><div id='newCoordinatesContainer'><span class='label'>#{newCoordString}</span><div id='newCoordinatesInputsContainer'>X: <input type='text' id='newXCoordinate' maxLength='3'/> Y: <input type='text' id='newYCoordinate' maxLength='3'/></div></div></div><div id='escapeError'></div><div class='buttonContainer'><a class='button20' onclick='cm.ItemController.useMerlinsEscape(924);'><span>#{submitString}</span></a><a onclick='Modal.hideModal();'>#{cancelString}</a></div></div>",
        merlinsEscapeConfirmModal: "<div id='merlinsEscapeConfirmContainer'><div id='confirmContainer'><p id='itemUsedContainer'></p><p id='nameChangedContainer'></p><p id='teleportedToContainer'></p></div><a id='merlinsEscapeConfirmButton' class='button20' onclick=''><span>#{okString}</span></a></div>",
        potionOfMistModal: "<div id='potionOfMistContainer'><div id='potionOfMistMessage'>#{mistWarningString}</div><div class='buttonContainer'><a class='button20' onclick='cm.ItemController.usePotionOfMist(10021);'><span>#{useMistsString}</span></a><a class='button20' onclick='Modal.hideModal();'><span>#{cancelString}</span></a></div></div>",
        vacationModeModal: "<div id='vacationModeContainer'><div id='vacationModeWarningContainer'><span id='vacationModeWarning'></span><p id='vacationModeMessage'></p></div><div class='buttonContainer'><a class='button20' onclick='cm.ItemController.useVacationMode(#{itemId});'><span>#{useVacationString}</span></a><a class='button20' onclick='Modal.hideModal()'><span>#{cancelString}</span></a></div></div>"
    },
    ChooseGift_39: {
        self: '<div id="{$.modalId}"><div class=""><div class="instr">{g_js_strings.choosegiftmodal.title}</div><div class="desc">{g_js_strings.choosegiftmodal.description}</div><div class="sendbtn"><a class="button25"><span>{g_js_strings.choosegiftmodal.proceedtosend}</span></a></div><div class="clearfix itemlist" id="itemlist">{$.items}</div><div class="sendbtn"><a class="button25"><span>{g_js_strings.choosegiftmodal.proceedtosend}</span></a></div></div></div>',
        "items[*]": '<div class="item"><img src="{site_image_url}img/items/70/{$.itemId}.jpg" /><div class="itemnm">{$.name}</div><div class="radio"><input type="radio" name="itemsel" value="{$.itemId}" /></div></div>'
    },
    autoAttack_28: {
        self: '<div id="modal_rallypoint_autoattack" style="display: none;" class="autoattack_manager"><div class="countdown"></div><div class="header"><div class="start_button"></div><div class="title">{g_js_strings.modal_auto_attack.restartraidtimer}</div><img src="{site_image_url}img/1pixel.png" usemap="#map_autoattack{instance_guid}" /><map name="map_autoattack{instance_guid}"><area shape="polygon" coords="0,0,252,0,236,29,16,29" href="#" /></map><div class="options_button"><a class="inlineButton brown20"><span>{g_js_strings.commonstr.options}</span></a></div><div class="whats_a_barbraid"><a>{g_js_strings.modal_auto_attack.whatisabarbarianraid}</a></div></div><div class="global_controller"><div class="num_city">{city_name}<span>{city_number}</span></div><div class="raids_manupulate"><a class="inlineButton brown20 addraid"><span>+ {g_js_strings.modal_auto_attack.addraid}</span></a></div><div class="raids_bulk_controller"><a class="inlineButton brown20"><span class="stopAll">{g_js_strings.modal_auto_attack.stopall}</span></a><a class="inlineButton brown20"><span class="resumeAll">{g_js_strings.modal_auto_attack.resumeall}</span></a></div></div><div class="glass_pane"></div><div class="main"><div class="raids"><div class="add_raid_message">{g_js_strings.modal_auto_attack.youdonothaveanysavedraids}. <a>{g_js_strings.modal_auto_attack.addaraid}</a> {g_js_strings.modal_auto_attack.now}.</div></div><div class="glass_pane"></div></div></div>',
        "queue[*]": '<div class="raid"><div class="raid_title"><span class="toggler"></span>{g_js_strings.commonstr.barbariancamp} {g_js_strings.commonstr.lvl} {$.cityMarches.toTileLevel} <span class="coordinates">({$.cityMarches.toXCoord}, {$.cityMarches.toYCoord})</span> - <span class="status {$.status_css}">{$.status}</span><div class="raid_controller"><div class="view_buttons"><a class="inlineButton brown8 stop"><span>{g_js_strings.modal_auto_attack.stop}</span></a><a class="inlineButton brown8 resume"><span>{g_js_strings.modal_auto_attack.resume}</span></a><a class="inlineButton brown8 edit"><span>{g_js_strings.commonstr.edit}</span></a><a class="inlineButton brown8 delete"><span>{g_js_strings.commonstr.deletetx}</span></a></div><div class="edit_buttons"><a class="inlineButton blue11 save"><span>{g_js_strings.commonstr.save}</span></a><a class="inlineButton brown11 cancel"><span>{g_js_strings.commonstr.cancel}</span></a></div></div></div><div class="information clearfix"><div class="details"><div><span class="detail_title">{g_js_strings.commonstr.coordinates}:</span> <span class="coordinates_label">{$.cityMarches.toXCoord}, {$.cityMarches.toYCoord}</span><div class="coordinates_editor"><div class="manual_input"><span>X = <input value="{$.cityMarches.toXCoord}" /></span><span>Y = <input value="{$.cityMarches.toYCoord}" /></span><a>{g_js_strings.modal_attack.dord}{g_js_strings.modal_attack.selbookmark}</a></div><div class="select_bookmarks"><select><option value="0">{g_js_strings.modal_attack_target_dropdown.choosebookmark}</option></select><a>{g_js_strings.modal_attack.dord}{g_js_strings.modal_attack.inpcoor}</a></div></div></div><div><span class="detail_title">{g_js_strings.commonstr.knight}:</span> <span class="knight_name">{$.knight_name}</span><select class="knight_selector"><option>1</option></select></div><div><span class="detail_title">{g_js_strings.modal_auto_attack.roundtrip}:</span> <span class="round_trip">{$.round_trip}</span></div><div class="last_march"><span class="detail_title">{g_js_strings.modal_auto_attack.lastmarch}:</span> {$.last_march}</div></div><!-- .details --><div class="troops"><div>{$.troops}</div></div><!-- .troops --></div><!-- .information --><div class="glass_pane"></div></div><!-- end of .raid -->',
        "queue[*].troops[*]": '<div class="troop_info"><div class="icon"><img src="{site_image_url}img/units/unit_{$.type_id}_30.png" /></div><div class="details"><div class="type_label">{$.type}</div><div class="quantity"><span class="editor"><input name="{$.type_id}" /> <span>/ {$.stock}</span></span><span class="label">{$.quantity}</span></div></div></div>',
        options: '<div class="autoattack_options" id="{$.htmlElementIdBase}"><div class="option_section troop_option"><p class="title">{g_js_strings.modal_auto_attack.troopoptions}</p><div class="option_input_block no_auto_refill"><input type="radio" name="replenish_radio" id="{$.htmlElementIdBase}_noreplenish" class=""/><div class="option_description"><label for="{$.htmlElementIdBase}_noreplenish">{g_js_strings.modal_auto_attack.autostopraid}</label><select class="settings_input" id="{$.htmlElementIdBase}_pausePct" name="pausePct"><option value="100">100%</option><option value="90">90%</option><option value="75">75%</option><option value="50">50%</option></select><p class="message">{g_js_strings.modal_auto_attack.autostopraiddescription}</p></div></div><div class="option_input_block auto_refill"><input type="radio" name="replenish_radio" id="{$.htmlElementIdBase}_replenish" class=""/><div class="option_description"><label for="{$.htmlElementIdBase}_replenish">{g_js_strings.modal_auto_attack.autorefilltroop}</label><div class="option_input_block"><input type="checkbox" name="noreplenish_when_lost" id="{$.htmlElementIdBase}_noreplenish_when_lost" class=""/><div class="option_description"><label for="{$.htmlElementIdBase}_noreplenish_when_lost">{g_js_strings.modal_auto_attack.autorefilltroopexception}</label></div></div><p class="message">{g_js_strings.modal_auto_attack.autorefilltroopdescription}</p></div></div></div><div class="option_section"><p class="title">{g_js_strings.modal_auto_attack.reportoptions}</p><p class="message">{g_js_strings.modal_auto_attack.reportlifetimedescription}</p><div class="option_input_block"><input type="checkbox" name="autoDelReport" id="{$.htmlElementIdBase}_autoDelReport" class=""/><div class="option_description"><label for="{$.htmlElementIdBase}_autoDelReport">{g_js_strings.modal_auto_attack.autodeleteallreport}</label></div></div></div><div class="button_row"><a class="inlineButton brown20"><span>{g_js_strings.commonstr.saveandclose}</span></a></div></div>'
    },
    autoAttack_34: {
        self: '<div id="modal_rallypoint_autoattack" style="display: none;" class="autoattack_manager"><div class="countdown"></div><div class="header"><div class="start_button"></div><div class="title">{g_js_strings.modal_auto_attack.restartraidtimer}</div><img src="{site_image_url}img/1pixel.png" usemap="#map_autoattack{instance_guid}" /><map name="map_autoattack{instance_guid}"><area shape="polygon" coords="0,0,252,0,236,29,16,29" href="#" /></map><div class="options_button"><a class="inlineButton brown20"><span>{g_js_strings.commonstr.options}</span></a></div><div class="whats_a_barbraid"><a>{g_js_strings.modal_auto_attack.whatisabarbarianraid}</a></div></div><div class="global_controller"><div class="num_city">{city_name}<span>{city_number}</span></div><div class="raids_manupulate"><a class="inlineButton brown20 addraid"><span>+ {g_js_strings.modal_auto_attack.addraid}</span></a></div><div class="raids_bulk_controller"><a class="inlineButton brown20"><span class="stopAll">{g_js_strings.modal_auto_attack.stopall}</span></a><a class="inlineButton brown20"><span class="resumeAll">{g_js_strings.modal_auto_attack.resumeall}</span></a></div></div><div class="glass_pane"></div><div class="main"><div class="raids"><div class="add_raid_message">{g_js_strings.modal_auto_attack.youdonothaveanysavedraids}. <a>{g_js_strings.modal_auto_attack.addaraid}</a> {g_js_strings.modal_auto_attack.now}.</div></div><div class="glass_pane"></div></div></div>',
        "queue[*]": '<div class="raid"><div class="raid_title"><span class="toggler"></span>{g_js_strings.commonstr.barbariancamp} {g_js_strings.commonstr.lvl} {$.cityMarches.toTileLevel} <span class="coordinates">({$.cityMarches.toXCoord}, {$.cityMarches.toYCoord})</span> - <span class="status {$.status_css}">{$.status}</span><div class="raid_controller"><div class="view_buttons"><a class="inlineButton brown8 stop"><span>{g_js_strings.modal_auto_attack.stop}</span></a><a class="inlineButton brown8 resume"><span>{g_js_strings.modal_auto_attack.resume}</span></a><a class="inlineButton brown8 edit"><span>{g_js_strings.commonstr.edit}</span></a><a class="inlineButton brown8 delete"><span>{g_js_strings.commonstr.deletetx}</span></a></div><div class="edit_buttons"><a class="inlineButton blue11 save"><span>{g_js_strings.commonstr.save}</span></a><a class="inlineButton brown11 cancel"><span>{g_js_strings.commonstr.cancel}</span></a></div></div></div><div class="information clearfix"><div class="details"><div><span class="detail_title">{g_js_strings.commonstr.coordinates}:</span> <span class="coordinates_label">{$.cityMarches.toXCoord}, {$.cityMarches.toYCoord}</span><div class="coordinates_editor"><div class="manual_input"><span>X = <input value="{$.cityMarches.toXCoord}" /></span><span>Y = <input value="{$.cityMarches.toYCoord}" /></span><a>{g_js_strings.modal_attack.dord}{g_js_strings.modal_attack.selbookmark}</a></div><div class="select_bookmarks"><select><option value="0">{g_js_strings.modal_attack_target_dropdown.choosebookmark}</option></select><a>{g_js_strings.modal_attack.dord}{g_js_strings.modal_attack.inpcoor}</a></div></div></div><div><span class="detail_title">{g_js_strings.commonstr.knight}:</span> <span class="knight_name">{$.knight_name}</span><select class="knight_selector"><option>1</option></select></div><div><span class="detail_title">{g_js_strings.modal_auto_attack.roundtrip}:</span> <span class="round_trip">{$.round_trip}</span></div><div class="last_march"><span class="detail_title">{g_js_strings.modal_auto_attack.lastmarch}:</span> {$.last_march}</div></div><!-- .details --><div class="troops"><div>{$.troops}</div></div><!-- .troops --></div><!-- .information --><div class="glass_pane"></div></div><!-- end of .raid -->',
        "queue[*].troops[*]": '<div class="troop_info"><div class="icon"><img src="{site_image_url}img/units/unit_{$.type_id}_30_s34.jpg" /></div><div class="details"><div class="type_label">{$.type}</div><div class="quantity"><span class="editor"><input name="{$.type_id}" /> <span>/ {$.stock}</span></span><span class="label">{$.quantity}</span></div></div></div>',
        options: '<div class="autoattack_options" id="{$.htmlElementIdBase}"><div class="option_section troop_option"><p class="title">{g_js_strings.modal_auto_attack.troopoptions}</p><div class="option_input_block no_auto_refill"><input type="radio" name="replenish_radio" id="{$.htmlElementIdBase}_noreplenish" class=""/><div class="option_description"><label for="{$.htmlElementIdBase}_noreplenish">{g_js_strings.modal_auto_attack.autostopraid}</label><select class="settings_input" id="{$.htmlElementIdBase}_pausePct" name="pausePct"><option value="100">100%</option><option value="90">90%</option><option value="75">75%</option><option value="50">50%</option></select><p class="message">{g_js_strings.modal_auto_attack.autostopraiddescription}</p></div></div><div class="option_input_block auto_refill"><input type="radio" name="replenish_radio" id="{$.htmlElementIdBase}_replenish" class=""/><div class="option_description"><label for="{$.htmlElementIdBase}_replenish">{g_js_strings.modal_auto_attack.autorefilltroop}</label><div class="option_input_block"><input type="checkbox" name="noreplenish_when_lost" id="{$.htmlElementIdBase}_noreplenish_when_lost" class=""/><div class="option_description"><label for="{$.htmlElementIdBase}_noreplenish_when_lost">{g_js_strings.modal_auto_attack.autorefilltroopexception}</label></div></div><p class="message">{g_js_strings.modal_auto_attack.autorefilltroopdescription}</p></div></div></div><div class="option_section"><p class="title">{g_js_strings.modal_auto_attack.reportoptions}</p><p class="message">{g_js_strings.modal_auto_attack.reportlifetimedescription}</p><div class="option_input_block"><input type="checkbox" name="autoDelReport" id="{$.htmlElementIdBase}_autoDelReport" class=""/><div class="option_description"><label for="{$.htmlElementIdBase}_autoDelReport">{g_js_strings.modal_auto_attack.autodeleteallreport}</label></div></div></div><div class="button_row"><a class="inlineButton brown20"><span>{g_js_strings.commonstr.saveandclose}</span></a></div></div>'
    },
    DailyRewards: {
        openMain: '<div id="dailyRewardModalContainer"><div class="title">#{title}</div><p class="notification">#{notification}</p><p class="itemNotification"><span style="color: red;">#{itemName}</span>#{itemNotification}</p><div class="dailyRewardInfoContainer"><ul>#{rewardInfoHtml}</ul><div id="progressBarContainer" class="progressBarContainer"><div id="dailyRewardProgress" style="width: #{progressBar}%"></div></div></div><div class="shareContainer"><input type="checkbox" id="shareDailyRewardCheck" /><span class="label">#{shareLabel}</span></div><a id="dailyRewardModalButton"><span>#{button}</span></a></div>',
        rewardInfo: '<li class="#{rewardStatus} item#{position}"><div class="label"><span class="day">#{dayLabel} <br/> #{dayCount}</span><span class="check #{checkStatus}"></span></div><div class="rewardImage #{itemId}"></div></li>'
    },
    reinforcedReport101: {
        self: '<div class="reinforceReport"><div class="reportHeader"><div class="reportTitle">{PRESENTATION_MODEL.reinforcementreceived}</div><div class="reportSubtitle"><span class="cityNumber">{city.number}</span> {city.name} {date}</div></div><div class="helpSection"><img src="{stimgurl}img/scenes_reinforcement.jpg" width="408" height="216" />{PRESENTATION_MODEL.note}<ul style="height: 23px;"><li class="sendTroopsHome"><a name="reinforceReportSendTroopsHomeButton" class="inlineButton brown20"><span>{PRESENTATION_MODEL.sendtroopshome}</span></a></li><li class="backToReports"><a name="reinforceReportBackButton" class="inlineButton blue20"><span>{PRESENTATION_MODEL.backtoreports}</span></a></li></ul></div><div class="detailSection"><div class="memberLabel">{PRESENTATION_MODEL.alliancemember}</div><div class="allianceInformation">{member.name} ({member.cordx}, {member.cordy})</div><div class="reinforcedLabel">{PRESENTATION_MODEL.reinforcedyouwith}</div>{reinforced_troops}</div></div>',
        reinforced_troops: '<div><ul class="troopsTitleRow"><li class="typeColumn">{PRESENTATION_MODEL.troops}</li><li class="numberColume">{PRESENTATION_MODEL.number}</li></ul>{$}</div>',
        "reinforced_troops[*]": '<ul class="troopsRow"><li class="typeColumn"><img src="{stimgurl}img/units/unit_{$.unitid}_30_s34.jpg" /> {$.unitname}</li><li class="numberColume">{$.reinforced}</li></ul>'
    },
    Building: {
        openBuilding: '<div class="buildingFrame"><div class="titleContainer"><span class="title"> #{title} </span><a id="buildingCloseButton" class="close"> close </a></div><div class="buildingContainer"><div class="buildingInfoContainer"><div class="imageContainer"><div class="image b#{buildingId}"></div></div><div class="actionContainer"><div class="destroyContainer">#{buttons}</div><p class="buildingDescription"> #{buildingDescription} </p>#{buildContainer}</div><div class="upgradeContainer"><div class="requirementContainer"><span class="">#{requirementLabel}</span><div class="requirementTableContainer"><span class="top"></span><div class="body"><table><tr><th>Resource</th><th>Required</th><th>You Own</th></tr>#{requirementRows}</table></div><span class="bottom"></span></div></div>#{benefitsContainerHTML}</div></div><div class="requirementInfoContainer">#{craft}</div></div></div>',
        benefitsContainer: '<div class="benefitsContainer"><span>#{benefitLabel}</span><div class="currentLevel"><span class="label">#{currentLevelLabel}</span><span class="level">#{currentLevelValue}</span><p class="description">#{currentLevelHint}</p></div><div class="arrow"> arrow </div><div class="nextLevel"><span class="label">#{nextLevelLabel}</span><span class="level">#{nextLevelValue}</span><p class="description">#{nextLevelHint}</p></div></div>',
        benefitsContainerMax: '<div class="benefitsContainerMax"><span>#{benefitLabel}</span><div class="currentLevel"><span class="label">#{currentLevelLabel}</span><span class="level">#{currentLevelValue}</span><p class="description">#{currentLevelHint}</p></div></div>',
        buildContainer0: '<div class="buildContainer">#{info}<div class="buildActionContainer"><div class="share"><input type="checkbox" id="askHelpCheckbox" /><p>Share a message to your wall and alliance chat asking for help reducing your build or research time.</p></div><a id="buildingBuildButton" class="#{buttonClass}"> <span> #{buttonLabel} </span> </a></div></div>',
        buildContainer1: '<div class="buildContainer"><p class="requirement"> #{warning} </p><div class="buildActionContainer"><div class="share"><input type="checkbox" id="askHelpCheckbox" /><p> #{shareContent} </p></div><a id="buildingBuildButton" class="#{buttonClass}"> <span> #{buttonLabel} </span> </a></div></div>',
        buildContainer2: '<div class="buildContainer"><div class="timeLeftContainer"><span class="label"> #{timeLabel}:</span><span id="upgradeTimeLeft">  00m 00s </span><a id="buildingCancelButton" onclick=\'cancelConstruction(#{curlv},#{slotid},#{curlv});\'> <span> #{cancelLabel} </span> </a></div><div class="buildActionContainer"><a id="buildingSpeedButton" class="speed"> <span> #{speedLabel} </span> </a><a id="buildingAskButton" class="ask"> <span> #{askLabel} </span> </a></div></div>',
        craftFailure: '<div class="craftFailure"><div class="item item#{itemId}_70"><span class="item#{itemId}_70"></span><span class="frame"></span></div><div class="content"><span class="title">#{failure}</span></div></div>'
    },
    ChangeDomain: {
        imageRotator: '<div class="image_rotator"><div id="domainChangeRotated" class="image_rotated"></div><div id="domainChangePager" class="pager clearfix"></div></div>',
        domainSelector: '<div class="domain_container clearfix"><h2>#{enterYourDomainText}</h2><div class="filter"><label for="changeDomainFilterBy">#{filterByText}</label><select id="changeDomainFilterBy">#{filterOptions}</select></div><table class="domain_selector clearfix"><thead class="fixed_header"><tr>#{tableHeader}</tr></thead><tbody><tr><td colspan="6"><div id="serverIds" class="scroll_content"><table><tbody>#{tableBody}</tbody></table></div></td></tr></tbody></table><div class="legend clearfix"><div class="domain_types tournament_types"><!--<div class="type classic"><span class="title">#{classicText}</span> - #{classicDescription}</div><!--<div class="type enhanced"><span class="title">#{enhancedText}</span> - #{enhancedDescription}</div>--><div class="type new"><span class="title">#{newText}</span> - #{newDescription}</div><div class="type glory"><span class="title">#{gloryText}</span> - #{gloryDescription}</div><div class="type might"><span class="title">#{mightText}</span> - #{mightDescription}</div></div><div class="action_buttons">#{actionButtons}</div></div></div>',
        domainRow: '<tr id="serverId_#{serverId}" class="#{selected}"><td class="radio"></td><td class="domain"><div class="type #{domainType}">&nbsp;</div><div class="type #{tournamentType}">&nbsp;</div><div class="domain_name">#{domainName}</div></td><td class="lord">#{name}</td><td class="might">#{might}</td><td class="friends"><div class="friend">#{friends}</div></td><td class="lastVisit">#{lastVisit}</td></tr>'
    },
    SalesPromotion: {
        saleBody: '<div class="title">#{title}</div><div class="discount"><img class="discountImg" src="img/items/100/#{saleImageId}.png" /><div class="discountText"><h3 class="info">#{header}</h3><h2 class="red">#{discountAmount}</h2></div></div><div class="itemsTitle">#{itemsHeader}</div><div class="items"><ul>#{itemList}</ul></div><div class="timeLeft">#{timeLeftString} <span id="salesPromoModalCountdown" class="red">#{timeLeftAmount}</span></div><div class="button">#{buttonString}</div>',
        saleRewardItem: '<li class="itemSlot clearfix"><div class="itemContent"><img class="rewardImg" src="img/items/70/#{itemId}.jpg" /><div class="rewardText">#{itemName} x#{itemAmount}</div></div></li>'
    },
    AutoAttackReportsView: {
        autoAttackReports: '<div class="barbReports"><div class="dailySummaryTitle">#{dailySummaryTitle}</div><img src="" alt="" class="castleIcon"></img><div class="cityName">#{cityName}</div><div class="blockTitle">#{totalRaidsSent}</div><div class="blockTitle">#{totalRaidsWon}</div><div class="blockTitle">#{totalRaidsLost}</div><div class="warning">#{warning}</div><table class="totalLoot"><tr><td colspan="2">#{totalLoot}</td></tr><tr><td class="gold"></td><td>#{gold} #{goldValue}</td></tr><tr><td class="food"></td><td>#{food} #{foodValue}</td></tr><tr><td class="wood"></td><td>#{wood} #{woodValue}</td></tr><tr><td class="stone"></td><td>#{stone} #{stoneValue}</td></tr><tr><td class="ore"></td><td>#{ore} #{oreValue}</td></tr></table></div>',
        test: "<div></div>"
    },
    Throne: {
        mainThrone: '<div id="throneMainContainer"><div id="throneItemContainer"></div><div id="throneInfoContainer"><div id="throneInfoContent" class="infoContainer"><div id="throneInventoryContainer" class="inventoryContainer"><ul id="throneInventoryList"></ul></div><div id="throneStatContainer" class="statContainer"><ul id="throneStatList"></ul><div class="stats"><ul id="throneStatDisplay"></ul></div></div></div><ul class="tabNavigation"><li id="throneInventoryTab" class="inactive"> Inventory </li><li id="throneStatTab" class="inactive"> Stats </li></ul></div><div id="thronePanelContainer"></div></div>',
        throneInfo: '<div id="throneInfoContainer"><ul><li>Inventory</li><li>Bonus Stats</li></ul><div id="throneInventoryContainer"></div><div id="throneStatContainer"></div></div>',
        thronePanel: '<div class="thronePanelContainer"><div class="navigation"><ul class="tabsv2"><li class="selected"> Enhance </li><li> Upgrade </li></ul><a id="thronePanelSlideArrow" class="slideArrow"></a></div><div class="thronePanelInfoContainer"><div class="instructions"><ul id="thronePanelInstructions"><li>Do you see any Teletubbies in here? Do you see a slender plastic tag clipped to my shirt with my name printed on it? Do you see a little Asian child with a blank expression on his face sitting outside on a mechanical helicopter that shakes when you put quarters in it? No? Well, that\'s what you see at a toy store. And you must think you\'re in a toy store, because you\'re here shopping for an infant named Jeb.</li><li>Now that there is the Tec-9, a crappy spray gun from South Miami. This gun is advertised as the most popular gun in American crime. Do you believe that shit? It actually says that in the little book that comes with it: the most popular gun in American crime. Like they\'re actually proud of that shit. </li><li>The path of the righteous man is beset on all sides by the iniquities of the selfish and the tyranny of evil men. Blessed is he who, in the name of charity and good will, shepherds the weak through the valley of darkness, for he is truly his brother\'s keeper and the finder of lost children. And I will strike down upon thee with great vengeance and furious anger those who would attempt to poison and destroy My brothers. And you will know My name is the Lord when I lay My vengeance upon thee.</li><li>Look, just because I don\'t be givin\' no man a foot massage don\'t make it right for Marsellus to throw Antwone into a glass motherfuckin\' house, fuckin\' up the way the nigger talks. Motherfucker do that shit to me, he better paralyze my ass, \'cause I\'ll kill the motherfucker, know what I\'m sayin\'?</li></ul></div><div class="thronePanelItemContainer"><div class="thronePanelItemInfoContainer"><!--<div class="imageContainer"><div class="image"><img id="thronePanelPortrait" src="img/throne/icons/100/britton/common_britton_advisor_1.png"/></div></div>--><div id="thronePanelName" class="name common">Common Throne of Leadership +1</div><div class="statsContainer"><div class="currentStat"><span> Current </span><ul id="thronePanelStat1"><li>stat 1 100%</li><li>stat 1 100%</li><li>stat 1 100%</li><li>stat 1 100%</li><li>stat 1 100%</li></ul></div><span class="arrow"></span><div id="nextStatContainer" class="nextStat"><span> Next </span><ul id="thronePanelStat2"><li>stat 1 100%</li><li>stat 1 100%</li><li>stat 1 100%</li><li>stat 1 100%</li><li>stat 1 100%</li></ul></div></div><div class="progressBarContainer"><ul id="thronePanelProgressBarList"><!--<li class="simple">simple</li><li class="common">common</li><li class="uncommon">uncommon</li><li class="rare">rare</li><li class="epic">epic</li><li class="wondrous">wonderous</li><li class="unique last">unique</li>--></ul></div></div><div class="thronePanelItemRequirementsContainer" id="thronePanelItemRequirementsContainer"><div class="title"> Requirements </div><div class="costContainer"><select id="costDropDown"><option>Aetherstones</option><option>Gems</option></select><div id="thronePanelCostIcon" class="icon"> icon 1 </div><div id="thronePanelCostPrice" class="price"> Aetherstones <br/> 50/50 </div></div><div class="buffContainer"><select id="buffDropDown"><option>Buff 1</option><option>Buff 2</option></select><div id="thronePanelBuffIcon" class="icon"> buff 1 </div><div id="thronePanelBuffPrice" class="price"> 400 </div></div><div class="riskContainer"><div class="title"> Success Rate </div><div id="thronePanelRiskBarContainer" class="riskBarContainer active"><div id="thronePanelRiskBar" class="riskBar active"></div></div><span class="low">Low</span><span class="high">High</span></div><a class="gemButtonv2 green"> Enhance <span>100</span> </a></div></div></div></div>',
        brokenPanel: '<div id="thronePanelBrokenContainer"><div class="infoContainer"><div class="imageContainer"><div class="fail"></div><img src="#{src}" /></div><div class="info"><span class="name #{quality}"> #{name} </span><ul>#{stats}</ul></div></div><div class="timeContainer"><div class="title">#{title}</div><div class="time"><div id="thronePanelBrokenTimeBar" class="bar"></div><div class="labelContainer"><div class="label"> #{labelTimeRemaining}: <span id=\'thronePanelBrokenTime\'>#{time}</span></div></div></div><div id=\'thronePanelBrokenActions\' class="action"><div class="instantContainer"><span class="gems"> #{cost} </span><a id="thronePanelBrokenInstantButton" class="buttonv2 h30 green"> #{labelInstantRepair} </a></div><div class="startContainer"><span class="time">#{time}</span><a id="thronePanelBrokenRepairButton" class="buttonv2 h30 blue"> #{labelStartRepair} </a></div></div></div></div>'
    },
    Crafting: {
        openCrafting: '<div class="craftFrame"><div class="titleContainer"><span class="title"> #{title}</span></div><div class="craftContainer"><div class="navigationContainer"><ul id="recipeNavigationList"><li onclick="cm.CraftingView.changeCraftingCategory(1, this);" class="selected"> #{tabGeneral} </li><li onclick="cm.CraftingView.changeCraftingCategory(3, this);"> #{tabCombat} </li></ul></div><div class="craftDisplay"><div class="recipesContainer"><ul id="recipesList">#{recipesList}</ul></div><div class="displayContainer"><div class="insuranceContainer"><div class="label"> #{insuranceLabel} </div><span id="recipeRateIndicator" class="rate #{failureRate}"> #{failureRate} </span><div class="insuranceInfo"><input type="checkbox" id="insuranceCheckbox" /><div class="cost"><span class="label"> Insurance </span><span class="amount" id="recipeInsuranceAmount"> #{insurancePrice} </span></div><p> #{insuranceHint} </p></div></div><ul id="ingredientsList">#{ingredientsList}</ul><div class="output item"><span id="itemFrame" class="frame"></span><span id="recipeOutputItem" class="item#{outputItem}_70 outputItem"> output </span><span id="recipeConsolationItem" class="consolation item#{consolationItem}_30"> consolation </span></div><div class="buttonContainer"><a id="recipeCraftButton" class="gemButton #{craftButtonType}"> Craft </a></div></div></div></div></div>'
    },
    Shop: {
        openShop: "<div id='shopModalContainer'><div id='shopModalHeader'><a class='button20' onclick='Modal.hideModalAll(); cm.InventoryView.openInventory();'><span> #{getmoreitemsString} </span></a><div id='gemsContainer'><span class='label'> #{gemsString} </span><span id='shopGemQuantity' class='gemsQuantity'> #{gemsAmount} </span><img src='img/gem.png' /><a class='buttonGreen20' onclick='cm.ConversionTracker.track(\"payments\", \"MORE_GEMS_MY_ITEMS\", \"\"); modal_getgems();return false;'><span> + #{getmoregemsString} </span></a></div></div><div id='shopModalBody'><div id='shopTabs'><ul><li id='shopTab0'><a onclick='cm.ShopView.openTab(0); return false;'> #{featuredString} </a></li><li id='shopTab1'><a onclick='cm.ShopView.openTab(1); return false;'> #{generalString} </a></li><li id='shopTab2'><a onclick='cm.ShopView.openTab(2); return false;'> #{speedupString} </a></li><li id='shopTab3'><a onclick='cm.ShopView.openTab(3); return false;'> #{combatString} </a></li><li id='shopTab4'><a onclick='cm.ShopView.openTab(4); return false;'> #{resourcesString} </a></li><li id='shopTab5'><a onclick='cm.ShopView.openTab(5); return false;'> #{chestString} </a></li><li id='shopTab6'><a onclick='cm.ShopView.openTab(6); return false;'> #{courtString} </a></li></ul></div><div id='shopMessage'></div><div id='shopBanner' class='#{className}'>#{bannerHTML}</div><div id='shopItemsContainer'><a id='shopPrevPageButton' onclick='cm.ShopView.goPrevPage();'></a><a id='shopNextPageButton' onclick='cm.ShopView.goNextPage();'></a><ul id='shopItemsContainerList'></ul></div></div></div>",
        shopItem: "<li><div id='item#{id}' class='item #{className}' name=\"#{description}\" onmouseover='cm.ShopView.showItemTooltip(this, event);' onmouseout='removeTooltip();'><div class='name'>#{name}</div><div class='info'><img src='#{img}' /><div class='costContainer'>#{costContent}</div><div class='ownedContainer'><span class='label'>#{ownedString}:</span><span id='item#{id}Count'>#{count}</span></div><a class='buttonGreen20' onclick='cm.ShopController.buy(#{id});'><span id='item#{id}ButtonText'>#{buyString}</span></a></div></div></li>",
        getMoreGems: '<div id="getGemsModalContainer"><p>#{content1}</p><p>#{content2}</p><div class="buttonContainer"><a class="buttonGreen20" onclick="Modal.hideModal(); modal_getgems(); return false;"><span>#{getMoreGemsString}</span></a></div></div>'
    },
    MapProfile: {
        mapPortal: '<div id="mapprofilePortalContainer"><p class="notification"> #{notification} </p><div class="itemContainer"><div class="iconContainer"><img src="#{portalSrc}" /><span id="mapProfilePortalAmount"> #{portalQuantity}</span></div><div class="buyContainer"><span id="mapProfileGemAmount">#{gemAmount}</span><a id="mapProfileBuyButton" onclick="teleport_modal_buy();" class="inlineButton blue14"><span>#{buyLabel}</span></a></div><div class="label"> #{itemLabel} </div></div><div id="mapProfileErrorMessage"></div></div>'
    }
};

function showAchievementsPopup(b) {
    Modal.showModal(500, 500, 10, 10, g_js_strings.achievement.unlockTitle, "<div id='achievementPopup'></div>");
    var a = jQuery("#achievementPopup").css({
        paddingBottom: "1px"
    });
    b._each(function (f) {
        var d = "a" + f.id + "_" + f.level;
        var c = g_js_strings.achievement.unlockMessage.replace("REPLACE_NAME", g_js_strings.achievement[d]);
        c += " " + g_js_strings.achievement["s" + f.level];
        var e = jQuery("<div>" + c + "</div>").css({
            textAlign: "center",
            margin: "10px auto"
        });
        a.append(e);
        a.append(jQuery("<div>You received: </div>" + rewardListToHTML(seed.achievementStaticData[d].rewardList, true)))
    })
}

function showAchievementsWindow() {
    Modal.showModal(500, 500, 10, 10, g_js_strings.achievement.windowTitle, "<div id='achievementWindow' class='clearfix'></div>");
    var l_container = jQuery("#achievementWindow").css({
        paddingBottom: "1px",
        marginTop: "10px",
        paddingLeft: "10px"
    });
    var l_achievements = {};
    Object.values(seed.achievementStaticData)._each(function (a_achievement) {
        var l_achievementClass = "a" + a_achievement.id + "_" + a_achievement.level;
        var l_achievementContainer = jQuery("<div class='achievementContainer' id='" + l_achievementClass + "'></div>");
        l_achievementContainer.addClass(l_achievementClass).addClass("s" + a_achievement.level);
        l_achievements[l_achievementClass] = (new AchievementDisplay(l_achievementContainer, a_achievement));
        l_container.append(l_achievementContainer)
    });
    var l_params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/achievementStatus.php" + g_ajaxsuffix, {
        method: "post",
        parameters: l_params,
        onSuccess: function (a_response) {
            var l_result = eval("(" + a_response.responseText + ")");
            var l_achievementUpdateData = l_result.userAchievements;
            var l_achievementKeys = Object.keys(l_achievementUpdateData);
            l_achievementKeys._each(function (a_key) {
                l_achievements[a_key].update(l_achievementUpdateData[a_key])
            })
        }
    })
}

function makeElement(d, b, a) {
    var c = document.createElement(d);
    if (b) {
        jQuery(b).append(c)
    }
    if (a) {
        c.className = a
    }
    return c
}

function AchievementDisplay(b, a) {
    this.m_container = b;
    this.m_achievement = a;
    this.m_stringName = "a" + a.id + "_" + a.level;
    this.m_progressBarContainer = undefined;
    this.display()
}
AchievementDisplay.prototype.display = function () {
    var b = makeElement("div", this.m_container, "achievementBorder");
    makeElement("div", b, "achievmentImg").innerHTML = "IMG GOES HERE";
    this.m_progressBarContainer = makeElement("div", this.m_container, "progressBarContainer");
    var c = makeElement("div", this.m_container, "achievementName");
    c.innerHTML = g_js_strings.achievement[this.m_stringName];
    var a = this;
    jQuery(b).mouseover(function (d) {
        showTooltip(requirementListToHTML(a.m_achievement.requirementList) + requirementListToHTML(a.m_achievement.rewardList), this, d.originalEvent, "achievementWindow")
    }).mouseout(removeTooltip)
};
AchievementDisplay.prototype.update = function (a) {
    if (a.complete) {
        this.m_container.addClass("complete")
    } else {
        achievementPercentageBar(a.percentageComplete, this.m_container)
    }
};

function achievementPercentageBar(c, b) {
    var d = makeElement("div", b, "achievementPercentageBar");
    var a = makeElement("div", d, "achievementPercentageBarInner");
    jQuery(a).css({
        width: parseInt((100 * c)) + "%"
    })
}

function rewardListToHTML(c, a) {
    var b = "";
    c._each(function (d) {
        switch (d.type) {
        case "ItemReward":
            b += "<div>" + (a ? "" : "You will get ") + d.quantity + " X " + itemlist["i" + d.itemId].name + "</div>";
            if (a) {
                seed.items["i" + d.itemId] = parseInt(seed.items["i" + d.itemId]) + d.quantity;
                ksoItems[d.itemId].add(d.quantity)
            }
            break;
        default:
            break
        }
    });
    return b
}

function requirementListToHTML(a) {
    var b = "";
    a._each(function (c) {
        switch (c.type) {
        case "PvPWinRequirement":
            b += "<div>Winning " + c.PvPWins + " marches against a player</div>";
            break;
        default:
            break
        }
    });
    return b
};
if (!window.AddCity) {
    var AddCity = new Object()
}
AddCity.Properties = {
    c_new_city_strings: ["Second City", "Third City", "Fourth City", "Fifth City", "Sixth City", "Seventh City", "Fey City"],
    c_new_second_city_item: "i1202",
    c_new_city_deed: ["i1202", "i1203", "i1204", "i1205", "i1206", "i1207", "i1211"],
    c_new_city_deed_quest: ["q8002", "q8003", "q8004", "q8005", "q8006", "q8007", "q8008"],
    c_new_city_deed_items: {
        i1202: {},
        i1203: {
            i1101: 4,
            i1102: 2,
            i1103: 1
        },
        i1204: {
            i1103: 4,
            i1104: 3,
            i1105: 1
        },
        i1205: {
            i1106: 4,
            i1107: 3,
            i1108: 2
        },
        i1206: {
            i1109: 4,
            i1110: 3,
            i1111: 2
        },
        i1207: {
            i1112: 4,
            i1113: 3,
            i1114: 2
        },
        i1211: {
            i1115: 4,
            i1120: 3,
            i1121: 2
        }
    },
    c_new_city_deed_msg: [{
        noqual: g_js_strings.AddCity.noqualseconddeed,
        qual: g_js_strings.AddCity.qualseconddeed
    }, {
        noqual: g_js_strings.AddCity.noqualthirddeed,
        qual: g_js_strings.AddCity.qualthirddeed
    }, {
        noqual: g_js_strings.AddCity.noqualfourthdeed,
        qual: g_js_strings.AddCity.qualfourthdeed
    }, {
        noqual: g_js_strings.AddCity.noqualfifthdeed,
        qual: g_js_strings.AddCity.qualfifthdeed
    }, {
        noqual: g_js_strings.AddCity.noqualsixthdeed,
        qual: g_js_strings.AddCity.qualsixthdeed
    }, {
        noqual: g_js_strings.AddCity.noqualseventhdeed,
        qual: g_js_strings.AddCity.qualseventhdeed
    }, {
        noqual: g_js_strings.AddCity.noqualfeydeed,
        qual: g_js_strings.AddCity.qualfeydeed
    }],
    next_city_idx: 2,
    applyTId: 0,
    feError: {
        noMercChange: g_js_strings.AddCity.nochange,
        notEnoughGold: g_js_strings.AddCity.nogold,
        notValidNumber: g_js_strings.AddCity.validnumber
    }
};
AddCity.Methods = {
    startBuildProcess: function (a) {
        statusupdate();
        this.next_city_idx = seed.cities.length + 1;
        if (a) {
            this.applyTId = a
        }
        if (this.next_city_idx == 2) {
            this.secondCityModal()
        } else {
            this.otherCityModal()
        }
    },
    checkReq: function () {},
    recheckCoord: function (d) {
        var a = Element.extend(d);
        var c = a.select("option");
        for (var b = 0; b < c.length; b++) {
            if (isNaN(c[b].innerHTML.charAt(0))) {
                c[b].innerHTML = c[b].innerHTML.substring(1)
            }
            if (c[b].selected) {
                c[b].innerHTML = "&#10004;" + c[b].innerHTML
            }
        }
    },
    getPlainOptions: function () {
        var d = "<select id='plains_coord_box' class='selectbox' onchange='AddCity.recheckCoord(this);return false;'>";
        var a = getWildIds(currentcityid, 50);
        for (var c = 0; c < a.length; c++) {
            var e = false;
            var f = a[c].split("t")[1];
            if (this.applyTId != 0) {
                if (f == this.applyTId) {
                    e = true
                }
            } else {
                if (c == 0) {
                    e = true
                }
            }
            var b = seed.wilderness["city" + currentcityid][a[c]].xCoord + " , " + seed.wilderness["city" + currentcityid][a[c]].yCoord;
            d += '<option value="' + f + '" ' + ((e) ? "selected" : "") + ">" + ((e) ? ("&#10004;" + b) : b) + "</option>"
        }
        d += "</select>";
        return d
    },
    secondCityModal: function () {
        var a = (getWildIds(currentcityid, 50).length >= 1) ? true : false;
        var e = (seed.items[this.c_new_city_deed[this.next_city_idx - 2]] && parseInt(seed.items[this.c_new_city_deed[this.next_city_idx - 2]]) > 0) ? true : false;
        var d = (g_questcomp[this.c_new_city_deed_quest[this.next_city_idx - 2]] && parseInt(g_questcomp[this.c_new_city_deed_quest[this.next_city_idx - 2]]) >= 1) ? true : false;
        var f = (parseInt(seed.player.title) >= 7) ? true : false;
        var j = e && a && f;
        var b = "";
        var h = "";
        var c = {
            link_item_img: "<img src='" + stimgUrl + "img/items/70/" + this.c_new_city_deed[this.next_city_idx - 2].split("i")[1] + ".jpg' />",
            text_item_name: itemlist[this.c_new_city_deed[this.next_city_idx - 2]].name,
            text_item_count: (e) ? "1/1" : "0/1",
            text_item_class: "single"
        };
        b += getTemplate("addcity_secondcitymodal_item", c);
        if (j) {
            h += "<a class='button30Green' onclick='startCityBuild();return false;return false;'><span>";
            h += g_js_strings.commonstr.build;
            h += "</span></a>"
        } else {
            h += "<a class='button30Grey'><span>";
            h += g_js_strings.commonstr.build;
            h += "</span></a>"
        }
        var g = {
            text_to_build: g_js_strings.AddCity.tobuilda.replace("%1$s", this.c_new_city_strings[this.next_city_idx - 2]),
            text_get_deed: g_js_strings.AddCity.obtainadeed.replace("%1$s", this.c_new_city_strings[this.next_city_idx - 2]),
            text_second_deed_noqual_desc: this.c_new_city_deed_msg[this.next_city_idx - 2].noqual,
            text_second_deed_qual_desc: this.c_new_city_deed_msg[this.next_city_idx - 2].qual,
            text_invite: g_js_strings.commonstr.invite,
            text_shop: g_js_strings.commonstr.shop,
            lstring_item: b,
            text_lvl_qual: g_js_strings.AddCity.reachlvl,
            text_plains_qual: g_js_strings.AddCity.controlplain,
            text_view_map: g_js_strings.commonstr.viewmap,
            text_lvl_desc: g_js_strings.AddCity.nolvlqual,
            text_claim: g_js_strings.commonstr.claim,
            text_qid: this.c_new_city_deed_quest[this.next_city_idx - 2].split("q")[1],
            text_complete: g_js_strings.commonstr.completedexc,
            text_plains_noqual_desc: g_js_strings.AddCity.noplainqual,
            text_plains_qual_desc: g_js_strings.AddCity.selectplain,
            text_btn_string: h,
            lstring_map_coord: this.getPlainOptions()
        };
        var i = getTemplate("addcity_secondcitymodal", g);
        Modal.showModal(500, 580, 90, 10, g_js_strings.modaltitles.buildingnewcity, i);
        if (e) {
            $("qual_second_city_deed").className = "qualitem comp"
        } else {
            if (d) {
                $("qual_second_city_deed").className = "qualitem qual"
            } else {
                $("qual_second_city_deed").className = "qualitem noqual"
            }
        }
        if (f) {
            $("qual_lvl_7").className = "qualitem comp"
        } else {
            $("qual_lvl_7").className = "qualitem noqual"
        }
        if (a) {
            $("qual_plains").className = "qualitem comp"
        } else {
            $("qual_plains").className = "qualitem noqual"
        }
    },
    otherCityModal: function () {
        var a = (getWildIds(currentcityid, 50).length >= 1) ? true : false;
        var l = (seed.items[this.c_new_city_deed[this.next_city_idx - 2]] && parseInt(seed.items[this.c_new_city_deed[this.next_city_idx - 2]]) > 0) ? true : false;
        var d = (g_questcomp[this.c_new_city_deed_quest[this.next_city_idx - 2]] && parseInt(g_questcomp[this.c_new_city_deed_quest[this.next_city_idx - 2]]) >= 1) ? true : false;
        var f = l && a;
        var b = "";
        var j = "";
        if (l || d) {
            var c = {
                link_item_img: "<img src='" + stimgUrl + "img/items/70/" + this.c_new_city_deed[this.next_city_idx - 2].split("i")[1] + ".jpg' />",
                text_item_name: itemlist[this.c_new_city_deed[this.next_city_idx - 2]].name,
                text_item_count: (l) ? "1/1" : "0/1",
                text_item_class: "single"
            };
            b += getTemplate("addcity_secondcitymodal_item", c)
        } else {
            var g = this.c_new_city_deed_items[this.c_new_city_deed[this.next_city_idx - 2]];
            var m = Object.keys(g);
            for (var e = 0; e < m.length; e++) {
                var c = {
                    link_item_img: "<img src='" + stimgUrl + "img/items/70/" + m[e].split("i")[1] + ".jpg' />",
                    text_item_name: itemlist[m[e]].name,
                    text_item_count: (seed.items[m[e]] || 0) + "/" + g[m[e]],
                    text_item_class: "triple",
                    text_count_class: (seed.items[m[e]] && parseInt(seed.items[m[e]]) >= parseInt(g[m[e]])) ? "enough" : ""
                };
                b += getTemplate("addcity_secondcitymodal_item", c)
            }
        }
        if (f) {
            j += "<a class='button30Green' onclick='startCityBuild();return false;return false;'><span>";
            j += g_js_strings.commonstr.build;
            j += "</span></a>"
        } else {
            j += "<a class='button30Grey'><span>";
            j += g_js_strings.commonstr.build;
            j += "</span></a>"
        }
        var h = {
            text_to_build: g_js_strings.AddCity.tobuilda.replace("%1$s", this.c_new_city_strings[this.next_city_idx - 2]),
            text_get_deed: g_js_strings.AddCity.obtainadeed.replace("%1$s", this.c_new_city_strings[this.next_city_idx - 2]),
            text_other_deed_noqual_desc: this.c_new_city_deed_msg[this.next_city_idx - 2].noqual,
            text_other_deed_qual_desc: this.c_new_city_deed_msg[this.next_city_idx - 2].qual,
            text_shop: g_js_strings.commonstr.shop,
            lstring_item: b,
            text_lvl_qual: g_js_strings.AddCity.reachlvl,
            text_plains_qual: g_js_strings.AddCity.controlplain,
            text_view_map: g_js_strings.commonstr.viewmap,
            text_lvl_desc: g_js_strings.AddCity.nolvlqual,
            text_claim: g_js_strings.commonstr.claim,
            text_qid: this.c_new_city_deed_quest[this.next_city_idx - 2].split("q")[1],
            text_complete: g_js_strings.commonstr.completedexc,
            text_plains_noqual_desc: g_js_strings.AddCity.noplainqual,
            text_plains_qual_desc: g_js_strings.AddCity.selectplain,
            lstring_map_coord: this.getPlainOptions(),
            text_btn_string: j
        };
        var k = getTemplate("addcity_othercitymodal", h);
        Modal.showModal(500, 580, 90, 10, g_js_strings.modaltitles.buildingnewcity, k);
        if (l) {
            $("qual_other_city_deed").className = "qualitem comp"
        } else {
            if (d) {
                $("qual_other_city_deed").className = "qualitem qual"
            } else {
                $("qual_other_city_deed").className = "qualitem noqual"
            }
        }
        if (a) {
            $("qual_plains").className = "qualitem comp"
        } else {
            $("qual_plains").className = "qualitem noqual"
        }
    }
};
Object.extend(AddCity, AddCity.Methods);
Object.extend(AddCity, AddCity.Properties);

function modal_addcityhelp() {
    AddCity.startBuildProcess()
}

function startCityBuild() {
    modal_wilderness_buildcity($("plains_coord_box").value, currentcityid)
}

function modal_wilderness_buildcity_citybuildcheck(c, h) {
    var l = Object.keys(seed.queue_atkp);
    var e = false;
    var n = [0, 0, 0, 0, 0];
    var b = 0;
    for (var f = 0; f < l.length; f++) {
        var g = Object.keys(seed.queue_atkp[l[f]]);
        for (var d = 0; d < g.length; d++) {
            var m = seed.queue_atkp[l[f]][g[d]];
            if (parseInt(m.toXCoord) == parseInt(c) && parseInt(m.toYCoord) == parseInt(h) && parseInt(m.marchStatus) == 2) {
                b += parseInt(m.unit1Count);
                n[0] += parseInt(m.gold);
                for (var a = 1; a < 5; a++) {
                    n[a] += parseInt(m["resource" + a])
                }
            }
        }
    }
    if (b >= 250 && n[0] >= 10000 && n[1] >= 10000 && n[2] >= 10000 && n[3] >= 10000 && n[4] >= 10000) {
        return true
    }
    return false
}

function modal_wilderness_buildcity(b, c) {
    var a = new Array();
    a.push("<div id='modal_wilderness_newcitydiv'>");
    a.push("<div class='nmttl'>" + g_js_strings.modal_wilderness_buildcity.namecity + "</div>");
    a.push("<div class='nmipt'><input type='text' id='modal_wilderness_newcity_ipt' maxlength='15'/></div>");
    a.push("<div class='clearfix btns'><a  class='button20' onclick='modal_wilderness_buildcity_confirm(");
    a.push(b);
    a.push(",");
    a.push(c);
    a.push(");return false;'><span>" + g_js_strings.commonstr.ok + "</span></a><a  class='cancel' onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a></div>");
    a.push("</div>");
    Modal.showModal(500, 400, 120, 190, g_js_strings.modaltitles.namenewcity, a.join(""))
}

function modal_wilderness_buildcity_confirm(tileid, cityid) {
    var params = Object.clone(g_ajaxparams);
    params.tid = tileid;
    params.cid = cityid;
    params.cname = $("modal_wilderness_newcity_ipt").value;
    new Ajax.Request(g_ajaxpath + "ajax/buildCity.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                top.location = appUrl
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}
var cm = cm || {};
cm.cities = function (b) {
    var c = 1;
    var a = 8;
    return {
        setIndex: function (d) {
            c = d
        },
        max: function () {
            return a
        },
        selectedIndex: function () {
            return c
        }
    }
}(jQuery);
var cm = cm || {};
cm.AUTO_BARB_TROOP_MODE = {
    AUTO_BARB_TROOP_MODE_STOP_ON_PERCENTAGE_LOST: 0,
    AUTO_BARB_TROOP_MODE_REFILL_ALWAYS: 1,
    AUTO_BARB_TROOP_MODE_REFILL_UNLESS_LOST_BATTLE: 2
};
cm.BOT_STATUS = {
    BOT_MARCH_UNDEFINED: 0,
    BOT_MARCH_MARCHING: 1,
    BOT_MARCH_RETURNING: 2,
    BOT_MARCH_STOPPED: 3,
    BOT_MARCH_INSUFFICIENT_TROOPS: 4,
    BOT_MARCH_MAX_RAIDS_EXCEEDED: 5,
    BOT_MARCH_TIMED_OUT: 6,
    BOT_MARCH_RESTING: 7,
    BOT_MARCH_UNAVAILABLE_KNIGHT: 8,
    BOT_MARCH_RALLY_POINT_LIMIT_REACHED: 9,
    BOT_MARCH_STOPPING: 200
};
cm.MARCH_STATUS = {
    MARCH_STATUS_INACTIVE: 0,
    MARCH_STATUS_OUTBOUND: 1,
    MARCH_STATUS_DEFENDING: 2,
    MARCH_STATUS_STOPPED: 10,
    MARCH_STATUS_RESTING: 4,
    MARCH_STATUS_UNKNOWN: 5,
    MARCH_STATUS_SITUATIONCHANGED: 7,
    MARCH_STATUS_RETURNING: 8,
    MARCH_STATUS_ABORTING: 9
};
cm.MARCH_TYPES = {
    MARCH_TYPE_NONE: 0,
    MARCH_TYPE_TRANSPORT: 1,
    MARCH_TYPE_REINFORCE: 2,
    MARCH_TYPE_SCOUT: 3,
    MARCH_TYPE_ATTACK: 4,
    MARCH_TYPE_REASSIGN: 5,
    MARCH_TYPE_BARBARIAN: 6,
    MARCH_TYPE_MERCENARY: 7,
    MARCH_TYPE_BARBARIAN_REINFORCE: 8,
    MARCH_TYPE_BOT_BARBARIAN: 9,
    MARCH_TYPE_DARK_FOREST: 10,
    MARCH_TYPE_DARK_FOREST_SCOUT: 11
};
cm.TILE_TYPES = {
    TILE_TYPE_VOID: 0,
    TILE_TYPE_GRASSLAND: 10,
    TILE_TYPE_R1_1: 10,
    TILE_TYPE_LAKE: 11,
    TILE_TYPE_R1_2: 11,
    TILE_TYPE_WOODS: 20,
    TILE_TYPE_R2_1: 20,
    TILE_TYPE_HILLS: 30,
    TILE_TYPE_R3_1: 30,
    TILE_TYPE_MOUNTAIN: 40,
    TILE_TYPE_R4_1: 40,
    TILE_TYPE_PLAIN: 50,
    TILE_TYPE_CITY: 51,
    TILE_TYPE_RUIN: 52,
    TILE_TYPE_FOG: 53,
    TILE_TYPE_CAMELOT1: 101,
    TILE_TYPE_CAMELOT2: 102,
    TILE_TYPE_CAMELOT3: 103,
    TILE_TYPE_CAMELOT4: 104,
    TILE_TYPE_CAMELOT5: 105,
    TILE_TYPE_CAMELOT6: 106
};
cm.UNIT_TYPES = cm.UNIT_TYPES || {};
cm.WILDERNESS_TYPES = {
    GRASSLAND: 10,
    LAKE: 11,
    WOODS: 20,
    HILLS: 30,
    MOUNTAIN: 40,
    PLAIN: 50
};
cm.BUILDING_TYPES = {
    CASTLE: 0,
    FARM: 1,
    SAWMILL: 2,
    QUARRY: 3,
    MINE: 4,
    COTTAGE: 5,
    TAVERN: 6,
    KNIGHTS_HALL: 7,
    EMBASSY: 8,
    STOREHOUSE: 9,
    MARKET: 10,
    ALCHEMY_LAB: 11,
    RALLY_POINT: 12,
    BARRACK: 13,
    WATCH_TOWER: 14,
    BLACKSMITH: 15,
    WORKSHOP: 16,
    STABLE: 17,
    RELIEF_STATION: 18,
    WALL: 19
};
cm.SERVER_TYPES = {
    CLASSIC: 0,
    ENHANCED: 1,
    PREMIUM: 2
};
cm.CONTEST_TYPES = {
    CONTEST_TYPE_NONE: 0,
    CONTEST_TYPE_MIGHT: 1,
    CONTEST_TYPE_PLUNDER: 2,
    CONTEST_TYPE_CRESTS: 3,
    CONTEST_TYPE_ALL_RESOURCES: 4,
    CONTEST_TYPE_RESOURCE_GOLD: 5,
    CONTEST_TYPE_RESOURCE_FOOD: 6,
    CONTEST_TYPE_RESOURCE_WOOD: 7,
    CONTEST_TYPE_RESOURCE_STONE: 8,
    CONTEST_TYPE_RESOURCE_ORE: 9,
    CONTEST_TYPE_ALL_UNITS: 10,
    CONTEST_TYPE_UNIT_SUPPLYTROOP: 11,
    CONTEST_TYPE_UNIT_MILITIAMAN: 12,
    CONTEST_TYPE_UNIT_SCOUT: 13,
    CONTEST_TYPE_UNIT_PIKEMAN: 14,
    CONTEST_TYPE_UNIT_SWORDSMAN: 15,
    CONTEST_TYPE_UNIT_ARCHER: 16,
    CONTEST_TYPE_UNIT_CAVALRY: 17,
    CONTEST_TYPE_UNIT_HEAVY_CAVALRY: 18,
    CONTEST_TYPE_UNIT_SUPPLY_WAGON: 19,
    CONTEST_TYPE_UNIT_BALLISTA: 20,
    CONTEST_TYPE_UNIT_BATTERING_RAM: 21,
    CONTEST_TYPE_UNIT_CATAPULT: 22,
    CONTEST_TYPE_KNIGHT_EXPERIENCE: 23,
    CONTEST_TYPE_ALLIANCE_MIGHT: 24,
    CONTEST_TYPE_GLORY: 25
};
(function () {
    if (undefined === window.unitcost) {
        return
    }
    var e;
    var d;
    var a;
    var b;
    var c;
    for (e in unitcost) {
        d = e.split("unt");
        if (d.length < 2) {
            continue
        }
        if (!window.unitnamedesctranslated || unitnamedesctranslated[e] === undefined || unitnamedesctranslated[e].length < 2) {
            continue
        }
        b = unitnamedesctranslated[e];
        c = unitcost[e];
        c[0] = b[0];
        c[10] = b[1]
    }
})();
if (!window.AjaxCall) {
    var AjaxCall = new Object()
}
AjaxCall.Properties = {
    ajaxcall_data: null
};
AjaxCall.Methods = {
    gGetRequest: function (c, d, b, a) {
        this.gAjaxRequest(c, d, b, a, "get")
    },
    gPostRequest: function (c, d, b, a) {
        this.gAjaxRequest(c, d, b, a, "post")
    },
    gAjaxRequest: function (ajax_path, additional_params, handleSuccessCallback, handleFailureCallback, http_request_method) {
        var params = Object.clone(g_ajaxparams);
        if (additional_params) {
            Object.keys(additional_params).each(function (item) {
                params[item] = additional_params[item]
            })
        }
        new Ajax.Request(g_ajaxpath + ajax_path + g_ajaxsuffix, {
            method: http_request_method,
            parameters: params,
            onSuccess: function (message) {
                var rslt = eval("(" + message.responseText + ")");
                handleSuccessCallback(rslt)
            },
            onFailure: handleFailureCallback
        })
    }
};
Object.extend(AjaxCall, AjaxCall.Methods);
Object.extend(AjaxCall, AjaxCall.Properties);
var ajax = function (f) {
        var d = {
            lastSent: [],
            isSending: {},
            timeout: 5,
            loadingSymbolCounter: 0
        };

        function e(j, k) {
            d.params = k;
            d.options = {
                dataType: k.dataType || "json",
                type: k.method || k.type || "POST",
                url: j || "",
                data: k.parameters || k.data || "",
                success: h,
                error: b,
                complete: c,
                async: true,
                loading: k.loading || false
            }
        }

        function i(j) {
            if (0 == d.loadingSymbolCounter++) {
                f("body").append("<div class='spinnyLoading'></div>")
            }
            setTimeout(function () {
                a(j)
            }, 10000)
        }

        function a(j) {
            if (j.loading && (0 == --d.loadingSymbolCounter)) {
                f(".spinnyLoading").remove();
                j.loading = false
            }
            d.loadingSymbolCounter = Math.max(0, d.loadingSymbolCounter)
        }

        function g(j) {
            return d.isSending[j] ? true : false
        }

        function h(l, j, k) {
            if (k._params.onSuccess) {
                k._params.onSuccess({
                    responseText: JSON.stringify(l),
                    responseTextRaw: k.responseText
                })
            }
            if (k._params.next) {
                k._params.next(l)
            }
        }

        function b(k, j, n) {
            try {
                var m = k._params.onFailure || k._params.error ||
                function () {};
                m(k, j, n)
            } catch (l) {}
        }

        function c(k, j) {
            try {
                d.isSending[k._options.url] = false;
                a(k._options);
                if (k._params.onComplete) {
                    k._params.onComplete(k, j)
                }
            } catch (l) {}
        }
        return {
            Request: function (k, l) {
                if (!g(k)) {
                    d.isSending[k] = true;
                    d.lastSent[k] = unixtime();
                    e(k, l);
                    var j = f.ajax(d.options);
                    if (j) {
                        j._options = d.options;
                        j._params = d.params;
                        if (d.options.loading) {
                            i(j._options)
                        }
                    }
                } else {
                    cm.log.l("Prevented another ajax call, because we haven't received the response yet.")
                }
            }
        }
    }(jQuery);
var friendsInfo;
var arrSelectedFriends = new Object();
var strSelectedFriends = "";
var friendsButNotPlayers;
var existingPlayers_AI;
var arrSelectedFriends_AI = new Object();
var strSelectedFriends_AI = "";
var xfbmlFriendsList;
var allianceInviteLink;
var playerInfo;

function recommendFriendsModule() {
    var strHTML = "<div class='allianceInvite' style='height:300px'>";
    strHTML += "<div class='waiting'>";
    strHTML += "</div>";
    strHTML += "</div>";
    document.getElementById("allianceContent").innerHTML = strHTML;
    arrSelectedFriends = new Object();
    var params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/allianceGetFriendsSameServer.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                var strHTML = "<div id='divRecommendTopSection'><div class='clearfix recselplayers'><a class='buttonDown20' onclick='membersInfo();return false;'><span>" + g_js_strings.commonstr.back + "</span></a></div><div id='recommendActionResult'></div></div>";
                strHTML += "<div id='divFriends'><div class='recttl'>" + g_js_strings.recommendFriendsModule.recommendmember + "</div>";
                strHTML += "<div class='recbox clearfix'><div id='divFriendsInSameDomain'><div class='selfriendttl'>" + g_js_strings.recommendFriendsModule.selectfromfriend + "</div>";
                var strFriendsContent = "";
                if (rslt.friendsInfo) {
                    friendsInfo = rslt.friendsInfo;
                    strFriendsContent = "";
                    strMsg = g_js_strings.recommendFriendsModule.yourfriendsona.replace("%1$s", rslt.server);
                    for (friendId in friendsInfo) {
                        strFriendsContent += "<tr><td><input type='checkbox' id='chk_friend_" + friendId + "' onclick='selectedFriendsList(" + friendId + ',this,"friendsInfo")\'/></td><td>';
                        strFriendsContent += "<a href='https://www.facebook.com/profile.php?id=" + friendsInfo[friendId].fbuid + " target='_blank'><fb:profile-pic uid='" + friendsInfo[friendId].fbuid + "' size='q' linked='false'></fb:profile-pic></a>";
                        strFriendsContent += "</td><td><div class='fname'><a  onclick='getInfoForAnUser(\"" + friendId + "\");return false;'>" + friendsInfo[friendId].genderAndName + "</a> (<fb:name uid='" + friendsInfo[friendId].fbuid + "' linked='false'></fb:name>)</div></td></tr>"
                    }
                } else {
                    strMsg = g_js_strings.recommendFriendsModule.sorrynofriends
                }
                strHTML += "<div class='fdomainnm'>" + strMsg + "</div>";
                strHTML += "<div class='friendbox'><table cellpadding='0' cellspacing='0'>" + strFriendsContent;
                strHTML += "</table></div></div>";
                strHTML += "<div id='divSearchPlayer'><div class='searchttl'>" + g_js_strings.recommendFriendsModule.searchplayers + "</div>";
                strHTML += "<div class='searchbox clearfix'><input type='text' name='txtPlayerNameToSearch' id='txtPlayerNameToSearch'/>";
                strHTML += '<a  class=\'button20\' onclick=\'searchPlayersByName("txtPlayerNameToSearch","divMatchedPlayers","Select the players you want to recommend");return false;\'><span>' + g_js_strings.commonstr.search + "</span></a></div>";
                strHTML += "<div id='divMatchedPlayers'></div>";
                strHTML += "</div></div>";
                strHTML += "<div class='divselplayers'><div class='divSelPlayersTtl'><div>" + g_js_strings.recommendFriendsModule.selectedplayers + "</div></div><div id='divSelectedFriends'></div></div>";
                strHTML += "<div class='clearfix recselplayers'><a class='button20' onclick='recommendSelectedFriends();return false;'><span>" + g_js_strings.recommendFriendsModule.recselplayers + "</span></a><a class='buttonDown20' onclick='membersInfo();return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a></div></div>";
                document.getElementById("allianceContent").innerHTML = strHTML;
                FB.XFBML.Host.parseDomTree(document.getElementById("divFriendsInSameDomain"))
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function selectedFriendsList(friendId, chkBox, strSourceArray) {
    var strHTML = "";
    strSelectedFriends = "";
    if (chkBox.checked) {
        arrSelectedFriends[friendId] = eval(strSourceArray)[friendId].genderAndName
    } else {
        if (arrSelectedFriends[friendId]) {
            delete arrSelectedFriends[friendId]
        }
    }
    for (currentFriendId in arrSelectedFriends) {
        strHTML += "<div class='friend'>" + arrSelectedFriends[currentFriendId] + "</div>";
        strSelectedFriends += "," + currentFriendId
    }
    document.getElementById("divSelectedFriends").innerHTML = strHTML
}

function recommendSelectedFriends() {
    var message = "";
    if (strSelectedFriends.length > 0) {
        strSelectedFriends = strSelectedFriends.substring(1, strSelectedFriends.length)
    }
    var params = Object.clone(g_ajaxparams);
    params.memberList = strSelectedFriends;
    new Ajax.Request(g_ajaxpath + "ajax/allianceMemberRecommendations.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                if (rslt.duplicates) {
                    var arrDuplicateIds = (rslt.duplicates).split(",");
                    var ids = "";
                    for (i = 0; i < arrDuplicateIds.length; i++) {
                        ids += ", " + arrSelectedFriends[arrDuplicateIds[i]]
                    }
                    ids = ids.substring(1);
                    message = g_js_strings.recommendSelectedFriends.aalreadyrec.replace("%1$s", ids)
                } else {
                    message = g_js_strings.recommendSelectedFriends.recsuccess
                }
            } else {
                message = g_js_strings.recommendSelectedFriends.sorrynorec
            }
            document.getElementById("recommendActionResult").innerHTML = message
        },
        onFailure: function () {}
    })
}

function inviteFriendsModule() {
    strHTML = "<div class='allianceInvite' style='height:300px'>";
    strHTML += "<div class='waiting'>";
    strHTML += "</div>";
    strHTML += "</div>";
    document.getElementById("allianceContent").innerHTML = strHTML;
    var params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/allianceGetFbFriends.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                friendsButNotPlayers = rslt.friendsButNotPlayers;
                existingPlayers_AI = rslt.existingPlayers;
                allianceInviteLink = rslt.allianceInviteLink;
                strHTML = "<div id='divInviteAllianceMember'>";
                strHTML += "<div class='invtabs clearfix' id='divInviteAllianceMemberInvtabs'><a class='tab tabsel' onclick='friendsTabInAllianceInvite(" + rslt.referralId + ");return false;'><span>" + g_js_strings.commonstr.friends + "</span></a>";
                strHTML += "<a class='tab'  onclick='searchTabInAllianceInvite();return false;'><span>" + g_js_strings.recommendSelectedFriends.playersrch + "</span></a>";
                strHTML += "</div>";
                strHTML += "<div id='tabContent_AI' class='clearfix'></div>";
                strHTML += "</div>";
                document.getElementById("allianceContent").innerHTML = strHTML;
                friendsTabInAllianceInvite(rslt.referralId)
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function encodeURIComponentWithQuote(b) {
    var a = encodeURIComponent(b);
    a = a.replace(/%26%2339%3B|'/g, "%27");
    a = a.replace(/%26%2334%3B|"/g, "%22");
    return a
}

function friendsTabInAllianceInvite(a) {
    $("divInviteAllianceMemberInvtabs").select(".tabsel")[0].removeClassName("tabsel");
    $("divInviteAllianceMemberInvtabs").select(".tab")[0].addClassName("tabsel");
    var c = "<div class='makealstrong'>" + g_js_strings.friendsTabInAllianceInvite.makealliancestrong + "</div><div id='leftColumn_AI'><div class='extttl'><div>" + g_js_strings.recommendFriendsModule.selectfromfriend + "</div></div><div class='seldiv'>";
    subject = encodeURIComponentWithQuote(g_js_strings.friendsTabInAllianceInvite.subjecttxt.replace("%1$s", arrAllianceInfo.allianceName));
    message = encodeURIComponentWithQuote(g_js_strings.friendsTabInAllianceInvite.msgtxt.replace("%1$s", userInfo.displayName).replace("%2$s", arrAllianceInfo.allianceName).replace("%3$s", domainName).replace("%4$s", allianceInviteLink));
    c += "<table cellpadding='0' cellspacing='0'>";
    for (index in friendsButNotPlayers) {
        var b = "btn_AI_" + index;
        url = "https://www.facebook.com/inbox/?compose&id=" + friendsButNotPlayers[index].uid + "&subject=" + subject + "&message=" + message;
        c += "<tr><td class='piccol'><a href='https://www.facebook.com/profile.php?id=" + friendsButNotPlayers[index].uid + "' target='_blank'><img src=\"";
        if (friendsButNotPlayers[index].pic_square == "") {
            c += kraken.network.getNoPictureUrl()
        } else {
            c += friendsButNotPlayers[index].pic_square
        }
        c += "\" /></a></td><td class='nmcol'><div>" + friendsButNotPlayers[index].name + "</div></td><td class='sendcol' id='" + b + "'><a  class='button20' onclick='inviteFriendToJoinAlliance(" + friendsButNotPlayers[index].uid + ',"fbuid","' + b + "\"); return false;'><span>" + g_js_strings.commonstr.send + "</span></a></td></tr>"
    }
    c += "</table></div></div>";
    c += "<div id='rightColumn_AI'><div class='extttl'><div>" + g_js_strings.friendsTabInAllianceInvite.existingplayers + "</div></div><div class='explscr'>";
    c += "<table id='tbl_existingPlayers' cellpadding='0' cellspacing='0'>";
    for (fbuid in existingPlayers_AI) {
        var b = "btn_friendAI_" + existingPlayers_AI[fbuid].userId;
        c += "<tr>";
        c += "<td class='pic'>";
        c += "<a href='https://www.facebook.com/profile.php?id=" + fbuid + "' target='_blank'>";
        c += "<fb:profile-pic uid='" + fbuid + "' size='q' linked='false'></fb:profile-pic>";
        c += "</a>";
        c += "</td>";
        c += "<td class='info'>";
        c += "<div class='nm'>";
        c += "<a onclick='getInfoForAnUser(\"" + existingPlayers_AI[fbuid].userId + "\");return false;'>" + existingPlayers_AI[fbuid].genderAndName + "</a>";
        c += "<span>(<fb:name uid='" + fbuid + "' linked='false'></fb:name>)</span>";
        c += "</div>";
        c += "<div>" + g_js_strings.commonstr.might + ": " + existingPlayers_AI[fbuid].might + "</div>";
        c += "<div>" + g_js_strings.commonstr.title + ": " + existingPlayers_AI[fbuid].title + "</div>";
        c += "<div>" + g_js_strings.commonstr.alliance + ": " + existingPlayers_AI[fbuid].alliance + "</div>";
        c += "</td>";
        c += "<td class='invcol' id='" + b + "'>";
        if (existingPlayers_AI[fbuid].inviteStatus) {
            c += g_js_strings.friendsTabInAllianceInvite.pendinginv
        } else {
            c += "<a  class='button20' onclick='inviteFriendToJoinAlliance(\"" + existingPlayers_AI[fbuid].userId + '","userId","' + b + "\");return false;'><span>" + g_js_strings.commonstr.invite + "</span></a>"
        }
        c += "</td>";
        c += "</tr>"
    }
    c += "</table></div></div><div id='xfbmlFriendsList'></div>";
    document.getElementById("tabContent_AI").innerHTML = c;
    FB.XFBML.Host.parseDomTree(document.getElementById("tbl_existingPlayers"))
}

function inviteFriendToJoinAlliance(friendId, type, divId) {
    var element = $(divId);
    element.setOpacity(0.5);
    element.setStyle("cursor: default");
    element.onclick = function () {
        return false
    };
    var params = Object.clone(g_ajaxparams);
    params.friendId = friendId;
    params.type = (type || "userId");
    new Ajax.Request(g_ajaxpath + "ajax/allianceSendInviteToFriends.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                if (element) {
                    element.innerHTML = g_js_strings.commonstr.invited
                }
            } else {
                if (element) {
                    element.innerHTML = rslt.message
                }
            }
        },
        onFailure: function () {}
    })
}

function searchTabInAllianceInvite() {
    $("divInviteAllianceMemberInvtabs").select(".tabsel")[0].removeClassName("tabsel");
    $("divInviteAllianceMemberInvtabs").select(".tab")[1].addClassName("tabsel");
    var a = "<div id='divSearchPlayer'><div class='searchttl'>" + g_js_strings.recommendFriendsModule.searchplayers + "</div>";
    a += "<div class='searchipt clearfix'><input type='text' name='txtPlayerNameToSearch' id='txtPlayerNameToSearch'/>";
    a += '<a class=\'button20\' onclick=\'searchPlayersByName("txtPlayerNameToSearch","divMatchedPlayers_AI","' + g_js_strings.searchTabInAllianceInvite.messagetoinvite + '","AI");return false;\'><span>' + g_js_strings.commonstr.search + "</span></a></div>";
    a += "<div id='divMatchedPlayers_AI'></div>";
    document.getElementById("tabContent_AI").innerHTML = a
}

function searchPlayersByName(txtInput, resultPlaceHolder, messageHeading, requestType) {
    var playerName = $(txtInput) ? $(txtInput).value : "";
    if (playerName.blank() || playerName.length < 3) {
        Modal.showAlert(g_js_strings.searchPlayersByName.atleast3char);
        return false
    }
    if (messageHeading == null) {
        messageHeading = ""
    }
    if (requestType == null) {
        requestType = ""
    }
    var subject = g_js_strings.searchPlayersByName.allinvite;
    var messageStdDescription = g_js_strings.searchPlayersByName.youareinvited;
    var messageStdNoUserfound = g_js_strings.searchPlayersByName.nouserfound;
    var params = Object.clone(g_ajaxparams);
    params.searchName = playerName;
    params.subType = "ALLIANCE_INVITE";
    new Ajax.Request(g_ajaxpath + "ajax/searchPlayers.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            var alhtml = [];
            if (rslt.ok) {
                var alhtml = [];
                playerInfo = rslt.matchedUsers;
                alhtml.push("<div class='msghd'>" + messageHeading + "</div><div class='tbl_searchFriendsResults'><table id='tbl_searchFriendResults' cellpadding='0' cellspacing='5'>");
                if (playerInfo) {
                    if (requestType == "") {
                        for (playerId in playerInfo) {
                            alhtml.push("<tr><td>");
                            var playerStatus = "";
                            var disabled = "";
                            if (playerInfo[playerId].sameAlliance) {
                                playerStatus = "Alliance Member";
                                disabled = 'disabled="disabled"'
                            } else {
                                if (playerInfo[playerId].inviteStatus) {
                                    playerStatus = "Pending Invitation";
                                    disabled = 'disabled="disabled"'
                                }
                            }
                            alhtml.push("<input type='checkbox' id='chk_player__" + playerId + "' onclick='selectedFriendsList(" + playerId + ',this,"playerInfo")\' ' + disabled + "/>");
                            alhtml.push("</td><td class='pic'><a href='https://www.facebook.com/profile.php?id=" + playerInfo[playerId].fbuid + "' target='_blank'><fb:profile-pic linked='false' uid='" + playerInfo[playerId].fbuid + "'></fb:profile-pic></a></td>");
                            alhtml.push("</td><td><div style='width:100px'><a onclick='getInfoForAnUser(\"" + playerId + "\");return false;'>" + playerInfo[playerId].genderAndName + ' </a><br/>(<fb:name uid="' + playerInfo[playerId].fbuid + "\" linked='false'></fb:name>)</div></td>");
                            alhtml.push("<td>" + playerStatus + "</td></tr>")
                        }
                    } else {
                        if (requestType == "AI") {
                            for (playerId in playerInfo) {
                                var messageDescription = encodeURIComponent(g_js_strings.searchPlayersByName.abinkocjoinc.replace("%1$s", messageStdDescription).replace("%2$s", rslt.allianceName)).replace(encodeURIComponent("%3$s"), playerInfo[playerId].link);
                                var divId = "";
                                url = "https://www.facebook.com/inbox/?compose&id=" + playerInfo[playerId].fbuid + "&subject=" + encodeURIComponent(subject) + "&message=" + messageDescription;
                                alhtml.push("<tr><td class='pic'><a href='https://www.facebook.com/profile.php?id=" + playerInfo[playerId].fbuid + "' target='_blank'><fb:profile-pic uid='" + playerInfo[playerId].fbuid + "' linked='false'></fb:profile-pic></a></td>");
                                alhtml.push("<td class='info'><div class='nm'><a onclick='getInfoForAnUser(" + playerId + ");return false;' >" + playerInfo[playerId].genderAndName + "</a><span>(<fb:name linked='false' uid='" + playerInfo[playerId].fbuid + "'></fb:name>)</span></div>");
                                alhtml.push("<div>" + g_js_strings.commonstr.might + ": " + playerInfo[playerId].might + "</div>");
                                alhtml.push("<div>" + g_js_strings.commonstr.title + ": " + playerInfo[playerId].title + "</div>");
                                var sameAlliance = false;
                                if (playerInfo[playerId].allianceId) {
                                    alhtml.push("<div>" + g_js_strings.commonstr.alliance + ":" + playerInfo[playerId].allianceName + "</div>");
                                    sameAlliance = playerInfo[playerId].sameAlliance
                                }
                                divId = "btn_searchFriend_" + playerId;
                                alhtml.push("</td><td id='" + divId + "' class='invcol'>");
                                if (sameAlliance) {
                                    alhtml.push(g_js_strings.searchPlayersByName.mbrofall)
                                } else {
                                    if (playerInfo[playerId].inviteStatus) {
                                        alhtml.push(g_js_strings.friendsTabInAllianceInvite.pendinginv)
                                    } else {
                                        alhtml.push('<a onclick="inviteFriendToJoinAlliance(' + playerId + ",'userId','" + divId + '\'); return false;" class="button20" ><span>' + g_js_strings.commonstr.invite + "</span></a></td></tr>")
                                    }
                                }
                            }
                        }
                    }
                } else {
                    alhtml.push("<tr><td>" + g_js_strings.searchPlayersByName.srynoplayers.replace("%1$s", playerName) + "</td></tr>")
                }
                alhtml.push("</table></div>");
                document.getElementById(resultPlaceHolder).innerHTML = alhtml.join("");
                FB.XFBML.Host.parseDomTree(document.getElementById("tbl_searchFriendResults"))
            } else {
                alhtml.push("<div class='msghd'>" + messageStdNoUserfound + "</div>");
                document.getElementById(resultPlaceHolder).innerHTML = alhtml.join("")
            }
        },
        onFailure: function () {}
    })
};
if (!window.Alliance) {
    var Alliance = new Object()
}
Alliance.Properties = {
    userInfo: null,
    memberInfo: null,
    memberAllianceName: null,
    memberAllianceId: null,
    allianceDiplomacy: null,
    userOfficerType: null,
    officerTypeMapping: [],
    arrPendingRequest: null,
    arrPendingApprovals: null,
    arrAllianceInfo: null,
    invitations: null
};
Alliance.Methods = {
    pendingTab: function (a) {
        var b = Event.element(a);
        if ($(b).id == "pending_friendly_them") {
            $("pending_friendly_you_content").hide();
            $("pending_friendly_them_content").show();
            if ($(b).hasClassName("off")) {
                $(b).toggleClassName("off");
                $("pending_friendly_you").toggleClassName("off")
            }
        } else {
            if ($(b).id == "pending_friendly_you") {
                $("pending_friendly_you_content").show();
                $("pending_friendly_them_content").hide();
                if ($(b).hasClassName("off")) {
                    $(b).toggleClassName("off");
                    $("pending_friendly_them").toggleClassName("off")
                }
            }
        }
    }
};
Object.extend(Alliance, Alliance.Methods);
Object.extend(Alliance, Alliance.Properties);
Alliance.officerTypeMapping[1] = g_js_strings.commonstr.chancellor;
Alliance.officerTypeMapping[2] = g_js_strings.commonstr.vicechancellor;
Alliance.officerTypeMapping[3] = g_js_strings.commonstr.officer;
Alliance.officerTypeMapping[4] = g_js_strings.commonstr.member;
var userInfo;
var memberInfo;
var memberAllianceName;
var memberAllianceId;
var allianceDiplomacy;
var userOfficerType;
var allianceOfficerTypeMapping = [];
allianceOfficerTypeMapping[1] = g_js_strings.commonstr.chancellor;
allianceOfficerTypeMapping[2] = g_js_strings.commonstr.vicechancellor;
allianceOfficerTypeMapping[3] = g_js_strings.commonstr.officer;
allianceOfficerTypeMapping[4] = g_js_strings.commonstr.member;
var arrPendingRequest;
var arrAllianceInfo = null;
var allianceInvitations;

function showStatusMessage(a) {
    if (a) {
        document.getElementById("allianceStatus").innerHTML = a;
        document.getElementById("allianceStatus").className = "memlisthd"
    } else {
        document.getElementById("allianceStatus").className = ""
    }
}

function openAllianceWindow(a) {
    if (a == "view") {
        modal_alliance()
    } else {
        if (a == "leave") {
            modal_alliance(a)
        } else {
            if (a.indexOf("joinafterfte") != -1) {
                modal_alliance()
            }
        }
    }
}

function showCreateAlliance() {
    var a = "<div id='newAllianceCreation'>";
    a += "<div class='createttl'>" + g_js_strings.showCreateAlliance.createalli + "</div>";
    a += "<div class='cmError' id='createNameError' style='display:none;'>" + g_js_strings.showCreateAlliance.allinameinstruct + "</div>";
    a += "<div><table border='0' cellpadding='0' cellspacing='0'><tr><td><b>" + g_js_strings.showCreateAlliance.alliname + "</b></td><td><input type='text' id='txtAllianceName' /></tr>";
    a += "<tr><td><b>" + g_js_strings.commonstr.description + "</b></td><td><textarea id='txtAllianceDescription'></textarea></td></tr>";
    a += "<tr><td colspan='2' align='center'><a  class='button20'  onclick='createAlliance();return false;'><span>" + g_js_strings.showCreateAlliance.createalli + "</span></a><a  class='buttonDown20' onclick='closeCreateAlliance();return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a></td>";
    a += "</table></div></div>";
    document.getElementById("divAllianceInfoActions").innerHTML = a
}

function closeCreateAlliance() {
    document.getElementById("newAllianceCreation").innerHTML = ""
}

function createAlliance() {
    if ($("txtAllianceName").value.match(/[^a-zA-Z0-9_\ ]/g)) {
        $("createNameError").show();
        return false
    }
    var params = Object.clone(g_ajaxparams);
    params.allianceName = document.getElementById("txtAllianceName").value;
    params.allianceDescription = document.getElementById("txtAllianceDescription").value;
    new Ajax.Request(g_ajaxpath + "ajax/allianceCreate.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                document.getElementById("allianceStatus").innerHTML = "Alliance Created";
                allianceInfo();
                try {
                    var settings = {
                        body: g_js_strings.showCreateAlliance.networkinvitationbody.replace("%1$s", params.allianceName).replace("%2$s", rslt.sname),
                        data: {
                            alliancefte: "joinafterfte_" + rslt.s + "_" + rslt.aid + "_" + tvuid
                        },
                        googleplus__type: "invite"
                    };
                    kraken.network.getUser(function (me) {
                        kraken.network.makeRequest(settings, function (recipients) {
                            if (!recipients || !recipients.length) {
                                return
                            }
                            var params = Object.clone(g_ajaxparams);
                            params.friendId = recipients.join(",");
                            params.type = "fbuid";
                            new Ajax.Request(g_ajaxpath + "ajax/allianceSendInviteToFriends.php" + g_ajaxsuffix, {
                                method: "post",
                                parameters: params,
                                onSuccess: function (message) {
                                    var rslt = ("(" + message.responseText + ")").evalJSON();
                                    if (!rslt.ok) {
                                        Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                                    }
                                },
                                onFailure: function () {}
                            })
                        })
                    });
                    return
                } catch (e) {}
                cm.MixPanelTracker.track("alliance_create", {
                    usr_gen: seed.player.g,
                    usr_byr: seed.player.y,
                    usr_ttl: titlenames[seed.player.title],
                    distinct_id: tvuid
                })
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function allianceInfo(b) {
    var g = "";
    var d = "";
    var a = "";
    var f = "";
    var c = "";
    var e = "";
    AjaxCall.gPostRequest("ajax/allianceGetInfo.php", {}, function (o) {
        if (o.ok) {
            var q = new Array();
            arrPendingRequest = null;
            userInfo = (o.userInfo) ? o.userInfo : null;
            if (o.inAlliance) {
                arrAllianceInfo = o.allianceInfo;
                var r = o.officers;
                allianceDiplomacy = o.diplomaticAlliances;
                c = arrAllianceInfo.founder;
                e = arrAllianceInfo.ranking;
                userOfficerType = o.userOfficerType;
                q.push("<div class='allianceinfobox'>");
                q.push("<div class='alinfohd'><span>Info</span>");
                q.push('<a id="allianceOptions"  class="button20" onclick="optionsInAlliance();return false;"><span>' + g_js_strings.allianceInfo.leavealli + "</span></a>");
                q.push("</div>");
                q.push("<table class='alinfotable' cellpadding='0' cellspacing='0'>");
                q.push("<tr><td><b>" + g_js_strings.allianceInfo.curralli + ":</b> ");
                q.push(arrAllianceInfo.allianceName);
                q.push("</td><td><b>" + g_js_strings.commonstr.members + ":</b> ");
                q.push(arrAllianceInfo.members);
                q.push("/100</td><td><b>" + g_js_strings.commonstr.might + ":</b> ");
                q.push(arrAllianceInfo.might);
                q.push((cm.WorldSettings.isOn("GLORY_FE") ? "</td><td><b>" + g_js_strings.commonstr.glory + ":</b> " + arrAllianceInfo.glory + "</td></tr>" : ""));
                q.push("<tr><td><b>" + g_js_strings.commonstr.founder + ":</b> ");
                q.push(arrAllianceInfo.founderGenderAndName);
                q.push("</td><td><b>" + g_js_strings.commonstr.ranking + ":</b> ");
                q.push(arrAllianceInfo.ranking);
                q.push("</td><td><b>" + g_js_strings.commonstr.position + ":</b> ");
                q.push(allianceOfficerTypeMapping[parseInt(userOfficerType)]);
                q.push("</td></tr></table>");
                q.push("<div id='divAllianceLeaveActions' class='allianceleavebox'></div>");
                q.push("<div class='alinfocolbox clearfix'><div class='lcol'>");
                if (o.pendingApprovals) {
                    arrPendingApprovals = o.pendingApprovals;
                    q.push("<div id='divPendingApprovals'><div class='pendingttl'><span>" + g_js_strings.allianceInfo.pendmbrs + "</span></div><table id='pa_table' cellpadding='0' cellspacing='0'>");
                    for (uid in arrPendingApprovals) {
                        var n = false;
                        var j = arrPendingApprovals[uid].recommendedBy;
                        if (j) {
                            n = true
                        } else {
                            recoBy = ""
                        }
                        q.push("<tr id='tbl_pa_");
                        q.push(uid);
                        q.push("'><td style='padding-top:5px;border-bottom:1px solid #A56631;''><table cellpadding='0' cellspacing='0'><tr><td rowspan='2'><fb:profile-pic uid='");
                        q.push(arrPendingApprovals[uid].fbuid);
                        q.push("' size='q' style='width:35px;height:35px;margin:0 5px;'></fb:profile-pic></td>");
                        q.push("<td><a onclick='getInfoForAnUser(\"" + uid + "\");return false;' >");
                        q.push(arrPendingApprovals[uid].genderAndName);
                        q.push("</a></td>");
                        q.push("<td style='padding-left:5px;'><a  class='button20");
                        if (arrAllianceInfo.members < 100) {
                            q.push("' onclick='actionOnPendingApproval(\"approve\",");
                            q.push(uid);
                            q.push(",");
                            q.push(n);
                            q.push(",");
                            q.push(arrPendingApprovals[uid].fbuid);
                            q.push(")'")
                        } else {
                            q.push(" disabled' onclick='' title='Your alliance has reached the member limit'")
                        }
                        q.push("><span>" + g_js_strings.commonstr.approve + "</span></a></td>");
                        q.push("<td><a class='button20' onclick='actionOnPendingApproval(\"reject\",");
                        q.push(uid);
                        q.push(",");
                        q.push(n);
                        q.push(")'/><span>" + g_js_strings.commonstr.reject + "</span></a></td></tr>");
                        q.push("<tr><td colspan='2'>(<fb:name uid='");
                        q.push(arrPendingApprovals[uid].fbuid);
                        q.push("' linked='false'></fb:name>)");
                        q.push("</td></tr>");
                        var p = "";
                        for (recoId in j) {
                            p += "<div class='clearfix' style='display:block;padding-bottom:3px;'><img style='float:left;height:30px;width:30px;margin-right:5px;' src='" + j[recoId].avatarurl + "' /><a  style='float:left;display:block;line-height:30px;' onclick='getInfoForAnUser(\"" + recoId + "\");return false;'>" + j[recoId].genderAndName + "</a><div>"
                        }
                        if (p != "") {
                            q.push("<tr><td colspan='4' style='padding-left:5px;'>" + g_js_strings.allianceInfo.recommby + ":");
                            q.push(p);
                            q.push("</td></tr>")
                        }
                        q.push("</table></td></tr>")
                    }
                    q.push("</table></div>")
                }
                q.push("<div class='alinfolead'><div class='alinfoleadhd'><span>" + g_js_strings.commonstr.leaders + "</span></div><table cellpadding='0' cellspacing='0' class='alinfoleadtable'>");
                for (var m = 0; m < r.length; m++) {
                    q.push("<tr><td id='userId_");
                    q.push(r[m].id);
                    q.push("'>");
                    q.push("<a  onclick='getInfoForAnUser(\"");
                    q.push(r[m].id);
                    q.push("\")'>");
                    q.push(r[m].genderAndName);
                    q.push("</a>");
                    q.push(" (");
                    q.push(allianceOfficerTypeMapping[parseInt(r[m].type)]);
                    q.push(")</td><td class='msgcol'><a  class='button20' onclick='getMessageWindow(");
                    q.push(r[m].id);
                    q.push(',"');
                    q.push(escape(r[m].genderAndName));
                    q.push("\");return false;'><span>" + g_js_strings.commonstr.message + "</span></a></td></tr>")
                }
                q.push("</table></div>");
                q.push('<div class="gemGiftToAllianceContainer">');
                q.push('<div class="header">');
                q.push(g_js_strings.allianceInfo.gemGiftHeader);
                q.push("</div>");
                q.push('<div class="body">');
                q.push("<a class=\"inlineButton blue20\" onclick=\"cm.ConversionTracker.track('payments', 'MORE_GEMS_MAIN', ''); modal_getgems();return false;\"><span>" + g_js_strings.allianceInfo.gemGiftButton + "</span></a>");
                q.push("</div>");
                q.push("</div>");
                q.push("</div><div class='rcol'>");
                q.push("<div class='alinfodip'>");
                q.push("<div class='alinfodiphd'><span>" + g_js_strings.allianceInfo.allidiplomacy + "</span></div>");
                q.push("<div id='alinfodiptabs' class='tabsbar alinfodiptabs clearfix'>");
                q.push("<a  class='tab selected' onclick='getDiplomacy(\"FRIENDLY\");return false;'><span>" + g_js_strings.commonstr.friendly + "</span></a>");
                q.push("<a  class='tab' onclick='getDiplomacy(\"HOSTILE\");return false;'><span>" + g_js_strings.commonstr.hostile + "</span></a>");
                q.push("<a  class='tab' onclick='getDiplomacy(\"PENDING\");return false;'><span>" + g_js_strings.commonstr.pending + "</span></a>");
                q.push("</div>");
                q.push("<div style='clear:both'></div>");
                q.push("<div id='allianceDiplomacyInfo' style='overflow: auto; height: 200px;'></div>");
                q.push("<div style='clear:both'></div>");
                if (userOfficerType < 3) {
                    q.push("<div id='set_diplomacy_box'><a  class='button20' onclick='setDiplomacyWindow();return false;'><span>" + g_js_strings.allianceInfo.setdiplomacy + "</span></a><div style='clear:both'></div></div>")
                }
                q.push("</div>");
                q.push("</div></div>")
            } else {
                arrAllianceInfo = null;
                q.push("<div class='noalliance_bodywrap'>");
                q.push("<div class='noalliance_body'>");
                q.push("<div class='infohd'><span>" + g_js_strings.commonstr.info + "</span></div>");
                q.push("<div class='descmain'>" + g_js_strings.allianceInfo.currentlynoalli + "</div><div class='desc'>" + g_js_strings.allianceInfo.alliprotectdesc + "</div>");
                q.push("<div class='btn clearfix'><a  class='button20' onclick='allianceList();modal_alliance_changetab(3);'><span>" + g_js_strings.allianceInfo.browsealli + "</span></a></div>");
                q.push("</div>");
                if (o.embasyLevel < 2) {
                    strCreateAllianceEligiblity = "<div class='tx'>" + g_js_strings.allianceInfo.musthaveembassylvl2 + "</div>"
                } else {
                    strCreateAllianceEligiblity = "<div class='tx'>" + g_js_strings.allianceInfo.startown + "</div><br /><div><a  class='button20' onclick='showCreateAlliance();'><span style='margin-left:275px'>" + g_js_strings.allianceInfo.createalli + "</span></a></div>"
                }
                if (!o.embasyLevel) {
                    strCreateAllianceEligiblity += "<div class='tx'> " + g_js_strings.allianceInfo.andlvl1tojoin + "</div>"
                }
                q.push("<div class='noalliance_startown clearfix'>" + strCreateAllianceEligiblity + "</div>");
                if (o.pendingRequest) {
                    q.push("<br/><div id='pendingRequestFromUser'><div class='prhd'>" + g_js_strings.allianceInfo.pendingreq + "</div><table cellpadding='0' cellspacing='0'>");
                    arrPendingRequest = o.pendingRequest;
                    for (aId in arrPendingRequest) {
                        q.push("<tr><td class='colhd'>" + g_js_strings.commonstr.nametx + ":</td><td>" + arrPendingRequest[aId].name + "</td></tr>");
                        q.push("<tr><td class='colhd'>" + g_js_strings.commonstr.host + ":</td><td><a  onclick='getInfoForAnUser(\"" + arrPendingRequest[aId].hostId + "\");return false;'>" + arrPendingRequest[aId].hostGenderAndName + "</a></td></tr>");
                        q.push("<tr><td class='colhd'>" + g_js_strings.commonstr.members + ":</td><td>" + arrPendingRequest[aId].members + "</td></tr>");
                        q.push("<tr><td class='colhd'>" + g_js_strings.commonstr.ranking + ":</td><td>" + arrPendingRequest[aId].ranking + "</td></tr>");
                        q.push("<tr><td class='colhd'>" + g_js_strings.commonstr.might + ":</td><td>" + arrPendingRequest[aId].might + "</td></tr>");
                        q.push("<tr><td class='colhd'>" + g_js_strings.commonstr.description + ":</td><td>" + arrPendingRequest[aId].description + "</td></tr>");
                        q.push("<tr><td colspan='2'>" + g_js_strings.allianceInfo.reqdon + " " + arrPendingRequest[aId].timeRequested + "</td></tr>");
                        q.push("<tr><td colspan='2'><a  class='button20' onclick='cancelCurrentAllianceRequest();return false;'><span>" + g_js_strings.allianceInfo.cancelreq + "</span></a></td></tr>")
                    }
                    q.push("</table></div>")
                }
            }
            if (o.allianceInvitations) {
                q.push("<div class='alinv'><div class='alinvhd'><span>" + g_js_strings.allianceInfo.alliinvites + "</span></div><div class='alinvbody'><table id='tblAllianceInvitations' cellpadding='0' cellspacing='0'>");
                allianceInvitations = o.allianceInvitations;
                for (allianceId in allianceInvitations) {
                    q.push("<tr id='tr_AI_");
                    q.push(allianceId);
                    q.push("'>");
                    var l = allianceInvitations[allianceId].referralUserIds;
                    var h = "";
                    q.push("<td class='piccol'><img src='");
                    q.push(allianceInvitations[allianceId].avatarurl);
                    q.push("'/></td><td class='invcol'>");
                    if (l) {
                        q.push("<div>");
                        for (refId in l) {
                            h += "<a  onclick='getInfoForAnUser(\"" + refId + "\");return false;'>" + l[refId].genderAndName + "</a>(<fb:name uid='" + l[refId].fbuid + "' linked='false'></fb:name>),"
                        }
                        q.push(g_js_strings.allianceInfo.ainvitedyoutob.replace("%1$s", h.slice(0, -1)).replace("%2$s", allianceInvitations[allianceId].name));
                        q.push("</div>")
                    }
                    q.push("<div class='btns clearfix'>");
                    q.push("<a  class='button20' onclick='actionOnAllianceInvitations(\"join\",");
                    q.push(o.inAlliance);
                    q.push(",");
                    q.push(allianceId);
                    q.push(");return false;'><span>" + g_js_strings.allianceInfo.joinalli + "</span></a><a class='nothanks'  onclick='actionOnAllianceInvitations(\"reject\",");
                    q.push(o.inAlliance);
                    q.push(",");
                    q.push(allianceId);
                    q.push(");return false;'>" + g_js_strings.allianceInfo.nothanks + "</a>");
                    q.push("</div></td><td class='statscol'><div><b>" + g_js_strings.commonstr.nametx + ":</b> ");
                    q.push(allianceInvitations[allianceId].name);
                    q.push("</div><div><b>" + g_js_strings.commonstr.host + ":</b> <a  onclick='getInfoForAnUser(\"" + allianceInvitations[allianceId].hostUserId + "\");return false;'>");
                    q.push(allianceInvitations[allianceId].hostGenderAndName);
                    q.push("</a></div><div><b>" + g_js_strings.commonstr.founder + ":</b> ");
                    q.push(allianceInvitations[allianceId].founderGenderAndName);
                    q.push("</div><div><b>" + g_js_strings.commonstr.members + ":</b> ");
                    q.push(allianceInvitations[allianceId].memberCount);
                    q.push("</div><div><b>" + g_js_strings.commonstr.ranking + ":</b> ");
                    q.push(allianceInvitations[allianceId].ranking);
                    q.push("</div><div><b>" + g_js_strings.commonstr.might + ":</b> ");
                    q.push(allianceInvitations[allianceId].might);
                    q.push("</div></td><td class='desccol'><b>" + g_js_strings.commonstr.description + ":</b> ");
                    q.push(allianceInvitations[allianceId].description);
                    q.push("</td></tr>")
                }
                q.push("</table></div></div>")
            }
            q.push("<div id='divAllianceInfoActions'></div>");
            q.push("</div>");
            document.getElementById("allianceContent").innerHTML = q.join("");
            FB.XFBML.Host.parseDomTree(document.getElementById("allianceContent"));
            if (o.inAlliance) {
                getDiplomacy("FRIENDLY")
            }
            if (b == "leave") {
                document.getElementById("divAllianceLeaveActions").innerHTML = leaveAllianceConfirmationContent()
            } else {
                if (b == "members") {
                    membersInfo()
                }
            }
        } else {
            Modal.showAlert(printLocalError((o.error_code || null), (o.msg || null), (o.feedback || null)))
        }
    })
}

function getDiplomacy(d) {
    var a = new Array();
    var c = null;
    $("alinfodiptabs").select(".selected")[0].removeClassName("selected");
    var b = $("alinfodiptabs").select(".tab");
    if (d == "FRIENDLY") {
        b[0].addClassName("selected");
        c = allianceDiplomacy.friendly
    } else {
        if (d == "HOSTILE") {
            b[1].addClassName("selected");
            c = allianceDiplomacy.hostile
        } else {
            b[2].addClassName("selected");
            c = "PENDING"
        }
    }
    if (c == "undefined" || c == null) {
        a.push("<table>");
        a.push("<tr><td>" + g_js_strings.getDiplomacy.sorrynoalli + "</td></tr>");
        a.push("</table>")
    } else {
        if (c == "PENDING") {
            var f = "",
                e = "";
            Object.values(allianceDiplomacy.friendlyToThem).each(function (g) {
                f += "<div class='pending_content_row'>" + g.allianceName + "<span class='green_friendly'>" + g_js_strings.getDiplomacy.acceptancepending + "</span></div>"
            });
            Object.values(allianceDiplomacy.friendlyToYou).each(function (g) {
                e += "<div class='pending_content_row'><span class='red_friendly'>" + g_js_strings.getDiplomacy.leaderacceptancepending + "</span>" + g.allianceName + "</div>"
            });
            a.push("<div><div style='margin:10px;position:relative;height:20px;'><div id='pending_friendly_them' class='pending_subtab' onclick='Alliance.pendingTab(event)'>" + g_js_strings.getDiplomacy.friendlytowardsthem + "</div><div id='pending_friendly_you' class='pending_subtab off' onclick='Alliance.pendingTab(event)'>" + g_js_strings.getDiplomacy.friendlytoyou + "</div></div><div id='pending_friendly_them_content' class='pending_subtab_content'><div class='pending_alliname'>" + g_js_strings.getDiplomacy.alliname + "</div>" + f + "</div><div id='pending_friendly_you_content' class='pending_subtab_content' style='display:none;'><div class='pending_alliname'>" + g_js_strings.getDiplomacy.alliname + "</div>" + e + "</div></div>")
        } else {
            a.push("<table>");
            a.push("<tr><td>" + g_js_strings.getDiplomacy.alliname + "</td><td>" + g_js_strings.commonstr.ranking + "</td><td>" + g_js_strings.commonstr.members + "</td></tr>");
            for (aId in c) {
                a.push("<tr><td>");
                a.push(c[aId].allianceName);
                a.push("</td><td>");
                a.push(c[aId].rank);
                a.push("</td><td>");
                a.push(c[aId].membersCount);
                a.push("</td></tr>")
            }
            a.push("</table>")
        }
    }
    if (document.getElementById("allianceDiplomacyInfo") != null) {
        document.getElementById("allianceDiplomacyInfo").innerHTML = a.join("")
    }
}

function actionOnPendingApproval(type, uid, isRecommendation, fbuid) {
    var params = Object.clone(g_ajaxparams);
    params.targetUserId = uid;
    if (type == "approve") {
        if (isRecommendation == null) {
            isRecommendation = false
        }
        params.actionType = "approve";
        params.isRecommendation = isRecommendation
    } else {
        if (isRecommendation == null) {
            isRecommendation = false
        }
        params.actionType = "reject";
        params.isRecommendation = isRecommendation
    }
    new Ajax.Request(g_ajaxpath + "ajax/alliancePendingAction.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                allianceInfo();
                if (type == "approve") {
                    var msg = (rslt.message) ? encodeURIComponent(rslt.message) : "";
                    var sub = (rslt.subject) ? rslt.subject : "";
                    window.open("https://www.facebook.com/inbox/?compose&id=" + fbuid + "&subject=" + sub + "&message=" + msg, "facebookCompose", "status = 1, height=420, width = 970,left=300,top=300, resizable = 0")
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)));
                allianceInfo()
            }
        },
        onFailure: function () {}
    })
}

function actionOnAllianceInvitations(actionType, inAlliance, allianceId) {
    var strHTML = "";
    if (actionType == "join" && inAlliance) {
        var msg = g_js_strings.actionOnAllianceInvitations.leavecurralli;
        strHTML += leaveAllianceConfirmationContent(msg)
    } else {
        if (actionType == "join") {
            var params = Object.clone(g_ajaxparams);
            params.allianceId = allianceId;
            params.cityId = currentcityid;
            new Ajax.Request(g_ajaxpath + "ajax/allianceRecommendationJoin.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (message) {
                    var rslt = eval("(" + message.responseText + ")");
                    if (rslt.ok) {
                        strHTML = g_js_strings.actionOnAllianceInvitations.congratsyoujoinedalli.replace("%1$s", allianceInvitations[allianceId].name);
                        allianceInfo();
                        cm.MixPanelTracker.track("alliance_join", {
                            usr_gen: seed.player.g,
                            usr_byr: seed.player.y,
                            usr_ttl: titlenames[seed.player.title],
                            distinct_id: tvuid
                        })
                    } else {
                        Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                    }
                },
                onFailure: function () {}
            })
        } else {
            if (actionType == "reject") {
                var params = Object.clone(g_ajaxparams);
                params.allianceId = allianceId;
                new Ajax.Request(g_ajaxpath + "ajax/allianceRecommendationReject.php" + g_ajaxsuffix, {
                    method: "post",
                    parameters: params,
                    onSuccess: function (message) {
                        var rslt = eval("(" + message.responseText + ")");
                        if (rslt.ok) {
                            var aI = document.getElementById("tblAllianceInvitations").tBodies[0];
                            aI.deleteRow(document.getElementById("tr_AI_" + allianceId).rowIndex)
                        } else {
                            Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                        }
                    },
                    onFailure: function () {}
                })
            }
        }
    }
    document.getElementById("divAllianceInfoActions").innerHTML = strHTML
}

function leaveAllianceConfirmationContent(c, a) {
    if (c == null) {
        c = ""
    }
    if (a == null) {
        a = "divAllianceLeaveActions"
    }
    var b = "<div class='leaveallianceconfirm'><div class='cural'><b>" + g_js_strings.leaveAllianceConfirmationContent.curralli + ":</b> " + arrAllianceInfo.allianceName + "</div>" + c;
    if (userOfficerType == 1 && arrAllianceInfo.members > 1) {
        b = g_js_strings.leaveAllianceConfirmationContent.chancellorsnotleave;
        b += "<div class='clearfix'><a class='button20'  onclick='resignAlliance(\"" + a + "\");return false;'><span>" + g_js_strings.leaveAllianceConfirmationContent.resignchancellors + "</span></a></div>"
    } else {
        if (arrAllianceInfo.members == 1) {
            b += g_js_strings.leaveAllianceConfirmationContent.noteonlyperson
        }
        b += "<div>" + g_js_strings.leaveAllianceConfirmationContent.liketoleave + "</div>";
        b += "<div class='clearfix cfrmbtns'><a  class='button20' onclick='leaveAlliance(\"" + a + "\");return false;'><span>" + g_js_strings.commonstr.leave + "</span></a><a  class='buttonDown20' onclick='document.getElementById(\"" + a + '").innerHTML = "";return false;\'><span>' + g_js_strings.commonstr.cancel + "</span></a></div></div>"
    }
    if (!document.getElementById(a)) {
        b = "<div id='" + a + "'" + b + "</div>"
    }
    return b
}

function resignAlliance(divId) {
    var strHTML = "<div class='resigntitle'>" + g_js_strings.resignAlliance.chancellorresignation + "</div><div>" + g_js_strings.resignAlliance.selectnewchancellor + "</div><div>" + g_js_strings.resignAlliance.youvicechancellor + "</div>";
    var params = Object.clone(g_ajaxparams);
    params.resign = 1;
    new Ajax.Request(g_ajaxpath + "ajax/allianceGetMemberNames.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                if (rslt.allianceMembers) {
                    var arrElectAllianceMembers = rslt.allianceMembers;
                    strHTML += "<select id='selAllianceMembers_elect'>";
                    for (uid in arrElectAllianceMembers) {
                        strHTML += "<option value='" + uid + "'>" + arrElectAllianceMembers[uid].displayName + "(<fb:name uid='" + arrElectAllianceMembers[uid].fbuid + "' linked='false'></fb:name>)</option>"
                    }
                    strHTML += "</select><div class='clearfix'><a class='button20' onclick='assignNewChancellor(\"divAllianceLeaveActions\");return false;'><span>" + g_js_strings.resignAlliance.assignnewchancellor + "</span></a></div>";
                    document.getElementById(divId).innerHTML = strHTML;
                    FB.XFBML.Host.parseDomTree(document.getElementById(divId))
                } else {
                    allianceInfo()
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function leaveAlliance(divId) {
    var params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/allianceLeave.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                document.getElementById(divId).innerHTML = g_js_strings.leaveAlliance.allianceaterminated.replace("%1$s", arrAllianceInfo.allianceName);
                seed.allianceDiplomacies = null;
                allianceInfo();
                if (rslt.updateSeed.city && rslt.marches) {
                    var marches = new Hash(rslt.marches);
                    if (marches) {
                        marches.each(function (pair) {
                            var march = pair.value;
                            var ut = unixtime();
                            if (march.marchStatus == 2) {
                                seed.queue_atkp["city" + march.fromCityId]["m" + march.marchId].marchStatus = 8;
                                var marchtime = parseInt(seed.queue_atkp["city" + march.fromCityId]["m" + march.marchId].returnUnixTime) - parseInt(seed.queue_atkp["city" + march.fromCityId]["m" + march.marchId].destinationUnixTime)
                            } else {
                                if (march.marchStatus == 1) {
                                    for (var k in cm.UNIT_TYPES) {
                                        k = cm.UNIT_TYPES[k];
                                        seed.queue_atkp["city" + march.fromCityId]["m" + march.marchId]["unit" + k + "Return"] = seed.queue_atkp["city" + march.fromCityId]["m" + march.marchId]["unit" + k + "Count"]
                                    }
                                    seed.queue_atkp["city" + march.fromCityId]["m" + march.marchId].marchStatus = 9;
                                    var marchtime = ut - parseInt(seed.queue_atkp["city" + march.fromCityId]["m" + march.marchId].marchUnixTime)
                                }
                            }
                            seed.queue_atkp["city" + march.fromCityId]["m" + march.marchId].returnUnixTime = ut + marchtime;
                            seed.queue_atkp["city" + march.fromCityId]["m" + march.marchId].destinationUnixTime = ut;
                            seed.queue_atkp["city" + march.fromCityId]["m" + march.marchId].marchUnixTime = ut - marchtime
                        })
                    }
                    update_seed(rslt.updateSeed)
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)));
                allianceInfo()
            }
        },
        onFailure: function () {}
    })
}

function assignNewChancellor(divId) {
    var newChancellorName = document.getElementById("selAllianceMembers_elect").options[document.getElementById("selAllianceMembers_elect").selectedIndex].text;
    var params = Object.clone(g_ajaxparams);
    params.requestType = 6;
    params.newChancellorId = document.getElementById("selAllianceMembers_elect").value;
    params.newChancellorName = newChancellorName;
    new Ajax.Request(g_ajaxpath + "ajax/allianceNewChancellor.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                document.getElementById(divId).innerHTML = g_js_strings.commonstr.alliance + ": " + arrAllianceInfo.allianceName + "<br/>" + g_js_strings.assignNewChancellor.newchancellorisa.replace("%1$s", newChancellorName);
                allianceInfo()
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)));
                allianceInfo()
            }
        },
        onFailure: function () {}
    })
}

function cancelCurrentAllianceRequest(confirm) {
    if (confirm == null) {
        document.getElementById("divAllianceInfoActions").innerHTML = "<div class='alliancecancelrequest clearfix'><div>" + g_js_strings.cancelCurrentAllianceRequest.suretocancel + "</div><a onclick='cancelCurrentAllianceRequest(\"yes\");return false;' class='button20'><span>Confirm</span></a><a onclick='document.getElementById(\"divAllianceInfoActions\").innerHTML=\"\";return false;' class='buttonDown20'><span>" + g_js_strings.commonstr.cancel + "</span></a></div>"
    } else {
        var params = Object.clone(g_ajaxparams);
        new Ajax.Request(g_ajaxpath + "ajax/allianceCancelRequest.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (message) {
                var rslt = eval("(" + message.responseText + ")");
                if (rslt.ok) {
                    allianceInfo()
                } else {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)));
                    allianceInfo()
                }
            },
            onFailure: function () {}
        })
    }
}

function getDirectoryTabAllianceMembers() {
    var params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/allianceGetLeaders.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var additionalAllianceInfo = [];
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                var allianceOfficers = rslt.officers;
                var strHTML = new Array();
                if (allianceOfficers) {
                    strHTML.push("<div class='leaders'>" + g_js_strings.commonstr.leaders + "</div>");
                    for (aId in allianceOfficers) {
                        strHTML.push('<div class="clearfix friend">');
                        strHTML.push('<img src="');
                        strHTML.push(allianceOfficers[aId].avatarurl);
                        strHTML.push('" class="pic"/>');
                        strHTML.push('<div class="info">');
                        strHTML.push('<div class="nm"><a href="#" onclick=\'getInfoForAnUser("');
                        strHTML.push(allianceOfficers[aId].userId);
                        strHTML.push("\");return false;' >");
                        strHTML.push(allianceOfficers[aId].genderAndName);
                        strHTML.push("</a></div>");
                        if (allianceOfficers[aId].online) {
                            strHTML.push("<div style='color:green;font-size:10px;'>(" + g_js_strings.commonstr.online + ")</div>")
                        }
                        strHTML.push('<div class="stat">' + g_js_strings.commonstr.might + ":");
                        strHTML.push(allianceOfficers[aId].might);
                        strHTML.push("</div>" + (cm.WorldSettings.isOn("GLORY_FE") ? '<div class="stat">' + g_js_strings.commonstr.glory + ":" + allianceOfficers[aId].glory + "</div>" : "") + '<div class="action">');
                        strHTML.push('<a href="#" onclick=\'getMessageWindow("' + allianceOfficers[aId].userId + '","' + escape(allianceOfficers[aId].genderAndName) + "\")'>" + g_js_strings.commonstr.message + "</a></div></div></div>")
                    }
                    strHTML.push("<br/><div class='heading'><a onclick='modal_alliance(\"members\");return false;'>" + g_js_strings.getDirectoryTabAllianceMembers.viewallmbrs + "</a></div>")
                } else {
                    strHTML.push(g_js_strings.getDirectoryTabAllianceMembers.sorrynoofficersa.replace("%1$s", rslt.allianceName))
                }
                additionalAllianceInfo.push("<div>" + g_js_strings.commonstr.alliance + ': <a href="#">' + rslt.allianceName + "</a></div>");
                additionalAllianceInfo.push("<div>" + g_js_strings.commonstr.members + ': <a href="#">' + rslt.members + "</a></div>");
                document.getElementById("directory_tabs_2_members").innerHTML = strHTML.join("");
                if (allianceOfficers) {
                    FB.XFBML.Host.parseDomTree(document.getElementById("directory_tabs_2_members"))
                }
            } else {
                document.getElementById("directory_tabs_2_members").innerHTML = "<a onclick='modal_alliance();return false;'>" + g_js_strings.getDirectoryTabAllianceMembers.jointosee + "</a><br/><br/>" + g_js_strings.allianceInfo.alliprotectdesc;
                additionalAllianceInfo.push("<div></div>")
            }
            document.getElementById("directory_tabs_2_allianceInfo").innerHTML = additionalAllianceInfo.join("")
        },
        onFailure: function () {}
    })
}

function membersInfo(pageNo) {
    if (pageNo == null) {
        pageNo = 1;
        document.getElementById("allianceContent").innerHTML = "<div id='divAllianceMemberList'></div><div id='memberInfo_pagination' class='pagination'></div>"
    }
    var params = Object.clone(g_ajaxparams);
    params.pageNo = pageNo;
    new Ajax.Request(g_ajaxpath + "ajax/allianceGetMembersInfo.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                userOfficerType = rslt.userOfficerType;
                memberInfo = rslt.memberInfo;
                memberAllianceName = rslt.allianceName;
                memberAllianceId = rslt.allianceId;
                var memhtml = new Array();
                if (rslt.memberCount < 100) {
                    memhtml.push("<div class='memlisthd clearfix'><div class='tx'>" + g_js_strings.membersInfo.allilarger + "</div>");
                    if (userOfficerType == 4) {
                        memhtml.push("<a  class='button20' onclick='recommendFriendsModule();return false;'><span>" + g_js_strings.membersInfo.recommalli + "</span></a>")
                    } else {
                        if (userOfficerType < 4) {
                            memhtml.push("<a  class='button20' onclick='inviteFriendsModule();return false;'><span>" + g_js_strings.membersInfo.invitealli + "</span></a>");
                            memhtml.push("<a  class='button20 msgall' onclick='getMessageWindow(" + memberAllianceId + ',"Alliance Members","allianceall");return false;\'><span>' + g_js_strings.membersInfo.msgeveryone + "</span></a>")
                        }
                    }
                } else {
                    if (rslt.memberCount == 100) {
                        memhtml.push("<div class='memlisthd clearfix' style='font-size:12px'>" + g_js_strings.membersInfo.allilimit);
                        memhtml.push("<a class='button20 msgall' onclick='getMessageWindow(" + memberAllianceId + ',"Alliance Members","allianceall");return false;\'><span>' + g_js_strings.membersInfo.msgeveryone + "</span></a></div>")
                    }
                }
                memhtml.push("</div><div class='memlist'><div class='memlistfull'><table cellpadding='0' cellspacing='0'><tr class='header'><td class='colnm'>" + g_js_strings.commonstr.nametx + "</td><td class='colpos'>" + g_js_strings.commonstr.position + "</td><td class='colrank'>" + g_js_strings.commonstr.rank + "</td><td class='colmight'>" + g_js_strings.commonstr.might + "</td>" + (cm.WorldSettings.isOn("GLORY_FE") ? "<td class='colglory'>" + g_js_strings.commonstr.glory + "</td>" : "") + "<td class='colact'>" + g_js_strings.commonstr.actions + "</td></tr>");
                var cnt = 0;
                for (key in memberInfo) {
                    memhtml.push("<tr ");
                    if (cnt % 2 == 0) {
                        memhtml.push("class='stripe' ")
                    }
                    memhtml.push("id='memberId_" + memberInfo[key].userId + "'>");
                    memhtml.push("<td class='colnm'>" + memberInfo[key].genderAndName + "</td>");
                    memhtml.push("<td class='colpos'>" + allianceOfficerTypeMapping[parseInt(memberInfo[key].positionType)] + "</td>");
                    memhtml.push("<td class='colrank'>" + memberInfo[key].ranking + "</td>");
                    memhtml.push("<td class='colmight'>" + memberInfo[key].prestige + "</td>");
                    memhtml.push((cm.WorldSettings.isOn("GLORY_FE") ? "<td class='colglory'>" + memberInfo[key].glory + "</td>" : ""));
                    memhtml.push("<td class='colact'><a  class='button20' onclick='getMessageWindow(" + memberInfo[key].userId + ',"' + escape(memberInfo[key].genderAndName) + "\");return false;'><span>" + g_js_strings.commonstr.message + "</span></a><a  class='button20' onclick='showMemberInfo(" + key + ");return false;' id='btnView" + key + "'><span>" + g_js_strings.commonstr.view + "</span></a></td></tr>");
                    cnt++
                }
                memhtml.push("</table></div></div>");
                document.getElementById("divAllianceMemberList").innerHTML = memhtml.join("") + "<div style='clear:both'/><div id='divMemberInfo'></div>";
                if (pageNo == 1) {
                    ctrlPagination("memberInfo_pagination", rslt.noOfPages, "membersInfo", pageNo)
                }
            } else {
                document.getElementById("allianceContent").innerHTML = "<div class='noalliance_bodywrap'><div class='msg'>" + g_js_strings.membersInfo.youmustbelong + "</div></div>"
            }
        },
        onFailure: function () {}
    })
}
var tmpMemberOtherInfo;
var tmpActionsOnMember;

function showMemberInfo(memberId) {
    var memberProvinces = "";
    var provinceIds = memberInfo[memberId].provinceIds;
    if (provinceIds) {
        var arrProvinceIds = provinceIds.split(",");
        var memberProvinces = "";
        for (var i = 0; i < arrProvinceIds.length; i++) {
            if (arrProvinceIds[i]) {
                memberProvinces += provincenames["p" + arrProvinceIds[i]] + ","
            }
        }
        if (memberProvinces.charAt(memberProvinces.length - 1) == ",") {
            memberProvinces = memberProvinces.substring(0, memberProvinces.length - 1)
        }
    }
    var strHTML = "<div style='padding:35px 0 20px 120px;'><div'>";
    strHTML += "<table><tr><td rowspan='10' style='vertical-align:top'><img src='" + memberInfo[memberId].avatarurl + "'/></td><td>" + g_js_strings.commonstr.profile + ":</td><td>" + memberInfo[memberId].genderAndName + "</td></tr>";
    strHTML += "<tr><td>" + g_js_strings.showMemberInfo.fbname + ":</td><td><fb:name uid='" + memberInfo[memberId].fbuid + "' linked='false'></fb:name></td></tr>";
    strHTML += "<tr><td>" + g_js_strings.commonstr.might + ":</td><td>" + memberInfo[memberId].prestige + "</td></tr>";
    strHTML += cm.WorldSettings.isOn("GLORY_FE") ? "<tr><td>" + g_js_strings.commonstr.glory + ":</td><td>" + memberInfo[memberId].glory + "</td></tr>" : "";
    strHTML += "<tr><td>" + g_js_strings.commonstr.title + ":</td><td>" + titlenames[memberInfo[memberId].title] + "</td></tr>";
    strHTML += "<tr><td>" + g_js_strings.commonstr.alliance + ":</td><td>" + memberAllianceName + "</td></tr>";
    strHTML += "<tr><td>" + g_js_strings.commonstr.cities + ":</td><td>" + memberInfo[memberId].cities + "</td></tr>";
    strHTML += "<tr><td>" + g_js_strings.commonstr.province + ":</td><td>&nbsp;" + memberProvinces + "</td></tr>";
    strHTML += "<tr><td>" + g_js_strings.showMemberInfo.datejoinedalli + ":</td><td>&nbsp;" + memberInfo[memberId].dateJoined + "</td></tr>";
    strHTML += "<tr><td>" + g_js_strings.showMemberInfo.daysincurrpos + ":</td><td>&nbsp;" + memberInfo[memberId].daysInPosition + "</td></tr></table>";
    strHTML += "<div id='memberOtherInfo'></div>";
    strHTML += "<div id='actionsOnMember' style='display:block;padding-top:10px;' class='clearfix'>";
    switch (userOfficerType) {
    case "1":
    case "2":
        if (eval(userOfficerType) < eval(memberInfo[memberId].positionType)) {
            strHTML += "<input type='button' value='Promote' onclick=confirmActionOnMember(\"promote\"," + memberId + ") />";
            if (eval(memberInfo[memberId].positionType) != 4) {
                strHTML += "<input type='button' value='Demote' onclick='confirmActionOnMember(\"demote\"," + memberId + ")'/>"
            }
        }
    case "3":
        if (userOfficerType < memberInfo[memberId].positionType) {
            strHTML += "<input type='button' value='Remove' onclick='confirmActionOnMember(\"remove\"," + memberId + ")'/>"
        }
    case "4":
        strHTML += "<a  class='button20' onclick='getMessageWindow(" + memberId + ',"' + escape(memberInfo[memberId].genderAndName) + "\")'><span>" + g_js_strings.commonstr.message + "</span></a>"
    }
    strHTML += "</div><div id='divActionOnMember'></div></div></div>";
    Modal.showModal(740, 740, 10, 10, g_js_strings.modaltitles.memberdetails, "<div id='divShowMemberInfoDetails'>" + strHTML + "</div>");
    FB.XFBML.Host.parseDomTree(document.getElementById("divShowMemberInfoDetails"))
}

function confirmActionOnMember(actionType, memberId) {
    tmpMemberOtherInfo = document.getElementById("memberOtherInfo").innerHTML;
    tmpActionsOnMember = document.getElementById("actionsOnMember").innerHTML;
    var strHTML = "";
    var actionBar;
    var labelName = "";
    if (actionType == "promote") {
        labelName = g_js_strings.commonstr.promote;
        strHTML = g_js_strings.confirmActionOnMember.promoteatob.replace("%1$s", memberInfo[memberId].genderAndName).replace("%2$s", allianceOfficerTypeMapping[parseInt(memberInfo[memberId].positionType) - 1]);
        if (eval(memberInfo[memberId].positionType) == 2) {
            strHTML += "<br/>" + g_js_strings.confirmActionOnMember.demotetovicechancellor
        }
    } else {
        if (actionType == "demote") {
            labelName = g_js_strings.commonstr.demote;
            strHTML = g_js_strings.confirmActionOnMember.demoteatob.replace("%1$s", memberInfo[memberId].genderAndName).replace("%2$s", allianceOfficerTypeMapping[parseInt(memberInfo[memberId].positionType) + 1])
        } else {
            if (actionType == "remove") {
                labelName = g_js_strings.commonstr.remove;
                strHTML = g_js_strings.confirmActionOnMember.wanttoremovea.replace("%1$s", memberInfo[memberId].genderAndName)
            }
        }
    }
    actionBar = "<input type='button' value='" + labelName + "' onclick='doActionOnMember(\"" + actionType + '",' + memberId + ")' />";
    actionBar += "<input type='button' value='Cancel' onclick='restoreMemberInfo()' />";
    document.getElementById("memberOtherInfo").innerHTML = "<div>" + strHTML + "</div>";
    document.getElementById("actionsOnMember").innerHTML = actionBar
}

function doActionOnMember(actionType, memberId) {
    var params = Object.clone(g_ajaxparams);
    var fileName = "";
    if (actionType == "promote") {
        fileName = "alliancePromoteMember.php"
    } else {
        if (actionType == "demote") {
            fileName = "allianceDemoteMember.php"
        } else {
            if (actionType == "remove") {
                fileName = "allianceRemoveMember.php"
            }
        }
    }
    if (fileName != "") {
        params.memberOfficerType = memberInfo[memberId].positionType;
        params.memberId = memberId;
        new Ajax.Request(g_ajaxpath + "ajax/" + fileName + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (message) {
                var rslt = eval("(" + message.responseText + ")");
                if (rslt.ok) {
                    Modal.hideModal();
                    membersInfo();
                    showStatusMessage(memberInfo[memberId].genderAndName + rslt.message)
                } else {
                    Modal.hideModal();
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)));
                    membersInfo()
                }
            },
            onFailure: function () {}
        })
    }
}

function restoreMemberInfo() {
    document.getElementById("memberOtherInfo").innerHTML = tmpMemberOtherInfo;
    document.getElementById("actionsOnMember").innerHTML = tmpActionsOnMember
}

function allianceList(pageNo) {
    if (pageNo == null) {
        pageNo = 1;
        document.getElementById("allianceContent").innerHTML = "<div id='divAllianceList' class='divalliancelist'></div><div id='alliance_list2' class='pagination'></div>"
    }
    var params = Object.clone(g_ajaxparams);
    params.pageNo = pageNo;
    params.cityId = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/allianceGetOtherInfo.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                otherAllianceInfo = rslt.otherAlliances;
                var strHTML = new Array();
                strHTML.push("<div id='alliance_list1'><table cellpadding='0' cellspacing='0' class='alliance_list_table'>");
                strHTML.push("<thead><tr><td class='rankcol'><div>" + g_js_strings.commonstr.rank + "</div></td><td><div>" + g_js_strings.getDiplomacy.alliname + "</div></td><td><div>" + g_js_strings.commonstr.chancellor + "</div></td><td><div>" + g_js_strings.commonstr.members + "</div></td><td><div>" + g_js_strings.commonstr.might + "</div></td>" + (cm.WorldSettings.isOn("GLORY_FE") ? "<td><div>" + g_js_strings.commonstr.glory + "</div></td>" : "") + "<td class='viewcol'><div>" + g_js_strings.commonstr.view + "</div></td></tr></thead><tbody>");
                var stripe = 0;
                for (var i = 0; i < otherAllianceInfo.length; i++) {
                    var aId = otherAllianceInfo[i].allianceId;
                    strHTML.push("<tr id='otherAllianceId_" + aId + "'");
                    if (stripe % 2 == 0) {
                        strHTML.push(" class='stripe'")
                    }
                    strHTML.push("><td class='rankcol'><div>" + otherAllianceInfo[i].ranking + "</div></td>");
                    strHTML.push("<td><div><a href='#' onclick='showAllianceInfo(" + i + "," + pageNo + ");return false;'>" + otherAllianceInfo[i].name + "</a></div></td>");
                    strHTML.push("<td><div>" + otherAllianceInfo[i].hostGenderAndName + "</div></td><td><div>" + otherAllianceInfo[i].membersCount + "</div></td><td><div>" + otherAllianceInfo[i].might + "</div></td>" + (cm.WorldSettings.isOn("GLORY_FE") ? "<td><div>" + otherAllianceInfo[i].glory + "</div></td>" : "") + "<td class='viewcol'><div class='clearfix'>");
                    if (rslt.eligibleToRequest) {
                        strHTML.push('<span id="divRequestToJoin_' + aId + "\" class='actionbtn'>");
                        if (otherAllianceInfo[i].membersCount < 100) {
                            strHTML.push("<a  class='button20'  onclick='confirmRequestToJoin(" + i + ");return false;' name='requestToJoin'><span>" + g_js_strings.allianceList.reqjoin + "</span></a></span>")
                        } else {
                            strHTML.push(g_js_strings.allianceList.allifull + "</span>")
                        }
                    } else {
                        strHTML.push("<span class='actionbtn'><a  class='button20' onclick='getMessageWindow(" + aId + ',"' + escape(otherAllianceInfo[i].name) + "\",\"alliance\");return false;'  name='messageAlliance'><span>" + g_js_strings.commonstr.message + "</span></a></span>")
                    }
                    stripe++
                }
                strHTML.push("</tbody></table></div>");
                document.getElementById("divAllianceList").innerHTML = strHTML.join("") + "<div style='clear:both'/><div id='divAllianceListActions'></div>";
                if (pageNo == 1) {
                    ctrlPagination("alliance_list2", rslt.noOfPages, "allianceList")
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function confirmRequestToJoin(a) {
    var d = otherAllianceInfo[a].allianceId;
    if (arrPendingRequest) {
        var b = [];
        var c = new Object();
        for (aId in arrPendingRequest) {
            c = arrPendingRequest[aId]
        }
        b.push("<div style='padding-top:25px;padding-bottom:40px;padding-left:20px'>");
        if (c.allianceId == d) {
            b.push(g_js_strings.confirmRequestToJoin.youhaverequestwitha.replace("%1$s", c.name) + "<div style='margin-top:10px'><a onclick='Modal.hideModal();' class='button20' ><span>" + g_js_strings.commonstr.close + "</span></a></div>")
        } else {
            b.push("<div>" + g_js_strings.confirmRequestToJoin.cancelwithaandreqb.replace("%1$s", c.name).replace("%2$s", otherAllianceInfo[a].name));
            b.push("</div><div style='margin-top: 20px'><a onclick='Modal.hideModal();htmlAllianceRequest(" + a + ");return false;' class='button20' ><span>" + g_js_strings.commonstr.yes + "</span></a> ");
            b.push("<a onclick='Modal.hideModal();' class='button20' ><span>" + g_js_strings.commonstr.no + "</span></a></div>")
        }
        b.push("</div>");
        Modal.showModal(740, 400, 10, 350, g_js_strings.modaltitles.alliancerequest, b.join(""))
    } else {
        htmlAllianceRequest(a)
    }
}

function htmlAllianceRequest(a) {
    var c = otherAllianceInfo[a].allianceId;
    var b = "<div class='alliance_requestjoin_message'><div class='sendhd'>" + g_js_strings.htmlAllianceRequest.sendrequest + ": <b>" + otherAllianceInfo[a].name + "</b><br/>(" + g_js_strings.htmlAllianceRequest.pendingdrop + ")</div>";
    var d = "" + g_js_strings.commonstr.might + ": " + userInfo.might + "\n" + g_js_strings.commonstr.cities + ": " + userInfo.noOfCities;
    b += "<table cellpadding='0' cellspacing='0'><tr><td><b>" + g_js_strings.commonstr.subject + "</b></td><td><input type='textbox' id='txtSubjectJoinRequest' value='" + g_js_strings.htmlAllianceRequest.reqtojoinallia.replace("%1$s", otherAllianceInfo[a].name) + "' size='50'/></td></tr>";
    b += "<tr><td><b>" + g_js_strings.commonstr.message + "</b></td><td><textarea id='txtMessageJoinRequest'>" + g_js_strings.htmlAllianceRequest.interestinjoining + "\n\n" + g_js_strings.htmlAllianceRequest.thanksforconsidering + "\n" + userInfo.displayName + " </textarea></td></tr>";
    b += "<tr><td><a  class='button20' onclick='joinAllianceRequest(" + a + ");return false;'><span>" + g_js_strings.commonstr.send + "</span></a></td>";
    b += "<td><a  class='buttonDown20' onclick='$(\"divAllianceListActions\").innerHTML=\"\";return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a></td></tr></table></div>";
    document.getElementById("divAllianceListActions").innerHTML = b
}

function joinAllianceRequest(idx) {
    var allianceId = otherAllianceInfo[idx].allianceId;
    var params = Object.clone(g_ajaxparams);
    params.subject = document.getElementById("txtSubjectJoinRequest").value;
    params.message = document.getElementById("txtMessageJoinRequest").value;
    params.requestToAllianceId = allianceId;
    new Ajax.Request(g_ajaxpath + "ajax/allianceJoinRequest.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                document.getElementById("divAllianceListActions").innerHTML = "Successfully requested";
                var oldRequest = 0;
                for (aId in arrPendingRequest) {
                    oldRequest = aId
                }
                arrPendingRequest[oldRequest] = new Object();
                arrPendingRequest[oldRequest]["allianceId"] = allianceId;
                arrPendingRequest[oldRequest]["name"] = otherAllianceInfo[idx].name
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function showAllianceInfo(a, b) {
    var d = otherAllianceInfo[a].allianceId;
    var c = "<div class='clearfix allianceviewtablebtn'><a  class='button20' onclick='allianceList(" + b + ');$("alliance_list2").show();return false;\'><span>' + g_js_strings.showAllianceInfo.backtolist + "</span></a></div><table cellpadding='0' cellspacing='0' class='allianceviewtable'>";
    c += "<tr><td colspan='2' class='alliancenm'>" + otherAllianceInfo[a].name + "</td></tr>";
    c += "<tr><td class='hdcol'>" + g_js_strings.commonstr.description + ":</td><td>" + otherAllianceInfo[a].description + "</td></tr>";
    c += "<tr><td class='hdcol'>" + g_js_strings.commonstr.founder + ":</td><td>" + otherAllianceInfo[a].founderGenderAndName + "</td></tr>";
    c += "<tr><td class='hdcol'>" + g_js_strings.commonstr.members + ":</td><td>" + otherAllianceInfo[a].membersCount + "</td></tr>";
    c += "<tr><td class='hdcol'>" + g_js_strings.commonstr.ranking + ":</td><td>" + otherAllianceInfo[a].ranking + "</td></tr>";
    c += "<tr><td class='hdcol'>" + g_js_strings.commonstr.might + ":</td><td>" + otherAllianceInfo[a].might + "</td></tr></table>";
    document.getElementById("divAllianceListActions").innerHTML = c;
    if ($("alliance_list1")) {
        $("alliance_list1").hide()
    }
    if ($("alliance_list2")) {
        $("alliance_list2").hide()
    }
}

function optionsInAlliance() {
    var a = "";
    if (arrAllianceInfo == null) {
        a = g_js_strings.optionsInAlliance.optionsapply
    } else {
        if (userOfficerType > 1) {
            a = leaveAllianceConfirmationContent()
        } else {
            if (userOfficerType == 1) {
                a += leaveAllianceConfirmationContent()
            }
        }
    }
    document.getElementById("divAllianceLeaveActions").innerHTML = a
}

function getInfoForAnUser(uid, callBackFn) {
    if (!cm.ProfileController.disabled) {
        cm.ProfileController.open(uid);
        return
    }
    if (!uid) {
        Modal.showAlert(g_js_strings.getInfoForAnUser.sorryprobs)
    }
    var strHTML = "";
    var params = Object.clone(g_ajaxparams);
    params.uid = uid;
    new Ajax.Request(g_ajaxpath + "ajax/getUserGeneralInfo.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                var userInfo = rslt.userInfo;
                var strHTML = new Array();
                strHTML.push("<div id='memberinfo_userprofile'>");
                strHTML.push("<div class='infoblock clearfix'>");
                strHTML.push("<img src='" + userInfo[0].avatarurl + "'/>");
                strHTML.push("<div class='info'>");
                strHTML.push("<div><b>" + g_js_strings.commonstr.nametx + ":</b> " + userInfo[0].genderAndName + "</div>");
                strHTML.push("<div><b>" + g_js_strings.commonstr.might + ":</b> " + userInfo[0].might + "</div>");
                strHTML.push("<div><b>" + g_js_strings.commonstr.title + ":</b> " + titlenames[parseInt(userInfo[0].title)] + "</div>");
                strHTML.push("<div id='memberOtherInfo'>");
                strHTML.push("<div><b>" + g_js_strings.commonstr.alliance + ":</b> " + (userInfo[0].allianceName || "") + "</div>");
                strHTML.push("<div><b>" + g_js_strings.commonstr.cities + ":</b> " + userInfo[0].cities + "</div>");
                var userProvinces = "";
                var provinceIds = userInfo[0].provinceIds;
                if (provinceIds) {
                    var arrProvinceIds = provinceIds.split(",");
                    var userProvinces = "";
                    for (var i = 0; i < arrProvinceIds.length; i++) {
                        if (arrProvinceIds[i]) {
                            userProvinces += provincenames["p" + arrProvinceIds[i]] + ","
                        }
                    }
                    if (userProvinces.charAt(userProvinces.length - 1) == ",") {
                        userProvinces = userProvinces.substring(0, userProvinces.length - 1)
                    }
                }
                strHTML.push("<div><b>" + g_js_strings.commonstr.province + ":</b> " + userProvinces + "</div>");
                strHTML.push("</div></div>");
                strHTML.push("</div>");
                strHTML.push("<div id='actionsOnMember' class='clearfix'>");
                strHTML.push("<a class='button20' onclick='getMessageWindow(" + userInfo[0].userId + ',"' + escape(userInfo[0].genderAndName) + "\");return false;'><span>" + g_js_strings.commonstr.message + "</span></a>");
                strHTML.push("<a class='button20' onclick='Modal.hideModal();changeview_court(" + userInfo[0].userId + ");return false;'><span>" + g_js_strings.getInfoForAnUser.visitcourt + "</span></a>");
                strHTML.push("</div>");
                strHTML.push("</div>");
                if (callBackFn) {
                    var fnName = callBackFn + "(" + userInfo[0].userId + ',"' + strHTML.join("") + '")';
                    eval(fnName)
                } else {
                    Modal.showModal(500, 400, 125, 350, g_js_strings.modaltitles.userprofile, strHTML.join(""))
                }
            } else {
                Modal.hideModal();
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function showUserInfo_DirectoryTab(a, c) {
    var b = [];
    b.push(c);
    Modal.showModal(740, 400, 10, 10, "View", b)
}
var searchAllianceNames_sd_count = 0;

function setDiplomacyWindow() {
    var a = [];
    a.push("<div class='diplomacywindow'>");
    a.push("<div class='alinfohd'><span>" + g_js_strings.setDiplomacyWindow.setdiplo + "</span><a  onclick='allianceInfo();return false;' class='button20'><span>" + g_js_strings.setDiplomacyWindow.backalli + "</span></a></div>");
    a.push("<div class='diplomacybody'>");
    a.push("<div class='subtitle'>" + g_js_strings.setDiplomacyWindow.srchalli + "</div>");
    a.push("<div class='clearfix'><input type='text' name='txtAllianceName_sd' id='txtAllianceName_sd' /><a  onclick='getAllianceSearchResults();return false;' class='button20'><span>" + g_js_strings.commonstr.search + "</span></a></div>");
    a.push("<div id='allianceSearchResults_sd'></div>");
    a.push("<div class='subtitle'>" + g_js_strings.setDiplomacyWindow.setalli + ":</div><div class='options'><input type='radio' name='diplomacyStatus_sd'  value='1'/>Friendly<input type='radio' name='diplomacyStatus_sd'  value='0' />" + g_js_strings.commonstr.neutral + "<input type='radio' name='diplomacyStatus_sd' value='2' />" + g_js_strings.commonstr.hostile + "</div>");
    a.push("<div class='setbutton clearfix'><a onclick='setAllianceDiplomacies();return false;' class='button20'><span>" + g_js_strings.setDiplomacyWindow.setdiplo + "</span></a></div>");
    a.push("</div>");
    a.push("</div>");
    $("allianceContent").innerHTML = a.join("")
}

function getAllianceSearchResults() {
    var searchString = $("txtAllianceName_sd").value;
    if (searchString.blank() || searchString.length < 3) {
        var alhtml = [];
        alhtml.push("<div class='searchresultempty'>" + g_js_strings.getAllianceSearchResults.entryatleast3 + "</div>");
        $("allianceSearchResults_sd").innerHTML = alhtml.join("");
        return false
    }
    var params = Object.clone(g_ajaxparams);
    params.allianceName = document.getElementById("txtAllianceName_sd").value;
    new Ajax.Request(g_ajaxpath + "ajax/allianceGetSearchResults.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                var alhtml = [];
                if (rslt.alliancesMatched) {
                    var alliancesMatched = rslt.alliancesMatched;
                    searchAllianceNames_sd_count = rslt.count;
                    var arrRelation = new Array("", g_js_strings.commonstr.friendly, g_js_strings.commonstr.hostile);
                    alhtml.push("<div class='searchresult header clearfix'><div class='sel'>" + g_js_strings.commonstr.select + "</div><div class='name'>" + g_js_strings.commonstr.nametx + "</div><div class='curr'>" + g_js_strings.getAllianceSearchResults.currdiplo + "</div><div class='might'>" + g_js_strings.commonstr.might + "</div><div class='rank'>" + g_js_strings.commonstr.rank + "</div></div>");
                    for (aId in alliancesMatched) {
                        alhtml.push("<div class='searchresult row clearfix'>");
                        alhtml.push("<div class='sel'><input type='checkbox'  name='chkAllianceIdSD_" + alliancesMatched[aId].allianceId + "' id='chkAllianceIdSD_" + alliancesMatched[aId].allianceId + "'/></div>");
                        alhtml.push("<div class='name'>");
                        alhtml.push(alliancesMatched[aId].allianceName);
                        alhtml.push("</div>");
                        alhtml.push("<div class='curr'>");
                        var relation = "&nbsp;";
                        if (alliancesMatched[aId].relation) {
                            relation = arrRelation[alliancesMatched[aId].relation]
                        }
                        alhtml.push(relation);
                        alhtml.push("</div>");
                        alhtml.push("<div class='might'>");
                        alhtml.push(alliancesMatched[aId].might);
                        alhtml.push("</div>");
                        alhtml.push("<div class='rank'>");
                        alhtml.push(alliancesMatched[aId].ranking);
                        alhtml.push("</div>");
                        alhtml.push("</div>")
                    }
                }
                $("allianceSearchResults_sd").innerHTML = alhtml.join("")
            } else {
                var alhtml = [];
                alhtml.push("<div class='searchresultempty'>" + g_js_strings.getAllianceSearchResults.noresults + "</div>");
                $("allianceSearchResults_sd").innerHTML = alhtml.join("")
            }
        },
        onFailure: function () {}
    })
}
var collection;

function setAllianceDiplomacies() {
    var diplomacyStatus = null;
    var allianceSelected = "";
    if (document.getElementsByName("diplomacyStatus_sd")[0].checked) {
        diplomacyStatus = document.getElementsByName("diplomacyStatus_sd")[0].value
    } else {
        if (document.getElementsByName("diplomacyStatus_sd")[1].checked) {
            diplomacyStatus = document.getElementsByName("diplomacyStatus_sd")[1].value
        } else {
            if (document.getElementsByName("diplomacyStatus_sd")[2].checked) {
                diplomacyStatus = document.getElementsByName("diplomacyStatus_sd")[2].value
            }
        }
    }
    if (diplomacyStatus == null) {
        Modal.showModal(400, 240, 10, 10, g_js_strings.modaltitles.alliance, "<div  class='alerrormessage'>" + g_js_strings.setAllianceDiplomacies.choosediplo + "</div>");
        return false
    }
    collection = document.getElementById("allianceSearchResults_sd").getElementsByTagName("INPUT");
    for (i = 0; i < collection.length; i++) {
        if (collection[i].type.toUpperCase() == "CHECKBOX") {
            if (collection[i].checked) {
                var aid = (collection[i].id).split("_")[1];
                allianceSelected += aid + ","
            }
        }
    }
    if (allianceSelected.length == 0) {
        Modal.showModal(400, 240, 10, 10, g_js_strings.modaltitles.alliance, "<div class='alerrormessage'>" + g_js_strings.setAllianceDiplomacies.selectatleastone + "</div>");
        return false
    } else {
        allianceSelected = allianceSelected.substring(0, allianceSelected.length - 1);
        var params = Object.clone(g_ajaxparams);
        params.allianceSelected = allianceSelected;
        params.diplomacyStatus = diplomacyStatus;
        new Ajax.Request(g_ajaxpath + "ajax/allianceSetDiplomacies.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (message) {
                var rslt = eval("(" + message.responseText + ")");
                if (rslt.ok) {
                    document.getElementById("allianceSearchResults_sd").innerHTML = g_js_strings.setAllianceDiplomacies.diplosuccess
                } else {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                }
            },
            onFailure: function () {}
        })
    }
}

function modal_alliance(a) {
    var b = new Array();
    b.push("<div id='modal_alliance'><div id='modal_alliance_top' class='modal_alliance_top1'><div class='modal_alliance_btm'>");
    b.push('<input type="hidden" id="hdnPageNo" value="1"/>');
    b.push('<input type="hidden" id="hdnBoxType" />');
    b.push('<input type="hidden" id="hdnMostRecentMessageId"/>');
    b.push('<div class="modal_alliance_content">');
    b.push('<div id="allianceTabs" class="tabsbar clearfix">');
    b.push('<div id="allianceTab1" class="tab selected" onclick="allianceInfo();modal_alliance_changetab(1);"><span>' + g_js_strings.modal_alliance.alliinfo + "</span></div>");
    b.push('<div id="allianceTab2" class="tab" onclick="membersInfo();modal_alliance_changetab(2);"><span>' + g_js_strings.commonstr.members + "</span></div>");
    b.push('<div id="allianceTab3" class="tab" onclick="allianceList();modal_alliance_changetab(3);" ><span>' + g_js_strings.modal_alliance.allilist + "</span></div>");
    b.push('<div id="allianceTab4" class="tab" onclick="allianceReports();modal_alliance_changetab(4);" ><span>' + g_js_strings.commonstr.reports + "</span></div>");
    b.push("</div>");
    b.push('<div id="allianceStatus"></div>');
    b.push('<div class="modalalliancewrap"/>');
    b.push('<div id="allianceContent" class="allianceboxwrap">');
    b.push("</div>");
    b.push('<div class="allianceboxwrapcap"></div>');
    b.push("</div>");
    b.push("</div></div></div>");
    try {
        if (g_trackingPixels.allianceModal.length) {
            b.push('<div style="display:inline;"><img height="1" width="1" style="border-style:none;" alt="" src="' + g_trackingPixels.allianceModal + '"/></div>')
        }
    } catch (c) {}
    if (a == "leave") {
        Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.alliance, b.join(""), modal_alliance_Leave)
    } else {
        if (a == "members") {
            Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.alliance, b.join(""), modal_alliance_members)
        } else {
            Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.alliance, b.join(""), modal_alliance_init)
        }
    }
}

function modal_alliance_changetab(a) {
    var b = $("allianceTabs").select(".selected")[0];
    if (b) {
        b.removeClassName("selected")
    }
    b = $("allianceTabs").select(".tab")[a - 1];
    if (b) {
        b.addClassName("selected")
    }
}

function modal_alliance_init() {
    allianceInfo()
}

function modal_alliance_Leave() {
    allianceInfo("leave")
}

function modal_alliance_members() {
    allianceInfo("members");
    modal_alliance_changetab(2)
}

function allianceReports(pageNo) {
    var params = Object.clone(g_ajaxparams);
    if (pageNo) {
        params.pageNo = pageNo
    }
    params.group = "a";
    new Ajax.Request(g_ajaxpath + "ajax/listReports.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                var msghtml = new Array();
                msghtml.push("<div class='modal_msg_reports'>");
                var rptkeys = Object.keys(rslt.arReports);
                if (!Object.isArray(rslt.arReports)) {
                    msghtml.push("<div id='modal_alliance_reports_tablediv' class='modal_msg_list'><table cellpadding='0' cellspacing='0' class='msgviewtable reportviewtable alliancetable'>");
                    msghtml.push("<thead><tr><td class='dtcol'>" + g_js_strings.commonstr.date + "</td><td class='nmcol'>" + g_js_strings.commonstr.type + "</td><td class='subjcol'>" + g_js_strings.commonstr.view + "</td></tr></thead><tbody>");
                    for (var i = 0; i < rptkeys.length; i++) {
                        var idvrpt = rslt.arReports[rptkeys[i]];
                        msghtml.push("<tr class='");
                        if (i % 2 == 0) {
                            msghtml.push("stripe")
                        }
                        msghtml.push("' id='viewreports_marchreport_");
                        msghtml.push(idvrpt.reportId);
                        msghtml.push("'><td class='dtcol'><div>");
                        msghtml.push(formatDateByUnixTime(idvrpt.reportUnixTime));
                        msghtml.push("</div></td>");
                        msghtml.push("<td class='nmcol'><div>");
                        switch (parseInt(idvrpt.marchType)) {
                        case 1:
                            msghtml.push(g_js_strings.commonstr.transport);
                            break;
                        case 3:
                            msghtml.push(g_js_strings.commonstr.scout);
                            break;
                        default:
                            msghtml.push(g_js_strings.commonstr.attack);
                            break
                        }
                        msghtml.push(" ");
                        if (parseInt(idvrpt.side0PlayerId) == parseInt(tvuid)) {
                            msghtml.push("(" + rslt.arCityNames["c" + idvrpt.side0CityId] + ")")
                        } else {
                            var coordinateLink = new cm.utils.CoordinateLink(idvrpt.side0XCoord, idvrpt.side0YCoord);
                            coordinateLink.setClassName("coordinateLink");
                            msghtml.push(coordinateLink.getHTML())
                        }
                        msghtml.push(" ");
                        if (parseInt(idvrpt.side0TileType) != 51) {
                            msghtml.push(" - ");
                            msghtml.push(g_mapObject.types[parseInt(idvrpt.side0TileType)].capitalize());
                            msghtml.push(" Lv." + idvrpt.side0TileLevel)
                        } else {
                            if (parseInt(idvrpt.side0PlayerId) == 0) {
                                msghtml.push(" - ");
                                msghtml.push(g_js_strings.commonstr.barbariancamp);
                                msghtml.push(" " + g_js_strings.commonstr.lv + " " + idvrpt.side0TileLevel)
                            } else {
                                if (parseInt(idvrpt.marchType) == 1) {
                                    msghtml.push(" - <span>" + g_js_strings.commonstr.from + ": ");
                                    msghtml.push(unescape(rslt.arPlayerNames["p" + idvrpt.side1PlayerId]));
                                    msghtml.push("</span>")
                                } else {
                                    if (parseInt(idvrpt.side0PlayerId) == parseInt(tvuid)) {
                                        msghtml.push(" - <span style='color:#A02932;'>" + g_js_strings.modal_messages_viewreports.attackedby + " ");
                                        msghtml.push(unescape(rslt.arPlayerNames["p" + idvrpt.side1PlayerId]));
                                        msghtml.push("</span>")
                                    }
                                }
                            }
                        }
                        if (parseInt(idvrpt.marchType) == 1) {
                            msghtml.push("<span>");
                            msghtml.push(" (" + unescape(rslt.arCityNames["c" + idvrpt.side1CityId]) + ")");
                            msghtml.push("</span>")
                        } else {
                            if (parseInt(idvrpt.side0PlayerId) == parseInt(tvuid)) {
                                msghtml.push("<span style='color:#A02932;'>");
                                msghtml.push(" (" + unescape(rslt.arCityNames["c" + idvrpt.side1CityId]) + ")");
                                msghtml.push("</span>")
                            } else {
                                msghtml.push(" (" + unescape(rslt.arCityNames["c" + idvrpt.side1CityId]) + ")")
                            }
                        }
                        msghtml.push("</div></td>");
                        msghtml.push("<td class='subjcol'><div><a onclick='modal_alliance_report_view(\"");
                        msghtml.push(idvrpt.reportId);
                        msghtml.push('",');
                        if (parseInt(idvrpt.side1AllianceId) == parseInt(seed.allianceDiplomacies.allianceId)) {
                            msghtml.push(1)
                        } else {
                            msghtml.push(0)
                        }
                        msghtml.push(",");
                        msghtml.push(idvrpt.side0TileType);
                        msghtml.push(",");
                        msghtml.push(idvrpt.side0TileLevel);
                        msghtml.push(",");
                        msghtml.push(idvrpt.side0PlayerId);
                        msghtml.push(',"');
                        if (parseInt(idvrpt.side0PlayerId) != 0) {
                            msghtml.push(escape(rslt.arPlayerNames["p" + idvrpt.side0PlayerId]))
                        } else {
                            msghtml.push(g_js_strings.commonstr.enemy)
                        }
                        msghtml.push('","');
                        if (parseInt(idvrpt.side0PlayerId) != 0) {
                            msghtml.push(escape(rslt.arPlayerNames["g" + idvrpt.side0PlayerId]))
                        } else {
                            msghtml.push(0)
                        }
                        msghtml.push('","');
                        if (parseInt(idvrpt.side1PlayerId) > 0) {
                            msghtml.push(escape(rslt.arPlayerNames["p" + idvrpt.side1PlayerId]))
                        }
                        msghtml.push('","');
                        if (parseInt(idvrpt.side1PlayerId) != 0) {
                            msghtml.push(escape(rslt.arPlayerNames["g" + idvrpt.side1PlayerId]))
                        }
                        msghtml.push('",');
                        msghtml.push(idvrpt.marchType);
                        msghtml.push(",");
                        msghtml.push(idvrpt.side0XCoord);
                        msghtml.push(",");
                        msghtml.push(idvrpt.side0YCoord);
                        msghtml.push(",");
                        msghtml.push(idvrpt.reportUnixTime);
                        msghtml.push(",");
                        if (parseInt(idvrpt.reportStatus) == 2) {
                            msghtml.push(1)
                        } else {
                            msghtml.push(0)
                        }
                        if (idvrpt.side1XCoord) {
                            msghtml.push(",");
                            msghtml.push(idvrpt.side1XCoord);
                            msghtml.push(",");
                            msghtml.push(idvrpt.side1YCoord)
                        } else {
                            msghtml.push(",");
                            msghtml.push(",")
                        }
                        msghtml.push(");return false;'>" + g_js_strings.modal_messages_viewtrades.viewrpt + "</a></div></td></tr>")
                    }
                    msghtml.push("</tbody></table></div>")
                }
                msghtml.push("</div>");
                msghtml.push("<div id='modal_report_list_pagination'></div>");
                $("allianceContent").innerHTML = msghtml.join("");
                if (pageNo) {
                    ctrlPagination("modal_report_list_pagination", rslt.totalPages, "allianceReports", pageNo)
                } else {
                    ctrlPagination("modal_report_list_pagination", rslt.totalPages, "allianceReports")
                }
            } else {
                var msghtml = new Array();
                msghtml.push("<div class='modal_msg_reports'>");
                msghtml.push("<div id='modal_alliance_reports_tablediv' class='modal_msg_list'></div>");
                msghtml.push("<div style='font-size:17px;margin-left:30px;margin-top:20px'>" + g_js_strings.modal_messages_viewreports.nomarchrpts + "</div>");
                msghtml.push("</div>");
                $("allianceContent").innerHTML = msghtml.join("");
                $("modal_msg_list_actions").hide();
                if ($("pagination_indexOnly")) {
                    ($("pagination_indexOnly")).remove()
                }
            }
        },
        onFailure: function () {}
    })
}

function modal_alliance_report_view(rptid, side, tiletype, tilelv, defid, defnm, defgen, atknm, atkgen, marchtype, xcoord, ycoord, timestamp, unread, atkxcoord, atkycoord) {
    var args = arguments;
    var arrtpgs = $("modal_report_list_pagination").getElementsByTagName("a");
    var tpgs = 0;
    var currpg = 0;
    for (var i = 0; i < arrtpgs.length; i++) {
        Element.extend(arrtpgs[i]);
        if (arrtpgs[i].className == "paginationHighlightedPage") {
            currpg = i
        }
    }
    currpg = currpg + 1;
    if (arrtpgs.length == 0) {
        tpgs = 1
    } else {
        tpgs = arrtpgs.length
    }
    $("modal_report_list_pagination").hide();
    var params = Object.clone(g_ajaxparams);
    params.rid = rptid;
    params.side = side;
    new Ajax.Request(g_ajaxpath + "ajax/fetchReport.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok == false) {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            } else {
                var msghtml = new Array();
                msghtml.push("<div class='reportdetail clearfix'><a  class='button20' onclick='loadPage_pagination(\"modal_report_list_pagination\",\"" + currpg + '","allianceReports",' + tpgs + ");return false;'><span>" + g_js_strings.commonstr.back + "</span></a></div>");
                $("modal_alliance_reports_tablediv").innerHTML = getReportDisplay(args, rslt) + msghtml.join("")
            }
        },
        onFailure: function () {}
    })
};
var cm = cm || {};
cm.AlmActivationView = function (d) {
    var j = false;
    try {
        if ("true" !== cm.features.ALM_ENABLED) {
            throw "Feature is not activated"
        }
        j = true
    } catch (f) {} finally {
        if (!j) {
            return {}
        }
    }
    var a = "AlmActivation";
    var i = function (m) {
            var k = "";
            try {
                if ("lastShowTime" === cm.features.ALM_TIME_TO_TRACK) {
                    k = "ackShow"
                }
            } catch (n) {} finally {
                if ("" == k) {
                    k = "ackClose"
                }
            }
            if (k.toLowerCase() !== ("ack" + m)) {
                return
            }
            var l = d.extend({}, g_ajaxparams, {
                ctrl: "AlmActivation",
                action: k
            });
            new Ajax.Request(g_ajaxpath + "ajax/_dispatch.php" + g_ajaxsuffix, {
                method: "post",
                parameters: l,
                onSuccess: function () {},
                onFailure: function () {}
            })
        };
    var h = function () {
            try {
                return seed.showAlmPopUp ? true : false
            } catch (k) {}
            return false
        };
    var g = function (k) {
            try {
                if (!k || !k.action) {
                    return
                }
                switch (k.action) {
                case "open":
                    i("open");
                    break;
                case "close":
                    i("close");
                    d(".AlmActivation .close").click();
                    break;
                default:
                    return
                }
            } catch (l) {}
        };
    var c = function () {
            d(".AlmActivation *").unbind()
        };
    var b = function () {
            if (!h()) {
                return
            }
            try {
                var k = "k_xd_receiver_dev.html";
                try {
                    if (seed.almCrossDomainReceiver) {
                        k = seed.almCrossDomainReceiver
                    }
                } catch (p) {}
                KABAM.init(g_servcallback_url + "../" + k);
                var m = 650;
                var s = 800;
                var o = {
                    id: a + "Frame",
                    name: a + "Frame",
                    scrolling: "no",
                    style: ["background: none;background-color: transparent;width: ", m, "px; height: ", s, "px"].join(""),
                    frameborder: "0",
                    width: m,
                    height: s,
                    allowtransparency: "true"
                };
                var l = [];
                for (var n in o) {
                    l.push([n, '="', o[n], '"'].join(""))
                }
                var q = ["<iframe ", l.join(" "), "></iframe>"].join("");
                cm.ModalManager.add({
                    body: q,
                    lower: false,
                    "class": "AlmActivation",
                    curtain: true,
                    width: m,
                    height: s,
                    left: Math.max(0, Math.floor((760 - m) / 2)),
                    top: 100,
                    z: 100100,
                    close: c
                });
                var r = null;
                try {
                    r = {
                        email: seed.player.email,
                        first_name: seed.player.fname,
                        last_name: seed.player.lname
                    }
                } catch (p) {}
                KABAM.ClaimItem.displayModal("", document.getElementById(o.id), r, 1, kabamuid, g_server, g)
            } catch (p) {}
        };
    return {
        tryRender: b
    }
}(jQuery);
cm = cm || {};
cm.AnimationCreation = function (b) {
    var a = function () {
            var e = {
                element: b("#guardianContainer"),
                image: "img/guardian/animation/wood_animation_1.png",
                frames: 23,
                frameRate: 10,
                width: 124,
                height: 125,
                pan: [{
                    top: 200,
                    left: 100,
                    duration: 3
                }, {
                    top: 100,
                    left: 200,
                    duration: 2
                }, {
                    top: 200,
                    left: -200,
                    duration: 3
                }, {
                    top: 300,
                    left: -100,
                    duration: 4
                }, {
                    top: 0,
                    left: 100,
                    duration: 1
                }]
            };
            var d = new cm.AnimationModel(e);
            d.create(e);
            b("#guardianContainer").bind("mouseenter", function () {
                d.start();
                d.pan()
            });
            b("#guardianContainer").bind("mouseleave", function () {})
        };
    var c = function () {};
    return {
        init: c
    }
}(jQuery);
cm = cm || {};
cm.AnimationModel = jQueryClass.extend({
    init: function (a) {
        this.oldStuff = {};
        this.element;
        this.image;
        this.frames;
        this.frameRate;
        this.width;
        this.height;
        this.css;
        this.interval;
        this.currentFrame = 1;
        this.pauseInfo = {};
        this.pauseInfo.duration = 0;
        this.pauseInfo.cycles = 0;
        this.pauseInfo.repeat = true;
        this.stopInfo = {};
        this.stopInfo.duration = 0;
        this.stopInfo.cycles = 0;
        this.callback = {};
        this.callback.start = null;
        this.callback.stop = null;
        this.callback.pause = null;
        this.panInfo
    },
    start: function () {
        if (this.callback.start != null) {
            this.callback.start()
        }
        var b = this.element,
            f = 'url("' + stimgUrl + this.image + '")',
            a, e = this.pauseInfo.cycles * (this.frames - 1) * ((1000 / this.frameRate) + 10),
            d = this.stopInfo.cycles * (this.frames - 1) * ((1000 / this.frameRate) + 10),
            c = this;
        $(b).css("background-color", "transparent");
        $(b).css("background-image", f);
        $(b).css("background-position", "0 0");
        $(b).css("background-repeat", "no-repeat");
        this.interval = setInterval(function (g) {
            if (g.currentFrame >= (g.frames - 1)) {
                g.currentFrame = 1
            }++g.currentFrame;
            a = "-" + (g.currentFrame * g.width) + "px -45px";
            $(b).css("background-position", a)
        }, 1000 / this.frameRate, this);
        if (this.pauseInfo.duration > 0) {
            setTimeout(function (g) {
                g.pause()
            }, this.pauseInfo.duration * 1000, this)
        }
        if (this.pauseInfo.cycles > 0) {
            setTimeout(function (g) {
                g.pause()
            }, e, this)
        }
        if (this.stopInfo.duration > 0) {
            setTimeout(function (g) {
                g.stop()
            }, this.stopInfo.duration * 1000, this)
        }
        if (this.stopInfo.cycles > 0) {
            setTimeout(function (g) {
                g.stop()
            }, d, this)
        }
    },
    stop: function () {
        var a = this.element;
        if (this.callback.stop != null) {
            this.callback.stop()
        }
        this.pause();
        $(a).css("background-position", "0 0");
        this.revert()
    },
    pause: function () {
        if (this.callback.pause != null) {
            this.callback.pause()
        }
        clearInterval(this.interval);
        this.interval = null
    },
    revert: function () {
        var a = this.element;
        if (this.oldStuff.style != null || this.oldStuff.style != "") {
            if ($(a).attr("style") != this.oldStuff.style) {
                $(a).attr("style", this.oldStuff.style)
            }
        }
        if (this.oldStuff["class"] != null || this.oldStuff["class"] != "") {
            if ($(a).attr("class") != this.oldStuff["class"]) {
                $(a).attr("class", this.oldStuff["class"])
            }
        }
        if (this.oldStuff.background != null || this.oldStuff.background != "") {}
    },
    pan: function () {
        var j = ["#maparea_city", "#maparea_fields", "#maparea_map"],
            a, e, b, f, c, l, k, m, h = [];
        for (var d = 0, g = j.length; d < g; ++d) {
            if (jQuery(j[d]).attr("style") == undefined || jQuery(j[d]).css("display") == "block") {
                l = j[d]
            }
        }
        a = jQuery(l).offset();
        e = [a.left, a.top];
        b = jQuery(this.element).offset();
        f = [b.left, b.top];
        for (var d = 0, g = this.panInfo.length; d < g; ++d) {
            k = this.panInfo[d];
            c = [k.left, k.top];
            m = {};
            if (c[0] > f[0]) {
                m.left = "" + (c[0] - f[0])
            } else {
                m.left = "" + (f[0] - c[0])
            }
            if (c[1] > f[1]) {
                m.top = "" + (c[1] - f[1])
            } else {
                m.top = "" + (f[1] - c[1])
            }
            m.duration = k.duration;
            h.push(m)
        }
        this.move(h)
    },
    moveIndex: 0,
    move: function (c) {
        var b = this,
            a = c[this.moveIndex];
        if (this.moveIndex < c.length) {
            jQuery(this.element).animate({
                top: a.top,
                left: a.left
            }, 1000 * a.duration, "linear", function () {
                b.move(c);
                ++b.moveIndex
            })
        } else {
            this.moveIndex = 0
        }
    },
    create: function (f) {
        var c = f.element,
            b = $(c).css("background-color"),
            e = $(c).css("background-image"),
            a = $(c).css("background-position"),
            d = $(c).css("background-repeat");
        this.oldStuff.style = $(c).attr("style");
        this.oldStuff["class"] = $(c).attr("class");
        this.oldStuff.background = b + " " + e + " " + a + " " + d;
        this.element = f.element;
        this.image = f.image;
        this.frames = f.frames;
        this.width = f.width;
        this.height = f.height;
        this.frameRate = f.frameRate || 12;
        this.duration = f.duration || 0;
        if (f.pause) {
            this.pauseInfo.duration = f.pause.duration || 0;
            this.pauseInfo.cycles = f.pause.cycles || 0;
            this.pauseInfo.repeat = f.pause.repeat || false
        }
        if (f.stop) {
            this.stopInfo.duration = f.stop.duration || 0;
            this.stopInfo.cycles = f.stop.cycles || 0
        }
        if (f.callback) {
            this.callback.start = f.callback.start || null;
            this.callback.stop = f.callback.stop || null;
            this.callback.pause = f.callback.pause || null
        }
        if (f.pan) {
            this.panInfo = f.pan
        }
    }
});

function modal_attack(e, h, k, m) {
    var l = e;
    m = m || {};
    if (e == cm.MARCH_TYPES.MARCH_TYPE_BARBARIAN) {
        e = cm.MARCH_TYPES.MARCH_TYPE_ATTACK
    }
    var j = [];
    var s = 100;
    j.push("<div id='modal_attack'>");
    j.push('<ul class="marchTypeTabs">');
    j.push('<li id="modal_attack_tab_' + cm.MARCH_TYPES.MARCH_TYPE_ATTACK + '">' + g_js_strings.commonstr.attack + "</li>");
    j.push('<li id="modal_attack_tab_' + cm.MARCH_TYPES.MARCH_TYPE_SCOUT + '">' + g_js_strings.commonstr.scout + "</li>");
    j.push('<li id="modal_attack_tab_' + cm.MARCH_TYPES.MARCH_TYPE_REINFORCE + '">' + g_js_strings.commonstr.reinforce + "</li>");
    j.push('<li id="modal_attack_tab_' + cm.MARCH_TYPES.MARCH_TYPE_REASSIGN + '">' + g_js_strings.commonstr.reassign + "</li>");
    j.push('<li id="modal_attack_tab_' + cm.MARCH_TYPES.MARCH_TYPE_TRANSPORT + '">' + g_js_strings.commonstr.transport + "</li>");
    j.push("</ul>");
    j.push("<div class='marchtype' style='display:none;'>");
    j.push(g_js_strings.modal_attack.marchtype);
    j.push("<select id='modal_attack_atktype'>");
    for (var p in cm.MARCH_TYPES) {
        if (cm.MARCH_TYPES[p] < cm.MARCH_TYPES.MARCH_TYPE_TRANSPORT || cm.MARCH_TYPES[p] > cm.MARCH_TYPES.MARCH_TYPE_REASSIGN) {
            continue
        }
        j.push("<option value='" + cm.MARCH_TYPES[p] + "'");
        if (e == cm.MARCH_TYPES[p]) {
            j.push(" selected")
        }
        j.push(">" + cm.MARCH_TYPES[p] + "</option>")
    }
    j.push("</select>");
    j.push("</div>");
    j.push("<div class='units'>");
    j.push("<div class='unitshd'>");
    j.push("<div class='available_troops'>" + g_js_strings.modal_attack.availabletroops + "</div>");
    if ("on" == cm.features.AUTO_ATTACK) {
        j.push("<div class='raidfilter' id='modal_attack_raidfilter'><input type='checkbox' id='modal_attack_raidfilter_checkbox' tabindex='");
        j.push(s++);
        j.push("' " + ((l == cm.MARCH_TYPES.MARCH_TYPE_BARBARIAN) ? "checked " : " "));
        j.push((seed.player.title >= cm.AutoAttackLevelLock) ? " " : "disabled ");
        j.push('/><a onclick="cm.MarchModal.onAutoAttackHelpClick();return false;">');
        j.push(g_js_strings.modal_attack.thisisabarbarianraid);
        j.push("</a></div>")
    }
    j.push("<div class='unitfilter' id='modal_attack_supplyfilter'><input type='checkbox' id='modal_attack_supplyfilter_checkbox' tabindex='");
    j.push(s++);
    j.push("' />");
    j.push(g_js_strings.modal_attack.displaysupplyonly);
    j.push("</div>");
    j.push("</div>");
    j.push("<div class='' id='modal_attack_unitlist'>");
    var b = seed.units["city" + currentcityid];
    var r = Object.keys(b);
    for (var p = 0; p < r.length; p++) {
        var g = r[p].split("unt")[1];
        j.push("<div class='unit' name='");
        j.push(g);
        j.push("'><img src='");
        j.push(stimgUrl);
        j.push("img/units/unit_");
        j.push(g);
        j.push("_50_s34.jpg'/><div class='unitinfo'><div class='unitname'>");
        j.push(unitcost[r[p]][0]);
        j.push("</div><div><span class='unitnum'>");
        j.push(b[r[p]]);
        j.push("</span></div><div class='numbox'><input type='text' id='modal_attack_unit_ipt");
        j.push(g);
        j.push("' value='0' onfocus='this.select();' onkeyup='modal_attack_update_num(this);' onkeyDown='cm.KeyFilter.allowOnlyNumbers(event)' onblur='modal_attack_normalize_number(this)' name='");
        j.push(r[p].split("unt")[1]);
        j.push("' tabindex='");
        j.push(s++);
        j.push("' /><a id='maxButton" + g + "'  class='button14'");
        j.push("><span>" + g_js_strings.commonstr.max + "</span></a></div></div></div>")
    }
    j.push("</div>");
    j.push("<div class='unitarmy'>");
    j.push(g_js_strings.modal_attack.selectedtroops + ":");
    j.push(" <span id='modal_attack_selnum'>0</span> / <span id='modal_attack_maxunt'>");
    var t = getBuildingLevel(12),
        o = 1,
        a = unixtime();
    if (seed.playerEffects.aurasExpire) {
        if (seed.playerEffects.aurasExpire > a) {
            o = 1.15
        }
    }
    if (seed.playerEffects.auras2Expire) {
        if (seed.playerEffects.auras2Expire > a) {
            o = 1.3
        }
    }
    var q = cm.ThroneController.effectBonus(66);
    var d = 0;
    if (t === 11) {
        d = (Math.round(150000 * o))
    } else {
        if (t === 12) {
            d = (Math.round(200000 * o))
        } else {
            d = (Math.round((t * 10000) * o))
        }
    }
    if (l != 6) {
        d = Math.round(d * (1 + q / 100))
    }
    j.push(d);
    j.push("</span><span id='modal_attack_resource_summary'> &nbsp; ");
    j.push(g_js_strings.modal_attack.resouresselected + ":");
    j.push(" <span id='modal_attack_selres'>0</span> / <span id='modal_attack_maxres'>0</span></span></div>");
    j.push("<div id='modal_attack_vacancy' name='0' style='display:none'>0</div>");
    j.push("</div>");
    j.push("<div class='targetitems clearfix'>");
    j.push("<div class='left_column'>");
    j.push("<div class='section'>");
    j.push("<div class='section_title'>" + g_js_strings.modal_attack.availableknights + "</div>");
    j.push("<div class='section_content'>");
    j.push("<select id='modal_attack_knight' tabindex='150'><option value='0'>");
    var f = seed.knights["city" + currentcityid];
    if (f) {
        j.push(g_js_strings.modal_attack.dchooseknightd)
    } else {
        j.push(g_js_strings.modal_attack.noknightavailable)
    }
    j.push("</option>");
    if (f) {
        var n = Object.keys(f);
        n.sort(cm.MarchModal.sortKnights);
        for (var p = 0; p < n.length; p++) {
            var c = parseInt(n[p].split("knt")[1]);
            if (parseInt(f["knt" + c].knightStatus) == 1 && c != parseInt(seed.leaders["city" + currentcityid].resourcefulnessKnightId) && c != parseInt(seed.leaders["city" + currentcityid].intelligenceKnightId) && c != parseInt(seed.leaders["city" + currentcityid].combatKnightId) && c != parseInt(seed.leaders["city" + currentcityid].politicsKnightId)) {
                j.push("<option value='");
                j.push(f[n[p]].knightId);
                j.push("'>");
                j.push(f[n[p]].knightName);
                j.push(" (" + g_js_strings.commonstr.atk + ":");
                j.push(f[n[p]].combat);
                j.push(")</option>")
            }
        }
    }
    j.push("</select>");
    j.push("<div>" + g_js_strings.modal_attack.chooseknight + "</div>");
    j.push("</div></div>");
    j.push("<div class='section'>");
    j.push("<div class='section_title'>" + g_js_strings.modal_attack.marchto + "</div>");
    j.push("<div class='section_content'>");
    j.push("<span id='modal_attack_target_dropdown'");
    if (h > -1 && k > -1) {
        j.push(" style='display:none;'")
    }
    j.push("><span id='savedCoordinatesDropdown'></span> ");
    j.push(" <a  onclick='modal_attack_target_coords();return false;'>");
    j.push(g_js_strings.modal_attack.dord);
    j.push(g_js_strings.modal_attack.inpcoor);
    j.push("</a></span>");
    j.push("<span id='modal_attack_target_coords'");
    if (!(h > -1) || !(k > -1)) {
        j.push(" style='display:none;'")
    }
    j.push(">X=<input type='text' class='coordipt' id='modal_attack_target_coords_x' onkeyup='modal_attack_update_time();' maxlength='3'");
    if (h > -1 && k > -1) {
        j.push(" value='" + h + "'")
    } else {
        j.push(" value='0'")
    }
    j.push(" tabindex='151' /> Y=<input type='text' class='coordipt' id='modal_attack_target_coords_y' onkeyup='modal_attack_update_time();' maxlength='3'");
    if (h > -1 && k > -1) {
        j.push(" value='" + k + "'")
    } else {
        j.push(" value='0'")
    }
    j.push(" tabindex='152' />");
    j.push("<a  onclick='modal_attack_target_dropdown();return false;' class='seltoggle'>");
    j.push(g_js_strings.modal_attack.dord);
    j.push(g_js_strings.modal_attack.selbookmark);
    j.push("</a>");
    j.push("</span>");
    j.push("</div></div>");
    cm.MarchModal.rendererBoostSection(j, "modal_attack_march_boost", g_js_strings.modal_attack.marchboosts, [931, 932]);
    cm.MarchModal.rendererBoostSection(j, "modal_attack_speed_boost", g_js_strings.modal_attack.speedboosts, [55, 57], cm.MarchModal.rendererEstimateTime);
    j.push("</div><!-- end .left_column -->");
    j.push("<div class='right_column'>");
    cm.MarchModal.rendererResourceSection(j);
    cm.MarchModal.rendererBoostSection(j, "modal_attack_attack_boost", g_js_strings.modal_attack.attackboosts, [221, 261, 262, 280], null, {
        i280: true
    });
    cm.MarchModal.rendererBoostSection(j, "modal_attack_defense_boost", g_js_strings.modal_attack.defenseboosts, [271, 272, 281], null, {
        i281: true
    });
    j.push("</div><!-- end .right_column -->");
    j.push("</div>");
    j.push("<div id='error_overmarch'></div>");
    j.push("<div class='footerbtns clearfix'><a id='btnMarch' class='inlineButton blue36'><span>" + g_js_strings.commonstr.march + "</span></a></div>");
    j.push("</div>");
    Modal.onCloseCallback = function () {
        cm.MarchModal.onModelClosed()
    };
    Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.marchtroops, j.join(""), undefined, undefined, undefined, {
        additionalClass: "nodecoration"
    });
    attack_checkOverMarch();
    cm.MarchModal.bind(m);
    cm.MarchModal.changeMarchType(e, l)
}

function modal_attack_rec_vacancy(h) {
    var f = "gold";
    if (parseInt(h) > 0) {
        f = "rec" + h
    }
    var e = $("modal_attack_vacancy").getAttribute("name");
    var g = $("modal_attack_transport").getElementsByTagName("input");
    var c = $("modal_attack_" + f).value;
    var b = c.match(/[0-9]+/g);
    b = b ? b.join("") : "";
    while (b.substr(0, 1) == "0" && b.length > 1) {
        b = b.substr(1)
    }
    $("modal_attack_" + f).value = b;
    var d = parseInt($("modal_attack_rec_max_" + f).innerHTML);
    var a = parseInt($("modal_attack_" + f).value);
    if (a > d) {
        $("modal_attack_" + f).value = d
    }
    cm.MarchModal.updateTroopResource()
}

function modal_attack_update_rec_max(e) {
    e = +e;
    modal_attack_update_rec_reset(e);
    var d = (e === 0) ? "gold" : "rec" + e,
        f = +($("modal_attack_rec_max_" + d).innerHTML),
        a = Math.max(+($("modal_attack_vacancy").innerHTML), 0),
        b = e === 5 ? Math.floor(a / 5) : Math.floor(a),
        c = Math.min(b, f);
    if (a <= 0) {
        return
    }
    $("modal_attack_" + d).value = c;
    $("modal_attack_vacancy").innerHTML = a - c;
    cm.MarchModal.updateTroopResource()
}

function modal_attack_update_rec_reset(g) {
    g = +g;
    var f = (g === 0) ? "gold" : "rec" + g,
        e = "modal_attack_" + f,
        c = +($(e).value) || 0,
        d = c * (g === 5 ? 5 : 1),
        a = Math.max(+($("modal_attack_vacancy").innerHTML), 0),
        b = a + d;
    $(e).value = 0;
    $("modal_attack_vacancy").innerHTML = b;
    cm.MarchModal.updateTroopResource()
}

function modal_attack_update_unt_max(d) {
    var c = 0,
        b = getBuildingLevel(12),
        a = $("modal_attack_item931"),
        g = $("modal_attack_item932"),
        e = 1,
        f = unixtime();
    if (seed.playerEffects.aurasExpire) {
        if (seed.playerEffects.aurasExpire > f) {
            e = 1.15
        }
    }
    if (seed.playerEffects.auras2Expire) {
        if (seed.playerEffects.auras2Expire > f) {
            e = 1.3
        }
    }
    if (d === 1) {
        if (a.checked) {
            if (ksoItems[931].count > 0) {
                e += 0.25
            }
            g.checked = false
        }
    } else {
        if (d === 2) {
            if (g.checked) {
                if (ksoItems[932].count > 0) {
                    e += 0.5
                }
                a.checked = false
            }
        }
    }
    if (b === 11) {
        c = 150000 * e
    } else {
        if (b === 12) {
            c = 200000 * e
        } else {
            c = (b * 10000) * e
        }
    }
    $("modal_attack_maxunt").innerHTML = Math.round(c)
}

function modal_attack_item_march(a) {
    var b = 55;
    if (parseInt(a) == 55) {
        b = 57
    }
    if ($("modal_attack_item" + a).checked) {
        $("modal_attack_item" + b).checked = false
    }
    modal_attack_update_time()
}

function modal_attack_normalize_number(b) {
    var a = parseInt(b.value, 10);
    b.value = isNaN(a) ? 0 : a
}

function modal_attack_update_num_max(a) {
    $("modal_attack_unit_ipt" + a).value = parseInt(seed.units["city" + currentcityid]["unt" + a]);
    modal_attack_update_num($("modal_attack_unit_ipt" + a))
}

function modal_attack_update_num(c) {
    var g = jQuery("#modal_attack_unitlist input");
    var e = 0;
    var j, a;
    for (var f = 0; f < g.length; f++) {
        j = g[f];
        if (j != c) {
            a = parseInt(j.value);
            e += isNaN(e) ? 0 : a
        }
    }
    enteredValue = parseInt(c.value, 10);
    var b = parseInt(seed.units["city" + currentcityid]["unt" + c.getAttribute("name")]);
    var k = parseInt($("modal_attack_maxunt").innerHTML);
    var h = isNaN(enteredValue) ? 0 : enteredValue;
    var d = Math.min(b, k - e);
    c.value = c.value === "" ? "" : Math.min(h, d);
    cm.MarchModal.updateTroopResource();
    modal_attack_update_time()
}

function modal_attack_update_time() {
    var d = $("modal_attack_unitlist").getElementsByTagName("input");
    var a = {};
    for (var c = 0; c < d.length; c++) {
        a[parseInt(d[c].getAttribute("name"))] = d[c].value
    }
    var b = {};
    if ($("modal_attack_item57").checked) {
        b["57"] = true
    } else {
        if ($("modal_attack_item55").checked) {
            b["55"] = true
        }
    }
    $("modal_attack_esttime").innerHTML = cm.MarchModal.marchTimeCalculator(a, $("modal_attack_target_coords_x").value, $("modal_attack_target_coords_y").value, false, b)
}

function modal_attack_check(b) {
    if (!cm.MarchModal.isMarchAllowed()) {
        return
    }
    if (Number(seed.playerEffects.vacationExpire) > unixtime()) {
        Modal.multiButton({
            buttons: [{
                txt: g_js_strings.modal_myitems_confirm_vacation_continue_button,
                exe: function () {
                    seed.playerEffects.vacationExpire = unixtime() - 1;
                    seed.player.truceExpireUnixTime = unixtime() - 1;
                    seed.playerEffects.troopUpkeepReductExp = unixtime() - 1;
                    seed.playerEffects.fogExpire = unixtime() - 1;
                    update_boosts();
                    modal_attack_do()
                }
            }, {
                txt: g_js_strings.commonstr.cancel,
                exe: function () {
                    Modal.hideModal()
                }
            }],
            body: g_js_strings.vacationMode.modal_attack_vacation
        })
    } else {
        if (cm.item.fire("stop_action", modal_attack_do) == true) {
            return false
        } else {
            if ((parseInt(seed.playerEffects.fogExpire) > unixtime()) && ($("modal_attack_atktype").value == 4 || $("modal_attack_atktype").value == 3)) {
                var c = new Array();
                var a = new Array();
                c.push("<div class='mistwarn'>");
                c.push(g_js_strings.modal_attack_check.warning);
                c.push("</div>");
                c.push("<div class='mistsexpl'>");
                c.push(g_js_strings.modal_attack_check.warningdesc);
                c.push("</div>");
                a.push("<a class='button20' onclick='Modal.hideModal();modal_attack_do();return false;'><span>");
                a.push(g_js_strings.modal_attack_check.marchon);
                a.push("</span></a>");
                a.push("<a class='button20' onclick='Modal.hideModal();return false;'><span>");
                a.push(g_js_strings.modal_attack_check.canmarch);
                a.push("</span></a>");
                Modal.showAlert(c.join(""), a.join(""))
            } else {
                modal_attack_do()
            }
        }
    }
}
var boosted = false;

function updateBoosts(a, b) {
    var b = unixtime();
    if (parseInt(a.atkBoostTime) > 0) {
        boosted = true;
        if (!(parseInt(seed.playerEffects.atkExpire) > b)) {
            seed.playerEffects.atkExpire = b + parseInt(a.atkBoostTime)
        } else {
            seed.playerEffects.atkExpire = parseInt(seed.playerEffects.atkExpire) + parseInt(a.atkBoostTime)
        }
    }
    if (parseInt(a.atk2BoostTime) > 0) {
        if (!(parseInt(seed.playerEffects.atk2Expire) > b)) {
            seed.playerEffects.atk2Expire = b + parseInt(a.atk2BoostTime)
        } else {
            seed.playerEffects.atk2Expire = parseInt(seed.playerEffects.atk2Expire) + parseInt(a.atk2BoostTime)
        }
        if (seed.playerEffects.atkExpire && parseInt(seed.playerEffects.atkExpire) > b) {
            seed.playerEffects.atkExpire = parseInt(seed.playerEffects.atkExpire) + parseInt(a.atk2BoostTime)
        }
    }
    if (parseInt(a.defBoostTime) > 0) {
        boosted = true;
        if (!(parseInt(seed.playerEffects.defExpire) > b)) {
            seed.playerEffects.defExpire = b + parseInt(a.defBoostTime)
        } else {
            seed.playerEffects.defExpire = parseInt(seed.playerEffects.defExpire) + parseInt(a.defBoostTime)
        }
    }
    if (parseInt(a.def2BoostTime) > 0) {
        if (!(parseInt(seed.playerEffects.def2Expire) > b)) {
            seed.playerEffects.def2Expire = b + parseInt(a.def2BoostTime)
        } else {
            seed.playerEffects.def2Expire = parseInt(seed.playerEffects.def2Expire) + parseInt(a.def2BoostTime)
        }
        if (seed.playerEffects.defExpire && parseInt(seed.playerEffects.defExpire) > b) {
            seed.playerEffects.defExpire = parseInt(seed.playerEffects.defExpire) + parseInt(a.def2BoostTime)
        }
    }
}

function modal_attack_do() {
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    params.type = $("modal_attack_atktype").value;
    params.kid = $("modal_attack_knight").value;
    params.xcoord = $("modal_attack_target_coords_x").value;
    params.ycoord = $("modal_attack_target_coords_y").value;
    var unts = $("modal_attack_unitlist").getElementsByTagName("input");
    var unitsarr = {};
    var totalTroops = 0;
    var totalResources = 0;
    var unitId = null;
    var hasScout = false;
    var i;
    for (i = 0; i < unts.length; i++) {
        unitId = +(unts[i].getAttribute("name"));
        if (unts[i].value > 0) {
            totalTroops += +(unts[i].value);
            params["u" + unitId] = unitsarr[unitId] = unts[i].value
        } else {
            unitsarr[unitId] = 0
        }
    }
    var resources = new Array();
    params.gold = $("modal_attack_gold").value;
    resources.push(params.gold);
    totalResources += parseInt($("modal_attack_gold").value);
    var recLength;
    if (cm.WorldSettings.isOn("DARK_FOREST_AETHERSTONE_PVP")) {
        recLength = 5
    } else {
        recLength = 4
    }
    for (var i = 1; i <= recLength; i++) {
        totalResources += parseInt($("modal_attack_rec" + i).value);
        params["r" + i] = $("modal_attack_rec" + i).value;
        resources.push(params["r" + i])
    }
    var itemlist = [55, 57, 221, 261, 262, 271, 272, 931, 932, 280, 281];
    var iused = new Array();
    for (var i = 0; i < itemlist.length; i++) {
        var l_elem = $("modal_attack_item" + itemlist[i]);
        if (l_elem && l_elem.checked && parseInt(seed.items["i" + itemlist[i]]) > 0) {
            iused.push(itemlist[i])
        }
    }
    params.items = iused.join(",");
    if (totalTroops == 0) {
        Modal.showAlert(g_js_strings.modal_attack_do.sendtroop);
        return false
    }
    if (params.type == cm.MARCH_TYPES.MARCH_TYPE_TRANSPORT && totalResources == 0) {
        Modal.showAlert(g_js_strings.modal_attack_do.transportitem);
        return false
    }
    if (params.type == cm.MARCH_TYPES.MARCH_TYPE_SCOUT) {
        for (unitId in cm.unitScoutTypes) {
            if ($("modal_attack_unit_ipt" + unitId).value.blank() || ($("modal_attack_unit_ipt" + unitId).value == 0)) {
                continue
            }
            hasScout = true;
            break
        }
        if (!hasScout) {
            Modal.showAlert(g_js_strings.modal_attack_do.sendscout);
            return false
        }
    }
    if (params.type == cm.MARCH_TYPES.MARCH_TYPE_ATTACK && params.kid == 0) {
        Modal.showAlert(g_js_strings.modal_attack_do.sendknight);
        return false
    }
    if (isNaN(parseInt(params.xcoord)) || isNaN(parseInt(params.ycoord))) {
        Modal.showAlert(g_js_strings.modal_attack_do.specifytarget);
        return false
    }
    if (("on" == cm.features.AUTO_ATTACK) && (params.type == cm.MARCH_TYPES.MARCH_TYPE_ATTACK) && $("modal_attack_raidfilter_checkbox").checked) {
        return cm.MarchModal.saveRaid(params)
    }
    var modalInstanceId = cm.MarchModal.getInstanceId();
    var AttackCall_ = function () {
            if (!cm.MarchModal.isModelOpened() || (cm.MarchModal.getInstanceId() != modalInstanceId)) {
                return
            }
            var profiler = new cm.Profiler("ResponseTime", "march.php");
            ajax.Request(g_ajaxpath + "ajax/march.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                loading: true,
                onSuccess: function (transport) {
                    profiler.stop();
                    cm.MarchModal.setBackedOff(false);
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        cm.sounds.play("player_initiates_march");
                        Modal.hideModalAll();
                        var timediff = parseInt(rslt.eta) - parseInt(rslt.initTS);
                        var ut = unixtime();
                        attach_addoutgoingmarch(rslt.marchId, rslt.marchUnixTime, ut + timediff, params.xcoord, params.ycoord, unitsarr, params.type, params.kid, resources, rslt.tileId, rslt.tileType, rslt.tileLevel, currentcityid, true);
                        if (rslt.updateSeed) {
                            update_seed(rslt.updateSeed)
                        }
                        var ut = unixtime();
                        boosted = false;
                        updateBoosts(rslt);
                        if (rslt.liftFog) {
                            boosted = true;
                            seed.playerEffects.fogExpire = 0;
                            g_mapObject.getMoreSlots()
                        }
                        if (boosted) {
                            update_boosts()
                        }
                        if (parseInt(rslt.knightCombatBoostTime) > 0) {}
                        var mpiused = "no";
                        if (iused.length > 0) {
                            mpiused = "yes"
                        }
                        for (var i = 0; i < iused.length; i++) {
                            seed.items["i" + iused[i]] = parseInt(seed.items["i" + iused[i]]) - 1;
                            ksoItems[iused[i]].subtract()
                        }
                        UserEngagement.popViralModalUEP()
                    } else {
                        if (rslt.user_action) {
                            var user_action = {
                                title: '<span class="march_useraction_title"></span>',
                                marchWarning: function () {
                                    var body = ['<div class="march_useraction_warning"><div class="title">', g_js_strings.modal_attack.useractionwarningtitle, "</div>", "<div>", g_js_strings.modal_attack.useractionwarningmessage, "</div></div>"].join("");
                                    var buttons = {
                                        okay: {
                                            txt: g_js_strings.modal_attack.useractionwarningiunderstand,
                                            cls: "inlineButton blue25",
                                            exe: function () {
                                                Modal.hideModal();
                                                params.marchWarning = 1;
                                                AttackCall_()
                                            }
                                        }
                                    };
                                    Modal.multiButton({
                                        title: user_action.title,
                                        noControl: true,
                                        body: body,
                                        buttonContainerClass: "",
                                        buttons: buttons,
                                        buttonContainerClass: "march_useraction_buttons clearfix"
                                    })
                                },
                                marchCaptcha: function () {
                                    var captcha_form_id = "march_captcha_" + Math.floor(Math.random() * 10000000);
                                    var body = ["<div class='march_useraction_warning'><div>", g_js_strings.modal_attack.useractioncaptchap1, "</div>", '<div class="captcha_container"><form id="', captcha_form_id, '"></form></div>', "<div>", g_js_strings.modal_attack.useractioncaptchap2, "</div></div>"].join("");
                                    var SubmitForm = function (event) {
                                            event.preventDefault();
                                            event.stopPropagation();
                                            params.marchWarning = 1;
                                            params.marchCaptcha_challenge = Recaptcha.get_challenge();
                                            params.marchCaptcha_response = Recaptcha.get_response();
                                            Modal.hideModal();
                                            AttackCall_();
                                            return false
                                        };
                                    var buttons = {
                                        okay: {
                                            txt: g_js_strings.commonstr.ok,
                                            cls: "inlineButton blue25",
                                            exe: SubmitForm
                                        }
                                    };
                                    Modal.onCloseCallback = function () {
                                        Recaptcha.destroy()
                                    };
                                    Modal.multiButton({
                                        title: user_action.title,
                                        noControl: true,
                                        body: body,
                                        buttons: buttons,
                                        buttonContainerClass: "march_useraction_buttons clearfix"
                                    });
                                    Recaptcha.create("6LcT7cQSAAAAAG4whvbBz60hGjJg0ON1wRIRv_iD", captcha_form_id, {
                                        callback: Recaptcha.focus_response_field,
                                        theme: "white"
                                    });
                                    jQuery("#" + captcha_form_id).submit(SubmitForm)
                                },
                                backOffWaitTime: function () {
                                    cm.MarchModal.setBackedOff(true);
                                    params.tt = rslt.tt;
                                    setTimeout(AttackCall_, rslt.wait_time * 1000)
                                }
                            };
                            user_action[rslt.user_action].call();
                            return
                        }
                        Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                    }
                },
                onFailure: function () {
                    profiler.stop();
                    cm.MarchModal.setBackedOff(false)
                }
            })
        };
    AttackCall_()
}

function modal_attack_target_coords() {
    $("modal_attack_target_dropdown").hide();
    $("modal_attack_target_coords").show()
}

function modal_attack_target_dropdown() {
    $("modal_attack_target_coords").hide();
    $("modal_attack_target_dropdown").show();
    var strHTML = [];
    var params = Object.clone(g_ajaxparams);
    params.requestType = "GET_BOOKMARK_INFO";
    new Ajax.Request(g_ajaxpath + "ajax/tileBookmark.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                var bookmarkInfo = rslt.bookmarkInfo;
                strHTML.push("<select onchange='selectAttackBookmark(this);return false;' tabindex='153'>");
                strHTML.push("<option value='0'>" + g_js_strings.modal_attack_target_dropdown.choosebookmark + "</option>");
                for (var i = 0; i < seed.cities.length; i++) {
                    strHTML.push("<option value='" + seed.cities[i][2] + "_" + seed.cities[i][3] + "'>" + seed.cities[i][1] + " (" + seed.cities[i][2] + ", " + seed.cities[i][3] + ") </option>")
                }
                for (id in bookmarkInfo) {
                    strHTML.push("<option value='" + bookmarkInfo[id].xCoord + "_" + bookmarkInfo[id].yCoord + "'>" + bookmarkInfo[id].name + " (" + bookmarkInfo[id].xCoord + ", " + bookmarkInfo[id].yCoord + ") </option>")
                }
                strHTML.push("</select>");
                $("savedCoordinatesDropdown").innerHTML = strHTML.join("")
            }
        },
        onFailure: function () {}
    })
}

function selectAttackBookmark(b) {
    if (b.value == 0) {
        return false
    } else {
        var a = b.value.split("_");
        $("modal_attack_target_coords_x").value = a[0];
        $("modal_attack_target_coords_y").value = a[1];
        modal_attack_target_coords();
        modal_attack_update_time()
    }
}

function attack_addqueue(p, a, f, e, n, l, o, g, c, d, k, m, j) {
    var b = new Object(),
        h;
    b.destinationUnixTime = parseInt(f);
    b.marchUnixTime = parseInt(a);
    b.returnUnixTime = b.destinationUnixTime - b.marchUnixTime + b.destinationUnixTime;
    b.toXCoord = e;
    b.toYCoord = n;
    b.marchType = o;
    b.knightId = g;
    b.marchStatus = 1;
    b.gold = c[0];
    if (d) {
        b.toTileId = d;
        b.toTileType = k;
        b.toTileLevel = m
    }
    for (h = 1; h < 5; h++) {
        b["resource" + h] = c[h]
    }
    for (h in l) {
        b["unit" + h + "Count"] = l[h];
        b["unit" + h + "Return"] = 0
    }
    if (Object.isArray(seed.queue_atkp["city" + j])) {
        seed.queue_atkp["city" + j] = new Object()
    }
    seed.queue_atkp["city" + j]["m" + p] = b
}

function attach_addoutgoingmarch(r, a, g, e, o, m, p, h, c, d, l, n, k, q) {
    var j;
    k = k || currentcityid;
    if (q) {
        var f = seed.units["city" + k];
        for (j in m) {
            var b = parseInt(m[j]);
            if (!isNaN(b) && (b > 0)) {
                f["unt" + j] = parseInt(f["unt" + j]) - b
            }
        }
    }
    if (parseInt(h) != 0) {
        seed.knights["city" + k]["knt" + h].knightStatus = 10
    }
    attack_addqueue(r, a, g, e, o, m, p, h, c, d, l, n, k);
    cityinfo_army();
    cm.MarchProgressBar.forceOn(k);
    attack_generatequeue()
}
var g_ftdpromo = false;

function attack_generateincoming() {
    var f = new Array();
    var d = false;
    if (!Object.isArray(seed.queue_atkinc) && Object.keys(seed.queue_atkinc) && Object.keys(seed.queue_atkinc).length > 0) {
        var c = unixtime();
        var g = 0;
        var a = c + 9999999;
        var h = Object.keys(seed.queue_atkinc);
        for (var e = 0; e < h.length; e++) {
            if (seed.queue_atkinc[h[e]].score) {
                d = true
            }
            if (seed.queue_atkinc[h[e]].arrivalTime) {
                var j = parseInt(seed.queue_atkinc[h[e]].arrivalTime);
                if (j < a && j > c) {
                    a = j;
                    g = parseInt(h[e].split("m")[1])
                }
            }
        }
        if (d) {
            f.push("<div style='font-weight:bold;margin-top:8px;padding:0; color: red;'>");
            f.push("<div class='clearfix' style='display:block;'><span style='float:left;margin-right:5px;'>" + g_js_strings.attack_generateincoming.impendingattack + "</span>");
            f.push("<a class='button14' onclick='attack_viewimpending();return false;'><span style='color:#FFF;'>" + g_js_strings.commonstr.view + "</span></a>");
            f.push("</div>");
            f.push("<div style='padding-top:0;font-weight:normal;'>");
            if (g != 0) {
                f.push(g_js_strings.attack_generateincoming.estimatedarrival + ": ");
                f.push(timestr(a - c))
            } else {
                f.push("&nbsp;")
            }
            f.push("</div>");
            f.push("</div>");
            g_ftdpromo = false
        }
    }
    var k = false;
    if (!d) {
        f = new Array();
        var b = 4 - parseInt((unixtime() - parseInt(seed.player.datejoinUnixTime)) / 86400);
        if (parseInt(seed.player.warStatus) == 2) {
            f.push('<div><a onclick="modal_guide();return false;">' + g_js_strings.attack_generateincoming.lostreadguide + "</a>" + g_js_strings.attack_generateincoming.protecteddays.replace("%1$s", b) + "</div>")
        } else {
            f.push('<div><a onclick="modal_guide();return false;">' + g_js_strings.attack_generateincoming.lostreadguide + "</a>" + g_js_strings.attack_generateincoming.unprotecteddays + "</div>")
        }
    }
}

function attack_viewimpending(d) {
    var c = new Array();
    c.push("<div id='modal_attackimpending'>");
    c.push("<div class='troopopt'>" + g_js_strings.attack_viewimpending_view.troophideoption + "</div>");
    c.push("<table cellpadding='0' cellspacing='0'><thead><tr><td>" + g_js_strings.commonstr.target + "</td><td>" + g_js_strings.commonstr.view + "</td></tr></thead><tbody>");
    var h = Object.keys(seed.queue_atkinc);
    for (var e = 0; e < h.length; e++) {
        var a = seed.queue_atkinc[h[e]].toTileId;
        var f = incomingAttackInfo(a);
        var g;
        var j = parseInt(seed.queue_atkinc[h[e]].arrivalTime);
        var b = unixtime();
        if (f.length) {
            g = f[0] + " (" + f[1] + "," + f[2] + ")"
        } else {
            g = attack_cityidtoname(seed.queue_atkinc[h[e]].toCityId)
        }
        if (seed.queue_atkinc[h[e]].score) {
            c.push("<tr><td>");
            c.push(g);
            c.push("</td><td>");
            c.push("<a class='button20' onclick='attack_viewimpending_view(" + h[e].split("m")[1] + ",&quot;" + g + "&quot;, " + d + ");return false;'><span style='color:#FFF;'>" + g_js_strings.commonstr.view + "</span></a>");
            c.push("</td></tr>")
        }
    }
    c.push("</tbody></table>");
    if (d) {
        c.push('<div class="buttonContainer"><a class="inlineButton blue20" onclick="modal_build(' + d + ')"><span>' + g_js_strings.attack_viewimpending_view.gotowatchtower + "</span></a></div>")
    }
    c.push("</div>");
    Modal.showModal(500, 400, 120, 190, g_js_strings.modaltitles.impatks, c.join(""))
}

function incomingAttackInfo(b) {
    var g = [],
        e = seed.wilderness,
        f, c, h, d, a = 1;
    if (!(e instanceof Array) && typeof (e) === "object") {
        for (f in e) {
            if (a) {
                c = e[f];
                for (h in c) {
                    if (c[h]["tileId"] == b) {
                        if (c[h]["tileType"] == cm.WILDERNESS_TYPES.PLAIN) {
                            d = g_js_strings.commonstr.plain
                        } else {
                            if (c[h]["tileType"] == cm.WILDERNESS_TYPES.GRASSLAND) {
                                d = g_js_strings.commonstr.grassland
                            } else {
                                if (c[h]["tileType"] == cm.WILDERNESS_TYPES.LAKE) {
                                    d = g_js_strings.commonstr.lake
                                } else {
                                    if (c[h]["tileType"] == cm.WILDERNESS_TYPES.WOODS) {
                                        d = g_js_strings.commonstr.woods
                                    } else {
                                        if (c[h]["tileType"] == cm.WILDERNESS_TYPES.HILLS) {
                                            d = g_js_strings.commonstr.hills
                                        } else {
                                            if (c[h]["tileType"] == cm.WILDERNESS_TYPES.MOUNTAIN) {
                                                d = g_js_strings.commonstr.mountain
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        g.push(d);
                        g.push(c[h]["xCoord"]);
                        g.push(c[h]["yCoord"]);
                        a = 0;
                        break
                    }
                }
            } else {
                break
            }
        }
    }
    return g
}

function attack_cityidtoname(b) {
    for (var a = 0; a < seed.cities.length; a++) {
        if (parseInt(seed.cities[a][0]) == parseInt(b)) {
            return seed.cities[a][1]
        }
    }
    return ""
}

function attack_viewimpending_view(e, g, d) {
    var c = new Array();
    var a = seed.queue_atkinc["m" + e];
    c.push("<div id='modal_attackimpending_view'>");
    c.push("<div><b>" + g_js_strings.commonstr.target + ":</b> ");
    if (a.score != 0) {
        c.push(g)
    } else {
        c.push(g_js_strings.attack_viewimpending_view.upgradetoseeinfo)
    }
    c.push("</div>");
    c.push("<div><b>" + g_js_strings.modal_attack.marchtype + ":</b> ");
    if (a.marchType) {
        if (parseInt(a.marchType) == 4) {
            c.push(g_js_strings.commonstr.attack)
        } else {
            if (parseInt(a.marchType) == 3) {
                c.push(g_js_strings.commonstr.scout)
            }
        }
    } else {
        c.push(g_js_strings.attack_viewimpending_view.upgradetoseeinfo)
    }
    c.push("</div>");
    c.push("<div><b>" + g_js_strings.attack_generateincoming.estimatedarrival + ":</b> ");
    if (a.arrivalTime) {
        c.push(timestr(parseInt(a.arrivalTime) - unixtime()))
    } else {
        c.push(g_js_strings.attack_viewimpending_view.upgradetoseeinfo)
    }
    c.push("</div>");
    c.push("<div><b>" + g_js_strings.commonstr.attacker + ":</b> ");
    if (a.pid) {
        c.push(seed.players["u" + a.pid].n)
    } else {
        c.push(g_js_strings.attack_viewimpending_view.upgradetoseeinfo)
    }
    c.push("</div>");
    c.push("<div><b>" + g_js_strings.commonstr.alliance + ":</b> ");
    if (parseInt(a.score) > 3) {
        if (a.aid) {
            if (seed.allianceNames && seed.allianceNames["a" + a.aid]) {
                c.push(seed.allianceNames["a" + a.aid])
            } else {
                c.push("None")
            }
        } else {
            c.push("None")
        }
    } else {
        c.push(g_js_strings.attack_viewimpending_view.upgradetoseeinfo)
    }
    c.push("</div>");
    c.push("<div><b>" + g_js_strings.attack_viewimpending_view.armysize + ":</b> ");
    if (parseInt(a.score) > 4) {
        c.push(a.cnt)
    } else {
        c.push(g_js_strings.attack_viewimpending_view.upgradetoseeinfo)
    }
    c.push("</div>");
    c.push("<div><b>" + g_js_strings.attack_viewimpending_view.incomingtroops + ":</b></div>");
    if (parseInt(a.score) > 5) {
        c.push("<table cellpadding='0' cellspacing='0'><thead><tr><td>" + g_js_strings.commonstr.type + "</td><td>Amount</td></tr></thead><tbody>");
        var h = Object.keys(a.unts);
        for (var f = 0; f < h.length; f++) {
            c.push("<tr><td>");
            c.push(unitcost["unt" + h[f].split("u")[1]][0]);
            c.push("</td><td>");
            if (parseInt(a.score) > 6) {
                c.push(a.unts[h[f]])
            } else {
                c.push(g_js_strings.attack_viewimpending_view.upgradetoseeinfo)
            }
            c.push("</td></tr>")
        }
        c.push("</tbody></table>")
    } else {
        c.push("<div>" + g_js_strings.attack_viewimpending_view.upgradetoseeinfo + "</div>")
    }
    c.push("<div><b>" + g_js_strings.attack_viewimpending_view.knightcomlvl + ":</b> ");
    if (a.knt && a.knt.cbt) {
        c.push(a.knt.cbt)
    } else {
        c.push(g_js_strings.attack_viewimpending_view.upgradetoseeinfo)
    }
    c.push("</div>");
    c.push("<div><b>" + g_js_strings.attack_viewimpending_view.techlevels + ":</b></div>");
    if (parseInt(a.score) > 9) {
        c.push("<table cellpadding='0' cellspacing='0'><thead><tr><td>" + g_js_strings.commonstr.tech + "</td><td>" + g_js_strings.commonstr.level + "</td></tr></thead><tbody>");
        var b = Object.keys(a.tech);
        for (var f = 0; f < b.length; f++) {
            c.push("<tr><td>");
            c.push(techcost["tch" + b[f].split("t")[1]][0]);
            c.push("</td><td>");
            c.push(a.tech[b[f]]);
            c.push("</td></tr>")
        }
        c.push("</tbody></table>")
    } else {
        c.push("<div>" + g_js_strings.attack_viewimpending_view.upgradetoseeinfo + "</div>")
    }
    if (d) {
        c.push('<div class="buttonContainer"><a class="inlineButton blue20" onclick="modal_build(' + d + ')"><span>' + g_js_strings.attack_viewimpending_view.gotowatchtower + "</span></a></div>")
    }
    c.push("</div>");
    Modal.showModal(500, 400, 120, 190, g_js_strings.modaltitles.impatks, c.join(""))
}

function attack_generatequeue() {
    var H, h, D, p = null,
        c = [],
        G = [],
        t, z, A, y, F, g;
    for (D in seed.queue_atkp) {
        var v = "city" + currentcityid == D;
        var q = seed.queue_atkp[D];
        if (!Object.isArray(q)) {
            $("mod_untqueue").show();
            var n = unixtime();
            var l = Object.keys(q);
            var s = l.length;
            for (var x = 0; x < s; x++) {
                var r = q[l[x]];
                if (!r) {
                    continue
                }
                var o = true;
                var a = 0;
                var j = parseInt(r.marchStatus);
                var f = parseInt(r.marchType);
                if (r && r.destinationUnixTime) {
                    if (j == cm.MARCH_STATUS.MARCH_STATUS_STOPPED) {
                        o = false;
                        a = 0
                    } else {
                        if (n < parseInt(r.destinationUnixTime)) {
                            a = parseInt(r.destinationUnixTime) - n
                        } else {
                            if (j != cm.MARCH_STATUS.MARCH_STATUS_DEFENDING) {
                                a = parseInt(r.returnUnixTime) - n
                            } else {
                                a = 0
                            }
                            if (n == parseInt(r.destinationUnixTime)) {
                                if ((j != cm.MARCH_STATUS.MARCH_STATUS_RETURNING) && (j != cm.MARCH_STATUS.MARCH_STATUS_DEFENDING)) {
                                    seed.queue_atkp[D][l[x]].marchStatus = cm.MARCH_STATUS.MARCH_STATUS_UNKNOWN
                                }
                                window.setTimeout("update_seed_ajax(true)", 5000)
                            }
                            o = false
                        }
                    }
                    if (a > 0 && j != cm.MARCH_STATUS.MARCH_STATUS_UNKNOWN) {
                        var b = 1;
                        if (j == cm.MARCH_STATUS.MARCH_STATUS_RETURNING) {
                            b = parseInt(r.returnUnixTime) - parseInt(r.destinationUnixTime)
                        } else {
                            var b = parseInt(r.destinationUnixTime) - parseInt(r.marchUnixTime)
                        }
                        if (v) {
                            var u = "";
                            if (f == cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN) {
                                p = G;
                                u = "raid"
                            } else {
                                p = c
                            }
                            p.push('<div class="untqueue_item clearfix">');
                            p.push('<div class="atkpic ');
                            if (j == cm.MARCH_STATUS.MARCH_STATUS_RETURNING) {
                                p.push("returning")
                            } else {
                                if ((j == cm.MARCH_STATUS.MARCH_STATUS_UNKNOWN) || (j == cm.MARCH_STATUS.MARCH_STATUS_DEFENDING)) {
                                    p.push("reinforce")
                                } else {
                                    if (f == cm.MARCH_TYPES.MARCH_TYPE_SCOUT || f == cm.MARCH_TYPES.MARCH_TYPE_DARK_FOREST_SCOUT) {
                                        p.push("scouting")
                                    } else {
                                        if (f == cm.MARCH_TYPES.MARCH_TYPE_REINFORCE) {
                                            p.push("reinforce")
                                        } else {
                                            if (f == cm.MARCH_TYPES.MARCH_TYPE_TRANSPORT) {
                                                p.push("transporting")
                                            } else {
                                                if (f == cm.MARCH_TYPES.MARCH_TYPE_REASSIGN) {
                                                    p.push("transporting")
                                                } else {
                                                    p.push("attacking")
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            p.push('"></div>');
                            p.push('<div class="info"><div class="stat"><div class="time">');
                            p.push(timestr(a));
                            p.push("</div>");
                            if (o) {
                                p.push('<div class="tgt">');
                                var K = new cm.utils.CoordinateLink(r.toXCoord, r.toYCoord);
                                K.setClassName("coordinateLink");
                                p.push(K.getHTML());
                                p.push("</div>")
                            }
                            p.push('</div><div class="bar ' + u + '" style="width: ');
                            if (o) {
                                p.push(123 - parseInt(123 * (a / b)))
                            } else {
                                var d = parseInt(123 * (a / b));
                                if (d > 123) {
                                    d = 123
                                }
                                p.push(d)
                            }
                            p.push('px;">&nbsp;</div></div>');
                            if ((f == cm.MARCH_TYPES.MARCH_TYPE_ATTACK) || (f == cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN)) {
                                p.push('<div class="attack_knight_info clearfix">');
                                var E = r.knightId;
                                var J = seed.knights["city" + currentcityid]["knt" + E].knightName.split(" ");
                                var w = 0;
                                if (f == cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN && j == cm.MARCH_STATUS.MARCH_STATUS_RETURNING) {
                                    F = "Return"
                                } else {
                                    F = "Count"
                                }
                                for (t in cm.UNIT_TYPES) {
                                    A = "unit" + cm.UNIT_TYPES[t] + F;
                                    y = 0;
                                    try {
                                        y = +(r[A])
                                    } catch (C) {}
                                    if (!isNaN(y)) {
                                        w += y
                                    }
                                }
                                p.push('<div class="name">' + g_js_strings.commonstr.knight + ": " + J[0] + "</div>");
                                p.push('<div class="army">' + g_js_strings.commonstr.army + ": " + w + "</div>");
                                p.push("</div>")
                            }
                            p.push("</div>")
                        }
                    } else {
                        var I = r.hasUpdated;
                        if ((j != cm.MARCH_STATUS.MARCH_STATUS_DEFENDING) && (j != cm.MARCH_STATUS.MARCH_STATUS_UNKNOWN) && (f != cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN)) {
                            if (I) {
                                if (f == cm.MARCH_TYPES.MARCH_TYPE_TRANSPORT) {
                                    F = "Count"
                                } else {
                                    if (f != cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN) {
                                        F = "Return"
                                    }
                                }
                                for (t in cm.UNIT_TYPES) {
                                    z = cm.UNIT_TYPES[t];
                                    A = "unit" + z + F;
                                    y = 0;
                                    try {
                                        y = +(r[A])
                                    } catch (C) {}
                                    if (!isNaN(y)) {
                                        g = "unt" + z;
                                        seed.units[D][g] = +(seed.units[D][g]) + y
                                    }
                                }
                                if ((f != cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN) && parseInt(r.knightId) != 0) {
                                    if (seed.knights[D]["knt" + seed.queue_atkp[D][l[x]].knightId]) {
                                        seed.knights[D]["knt" + seed.queue_atkp[D][l[x]].knightId].knightStatus = 1
                                    }
                                }
                                delete seed.queue_atkp[D][l[x]];
                                if (Object.keys(seed.queue_atkp[D]).length == 0) {
                                    seed.queue_atkp[D] = []
                                }
                            }
                        } else {
                            if ((j == cm.MARCH_STATUS.MARCH_STATUS_UNKNOWN) && (f == cm.MARCH_TYPES.MARCH_TYPE_REASSIGN) && I) {
                                delete seed.queue_atkp[D][l[x]];
                                if (Object.keys(seed.queue_atkp[D]).length == 0) {
                                    seed.queue_atkp[D] = []
                                }
                            }
                            if (v && r) {
                                var u = "";
                                if (f == cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN) {
                                    p = G;
                                    u = "raid"
                                } else {
                                    p = c
                                }
                                var m = "";
                                var B = "reinforce";
                                switch (j) {
                                case cm.MARCH_STATUS.MARCH_STATUS_DEFENDING:
                                    m = g_js_strings.commonstr.encamped;
                                    break;
                                case cm.MARCH_STATUS.MARCH_STATUS_STOPPED:
                                    m = g_js_strings.attack_generatequeue.raidstopped;
                                    B = "stopped";
                                    break;
                                case cm.MARCH_STATUS.MARCH_STATUS_RESTING:
                                    m = g_js_strings.attack_generatequeue.unloadingloot;
                                    B = "resting";
                                    break;
                                case cm.MARCH_STATUS.MARCH_STATUS_UNKNOWN:
                                case cm.MARCH_STATUS.MARCH_STATUS_RETURNING:
                                    if (f == cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN && n >= r.returnUnixTime) {
                                        m = g_js_strings.attack_generatequeue.unloadingloot;
                                        B = "resting"
                                    } else {
                                        m = g_js_strings.attack_generatequeue.waitreport
                                    }
                                    break
                                }
                                p.push('<div class="untqueue_item clearfix">');
                                p.push('<div class="atkpic ' + B + '"></div>');
                                p.push('<div class="info"><div class="stat"><div class="time">');
                                p.push(m);
                                p.push('</div><div class="tgt">');
                                var K = new cm.utils.CoordinateLink(r.toXCoord, r.toYCoord);
                                K.setClassName("coordinateLink");
                                p.push(K.getHTML());
                                p.push("</div>");
                                p.push("</div>");
                                p.push('<div class="bar ' + u + '" style="width: ');
                                p.push('0px;">&nbsp;</div></div>');
                                p.push("</div>")
                            }
                        }
                    }
                }
            }
        }
    }
    cm.MarchProgressBar.updateView(G.join("") + c.join(""))
}

function modal_wilderness_view(tileid, level, type, xcoor, ycoor) {
    var params = Object.clone(g_ajaxparams);
    params.tid = tileid;
    new Ajax.Request(g_ajaxpath + "ajax/viewTile.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                var msghtml = new Array();
                msghtml.push("<div class='wildviewwrap'>");
                msghtml.push("<div class='wildviewheader'>" + g_js_strings.commonstr.level + " " + level + "</div>");
                msghtml.push("<div class='wildviewtablewrap'>");
                msghtml.push("<table class='wildviewtable' cellpadding='0' cellspacing='0' border='0'>");
                msghtml.push("<thead>");
                msghtml.push("<tr>");
                msghtml.push("<td class='hero'>" + g_js_strings.commonstr.knight + "</td>");
                msghtml.push("<td>" + g_js_strings.commonstr.lord + "</td>");
                msghtml.push("<td>" + g_js_strings.commonstr.from + "</td>");
                msghtml.push("<td>" + g_js_strings.commonstr.recall + "</td>");
                msghtml.push("</tr>");
                msghtml.push("</thead>");
                if (!Object.isArray(rslt.defenders)) {
                    msghtml.push("<tbody>");
                    var cities = new Hash(rslt.defenders);
                    cities.each(function (pair) {
                        var marches = new Hash(pair.value);
                        marches.each(function (mpair) {
                            msghtml.push("<tr>");
                            msghtml.push("<td class='hero'>");
                            if (mpair.value.knightName == null) {
                                msghtml.push(g_js_strings.commonstr.noknight)
                            } else {
                                msghtml.push(mpair.value.knightName)
                            }
                            msghtml.push("</td>");
                            msghtml.push("<td>" + rslt.playerNames["u" + mpair.value.fromPlayerId] + "</td>");
                            msghtml.push("<td>");
                            var coordinateLink = new cm.utils.CoordinateLink(mpair.value.fromXCoord, mpair.value.fromYCoord);
                            coordinateLink.setClassName("coordinateLink");
                            msghtml.push(coordinateLink.getHTML());
                            msghtml.push("</td>");
                            if (mpair.value.marchStatus == 2 && mpair.value.fromPlayerId == tvuid) {
                                msghtml.push("<td ><a  onclick='Modal.hideModal();attack_recall(" + mpair.value.marchId + ",1," + mpair.value.fromCityId + ");return false;' class='button14'><span style='float:left'>" + g_js_strings.commonstr.recall + "</span></a><a  onclick='Modal.hideModal();view_march(" + mpair.value.marchId + ");return false;' class='button14'><span style='float:left'>" + g_js_strings.commonstr.view + "</span></a></td>")
                            } else {
                                msghtml.push("<td></td>")
                            }
                            msghtml.push("</tr>")
                        })
                    });
                    msghtml.push("</tbody>")
                }
                msghtml.push("</table>");
                msghtml.push("</div>");
                msghtml.push("</div>");
                Modal.showModal(500, 400, 120, 190, type + " (" + xcoor + "," + ycoor + ")", msghtml.join(""))
            }
        },
        onFailure: function () {}
    })
}

function modal_wilderness_abandon(tileid, level, type, xcoor, ycoor) {
    function abandon_exe() {
        var params = Object.clone(g_ajaxparams);
        params.tid = tileid;
        params.x = xcoor;
        params.y = ycoor;
        params.cid = currentcityid;
        new Ajax.Request(g_ajaxpath + "ajax/abandonWilderness.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    Modal.hideModal();
                    if (rslt.returningMarches && !Object.isArray(rslt.returningMarches)) {
                        var cities = Object.keys(rslt.returningMarches);
                        for (var i = 0; i < cities.length; i++) {
                            for (var j = 0; j < rslt.returningMarches[cities[i]].length; j++) {
                                var cid = cities[i].split("c")[1];
                                var mid = rslt.returningMarches[cities[i]][j];
                                var march = seed.queue_atkp["city" + cid]["m" + mid];
                                if (march) {
                                    var marchtime = Math.abs(parseInt(march.destinationUnixTime) - parseInt(march.marchUnixTime));
                                    var ut = unixtime();
                                    seed.queue_atkp["city" + cid]["m" + mid].destinationUnixTime = ut;
                                    seed.queue_atkp["city" + cid]["m" + mid].marchUnixTime = ut - marchtime;
                                    seed.queue_atkp["city" + cid]["m" + mid].returnUnixTime = ut + marchtime;
                                    seed.queue_atkp["city" + cid]["m" + mid].marchStatus = 8
                                }
                            }
                        }
                    }
                    if (rslt.updateSeed) {
                        update_seed(rslt.updateSeed)
                    }
                    if (Object.keys(seed.wilderness["city" + currentcityid]).length == 1) {
                        seed.wilderness["city" + currentcityid] = []
                    } else {
                        delete seed.wilderness["city" + currentcityid]["t" + tileid]
                    }
                    g_mapObject.getMoreSlots()
                }
            },
            onFailure: function () {}
        })
    }
    Modal.okay({
        okay: abandon_exe,
        text: g_js_strings.modal_questions.abandon + g_mapObject.typename[g_mapObject.types[parseInt(type)]].capitalize() + "?"
    })
}

function modal_attack_cancel(marchId) {
    var params = Object.clone(g_ajaxparams);
    params.marchId = marchId;
    params.requestType = "CANCEL_MARCH";
    new Ajax.Request(g_ajaxpath + "ajax/cancelMarch.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            seed.queue_atkp["city" + cid]["m" + marchId].destinationUnixTime = rslt.destinationUnixTime;
            seed.queue_atkp["city" + cid]["m" + marchId].returnUnixTime = rslt.returnUnixTime;
            seed.queue_atkp["city" + cid]["m" + marchId].marchStatus = 8;
            showResult(rslt)
        },
        onFailure: function () {}
    })
}

function showResult(a) {
    if (parseInt(a.error_code) == 253) {
        Modal.showAlert(g_js_strings.recall.error)
    } else {
        if (a.ok) {
            Modal.showAlert(g_js_strings.commonstr.cancelled)
        } else {
            Modal.showAlert(printLocalError((a.error_code || null), (a.msg || null), (a.feedback || null)))
        }
    }
}

function attack_checkOverMarch() {
    var b = Object.keys(seed.queue_atkp["city" + currentcityid]);
    var g = 0;
    var d = ["btnScout", "btnAttack", "btnMarch", "btnTransport", "btnReinforce", "btnReassign", "btnRaid"];
    for (var c = 0; c < b.length; c++) {
        var j = parseInt(seed.queue_atkp["city" + currentcityid][b[c]].marchStatus);
        if (j == 1 || j == 2 || j == 7 || j == 8 || j == 9) {
            g++
        }
    }
    var f = Object.keys(seed.buildings["city" + currentcityid]);
    var e = -1;
    for (var c = 0; c < f.length; c++) {
        var a = seed.buildings["city" + currentcityid][f[c]];
        if (parseInt(a[0]) == 12) {
            e = parseInt(a[1])
        }
    }
    if (g >= e) {
        for (var c = 0; c < d.length; c++) {
            if ($(d[c])) {
                $(d[c]).setOpacity(0.5);
                $(d[c]).setStyle("cursor: default");
                $(d[c]).onclick = function () {
                    return false
                }
            }
        }
        var h = $("btnMarch");
        if (h) {
            h.setOpacity(1);
            h.removeClassName("blue36");
            h.addClassName("grey36")
        }
        if ($("error_overmarch")) {
            $("error_overmarch").innerHTML = [g_js_strings.modal_attack.overmarch21, g_js_strings.modal_attack.overmarch22].join("<br />");
            $("error_overmarch").show()
        }
    }
}
var cm = cm || {};
cm.MarchModal = function ($) {
    var march_type_ = cm.MARCH_TYPES.MARCH_TYPE_NONE;
    var modal_start_type_ = cm.MARCH_TYPES.MARCH_TYPE_NONE;
    var march_detail_ = {};
    var last_effect_item_tabindex_ = 0;
    var is_allow_buy_ = false;
    var callbacks_ = {};
    var instanceId_ = null;
    var isMarchAllowed_ = true;
    var isModelOpened_ = false;
    var bind_ = function (extra_options) {
            instanceId_ = [(new Date()).getTime(), Math.random(), Math.random()].join("");
            isModelOpened_ = true;
            isMarchAllowed_ = true;
            is_allow_buy_ = false;
            callbacks_ = {};
            callbacks_.saveRaid = extra_options.callbackSaveRaid;
            $("#modal_attack .section.boost input").click(onBoostItemClick_);
            $("#modal_attack_supplyfilter_checkbox").click(filterTroops_);
            $("#modal_attack_raidfilter_checkbox").click(onRaidfilterClick_);
            $("#modal_attack .modal_attack_buy_item").click(onBuyItemButtonClick_);
            $("#btnMarch").click(modal_attack_check);
            var barbraidHelp = ["<ul>"];
            barbraidHelp.push("<li>" + g_js_strings.modal_attack.thisisabarbarianraidtooltipp1 + "</li>");
            barbraidHelp.push("<li>" + g_js_strings.modal_attack.thisisabarbarianraidtooltipp2 + "</li>");
            barbraidHelp.push("<li>" + g_js_strings.modal_attack.thisisabarbarianraidtooltipp3 + "</li>");
            barbraidHelp.push("<li>" + g_js_strings.modal_attack.thisisabarbarianraidtooltipp4 + "</li>");
            barbraidHelp.push("</ul>");
            cm.Tooltip.setTooltip({
                htmlElement: $("#modal_attack .raidfilter a"),
                tooltip: barbraidHelp.join("")
            });
            for (var i in march_detail_) {
                var selector = "#modal_attack_tab_" + i;
                $(selector).click({
                    march_type: i
                }, onTabClick_);
                $(selector).mouseover({
                    tooltip: march_detail_[i].tooltip
                }, onTooltipTatgetMouseover_);
                $(selector).mouseout(onTooltipTatgetMouseout_)
            }
            resetLastEffectItemTabindex_();
            $("#modal_attack .modal_attack_buy_item").delay(500).fadeIn(500, "swing", onBuyButtonFadedIn_)
        };
    var filterBoosts_ = function () {
            var boost_sections = $("#modal_attack .section.boost");
            if ((march_type_ == cm.MARCH_TYPES.MARCH_TYPE_ATTACK) && $("#modal_attack_raidfilter_checkbox").attr("checked")) {
                $("#btnMarch span").html(g_js_strings.modal_attack.raidandsave);
                boost_sections.addClass("filter");
                var boost_items = $("#modal_attack .section.boost input");
                for (var i = boost_items.length - 1; i >= 0; --i) {
                    if (boost_items[i].checked) {
                        $(boost_items[i]).removeAttr("checked");
                        $(boost_items[i]).trigger("click", {
                            is_force: true
                        })
                    }
                }
            } else {
                $("#btnMarch span").html(g_js_strings.commonstr.march);
                boost_sections.removeClass("filter")
            }
        };
    var filterTroops_ = function () {
            var troops = $("#modal_attack_unitlist .unit");
            var troop = null;
            var troop_type;
            var troop_number = 0;
            var units = seed.units["city" + currentcityid];
            var is_enable = false;
            var is_show_supply_only = $("#modal_attack_supplyfilter_checkbox").attr("checked");
            for (var i = troops.length - 1; i >= 0; --i) {
                troop = $(troops[i]);
                troop_type = parseInt(troop.attr("name"));
                troop_number = parseInt(units["unt" + troop_type]);
                is_enable = false;
                do {
                    if (march_type_ == cm.MARCH_TYPES.MARCH_TYPE_SCOUT && (undefined === cm.unitScoutTypes[troop_type])) {
                        break
                    }
                    if (march_type_ == cm.MARCH_TYPES.MARCH_TYPE_TRANSPORT && is_show_supply_only && (undefined === cm.unitSupplyTypes[troop_type])) {
                        break
                    }
                    if (isNaN(troop_number) || troop_number < 1) {
                        break
                    }
                    is_enable = true
                } while (false);
                var input = troop.find("input").first(),
                    button = $("#maxButton" + troop_type),
                    button2 = document.getElementById("maxButton" + troop_type);
                if (is_enable) {
                    input.removeAttr("disabled", true);
                    troop.removeClass("filter");
                    button2.onclick = function (troop_type) {
                        return function () {
                            modal_attack_update_num_max(troop_type + 1)
                        }
                    }(i)
                } else {
                    input.attr("disabled", true);
                    input.val(0);
                    troop.addClass("filter");
                    button2.onclick = function (troop_type) {
                        return function () {
                            return false
                        }
                    }(i)
                }
            }
        };
    var init_ = function () {
            initMarchDetail_();
            resetLastEffectItemTabindex_()
        };
    var initMarchDetail_ = function () {
            march_detail_.show = eval(["({", "modal_attack_raidfilter: {", cm.MARCH_TYPES.MARCH_TYPE_ATTACK, ": true},", "modal_attack_supplyfilter: {", cm.MARCH_TYPES.MARCH_TYPE_TRANSPORT, ": true},", "modal_attack_transport: {", cm.MARCH_TYPES.MARCH_TYPE_TRANSPORT, ": true, ", cm.MARCH_TYPES.MARCH_TYPE_REINFORCE, ": true, ", cm.MARCH_TYPES.MARCH_TYPE_REASSIGN, ": true},", "modal_attack_attack_boost: {", cm.MARCH_TYPES.MARCH_TYPE_SCOUT, ": true, ", cm.MARCH_TYPES.MARCH_TYPE_ATTACK, ": true},", "modal_attack_defense_boost: {", cm.MARCH_TYPES.MARCH_TYPE_SCOUT, ": true, ", cm.MARCH_TYPES.MARCH_TYPE_ATTACK, ": true}", "})"].join(""));
            march_detail_[cm.MARCH_TYPES.MARCH_TYPE_TRANSPORT] = {
                tooltip: g_js_strings.modal_attack.marchtexttransport
            };
            march_detail_[cm.MARCH_TYPES.MARCH_TYPE_REINFORCE] = {
                tooltip: g_js_strings.modal_attack.marchtextreinforce
            };
            march_detail_[cm.MARCH_TYPES.MARCH_TYPE_SCOUT] = {
                tooltip: g_js_strings.modal_attack.marchtextscout
            };
            march_detail_[cm.MARCH_TYPES.MARCH_TYPE_ATTACK] = {
                tooltip: g_js_strings.modal_attack.marchtextattack
            };
            march_detail_[cm.MARCH_TYPES.MARCH_TYPE_REASSIGN] = {
                tooltip: g_js_strings.modal_attack.marchtextreassign
            }
        };
    var itemOwnString_ = function (you_own) {
            var you_own = parseInt(you_own);
            if (isNaN(you_own)) {
                you_own = 0
            } else {
                if (you_own > 9999) {
                    you_own = "9999+"
                }
            }
            return you_own
        };
    var marchTimeCalculator_ = function (troops, from_x, from_y, is_round_trip, items_applied) {
            if (!from_x.toString().match(/^\d+$/) || !from_y.toString().match(/^\d+$/)) {
                return ""
            }
            var speed = 99999;
            var total_troops = 0;
            items_applied = items_applied || {};
            for (var troop_type in troops) {
                if (!troops[troop_type].toString().match(/^\d+$/)) {
                    continue
                }
                var troop_number = parseInt(troops[troop_type]);
                if (troop_number <= 0) {
                    continue
                }
                total_troops += troop_number;
                var troop_speed = parseInt(unitstats["unt" + troop_type][3]) * (1 + 0.1 * parseInt(seed.tech.tch11));
                if (troop_type > 6) {
                    troop_speed = troop_speed * (1 + 0.05 * parseInt(seed.tech.tch12))
                }
                if (troop_speed < speed) {
                    speed = troop_speed
                }
            }
            var barbarian_raid = $("#modal_attack_raidfilter_checkbox").attr("checked");
            var attack_selected = $("#modal_attack_tab_4").hasClass("selected");
            var throne67 = cm.ThroneController.effectBonus(67);
            var throne68, throne69, throne70, throne71, throne72;
            throne68 = throne69 = throne70 = throne71 = throne72 = 0;
            if (attack_selected) {
                throne68 = cm.ThroneController.effectBonus(68)
            } else {
                if ($("#modal_attack_tab_3").hasClass("selected")) {
                    throne72 = cm.ThroneController.effectBonus(72)
                } else {
                    if ($("#modal_attack_tab_2").hasClass("selected")) {
                        throne69 = cm.ThroneController.effectBonus(69)
                    } else {
                        if ($("#modal_attack_tab_5").hasClass("selected")) {
                            throne71 = cm.ThroneController.effectBonus(71)
                        } else {
                            if ($("#modal_attack_tab_1").hasClass("selected")) {
                                throne70 = cm.ThroneController.effectBonus(70)
                            }
                        }
                    }
                }
            }
            var throneBoost = throne67 + throne68 + throne69 + throne70 + throne71 + throne72;
            if (!barbarian_raid) {
                speed = speed * (1 + (throneBoost * 0.01))
            }
            var gi = cm.guardianModalModel.getMarchBonus();
            var multiplier = 1 + (gi * 0.01);
            if (!barbarian_raid && cm.WorldSettings.isOn("GUARDIAN_MARCH_EFFECT")) {
                speed = speed * multiplier
            }
            var time = 0;
            if (0 == speed || 0 == total_troops) {
                return ""
            }
            var x = Math.abs(parseInt(currentcityinfo[2]) - parseInt(from_x));
            if (x > 375) {
                x = 750 - x
            }
            var y = Math.abs(parseInt(currentcityinfo[3]) - parseInt(from_y));
            if (y > 375) {
                y = 750 - y
            }
            time = Math.ceil(Math.sqrt((x * x) + (y * y)) * 6000 / speed);
            if (items_applied["57"] && seed.items.i57 > 0) {
                time = parseInt(time * 0.5)
            } else {
                if (items_applied["55"] && seed.items.i55 > 0) {
                    time = parseInt(time * 0.75)
                }
            }
            time += 30;
            if (seed.playerEffects.returnExpire > unixtime()) {
                time = parseInt(time * 0.75)
            }
            if (is_round_trip) {
                time *= 2
            }
            var minimum_time = 173;
            if (time < minimum_time && barbarian_raid && attack_selected) {
                time = minimum_time
            }
            return timestr(time)
        };
    var saveRaid_ = function (march_parameters, data_type, callback) {
            var xcoord = ("cityMarches" == data_type) ? march_parameters.toXCoord : march_parameters.xcoord;
            var ycoord = ("cityMarches" == data_type) ? march_parameters.toYCoord : march_parameters.ycoord;
            var cityId = null;
            var knightId = null;
            if ("cityMarches" == data_type) {
                cityId = march_parameters.fromCityId;
                knightId = march_parameters.knightId
            } else {
                cityId = march_parameters.cid;
                knightId = march_parameters.kid
            }
            var knight = seed.knights["city" + cityId]["knt" + knightId];
            var knight_status_old = knight.knightStatus;
            knight.knightStatus = 10;
            var revert_knight_status = function () {
                    knight.knightStatus = knight_status_old
                };
            g_mapObject.getTileData(["bl_" + xcoord + "_bt_" + ycoord], function (rslt) {
                var tile_id = "l_" + xcoord + "_t_" + ycoord;
                if (!rslt.data[tile_id] || (rslt.data[tile_id].tileType != cm.TILE_TYPES.TILE_TYPE_CITY) || rslt.data[tile_id].tileUserId) {
                    revert_knight_status();
                    Modal.showAlert(g_js_strings.modal_attack_do.selectbarbariancamps);
                    return
                }
                var parameters = Object.clone(g_ajaxparams);
                parameters.ctrl = "BotManager";
                parameters.action = march_parameters.is_edit ? "editMarch" : "saveMarch";
                parameters.settings = {
                    cityId: cityId
                };
                delete march_parameters.is_edit;
                var raid = null;
                if ("cityMarches" == data_type) {
                    raid = march_parameters
                } else {
                    raid = {
                        knightId: march_parameters.kid,
                        toXCoord: march_parameters.xcoord,
                        toYCoord: march_parameters.ycoord
                    };
                    for (var troop_type in cm.UNIT_TYPES) {
                        var troop_key = "u" + cm.UNIT_TYPES[troop_type];
                        var troop_number = parseInt(march_parameters[troop_key]);
                        if (!isNaN(troop_number)) {
                            raid["unit" + cm.UNIT_TYPES[troop_type] + "Count"] = troop_number
                        } else {
                            raid["unit" + cm.UNIT_TYPES[troop_type] + "Count"] = 0
                        }
                    }
                }
                parameters.queue = [{
                    botMarches: {
                        botMarchStatus: 1,
                        botState: 1
                    },
                    cityMarches: raid
                }];
                ajax.Request(g_ajaxpath + "ajax/_dispatch.php" + g_ajaxsuffix, {
                    method: "post",
                    parameters: parameters,
                    loading: true,
                    onSuccess: function (transport) {
                        var rslt = eval("(" + transport.responseText + ")");
                        if (rslt.ok) {
                            setTimeout(update_seed_ajax, 1000);
                            if (callback) {
                                callback()
                            } else {
                                if (callbacks_.saveRaid) {
                                    Modal.hideModal();
                                    callbacks_.saveRaid()
                                } else {
                                    Modal.hideModalAll()
                                }
                            }
                        } else {
                            revert_knight_status();
                            Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                        }
                    },
                    onFailure: revert_knight_status
                })
            }, revert_knight_status)
        };
    var onAutoAttackHelpClick_ = function () {
            Modal.showAlert([g_js_strings.modal_attack.barbarianraidhelpp1, g_js_strings.modal_attack.barbarianraidhelpp2, g_js_strings.modal_attack.barbarianraidhelpp3].join("<br /><br />"))
        };
    var onBoostItemClick_ = function (event, extra) {
            do {
                if (undefined != extra && extra.is_force) {
                    break
                }
                if ((march_type_ == cm.MARCH_TYPES.MARCH_TYPE_ATTACK) && $("#modal_attack_raidfilter_checkbox").attr("checked")) {
                    event.preventDefault();
                    return
                }
            } while (false);
            var item_id = this.id.split("_item")[1];
            if (item_id in {
                "55": "",
                "57": ""
            }) {
                modal_attack_item_march(item_id)
            }
            if (item_id in {
                "931": "",
                "932": ""
            }) {
                modal_attack_update_unt_max(item_id - 930)
            }
            if (undefined != extra && extra.is_force) {
                event.preventDefault()
            }
        };
    var onBuyButtonFadedIn_ = function () {
            is_allow_buy_ = true
        };
    var onBuyItemButtonClick_ = function (event) {
            if (!is_allow_buy_) {
                return
            }
            if ($("#modal_attack_raidfilter_checkbox").attr("checked")) {
                return
            }
            var re = /_(\d+)$/;
            var result = re.exec(this.id);
            if (!result) {
                return
            }
            var item_id = result[1];
            if (itemlist["i" + item_id].price > seed.player.gems) {
                modal_shop_buy_notenough();
                return
            }
            var params = Object.clone(g_ajaxparams);
            params.iid = item_id;
            params.original_quantity = ksoItems[item_id].count;
            $("#modal_attack_itemprice_" + item_id).css("visibility", "hidden");
            var profiler = new cm.Profiler("ResponseTime", "buyItem.php");
            new Ajax.Request(g_ajaxpath + "ajax/buyItem.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (message) {
                    profiler.stop();
                    onItemBought_(message)
                },
                onFailure: function () {
                    profiler.stop()
                }
            })
        };
    var onItemBought_ = function (message) {
            var item_id = message.request.parameters.iid;
            var item = itemlist["i" + item_id];
            $("#modal_attack_itemprice_" + item_id).css("visibility", "visible");
            var rslt = eval("(" + message.responseText + ")");
            if (!rslt.ok) {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)));
                return
            }
            seed.player.gems = seed.player.gems - item.price;
            var owned_element = $("#modal_attack_itemstock_" + item_id).first();
            if (owned_element.length < 1) {
                return
            }
            var quantity = parseInt(message.request.parameters.original_quantity);
            if (isNaN(quantity)) {
                quantity = 0
            }++quantity;
            var stock = ksoItems[item_id].count;
            if (!isNaN(stock) && (stock > quantity)) {
                quantity = stock
            } else {
                seed.items["i" + item_id] = quantity;
                ksoItems[item_id].add(quantity - stock)
            }
            owned_element.html(itemOwnString_(quantity));
            if (quantity > 0) {
                $("#modal_attack_item" + item_id).removeAttr("disabled");
                $("#modal_attack_itemstock_" + item_id).parent().removeClass("zero")
            }
            $("#kochead_gems").html(seed.player.gems);
            cm.MixPanelTracker.track("store_purchase", {
                item: item.name,
                cost: item.price,
                usr_gen: seed.player.g,
                usr_byr: seed.player.y,
                usr_ttl: titlenames[seed.player.title],
                distinct_id: tvuid
            })
        };
    var onMarchTypeChange_ = function (march_type, modal_start_type) {
            if (march_type < 1) {
                return
            }
            if (undefined != modal_start_type) {
                modal_start_type_ = modal_start_type
            }
            march_type_ = march_type;
            var march_detail = march_detail_[march_type];
            for (var i in march_detail_.show) {
                $("#" + i).css("display", march_detail_.show[i][march_type] ? "" : "none")
            }
            if (march_detail_.show.modal_attack_supplyfilter[march_type]) {
                $("#modal_attack_supplyfilter_checkbox").attr("checked", true)
            } else {
                $("#modal_attack_supplyfilter_checkbox").removeAttr("checked")
            }
            if (!march_detail_.show.modal_attack_transport[march_type]) {
                $("#modal_attack_transport input").val(0)
            }
            $("#modal_attack .marchTypeTabs li").removeClass("selected");
            $("#modal_attack_tab_" + march_type_).addClass("selected");
            var select_element = $("#modal_attack_knight option");
            if (cm.MARCH_TYPES.MARCH_TYPE_ATTACK == march_type && select_element.length > 1) {
                $("#modal_attack_knight").val($(select_element[1]).val())
            } else {
                $("#modal_attack_knight").val(0)
            }
            filterTroops_(march_type);
            filterBoosts_();
            updateTroopResource_();
            modal_attack_update_time()
        };
    var onModelClosed_ = function () {
            isModelOpened_ = false;
            setBackedOff_(false)
        };
    var onRaidfilterClick_ = function () {
            var rallyLevel = getBuildingLevel(12),
                troopAmountBonus = 1;
            if (rallyLevel === 11) {
                troopAmount = (Math.round(150000 * troopAmountBonus))
            } else {
                if (rallyLevel === 12) {
                    troopAmount = (Math.round(200000 * troopAmountBonus))
                } else {
                    troopAmount = (Math.round((rallyLevel * 10000) * troopAmountBonus))
                }
            }
            $("#modal_attack_maxunt").html(Math.round(troopAmount));
            filterBoosts_();
            updateTroopResource_();
            modal_attack_update_time()
        };
    var onTabClick_ = function (event) {
            if (event.data.march_type == march_type_) {
                return
            }
            $("#modal_attack_atktype").val(event.data.march_type);
            onMarchTypeChange_(event.data.march_type)
        };
    var onTooltipTatgetMouseout_ = function (event) {
            removeTooltip();
            event.stopPropagation()
        };
    var onTooltipTatgetMouseover_ = function (event) {
            showTooltip(event.data.tooltip, event.target, event.originalEvent, "mainbody");
            event.stopPropagation()
        };
    var rendererBoostSection_ = function (html, container_id, title, items, callback, block_buy_items) {
            var post_html = "";
            if (callback) {
                post_html = callback()
            }
            var model = {
                BOOST_SECTION: {
                    buy: g_js_strings.commonstr.buy,
                    title: g_js_strings.modal_attack.availableresources,
                    site_image_url: stimgUrl,
                    you_own: g_js_strings.commonstr.youown
                },
                container_id: container_id,
                title: title,
                items: [],
                post_html: post_html
            };
            for (var i = 0; i < items.length; i++) {
                model.items.push({
                    additional_class: {
                        own: "",
                        buy: (block_buy_items && block_buy_items["i" + items[i]]) ? "not_allowed" : ""
                    },
                    disabled: "",
                    id: items[i],
                    item_detail: itemlist["i" + items[i]],
                    quantity: itemOwnString_(ksoItems[items[i]].count),
                    tabindex: last_effect_item_tabindex_++
                });
                if (model.items[i].quantity < 1) {
                    model.items[i].additional_class.own = "zero";
                    model.items[i].disabled = "disabled"
                }
            }
            html.push(jsonT(model, templates_.boost_section));
            if (callback) {
                callback(html)
            }
        };
    var rendererEstimateTime_ = function () {
            return ["<div class='estimated'><div>", g_js_strings.modal_attack.estimatedmarchtime, ":", "<span id='modal_attack_esttime'></span>", "</div></div>"].join("")
        };
    var rendererResourceSection_ = function (html) {
            var site_image_url = stimgUrl,
                max = g_js_strings.commonstr.max,
                r5Title = g_js_strings.modal_attack.availableAetherstones,
                r5Label = g_js_strings.commonstr.aetherstone,
                r5Amount = seed.resources["city" + currentcityid].rec5[0],
                r5Hint = g_js_strings.modal_attack.aetherstoneHint;
            var template = "";
            if (cm.WorldSettings.isOn("DARK_FOREST_AETHERSTONE_PVP")) {
                template = '<div class="r5 section_title">' + r5Title + "</div>";
                template += '<div class="r5 resource_detail">';
                template += '<img class="icon property" src="' + site_image_url + 'img/aetherstone_30.png" />';
                template += '<span class="name property"> ' + r5Label + "</span>";
                template += '<input class="to_apply property" id="modal_attack_rec5" type="text" tabIndex="161" value="0" name="5" onKeyUp="modal_attack_rec_vacancy(5);" />';
                template += '<span class="amount" id="modal_attack_rec_max_rec5"> ' + r5Amount + "</span>";
                template += '<a class="button14 max" onclick="modal_attack_update_rec_max(5);"><span>' + max + "</span></a>";
                template += "<p>" + r5Hint + "</p>";
                template += "</div>"
            }
            var model = {
                RESOURCE_SECTION: {
                    title: g_js_strings.modal_attack.availableresources,
                    site_image_url: stimgUrl,
                    max: g_js_strings.commonstr.max,
                    r5Title: g_js_strings.modal_attack.availableAetherstones,
                    r5Label: g_js_strings.commonstr.aetherstone,
                    r5Amount: seed.resources["city" + currentcityid].rec5[0],
                    r5Hint: g_js_strings.modal_attack.aetherstoneHint,
                    r5Template: template
                },
                resources: [{
                    type_id: 0,
                    type_name: "gold",
                    icon: "gold",
                    display: resourceinfo.rec0,
                    quantity: seed.citystats["city" + currentcityid].gold[0],
                    tabindex: 160
                }, {
                    type_id: 1,
                    type_name: "rec1",
                    icon: "food",
                    display: resourceinfo.rec1,
                    quantity: parseInt(parseInt(seed.resources["city" + currentcityid].rec1[0] / 3600)),
                    tabindex: 161
                }, {
                    type_id: 2,
                    type_name: "rec2",
                    icon: "wood",
                    display: resourceinfo.rec2,
                    quantity: parseInt(parseInt(seed.resources["city" + currentcityid].rec2[0] / 3600)),
                    tabindex: 162
                }, {
                    type_id: 3,
                    type_name: "rec3",
                    icon: "stone",
                    display: resourceinfo.rec3,
                    quantity: parseInt(parseInt(seed.resources["city" + currentcityid].rec3[0] / 3600)),
                    tabindex: 163
                }, {
                    type_id: 4,
                    type_name: "rec4",
                    icon: "iron",
                    display: resourceinfo.rec4,
                    quantity: parseInt(parseInt(seed.resources["city" + currentcityid].rec4[0] / 3600)),
                    tabindex: 164
                }]
            };
            html.push(jsonT(model, templates_.resource_section))
        };
    var resetLastEffectItemTabindex_ = function () {
            last_effect_item_tabindex_ = 170
        };
    var setBackedOff_ = function (value) {
            isMarchAllowed_ = value ? false : true;
            var loadingSymbol = $(".spinnyLoading2");
            if (value) {
                if (loadingSymbol.length == 0) {
                    $("body").append("<div class='spinnyLoading2'></div>")
                }
            } else {
                loadingSymbol.remove()
            }
        };
    var sortKnights_ = function (knight_a, knight_b) {
            var knights = seed.knights["city" + currentcityid];
            return parseInt(knights[knight_b].combat) - parseInt(knights[knight_a].combat)
        };
    var updateTroopResource_ = function () {
            var units = $("#modal_attack_unitlist input");
            var total_units = 0;
            var load = 0;
            var techLoadBoost = parseInt(seed.tech.tch10) * 0.1;
            var loadEffectBoost = 0;
            if (seed.playerEffects.loadExpire > unixtime()) {
                loadEffectBoost = 0.25
            }
            var loadBoostBase = (cm.ThroneController.effectBonus(6) * 0.01) + loadEffectBoost + techLoadBoost;
            for (var i = 0; i < units.length; i++) {
                var unit_number = parseInt(units[i].value);
                if (!isNaN(unit_number) && (unit_number > 0)) {
                    total_units += unit_number;
                    var untid = parseInt(units[i].name);
                    var loadBoost = loadBoostBase;
                    if (cm.unitFrontendType[untid] == "siege") {
                        loadBoost += (cm.ThroneController.effectBonus(59) * 0.01)
                    } else {
                        if (cm.unitFrontendType[untid] == "horsed") {
                            loadBoost += (cm.ThroneController.effectBonus(48) * 0.01)
                        }
                    }
                    load += unit_number * parseInt(unitstats["unt" + untid][5]) * (1 + loadBoost)
                }
            }
            var resources = $("#modal_attack_transport input");
            var total_resources = 0;
            for (var i = 0; i < resources.length; i++) {
                if (parseInt(resources[i].value) > 0) {
                    if (i == 5) {
                        total_resources += (parseInt(resources[i].value) * 5)
                    } else {
                        total_resources += (parseInt(resources[i].value))
                    }
                }
            }
            $("#modal_attack_selnum").html(total_units);
            $("#modal_attack_vacancy").attr("name", load).html(load - total_resources);
            $("#modal_attack_selres").html(total_resources);
            $("#modal_attack_maxres").html(load)
        };
    var templates_ = {
        resource_section: {
            self: "{resources}",
            resources: ' <div class="section" id="modal_attack_transport" style="display: none;">   <div class="section_title">{RESOURCE_SECTION.title}</div>   <div class="section_content">   {$}   </div>   {RESOURCE_SECTION.r5Template} </div>',
            "resources[*]": '<div class="resource_detail clearfix">   <img class="icon property" src="{RESOURCE_SECTION.site_image_url}img/{$.icon}_30.png" />   <div class="name property">{$.display}</div>   <input class="to_apply property" onkeyup="modal_attack_rec_vacancy({$.type_id});return false;" id="modal_attack_{$.type_name}" name="{$.type_id}" type="text" value="0" tabindex="{$.tabindex}" />   <div class="have property">/ <span id="modal_attack_rec_max_{$.type_name}">{$.quantity}</span></div>   <div class="action property">     <a class="button14 max" onclick="modal_attack_update_rec_max({$.type_id});return false;">       <span>{RESOURCE_SECTION.max}</span>     </a>   </div> </div>'
        },
        boost_section: {
            self: "{items}",
            items: ' <div class="section boost" id="{container_id}">   <div class="section_title">{title}</div>   <div class="section_content">   {$}   {post_html}   </div> </div>',
            "items[*]": '<div class="item clearfix">   <input type="checkbox" name="{$.id}" id="modal_attack_item{$.id}" tabindex="{$.tabindex}" {$.disabled} />   <div class="icon_own">     <img class="icon" src="{BOOST_SECTION.site_image_url}img/items/30/{$.id}.jpg" />     <div class="own {$.additional_class.own}"><span id="modal_attack_itemstock_{$.id}">{$.quantity}</span></div>   </div>   <div class="info">     <div>{$.item_detail.name}</div>     <div class="desc">{$.item_detail.description}</div>   </div>   <div class="buy {$.additional_class.buy}">     <div class="gem">{$.item_detail.price} <img src="{BOOST_SECTION.site_image_url}img/gem.png" /></div>     <div><a class="inlineButton blue14 modal_attack_buy_item" id="modal_attack_itemprice_{$.id}"><span>{BOOST_SECTION.buy}</span></a></div>   </div> </div>'
        }
    };
    init_();
    return {
        bind: bind_,
        changeMarchType: onMarchTypeChange_,
        getInstanceId: function () {
            return instanceId_
        },
        isMarchAllowed: function () {
            return isMarchAllowed_
        },
        isModelOpened: function () {
            return isModelOpened_
        },
        marchTimeCalculator: marchTimeCalculator_,
        onAutoAttackHelpClick: onAutoAttackHelpClick_,
        onModelClosed: onModelClosed_,
        saveRaid: saveRaid_,
        rendererBoostSection: rendererBoostSection_,
        rendererEstimateTime: rendererEstimateTime_,
        rendererResourceSection: rendererResourceSection_,
        sortKnights: sortKnights_,
        setBackedOff: setBackedOff_,
        updateTroopResource: updateTroopResource_
    }
}(jQuery);

function processUserAction(a, d, c) {
    if (a.user_action) {
        var b = {
            title: '<span class="march_useraction_title"></span>',
            marchWarning: function () {
                var e = ['<div class="march_useraction_warning"><div class="title">', g_js_strings.modal_attack.useractionwarningtitle, "</div>", "<div>", g_js_strings.modal_attack.useractionwarningmessage, "</div></div>"].join("");
                var f = {
                    okay: {
                        txt: g_js_strings.modal_attack.useractionwarningiunderstand,
                        cls: "inlineButton blue25",
                        exe: function () {
                            Modal.hideModal();
                            c.marchWarning = 1;
                            d()
                        }
                    }
                };
                Modal.multiButton({
                    title: b.title,
                    noControl: true,
                    body: e,
                    buttonContainerClass: "",
                    buttons: f,
                    buttonContainerClass: "march_useraction_buttons clearfix"
                })
            },
            marchCaptcha: function () {
                var f = "march_captcha_" + Math.floor(Math.random() * 10000000);
                var e = ["<div class='march_useraction_warning'><div>", g_js_strings.modal_attack.useractioncaptchap1, "</div>", '<div class="captcha_container"><form id="', f, '"></form></div>', "<div>", g_js_strings.modal_attack.useractioncaptchap2, "</div></div>"].join("");
                var h = function (i) {
                        i.preventDefault();
                        i.stopPropagation();
                        c.marchWarning = 1;
                        c.marchCaptcha_challenge = Recaptcha.get_challenge();
                        c.marchCaptcha_response = Recaptcha.get_response();
                        Modal.hideModal();
                        d();
                        return false
                    };
                var g = {
                    okay: {
                        txt: g_js_strings.commonstr.ok,
                        cls: "inlineButton blue25",
                        exe: h
                    }
                };
                Modal.onCloseCallback = function () {
                    Recaptcha.destroy()
                };
                Modal.multiButton({
                    title: b.title,
                    noControl: true,
                    body: e,
                    buttons: g,
                    buttonContainerClass: "march_useraction_buttons clearfix"
                });
                Recaptcha.create("6LcT7cQSAAAAAG4whvbBz60hGjJg0ON1wRIRv_iD", f, {
                    callback: Recaptcha.focus_response_field,
                    theme: "white"
                });
                jQuery("#" + f).submit(h)
            },
            backOffWaitTime: function () {
                cm.MarchModal.setBackedOff(true);
                c.tt = a.tt;
                setTimeout(d, a.wait_time * 1000)
            }
        };
        b[a.user_action].call();
        return true
    }
    return false
};
var KB = KB || {};
KB.AudioManager = (function () {
    var b = this,
        d = {
            enabled: false,
            defaultPlaybackOption: {
                volume: 25,
                loop: true,
                duration: 3
            },
            playbackOptions: {},
            defaultCacheSize: 2,
            dynamicCache: null,
            lookup: {},
            cookieName: "musicDisabled"
        },
        c = {
            enabled: true,
            defaultPlaybackOption: {
                loop: false
            },
            playbackOptions: {},
            defaultCacheSize: 10,
            staticCache: {},
            dynamicCache: null,
            mapping: {},
            lookup: {},
            cookieName: "soundDisabled"
        },
        g = false,
        e = false,
        f = function (h) {
            if (c.staticCache[h]) {
                return c.staticCache[h]
            } else {
                if (c.dynamicCache.getElement(h)) {
                    return c.dynamicCache.getElement(h)
                } else {
                    return null
                }
            }
        },
        a = function (i) {
            var h = new Date();
            h.setTime(h.getTime() + (10 * 365 * 24 * 60 * 60 * 1000));
            KB.ClientSideCookieManager.setCookie(i, "true", h)
        };
    this.AM_initAudioManager = function (k) {
        var p, n, o = k.music,
            h, j = k.sound,
            m, l;
        k = k || {};
        g = k.ignoreSounds ? true : false;
        e = KB.Browser.IE && KB.Browser.Version <= 8;
        if (o) {
            h = o.cacheSize && !isNaN(parseInt(o.cacheSize, 10)) ? parseInt(o.cacheSize, 10) : d.defaultCacheSize;
            d.dynamicCache = new KB.HashedQueue(h);
            d.playbackOptions = o && o.playbackOptions ? o.playbackOptions : d.defaultPlaybackOption;
            if (o.cookieName) {
                d.cookieName = o.cookieName
            }
            n = KB.ClientSideCookieManager.getCookie(d.cookieName);
            d.enabled = (n !== "true");
            if (o && o.regular && o.regular instanceof Array && o.regular.length > 0) {
                for (l = 0; l <= o.regular.length; l += 1) {
                    p = o.regular[l];
                    d.lookup[p] = true
                }
            }
        }
        if (k.sound) {
            m = j.cacheSize && !isNaN(parseInt(j.cacheSize, 10)) ? parseInt(j.cacheSize, 10) : c.defaultCacheSize;
            c.dynamicCache = new KB.HashedQueue(m);
            c.staticCache = {};
            c.playbackOptions = j && j.playbackOptions ? j.playbackOptions : c.defaultPlaybackOption;
            if (j && j.cached && j.cached instanceof Array) {
                for (l = 0; l <= j.cached.length; l += 1) {
                    p = j.cached[l];
                    c.staticCache[p] = KB.SoundFactory.getSound(p, c.playbackOptions);
                    c.lookup[p] = true
                }
            }
            if (j && j.regular && j.regular instanceof Array) {
                for (l = 0; l <= j.regular.length; l += 1) {
                    if (e) {
                        p = j.regular[l];
                        c.staticCache[p] = KB.SoundFactory.getSound(p, c.playbackOptions)
                    }
                    c.lookup[p] = true
                }
            }
            if (j.mapping) {
                c.mapping = j.mapping
            }
            if (j.cookieName) {
                c.cookieName = j.cookieName
            }
            n = KB.ClientSideCookieManager.getCookie(c.cookieName);
            c.enabled = (n !== "true")
        }
    };
    this.AM_suppressNextSound = function (h) {
        c.suppressedSounds = h
    };
    this.AM_playSound = function (n) {
        var j = c.suppressedSounds,
            h, m, k;
        if (g) {
            return false
        }
        if (j) {
            c.suppressedSounds = null;
            for (k = 0; k < j.length; k += 1) {
                h = j[k];
                if (n === h) {
                    return
                }
            }
        }
        try {
            if (!c.enabled) {
                return
            }
            m = f(n);
            if (!m) {
                m = KB.SoundFactory.getSound(n, c.playbackOptions);
                c.dynamicCache.enQueue(n, m)
            } else {
                c.dynamicCache.moveToLast(n)
            }
            if (m) {
                m.play()
            }
        } catch (l) {}
    };
    this.AM_playMappedSound = function (i, h) {
        var j = c.mapping[i] && c.mapping[i][h] ? c.mapping[i][h] : null;
        if (j) {
            this.AM_playSound(j)
        }
    };
    this.AM_changeMusic = function (j, h) {
        if (d.current !== j && d.lookup[j]) {
            this.AM_stopMusic();
            var l = d.dynamicCache.getElement(j),
                i;
            if (!l) {
                l = new KB.SoundFactory.getSound(j, d.playbackOptions);
                i = d.dynamicCache.enQueue(j, l);
                if (i && typeof (i.purge) === "function") {
                    i.purge()
                }
            } else {
                d.dynamicCache.moveToLast(j)
            }
            d.current = j;
            try {
                if (d.enabled) {
                    h = h || 0;
                    if (e) {
                        h = Math.max(h, 500)
                    }
                    setTimeout(function () {
                        AM_playMusic()
                    }, h)
                }
            } catch (k) {}
            return true
        } else {
            return false
        }
    };
    this.AM_getCurrentMusicName = function () {
        return d.current
    };
    this.AM_playMusic = function () {
        if (g) {
            return false
        }
        var h = d.dynamicCache ? d.dynamicCache.getLastElement() : null;
        if (h && typeof (h.fadeIn) === "function") {
            h.fadeIn();
            return true
        }
        return false
    };
    this.AM_stopMusic = function () {
        var h = d.dynamicCache ? d.dynamicCache.getLastElement() : null;
        if (h && typeof (h.fadeOut) === "function") {
            h.fadeOut()
        }
    };
    this.AM_enableMusic = function (h) {
        d.enabled = h;
        if (d.enabled) {
            this.AM_playMusic();
            KB.ClientSideCookieManager.deleteCookie(d.cookieName)
        } else {
            a(d.cookieName);
            this.AM_stopMusic()
        }
    };
    this.AM_toggleMusic = function () {
        this.AM_enableMusic(!d.enabled)
    };
    this.AM_isMusicOn = function () {
        return d.enabled
    };
    this.AM_enableSound = function (h) {
        c.enabled = h;
        if (c.enabled) {
            KB.ClientSideCookieManager.deleteCookie(c.cookieName)
        } else {
            a(c.cookieName)
        }
    };
    this.AM_toggleSound = function () {
        this.AM_enableSound(!c.enabled)
    };
    this.AM_isSoundOn = function () {
        return c.enabled
    };
    this.AM_getInternalSoundObject = function () {
        return c
    };
    this.AM_getInternalMusicObject = function () {
        return c
    }
}());
var cm = function (a) {
        a.util = a.util || {};
        var c = a.util;

        function d() {
            var g = -1;
            if (navigator.appName == "Microsoft Internet Explorer") {
                var e = navigator.userAgent;
                var f = new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");
                if (f.exec(e) != null) {
                    g = parseFloat(RegExp.$1)
                }
            }
            return g
        }
        var b = {};
        c.preventDoubleClick = function (f, e) {
            e = e || 10;
            if (unixtime() <= (e + b[f])) {
                return true
            } else {
                b[f] = unixtime();
                return false
            }
        };
        c.clearDouble = function (e) {
            b[e] = 0
        };
        c.rand = function (f, e) {
            return Math.round(Math.random() * (e - f)) + f
        };
        c.isChrome = function () {
            return Boolean(window.chrome)
        };
        c.isIE = function () {
            return ((document.all) && (navigator.appVersion.indexOf("MSIE") != -1))
        };
        c.ie9 = function () {
            var e = navigator.userAgent;
            return c.isIE() && e.indexOf("Trident/5") != -1
        };
        c.ieVersion = function () {
            return d()
        };
        c.clientTime = function () {
            return parseInt((new Date()).getTime() / 1000)
        };
        c.live = function () {
            return window.location.href.indexOf("webby") == -1
        };
        return a
    }(cm || {});
cm.OOP = new function () {
    this.inherits = function (a, b) {
        if (typeof (a) != "function" || typeof (b) != "function") {
            return
        }
        a.prototype = new b();
        a.prototype.constructor = b
    }
}();
cm.BootLoaderCallback = function (e, d, a) {
    var b;
    this.launch = function (f) {
        if (!d) {
            d = [f]
        }
        e.apply(window, d)
    };
    this.getPriority = function () {
        return b
    };
    var c = function () {
            b = a ? a : 0
        };
    c()
};
cm.BootLoader = new function () {
    var a = [];
    var b = function (d, c) {
            return c.getPriority() - d.getPriority()
        };
    this.add = function (e, d, c) {
        if (typeof (e) == "function") {
            a.push(new cm.BootLoaderCallback(e, d, c))
        } else {
            if (e instanceof cm.BootLoaderCallback) {
                a.push(e)
            }
        }
    };
    this.dispatchCallbacks = function (c) {
        a.sort(b);
        while (a.length > 0) {
            var d = a.shift();
            d.launch(c)
        }
        jQuery(window).unbind("load", cm.BootLoader.dispatchCallbacks)
    }
}();
jQuery(window).bind("load", cm.BootLoader.dispatchCallbacks);
cm.TimeFormatter = {
    format: function (d) {
        var b = [];
        var a, c, f, e;
        e = [];
        a = Math.floor(d / 3600);
        e.push(Math.max(Math.floor(a / 10), 0));
        e.push(Math.max(a % 10, 0));
        b.push(e.join(""));
        d %= 3600;
        e = [];
        c = Math.floor(d / 60);
        e.push(Math.max(Math.floor(c / 10), 0));
        e.push(Math.max(c % 10, 0));
        b.push(e.join(""));
        d %= 60;
        e = [];
        f = d;
        e.push(Math.max(Math.floor(f / 10), 0));
        e.push(Math.max(f % 10, 0));
        b.push(e.join(""));
        return b.join(":")
    }
};
cm.StringFormatter = {
    ellipsis: function (b, a) {
        if (b.length > a) {
            return b.substr(0, a) + "..."
        } else {
            return b
        }
    },
    applyTemplate: function (a, c) {
        var b = {
            self: a
        };
        return jsonT(c, b)
    },
    htmlInlineSafeStringEncode: function (c) {
        var b = [];
        for (var a = c.length - 1; a >= 0; --a) {
            b.push(c.charCodeAt(a))
        }
        return b.join(".")
    },
    htmlInlineSafeStringDecode: function (c) {
        if (!c) {
            return false
        }
        var c = c.split(".");
        var b = [];
        for (var a = c.length - 1; a >= 0; --a) {
            b.push(String.fromCharCode(c[a]))
        }
        return b.join("")
    }
};
cm.WorldSettings = new function () {
    var a;
    this.hasKeyValuePair = function (b, c) {
        var d = a[b];
        return c === d
    };
    this.hasSetting = function (b) {
        return a[b] !== undefined
    };
    this.getSetting = function (b) {
        return a[b]
    };
    this.getSettingAsNumber = function (c, b) {
        var d = parseInt(a[c]);
        d = isNaN(d) ? b : d;
        return d
    };
    this.init = function (b) {
        a = b
    };
    this.isOn = function (b) {
        if (!a) {
            return false
        }
        var c = a[b.toUpperCase()];
        var d = c ? c.toLowerCase() : false;
        return d == "on" || d == "true" || d == "yes"
    };
    this.set = function (b, c) {
        a[b] = c
    }
}();
cm.KeyFilter = new function () {
    var b = this;
    var c = function (d) {
            return (d >= 8 && d <= 9) || (d >= 35 && d <= 40) || d == 46
        };
    var a = function (d) {
            return (d >= 48 && d <= 57) || (d >= 96 && d <= 105)
        };
    this.allowOnlyNumbers = function (f) {
        var d = f.keyCode ? f.keyCode : f.which ? f.which : f.charCode;
        if (!a(d) && !c(d)) {
            f.cancelBubble = true;
            f.returnValue = false;
            if (f.stopPropagation) {
                f.stopPropagation();
                f.preventDefault()
            }
        }
    }
}();
cm.TroopFactory = new function () {
    this.getUnit = function (e) {
        var d = e.substring(1);
        var b = "img/units/unit_" + d + "_30_s34.jpg";
        var a = unitcost["unt" + d][0];
        var c = {};
        c.id = d;
        c.imageUrl = b;
        c.name = a;
        return c
    }
}();
cm.ResearchFactory = new function () {
    this.getResearch = function (c) {
        var a = c.substring(1);
        var d = techcost["tch" + a][0];
        var b = {};
        b.id = a;
        b.name = d;
        return b
    }
}();
cm.BuildingFinder = {
    getFirstInCurrentCity: function (i) {
        var c, f, h, g, j, k, d, m, b, a;
        var l = seed.buildings;
        var e = null;
        if (!(l instanceof Array) && typeof (l) == "object") {
            c = "city" + currentcityid;
            g = l[c];
            if (!(g instanceof Array) && typeof (g) == "object") {
                for (h in g) {
                    j = g[h];
                    k = parseInt(j[0]);
                    if (k === i) {
                        d = parseInt(j[1]);
                        m = j[2];
                        b = j[3];
                        f = c.substring(4);
                        e = {
                            buildingId: b,
                            cityId: f,
                            slot: m,
                            level: d
                        };
                        return e
                    }
                }
            }
        }
        return null
    }
};
cm.IframeUtil = new function () {
    var b = {};
    var a = function (g, d) {
            var f = g.srcElement ? g.srcElement : g.target;
            var h = f.id;
            var c = $(h);
            if (c) {
                c.stopObserving("load", a)
            }
            if (d) {
                document.body.removeChild(d);
                delete d
            }
        };
    this.post = function (m, d) {
        var f = document.createElement("form");
        var c = false;
        if ($(m)) {
            c = true;
            $(m).observe("load", function (i) {
                a(i, f)
            })
        }
        var e = d.split("?", 2);
        var o = e[0];
        var k = e.length > 1 ? e[1] : "";
        f.setAttribute("target", m);
        f.setAttribute("action", o);
        f.setAttribute("method", "post");
        var g = k.split("&");
        var n = g.length;
        var l, h, q, p, j;
        for (l = 0; l < n; l++) {
            h = g[l].split("=");
            q = h[0];
            p = h.length > 1 ? h[1] : "";
            j = document.createElement("input");
            j.setAttribute("type", "hidden");
            j.setAttribute("name", q);
            j.setAttribute("value", p);
            f.appendChild(j)
        }
        document.body.appendChild(f);
        f.submit();
        if (!c) {
            document.body.removeChild(f)
        }
    }
}();
cm.Url = function (a) {
    this.getParameterValue = function (h) {
        var b = a.split("?");
        var k = b[0];
        var f = b.length > 1 ? b[1] : "";
        var c = f.split("&");
        var j = c.length;
        var g, d, m, l, e;
        for (g = 0; g < j; g++) {
            d = c[g].split("=");
            m = d[0];
            l = d.length > 1 ? d[1] : "";
            if (m === h) {
                return l
            }
        }
        return ""
    }
};
cm.InGameDestination = function () {
    var d;
    var j = function () {
            cm.ShopView.openShop()
        };
    var e = function () {
            cm.InventoryView.openInventory()
        };
    var a = function () {
            g_modal = 3
        };
    var f = function () {
            modal_quests()
        };
    var g = function () {
            modal_alliance()
        };
    var c = function () {
            modal_messages()
        };
    var h = function () {
            cm.caravanController.onLoad()
        };
    var b = function () {
            cm.TownCrierFetcher.addEventListener("ready", h)
        };
    var i = {
        "1": j,
        "2": e,
        "3": a,
        "4": f,
        "5": g,
        "6": c,
        "7": b
    };
    this.isValid = function () {
        return i[d] !== undefined
    };
    this.proceed = function () {
        var k = i[d];
        if (typeof (k) == "function") {
            k()
        }
    };
    (function () {
        var k = new cm.Url(document.location.href);
        d = k.getParameterValue(cm.InGameDestination.key)
    })()
};
cm.InGameDestination.key = "m";
cm.timer = function (d) {
    var a = {};
    var c = null;

    function b() {
        d.each(a, function (e, f) {
            if (unixtime() % f.interval == 0) {
                f["function"]()
            }
        })
    }
    return {
        register: function (f, g, e) {
            if (!e) {
                e = 1
            }
            if (!c) {
                c = setInterval(b, 1000)
            }
            a[f] = {
                id: f,
                "function": g,
                interval: e
            }
        }
    }
}(jQuery);
cm.resourceConverter = function () {
    var c = ["K", "M", "B", "T", "Q"];
    var b = {};

    function a(g) {
        var d = g.toString().split(",");
        if (d.length > 1) {
            if (!b[g.toString()]) {
                var e = c[d.length - 2];
                var f = Math.round(d[0] + "." + d[1]);
                b[g.toString()] = f.toString() + e
            }
            return b[g.toString()]
        } else {
            return g
        }
    }
    return {
        convert: a
    }
}();
cm.LinkHelper = (function () {
    var b = function (c) {
            if (c.target) {
                window.open(c.href, c.target)
            } else {
                document.location = c.href
            }
        };
    var a = function (c, e) {
            try {
                c.preventDefault();
                c.stopImmediatePropagation();
                _gaq.push(["_trackEvent", "OutboundLinks", e, g_server, 0])
            } catch (d) {}
            setTimeout(function () {
                b(c.target)
            }, 100)
        };
    return {
        openLink: b,
        trackAndOpenLinkOnClick: a
    }
})();
cm.Gems = function (a) {
    function b(c) {
        var d = a("div.gemContainer span.amount");
        seed.player.gems = +(seed.player.gems) - c;
        a("#kochead_gems").html(seed.player.gems);
        if (d) {
            d.html(seed.player.gems)
        }
    }
    return {
        spend: b
    }
}(jQuery);
cm.Sort = function (b) {
    function a(f) {
        var d = {},
            e, c = [];
        for (e in f) {
            if (f.hasOwnProperty(e)) {
                c.push(+(e))
            }
        }
        c.sort(function (h, g) {
            return h - g
        });
        for (e = 0; e < c.length; e++) {
            d[c[e]] = f[c[e]]
        }
        return d
    }
    return {
        object: a
    }
}(jQuery);
cm = cm || {};
cm.AutoAttackLevelLock = 20;
cm.AutoAttackManagerController = function (g, s) {
    var i = null;
    var o = g;
    var v = s;
    var y = null;
    var A = false;
    var n = 0;
    var d = null;
    var C = function () {
            var E = v.getHtmlElement().find(".main .raids");
            E.bind("deleteraid", u);
            E.bind("editraid", a);
            E.bind("openraid", w);
            E.bind("refreshall", m);
            var D = v.getStartButton();
            D.click(b);
            D.bind("mouseenter mouseleave", e);
            v.getHtmlElement().find(".options_button .inlineButton").click(B);
            v.getHtmlElement().find(".raids_manupulate .addraid").click(p);
            v.getHtmlElement().find(".main .raids .add_raid_message a").click(p);
            v.getHtmlElement().find(".raids_bulk_controller .inlineButton").click(z);
            v.getHtmlElement().find(".main .raids").bind("scroll DOMMouseScroll mousewheel", j);
            cm.Tooltip.setTooltip({
                htmlElement: D,
                proxyElement: v.getStartButtonTooltipProxy(),
                tooltip: g_js_strings.modal_auto_attack.raidtimertooltip
            });
            cm.Tooltip.setTooltip({
                htmlElement: v.getHtmlElement().find(".header .whats_a_barbraid a"),
                tooltip: g_js_strings.modal_auto_attack.whatisabarbarianraidtooltip
            });
            if (null === d) {
                d = setInterval(h, 1000)
            }
        };
    var q = function () {
            if (null !== d) {
                clearInterval(d);
                d = null
            }
            v.destruct();
            i = v = o = null
        };
    var t = function (D) {
            i = D;
            i("#modal_rallypoint_tabs .button20").before("<a class='tab' id='modal_rallypoint_tab_autoattack'><span>" + g_js_strings.modal_auto_attack.barbarianraids + "</span></a>");
            var E = i("#modal_rallypoint_tab_autoattack");
            E.css("display", "none");
            if (seed.player.title >= cm.AutoAttackLevelLock) {
                E.click(x)
            } else {
                E.addClass("disabled");
                E.mouseover(function (F) {
                    showTooltip(g_js_strings.modal_openRallypoint.raidtooltip, F.target, F.originalEvent, "mainbody");
                    F.stopPropagation()
                });
                E.mouseout(function (F) {
                    removeTooltip();
                    F.stopPropagation()
                })
            }
            k(false)
        };
    var r = function (D) {
            v.getHtmlElement().find(".raid").trigger("hideothersdetails", [D])
        };
    var p = function (D) {
            modal_attack(cm.MARCH_TYPES.MARCH_TYPE_BARBARIAN, "", "", {
                callbackSaveRaid: k
            });
            D.preventDefault();
            D.stopPropagation()
        };
    var z = function (E) {
            if (i(this).find("span")[0].className == "stopAll") {
                var D = {
                    cancel: {
                        txt: g_js_strings.commonstr.cancel,
                        cls: "inlineButton brown20",
                        exe: function () {
                            Modal.hideModal()
                        }
                    },
                    okay: {
                        txt: g_js_strings.modal_auto_attack.stopallconfirmbutton,
                        cls: "inlineButton blue20",
                        description: g_js_strings.modal_auto_attack.stopallconfirmbuttonmessage,
                        exe: function () {
                            Modal.hideModal();
                            o.setBulkAction("stopAll", m)
                        }
                    }
                };
                Modal.multiButton({
                    additionalClass: "v2",
                    title: g_js_strings.modal_auto_attack.stopallconfirmtitle,
                    body: '<span style="font-weight: bold; font-size: 13px">' + g_js_strings.modal_auto_attack.stopallconfirmmessage + "</span>",
                    buttons: D,
                    buttonContainerClass: "inlineButtonRow clearfix",
                    hasInlineDescription: true
                })
            } else {
                o.setBulkAction(i(this).find("span")[0].className, m)
            }
        };
    var l = function (D) {
            if (!A) {
                A = true;
                i("#modal_rallypoint_tab_autoattack").css("display", "block")
            }
            v.refresh();
            C();
            if (D) {
                x()
            }
        };
    var u = function (E, D) {
            Modal.confirm({
                title: g_js_strings.modal_auto_attack.deleteraidconfirmtitle,
                text: g_js_strings.modal_auto_attack.deleteraidconfirmcontent,
                okay: c,
                data: D
            })
        };
    var c = function (D) {
            o.deleteRaid(D, m)
        };
    var a = function (F, G) {
            v.setEditMode((G.action === "start") ? true : false);
            if (G.action === "start") {
                y = true;
                var E = v.getHtmlElement().find(".main .raids");
                var D = E.scrollTop();
                D = Math.min(D, G.top);
                n = D = Math.max(D, G.top + G.height - E.outerHeight());
                E.scrollTop(D)
            } else {
                y = false
            }
        };
    var w = function (E, D) {
            r(D)
        };
    var B = function () {
            new cm.AutoAttackOptionsController(jQuery, o, new cm.AutoAttackOptionsView(jQuery, o))
        };
    var f = function (D) {
            Modal.showAlert(g_js_strings.modal_auto_attack.pausehelp);
            D.preventDefault();
            D.stopPropagation()
        };
    var j = function (D) {
            if (y) {
                v.getHtmlElement().find(".main .raids").scrollTop(n);
                D.preventDefault()
            }
        };
    var x = function (D) {
            if (!A) {
                return
            }
            modal_openRallypoint_tab("autoattack", 3)
        };
    var m = function () {
            k();
            setTimeout(update_seed_ajax, 1000)
        };
    var b = function (D) {
            D.preventDefault();
            o.resetTimer(k)
        };
    var e = function (D) {
            v.setStartButtonState({
                hover: ("mouseenter" === D.type)
            });
            D.stopPropagation()
        };
    var h = function () {
            var D = i("#modal_rallypoint_autoattack");
            if (D.length < 0 || (D[0] != (v.getHtmlElement())[0])) {
                q();
                return
            }
            var E = Math.max(0, parseInt(o.getData().settings.endTime) - unixtime());
            if (!isNaN(E) && E > 0) {
                v.updateTimeLeft(E)
            } else {
                v.updateTimeLeft(0)
            }
        };
    var k = function (D) {
            if (arguments.length < 1) {
                D = true
            }
            if (d !== null) {
                clearInterval(d);
                d = null
            }
            o.pull(l, D)
        };
    t(jQuery)
};
cm = cm || {};
cm.AutoAttackManagerModel = function () {
    var c = null;
    var e = function () {
            c = {
                settings: {
                    autoDelReport: 1,
                    pausePct: 100,
                    raidStartTime: unixtime() - 100000,
                    troopMode: 0,
                    endTime: unixtime() - 100000
                },
                newSettings: null,
                queue: []
            }
        };
    var b = function (j, l) {
            var k = {
                action: "deleteMarch",
                marchId: j
            };
            h(k, {
                onSuccess: function (m) {
                    for (var n = c.queue.length - 1; n >= 0; --n) {
                        try {
                            if (j == c.queue[n].cityMarches.marchId) {
                                var p = "city" + c.queue[n].cityMarches.cityId;
                                delete seed.queue_atkp[p]["m" + j];
                                if (Object.keys(seed.queue_atkp[p]).length == 0) {
                                    seed.queue_atkp[p] = []
                                }
                                break
                            }
                        } catch (o) {
                            cm.log.l("knight doesn't exist.")
                        }
                    }
                    l()
                }
            }, true)
        };
    var i = function () {
            return c
        };
    var d = function (l, k) {
            var j = {
                action: "getMarches"
            };
            h(j, {
                onSuccess: function (m) {
                    a(m);
                    l(k)
                }
            }, true)
        };
    var f = function (j, k) {
            if (c.queue.length < 1) {
                return
            }
            h({
                action: j
            }, {
                onSuccess: k
            })
        };
    var g = function (k, m) {
            var l = {
                action: "updateSettings"
            };
            for (var j in k) {
                l["settings[" + j + "]"] = k[j]
            }
            h(l, {
                onFailure: m.onFailure,
                onSuccess: function () {
                    jQuery.extend(c.settings, k);
                    m.onSuccess()
                }
            })
        };
    var h = function (l, k, j) {
            jQuery.extend(true, l, g_ajaxparams, {
                ctrl: "BotManager",
                "settings[cityId]": currentcityid
            });
            new Ajax.Request(g_ajaxpath + "ajax/_dispatch.php" + g_ajaxsuffix, {
                method: "post",
                parameters: l,
                onSuccess: function (n) {
                    cm.MarchModal.setBackedOff(false);
                    var m = n.responseText.evalJSON();
                    if (m.ok) {
                        if (!k.onSuccess) {
                            return
                        }
                        if (j) {
                            k.onSuccess(m)
                        } else {
                            k.onSuccess()
                        }
                    } else {
                        if (processUserAction(m, function () {
                            h(l, k, j)
                        }, l)) {
                            return
                        }
                        Modal.showAlert(printLocalError((m.error_code || null), (m.msg || null), (m.feedback || null)));
                        if (k.onFailure) {
                            k.onFailure()
                        }
                    }
                },
                onFailure: function () {
                    cm.MarchModal.setBackedOff(false);
                    k.onFailure()
                }
            })
        };
    var a = function (j) {
            var k = j.settings;
            if (k) {
                jQuery.extend(c.settings, k);
                c.settings.endTime = parseInt(c.settings.raidStartTime) + 86400;
                c.settings.autoDelReport = parseInt(c.settings.autoDelReport);
                c.settings.troopMode = parseInt(c.settings.troopMode)
            }
            c.queue = j.queue
        };
    e();
    this.deleteRaid = b;
    this.getData = i;
    this.pull = d;
    this.setBulkAction = f;
    this.setSettings = g;
    this.resetTimer = function (j) {
        h({
            action: "resetRaidTimer"
        }, {
            onSuccess: j
        })
    }
};
cm = cm || {};
cm.AutoAttackManagerView = function (f) {
    var e = null;
    var k = null;
    var h = null;
    var i = -1;
    var l = [];
    var d = {};
    var g = function (m) {
            e = m;
            k = f
        };
    var j = function () {
            for (var m = l.length - 1; m >= 0; --m) {
                l[m].destruct();
                delete l[m]
            }
            l.splice(0, l.length);
            l = [];
            if (h) {
                h.unbind();
                h.find("*").unbind();
                h = null
            }
            i = -1;
            d = {}
        };
    var c = function () {
            var q = k.getData();
            var p = e.extend(true, {}, q, {
                city_name: currentcityinfo[1],
                city_number: g_mapObject.getSlotCity(1, currentcityid),
                g_js_strings: g_js_strings,
                instance_guid: (new Date()).getTime(),
                site_image_url: stimgUrl
            });
            e("#modal_rallypoint_autoattack").remove();
            e("#modal_rallypoint .rallypointwrap").append(jsonT(p, cm.AUTO_ATTACK_MANAGER_RULE));
            h = e("#modal_rallypoint_autoattack");
            h.find("> .main > .glass_pane").width(cm.utils.ScrollbarWidthCalculator.get());
            if (q.queue.length > 0) {
                h.find("> .main > .raids").html("")
            }
            for (var n = 0; n < q.queue.length; ++n) {
                try {
                    var m = new cm.AutoAttackRaidModel(q.queue[n]);
                    var o = new cm.AutoAttackRaidView(m);
                    l.push(new cm.AutoAttackRaidController(m, o))
                } catch (r) {
                    cm.log.l(["Create raid instance failed. (", n, ")"].join(""))
                }
            }
        };
    var b = function (m) {
            h.find(".glass_pane").css("display", m ? "block" : "none")
        };
    var a = function (q) {
            var n = null;
            for (var m in q) {
                var p = q[m];
                var o = d[m];
                if (o !== p) {
                    if (null === n) {
                        n = h.find(".start_button")
                    }
                    if (p) {
                        n.addClass(m)
                    } else {
                        n.removeClass(m)
                    }
                }
                d[m] = p
            }
        };
    g(jQuery);
    this.render = c;
    this.setEditMode = b;
    this.setStartButtonState = a;
    this.destruct = function () {
        j();
        e = k = null
    };
    this.getHtmlElement = function () {
        return h
    };
    this.getStartButton = function () {
        return h.find("area")
    };
    this.getStartButtonTooltipProxy = function () {
        return h.find(".header img")[0]
    };
    this.hide = function () {
        h.css("display", "none")
    };
    this.refresh = function () {
        j();
        c();
        b(false)
    };
    this.updateTimeLeft = function (m) {
        if (m === i) {
            return
        }
        if (0 === m) {
            h.find(".countdown").html(g_js_strings.modal_auto_attack.timedout.toUpperCase());
            a({
                blinking: true
            })
        } else {
            h.find(".countdown").html(timestr(m, 2));
            a({
                blinking: false
            })
        }
        i = m
    }
};
cm = cm || {};
cm.AutoAttackOptionsController = function (d, e, h) {
    var l = e;
    var i = h;
    var b = function () {
            var m = i.getJqHtmlObject();
            var n = i.getHtmlElementIdBase();
            m.bind("AutoAttackOptionsViewBeforeDestruct", g);
            m.find(".troop_option > .option_input_block input").click(a);
            m.find(".button_row .inlineButton").click(k);
            d("#" + n + "_pausePct").change(c);
            d("#" + n + "_autoDelReport").change(c)
        };
    var g = function () {
            l = null;
            i = null
        };
    var f = function () {
            b()
        };
    var a = function (o) {
            var p = l.getData();
            var m = i.getHtmlElementIdBase();
            var n = -1;
            switch (o.target.id) {
            case m + "_noreplenish":
                n = cm.AUTO_BARB_TROOP_MODE.AUTO_BARB_TROOP_MODE_STOP_ON_PERCENTAGE_LOST;
                break;
            case m + "_replenish":
                if (p.newSettings.troopMode == cm.AUTO_BARB_TROOP_MODE.AUTO_BARB_TROOP_MODE_STOP_ON_PERCENTAGE_LOST) {
                    n = cm.AUTO_BARB_TROOP_MODE.AUTO_BARB_TROOP_MODE_REFILL_UNLESS_LOST_BATTLE
                } else {
                    n = p.newSettings.troopMode
                }
                break;
            case m + "_noreplenish_when_lost":
                if (p.newSettings.troopMode == cm.AUTO_BARB_TROOP_MODE.AUTO_BARB_TROOP_MODE_REFILL_ALWAYS) {
                    n = cm.AUTO_BARB_TROOP_MODE.AUTO_BARB_TROOP_MODE_REFILL_UNLESS_LOST_BATTLE
                } else {
                    n = cm.AUTO_BARB_TROOP_MODE.AUTO_BARB_TROOP_MODE_REFILL_ALWAYS
                }
                break
            }
            if (n >= 0) {
                p.newSettings.troopMode = n;
                i.updateUIState()
            }
        };
    var c = function () {
            var n = l.getData();
            var m = this.name;
            var o = null;
            switch (m) {
            case "autoDelReport":
                o = this.checked ? 1 : 0;
                break;
            case "pausePct":
                o = this.value;
                break
            }
            if (null !== o) {
                n.newSettings[m] = o
            }
        };
    var k = function () {
            var o = l.getData();
            var r = o.settings;
            var m = o.newSettings;
            var p = {};
            var q = false;
            for (var n in r) {
                if (r[n] != m[n]) {
                    p[n] = m[n];
                    q = true
                }
            }
            if (q) {
                l.setSettings(p, {
                    onSuccess: j
                })
            } else {
                Modal.hideModal()
            }
        };
    var j = function () {
            d("#modal_rallypoint_autoattack .main .raids").trigger("refreshall");
            Modal.hideModal()
        };
    f()
};
cm = cm || {};
cm.AutoAttackOptionsView = function (c, d) {
    var k = null;
    var f = null;
    var j = d;
    var g = function () {
            k.trigger("AutoAttackOptionsViewBeforeDestruct");
            k.find("*").andSelf().unbind();
            k = null;
            j = null
        };
    var e = function () {
            var l = j.getData();
            l.newSettings = c.extend({}, l.settings);
            b()
        };
    var b = function () {
            f = "AutoAttackOptionsView" + (new Date()).getTime();
            var l = {
                g_js_strings: g_js_strings,
                htmlElementIdBase: f
            };
            Modal.onCloseCallback = g;
            Modal.showModal(400, 400, 150, 100, g_js_strings.modal_auto_attack.barbarianraidoptions, jsonT(l, cm.AUTO_ATTACK_OPTIONS_RULE), null, null, null, {
                additionalClass: "v2"
            });
            k = c("#" + f);
            h()
        };
    var i = function (l) {
            c("#" + f + "_autoDelReport").attr("checked", l.newSettings.autoDelReport)
        };
    var a = function (n) {
            var m = null;
            var l = null;
            var o = c("#" + f + "_noreplenish_when_lost");
            o.attr("checked", false);
            c("#" + f + "_pausePct").val(n.newSettings.pausePct);
            switch (n.newSettings.troopMode) {
            case cm.AUTO_BARB_TROOP_MODE.AUTO_BARB_TROOP_MODE_STOP_ON_PERCENTAGE_LOST:
                m = k.find(".troop_option .option_input_block.no_auto_refill");
                l = m.next();
                break;
            case cm.AUTO_BARB_TROOP_MODE.AUTO_BARB_TROOP_MODE_REFILL_UNLESS_LOST_BATTLE:
                o.attr("checked", true);
            case cm.AUTO_BARB_TROOP_MODE.AUTO_BARB_TROOP_MODE_REFILL_ALWAYS:
                m = k.find(".troop_option .option_input_block.auto_refill");
                l = m.prev();
                break
            }
            m.addClass("selected");
            m.find("input").attr("disabled", false);
            m.find("select").attr("disabled", false);
            m.find("> input").attr("checked", true);
            l.removeClass("selected");
            l.find("input").attr("disabled", true);
            l.find("select").attr("disabled", true);
            l.find("> input").attr("disabled", false)
        };
    var h = function () {
            var l = j.getData();
            a(l);
            i(l)
        };
    e();
    this.getHtmlElementIdBase = function () {
        return f
    };
    this.getJqHtmlObject = function () {
        return k
    };
    this.updateUIState = h
};
cm = cm || {};
cm.AutoAttackRaidController = function (e, m) {
    var g = null;
    var k = e;
    var s = m;
    var h = this;
    var v = function () {
            s.getButton("stop").click(f);
            s.getButton("resume").click(o);
            s.getButton("edit").click(b);
            s.getButton("save").click(d);
            s.getButton("delete").click(i);
            s.getButton("cancel").click(p);
            s.getHtmlElement().bind("hideothersdetails", l);
            s.getHtmlElement().find(".raid_title .toggler").click(j);
            s.getHtmlElement().find(".select_bookmarks select").change(n);
            s.getHtmlElement().find(".coordinates_editor a").click(t);
            s.getHtmlElement().find("input").keydown(u);
            s.getHtmlElement().find("input").keyup(s.updateTripTime);
            if (g.browser.msie) {
                s.getHtmlElement().find(".knight_selector").bind("mousedown change blur", a)
            }
        };
    var r = function (w) {
            g = w;
            v()
        };
    var n = function (w) {
            var x = this.value.split("_");
            s.setLocation(x[0], x[1]);
            s.setCoordinateInputMethod(0)
        };
    var p = function () {
            c(false)
        };
    var t = function (x) {
            var w = g(this.parentNode);
            if (w.hasClass("manual_input")) {
                s.setCoordinateInputMethod(1)
            } else {
                s.setCoordinateInputMethod(0)
            }
        };
    var i = function () {
            if (s.getButton("delete").hasClass("grey8")) {
                return
            }
            s.getHtmlElement().trigger("deleteraid", [k.getData().cityMarches.marchId])
        };
    var j = function () {
            k.open(!k.open());
            s.displayDetails()
        };
    var b = function (w) {
            if (s.getButton("edit").hasClass("grey8")) {
                return
            }
            c(true)
        };
    var l = function (x, w) {
            if (w != k.getData().cityMarches.marchId) {
                s.displayDetails(false)
            }
        };
    var u = function (x) {
            var w = {
                "48": true,
                "49": true,
                "50": true,
                "51": true,
                "52": true,
                "53": true,
                "54": true,
                "55": true,
                "56": true,
                "57": true,
                "96": true,
                "97": true,
                "98": true,
                "99": true,
                "100": true,
                "101": true,
                "102": true,
                "103": true,
                "104": true,
                "105": true,
                "8": true,
                "46": true,
                "37": true,
                "39": true,
                "9": true
            };
            if (!w[x.keyCode]) {
                x.preventDefault()
            }
        };
    var a = function (w) {
            if ("mousedown" == w.type) {
                g(this).addClass("selected")
            } else {
                g(this).removeClass("selected")
            }
        };
    var d = function () {
            c(false);
            var w = s.getHtmlElement().find(".information .details .manual_input input");
            var y = s.getHtmlElement().find(".knight_selector");
            var A = s.getHtmlElement().find(".troops .troop_info .details .quantity .editor input");
            var z = {
                knightId: y[0].value,
                toXCoord: w[0].value,
                toYCoord: w[1].value
            };
            for (var x = A.length - 1; x >= 0; --x) {
                z["unit" + A[x].name + "Count"] = A[x].value
            }
            k.save(z, q)
        };
    var q = function (w) {
            s.getHtmlElement().trigger("refreshall")
        };
    var f = function (y) {
            if (s.getButton("stop").hasClass("grey8")) {
                return
            }
            var w = k.getData().botMarches.botMarchStatus;
            if (w == cm.BOT_STATUS.BOT_MARCH_MARCHING || w == cm.BOT_STATUS.BOT_MARCH_RETURNING) {
                var x = {
                    cancel: {
                        txt: g_js_strings.commonstr.cancel,
                        cls: "inlineButton brown20",
                        exe: function () {
                            Modal.hideModal()
                        }
                    },
                    okay: {
                        txt: g_js_strings.modal_auto_attack.stopconfirmbutton,
                        cls: "inlineButton blue20",
                        description: g_js_strings.modal_auto_attack.stopconfirmbuttonmessage,
                        exe: function () {
                            Modal.hideModal();
                            k.action("stopMarch", q)
                        }
                    }
                };
                Modal.multiButton({
                    additionalClass: "v2",
                    title: g_js_strings.modal_auto_attack.stopconfirmtitle,
                    body: '<span style="font-weight: bold; font-size: 13px">' + g_js_strings.modal_auto_attack.stopconfirmmessage + "</span>",
                    buttons: x,
                    buttonContainerClass: "inlineButtonRow clearfix",
                    hasInlineDescription: true
                })
            } else {
                k.action("stopMarch", q)
            }
        };
    var o = function () {
            if (s.getButton("edit").hasClass("grey8")) {
                return
            }
            k.action("resumeMarch", q)
        };
    var c = function (w) {
            s.displayDetails(true);
            s.setEditMode(w)
        };
    r(jQuery);
    this.destruct = function () {
        s.destruct();
        g = k = s = h = null
    }
};
cm = cm || {};
cm.AutoAttackRaidStatus = function () {
    var a = [];
    if ("on" == cm.features.AUTO_ATTACK) {
        a[cm.BOT_STATUS.BOT_MARCH_MARCHING] = {
            css_class: "marching",
            display: g_js_strings.commonstr.marching,
            action_button: "stop"
        };
        a[cm.BOT_STATUS.BOT_MARCH_RETURNING] = {
            css_class: "returning",
            display: g_js_strings.commonstr.returning,
            action_button: "stop"
        };
        a[cm.BOT_STATUS.BOT_MARCH_STOPPED] = {
            css_class: "stopped",
            display: g_js_strings.modal_auto_attack.stopped,
            action_button: "resume"
        };
        a[cm.BOT_STATUS.BOT_MARCH_INSUFFICIENT_TROOPS] = {
            css_class: "insufficient_troops",
            display: g_js_strings.modal_auto_attack.insufficienttroops,
            action_button: "resume"
        };
        a[cm.BOT_STATUS.BOT_MARCH_MAX_RAIDS_EXCEEDED] = {
            css_class: "max_raids_exceeded",
            display: g_js_strings.modal_auto_attack.maxraidsexceeded,
            action_button: "resume"
        };
        a[cm.BOT_STATUS.BOT_MARCH_TIMED_OUT] = {
            css_class: "timed_out",
            display: g_js_strings.modal_auto_attack.timedout,
            action_button: "resume"
        };
        a[cm.BOT_STATUS.BOT_MARCH_RESTING] = {
            css_class: "resting",
            display: g_js_strings.attack_generatequeue.unloadingloot,
            action_button: "stop"
        };
        a[cm.BOT_STATUS.BOT_MARCH_STOPPING] = {
            css_class: "resting",
            display: g_js_strings.modal_auto_attack.stopping,
            action_button: "resume"
        };
        a[cm.BOT_STATUS.BOT_MARCH_UNAVAILABLE_KNIGHT] = {
            css_class: "unavailable_knight",
            display: g_js_strings.modal_auto_attack.unavailableknight,
            action_button: "resume"
        };
        a[cm.BOT_STATUS.BOT_MARCH_RALLY_POINT_LIMIT_REACHED] = {
            css_class: "rp_limit_reached",
            display: g_js_strings.modal_auto_attack.rplimitreached,
            action_button: "resume"
        }
    }
    return a
}();
cm.AutoAttackRaidModel = function (e) {
    var b = "autoAttackUI_open_";
    var f = null;
    var d = null;
    var c = function (g) {
            f = g;
            f.botMarches.open = false
        };
    var a = function (h, i, g) {
            jQuery.extend(true, h, g_ajaxparams, {
                ctrl: "BotManager",
                "settings[cityId]": f.cityMarches.fromCityId,
                "settings[marchId]": f.cityMarches.marchId
            });
            new Ajax.Request(g_ajaxpath + "ajax/_dispatch.php" + g_ajaxsuffix, {
                method: "post",
                parameters: h,
                onSuccess: function (k) {
                    cm.MarchModal.setBackedOff(false);
                    var j = k.responseText.evalJSON();
                    if (j.ok) {
                        if (g) {
                            i(j)
                        } else {
                            i()
                        }
                    } else {
                        if (processUserAction(j, function () {
                            a(h, i, g)
                        }, h)) {
                            return
                        }
                        Modal.showAlert(printLocalError((j.error_code || null), (j.msg || null), (j.feedback || null)))
                    }
                },
                onFailure: function () {
                    cm.MarchModal.setBackedOff(false)
                }
            })
        };
    c(e);
    this.getData = function () {
        return f
    };
    this.action = function (g, h) {
        a({
            action: g
        }, h)
    };
    this.open = function (h) {
        var g = b + f.cityMarches.fromCityId;
        if (undefined === h) {
            if (null === d) {
                if (cm.ClientSideCookieManager.getCookie(g) == f.cityMarches.marchId) {
                    d = true
                } else {
                    d = false
                }
            }
            return d
        }
        d = h ? true : false;
        if (d) {
            cm.ClientSideCookieManager.setCookie(g, f.cityMarches.marchId)
        } else {
            if (cm.ClientSideCookieManager.getCookie(g) == f.cityMarches.marchId) {
                cm.ClientSideCookieManager.deleteCookie(g)
            }
        }
    };
    this.save = function (g, h) {
        g.fromCityId = f.cityMarches.fromCityId;
        g.marchId = e.cityMarches.marchId;
        g.is_edit = true;
        cm.MarchModal.saveRaid(g, "cityMarches", function () {
            for (var i in g) {
                f.cityMarches[i] = g[i]
            }
            if (h) {
                h()
            }
        })
    }
};
cm = cm || {};
cm.AutoAttackRaidView = function (g) {
    var f = null;
    var p = null;
    var o = null;
    var l = null;
    var j = null;
    var q = function (r) {
            if (undefined == r) {
                r = p.open()
            }
            if (r) {
                l.find(".information").css("display", "block");
                l.find(".toggler").addClass("open");
                l.trigger("openraid", p.getData().cityMarches.marchId)
            } else {
                l.find(".information").css("display", "none");
                l.find(".toggler").removeClass("open")
            }
            p.open(r)
        };
    var c = function (r) {
            if (r) {
                return f(o.find("." + r))
            }
            return o.find(".inlineButton")
        };
    var h = function (r) {
            f = r;
            p = g;
            d()
        };
    var d = function () {
            var u = p.getData();
            var r = [];
            var y = seed.units["city" + currentcityid];
            for (var s in cm.UNIT_TYPES) {
                s = cm.UNIT_TYPES[s];
                var t = "unt" + s;
                r.push({
                    type_id: t.split("unt")[1],
                    type: unitcost[t][0],
                    quantity: u.cityMarches["unit" + s + "Return"],
                    stock: y[t]
                })
            }
            var w = u.botMarches.botMarchStatus;
            if (w == cm.BOT_STATUS.BOT_MARCH_STOPPED && u.botMarches.marchStatus != cm.MARCH_STATUS.MARCH_STATUS_STOPPED) {
                w = cm.BOT_STATUS.BOT_MARCH_STOPPING
            }
            var x = "Unknown";
            try {
                x = seed.knights["city" + currentcityid]["knt" + u.cityMarches.knightId].knightName.split(" ")[0]
            } catch (v) {}
            u = f.extend(true, {}, u, {
                g_js_strings: g_js_strings,
                knight_name: x,
                last_march: formatDateByUnixTime(u.cityMarches.marchTimestamp),
                round_trip: timestr(u.cityMarches.returnEta - u.cityMarches.marchTimestamp),
                site_image_url: stimgUrl,
                status: cm.AutoAttackRaidStatus[w].display,
                status_css: cm.AutoAttackRaidStatus[w].css_class,
                troops: r
            });
            if (!l) {
                f("#modal_rallypoint_autoattack .main .raids").append(jsonT(u, cm.AUTO_ATTACK_RAID_RULE));
                l = f("#modal_rallypoint_autoattack .main .raids .raid").last()
            } else {
                o = null;
                j = null;
                l.find("> div").replaceWith(f(jsonT(u, cm.AUTO_ATTACK_RAID_RULE)).find("> div"))
            }
            o = l.find(".raid_controller");
            j = l.find(".troops");
            n();
            q();
            e(cm.AutoAttackRaidStatus[w].action_button, true);
            b(false);
            switch (w) {
            case cm.BOT_STATUS.BOT_MARCH_STOPPING:
                c("resume").removeClass("brown8").addClass("grey8");
            case cm.BOT_STATUS.BOT_MARCH_MARCHING:
            case cm.BOT_STATUS.BOT_MARCH_RETURNING:
                c("edit").removeClass("brown8").addClass("grey8");
                c("delete").removeClass("brown8").addClass("grey8");
                break
            }
        };
    var i = function (t) {
            var u = l.find(".select_bookmarks select")[0].options;
            u.length = 1;
            for (var r = 0; r < t.length; ++r) {
                var s = t[r];
                if (undefined == s.bookmark_id) {
                    continue
                }
                u[u.length] = new Option([s.name, " (", s.left, ", ", s.top, ")"].join(""), s.left + "_" + s.top)
            }
        };
    var a = function (r) {
            if (0 == r) {
                l.find(".coordinates_editor").removeClass("bookmarks")
            } else {
                cm.Bookmarks.get(i);
                l.find(".coordinates_editor").addClass("bookmarks")
            }
        };
    var b = function (r) {
            if (r) {
                l.addClass("editing");
                j.find(".quantity").each(k);
                l.find(".knight_selector")[0].value = p.getData().cityMarches.knightId
            } else {
                l.removeClass("editing")
            }
            l.trigger("editraid", {
                raid_id: p.getData().cityMarches.marchId,
                action: r ? "start" : "end",
                top: l[0].offsetTop,
                height: l.outerHeight()
            });
            if (r) {
                l.find(".glass_pane").css("display", "none")
            }
        };
    var k = function (r, s) {
            var u = f(s);
            var t = parseInt(u.find(".label").html());
            if (isNaN(t)) {
                t = 0
            }
            u.find("input").val(t)
        };
    var n = function () {
            var t = seed.knights["city" + currentcityid];
            var v = l.find(".knight_selector")[0].options;
            v.length = 0;
            if (undefined == t || t.length < 1) {
                v[v.length] = new Option(g_js_strings.modal_attack.noknightavailable, 0);
                return
            } else {
                v[v.length] = new Option(g_js_strings.modal_attack.dchooseknightd, 0)
            }
            var s = Object.keys(t);
            s.sort(cm.MarchModal.sortKnights);
            for (var r = 0; r < s.length; r++) {
                var u = parseInt(s[r].split("knt")[1]);
                if (u == parseInt(seed.leaders["city" + currentcityid].resourcefulnessKnightId) || u == parseInt(seed.leaders["city" + currentcityid].intelligenceKnightId) || u == parseInt(seed.leaders["city" + currentcityid].combatKnightId) || u == parseInt(seed.leaders["city" + currentcityid].politicsKnightId)) {
                    continue
                }
                if (1 != t[s[r]].knightStatus && u != parseInt(p.getData().cityMarches.knightId)) {
                    continue
                }
                v[v.length] = new Option([t[s[r]].knightName, " (", t[s[r]].combat, ")"].join(""), u)
            }
        };
    var e = function (r, s) {
            o.find("." + r).css("display", s ? "inline-block" : "")
        };
    var m = function () {
            var u = l.find(".troop_info input");
            var s = {};
            for (var t = u.length - 1; t >= 0; --t) {
                s[u[t].name] = u[t].value
            }
            var r = l.find(".information .details .manual_input input");
            l.find(".information .details .round_trip").html(cm.MarchModal.marchTimeCalculator(s, r[0].value, r[1].value, true))
        };
    h(jQuery);
    this.displayDetails = q;
    this.getButton = c;
    this.redraw = d;
    this.setBookmarks = i;
    this.setCoordinateInputMethod = a;
    this.setEditMode = b;
    this.updateTripTime = m;
    this.destruct = function () {
        l.unbind();
        l.find("*").unbind();
        f = p = l = o = j = null
    };
    this.getHtmlElement = function () {
        return l
    };
    this.setLocation = function (s, t) {
        var r = l.find(".information .details .manual_input input");
        r[0].value = s;
        r[1].value = t;
        m()
    }
};
cm.AutoAttackReportsView = function (d) {
    var a;

    function b(h) {
        var g = cm.Template.renderTemplate("AutoAttackReportsView", "autoAttackReports", {
            id: "newId"
        });
        if (d(".barbReports").length == 0) {
            d(a).append(g)
        }
        for (var e in h.troops) {}
        var f = '<table class="totalFought"><tr><td>' + h.totalTroops + "</td><td>" + h.totalFought + "</td><td>" + h.totalSurvived + "</td></tr>" + middle + "</table>"
    }

    function c(f, g, e) {
        return "<tr><td>" + f + "</td><td>" + g + "</td><td>" + e + "</td></tr>"
    }
    return {
        render: function (f, e) {
            a = ".reportdetail";
            b(f)
        }
    }
}(jQuery);
cm = cm || {};
cm.AutoAttackManagerTemplateLoader = function (b) {
    if ((undefined == cm.features.AUTO_ATTACK) || ("on" != cm.features.AUTO_ATTACK)) {}
    var a = function () {
            cm.AUTO_ATTACK_MANAGER_RULE = {
                self: null
            };
            cm.AUTO_ATTACK_RAID_RULE = {
                self: null,
                "self.troops[*]": null
            };
            cm.AUTO_ATTACK_OPTIONS_RULE = {
                self: null
            };
            if ("on" == cm.features.AUTO_ATTACK) {
                cm.AUTO_ATTACK_MANAGER_RULE.self = cm.Template.getTemplate("autoAttack_34", "self");
                cm.AUTO_ATTACK_RAID_RULE.self = cm.Template.getTemplate("autoAttack_34", "queue[*]");
                cm.AUTO_ATTACK_RAID_RULE["self.troops[*]"] = cm.Template.getTemplate("autoAttack_34", "queue[*].troops[*]");
                cm.AUTO_ATTACK_OPTIONS_RULE.self = cm.Template.getTemplate("autoAttack_34", "options")
            }
        };
    var c = function (e) {
            var d = e.responseText.split("<!---->");
            if (d.length < 4) {
                cm.log.l("Auto attack template is corrupted.")
            }
            cm.AUTO_ATTACK_MANAGER_RULE.self = d[0];
            cm.AUTO_ATTACK_RAID_RULE.self = d[1];
            cm.AUTO_ATTACK_RAID_RULE["self.troops[*]"] = d[2];
            cm.AUTO_ATTACK_OPTIONS_RULE.self = d[3]
        };
    b(document).ready(a);
    return {
        reload: a
    }
}(jQuery);
var cm = cm || {};
cm.CustomEventDispatcher = function () {
    var b = {};
    var a = function (f, g) {
            var c = -1;
            if (b[f]) {
                var e;
                var d = b[f].length;
                var h = b[f];
                for (e = 0; e < d; e++) {
                    var j = h[e];
                    if (j == g) {
                        c = e;
                        break
                    }
                }
            }
            return c
        };
    this.addEventListener = function (c, d) {
        if (typeof (d) !== "function") {
            return
        }
        if (b[c]) {
            if (a(c, d) < 0) {
                b[c].push(d)
            }
        } else {
            b[c] = [d]
        }
    };
    this.removeEventListener = function (d, f) {
        var c = a(d, f);
        if (c >= 0) {
            var e = b[d];
            e.splice(c, 1)
        }
    };
    this.dispatchCustomEvent = function (g) {
        var f = g.getType();
        var h = b[f];
        if (h) {
            var c = h.slice(0);
            var d = c.length;
            var e;
            for (e = 0; e < d; e++) {
                var j = c[e];
                if (typeof (j) == "function") {
                    j(g)
                }
            }
            c = null
        }
    }
};
cm.CustomEvent = function (c) {
    var b = c;
    var a = null;
    this.getTarget = function () {
        return a
    };
    this.setTarget = function (d) {
        a = d
    };
    this.getType = function () {
        return b
    }
};
cm.BaseDialog = function (c) {
    cm.CustomEventDispatcher.call(this);
    var e = this;
    var d;
    var b;
    var a;
    var f = function () {
            a = false;
            b = c || document.body;
            d = document.createElement("div");
            d.className = "dialogContainer"
        };
    this.show = function () {
        a = true;
        b.appendChild(d)
    };
    this.close = function () {
        try {
            var i = a;
            a = false;
            b.removeChild(d);
            if (i) {
                var g = new cm.DialogEvent(cm.DialogEvent.CLOSE);
                g.setTarget(e);
                e.dispatchCustomEvent(g)
            }
        } catch (h) {}
    };
    this.isActive = function () {
        return a
    };
    this.getHtmlElement = function () {
        return d
    };
    this.setParentElement = function (g) {
        b = g ? g : b
    };
    f()
};
cm.OOP.inherits(cm.BaseDialog, cm.CustomEventDispatcher);
cm.BaseDialog.prototype.getPriority = function () {
    return 0
};
cm.BaseCollection = function () {
    cm.CustomEventDispatcher.call(this);
    var d = this;
    var c = [];
    var b = 0;
    var a = {};
    this.add = function (i, g) {
        var j = i.getKey();
        if (i && !a[j]) {
            a[j] = i;
            c.push(i);
            var h = new cm.CollectionEvent(cm.CollectionEvent.ELEMENT_ADDED);
            h.setTarget(i);
            if (g) {
                c.sort(g)
            }
            d.dispatchCustomEvent(h)
        }
    };
    this.hasNext = function () {
        return b < c.length - 1
    };
    var e = function (g, i) {
            var j = {
                previousPosition: g,
                currentPosition: i
            };
            var h = new cm.CollectionEvent(cm.CollectionEvent.POSITION_CHANGED);
            h.setTarget(j);
            d.dispatchCustomEvent(h)
        };
    this.next = function () {
        if (d.hasNext()) {
            var g = b;
            b++;
            e(g, b);
            return c[b]
        } else {
            return null
        }
    };
    this.getElementAtCurrentPosition = function () {
        var g = c.slice(0);
        return g[b]
    };
    this.getElementAtPosition = function (g) {
        var h = c.slice(0);
        return h[g]
    };
    var f = function (h) {
            var g, k;
            var j = c.slice(0);
            for (g in j) {
                k = j[g];
                if (k.hasOwnProperty("getKey") && k.getKey() == h) {
                    return g
                }
            }
            return -1
        };
    this.getElementPosition = function (g) {
        return f(g.getKey())
    };
    this.getElementByKey = function (g) {
        return a[g]
    };
    this.remove = function (j) {
        var i = j.getKey();
        var g = f(i);
        if (g >= 0) {
            delete a[i];
            c.splice(g, 1);
            var h = new cm.CollectionEvent(cm.CollectionEvent.ELEMENT_REMOVED);
            h.setTarget(j);
            d.dispatchCustomEvent(h)
        }
    };
    this.clear = function () {
        var g, h;
        for (g in _collections) {
            h = _collections[g];
            this.remove(h)
        }
    };
    this.hasPrevious = function () {
        return b > 0
    };
    this.previous = function () {
        if (d.hasPrevious()) {
            var g = b;
            b--;
            e(g, b);
            return c[b]
        } else {
            return null
        }
    };
    this.getCount = function () {
        return c.length
    };
    this.jumpTo = function (h) {
        if (h != b && h >= 0 && h < c.length) {
            var g = b;
            b = h;
            e(g, h);
            return c[b]
        }
    };
    this.getCurrentPosition = function () {
        return b
    };
    this.toArray = function () {
        return c.slice(0)
    }
};
cm.OOP.inherits(cm.BaseCollection, cm.CustomEventDispatcher);
cm.CollectionEvent = function (a) {
    cm.CustomEvent.call(this, a)
};
cm.OOP.inherits(cm.CollectionEvent, cm.CustomEvent);
cm.CollectionEvent.ELEMENT_ADDED = "elementAdded";
cm.CollectionEvent.ELEMENT_REMOVED = "elementRemoved";
cm.CollectionEvent.POSITION_CHANGED = "positionChanged";
cm.DialogEvent = function (b) {
    cm.CustomEvent.call(this, b);
    var a = null;
    this.setMessage = function (c) {
        a = c
    };
    this.getMessage = function (c) {
        return a
    }
};
cm.OOP.inherits(cm.DialogEvent, cm.CustomEvent);
cm.DialogEvent.CLOSE = "close";
cm.DialogEvent.OK = "ok";
cm.DialogEvent.CANCEL = "cancel";
cm.RewardEvent = function (a) {
    cm.CustomEvent.call(this, a)
};
cm.OOP.inherits(cm.RewardEvent, cm.CustomEvent);
cm.RewardEvent.SUCESS = "RewardEvent_success";
cm.RewardEvent.FAILURE = "RewardEvent_failure";
cm.UserTileInfoFactory = new function () {
    this.getTileInfo = function (f, e) {
        var b = {};
        var g = seed.cities;
        var d, k;
        for (d = 0; d < g.length; d++) {
            k = g[d];
            if (k[0] == f) {
                b.city = {};
                b.city.id = k[0];
                b.city.name = k[1];
                b.city.number = d;
                b.city.x = k[2];
                b.city.y = k[3];
                b.city.tileId = k[5];
                b.city.type = 51;
                b.city.typeName = g_mapObject.typename[g_mapObject.types[51]].capitalize();
                if (k[5] == e) {
                    b.isCity = true;
                    return b
                } else {
                    b.isCity = false;
                    break
                }
            }
        }
        var l = seed.wilderness;
        var a = !(l instanceof Array) && typeof (l) === "object";
        if (a) {
            var c, h, j;
            for (c in l) {
                h = l[c];
                j = h["t" + e];
                if (j !== undefined) {
                    b.wilderness = {};
                    b.wilderness.tileId = j.tileId;
                    b.wilderness.type = parseInt(j.tileType);
                    b.wilderness.typeName = g_mapObject.typename[g_mapObject.types[parseInt(j.tileType)]].capitalize();
                    b.wilderness.x = parseInt(j.xCoord);
                    b.wilderness.y = parseInt(j.yCoord);
                    return b
                }
            }
        }
    }
}();
if (!window.BarbarianRaid) {
    var BarbarianRaid = new Object()
}
BarbarianRaid.Properties = {
    MAX_TROOPS_ALLOWED: 100000,
    mercenaryGold: [1000, 10000, 100000],
    raidDateUnix: null,
    helpers: null,
    playerSex: null,
    playerDisplayName: null,
    cityName: null,
    helpStatus: null,
    arrError: null,
    requestIn: null,
    stimgUrl: null,
    playerCities: null,
    worldCities: null,
    isSameServer: null,
    isDiffServer: null,
    destServerID: null,
    raidID: null
};
BarbarianRaid.Methods = {
    check: function () {
        if (this.isUnderAttack()) {
            BarbarianRaid.underAttack()
        }
    },
    isUnderAttack: function () {
        if (seed.barbarianRaid && parseInt(tvuid) == parseInt(seed.barbarianRaid.userId)) {
            return true
        }
        return false
    },
    isPeace: function () {
        if (seed.barbarianEvent && parseInt(seed.barbarianEvent.eventStatus) == 4) {
            return true
        }
        return false
    },
    isComing: function () {
        if (seed.barbarianEvent && parseInt(seed.barbarianEvent.eventStatus) == 2) {
            return true
        }
        return false
    },
    updateStatus: function () {
        var b;
        var d;
        var a;
        var e = false;
        if (this.isPeace()) {
            b = g_js_strings.barbarian.peacedeclared;
            d = "peace";
            a = "peace";
            e = true
        } else {
            if (this.isUnderAttack()) {
                b = g_js_strings.barbarian.barbariansatthegates;
                d = "under-attack";
                a = "underAttack";
                e = true
            } else {
                if (this.isComing()) {
                    b = g_js_strings.barbarian.barbarianscomming;
                    d = "coming";
                    a = "report";
                    e = true
                }
            }
        }
        if (e) {
            var c = new Array();
            c.push("<div class='raids-status " + d + "'>");
            c.push("	<span class='text'>" + b + "</span>");
            c.push("	<a class='button20' onclick='BarbarianRaid." + a + "();return false;'><span>" + g_js_strings.commonstr.view + "</span></a>");
            c.push("</div>");
            $("topnav_barbarian").innerHTML = c.join("");
            $("topnav_barbarian").show()
        } else {
            $("topnav_barbarian").hide()
        }
    },
    lendAid: function () {
        var c = new Array();
        var f = (this.playerSex == "M") ? g_js_strings.commonstr.lord : g_js_strings.commonstr.lady;
        c.push("<div class='raids-attack'>");
        c.push("	<div class='info'>");
        c.push("		<div class='header'>" + g_js_strings.barbarian.atthegates + "</div>");
        c.push("		<div class='desc'>" + g_js_strings.barbarian.atthegatesdesc + "</div>");
        c.push("		<div class='city'>" + g_js_strings.commonstr.player + ": " + f + " " + this.playerDisplayName + "<br/>" + g_js_strings.barbarian.cityname + ": " + this.cityName + "</div>");
        c.push("	</div>");
        c.push("	<div class='panel-aid'>");
        c.push("		<div class='content'>");
        if (this.helpers.length < 10) {
            c.push("			<a class='button-aid' onclick='BarbarianRaid.help(); return false;'>" + g_js_strings.barbarian.lendaid + "</a>")
        }
        c.push("			<div class='label-give-aid'>" + g_js_strings.barbarian.giveaid + "</div>");
        c.push("		<div class='player'><span class='header-name'>" + g_js_strings.barbarian.playername + "</span><span class='header-troop'>" + g_js_strings.commonstr.troops + "</span></div>");
        for (var b = 0; b < this.helpers.length; b++) {
            var e = (this.helpers[b].displayName == null || this.helpers[b].displayName == "") ? g_js_strings.barbarian.foreignaid : this.helpers[b].displayName;
            c.push("		<div class='player'><span class='name'>" + e + "</span><span class='troop'>" + addCommas(this.helpers[b].numTroops) + "</span></div>")
        }
        c.push("			<div class='note'><span>" + g_js_strings.commonstr.note + ":</span> " + g_js_strings.barbarian.troopscapped + " " + g_js_strings.barbarian.foreignaiddesc + "</div>");
        c.push("		</div>");
        c.push("	</div>");
        var d = 1 + Math.floor(Math.random() * 5);
        var a = this.raidDateUnix - this.unixtime();
        c.push("	<div class='time-left bg" + d + "'>");
        if (a < 0) {
            c.push("		<span class='label'>" + g_js_strings.commonstr.impending + "</span>")
        } else {
            c.push("		<span class='label'>" + g_js_strings.commonstr.timeremaining + ":</span>");
            c.push("		<span class='time'>" + this.timestr(a) + "</span>")
        }
        c.push("	</div>");
        c.push("</div>");
        Modal.showModal(740, 500, 0, 10, "", c.join(""));
        $("modalControlsClose1").hide()
    },
    showStatus: function (cid) {
        var params = Object.clone(g_ajaxparams);
        params.cid = cid;
        new Ajax.Request(g_ajaxpath + "ajax/barbarianCityReport.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    var html = new Array();
                    var title = (rslt.playerInfo.playerSex == "M") ? g_js_strings.commonstr.lord : g_js_strings.commonstr.lady;
                    html.push("<div class='raids-attack'>");
                    html.push("	<div class='info'>");
                    html.push("		<div class='header'>" + g_js_strings.barbarian.atthegates + "</div>");
                    html.push("		<div class='desc'>" + g_js_strings.barbarian.atthegatesdesc + "</div>");
                    html.push("		<div class='city'>" + g_js_strings.commonstr.player + ": " + title + " " + rslt.playerInfo.displayName + "<br/>" + g_js_strings.barbarian.cityname + ": " + rslt.cityInfo.cityName + "</div>");
                    html.push("	</div>");
                    html.push("	<div id='raids_defend_status' class='defend-status' style='display:none'></div>");
                    html.push("	<div class='panel-aid'>");
                    html.push("		<div class='content'>");
                    html.push("			<div class='empty'>&nbsp;</div>");
                    html.push("			<div class='label-give-aid'>" + g_js_strings.barbarian.giveaid + "</div>");
                    html.push("		<div class='player'><span class='header-name'>" + g_js_strings.barbarian.playername + "</span><span class='header-troop'>" + g_js_strings.commonstr.troops + "</span></div>");
                    for (var i = 0; i < rslt.assistanceInfo.length; i++) {
                        var playerName = (rslt.assistanceInfo[i].displayName == "" || rslt.assistanceInfo[i].displayName == null) ? g_js_strings.barbarian.foreignaid : rslt.assistanceInfo[i].displayName;
                        html.push("		<div class='player'><span class='name'>" + playerName + "</span><span class='troop'>" + addCommas(rslt.assistanceInfo[i].numTroops) + "</span></div>")
                    }
                    html.push("			<div class='note'><span>" + g_js_strings.commonstr.note + ":</span> " + g_js_strings.barbarian.troopscapped + " " + g_js_strings.barbarian.foreignaiddesc + "</div>");
                    html.push("		</div>");
                    html.push("	</div>");
                    var rand = 1 + Math.floor(Math.random() * 5);
                    var timeleft = rslt.raidInfo.raidDateUnix - unixtime();
                    html.push("	<div class='time-left bg" + rand + "'>");
                    if (timeleft < 0) {
                        html.push("		<span class='label'>" + g_js_strings.commonstr.impending + "</span>")
                    } else {
                        html.push("		<span class='label'>" + g_js_strings.commonstr.timeremaining + ":</span>");
                        html.push("		<span class='time'>" + this.timestr(timeleft) + "</span>")
                    }
                    html.push("	</div>");
                    html.push("</div>");
                    Modal.showModal(740, 500, 0, 10, "", html.join(""))
                } else {
                    Modal.showAlert(g_js_strings.barbarian.cannotgetalliesfriends, false, 100)
                }
            },
            onFailure: function () {
                Modal.showAlert(g_js_strings.barbarian.cannotgetalliesfriends, false, 100)
            }
        })
    },
    underAttack: function () {
        var e = new Array();
        var h = (seed.player.g == "M") ? g_js_strings.commonstr.lord : g_js_strings.commonstr.lady;
        var k = seed.barbarianRaid.cityId;
        var g = "";
        for (var c = 0; seed.cities.length; c++) {
            if (seed.cities[c][0] == seed.barbarianRaid.cityId) {
                g = seed.cities[c][1];
                break
            }
        }
        e.push("<div class='raids-attack'>");
        e.push("	<div class='info'>");
        e.push("		<div class='header'>" + g_js_strings.barbarian.atthegates + "</div>");
        e.push("		<div class='desc'>" + g_js_strings.barbarian.atthegatesdesc + "</div>");
        e.push("		<div class='city'>" + g_js_strings.commonstr.player + ": " + h + " " + seed.player.name + "<br/>" + g_js_strings.barbarian.cityname + ": " + g + "</div>");
        e.push("	</div>");
        e.push("	<div class='panel-aid'>");
        e.push("		<div class='content'>");
        if (parseInt(seed.barbarianRaid.raidStatus) == 1) {
            e.push("			<a id='button_defend' class='button-aid' onclick='BarbarianRaid.defend(); return false;' style='display: block;'>" + g_js_strings.commonstr.defend + "</a>");
            e.push("			<a id='button_callforhelp' class='button-aid' onclick='BarbarianRaid.callForHelp(); return false;' style='display: none;'>" + g_js_strings.barbarian.callforhelp + "</a>")
        } else {
            if (parseInt(seed.barbarianRaid.raidStatus) == 2) {
                e.push("			<a class='button-aid' onclick='BarbarianRaid.callForHelp(); return false;'>" + g_js_strings.barbarian.callforhelp + "</a>")
            }
        }
        e.push("			<div class='label-give-aid'>" + g_js_strings.barbarian.giveaid + "</div>");
        e.push("		<div class='player'><span class='header-name'>" + g_js_strings.barbarian.playername + "</span><span class='header-troop'>" + g_js_strings.commonstr.troops + "</span></div>");
        for (var d = 0; d < seed.barbarianRaid.helpers.length; d++) {
            var b = (seed.barbarianRaid.helpers[d].displayName == "" || seed.barbarianRaid.helpers[d].displayName == null) ? g_js_strings.barbarian.foreignaid : seed.barbarianRaid.helpers[d].displayName;
            e.push("		<div class='player'><span class='name'>" + b + "</span><span class='troop'>" + addCommas(seed.barbarianRaid.helpers[d].numTroops) + "</span></div>")
        }
        e.push("			<div class='note'><span>" + g_js_strings.commonstr.note + ":</span> " + g_js_strings.barbarian.troopscapped + " " + g_js_strings.barbarian.foreignaiddesc + "</div>");
        e.push("		</div>");
        e.push("	</div>");
        var f = 1 + Math.floor(Math.random() * 5);
        var a = seed.barbarianRaid.raidDateUnix - unixtime();
        e.push("	<div class='time-left bg" + f + "'>");
        if (a < 0) {
            e.push("		<span class='label'>" + g_js_strings.commonstr.impending + "</span>")
        } else {
            e.push("		<span class='label'>" + g_js_strings.commonstr.timeremaining + ":</span>");
            e.push("		<span class='time'>" + this.timestr(a) + "</span>")
        }
        e.push("	</div>");
        e.push("	<div class='button-report'><a class='buttonDown25' onclick='Modal.hideModalAll(); BarbarianRaid.report(); return false;'><span>" + g_js_strings.barbarian.buttoninvasionreport + "</span></a></div>");
        e.push("</div>");
        Modal.showModal(740, 500, 0, 10, "", e.join(""))
    },
    defend: function () {
        var params = Object.clone(g_ajaxparams);
        params.raidId = seed.barbarianRaid.barbarianRaidId;
        params.cityId = seed.barbarianRaid.cityId;
        new Ajax.Request(g_ajaxpath + "ajax/barbarianRaidDefendCity.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    Modal.showAlert(g_js_strings.barbarian.youhavedefended, false, 100);
                    $("button_defend").hide();
                    $("button_callforhelp").show()
                } else {
                    Modal.showAlert(g_js_strings.barbarian.erroroccured, false, 100)
                }
            },
            onFailure: function () {}
        })
    },
    showError: function () {
        var b = new Array();
        b.push("<div class='raids-help'>");
        b.push("		<div class='header error'>" + g_js_strings.commonstr.error + "</div>");
        b.push("		<div class='content'>");
        b.push("			<ul>");
        for (var a = 0; a < this.arrError.length; a++) {
            b.push("			<li>" + this.arrError[a] + "</li>")
        }
        b.push("			</ul>");
        b.push("		</div>");
        b.push("</div>");
        Modal.showModal(500, 500, 0, 100, "", b.join(""))
    },
    assist: function (b, c) {
        this.helpStatus = 1;
        this.isSameServer = true;
        this.isDiffServer = false;
        this.destServerID = parseInt(g_server);
        this.raidID = b;
        var a = new Array();
        a.push("<div class='raids-help'>");
        a.push("		<div class='header'>" + g_js_strings.barbarian.mercenariesdispatched + "</div>");
        a.push("		<div class='mercenaries'></div>");
        a.push("		<div class='panel-button'>");
        a.push("			<div class='label'>" + g_js_strings.barbarian.helpmore + "</div>");
        a.push('			<a class="button25" onclick="BarbarianRaid.chooseAssistCity(1); return false;"><span>' + g_js_strings.barbarian.sendtroops + "</span></a>");
        a.push('			<a class="button25" onclick="BarbarianRaid.chooseAssistCity(2); return false;"><span>' + g_js_strings.barbarian.hiremercenaries + "</span></a>");
        a.push("		</div>");
        a.push("</div>");
        Modal.showModal(500, 500, 0, 100, "", a.join(""))
    },
    chooseAssistCity: function (a) {
        var d = "";
        var e = "";
        var c = new Array();
        if (a == 1) {
            d = g_js_strings.barbarian.troopfromcity;
            e = "<select id='raids_help_choosecity' onchange='BarbarianRaid.assistTroopFromCity(this.options[this.selectedIndex].value)'>"
        } else {
            d = g_js_strings.barbarian.goldfromcity;
            e = "<select id='raids_help_choosecity' onchange='BarbarianRaid.sendMercenariesFromCity(this.options[this.selectedIndex].value)'>"
        }
        c.push("<div class='raids-choosecity'>");
        c.push("<div class='header'>" + d + "</div>");
        c.push("<div class='select-city'>");
        c.push(e);
        c.push("<option value='0'>-- " + g_js_strings.barbarian.selectacity + " --</option>");
        for (var b = 0; b < seed.cities.length; b++) {
            c.push("<option value='" + seed.cities[b][0] + "," + g_server + "'>" + seed.cities[b][1] + "</option>")
        }
        c.push("</select>");
        c.push("</div>");
        c.push("<div class='button-back'><a class='buttonDown25' onclick='Modal.hideModal(); return false;'><span>" + g_js_strings.commonstr.back + "</span></a></div>");
        c.push("</div>");
        Modal.showModal(400, 500, 0, 200, "", c.join(""))
    },
    help: function () {
        var a = new Array();
        a.push("<div class='raids-help'>");
        if (this.helpStatus == 1) {
            a.push("		<div class='header'>" + g_js_strings.barbarian.mercenariesdispatched + "</div>");
            a.push("		<div class='mercenaries'></div>");
            a.push("		<div class='panel-button'>");
            a.push("			<div class='label'>" + g_js_strings.barbarian.helpmore + "</div>");
            a.push('			<a class="button25" onclick="BarbarianRaid.chooseCity(1); return false;"><span>' + g_js_strings.barbarian.sendtroops + "</span></a>");
            a.push('			<a class="button25" onclick="BarbarianRaid.chooseCity(2); return false;"><span>' + g_js_strings.barbarian.hiremercenaries + "</span></a>");
            a.push("		</div>")
        } else {
            if (this.helpStatus == 2) {
                a.push("		<div class='header'>" + g_js_strings.barbarian.mercenariesdispatched + "</div>");
                a.push("		<div class='mercenaries'></div>");
                a.push("		<div class='panel-button'>");
                a.push("			<div class='label'>" + g_js_strings.barbarian.helpmore + "</div>");
                a.push('			<a class="button25" onclick="BarbarianRaid.chooseCity(2); return false;"><span>' + g_js_strings.barbarian.hiremercenaries + "</span></a>");
                a.push("		</div>")
            } else {
                if (this.helpStatus == 3) {
                    a.push("		<div class='header'>" + g_js_strings.barbarian.mercenariesdispatched + "</div>");
                    a.push("		<div class='mercenaries'></div>");
                    a.push("		<div class='panel-button'>");
                    a.push("			<div class='label'>" + g_js_strings.barbarian.helpmore + "</div>");
                    a.push('			<a class="button25" href="' + this.appUrl + "?in=" + this.requestIn + '" target="_top"><span>' + g_js_strings.barbarian.sendtroops + "</span></a>");
                    a.push('			<a class="button25" href="' + this.appUrl + "?in=" + this.requestIn + '" target="_top"><span>' + g_js_strings.barbarian.hiremercenaries + "</span></a>");
                    a.push('			<a class="button25" href="' + this.appUrl + "?in=" + this.requestIn + '" target="_top"><span>' + g_js_strings.barbarian.defendmyself + "</span></a>");
                    a.push("		</div>")
                }
            }
        }
        a.push("</div>");
        Modal.showModal(500, 500, 0, 100, "", a.join(""))
    },
    callForHelp: function () {
        var a = new Array();
        a.push(["REPLACE_RaIdId", seed.barbarianRaid.barbarianRaidId]);
        common_postToProfile("119", Object.cloneFeed(template_data_119), Object.cloneFeed(actionlink_data_119), continuation_119, a)
    },
    peace: function () {
        var a = new Array();
        a.push("<div class='raids-peace'>");
        a.push("		<div class='header'>" + g_js_strings.barbarian.kingarthurbrokerspeace + "</div>");
        a.push("		<div class='desc'>" + g_js_strings.barbarian.kingarthurbrokerspeacedesc + "</div>");
        a.push("		<div class='panel-arthur'>");
        a.push("			<div class='content'>");
        a.push("				<div class='stat'>");
        a.push("					<div class='type'>" + g_js_strings.barbarian.attacksrepelled + "</div>");
        a.push("					<div class='value'>" + addCommas(seed.barbarianStats.totalAttacksRepelled) + "</div>");
        a.push("				</div>");
        a.push("				<div class='stat'>");
        a.push("					<div class='type'>" + g_js_strings.barbarian.attacksyourepelled + "</div>");
        a.push("					<div class='value'>" + addCommas(seed.barbarianStats.playerAttacksRepelled) + "</div>");
        a.push("				</div>");
        a.push("				<div class='stat'>");
        a.push("					<div class='type'>" + g_js_strings.barbarian.attacksalliancerepelled + "</div>");
        a.push("					<div class='value'>" + addCommas(seed.barbarianStats.allianceAttacksRepelled) + "</div>");
        a.push("				</div>");
        a.push("				<div class='stat'>");
        a.push("					<div class='type'>" + g_js_strings.barbarian.attacksyouhelpedrepel + "</div>");
        a.push("					<div class='value'>" + addCommas(seed.barbarianStats.playerAssistanceAttacksRepelled) + "</div>");
        a.push("				</div>");
        a.push("			</div>");
        a.push("		</div>");
        a.push("		<div class='shake-hand'></div>");
        a.push("</div>");
        Modal.showModal(740, 500, 0, 0, "", a.join(""))
    },
    report: function () {
        var html = new Array();
        var params = Object.clone(g_ajaxparams);
        new Ajax.Request(g_ajaxpath + "ajax/barbarianFriendReport.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    html.push("<div class='raids-report'>");
                    html.push("	<div class='info'>");
                    html.push("		<div class='header'>" + g_js_strings.barbarian.invasionreport + "</div>");
                    html.push("		<div class='desc'>" + g_js_strings.barbarian.invasionreportdesc + "<div class='note'><strong>" + g_js_strings.commonstr.note + ":</strong> " + g_js_strings.barbarian.troopscapped + "</div></div>");
                    html.push("	</div>");
                    var percentProgress = parseInt(seed.barbarianEvent.pct);
                    var widthProgress;
                    var hidePercent = "";
                    if (percentProgress == 0) {
                        widthProgress = 0;
                        hidePercent = " style='display: none;'"
                    } else {
                        widthProgress = parseInt(Math.floor((408 * percentProgress) / 100))
                    }
                    if (widthProgress > 0) {
                        widthProgress = Math.max(widthProgress, 26)
                    }
                    html.push("	<div class='progress'>");
                    html.push("		<span class='label-attack'>" + g_js_strings.barbarian.numofattacks.replace("%1$s", addCommas(seed.barbarianEvent.totalAttacks)) + "</span>");
                    html.push("		<div class='bar' style='width: " + widthProgress + "px'><span class='percent'" + hidePercent + ">" + percentProgress + "%</span></div>");
                    html.push("		<div class='header-progress'>" + g_js_strings.barbarian.barbarianprogress + "</div>");
                    html.push("	</div>");
                    html.push("	<div class='panel-stat'>");
                    html.push("		<div class='content'>");
                    if (parseInt(rslt.allFriends.barb_prot_time) > 0) {
                        html.push("			<div class='safe'>" + g_js_strings.barbarian.youwereattackedrecently + "<br/><span>" + g_js_strings.barbarian.safeforatleast + " " + timestr(parseInt(rslt.allFriends.barb_prot_time)) + "</span></div>")
                    } else {
                        if (BarbarianRaid.isUnderAttack()) {
                            if (parseInt(seed.barbarianRaid.raidStatus) == 1 || parseInt(seed.barbarianRaid.raidStatus) == 2) {
                                html.push("			<a class='button-defend' onclick='Modal.hideModalAll(); BarbarianRaid.underAttack(); return false;'>" + g_js_strings.barbarian.youareunderattack + "<br/><span>" + g_js_strings.barbarian.clickheretodefend + "</span></a>")
                            }
                        } else {
                            html.push("			<div class='empty'>&nbsp;</div>")
                        }
                    }
                    html.push("			<div class='header-under-attack'>" + g_js_strings.barbarian.alliesunderattack + " (<span>" + rslt.allFriends.allies.length + "</span>)</div>");
                    html.push("			<div class='list'>");
                    for (var i = 0; i < rslt.allFriends.allies.length; i++) {
                        html.push("				<div class='player'><span class='name'>" + rslt.allFriends.allies[i].displayName + "</span>");
                        if (!rslt.allFriends.allies[i].assisted) {
                            html.push("				<a class='button25' onclick='BarbarianRaid.assist(" + rslt.allFriends.allies[i].barbarianRaidId + "," + rslt.allFriends.allies[i].cityId + ");return false;'><span>" + g_js_strings.commonstr.assist + "</span></a>")
                        } else {
                            html.push("				<a class='buttonDown25' onclick='Modal.hideModalAll(); BarbarianRaid.showStatus(" + rslt.allFriends.allies[i].cityId + "); return false;'><span>" + g_js_strings.commonstr.status + "</span></a>")
                        }
                        html.push("				</div>")
                    }
                    html.push("			</div>");
                    html.push("			<div class='header-under-attack'>" + g_js_strings.barbarian.friendsunderattack + " (<span>" + rslt.allFriends.friends.length + "</span>)</div>");
                    html.push("			<div class='list'>");
                    for (var i = 0; i < rslt.allFriends.friends.length; i++) {
                        html.push("				<div class='player'><span class='name'>" + rslt.allFriends.friends[i].displayName + "</span>");
                        if (!rslt.allFriends.friends[i].assisted) {
                            html.push("				<a class='button25' onclick='BarbarianRaid.assist(" + rslt.allFriends.friends[i].barbarianRaidId + "," + rslt.allFriends.friends[i].cityId + ");return false;'><span>" + g_js_strings.commonstr.assist + "</span></a>")
                        } else {
                            html.push("				<a class='buttonDown25' onclick='Modal.hideModalAll(); BarbarianRaid.showStatus(" + rslt.allFriends.friends[i].cityId + "); return false;'><span>" + g_js_strings.commonstr.status + "</span></a>")
                        }
                        html.push("				</div>")
                    }
                    html.push("			</div>");
                    html.push("		</div>");
                    html.push("	</div>");
                    html.push("</div>");
                    Modal.showModal(740, 400, 0, 0, "", html.join(""))
                } else {
                    Modal.showAlert(g_js_strings.barbarian.cannotgetalliesfriends, false, 100)
                }
            },
            onFailure: function () {
                Modal.showAlert(g_js_strings.barbarian.cannotgetalliesfriends, false, 100)
            }
        })
    },
    chooseCity: function (a) {
        var e = "";
        var f = "";
        var d = new Array();
        if (a == 1) {
            e = g_js_strings.barbarian.troopfromcity;
            f = "<select id='raids_help_choosecity' onchange='BarbarianRaid.sendTroopFromCity(this.options[this.selectedIndex].value)'>"
        } else {
            e = g_js_strings.barbarian.goldfromcity;
            f = "<select id='raids_help_choosecity' onchange='BarbarianRaid.sendMercenariesFromCity(this.options[this.selectedIndex].value)'>"
        }
        d.push("<div class='raids-choosecity'>");
        d.push("<div class='header'>" + e + "</div>");
        d.push("<div class='select-city'>");
        d.push(f);
        d.push("<option value='0'>-- " + g_js_strings.barbarian.selectacity + " --</option>");
        if (this.isSameServer) {
            var h = Object.keys(this.worldCities);
            for (var c = 0; c < h.length; c++) {
                d.push("<option value='" + this.worldCities[h[c]].cityId + "," + this.worldCities[h[c]].serverId + "'>" + this.worldCities[h[c]].cityName + " on " + this.worldCities[h[c]].serverName + "</option>")
            }
            if (a == 2) {
                var g = Object.keys(this.playerCities);
                for (var c = 0; c < g.length; c++) {
                    if (g[c] != this.destServerID) {
                        var h = Object.keys(this.playerCities[g[c]]);
                        for (var b = 0; b < h.length; b++) {
                            d.push("<option value='" + this.playerCities[g[c]][h[b]].cityId + "," + g[c] + "'>" + this.playerCities[g[c]][h[b]].cityName + " on " + this.playerCities[g[c]][h[b]].serverName + "</option>")
                        }
                    }
                }
            }
        } else {
            if (this.isDiffServer) {
                var g = Object.keys(this.playerCities);
                for (var c = 0; c < g.length; c++) {
                    if (g[c] != this.destServerID) {
                        var h = Object.keys(this.playerCities[g[c]]);
                        for (var b = 0; b < h.length; b++) {
                            d.push("<option value='" + this.playerCities[g[c]][h[b]].cityId + "," + this.playerCities[g[c]][h[b]].serverId + "'>" + this.playerCities[g[c]][h[b]].cityName + " : " + this.playerCities[g[c]][h[b]].serverName + "</option>")
                        }
                    }
                }
            }
        }
        d.push("</select>");
        d.push("</div>");
        d.push("<div class='button-back'><a class='buttonDown25' onclick='Modal.hideModal(); return false;'><span>" + g_js_strings.commonstr.back + "</span></a></div>");
        d.push("</div>");
        Modal.showModal(400, 500, 0, 200, "", d.join(""))
    },
    assistTroopFromCity: function (b) {
        var d = new Array();
        var a = b.split(",");
        var g = a[0];
        d.push("<div class='raids-sendtroopfromcity clearfix'>");
        d.push("		<div class='header'>" + g_js_strings.barbarian.selecttroops + "</div>");
        d.push("		<div class='note'>" + g_js_strings.barbarian.cannotexceed + "</div>");
        d.push("		<div class='note'>" + g_js_strings.barbarian.totaltroopsbeingdeployed + " <span id='raids_sendtroop_total'>0</span></div>");
        var f = Object.keys(unitcost);
        for (var c = 0; c < f.length; c++) {
            var e = f[c].split("unt")[1];
            d.push("<div class='unit clearfix' name='" + e + "'>");
            d.push("		<img src='");
            if (this.stimgUrl) {
                d.push(this.stimgUrl)
            } else {
                d.push(stimgUrl)
            }
            d.push("img/units/unit_" + e + "_50_s34.jpg'/>");
            d.push("		<div class='unitinfo'>");
            d.push("				<div class='unitname'>");
            d.push("					" + unitcost[f[c]][0]);
            d.push("				</div>");
            d.push("				<div class='unitnum'>");
            d.push("					" + addCommas(seed.units["city" + g]["unt" + e]));
            d.push("				</div>");
            d.push("				<div class='clearfix numbox'>");
            d.push("					<input type='hidden' id='raids_sendtroop_currentamount" + e + "' value='" + seed.units["city" + g]["unt" + e] + "'/>");
            d.push("					<input type='text' id='raids_sendtroop_input" + e + "' value='0' name='" + f[c].split("unt")[1] + "' onkeyup='BarbarianRaid.sendTroopValidate(" + e + "); BarbarianRaid.sendTroopCap(" + e + ")'/>");
            d.push("					<a  class='button14' onclick='BarbarianRaid.sendTroopMax(" + e + ");return false;'><span>" + g_js_strings.commonstr.all + "</span></a>");
            d.push("				</div>");
            d.push("		</div>");
            d.push("</div>")
        }
        d.push("		<div class='note'><span>" + g_js_strings.commonstr.note + ":</span> " + g_js_strings.barbarian.troopscapped + "</div>");
        d.push("		<div class='buttons clearfix'>");
        d.push("			<a class='button25' onclick='BarbarianRaid.assistSubmit(5," + b + "); return false;'><span>" + g_js_strings.commonstr.march + "</span></a>");
        d.push("			<a class='button25' onclick='Modal.hideModal(); return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a>");
        d.push("		</div>");
        d.push("</div>");
        Modal.showModal(500, 500, 0, 0, "", d.join(""));
        $("raids_help_choosecity").selectedIndex = 0
    },
    sendTroopFromCity: function (b) {
        var d = new Array();
        var a = b.split(",");
        var g = a[0];
        d.push("<div class='raids-sendtroopfromcity clearfix'>");
        d.push("		<div class='header'>" + g_js_strings.barbarian.selecttroops + "</div>");
        d.push("		<div class='note'>" + g_js_strings.barbarian.cannotexceed + "</div>");
        d.push("		<div class='note'>" + g_js_strings.barbarian.totaltroopsbeingdeployed + " <span id='raids_sendtroop_total'>0</span></div>");
        var f = Object.keys(unitcost);
        for (var c = 0; c < f.length; c++) {
            var e = f[c].split("unt")[1];
            d.push("<div class='unit clearfix' name='" + e + "'>");
            d.push("		<img src='");
            if (this.stimgUrl) {
                d.push(this.stimgUrl)
            } else {
                d.push(stimgUrl)
            }
            d.push("img/units/unit_" + e + "_50_s34.jpg'/>");
            d.push("		<div class='unitinfo'>");
            d.push("				<div class='unitname'>");
            d.push("					" + unitcost[f[c]][0]);
            d.push("				</div>");
            d.push("				<div class='unitnum'>");
            d.push("					" + addCommas(this.worldCities[g]["unit" + e + "Count"]));
            d.push("				</div>");
            d.push("				<div class='clearfix numbox'>");
            d.push("					<input type='hidden' id='raids_sendtroop_currentamount" + e + "' value='" + this.worldCities[g]["unit" + e + "Count"] + "'/>");
            d.push("					<input type='text' id='raids_sendtroop_input" + e + "' value='0' name='" + f[c].split("unt")[1] + "' onkeyup='BarbarianRaid.sendTroopValidate(" + e + "); BarbarianRaid.sendTroopCap(" + e + ")'/>");
            d.push("					<a  class='button14' onclick='BarbarianRaid.sendTroopMax(" + e + ");return false;'><span>" + g_js_strings.commonstr.all + "</span></a>");
            d.push("				</div>");
            d.push("		</div>");
            d.push("</div>")
        }
        d.push("		<div class='note'><span>" + g_js_strings.commonstr.note + ":</span> " + g_js_strings.barbarian.troopscapped + "</div>");
        d.push("		<div class='buttons clearfix'>");
        d.push("			<a class='button25' onclick='BarbarianRaid.helpSubmit(5," + b + "); return false;'><span>" + g_js_strings.commonstr.march + "</span></a>");
        d.push("			<a class='button25' onclick='Modal.hideModal(); return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a>");
        d.push("		</div>");
        d.push("</div>");
        Modal.showModal(500, 500, 0, 0, "", d.join(""));
        $("raids_help_choosecity").selectedIndex = 0
    },
    sendTroopCap: function (c) {
        BarbarianRaid.sendTroopValidate(c);
        var a = parseInt($("raids_sendtroop_input" + c).value, 10);
        var d = BarbarianRaid.sendTroopSum(c) - a;
        var b = parseInt($("raids_sendtroop_currentamount" + c).value, 10);
        if (d > this.MAX_TROOPS_ALLOWED) {
            $("raids_sendtroop_input" + c).value = "0"
        } else {
            if (d + a > this.MAX_TROOPS_ALLOWED) {
                $("raids_sendtroop_input" + c).value = Math.min(this.MAX_TROOPS_ALLOWED - d, a, b)
            } else {
                $("raids_sendtroop_input" + c).value = a
            }
        }
        $("raids_sendtroop_total").innerHTML = addCommas(BarbarianRaid.sendTroopSum())
    },
    sendTroopMax: function (a) {
        $("raids_sendtroop_input" + a).value = parseInt($("raids_sendtroop_currentamount" + a).value, 10);
        BarbarianRaid.sendTroopCap(a)
    },
    sendTroopSum: function (c) {
        var b = 0;
        var e = Object.keys(unitcost);
        for (var a = 0; a < e.length; a++) {
            var d = e[a].split("unt")[1];
            if (isNaN($("raids_sendtroop_input" + d).value)) {
                $("raids_sendtroop_input" + d).value = "0"
            } else {
                BarbarianRaid.sendTroopValidate(d);
                $("raids_sendtroop_input" + d).value = parseInt($("raids_sendtroop_input" + d).value, 10);
                b += parseInt($("raids_sendtroop_input" + d).value, 10)
            }
        }
        return b
    },
    sendTroopValidate: function (c) {
        var a = 0;
        var b = parseInt($("raids_sendtroop_currentamount" + c).value, 10);
        if (isNaN($("raids_sendtroop_input" + c).value) || $("raids_sendtroop_input" + c).value == "") {
            $("raids_sendtroop_input" + c).value = "0"
        } else {
            a = parseInt($("raids_sendtroop_input" + c).value, 10);
            $("raids_sendtroop_input" + c).value = a
        }
        if (a < 0) {
            $("raids_sendtroop_input" + c).value = "0"
        } else {
            if (a > b) {
                $("raids_sendtroop_input" + c).value = b
            }
        }
    },
    assistSubmit: function (helptype, cityid, serverid) {
        var params = Object.clone(g_ajaxparams);
        var msg = "";
        helptype = parseInt(helptype);
        params.raidId = BarbarianRaid.raidID;
        params.tid = helptype;
        params.fcid = parseInt(cityid);
        params.fs = parseInt(serverid);
        if (helptype == 5) {
            if (BarbarianRaid.sendTroopSum() < 1) {
                Modal.showAlert(g_js_strings.barbarian.mustsendatleast, false, 100);
                return false
            }
        }
        if (helptype >= 2 && helptype <= 4) {
            var gold = parseInt(seed.citystats["city" + cityid].gold[0]);
            if (gold < this.mercenaryGold[helptype - 2]) {
                Modal.showAlert(g_js_strings.barbarian.notenoughgold, false, 100);
                return false
            }
        }
        if (helptype == 5) {
            var unitkeys = Object.keys(unitcost);
            var unitsjson = new Array();
            for (var i = 0; i < unitkeys.length; i++) {
                var untid = unitkeys[i].split("unt")[1];
                unitsjson.push('"unit' + untid + 'Count":' + $("raids_sendtroop_input" + untid).value);
                seed.units["city" + cityid]["unt" + untid] = parseInt(seed.units["city" + cityid]["unt" + untid]) - parseInt($("raids_sendtroop_input" + untid).value)
            }
            params.units = "{" + unitsjson + "}";
            msg = g_js_strings.barbarian.havesenttroops
        } else {
            if (helptype >= 2 && helptype <= 4) {
                msg = g_js_strings.barbarian.havesentmercenaries
            }
        }
        new Ajax.Request(g_ajaxpath + "ajax/barbarianRaidReinforceCity.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var result = eval("(" + transport.responseText + ")");
                if (result.ok) {
                    Modal.hideModalAll();
                    Modal.showAlert(msg, false, 150)
                } else {
                    Modal.showAlert(g_js_strings.barbarian.errorcode.replace("%1$s", result.error_code), false, 100)
                }
            },
            onFailure: function () {}
        })
    },
    helpSubmit: function (helptype, cityid, serverid) {
        var params = Object.clone(g_ajaxparams);
        var msg = "";
        helptype = parseInt(helptype);
        params.raidId = BarbarianRaid.raidID;
        params.tid = helptype;
        params.fcid = parseInt(cityid);
        params.fs = parseInt(serverid);
        if (helptype >= 2 && helptype <= 4) {
            var gold;
            if (this.helpers) {
                gold = parseInt(this.playerCities[serverid][cityid].gold)
            } else {
                gold = parseInt(seed.citystats["city" + cityid].gold[0])
            }
            if (gold < this.mercenaryGold[helptype - 2]) {
                Modal.showAlert(g_js_strings.barbarian.notenoughgold, false, 100);
                return false
            }
        }
        if (helptype == 5) {
            if (BarbarianRaid.sendTroopSum() < 1) {
                Modal.showAlert(g_js_strings.barbarian.mustsendatleast, false, 100);
                return false
            }
        }
        if (helptype == 5) {
            var unitkeys = Object.keys(unitcost);
            var unitsjson = new Array();
            for (var i = 0; i < unitkeys.length; i++) {
                var untid = unitkeys[i].split("unt")[1];
                unitsjson.push('"unit' + untid + 'Count":' + $("raids_sendtroop_input" + untid).value)
            }
            params.units = "{" + unitsjson + "}";
            msg = g_js_strings.barbarian.havesenttroops
        } else {
            if (helptype >= 2 && helptype <= 4) {
                msg = g_js_strings.barbarian.havesentmercenaries
            }
        }
        new Ajax.Request(g_ajaxpath + "ajax/barbarianRaidReinforceCity.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var result = eval("(" + transport.responseText + ")");
                if (result.ok) {
                    Modal.hideModalAll();
                    Modal.showAlert(msg, '<a class="button25" href="' + BarbarianRaid.appUrl + "?in=" + BarbarianRaid.requestIn + '" target="_top"><span>' + g_js_strings.barbarian.backtogame + "</span></a>", 150);
                    $("modalControlsClose" + Modal.modalid).hide()
                } else {
                    Modal.showAlert(g_js_strings.barbarian.errorcode.replace("%1$s", result.error_code), false, 100)
                }
            },
            onFailure: function () {}
        })
    },
    sendMercenariesFromCity: function (c) {
        var d = new Array();
        var b;
        if (this.stimgUrl) {
            b = this.stimgUrl
        } else {
            b = stimgUrl
        }
        var a = b + "img/chrome_icon_gold.png";
        d.push("<div class='raids-mercenaries'>");
        d.push("		<div class='header'>" + g_js_strings.barbarian.whatlevelofmercenaries + "</div>");
        d.push("		<div class='mercenaries'></div>");
        d.push("		<div class='level clearfix'>");
        d.push("			<div class='title clearfix'>" + g_js_strings.barbarian.lightmercenaries + "</div>");
        d.push("			<div class='desc'>" + g_js_strings.barbarian.lightmercenariesdesc + "</div>");
        d.push("			<div class='button-send clearfix'><a class='button25' onclick='BarbarianRaid.helpSubmit(2," + c + "); return false;'><span>" + g_js_strings.commonstr.send + "</span></a></div>");
        d.push("			<div class='price clearfix'>1,000g <img src='" + a + "' align='absmiddle'></div>");
        d.push("			<div class='title clearfix'>" + g_js_strings.barbarian.mediummercenaries + "</div>");
        d.push("			<div class='desc'>" + g_js_strings.barbarian.mediummercenariesdesc + "</div>");
        d.push("			<div class='button-send clearfix'><a class='button25' onclick='BarbarianRaid.helpSubmit(3," + c + "); return false;'><span>" + g_js_strings.commonstr.send + "</span></a></div>");
        d.push("			<div class='price clearfix'>10,000g <img src='" + a + "' align='absmiddle'></div>");
        d.push("			<div class='title clearfix'>" + g_js_strings.barbarian.heavymercenaries + "</div>");
        d.push("			<div class='desc'>" + g_js_strings.barbarian.heavymercenariesdesc + "</div>");
        d.push("			<div class='button-send clearfix'><a class='button25' onclick='BarbarianRaid.helpSubmit(4," + c + "); return false;'><span>" + g_js_strings.commonstr.send + "</span></a></div>");
        d.push("			<div class='price clearfix'>100,000g <img src='" + a + "' align='absmiddle'></div>");
        d.push("		</div>");
        d.push("		<div class='button-back'><a class='buttonDown25' onclick='Modal.hideModal(); return false;'><span>" + g_js_strings.commonstr.back + "</span></a></div>");
        d.push("</div>");
        Modal.showModal(500, 500, 0, 0, "", d.join(""));
        $("raids_help_choosecity").selectedIndex = 0
    },
    viewMarchReport: function (rptid, side, tiletype, tilelv, defid, defnm, defgen, atknm, atkgen, marchtype, xcoord, ycoord, timestamp, unread, atkxcoord, atkycoord) {
        var params = Object.clone(g_ajaxparams);
        var args = arguments;
        params.rid = rptid;
        params.side = side;
        $("modal_msg_list_pagination").hide();
        new Ajax.Request(g_ajaxpath + "ajax/fetchReport.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (unread == 1) {
                    seed.newReportCount = parseInt(seed.newReportCount) - 1;
                    messages_notify_bug()
                }
                $("modal_msg_list").innerHTML = MarchReport.getMarchReport(args, rslt).render()
            },
            onFailure: function () {}
        })
    },
    timestr: function timestr(e, d) {
        var f = "";
        if (e < 61) {
            if (d == 1) {
                f = e + g_js_strings.timestr.timesec
            } else {
                f = e + g_js_strings.timestr.times
            }
        } else {
            if (e < 3601) {
                var b = parseInt(e / 60);
                e = e - (60 * b);
                if (d == 1) {
                    f = b + g_js_strings.timestr.timemin + " " + e + g_js_strings.timestr.timesec
                } else {
                    f = b + g_js_strings.timestr.timem + " " + e + g_js_strings.timestr.times
                }
            } else {
                if (e < 86401) {
                    var c = parseInt(e / 3600);
                    var b = parseInt((e - (c * 3600)) / 60);
                    if (d == 1) {
                        f = c + g_js_strings.timestr.timehr + " " + b + g_js_strings.timestr.timemin
                    } else {
                        f = c + g_js_strings.timestr.timeh + " " + b + g_js_strings.timestr.timem
                    }
                } else {
                    var a = parseInt(e / 86400);
                    var c = parseInt((e - (a * 86400)) / 3600);
                    var b = parseInt((e - (c * 3600) - (a * 86400)) / 60);
                    if (d == 1) {
                        f = a + g_js_strings.timestr.timeday + " " + c + g_js_strings.timestr.timehr + " " + b + g_js_strings.timestr.timemin
                    } else {
                        f = a + g_js_strings.timestr.timed + " " + c + g_js_strings.timestr.timeh + " " + b + g_js_strings.timestr.timem
                    }
                }
            }
        }
        return f
    },
    unixtime: function () {
        return parseInt((new Date()).getTime() / 1000)
    }
};
Object.extend(BarbarianRaid, BarbarianRaid.Methods);
Object.extend(BarbarianRaid, BarbarianRaid.Properties);
var cm = cm || {};
cm.BarracksUnitsTypeMap = (function () {
    var e = {
        infantry: 0,
        ranged: 1,
        horsed: 2,
        siege: 3
    };
    var a = {};
    var c = {};
    var b = function (g) {
            try {
                return a[e[cm.unitFrontendType[g]]]
            } catch (f) {}
            return ""
        };
    var d = function () {
            a[e.infantry] = g_js_strings.modal_barracks_trainingtab.unittypeinfantry;
            a[e.ranged] = g_js_strings.modal_barracks_trainingtab.unittyperanged;
            a[e.horsed] = g_js_strings.modal_barracks_trainingtab.unittypehorsed;
            a[e.siege] = g_js_strings.modal_barracks_trainingtab.unittypesiege
        };
    d();
    return {
        getTypeString: b
    }
})();

function modal_openBarracks() {
    var a = new Array();
    a.push("<div class='tabsbar clearfix' id='barracksModalTabs'>");
    a.push("<a class='tab selected' onclick='changeBarracksModalTabs(0);return false;'><span>");
    a.push(g_js_strings.modal_openBarracks.trainttl);
    a.push("</span></a>");
    a.push("<a class='tab' onclick='changeBarracksModalTabs(1);return false;'><span>");
    a.push(g_js_strings.modal_openBarracks.trainingttl);
    a.push("</span></a>");
    a.push("</div>");
    a.push("<div id='barracks_0' class='tablewrap barrackswrap'>");
    a.push("<div class='unitlist clearfix'>");
    var e = Object.keys(unitcost);
    for (var c = 0; c < e.length; c++) {
        var d = e[c].split("unt")[1];
        a.push("<div class='unit'>");
        a.push("<img src='");
        a.push(stimgUrl);
        a.push("img/units/unit_");
        a.push(d);
        a.push("_68_s34.jpg?6545'/>");
        a.push("<div class='unitinfo'>");
        a.push("<div class='unitnm'>");
        a.push(unitcost[e[c]][0]);
        a.push("</div>");
        a.push("<div class='unitdesc'>");
        a.push(unitcost[e[c]][10]);
        a.push("</div>");
        a.push("<div class='unitcount'><b>");
        a.push(g_js_strings.modal_openBarracks.youown);
        a.push(":</b> ");
        a.push(seed.units["city" + currentcityid]["unt" + d]);
        a.push("</div>");
        a.push("<div class='clearfix btn'><a  class='button20' onclick='modal_barracks_train(");
        a.push(d);
        a.push(");return false;'><span>" + g_js_strings.commonstr.train + "</span></a><a  class='buttonDown20' onclick='modal_barracks_dismiss(");
        a.push(d);
        a.push(");return false;'><span>");
        a.push(g_js_strings.commonstr.dismiss);
        a.push("</span></a></div>");
        a.push("</div>");
        a.push("</div>")
    }
    a.push("</div>");
    a.push("</div>");
    a.push("<div id='barracks_1' style='display:none;' class='barrackswrap'>");
    a.push("<div class='trainboxwrap'>");
    a.push("<div class='trainbox'>");
    a.push("<div class='trainhd'><span>");
    a.push(g_js_strings.modal_openBarracks.curintrain);
    a.push("</span></div><div id='modal_currentlytraining'>");
    a.push("</div>");
    a.push("</div>");
    a.push("<div class='trainbox'>");
    a.push("<div class='trainhd'><span>");
    a.push(g_js_strings.modal_openBarracks.waittrain);
    a.push("</span></div>");
    a.push("<div id='modal_trainingqueue'>");
    a.push("</div>");
    a.push("</div>");
    a.push("</div>");
    a.push("</div>");
    var b = $("modal_build_content");
    if (b) {
        b.innerHTML = a.join("")
    }
}

function modal_barracks_dismiss(b) {
    var a = new Array();
    a.push("<div id='barracks_dismiss' class='clearfix'><div class='unitinfo clearfix'>");
    a.push("<img src='");
    a.push(stimgUrl);
    a.push("img/units/unit_");
    a.push(b);
    a.push("_50_s34.jpg'/>");
    a.push("<div class='nm'>" + unitcost["unt" + b][0] + "</div>");
    a.push("<div class='count'>" + addCommas(parseInt(seed.units["city" + currentcityid]["unt" + b])) + "</div>");
    a.push("</div>");
    a.push("<div class='unit_ipt clearfix'><input type='text' id='barracks_dismiss_ipt' onkeyup='modal_barracks_dismiss_keyup(");
    a.push(seed.units["city" + currentcityid]["unt" + b]);
    a.push(");'/><a  class='button20' onclick='modal_barracks_dismiss_max(");
    a.push(seed.units["city" + currentcityid]["unt" + b]);
    a.push(");return false;'><span>" + g_js_strings.commonstr.max + "</span></a></div>");
    a.push("<div class='unit_btns clearfix'><a  class='button20' onclick='modal_barracks_dismiss_confirm(");
    a.push(b);
    a.push(");return false;'><span>" + g_js_strings.commonstr.dismiss + "</span></a><a  onclick='Modal.hideModal();return false;' class='cancel'>" + g_js_strings.commonstr.cancel + "</a>");
    a.push("</div>");
    a.push("</div>");
    Modal.showModal(500, 400, 120, 20, g_js_strings.modal_barracks_dismiss.dismisstroops + " - " + unitcost["unt" + b][0], a.join(""))
}

function modal_barracks_dismiss_confirm(b) {
    var a = new Array();
    a.push("<div id='barracks_dismiss' class='clearfix'>");
    a.push("<div class='cfrmhd'>");
    a.push(g_js_strings.modal_barracks_dismiss_confirm.areyousure);
    a.push(" ");
    a.push(addCommas(parseInt($("barracks_dismiss_ipt").value)));
    a.push(" ");
    a.push(unitcost["unt" + b][0]);
    a.push("</div>");
    a.push("<div class='unit_btns clearfix'><a  class='button20' onclick='modal_barracks_dismiss_do(");
    a.push(b);
    a.push(");return false;'><span>");
    a.push(g_js_strings.commonstr.ok);
    a.push("</span></a><a  onclick='Modal.hideModal();return false;' class='cancel'>");
    a.push(g_js_strings.commonstr.cancel);
    a.push("</a>");
    a.push("</div>");
    a.push("</div>");
    Modal.showModal(500, 400, 120, 20, g_js_strings.modal_barracks_dismiss_confirm.confirmttl, a.join(""))
}

function modal_barracks_dismiss_do(unitid) {
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    params.type = unitid;
    params.quant = $("barracks_dismiss_ipt").value;
    new Ajax.Request(g_ajaxpath + "ajax/dismissUnits.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                seed.units["city" + currentcityid]["unt" + unitid] = parseInt(seed.units["city" + currentcityid]["unt" + unitid]) - parseInt($("barracks_dismiss_ipt").value);
                Modal.hideModalAll()
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function modal_barracks_dismiss_keyup(a) {
    if (!(parseInt(a) > parseInt($("barracks_dismiss_ipt").value)) && $("barracks_dismiss_ipt").value != "") {
        $("barracks_dismiss_ipt").value = a
    }
}

function modal_barracks_dismiss_max(a) {
    $("barracks_dismiss_ipt").value = a
}

function modal_barracks_train(b) {
    cm.sounds.play("modal_barracks_train_" + b);
    var a = createRequirementRows(b),
        c = unitcost["unt" + b][0],
        d;
    if (cm.WorldSettings.hasKeyValuePair("TROOP_GAMBLE", "ON")) {
        createGambleContainer(b)
    } else {
        createTutelageContainer(b)
    }
}

function createTutelageContainer(b) {
    var a = [36, 37, 38],
        g = ["modal_barracks_tutred", "modal_barracks_arthurs_tutred", "modal_barracks_merlins_tutred"],
        p = ["modal_barracks_tut", "modal_barracks_arthurs_tut", "modal_barracks_merlins_tut"],
        m, d = [],
        l, n = "";
    for (var c = 0, f = a.length; c < f; ++c) {
        if (ksoItems[a[c]].count <= 0) {
            n = "DISABLED"
        } else {
            n = ""
        }
        l = stimgUrl + "img/items/70/" + a[c] + ".jpg";
        m = cm.Template.renderTemplate("Barracks", "unit_training_boost", {
            index: c + 1,
            inputId: p[c],
            imgSource: l,
            name: ksoItems[a[c]].name,
            timeLabel: g_js_strings.modal_barracks_train.timereduction,
            timeId: g[c],
            secLabel: g_js_strings.timestr.timesec,
            youOwnLabel: g_js_strings.commonstr.youown,
            youOwnValue: ksoItems[a[c]].count,
            isDisabled: n,
            getMoreLabel: g_js_strings.commonstr.getmore
        });
        d.push(m)
    }
    d = "<div id='tutelageContainer'>" + d.join("") + "</div>";
    var j = createRequirementRows(b),
        k = unitcost["unt" + b][0],
        e;
    var h;
    var o = checkreq("unt", b, 1);
    for (var c = 0, f = o[0].length; c < f; ++c) {
        if (o[3][c] == 0) {
            h = true;
            break
        } else {
            h = false
        }
    }
    if (h) {
        e = 0
    } else {
        e = (modal_barracks_train_max(b) > 0) ? modal_barracks_train_max(b) : 0
    }
    var m = cm.Template.renderTemplate("Barracks", "unit_training_modal", {
        unitId: b,
        unitImage: stimgUrl + "/img/units/unit_" + b + "_215_s34.jpg?6545",
        unitDescription: unitcost["unt" + b][10],
        attackLabel: g_js_strings.modal_barracks_train.attack,
        speedLabel: g_js_strings.modal_barracks_train.speed,
        defenseLabel: g_js_strings.modal_barracks_train.defense,
        rangeLabel: g_js_strings.modal_barracks_train.range,
        lifeLabel: g_js_strings.modal_barracks_train.life,
        loadLabel: g_js_strings.modal_barracks_train.load,
        upkeepLabel: g_js_strings.commonstr.upkeep,
        typeLabel: g_js_strings.commonstr.type,
        attackValue: unitstats["unt" + b][1],
        speedValue: unitstats["unt" + b][3],
        defenseValue: unitstats["unt" + b][2],
        rangeValue: unitstats["unt" + b][4],
        lifeValue: unitstats["unt" + b][0],
        loadValue: unitstats["unt" + b][5],
        upkeepValue: unitupkeeps[b],
        typeValue: cm.BarracksUnitsTypeMap.getTypeString(b),
        resourceHeader: g_js_strings.commonstr.resource,
        requiredHeader: g_js_strings.commonstr.required,
        youOwnHeader: g_js_strings.commonstr.youown,
        reqs: j,
        youOwnLabel: g_js_strings.commonstr.youown,
        maxLabel: g_js_strings.commonstr.max,
        youOwnValue: seed.units["city" + currentcityid]["unt" + b],
        maxValue: e,
        troopTrainLabel: g_js_strings.modal_barracks_train.numtotrain + ":",
        trainTimeLabel: g_js_strings.modal_barracks_train.traintime,
        misc: d,
        buttonLabel: g_js_strings.modal_barracks_train.starttraining
    });
    Modal.showModal(500, 400, 120, 20, k, m)
}
var gambleOptionResults1;
var gambleOptionResults2;

function createGambleContainer(unitid) {
    var params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/getTroopGambles.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            gambleOptionResults1 = [];
            var rslt = eval("(" + transport.responseText + ")"),
                min1 = rslt["1"].min,
                max1 = rslt["1"].max;
            cost1 = rslt["1"].cost, min2 = rslt["2"].min, max2 = rslt["2"].max;
            cost2 = rslt["2"].cost, range1 = min1 + "% - " + max1 + "%", label1 = g_js_strings.modal_barracks_train.gambleLabel.replace("%1$s", range1).replace("%2$s", cost1), range2 = min2 + "% - " + max2 + "%", label2 = g_js_strings.modal_barracks_train.gambleLabel.replace("%1$s", range2).replace("%2$s", cost2);
            gambleOptionResults1 = [min1, max1, cost1];
            gambleOptionResults2 = [min2, max2, cost2];
            var template1 = cm.Template.renderTemplate("Barracks", "unit_training_gamble", {
                unitId: unitid,
                label0: g_js_strings.modal_barracks_train.gambleLabel0,
                label1: label1,
                label2: label2
            });
            var reqsHtml = createRequirementRows(unitid),
                title = unitcost["unt" + unitid][0],
                maxValue;
            var unmet;
            var reqs = checkreq("unt", unitid, 1);
            for (var i = 0, len = reqs[0].length; i < len; ++i) {
                if (reqs[3][i] == 0) {
                    unmet = true;
                    break
                } else {
                    unmet = false
                }
            }
            if (unmet) {
                maxValue = 0
            } else {
                maxValue = (modal_barracks_train_max(unitid) > 0) ? modal_barracks_train_max(unitid) : 0
            }
            var template = cm.Template.renderTemplate("Barracks", "unit_training_modal", {
                unitId: unitid,
                unitImage: stimgUrl + "/img/units/unit_" + unitid + "_215_s34.jpg?6545",
                unitDescription: unitcost["unt" + unitid][10],
                attackLabel: g_js_strings.modal_barracks_train.attack,
                speedLabel: g_js_strings.modal_barracks_train.speed,
                defenseLabel: g_js_strings.modal_barracks_train.defense,
                rangeLabel: g_js_strings.modal_barracks_train.range,
                lifeLabel: g_js_strings.modal_barracks_train.life,
                loadLabel: g_js_strings.modal_barracks_train.load,
                upkeepLabel: g_js_strings.commonstr.upkeep,
                typeLabel: g_js_strings.commonstr.type,
                attackValue: unitstats["unt" + unitid][1],
                speedValue: unitstats["unt" + unitid][3],
                defenseValue: unitstats["unt" + unitid][2],
                rangeValue: unitstats["unt" + unitid][4],
                lifeValue: unitstats["unt" + unitid][0],
                loadValue: unitstats["unt" + unitid][5],
                upkeepValue: unitupkeeps[unitid],
                typeValue: cm.BarracksUnitsTypeMap.getTypeString(unitid),
                resourceHeader: g_js_strings.commonstr.resource,
                requiredHeader: g_js_strings.commonstr.required,
                youOwnHeader: g_js_strings.commonstr.youown,
                reqs: reqsHtml,
                youOwnLabel: g_js_strings.commonstr.youown,
                maxLabel: g_js_strings.commonstr.max,
                youOwnValue: seed.units["city" + currentcityid]["unt" + unitid],
                maxValue: maxValue,
                troopTrainLabel: g_js_strings.modal_barracks_train.numtotrain + ":",
                trainTimeLabel: g_js_strings.modal_barracks_train.traintime,
                misc: template1,
                buttonLabel: g_js_strings.modal_barracks_train.starttraining
            });
            Modal.showModal(500, 400, 120, 20, title, template)
        }
    })
}
var unmetreqs = false;

function createRequirementRows(e) {
    var d = [];
    var b = checkreq("unt", e, 1);
    for (var c = 0, a = b[0].length; c < a; ++c) {
        d.push("<tr>");
        d.push("<td class='res'>");
        d.push(b[0][c]);
        d.push("</td>");
        if (b[4][c] != null) {
            d.push("<td id='unitTrainModal" + b[4][c] + "Needed' class='req ")
        } else {
            d.push("<td class='req ")
        }
        if (b[3][c] == 0) {
            d.push("unmet");
            unmetreqs = true
        } else {
            d.push("met")
        }
        d.push("'>");
        d.push(addCommas(b[1][c]));
        d.push("</td>");
        d.push("<td class='own'>");
        d.push(addCommas(b[2][c]));
        d.push("</td>");
        d.push("</tr>")
    }
    return d.join("")
}

function modal_barracks_traintime(d, f) {
    var c = +(unitcost["unt" + d][7]) * f,
        e, k = {},
        h = seed.buildings["city" + currentcityid],
        j = {},
        l = seed.knights["city" + currentcityid],
        a, g = seed.leaders["city" + currentcityid];
    k.barracks = 0;
    k.workshop = 0;
    k.stable = 0;
    k.tech = 0;
    k.knight = 0;
    k.ultimate = 0;
    jQuery.each(h, function (n, m) {
        m.id = +(m[0]);
        m.level = +(m[1]);
        if (m.id === 13 && m.level > 0) {
            k.barracks += (m.level + 9)
        }
        if (m.id === 16 && m.level > 0) {
            if (+(d) >= 9) {
                k.workshop = m.level
            }
        }
        if (m.id === 17 && m.level > k.stable) {
            if (+(d) >= 7) {
                k.stable = m.level
            }
        }
    });
    e = k.barracks / 10;
    c = Math.max(1, Math.ceil(c / e));
    e = 1;
    if (l) {
        a = l["knt" + g.combatKnightId];
        if (a) {
            k.knight = (+(a.combatBoostExpireUnixtime) - unixtime() > 0) ? (a.combat * 1.25) : a.combat
        } else {
            k.knight = 0
        }
    }
    if (seed.tech) {
        k.tech = seed.tech.tch5
    }
    k.ultimate = k.workshop + k.stable + k.tech;
    e = e * (1 + (0.1 * k.ultimate) + (0.005 * k.knight));
    var i = cm.ThroneController.effectBonus(77);
    e = e * (1 + (i / 100));
    if (cm.WorldSettings.isOn("GUARDIAN_MARCH_EFFECT")) {
        var b = cm.guardianModalModel.getStoneTrainingSpeedBonus();
        e = e * (1 + b)
    }
    c = Math.max(1, Math.ceil(c / e));
    return c
}

function modal_barracks_train_timecalc(E, y) {
    var a = ~~ (1 * E.value),
        I = ~~ (1 * $("modal_barracks_max_num").innerHTML),
        g = $("unitGambleOption"),
        s = $("trainingBoostContainer");
    if (a > I) {
        a = I
    } else {
        if ((a < 0) || (a == null) || (a == undefined)) {
            a = 0
        }
    }
    E.value = a;
    var u = modal_barracks_traintime(y, a),
        O, t, b, h, l = 1;
    if (g) {
        var w;
        if ($("gambleOption0").checked) {
            w = 0;
            l = 1;
            $("modal_barracks_traintime").innerHTML = timestr(u)
        } else {
            if ($("gambleOption1").checked) {
                w = 1;
                l = gambleOptionResults1[2];
                O = (100 - gambleOptionResults1[0]) / 100;
                t = (100 - gambleOptionResults1[1]) / 100;
                b = timestr(Math.ceil(O * u));
                h = timestr(Math.ceil(t * u));
                $("modal_barracks_traintime").innerHTML = h + " - " + b
            } else {
                if ($("gambleOption2").checked) {
                    w = 2;
                    l = gambleOptionResults2[2];
                    O = (100 - gambleOptionResults2[0]) / 100;
                    t = (100 - gambleOptionResults2[1]) / 100;
                    b = timestr(Math.ceil(O * u));
                    h = timestr(Math.ceil(t * u));
                    $("modal_barracks_traintime").innerHTML = h + " - " + b
                }
            }
        }
    } else {
        if (s) {
            $("modal_barracks_traintime").innerHTML = timestr(u, 1);
            $("modal_barracks_tutred").innerHTML = timestr(parseInt(u * 0.3, 10), 1);
            $("modal_barracks_arthurs_tutred").innerHTML = timestr(parseInt(u * 0.5, 10), 1);
            $("modal_barracks_merlins_tutred").innerHTML = timestr(parseInt(u * 0.7, 10), 1)
        }
    }
    var F = checkreq("unt", y, 1),
        Q = {},
        A = {},
        o, P, C;
    var e, r, B, H, v, k;
    for (var L = 0, p = F[4].length; L < p; ++L) {
        switch (F[4][L]) {
        case "Food":
            r = L;
            break;
        case "Wood":
            B = L;
            break;
        case "Stone":
            H = L;
            break;
        case "Ore":
            v = L;
            break;
        case "Population":
            k = L
        }
    }
    var O, t, b, h, G = F[1][r] * a,
        D = F[1][B] * a,
        K = F[1][v] * a,
        z = F[1][k] * a;
    var M = G * l,
        N = D * l,
        j = K * l,
        d = z * l;
    var c = (M > F[2][r]) ? "req unmet" : "req met",
        m = (N > F[2][B]) ? "req unmet" : "req met",
        f = (j > F[2][v]) ? "req unmet" : "req met",
        J = (d > F[2][k]) ? "req unmet" : "req met";
    $("unitTrainModalFoodNeeded").innerHTML = G * l;
    $("unitTrainModalFoodNeeded").className = c;
    $("unitTrainModalWoodNeeded").innerHTML = D * l;
    $("unitTrainModalWoodNeeded").className = m;
    $("unitTrainModalOreNeeded").innerHTML = K * l;
    $("unitTrainModalOreNeeded").className = f;
    $("unitTrainModalPopulationNeeded").innerHTML = z;
    $("unitTrainModalPopulationNeeded").className = J;
    if (H) {
        var n = F[1][H] * a,
            x = n * l,
            q = (x > F[2][H]) ? "req unmet" : "req met";
        $("unitTrainModalStoneNeeded").innerHTML = n * l;
        $("unitTrainModalStoneNeeded").className = q
    }
}

function clearOtherTuts(a) {
    if (a == 1) {
        $("modal_barracks_arthurs_tut").checked = false;
        $("modal_barracks_merlins_tut").checked = false
    } else {
        if (a == 2) {
            $("modal_barracks_tut").checked = false;
            $("modal_barracks_merlins_tut").checked = false
        } else {
            if (a == 3) {
                $("modal_barracks_tut").checked = false;
                $("modal_barracks_arthurs_tut").checked = false
            }
        }
    }
}

function chooseGambleOptions(B, y) {
    var r = ~~ (1 * $("modal_barracks_num").value);
    var q = modal_barracks_train_max(y);
    if (q < r) {
        r = q;
        $("modal_barracks_num").value = q
    }
    var a = checkreq("unt", y, 1);
    if (r == null || r == undefined || r == "") {
        r = 0
    }
    var e, p, A, E, u, j;
    for (var H = 0, n = a[4].length; H < n; ++H) {
        switch (a[4][H]) {
        case "Food":
            p = H;
            break;
        case "Wood":
            A = H;
            break;
        case "Stone":
            E = H;
            break;
        case "Ore":
            u = H;
            break;
        case "Population":
            j = H
        }
    }
    var w, k;
    if ($("gambleOption0").checked) {
        w = 0;
        k = 1
    } else {
        if ($("gambleOption1").checked) {
            w = 1;
            k = ~~ (1 * gambleOptionResults1[2])
        } else {
            if ($("gambleOption2").checked) {
                w = 2;
                k = ~~ (1 * gambleOptionResults2[2])
            }
        }
    }
    var t = modal_barracks_traintime(y, r);
    var v = $("modal_barracks_traintime");
    var K, s, b, g, D = a[1][p] * r,
        C = a[1][A] * r,
        G = a[1][u] * r,
        z = a[1][j] * r;
    var I = D * k,
        J = C * k,
        h = G * k,
        d = z;
    var c = (I > a[2][e]) ? "req unmet" : "req met",
        l = (J > a[2][e + 1]) ? "req unmet" : "req met",
        f = (h > a[2][e + 2]) ? "req unmet" : "req met",
        F = (d > a[2][e + 3]) ? "req unmet" : "req met";
    if (E) {
        var m = a[1][E] * r,
            x = m * k,
            o = (x > a[2][E]) ? "req unmet" : "req met";
        $("unitTrainModalStoneNeeded").innerHTML = m * k;
        $("unitTrainModalStoneNeeded").className = o
    }
    $("modal_barracks_max_num").innerHTML = modal_barracks_train_max(y);
    switch (B) {
    case 0:
        $("unitTrainModalFoodNeeded").innerHTML = D;
        $("unitTrainModalFoodNeeded").className = c;
        $("unitTrainModalWoodNeeded").innerHTML = C;
        $("unitTrainModalWoodNeeded").className = l;
        $("unitTrainModalOreNeeded").innerHTML = G;
        $("unitTrainModalOreNeeded").className = f;
        $("unitTrainModalPopulationNeeded").innerHTML = z;
        $("unitTrainModalPopulationNeeded").className = F;
        v.innerHTML = timestr(t);
        break;
    case 1:
        K = (100 - gambleOptionResults1[0]) / 100;
        s = (100 - gambleOptionResults1[1]) / 100;
        b = timestr(Math.ceil(K * t));
        g = timestr(Math.ceil(s * t));
        $("unitTrainModalFoodNeeded").innerHTML = D * gambleOptionResults1[2];
        $("unitTrainModalFoodNeeded").className = c;
        $("unitTrainModalWoodNeeded").innerHTML = C * gambleOptionResults1[2];
        $("unitTrainModalWoodNeeded").className = l;
        $("unitTrainModalOreNeeded").innerHTML = G * gambleOptionResults1[2];
        $("unitTrainModalOreNeeded").className = f;
        $("unitTrainModalPopulationNeeded").innerHTML = z;
        $("unitTrainModalPopulationNeeded").className = F;
        v.innerHTML = g + " - " + b;
        break;
    case 2:
        K = (100 - gambleOptionResults2[0]) / 100;
        s = (100 - gambleOptionResults2[1]) / 100;
        b = timestr(Math.ceil(K * t));
        g = timestr(Math.ceil(s * t));
        $("unitTrainModalFoodNeeded").innerHTML = D * gambleOptionResults2[2];
        $("unitTrainModalFoodNeeded").className = c;
        $("unitTrainModalWoodNeeded").innerHTML = C * gambleOptionResults2[2];
        $("unitTrainModalWoodNeeded").className = l;
        $("unitTrainModalOreNeeded").innerHTML = G * gambleOptionResults2[2];
        $("unitTrainModalOreNeeded").className = f;
        $("unitTrainModalPopulationNeeded").innerHTML = z;
        $("unitTrainModalPopulationNeeded").className = F;
        v.innerHTML = g + " - " + b;
        break;
    default:
        break
    }
}

function modal_barracks_train_maxbtn(b) {
    $("modal_barracks_num").value = modal_barracks_train_max(b);
    var a;
    if ($("gambleOption0").checked) {
        a = 0
    } else {
        if ($("gambleOption1").checked) {
            a = 1
        } else {
            if ($("gambleOption2").checked) {
                a = 2
            }
        }
    }
    chooseGambleOptions(a, b);
    modal_barracks_train_timecalc($("modal_barracks_num"), b)
}

function modal_barracks_train_max(f) {
    var a = 1;
    if (cm.WorldSettings.hasKeyValuePair("TROOP_GAMBLE", "ON")) {
        if ($("gambleOption0")) {
            if ($("gambleOption0").checked) {
                a = 1
            }
        }
        if ($("gambleOption1")) {
            var g = $("gambleOption1").checked;
            if ($("gambleOption1").checked) {
                a = ~~ (1 * gambleOptionResults1[2])
            }
        }
        if ($("gambleOption2")) {
            var g = $("gambleOption2").checked;
            if ($("gambleOption2").checked) {
                a = ~~ (1 * gambleOptionResults2[2])
            }
        }
    }
    var c = new Array();
    var b = new Array();
    for (var e = 1; e < 5; e++) {
        c.push((parseInt(unitcost["unt" + f][e]) * 3600) * a);
        b.push(parseInt(seed.resources["city" + currentcityid]["rec" + e][0]))
    }
    c.push((parseInt(unitcost["unt" + f][5])) * a);
    b.push(parseInt(seed.citystats["city" + currentcityid].gold[0]));
    c.push((parseInt(unitcost["unt" + f][6])));
    b.push(parseInt(seed.citystats["city" + currentcityid].pop[0]) - parseInt(seed.citystats["city" + currentcityid].pop[3]));
    var d = b[0] / c[0];
    for (var e = 1; e < c.length; e++) {
        if (parseInt(c[e]) != 0) {
            d = Math.min(d, b[e] / c[e])
        }
    }
    return parseInt(d) || 0
}

function modal_barracks_getmoreshop() {
    Modal.hideModalAll();
    modal_shop(2)
}

function modal_barracks_train_action(c) {
    cm.sounds.play("modal_barracks_train_action");
    if ($("trainingBoostContainer")) {
        if (!$("unit_btns_start").hasClassName("unmet")) {
            var b = parseInt($("modal_barracks_num").value);
            if (b <= modal_barracks_train_max(c) && b > 0) {
                var d = 0;
                if ($("modal_barracks_tut").checked) {
                    if (parseInt(seed.items.i36) > 0) {
                        d = 36
                    }
                }
                if ($("modal_barracks_arthurs_tut").checked) {
                    if (parseInt(seed.items.i37) > 0) {
                        d = 37
                    }
                }
                if ($("modal_barracks_merlins_tut").checked) {
                    if (parseInt(seed.items.i38) > 0) {
                        d = 38
                    }
                }
                Modal.hideModal();
                train_unit(c, b, d, null)
            }
        }
    } else {
        if ($("unitGambleOption")) {
            var b = parseInt($("modal_barracks_num").value);
            var a;
            if ($("gambleOption0").checked) {
                a = 0
            } else {
                if ($("gambleOption1").checked) {
                    a = 1
                } else {
                    if ($("gambleOption2").checked) {
                        a = 2
                    }
                }
            }
            Modal.hideModal();
            train_unit(c, b, null, a)
        }
    }
}

function changeBarracksModalTabs(a) {
    var c = $("barracksModalTabs").select("a");
    for (var b = 0; b < c.length; b++) {
        c[b].className = "tab";
        $("barracks_" + b).hide()
    }
    $("barracks_" + a).show();
    c[a].addClassName("selected");
    if (a == 0) {
        $("modal_build").className = "tab1"
    } else {
        $("modal_build").className = "tab2";
        modal_barracks_trainingtab()
    }
}

function trainingButton(a, c, b) {
    if (b) {
        a.push("<span class='speedupButton'>")
    }
    a.push("<a id='button_training_cancel' class='" + (b ? "inlineButton20Red" : "button20") + "' href='#' onclick='");
    if (b) {
        a.push('modal_speedup( "trn", ' + c[0] + ", " + c[0] + ', "Training", ' + c[2])
    } else {
        a.push("cancelTraining( 0," + currentcityid + "," + c[0] + "," + c[1] + "," + c[3] + "," + c[2] + "," + c[5] + "," + (b ? "true" : "false"))
    }
    a.push(");return false;'>");
    a.push("<span>" + (b ? g_js_strings.commonstr.speedup : g_js_strings.commonstr.cancel) + "</span></a>");
    if (b) {
        a.push("</span>")
    }
}

function modal_barracks_trainingtab() {
    if (seed.queue_unt["city" + currentcityid].length > 0) {
        var e = new Array();
        var a = seed.queue_unt["city" + currentcityid][0];
        e.push("<div class='clearfix traincur'>");
        e.push("<div class='piccol'><img src='");
        e.push(stimgUrl);
        e.push("img/units/unit_");
        e.push(a[0]);
        e.push("_50_s34.jpg?6545'/></div>");
        e.push("<div class='infocol'><div class='untnm'>");
        e.push(unitcost["unt" + a[0]][0]);
        e.push("</div><div>");
        e.push(a[1]);
        e.push("</div>");
        var j = modal_barracks_traintime(a[0], a[1]);
        var d = parseInt(a[3]) - parseInt(a[2]);
        var h;
        if (j == d) {
            h = false
        } else {
            h = true
        }
        var c = unixtime();
        var b = parseInt(a[3]) - c;
        if (h) {
            e.push("<div>" + g_js_strings.modal_barracks_trainingtab.totaltraintime + ": " + timestr(d) + ", reduced from " + timestr(j) + "</div>")
        } else {
            e.push("<div>" + g_js_strings.modal_barracks_trainingtab.totaltraintime + ": " + timestr(d) + "</div>")
        }
        e.push("</div>");
        e.push("</div>");
        e.push("<div class='btnrow clearfix'><div class='est2'>");
        e.push(g_js_strings.modal_barracks_trainingtab.esttimeremain);
        e.push("</div>");
        e.push("<div class='est3 traintimewidth'>");
        e.push(":  <b>");
        e.push("<span id='intraining_estimatedtimeremain'></span>");
        e.push("</b></div>");
        trainingButton(e, a);
        trainingButton(e, a, true);
        e.push("</div>");
        $("modal_currentlytraining").update(e.join(""));
        CountDown.addCountDown("intraining_estimatedtimeremain", b, function () {
            update_seed_ajax(true, function () {
                $("intraining_estimatedtimeremain").update(g_js_strings.modal_barracks_trainingtab.completetxt);
                $("button_training_cancel").hide();
                modal_barracks_trainingtab()
            })
        });
        if (seed.queue_unt["city" + currentcityid].length > 1) {
            var g = new Array();
            for (var f = 1; f < seed.queue_unt["city" + currentcityid].length; f++) {
                var k = (f % 2 == 0) ? "" : "stripe";
                g.push("<div class='clearfix queueitem " + k + "'>");
                g.push("<div class='piccol'><img src='");
                g.push(stimgUrl);
                g.push("img/units/unit_");
                g.push(seed.queue_unt["city" + currentcityid][f][0]);
                g.push("_50_s34.jpg'/></div>");
                g.push("<div class='infocol'><div><b>");
                g.push(unitcost["unt" + seed.queue_unt["city" + currentcityid][f][0]][0]);
                g.push(":</b> ");
                g.push(seed.queue_unt["city" + currentcityid][f][1]);
                g.push("</div><div><b>");
                g.push(g_js_strings.modal_barracks_trainingtab.esttime);
                g.push(":</b> ");
                g.push(timestr(parseInt(seed.queue_unt["city" + currentcityid][f][3]) - parseInt(seed.queue_unt["city" + currentcityid][f][2])));
                g.push("<a href='#' class='button20' onclick='cancelTraining(");
                g.push(f + "," + currentcityid + "," + seed.queue_unt["city" + currentcityid][f][0] + "," + seed.queue_unt["city" + currentcityid][f][1] + "," + seed.queue_unt["city" + currentcityid][f][3] + "," + seed.queue_unt["city" + currentcityid][f][2] + "," + seed.queue_unt["city" + currentcityid][f][5]);
                g.push(");return false;'>");
                g.push("<span>" + g_js_strings.commonstr.cancel + "</span></a>");
                g.push("</div></div>");
                g.push("</div>")
            }
            $("modal_trainingqueue").update(g.join(""))
        } else {
            $("modal_trainingqueue").update("")
        }
    } else {
        $("modal_currentlytraining").update("")
    }
}

function train_unit(tid, num, iid, gambleId) {
    var time = modal_barracks_traintime(tid, num);
    if (iid == 36) {
        time = parseInt(time * 0.7)
    } else {
        if (iid == 37) {
            time = parseInt(time * 0.5)
        } else {
            if (iid == 38) {
                time = parseInt(time * 0.3)
            }
        }
    }
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    params.type = tid;
    params.quant = num;
    params.items = iid;
    params.gambleId = gambleId;
    var profiler = new cm.Profiler("ResponseTime", "train.php");
    new Ajax.Request(g_ajaxpath + "ajax/train.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            profiler.stop();
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                var resourceFactors = [],
                    resourceLost;
                if (gambleId != null) {
                    time = rslt.timeNeeded
                }
                for (var i = 1; i < 5; i++) {
                    if (rslt.gamble) {
                        resourceFactors.push(rslt.gamble[i.toString()])
                    } else {
                        resourceFactors.push(1)
                    }
                    resourceLost = parseInt(unitcost["unt" + tid][i]) * 3600 * parseInt(num);
                    resourceLost = resourceLost * resourceFactors[i - 1];
                    seed.resources["city" + currentcityid]["rec" + i][0] = parseInt(seed.resources["city" + currentcityid]["rec" + i][0]) - resourceLost
                }
                seed.citystats["city" + currentcityid].gold[0] = parseInt(seed.citystats["city" + currentcityid].gold[0]) - parseInt(unitcost["unt" + tid][5]) * parseInt(num);
                seed.citystats["city" + currentcityid].pop[0] = parseInt(seed.citystats["city" + currentcityid].pop[0]) - parseInt(unitcost["unt" + tid][6]) * parseInt(num);
                seed.queue_unt["city" + currentcityid].push([tid, num, rslt.initTS, parseInt(rslt.initTS) + time, 0, time, null]);
                queue_changetab_train();
                changeBarracksModalTabs(1);
                seed.items["i" + iid] = Number(seed.items["i" + iid]) - 1;
                ksoItems[iid].subtract();
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                UserEngagement.popViralModalUEP(1)
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {
            profiler.stop()
        }
    })
};
cm = cm || {};
cm.BeginnerPackageView = function (d) {
    var c = function (g) {
            var f = (seed.tutorial.t1 >= 19);
            if (f) {
                b(g)
            }
        };
    var a = function (j) {
            var h = "";
            if (j.dollarAmount) {
                h += "<div class='title'>" + g_js_strings.beginnerPackage.titleDollar + "</div>";
                h += "<div class='gems dollar'>" + g_js_strings.beginnerPackage.gemsDollar + "</div>"
            } else {
                h += "<div class='title'>" + g_js_strings.beginnerPackage.title + "</div>";
                h += "<div class='gems'>" + g_js_strings.beginnerPackage.gems + "</div>"
            }
            h += "<div class='itemsTitle'>" + g_js_strings.beginnerPackage.itemsTitle + "</div>";
            var f = ["sp", "res", "bts", "tk"];
            for (var g = 0; g < f.length; g++) {
                if (g == 0) {
                    h += "<div class='items'><ul>"
                }
                h += "<li class='" + f[g] + "'>" + g_js_strings.beginnerPackage["itemText" + g] + "</li>";
                if (g == f.length - 1) {
                    h += "</ul></div>"
                }
            }
            h += "<div class='timeLeft'>" + g_js_strings.beginnerPackage.timeLeft + "</div>";
            h += "<div class='button'>" + g_js_strings.beginnerPackage.buynow + "</div>";
            return cm.StringFormatter.applyTemplate(h, j)
        };
    var b = function (h) {
            var f = a(h);
            var g = "close";
            if (h.popup) {
                cm.ModalManager.add({
                    body: f,
                    closeNow: true,
                    close: function () {
                        AjaxCall.gPostRequest("ajax/_dispatch.php", {
                            ctrl: "BeginnerSale",
                            action: "closeModal",
                            type: g
                        }, function () {})
                    },
                    lower: false,
                    "class": "beginnerpackage",
                    curtain: true,
                    width: 645,
                    height: 409,
                    left: 59,
                    top: 120,
                    z: 123455
                });
                d(".beginnerpackage .button").bind("click", function () {
                    g = "buy";
                    cm.ModalManager.close();
                    cm.ConversionTracker.track("payments", "MORE_GEMS_MAIN", "");
                    modal_getgems()
                })
            }
            e(h)
        };
    var e = function (k) {
            var n = parseInt(k.timeLeft.days);
            var j = parseInt(k.timeLeft.hours);
            var f = parseInt(k.timeLeft.minutes);
            var g = setInterval(function () {
                if (n == 0 && j == 0 && f == 0) {
                    clearInterval(g);
                    d("#promoTimeLeft").hide()
                } else {
                    f -= 1;
                    if (f == -1) {
                        f = 59;
                        j -= 1;
                        if (j == -1) {
                            j = 23;
                            n -= 1
                        }
                    }
                    var o = {
                        days: n,
                        hours: j,
                        minutes: f
                    };
                    var m = g_js_strings.beginnerPackage.countDownText;
                    var h = cm.StringFormatter.applyTemplate(m, o);
                    if (d("#impendingAttackContainer").html() == "") {
                        d("#promoTimeLeft").html(h).show()
                    } else {
                        d("#promoTimeLeft").html(h).hide()
                    }
                }
            }, 60 * 1000);
            var l = {
                days: n,
                hours: j,
                minutes: f
            };
            var i = cm.StringFormatter.applyTemplate(g_js_strings.beginnerPackage.countDownText, l);
            if (d("#impendingAttackContainer").html() == "") {
                d("#promoTimeLeft").html(i).show()
            } else {
                d("#promoTimeLeft").html(i).hide()
            }
        };
    return {
        init: c
    }
}(jQuery);
cm.BLTutorialSteps = [{
    name: "BL_INTRODUCTION",
    events: {
        enter: function () {
            cm.TutorialKeyController.disableKeys();
            if (cm.TutorialProgressChecker.isSawmillPositionOccupied()) {
                cm.TutorialManager.gotoStep("WATCH_SAWMILL_PROGRESS")
            } else {
                var a = [];
                a.push("<div class='content'>");
                a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin0a.replace("%1$s", seed.player.prefix) + "</div>");
                a.push("<div class='buttonrow clearfix'>");
                a.push("<a class='brownButton' onclick='cm.TutorialEventDispatcher.dispatchTutorialEvent(\"skip\", \"BL_INTRODUCTION\");return false;'>" + g_js_strings.commonstr.nothanks + "</a>");
                a.push("<a class='blueButton' onclick='cm.TutorialEventDispatcher.dispatchTutorialEvent(\"complete\", \"BL_INTRODUCTION\");return false;'>" + g_js_strings.commonstr.next + "</a></div>");
                a.push("</div>");
                var b = new cm.BLTutorialDialog(a.join(""));
                b.show();
                cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3-Merlin Intro-1" + seed.player.g);
                cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3 Skip-Merlin Intro-1" + seed.player.g);
                cm.MixPanelTracker.trackFunnel("FTE Tutorial v3", 1, "Merlin Intro", {
                    usr_gen: seed.player.g,
                    usr_byr: seed.player.y,
                    usr_ttl: titlenames[seed.player.title],
                    distinct_id: tvuid
                });
                cm.MixPanelTracker.trackFunnel("FTE Tutorial v3 Skip", 1, "Merlin Intro", {
                    usr_gen: seed.player.g,
                    usr_byr: seed.player.y,
                    usr_ttl: titlenames[seed.player.title],
                    distinct_id: tvuid
                });
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_merlin_intro");
                    fteConversionTracker("fte_conv_merlin_intro")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        },
        skip: function () {
            cm.TutorialManager.gotoStep("BL_SKIP")
        }
    }
}, {
    name: "CLICK_LOT_BUILD_SAWMILL",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillPositionOccupied()) {
                cm.TutorialManager.gotoStep("WATCH_SAWMILL_PROGRESS")
            } else {
                if (!$("maparea_fields").visible()) {
                    changeview_fields($("mod_views_field"))
                }
                $("arrowtip").innerHTML = "<div class='arrowdown'><div style='margin-top:-80px;width:200px;'>" + g_js_strings.tutorialCheck.clickforsawmill_a + "</div></div>";
                $("arrowtip").style.top = "210px";
                $("arrowtip").style.left = "300px";
                $("arrowtip").show();
                $("tutorialCover").addClassName("sawmill");
                tutorialUpdateCover2(278, 306, 91, 51);
                $("tutorialCover").show();
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_start_sawmill");
                    fteConversionTracker("fte_conv_start_sawmill")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CHOOSE_SAWMILL",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillPositionOccupied()) {
                cm.TutorialManager.gotoStep("WATCH_SAWMILL_PROGRESS")
            } else {
                $("arrowtip").innerHTML = "<div class='arrowleft'><div>" + g_js_strings.tutorialCheck.clickheresawmill_a + "</div></div>";
                $("arrowtip").style.top = "251px";
                $("arrowtip").style.left = "244px";
                $("arrowtip").show();
                $("tutorialCover").addClassName("clicksawmill");
                tutorialUpdateCover2(128, 118, 105, 206);
                $("tutorialCover").show();
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_select_sawmill");
                    fteConversionTracker("fte_conv_select_sawmill")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_BUILD_BUTTON_SAWMILL",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillPositionOccupied()) {
                cm.TutorialManager.gotoStep("WATCH_SAWMILL_PROGRESS")
            } else {
                $("modalControls1").hide();
                if ($("modal_whats_this_link")) {
                    $("modal_whats_this_link").style.visibility = "hidden"
                }
                $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialCheck.clickbuildnohelp_a + "</div></div>";
                $("arrowtip").style.top = "175px";
                $("arrowtip").style.left = "379px";
                $("arrowtip").show();
                Modal.showCurtain()
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "WATCH_SAWMILL_PROGRESS",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillBuilding()) {
                $("arrowtip").innerHTML = "<div class='arrowdown'><div style='margin-top:-150px;width:150px;'>" + g_js_strings.tutorialCheck.buildingtimeline + "</div></div>";
                $("arrowtip").style.top = "465px";
                $("arrowtip").style.left = "500px";
                $("arrowtip").show();
                Modal.showCurtain();
                $("modalCurtain0").setOpacity(0.3)
            } else {
                cm.TutorialManager.gotoNextStep()
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep();
            tutorialAdvance(1, 15)
        }
    }
}, {
    name: "CLICK_QUEST_SAWMILL_REWARD",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillRewardClaimed()) {
                cm.TutorialManager.gotoStep("CLICK_CITY_TAB")
            } else {
                tutorialAdvance(1, 16);
                Modal.hideModalAll();
                $("arrowtip").innerHTML = "<div class='arrowup'><div style='width:200px;'>" + g_js_strings.tutorialCheck.clickforquests_a + "</div></div>";
                $("arrowtip").style.top = "100px";
                $("arrowtip").style.left = "209px";
                $("arrowtip").show();
                $("tutorialCover").addClassName("quest");
                tutorialUpdateCover2(190, 40, 55, 55);
                $("tutorialCover").show();
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_click_quest");
                    fteConversionTracker("fte_conv_click_quest")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_QUEST_REWARD_BUTTON",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillRewardClaimed()) {
                cm.TutorialManager.gotoStep("CLICK_CITY_TAB")
            } else {
                modal_quests_doquests();
                $("modalControls1").hide();
                Event.observe("modalControlsClose1", "click", modal_questsFTEClose1);
                $("arrowtip").innerHTML = "<div class='arrowright'><div>" + g_js_strings.tutorialCheck.clickforreward + "</div></div>";
                $("arrowtip").style.top = "497px";
                $("arrowtip").style.left = "340px";
                $("arrowtip").show();
                Modal.showCurtain();
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_get_quest_reward");
                    fteConversionTracker("fte_conv_get_quest_reward")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_QUEST_CLOSE_BUTTON",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillRewardClaimed()) {
                cm.TutorialManager.gotoStep("CLICK_CITY_TAB")
            } else {
                $("arrowtip").innerHTML = "<div class='arrowright'><div style='margin-left:-100px'>" + g_js_strings.tutorialCheck.clickclosetofieldview + "</div></div>";
                $("arrowtip").style.top = "497px";
                $("arrowtip").style.left = "570px";
                $("arrowtip").show();
                var a = document.createElement("div");
                a.id = "questClickCover";
                a.className = "clickCover";
                document.body.appendChild(a);
                Modal.showCurtain();
                $("modal_quests_fte_close_btn").show();
                $("modalControls1").show();
                tutorialFlag = true
            }
        },
        complete: function () {
            tutorialAdvance(1, 18);
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_CITY_TAB",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isCottagePositionOccupied()) {
                cm.TutorialManager.gotoStep("BL_CONGRATULATIONS")
            } else {
                tutorialAdvance(1, 19);
                $("arrowtip").innerHTML = "<div class='arrowup'><div style='width:200px;'>" + g_js_strings.tutorialCheck.clickforcity_a + "</div></div>";
                $("arrowtip").style.top = "148px";
                $("arrowtip").style.left = "6px";
                $("arrowtip").show();
                $("tutorialCover").addClassName("cityview");
                tutorialUpdateCover2(-6, 103, 43, 24);
                $("tutorialCover").show();
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_city_view");
                    fteConversionTracker("fte_conv_city_view")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_LOT_BUILD_COTTAGE",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isCottagePositionOccupied()) {
                cm.TutorialManager.gotoStep("BL_CONGRATULATIONS")
            } else {
                $("arrowtip").innerHTML = "<div class='arrowdown'><div style='margin-top:-80px;width:200px;'>" + g_js_strings.tutorialCheck.clickforcott_a + "</div></div>";
                $("arrowtip").style.top = "236px";
                $("arrowtip").style.left = "240px";
                $("arrowtip").show();
                $("tutorialCover").addClassName("cottage");
                tutorialUpdateCover2(235, 322, 43, 59);
                $("tutorialCover").show();
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_start_cottage");
                    fteConversionTracker("fte_conv_start_cottage")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CHOOSE_COTTAGE",
    events: {
        enter: function () {
            $("arrowtip").innerHTML = "<div class='arrowleft'><div>" + g_js_strings.tutorialCheck.clickherecottage_a + "</div></div>";
            $("arrowtip").style.top = "264px";
            $("arrowtip").style.left = "130px";
            $("arrowtip").show();
            $("tutorialCover").addClassName("clickcottage");
            tutorialUpdateCover2(16, 117, 105, 206);
            $("tutorialCover").show();
            if (numWorlds == 1) {
                cm.ConversionTracker.track("", "fte_conv_select_cottage");
                fteConversionTracker("fte_conv_select_cottage")
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_BUILD_BUTTON_COTTAGE",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isCottagePositionOccupied()) {
                cm.TutorialManager.gotoStep("BL_CONGRATULATIONS")
            } else {
                $("modalControls1").hide();
                if ($("modal_whats_this_link")) {
                    $("modal_whats_this_link").style.visibility = "hidden"
                }
                $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialCheck.clickbuildnohelpcottage + "</div></div>";
                $("arrowtip").style.top = "175px";
                $("arrowtip").style.left = "379px";
                $("arrowtip").show();
                Modal.showCurtain()
            }
        },
        complete: function () {
            tutorialAdvance(1, 21);
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "BL_CONGRATULATIONS",
    nextStepName: "ENDING",
    events: {
        enter: function () {
            var a = [];
            a.push("<div class='content'>");
            a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin5a + "</div>");
            a.push("<div class='buttonrow'>");
            a.push("<a class='blueButton' onclick='cm.TutorialEventDispatcher.dispatchTutorialEvent(\"complete\",\"BL_CONGRATULATIONS\");return false;'><span>" + g_js_strings.commonstr.next + "</span></a><br clear='all' /></div>");
            a.push("</div>");
            var b = new cm.BLTutorialDialog(a.join(""));
            b.setClassName("bltutorial ending");
            b.show();
            cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3-Merlin Level Up-5");
            cm.MixPanelTracker.trackFunnel("FTE Tutorial v3", 5, "Merlin Level Up", {
                usr_gen: seed.player.g,
                usr_byr: seed.player.y,
                usr_ttl: titlenames[seed.player.title],
                distinct_id: tvuid
            });
            if (numWorlds == 1) {
                cm.ConversionTracker.track("", "fte_conv_merlin_level_up");
                fteConversionTracker("fte_conv_merlin_level_up")
            }
        },
        complete: function () {
            seed.tutorial.t1 = 50;
            tutorialMerlinOver();
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "BL_SKIP",
    events: {
        enter: function () {
            var a = [];
            a.push("<div class='content'>");
            a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin10a + "</div>");
            a.push("<div class='buttonrow clearfix'>");
            a.push("<a class='brownButton' onclick='cm.TutorialEventDispatcher.dispatchTutorialEvent(\"complete\", \"BL_SKIP\");return false;'>" + g_js_strings.tutorialMerlinTutorial.skiptutorial + "</span></a>");
            a.push("<a class='blueButton' onclick='cm.TutorialEventDispatcher.dispatchTutorialEvent(\"cancel\", \"BL_SKIP\");return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a>");
            a.push("</div>");
            a.push("</div>");
            var b = new cm.BLTutorialDialog(a.join(""));
            b.show()
        },
        complete: function () {
            tutorialNoShow();
            cm.TutorialManager.gotoNextStep()
        },
        cancel: function () {
            cm.TutorialManager.startFromBeginning()
        }
    }
}, {
    name: "ENDING",
    events: {
        enter: function () {
            cm.TutorialManager.end();
            cm.BLTutorialSteps = cm.MerlinTutorialSteps = null
        }
    }
}];

function setBookmarkLocation(tileId, bookmarkName) {
    var params = Object.clone(g_ajaxparams);
    params.requestType = "BOOKMARK_LOCATION";
    params.tileId = tileId;
    params.bookmarkName = bookmarkName || "";
    new Ajax.Request(g_ajaxpath + "ajax/tileBookmark.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            cm.Bookmarks.get(null, true);
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                Modal.hideModal()
            }
            if (!rslt.ok) {
                Modal.hideModal()
            }
            $("#contextMenu").remove()
        },
        onFailure: function () {}
    });
    if ($("bookmarkLocLink").className == "open") {
        $("bookmarkLocLink").className = "close";
        $("bookmarksBox").hide()
    }
}

function openBookMarks() {
    if ($("bookmarkLocLink").className == "open") {
        $("bookmarkLocLink").className = "close";
        $("bookmarksBox").hide()
    } else {
        $("bookmarksBox").show();
        $("bookmarkLocLink").className = "open";
        cm.Bookmarks.get(function (d) {
            var a = [];
            var c = null;
            a.push("<div class='bookmarkswrap'>");
            for (var b = 0; b < d.length; ++b) {
                c = d[b];
                a.push("<div class='bookmarkrow'>");
                a.push("<a class='location'  onclick='setBookmarkCoord(" + c.left + "," + c.top + ");return false;'>" + unescape(c.name) + " (" + c.left + ", " + c.top + ") </a>");
                if (undefined != c.bookmark_id) {
                    a.push("<a class='delete' onclick='deleteBookmark(this," + c.bookmark_id + ");return false;'>X</a>")
                }
                a.push("</div>")
            }
            a.push("</div>");
            $("bookmarksBox").innerHTML = a.join("")
        })
    }
}

function setBookmarkCoord(b, a) {
    $("mapXCoor").value = b;
    $("mapYCoor").value = a;
    reCenterMapWithCoor();
    openBookMarks()
}

function deleteBookmark(tgt, bid) {
    var params = Object.clone(g_ajaxparams);
    params.requestType = "REMOVE_BOOKMARK";
    params.bookmarkId = bid;
    new Ajax.Request(g_ajaxpath + "ajax/tileBookmark.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            cm.Bookmarks.get(null, true);
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                var bmrow = tgt.parentNode;
                Object.extend(bmrow);
                bmrow.remove();
                openBookMarks()
            }
        },
        onFailure: function () {}
    })
}
cm = cm || {};
cm.Bookmarks = function ($) {
    var bookmarks_ = null;
    var get_ = function (callback, is_latest) {
            if (is_latest || (null == bookmarks_)) {
                sync_(callback)
            } else {
                return_(callback)
            }
        };
    var return_ = function (callback) {
            var result = [];
            for (var i = 0; i < seed.cities.length; i++) {
                result.push({
                    name: seed.cities[i][1],
                    left: seed.cities[i][2],
                    top: seed.cities[i][3]
                })
            }
            if (callback) {
                callback(result.concat(bookmarks_))
            }
        };
    var sync_ = function (callback) {
            var params = Object.clone(g_ajaxparams);
            params.requestType = "GET_BOOKMARK_INFO";
            new Ajax.Request(g_ajaxpath + "ajax/tileBookmark.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (message) {
                    var rslt = eval("(" + message.responseText + ")");
                    if (rslt.ok) {
                        bookmarks_ = [];
                        var bookmarkInfo = rslt.bookmarkInfo;
                        for (id in bookmarkInfo) {
                            bookmarks_.push({
                                name: bookmarkInfo[id].name,
                                left: bookmarkInfo[id].xCoord,
                                top: bookmarkInfo[id].yCoord,
                                bookmark_id: bookmarkInfo[id].bookmarkId
                            })
                        }
                        return_(callback)
                    }
                },
                onFailure: function () {}
            })
        };
    return {
        get: get_
    }
}(jQuery);
cm = cm || {};
cm.BoostModel = jQueryClass.extend({
    init: function (a) {
        this.id = a[0];
        this.expireTime = Number(a[1])
    },
    isActive: function () {
        return (this.expireTime > unixtime())
    },
    addTime: function (a) {
        this.expireTime = this.expireTime + a;
        return this.expireTime
    },
    setTime: function (a) {
        this.expireTime = a;
        return this.expireTime
    },
    timeLeft: function () {
        return this.expireTime
    }
});
var cm = cm || {};
cm.FlashingNotifier = function (f) {
    var d = 0;
    var k = null;
    var b = 0;
    var i = 1;
    var g = 6;
    var h = function (l) {
            if (undefined != l.duration) {
                d = l.duration
            }
            if (undefined != l.element) {
                k = l.element;
                i = k.css("opacity")
            }
            if (undefined != l.repeat_times) {
                g = l.repeat_times
            }
        };
    var c = function () {
            if (d < 1 || null == k || g < 1) {
                return
            }
            if (b < unixtime()) {
                return
            }
            j();
            k.fadeIn(100, "swing");
            for (var l = 0; l < g - 1; ++l) {
                k.fadeToggle(d, "swing")
            }
            k.fadeIn(d, "swing")
        };
    var a = function (l) {
            d = l
        };
    var e = function (l) {
            b = l
        };
    var j = function () {
            if (null == k) {
                return
            }
            k.clearQueue();
            k.stop();
            k.css("opacity", i)
        };
    this.run = c;
    this.setDuration = a;
    this.setEndTime = e;
    this.stop = j;
    h(f)
};
cm.BoostsExpireNotifier = function (d) {
    var a = 6;
    var f = [166, 333, 500];
    var j = {
        production: {
            selector: "#maparea_boosts_production",
            flasher: null
        },
        combat: {
            selector: "#maparea_boosts_combat",
            flasher: null
        },
        fog: {
            selector: "#maparea_boosts_fog",
            flasher: null
        }
    };
    var b = null;
    var i = null;
    var e = function () {
            b = cm.BoostExpiration.expirationTable();
            d.each(j, function (l, k) {
                k.flasher = new cm.FlashingNotifier({
                    duration: 0,
                    element: d(k.selector),
                    repeat_times: a
                })
            });
            d(document).bind("onUpdateBoost", g);
            d(document).bind("onStopBoostNotifier", h)
        };
    var c = function () {
            for (boost_type in j) {
                j[boost_type].flasher.run()
            }
        };
    var h = function (l, k) {
            if (undefined == j[k] || null == j[k].flasher) {
                return
            }
            j[k].flasher.stop()
        };
    var g = function () {
            var s = null;
            var k = null;
            var m = null;
            var l = unixtime();
            var p = 0;
            var q = 0;
            var n = 0;
            var o = 0;
            var t = [];
            var r = false;
            for (s in j) {
                m = j[s];
                n = f.length;
                o = 0;
                t = b[s];
                for (k in t) {
                    if (undefined == seed.playerEffects[k]) {
                        continue
                    }
                    p = seed.playerEffects[k] - l;
                    if (p < 0) {
                        continue
                    }
                    for (q = 0; q < f.length; ++q) {
                        if (p < t[k][q]) {
                            break
                        }
                    }
                    if (q >= f.length) {
                        continue
                    }
                    n = Math.min(n, q);
                    if (o) {
                        o = Math.min(o, seed.playerEffects[k])
                    } else {
                        o = seed.playerEffects[k]
                    }
                }
                if (n < f.length) {
                    m.flasher.setDuration(f[n]);
                    m.flasher.setEndTime(o);
                    r = true
                } else {
                    m.flasher.setDuration(0);
                    m.flasher.setEndTime(0)
                }
            }
            if (r) {
                if (null == i) {
                    i = setInterval(c, 6000);
                    setTimeout(c, 5)
                }
            } else {
                if (null != i) {
                    clearTimeout(i);
                    i = null
                }
            }
        };
    d(document).ready(e);
    return {
        stop: function (k) {
            h(null, k)
        },
        update: g
    }
}(jQuery);
var cm = cm || {};
cm.BoostExpiration = function () {
    var a = {
        production: {
            r0BstExp: [3600, 7200, 14400],
            r1BstExp: [3600, 7200, 14400],
            r2BstExp: [3600, 7200, 14400],
            r3BstExp: [3600, 7200, 14400],
            r4BstExp: [3600, 7200, 14400]
        },
        combat: {
            troopUpkeepReductExp: [3600, 7200, 14400],
            atkExpire: [3600, 7200, 14400],
            atk2Expire: [3600, 7200, 14400],
            defExpire: [3600, 7200, 14400],
            def2Expire: [3600, 7200, 14400],
            truceExpireUnixTime: [3600, 7200, 14400],
            aurasExpire: [3600, 7200, 14400],
            auras2Expire: [3600, 7200, 14400]
        },
        fog: {
            fogExpire: [3600, 43200, 86400]
        }
    };
    var b = function () {
            var d = [];
            var f = null;
            if (arguments.length > 1) {
                d.push(arguments[0]);
                f = arguments[1]
            } else {
                d = ["production", "combat", "fog"];
                f = arguments[0]
            }
            var e = "";
            var c = null;
            while (d.length) {
                e = d.pop();
                c = a[e];
                if (undefined == c) {
                    continue
                }
                if (undefined != c[f]) {
                    return c[f][c[f].length - 1]
                }
            }
            return -1
        };
    return {
        expirationTable: function () {
            return a
        },
        getMaxNotificationTime: b
    }
}();

function update_boosts() {
    var d = false;
    var b = false;
    var e = false;
    var c = unixtime();
    if (parseInt(seed.playerEffects.fogExpire) > c) {
        e = true
    }
    for (var a = 0; a < 5; a++) {
        if (parseInt(seed.playerEffects["r" + a + "BstExp"]) > c) {
            d = true;
            break
        }
    }
    if (parseInt(seed.playerEffects.atkExpire) > c || parseInt(seed.playerEffects.atk2Expire) > c || parseInt(seed.playerEffects.defExpire) > c || parseInt(seed.playerEffects.def2Expire) > c || parseInt(seed.playerEffects.troopUpkeepReductExp) > c || parseInt(seed.playerEffects.loadExpire) > c || parseInt(seed.playerEffects.returnExpire) > c || parseInt(seed.playerEffects.lifeExpire) > c || parseInt(seed.playerEffects.aurasExpire) > c || parseInt(seed.playerEffects.auras2Expire) > c) {
        b = true
    }
    if (undefined != seed.player.truceExpireUnixTime && seed.player.truceExpireUnixTime > c) {
        seed.playerEffects.truceExpireUnixTime = seed.player.truceExpireUnixTime;
        b = true
    } else {
        delete seed.playerEffects.truceExpireUnixTime
    }
    jQuery(document).trigger("onUpdateBoost");
    if (e) {
        $("maparea_boosts_fog").show()
    } else {
        jQuery(document).trigger("onStopBoostNotifier", ["fog"]);
        $("maparea_boosts_fog").hide()
    }
    if (d) {
        $("maparea_boosts_production").show()
    } else {
        jQuery(document).trigger("onStopBoostNotifier", ["production"]);
        $("maparea_boosts_production").hide()
    }
    if (b) {
        $("maparea_boosts_combat").show()
    } else {
        jQuery(document).trigger("onStopBoostNotifier", ["combat"]);
        $("maparea_boosts_combat").hide()
    }
    if (d || b || e) {
        $("maparea_boosts").show()
    } else {
        $("maparea_boosts").hide()
    }
}

function boosts_tooltip_fog(g, a, e) {
    var d = new Array();
    d.push("<div id='boosts_tooltip'>");
    var c = unixtime();
    if (parseInt(seed.playerEffects.fogExpire) > c) {
        d.push("<div class='effect'>");
        d.push(g_js_strings.boosts_tooltip_fog.fog);
        d.push("</div>");
        var b = parseInt(seed.playerEffects.fogExpire) - c;
        var f = cm.BoostExpiration.getMaxNotificationTime("fog", "fogExpire");
        if (f > 0 && b < f) {
            d.push("<div class='time expired'>")
        } else {
            d.push("<div class='time'>")
        }
        d.push(g_js_strings.boosts_tooltip_production.aleft.replace("%1$s", timestr(b)));
        d.push("</div>")
    }
    d.push("</div>");
    showTooltip(d.join(""), g, a, e)
}

function boosts_tooltip_production(d, h, g) {
    var b = new Array();
    b.push("<div id='boosts_tooltip'>");
    var c = unixtime();
    var e = 0;
    var a = -1;
    if (parseInt(seed.playerEffects.r0BstExp) > c) {
        e = parseInt(seed.playerEffects.r0BstExp) - c;
        a = cm.BoostExpiration.getMaxNotificationTime("production", "r0BstExp");
        b.push("<div class='effect'>");
        b.push(g_js_strings.boosts_tooltip_production.goldprodincrease);
        b.push("</div>");
        if (a > 0 && e < a) {
            b.push("<div class='time expired'>")
        } else {
            b.push("<div class='time'>")
        }
        b.push(g_js_strings.boosts_tooltip_production.aleft.replace("%1$s", timestr(e)));
        b.push("</div>")
    }
    var j = "";
    for (var f = 1; f < 5; f++) {
        j = "r" + f + "BstExp";
        if (parseInt(seed.playerEffects[j]) > c) {
            e = parseInt(seed.playerEffects[j]) - c;
            a = cm.BoostExpiration.getMaxNotificationTime("production", j);
            b.push("<div class='effect'>");
            b.push(g_js_strings.boosts_tooltip_production.aprodincrease.replace("%1$s", resourceinfo["rec" + f]));
            b.push("</div>");
            if (a > 0 && e < a) {
                b.push("<div class='time expired'>")
            } else {
                b.push("<div class='time'>")
            }
            b.push(g_js_strings.boosts_tooltip_production.aleft.replace("%1$s", timestr(e)));
            b.push("</div>")
        }
    }
    b.push("</div>");
    showTooltip(b.join(""), d, h, g)
}

function boosts_tooltip_combat(e, i, g) {
    var c = [];
    c.push("<div id='boosts_tooltip'>");
    var d = unixtime();
    var h = {
        aurasExpire: g_js_strings.boosts_tooltip_combat.awesomeaura,
        atkExpire: g_js_strings.boosts_tooltip_combat.troopatkinc,
        defExpire: g_js_strings.boosts_tooltip_combat.troopdefinc,
        auras2Expire: g_js_strings.boosts_tooltip_combat.awesomeauraextreme,
        atk2Expire: g_js_strings.boosts_tooltip_combat.troopatkinc2,
        def2Expire: g_js_strings.boosts_tooltip_combat.troopdefinc2,
        truceExpireUnixTime: g_js_strings.boosts_tooltip_combat.cityinpeace,
        troopUpkeepReductExp: g_js_strings.boosts_tooltip_combat.troopupkeepreduct,
        loadExpire: g_js_strings.boosts_tooltip_combat.loadincrease,
        returnExpire: g_js_strings.boosts_tooltip_combat.troopreturnreduct,
        lifeExpire: g_js_strings.boosts_tooltip_combat.troophealthincrease
    };
    var f = 0;
    var a = -1;
    for (var b in h) {
        if (seed.playerEffects[b] && seed.playerEffects[b] > d) {
            f = parseInt(seed.playerEffects[b]) - d;
            a = cm.BoostExpiration.getMaxNotificationTime("combat", b);
            c.push("<div class='effect'>");
            c.push(h[b]);
            c.push("</div>");
            if (a > 0 && f < a) {
                c.push("<div class='time expired'>")
            } else {
                c.push("<div class='time'>")
            }
            c.push(g_js_strings.boosts_tooltip_production.aleft.replace("%1$s", timestr(f)));
            c.push("</div>")
        }
    }
    c.push("</div>");
    showTooltip(c.join(""), e, i, g)
};
var cm = cm || {};
cm.SpeedUpType = {
    build: "buildWithHelp" + tvuid,
    upgrade: "upgradeWithHelp" + tvuid,
    research: "researchWithHelp" + tvuid
};
cm.BuildingSpeedupController = new function () {
    var a = function (g) {
            var f = Event.element(g);
            while (!f.name) {
                f = f.parentNode
            }
            var d = f.name;
            return d
        };
    var b = "Speedup_Building_Click";
    var c = "bdg";
    this.queueClick = function (g, f) {
        var d = a(g);
        modal_speedup(c, d, undefined, f);
        cm.MixPanelTracker.track(b, {
            from: "queue"
        })
    };
    this.buildingClick = function (g) {
        var d = a(g);
        var f = jQuery(g.target).parent().parent().parent().attr("id");
        modal_speedup(c, d, f);
        cm.MixPanelTracker.track(b, {
            from: "building"
        });
        Event.stop(g)
    };
    this.popupClick = function (f) {
        var d = a(f);
        modal_speedup(c, d);
        cm.MixPanelTracker.track(b, {
            from: "popup"
        })
    }
};
cm.BuildingController = function (b, a) {
    var c = this;
    var d = b;
    var e = a;
    this.buildButtonClicked = function (j) {
        var l = d.getHelped();
        var f = d.getBuildingId();
        var g = d.getSlotId();
        var i = d.getCurrentLevel();
        var h = d.getWarStatus();
        if (f == 0 && g == 0 && i == 4 && h == 2) {
            protect_off_confirm(f, i, g, l)
        } else {
            build(f, i, g, l)
        }
    };
    this.askHelpCheckboxChanged = function (i) {
        var h = i.srcElement ? i.srcElement : i.target;
        d.setHelped(h.checked);
        var g = d.getCurrentLevel();
        var f = g > 0 ? cm.SpeedUpType.upgrade : cm.SpeedUpType.build;
        cm.ClientSideCookieManager.setCookie(f, h.checked);
        e.getElement("buildTimeText").innerHTML = d.getTime()
    }
};
cm.BuildingModel = function (f) {
    var d = f.buildingId;
    var j = f.slotId;
    var e = f.baseTime;
    var g = f.speedTime;
    var a = f.currentLevel;
    var b = f.nextLevel;
    var h = f.warStatus;
    var i = f.tutorialMode;
    var c = false;
    this.getBuildingId = function () {
        return d
    };
    this.getSlotId = function () {
        return j
    };
    this.getCurrentLevel = function () {
        return a
    };
    this.getNextLevel = function () {
        return _nextLevel
    };
    this.setHelped = function (l) {
        c = i ? false : l
    };
    this.getHelped = function () {
        return c
    };
    this.getTime = function () {
        return c ? g : e
    };
    this.getWarStatus = function () {
        return h
    };
    this.isTutorialMode = function () {
        return i
    }
};
cm.BuildingView = function (e, c) {
    var b = this;
    var a = e;
    var f = c;
    var d = function () {
            b.getElement("buildTimeText").innerHTML = f.getTime();
            b.getElement("askHelpCheckbox").checked = f.getHelped();
            b.getElement("whatIsThisLink").style.visibility = f.isTutorialMode() ? "hidden" : "visible";
            b.getElement("askHelpCheckbox").parentNode.style.visibility = f.isTutorialMode() ? "hidden" : "visible"
        };
    this.getElement = function (g) {
        return $(a[g])
    };
    d()
};
var buildingModel;
var buildingController;
var buildingView;

function modal_build_waiting_state() {}

function modal_build_show_state() {}

function modal_build_help_tooltip(c, a) {
    var b = "<div>" + g_js_strings.modal_build_help_tooltip.newfriendbuildtimedesc1 + "</div>";
    showTooltip(b, c, a, "modal_build")
}

function modal_build_demolish(b, d, a) {
    if (b == 1) {
        var c = "<div>" + g_js_strings.modal_build_demolish.deconstructiondesc + "</div>"
    } else {
        if (b == 2) {
            var c = "<div>" + g_js_strings.modal_build_demolish.destroydesc + "</div>"
        }
    }
    showTooltip(c, d, a, "modal_build")
}

function modal_build(u, r) {
    buildingModel = null;
    Modal.hideModalAll();
    var W = new Array();
    var c = seed.buildings["city" + currentcityid]["pos" + u];
    if (c == null) {
        var y = r;
        var aa = 0;
        var M = 1;
        var p = g_js_strings.modal_build.newbuilding + " - " + buildingcost["bdg" + y][0] + " " + g_js_strings.commonstr.lv + "1";
        var B = 1
    } else {
        var y = c[0];
        var aa = parseInt(c[1]);
        var M = aa + 1;
        var p = buildingcost["bdg" + y][0] + " " + g_js_strings.commonstr.lv + aa;
        var B = (M > 5) ? 5 : 1
    }
    if (y) {
        cm.sounds.play("modal_build" + y)
    } else {
        cm.log.l("newbdgid is undefined.")
    }
    var e = Math.pow(2, aa);
    W.push("<div id='modal_build' class='tab1'>");
    W.push("<div class='modal_build_body' id='modal_build_spinny' style='display:none;'>");
    W.push("<div class='modal_build_spinny'></div>");
    W.push("</div>");
    if (seed.cities[5] && currentcityid === parseInt(seed.cities[5][0], 10)) {
        W.push("<div class='modal_build_body city6' id='modal_build_body'>")
    } else {
        if (seed.cities[6] && currentcityid === parseInt(seed.cities[6][0], 10)) {
            W.push("<div class='modal_build_body city7' id='modal_build_body'>")
        } else {
            W.push("<div class='modal_build_body' id='modal_build_body'>")
        }
    }
    W.push("<div class='buildinginfo clearfix'>");
    W.push("<div class='buildingpic'>");
    W.push("<div class='building b");
    W.push(y);
    W.push("_" + B + "'>");
    W.push("</div>");
    W.push("</div>");
    W.push("<div class='buildingdesc'>");
    W.push(buildingcost["bdg" + y][10]);
    W.push("</div>");
    W.push("<div class='destructbtns'>");
    if (aa > 0 && parseInt(u) != 0 && parseInt(u) != 1 && !(cm.TutorialManager.inTutorialMode())) {
        W.push("<a class='buttonDown20' onclick='deconstructBuilding(" + c[3] + "," + u + ")' onmouseover='modal_build_demolish(1,this,event);' onmouseout='removeTooltip();'><span>" + g_js_strings.commonstr.decontruct + "</span></a>");
        if (aa > 1) {
            W.push("<div id='divDestroyBuilding' class='destroycol'>");
            W.push("<div class='clearfix'><a class='button20' onclick='destructBuilding(" + c[3] + "," + u + ")' onmouseover='modal_build_demolish(2,this,event);' onmouseout='removeTooltip();'><span>" + g_js_strings.commonstr.destroy + "</span></a></div>");
            W.push("<div class='dragonstomp'>(" + g_js_strings.modal_build.usedragon + ")</div>");
            W.push("</div>")
        }
    } else {
        if (parseInt(u) == 0 && seed.cities.length > 1) {
            W.push("<div><div class='clearfix' id='divDestroyBuilding' style='display:block;margin-left:6px;margin-top:5px;'><a class='button20' onclick='cityaction_abandonprompt();return false;'><span>" + g_js_strings.modal_build.abandoncity + "</span></a></div></div>")
        }
    }
    W.push("</div>");
    W.push("</div>");
    W.push("<div class='buildingdetail'>");
    if (aa < parseInt(buildingmaxlvl[y])) {
        var ac = true;
        W.push("<div class='reqhd'>" + g_js_strings.commonstr.level + " ");
        W.push(M);
        W.push(" " + g_js_strings.commonstr.requirement + "</div>");
        W.push("<div class='buildreq clearfix'>");
        W.push("<div class='leftColumn'>");
        W.push("<table cellpadding='0' cellspacing='0'><thead><tr><td class='rec'>" + g_js_strings.commonstr.resource + "</td><td class='req'>" + g_js_strings.commonstr.required + "</td><td class='own'>" + g_js_strings.commonstr.youown + "</td></tr></thead><tbody>");
        var an = checkreq("bdg", y, M);
        var g = new Array();
        var d = new Array();
        var h = new Array();
        for (var H = 0; H < an[0].length; H++) {
            if (typeof an[1][H] != "string" || an[1][H].indexOf("Lv.0") == -1) {
                g.push("<div>");
                g.push(an[0][H]);
                g.push("</div>");
                if (an[3][H] == 0) {
                    ac = false;
                    d.push("<div class='unmet'>")
                } else {
                    if (H === 0 && aa >= 10 && parseInt(y, 10) === 0) {
                        if (getBuildingLevel(19) >= aa) {
                            d.push("<div class='met'>")
                        } else {
                            d.push("<div class='unmet'>");
                            ac = false
                        }
                    } else {
                        d.push("<div class='met'>")
                    }
                }
                if (parseInt(an[1][H]) > 0) {
                    d.push(addCommas(parseInt(an[1][H])))
                } else {
                    if (aa >= 10 && parseInt(y, 10) === 0) {
                        d.push(g_js_strings.commonstr.lv + aa + " " + buildingcost.bdg19[0])
                    } else {
                        d.push(an[1][H])
                    }
                }
                d.push("</div>");
                h.push("<div>");
                if (parseInt(an[2][H]) > 0) {
                    h.push(addCommas(parseInt(an[2][H])))
                } else {
                    h.push(an[2][H])
                }
                h.push("</div>")
            }
        }
        W.push("<td class='rec'>");
        W.push(g.join(""));
        W.push("</td>");
        W.push("<td>");
        W.push(d.join(""));
        W.push("</td>");
        W.push("<td class='ownres'>");
        W.push(h.join(""));
        W.push("</td>");
        W.push("</tr>");
        if (parseInt(aa) >= 9) {
            var D = "i401";
            if (parseInt(y, 10) === 0) {
                if (parseInt(aa) == 10) {
                    D = "i402"
                } else {
                    if (parseInt(aa) == 11) {
                        D = "i404"
                    }
                }
            } else {
                if (parseInt(aa) > 10) {
                    D = "i403"
                }
            }
            var A = ~~ (1 * D.split("i")[1]);
            W.push("<tr>");
            W.push("<td class='rec'><div>");
            W.push(itemlist[D].name);
            W.push("</div></td>");
            W.push("<td>");
            if (ksoItems[A].count > 0) {
                W.push("<div class='met'>")
            } else {
                W.push("<div class='unmet'>")
            }
            W.push(1);
            W.push("</div>");
            W.push("</td>");
            W.push("<td class='ownres'><div>");
            if (ksoItems[A].count > 0) {
                W.push(addCommas(ksoItems[A].count))
            } else {
                W.push(0);
                ac = false
            }
            W.push("</div></td>");
            W.push("</tr>")
        }
        W.push("</tbody></table>");
        W.push("</div>");
        var aq = 0;
        var au = seed.queue_con["city" + currentcityid];
        var s = 0;
        var z = 0;
        if (au.length > 0) {
            aq = 1;
            for (var I = 0; I < au.length; I++) {
                if (parseInt(u) == parseInt(au[I][7])) {
                    aq = 2;
                    s = parseInt(au[I][4]) - parseInt(au[I][3]);
                    z = au[I][2];
                    break
                }
            }
        }
        if (aq == 0 && ac) {
            var w = g_js_strings.commonstr.build;
            var ax = cm.SpeedUpType.build;
            if (aa > 0) {
                w = g_js_strings.commonstr.upgrade;
                ax = cm.SpeedUpType.upgrade
            }
            var Z = g_js_strings.modal_build.buildandaskhelp;
            if (aa > 0) {
                Z = g_js_strings.modal_build.upgradeandaskhelp
            }
            var n = seed.knights["city" + currentcityid];
            var t = 0;
            if (n) {
                n = n["knt" + seed.leaders["city" + currentcityid].politicsKnightId];
                if (n) {
                    t = parseInt(n.politics);
                    if ((parseInt(n.politicsBoostExpireUnixtime) - unixtime()) > 0) {
                        t = parseInt(t * 1.25)
                    }
                }
            }
            var ai = buildingcost["bdg" + y][7] * e;
            if (parseInt(y) < 6 && parseInt(y) > 0 && e == 1) {
                ai = 15
            }
            var C = cm.ThroneController.effectBonus(78);
            ai = parseInt(ai / (1 + 0.005 * t + 0.1 * parseInt(seed.tech.tch16)));
            ai = Math.round(ai / (1 + (C / 100)));
            var at = Math.max(600, parseInt(ai * 0.1));
            var R = (ai - at) < 0 ? 0 : (ai - at);
            var K = ai;
            var ab = cm.TutorialManager.inTutorialMode();
            W.push("<div class='rightColumn'>");
            W.push("<div>");
            W.push("<div class='buttonRow'>");
            W.push("<a class='button20' onclick='buildingController.buildButtonClicked(event);return false;'>");
            W.push("<span>");
            W.push(w);
            W.push("</span></a>");
            W.push("<a id='modal_whats_this_link' class='helptext' style='visibility:hidden' onclick='Modal.showAlert(\"");
            W.push(g_js_strings.modal_build.whatsthiscontent);
            W.push("\");return false;'>");
            W.push(g_js_strings.modal_build.whatsthis);
            W.push("</a>");
            W.push("<span class='time'>" + g_js_strings.commonstr.time + ": ");
            W.push("<span id='buildTimeText'>");
            W.push(timestr(K));
            W.push("</span>");
            W.push("</span>");
            W.push("</div>");
            W.push("<div class='checkboxRow'style='visibility:hidden'>");
            W.push("<input id='askHelpCheckbox' type='checkbox'onclick='buildingController.askHelpCheckboxChanged(event)' />");
            W.push("<label for='askHelpCheckbox'>" + g_js_strings.modal_build.sharemessagebuildorresearch + "</label>");
            W.push("</div>");
            W.push("</div>");
            W.push("<div class='upgrade'>");
            W.push("<table cellpadding='0' cellspacing='0'><thead><tr><td class='lvcol'>" + g_js_strings.commonstr.lvl + "</td><td class='ycol'><div>" + g_js_strings.commonstr.yield + "</div></td></tr></thead><tbody>");
            if (aa > 0) {
                W.push("<tr><td class='lvcol'><div>");
                W.push(aa);
                W.push("</div><div class='cur'>" + g_js_strings.commonstr.current + "</div></td><td class='ycol'><div>");
                W.push(buildingupgradedesc[parseInt(y)][aa - 1]);
                W.push("</div></td></tr>")
            }
            W.push("<tr class='nextrow'><td class='lvcol'><div>");
            W.push(aa + 1);
            W.push("</div></td><td class='ycol'><div>");
            W.push(buildingupgradedesc[parseInt(y)][aa]);
            W.push("</div></td></tr>");
            W.push("</tbody></table>");
            W.push("<div style='clear:both;'>" + g_js_strings.modal_build.bonusinfo + "</div>");
            W.push("</div>");
            W.push("</div>");
            var U = false;
            var am = cm.ClientSideCookieManager.getCookie(ax);
            if ((am == null || am == "true") && seed.tutorial.t1 > 21) {
                U = true
            }
            var ah = {
                buildingId: y,
                currentLevel: aa,
                slotId: u,
                nextLevel: M,
                buildingTitle: p,
                image: B,
                baseTime: timestr(ai),
                speedTime: timestr(R),
                warStatus: parseInt(seed.player.warStatus),
                helped: U,
                tutorialMode: ab
            };
            buildingModel = new cm.BuildingModel(ah);
            var L = {
                askHelpCheckbox: "askHelpCheckbox",
                buildTimeText: "buildTimeText",
                whatIsThisLink: "modal_whats_this_link"
            }
        } else {
            if (aq == 2) {
                W.push("<div class='btns'><div class='clearfix btnrow'><a class='inlineButton25Red' name='" + z + "'");
                W.push(" onclick='cm.BuildingSpeedupController.popupClick(event)'>");
                W.push("<span>" + g_js_strings.commonstr.speedup + "</span></a></div><div><b>" + g_js_strings.modal_build.timeremaining + ": <span id='modal_build_timeremaining'>");
                W.push("</span></b></div>");
                if (getBuildHelpEligible(z, currentcityid) == false) {
                    W.push("<div class='clearfix btnrow' style='margin:10px 0px;'><a class='button25' onclick='build_gethelp(");
                    W.push(z);
                    W.push(");return false;'><span>" + g_js_strings.modal_quests.askhelp + "</span></a>");
                    W.push("<a class='helptext' onclick='Modal.showAlert(\"");
                    W.push(g_js_strings.modal_build.whatsthiscontent);
                    W.push("\");return false;'>");
                    W.push(g_js_strings.modal_build.whatsthis);
                    W.push("</a>");
                    W.push("</div>")
                }
                W.push("<div class='btnrow clearfix'><a onclick='cancelConstruction(" + aa + "," + u + "," + aa + ");return false;' class='button25' ><span>" + g_js_strings.modal_build.cancelcurrconstuct + "</span></a></div>");
                W.push("</div>")
            } else {
                if (aq == 1) {
                    W.push("<div class='btns'><div class='unable'>" + g_js_strings.modal_build.buildoneattime + "</div>");
                    W.push("<div class='upgrade'>");
                    W.push("<table cellpadding='0' cellspacing='0'><thead><tr><td class='lvcol'>" + g_js_strings.commonstr.lvl + "</td><td class='ycol'><div>" + g_js_strings.commonstr.yield + "</div></td></tr></thead><tbody>");
                    if (aa > 0) {
                        W.push("<tr><td class='lvcol'><div>");
                        W.push(aa);
                        W.push("</div><div class='cur'>" + g_js_strings.commonstr.current + "</div></td><td class='ycol'><div>");
                        W.push(buildingupgradedesc[parseInt(y)][aa - 1]);
                        W.push("</div></td></tr>")
                    }
                    W.push("<tr class='nextrow'><td class='lvcol'><div>");
                    W.push(aa + 1);
                    W.push("</div></td><td class='ycol'><div>");
                    W.push(buildingupgradedesc[parseInt(y)][aa]);
                    W.push("</div></td></tr>");
                    W.push("</tbody></table>");
                    W.push("</div>");
                    W.push("</div>")
                } else {
                    W.push("<div class='btns'><div class='unable'>" + g_js_strings.modal_build.reqnotmet + "</div>");
                    W.push("<div class='upgrade'>");
                    W.push("<table cellpadding='0' cellspacing='0'><thead><tr><td class='lvcol'>" + g_js_strings.commonstr.lvl + "</td><td class='ycol'><div>" + g_js_strings.commonstr.yield + "</div></td></tr></thead><tbody>");
                    if (aa > 0) {
                        W.push("<tr><td class='lvcol'><div>");
                        W.push(aa);
                        W.push("</div><div class='cur'>" + g_js_strings.commonstr.current + "</div></td><td class='ycol'><div>");
                        W.push(buildingupgradedesc[parseInt(y)][aa - 1]);
                        W.push("</div></td></tr>")
                    }
                    W.push("<tr class='nextrow'><td class='lvcol'><div>");
                    W.push(aa + 1);
                    W.push("</div></td><td class='ycol'><div>");
                    W.push(buildingupgradedesc[parseInt(y)][aa]);
                    W.push("</div></td></tr>");
                    W.push("</tbody></table>");
                    W.push("</div>");
                    W.push("</div>")
                }
            }
        }
        W.push("</div>")
    } else {
        var aq = 0;
        var au = seed.queue_con["city" + currentcityid];
        if (au.length > 0) {
            aq = 1;
            for (var I = 0; I < au.length; I++) {
                if (parseInt(u) == parseInt(au[I][7])) {
                    aq = 2;
                    s = parseInt(au[I][4]) - parseInt(au[I][3]);
                    z = au[I][2];
                    break
                }
            }
        }
        if (aq == 2) {
            W.push("<div class='btns'><div class='clearfix btnrow'><a  class='button25' onclick='build_speedup(");
            W.push(z);
            W.push(");return false;'><span>" + g_js_strings.commonstr.speedup + "</span></a></div><div><b>" + g_js_strings.modal_build.timeremaining + ": <span id='modal_build_timeremaining'>");
            W.push("</span></b></div>");
            W.push("<br/><div class='btnrow'><a onclick='cancelConstruction(" + aa + "," + u + ");return false;' class='button25' ><span>" + g_js_strings.modal_build.cancelcurrconstuct + "</span></a></div>");
            W.push("</div>")
        }
        W.push("<div class='reqhd'>&nbsp;</div><div class='buildreq clearfix' style='background:none;'><div class='btns' style='left:0;'>");
        W.push("<div class='upgrade'>");
        W.push("<table cellpadding='0' cellspacing='0'><thead><tr><td class='lvcol'>" + g_js_strings.commonstr.lvl + "</td><td class='ycol'><div>" + g_js_strings.commonstr.yield + "</div></td></tr></thead><tbody>");
        W.push("<tr><td class='lvcol'><div>");
        W.push(aa);
        W.push("</div><div class='cur'>" + g_js_strings.commonstr.current + "</div></td><td class='ycol'><div>");
        W.push(buildingupgradedesc[parseInt(y)][aa - 1]);
        W.push("</div></td></tr>");
        W.push("</tbody></table>");
        W.push("</div>");
        W.push("</div></div>")
    }
    W.push("</div>");
    W.push("<div class='buildingdetailbottom'></div>");
    W.push("</div>");
    W.push("<div id='modal_build_resourcebar' class='modal_build_resourcebar'>");
    W.push("</div>");
    W.push("<div id='modal_build_content' class='modal_build_content'>");
    W.push("</div>");
    W.push("</div>");
    W.push("<div id='modal_build_foot' class='clearfix'>");
    W.push("<img src='");
    W.push(stimgUrl);
    W.push("img/build_asterisk.png'/>");
    W.push(g_js_strings.modal_build.newreducebuildtimedesc);
    W.push("</div>");
    if (cm.TutorialManager.inTutorialMode()) {
        Modal.showModal(740, 400, 10, 10, p, W.join(""));
        cm.TutorialEventDispatcher.dispatchTutorialEvent("complete", "CHOOSE_SAWMILL");
        cm.TutorialEventDispatcher.dispatchTutorialEvent("complete", "CHOOSE_COTTAGE")
    } else {
        if (parseInt(y) == 0) {
            Modal.showModal(740, 400, 10, 10, p, W.join(""), function () {
                if (aa > 0) {
                    openCastle();
                    buildtutorial(y)
                }
            })
        } else {
            if (parseInt(y) == 7) {
                Modal.showModal(740, 400, 10, 10, p, W.join(""), function () {
                    if (aa > 0) {
                        openKnights();
                        buildtutorial(y)
                    }
                })
            } else {
                if (parseInt(y) == 8) {
                    Modal.showModal(740, 400, 10, 10, p, W.join(""), function () {
                        if (aa > 0) {
                            openEmbassy();
                            buildtutorial(y, aa)
                        }
                    })
                } else {
                    if (parseInt(y) == 11) {
                        Modal.showModal(740, 400, 10, 10, p, W.join(""), function () {
                            if (aa > 0) {
                                modal_openAlchemy();
                                buildtutorial(y, aa)
                            }
                        })
                    } else {
                        if (parseInt(y) == 13) {
                            Modal.showModal(740, 400, 10, 10, p, W.join(""), function () {
                                if (aa > 0) {
                                    modal_openBarracks();
                                    buildtutorial(y, aa)
                                }
                            })
                        } else {
                            if (parseInt(y) == 10) {
                                Modal.showModal(740, 400, 10, 10, p, W.join(""), function () {
                                    if (aa > 0) {
                                        modal_openMarket(aa);
                                        buildtutorial(y, aa)
                                    }
                                })
                            } else {
                                if (parseInt(y) == 12) {
                                    Modal.showModal(740, 400, 10, 10, p, W.join(""), function () {
                                        if (aa > 0) {
                                            modal_openRallypoint();
                                            buildtutorial(y, aa)
                                        }
                                    })
                                } else {
                                    if (parseInt(y) == 19) {
                                        Modal.showModal(740, 400, 10, 10, p, W.join(""), function () {
                                            if (aa > 0) {
                                                modal_openWalls();
                                                buildtutorial(y, aa)
                                            }
                                        })
                                    } else {
                                        if (~~ (1 * y) == 20) {
                                            if (c == null) {
                                                var N = ~~ (1 * u);
                                                ah = seed.buildings["city" + currentcityid]["pos" + u], buildingId = r, currentLevel = 0, nextLevel = 1, buildingTitle = g_js_strings.modal_build.newbuilding + " - " + buildingcost["bdg" + y][0] + " " + g_js_strings.commonstr.lv + "1", buildingImageLevel = 1
                                            } else {
                                                var N = ~~ (1 * u);
                                                ah = seed.buildings["city" + currentcityid]["pos" + u], buildingId = c[0], currentLevel = ~~ (1 * c[1]), nextLevel = currentLevel + 1, buildingTitle = buildingcost["bdg" + buildingId][0] + " " + g_js_strings.commonstr.lv + currentLevel, buildingImageLevel = (nextLevel > 5) ? 5 : 1
                                            }
                                            var ab = cm.TutorialManager.inTutorialMode(),
                                                ap = checkreq("bdg", buildingId, nextLevel),
                                                ay = [],
                                                az = [],
                                                a = false,
                                                m = true,
                                                av;
                                            if (currentLevel > 0 && N != 0 && N != 1 && !ab) {
                                                az.push("<div class='button'>");
                                                az.push("<a class='deconstruct' onclick='deconstructBuilding(" + ah[3] + "," + N + ");'>");
                                                az.push("<span>" + g_js_strings.commonstr.decontruct + "</span>");
                                                az.push("</a>");
                                                az.push("</div>");
                                                if (currentLevel > 1) {
                                                    az.push("<div class='button'>");
                                                    az.push("<a class='destroy' onclick='destructBuilding(" + ah[3] + "," + N + ");'>");
                                                    az.push("<span>" + g_js_strings.commonstr.destroy + "</span>");
                                                    az.push("</a>");
                                                    az.push("</div>")
                                                }
                                            } else {
                                                if (N == 0 && seed.cities.length > 1) {
                                                    az.push("<div class='button'>");
                                                    az.push("<a class='abandon' onclick='cityaction_abandonprompt();'> <span>" + g_js_strings.modal_build.abandoncity + "</span></a>");
                                                    az.push("<p>(" + g_js_strings.modal_build.usedragon + ")</p>");
                                                    az.push("</div>")
                                                }
                                            }
                                            for (var I = 0, Y = ap[0].length; I < Y; ++I) {
                                                if (typeof ap[1][I] != "string" || ap[1][I].indexOf("Lv.0") == -1) {
                                                    if (ap[3][I] == 0) {
                                                        a = false;
                                                        m = false
                                                    } else {
                                                        if (H == 0 && currentLevel >= 10 && buildingId == 0) {
                                                            if (getBuildingLevel(19) >= currentLevel) {
                                                                a = true
                                                            } else {
                                                                a = false;
                                                                m = false
                                                            }
                                                        } else {
                                                            a = true
                                                        }
                                                    }
                                                    if (I % 2 == 0) {
                                                        av = "even"
                                                    } else {
                                                        av = "odd"
                                                    }
                                                    ay.push(" <tr class='" + av + "'> ");
                                                    ay.push(" <td> " + ap[0][I] + " </td> ");
                                                    if (a) {
                                                        ay.push(" <td class='met'> ")
                                                    } else {
                                                        ay.push(" <td class='unmet'> ")
                                                    }
                                                    if (ap[1][I] > 0) {
                                                        ay.push(addCommas(ap[1][I]))
                                                    } else {
                                                        if (currentLevel >= 10 && buildingId == 0) {
                                                            ay.push(_js_strings.commonstr.lv + currentLevel + " " + buildingcost.bdg19[0])
                                                        } else {
                                                            ay.push(ap[1][I])
                                                        }
                                                    }
                                                    ay.push(" <td> ");
                                                    if (ap[2][I] > 0) {
                                                        ay.push(addCommas(ap[2][I]))
                                                    } else {
                                                        ay.push(ap[2][I])
                                                    }
                                                    ay.push(" </td> ");
                                                    ay.push(" </tr> ")
                                                }
                                            }
                                            if (currentLevel >= 9) {
                                                var V = 401;
                                                if (buildingId == 0) {
                                                    if (currentLevel == 10) {
                                                        V = 402
                                                    } else {
                                                        if (currentLevel == 11) {
                                                            V = 404
                                                        }
                                                    }
                                                } else {
                                                    if (currentLevel > 10) {
                                                        V = 403
                                                    }
                                                }
                                                if (av == "even") {
                                                    ay.push(" <tr class='odd'> ")
                                                } else {
                                                    ay.push(" <tr class='even'> ")
                                                }
                                                ay.push(" <td> " + itemlist["i" + V].name + " </td> ");
                                                if (ksoItems[V].count > 0) {
                                                    ay.push(" <td class='met'> 1 </td> ")
                                                } else {
                                                    ay.push(" <td class='unmet'> 1 </td> ")
                                                }
                                                ay.push(" <td> " + addCommas(ksoItems[V].count) + " </td> ");
                                                ay.push(" </tr> ")
                                            }
                                            var l = seed.queue_con["city" + currentcityid],
                                                ak = 0,
                                                E = 0,
                                                Q = 0,
                                                aj = [],
                                                ae = [],
                                                T, G, v = seed.knights["city" + currentcityid],
                                                S, f = 0,
                                                ao, x, b = Math.pow(2, currentLevel),
                                                aw, ad, P, af;
                                            var T, G;
                                            if (l.length > 0) {
                                                ak = 1;
                                                for (var I = 0, Y = l.length; I < Y; ++I) {
                                                    if (N == parseInt(l[I][7])) {
                                                        ak = 2;
                                                        E = parseInt(au[I][4]) - parseInt(au[I][3]);
                                                        Q = l[I][2];
                                                        break
                                                    }
                                                }
                                            }
                                            if (ak == 0) {
                                                if (currentLevel > 0) {
                                                    T = g_js_strings.commonstr.upgrade;
                                                    G = g_js_strings.modal_build.sharemessagebuildorresearch
                                                } else {
                                                    T = g_js_strings.commonstr.build;
                                                    G = g_js_strings.modal_build.sharemessagebuildorresearch
                                                }
                                                if (v) {
                                                    ao = seed.leaders["city" + currentcityid].politicsKnightId;
                                                    S = v[ao];
                                                    if (S) {
                                                        f = ~~ (1 * S.politics);
                                                        x = ~~ (1 * S.politicsBoostExpireUnixtime);
                                                        if ((x - unixtime()) > 0) {
                                                            f = f * 1.25
                                                        }
                                                    }
                                                }
                                                aw = buildingcost["bdg" + buildingId][7] * b;
                                                if (buildingId < 6 && buildingId > 0 && b == 1) {
                                                    aw = 15
                                                }
                                                af = ~~ (1 * seed.tech.tch16);
                                                aw = parseInt(aw / (1 + 0.005 * f + 0.1 * af));
                                                ad = Math.max(600, aw * 0.1);
                                                P = (aw - ad) < 0 ? 0 : (aw - ad);
                                                if (a) {
                                                    info = "<div class='timeLeftContainer'>";
                                                    info += "<span class='label'>" + g_js_strings.commonstr.time + ":</span>";
                                                    info += "<span id='buildTimeText' class='time'>" + timestr(aw) + "</span>";
                                                    info += "</div>"
                                                } else {
                                                    info = "<p class='notmet'>" + g_js_strings.modal_build.reqnotmet + "</p>"
                                                }
                                                if (aa < parseInt(buildingmaxlvl[y])) {
                                                    if (cm.WorldSettings.isOn("DARK_FOREST_CRAFTING_KILLSWITCH")) {
                                                        if (!m) {
                                                            var q = cm.Template.renderTemplate("Building", "buildContainer0", {
                                                                info: info,
                                                                shareContent: G,
                                                                buttonLabel: T,
                                                                buttonClass: "gray"
                                                            })
                                                        } else {
                                                            var q = cm.Template.renderTemplate("Building", "buildContainer0", {
                                                                info: info,
                                                                shareContent: G,
                                                                buttonLabel: T,
                                                                buttonClass: "blue"
                                                            })
                                                        }
                                                    } else {
                                                        var q = cm.Template.renderTemplate("Building", "buildContainer0", {
                                                            info: info,
                                                            shareContent: G,
                                                            buttonLabel: T,
                                                            buttonClass: "gray"
                                                        })
                                                    }
                                                }
                                            } else {
                                                if (ak == 1) {
                                                    if (currentLevel > 0) {
                                                        T = g_js_strings.commonstr.upgrade;
                                                        G = g_js_strings.modal_build.sharemessagebuildorresearch
                                                    } else {
                                                        T = g_js_strings.commonstr.build;
                                                        G = g_js_strings.modal_build.sharemessagebuildorresearch
                                                    }
                                                    if (aa < parseInt(buildingmaxlvl[y])) {
                                                        var q = cm.Template.renderTemplate("Building", "buildContainer1", {
                                                            warning: g_js_strings.modal_build.buildoneattime,
                                                            shareContent: G,
                                                            buttonLabel: T,
                                                            buttonClass: "gray",
                                                            curlv: currentLevel,
                                                            slotid: N
                                                        })
                                                    }
                                                } else {
                                                    if (ak == 2) {
                                                        if (aa < parseInt(buildingmaxlvl[y])) {
                                                            var q = cm.Template.renderTemplate("Building", "buildContainer2", {
                                                                timeLabel: g_js_strings.guardian.upgradeStr,
                                                                cancelLabel: g_js_strings.commonstr.cancel,
                                                                speedLabel: g_js_strings.commonstr.speedup,
                                                                askLabel: g_js_strings.modal_quests.askhelp,
                                                                curlv: currentLevel,
                                                                slotid: N
                                                            })
                                                        }
                                                    }
                                                }
                                            }
                                            if (aa < parseInt(buildingmaxlvl[y])) {
                                                var o = cm.Template.renderTemplate("Building", "benefitsContainer", {
                                                    benefitLabel: g_js_strings.commonstr.upgrade + " " + g_js_strings.commonstr.benefits,
                                                    currentLevelLabel: g_js_strings.commonstr.ccurrent + " " + g_js_strings.commonstr.level,
                                                    currentLevelValue: currentLevel,
                                                    currentLevelHint: g_js_strings.crafting.currentLevelHint.replace("%1$s", currentLevel),
                                                    nextLevelLabel: g_js_strings.commonstr.next + " " + g_js_strings.commonstr.level,
                                                    nextLevelValue: nextLevel,
                                                    nextLevelHint: g_js_strings.crafting.nextLevelHint.replace("%1$s", nextLevel)
                                                })
                                            } else {
                                                var o = cm.Template.renderTemplate("Building", "benefitsContainerMax", {
                                                    benefitLabel: g_js_strings.commonstr.upgrade + " " + g_js_strings.commonstr.benefits,
                                                    currentLevelLabel: g_js_strings.commonstr.ccurrent + " " + g_js_strings.commonstr.level,
                                                    currentLevelValue: currentLevel,
                                                    currentLevelHint: g_js_strings.crafting.currentLevelHint.replace("%1$s", currentLevel)
                                                })
                                            }
                                            var F = cm.Template.renderTemplate("Building", "openBuilding", {
                                                title: buildingcost["bdg" + buildingId][0],
                                                buildingId: buildingId,
                                                buttons: az.join(""),
                                                buildingDescription: buildingcost["bdg" + buildingId][10],
                                                buildContainer: q,
                                                requirementLabel: g_js_strings.commonstr.upgrade + " " + g_js_strings.commonstr.requirements,
                                                requirementRows: ay.join(""),
                                                benefitsContainerHTML: o,
                                                craft: cm.CraftingView.openCrafting()
                                            });
                                            Modal.showModal(780, 400, 10, 10, "", F, function () {
                                                var aH = false,
                                                    aE = ~~ (1 * seed.player.warStatus);
                                                jQuery("#buildingCloseButton").click(function () {
                                                    Modal.hideModal()
                                                });
                                                var aD = kocRecipes[1],
                                                    aF = kocRecipes[1][0],
                                                    i = cm.CraftingView.feySpire,
                                                    aB = (i) ? ~~ (1 * cm.CraftingView.feySpireLevel) : 0,
                                                    aG = ~~ (1 * aF.requirements.building),
                                                    aC = ksoItems[aF.output].name,
                                                    aI = (aF.consolation) ? ksoItems[aF.consolation].name : null,
                                                    aA;
                                                jQuery.each(seed.buildings["city" + currentcityid], function (aK, aJ) {
                                                    if (aJ[0] == "20" || aJ[0] == 20) {
                                                        cm.CraftingView.feySpire = aJ;
                                                        cm.CraftingView.feySpireLevel = aJ[1];
                                                        return false
                                                    } else {
                                                        cm.CraftingView.feySpire = null;
                                                        cm.CraftingView.feySpireLevel = 0
                                                    }
                                                });
                                                if (cm.WorldSettings.isOn("DARK_FOREST_CRAFTING_KILLSWITCH")) {
                                                    if (aB >= aG) {
                                                        jQuery("#recipeCraftButton").bind("click", function () {
                                                            cm.RecipeController.craft(aF)
                                                        })
                                                    } else {
                                                        jQuery("#recipeCraftButton").unbind("click")
                                                    }
                                                } else {
                                                    jQuery("#recipeCraftButton").bind("mouseover", function (aJ) {
                                                        Tooltip.show(aJ, g_js_strings.crafting.craftingDisabled, [-100, 50])
                                                    });
                                                    jQuery("#recipeCraftButton").bind("mouseout", function () {
                                                        Tooltip.hide()
                                                    })
                                                }
                                                if (ak == 0) {
                                                    if (cm.WorldSettings.isOn("DARK_FOREST_CRAFTING_KILLSWITCH") || m) {
                                                        if (m) {
                                                            jQuery("#buildingBuildButton").click(function () {
                                                                var aJ = jQuery("#askHelpCheckbox:checked");
                                                                if (aJ.length >= 1) {
                                                                    aH = true
                                                                }
                                                                if (buildingId == 0 && N == 0 && currentLevel == 4 && aE == 2) {
                                                                    protect_off_confirm(buildingId, currentLevel, N, aH)
                                                                } else {
                                                                    build(buildingId, currentLevel, N, aH)
                                                                }
                                                            })
                                                        }
                                                    } else {
                                                        jQuery("#buildingBuildButton").bind("mouseover", function (aJ) {
                                                            Tooltip.show(aJ, g_js_strings.crafting.craftingDisabled, [-100, 50])
                                                        });
                                                        jQuery("#buildingBuildButton").bind("mouseout", function () {
                                                            Tooltip.hide()
                                                        })
                                                    }
                                                } else {
                                                    if (ak == 2) {
                                                        jQuery("#buildingCancelButton").click(function () {
                                                            cancelConstruction(currentLevel, u, currentLevel)
                                                        });
                                                        jQuery("#buildingSpeedButton").click(function () {
                                                            modal_speedup("bdg", Q, u)
                                                        });
                                                        jQuery("#buildingAskButton").click(function () {
                                                            build_gethelp(Q)
                                                        });
                                                        var j = seed.queue_con["city" + currentcityid][0][4] - unixtime();
                                                        CountDown.addCountDown("upgradeTimeLeft", j, function () {
                                                            Modal.hideModal();
                                                            modal_build(u)
                                                        })
                                                    }
                                                }
                                                jQuery("#itemFrame").bind("mouseover", function (aJ) {
                                                    aA = g_js_strings.crafting.hoverOutputMessage.replace("%1$s", aC);
                                                    Tooltip.show(aJ, aA, [-50, 0])
                                                });
                                                jQuery("#itemFrame").bind("mouseout", function () {
                                                    Tooltip.hide()
                                                });
                                                jQuery("#recipeConsolationItem").bind("mouseover", function (aJ) {
                                                    if (aI != null) {
                                                        aA = g_js_strings.crafting.hoverConsolationMessage.replace("%1$s", aI)
                                                    } else {
                                                        aA = g_js_strings.crafting.hoverConsolationMessage2
                                                    }
                                                    Tooltip.show(aJ, aA, [-10, 5])
                                                });
                                                jQuery("#recipeConsolationItem").bind("mouseout", function () {
                                                    Tooltip.hide()
                                                });
                                                jQuery("#askHelpCheckbox").bind("click", function (aJ) {
                                                    buildingController.askHelpCheckboxChanged(aJ)
                                                })
                                            }, null, null, {
                                                additionalClass: "feySpire"
                                            })
                                        } else {
                                            if (y == cm.BUILDING_TYPES.WATCH_TOWER) {
                                                var X = aa > 0;
                                                if (X) {
                                                    Modal.onCloseCallback = function () {
                                                        al.remove()
                                                    }
                                                }
                                                Modal.showModal(740, 400, 10, 10, p, W.join(""), function () {
                                                    if (aa > 0) {
                                                        buildtutorial(y, aa)
                                                    }
                                                });
                                                if (X) {
                                                    var ag = document.createElement("div");
                                                    ag.className = "modal_build_content";
                                                    ag.innerHTML = '<div class="tabsbar"><a class="tab selected" style="width:auto;font:bold 11px Georgia"><span style="padding:0px 20px">' + g_js_strings.modaltitles.impatks + "</span></a></div>";
                                                    var J = document.createElement("div");
                                                    J.className = "modal_tab_content";
                                                    ag.appendChild(J);
                                                    var ar = $("modal_build_foot");
                                                    ar.parentNode.insertBefore(ag, ar);
                                                    var O = {
                                                        text: {
                                                            impendingAttacks: "Impending Attacks",
                                                            marchType: "March Type",
                                                            target: "Target",
                                                            timeRemaining: "Time Remaining",
                                                            status: "Status"
                                                        },
                                                        attacks: cm.IncomingAttackManager.getAllAttacks(),
                                                        recalledAttacks: cm.IncomingAttackManager.getRecalledAttacks(),
                                                        parentElement: J
                                                    };
                                                    var al = new cm.ImpendingAttackReport(O);
                                                    al.show()
                                                }
                                            } else {
                                                Modal.showModal(740, 400, 10, 10, p, W.join(""), function () {
                                                    if (aa > 0) {
                                                        buildtutorial(y, aa)
                                                    }
                                                })
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    if (buildingModel) {
        buildingView = new cm.BuildingView(L, buildingModel);
        buildingController = new cm.BuildingController(buildingModel, buildingView)
    }
}

function cancelConstruction(f, g) {
    var l = new Array();
    l.push("<div id='modal_lv10'>");
    l.push("<div class='lv10 clearfix'>");
    l.push("<div class='info' style='margin-left: 10px; width: 340px;'><div class='ttl'>");
    l.push(g_js_strings.cancelconstruction.cancelconstructiontakes);
    if (seed.buildings["city" + currentcityid]["pos" + g]) {
        bldType = seed.buildings["city" + currentcityid]["pos" + g][0];
        bldLvl = seed.buildings["city" + currentcityid]["pos" + g][1];
        if (bldLvl > 0) {
            var b = Math.pow(2, (bldLvl - 1));
            var i = checkreq("bdg", bldType, bldLvl);
            var d = new Array();
            l.push("<table cellpadding='2' cellspacing='0'><tbody><tr>");
            var e = [resourceinfo.rec1, resourceinfo.rec2, resourceinfo.rec3, resourceinfo.rec4];
            var a = 1;
            for (var c = 0; c < i[0].length; c++) {
                if (e.indexOf(i[0][c]) != -1) {
                    var h = new Array();
                    h.push("<td class='recdesc'>" + i[0][c] + "</td>");
                    if (parseInt(i[1][c]) > 0) {
                        h.push("<td class='rec'>" + addCommas(parseInt(i[1][c])) + "</td>")
                    } else {
                        h.push("<td class='rec'>" + i[1][c] + "</td>")
                    }
                    if (a % 2 == 0) {
                        l.push(h.join("") + "</tr>")
                    } else {
                        l.push(h.join(""))
                    }
                    a++
                }
            }
            if (bldLvl >= 9) {
                var m = itemlist.i401.name;
                if (g == 0) {
                    if (bldLvl == 10) {
                        m = itemlist.i402.name
                    } else {
                        if (bldLvl == 11) {
                            m = itemlist.i404.name
                        }
                    }
                } else {
                    if (bldLvl > 10) {
                        m = itemlist.i403.name
                    }
                }
                l.push('<tr><td colspan="4" class="warning">');
                l.push(cm.StringFormatter.applyTemplate(g_js_strings.cancelconstruction.cancelconstructionloseitem, {
                    itemName: m
                }));
                l.push("</td></tr>")
            }
            l.push("</tbody></table>")
        }
    } else {
        l.push(g_js_strings.deconstructBuilding.deconstructinvalid)
    }
    l.push("</div></div>");
    l.push("</div>");
    l.push("<div class='btns clearfix'>");
    l.push("<a  class='button20' onclick='removeConstruction(" + g + "," + f + ");return false;'><span>" + g_js_strings.cancelconstruction.cancelconstruction + "</span></a>");
    l.push("<a  class='cancel' onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    l.push("</div></div>");
    Modal.showModal(400, 400, 130, 130, g_js_strings.cancelconstruction.cancelconstructiontitle, l.join(""))
}

function removeConstruction(bldSlotId, currLevel, paramsOverride) {
    var params = Object.clone(g_ajaxparams);
    if (paramsOverride) {
        params = paramsOverride
    }
    params.requestType = "CANCEL_CONSTRUCTION";
    params.cityId = currentcityid;
    params.buildingPosition = bldSlotId;
    params.buildingId = seed.buildings["city" + currentcityid]["pos" + bldSlotId][3];
    new Ajax.Request(g_ajaxpath + "ajax/cancelConstruction.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            cm.MarchModal.setBackedOff(false);
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                var tgtlv = parseInt(seed.queue_con["city" + currentcityid][0][1]);
                seed.queue_con["city" + currentcityid] = [];
                Modal.hideModalAll();
                if (currLevel == 0) {
                    removeCityFromView(bldSlotId)
                } else {} if ($("mod_views_city").hasClassName("sel")) {
                    changeview_city($("mod_views_field"))
                } else {
                    if ($("mod_views_field").hasClassName("sel")) {
                        changeview_fields($("mod_views_field"))
                    }
                }
                bldLvl = seed.buildings["city" + currentcityid]["pos" + bldSlotId][1];
                bdgType = seed.buildings["city" + currentcityid]["pos" + bldSlotId][0];
                if (bldLvl > 0 && tgtlv != 0) {
                    mult = Math.pow(2, (bldLvl - 1));
                    seed.resources["city" + currentcityid].rec1[0] += parseInt(buildingcost["bdg" + bdgType][1]) * mult * 3600;
                    seed.resources["city" + currentcityid].rec2[0] += parseInt(buildingcost["bdg" + bdgType][2]) * mult * 3600;
                    seed.resources["city" + currentcityid].rec3[0] += parseInt(buildingcost["bdg" + bdgType][3]) * mult * 3600;
                    seed.resources["city" + currentcityid].rec4[0] += parseInt(buildingcost["bdg" + bdgType][4]) * mult * 3600;
                    seed.citystats["city" + currentcityid].gold[0] += parseInt(buildingcost["bdg" + bdgType][5]) * mult;
                    update_gold()
                }
                update_bdg()
            } else {
                processUserAction(rslt, function () {
                    removeConstruction(bldSlotId, currLevel, params)
                }, params)
            }
        },
        onFailure: function () {
            cm.MarchModal.setBackedOff(false)
        }
    })
}

function deconstructBuilding(a, h) {
    var n = new Array();
    n.push("<div id='modal_lv10'>");
    n.push("<div class='lv10 clearfix'>");
    n.push("<div class='info' style='margin-left: 10px; width: 340px;'><div class='ttl'>");
    if (seed.buildings["city" + currentcityid]["pos" + h]) {
        bldType = seed.buildings["city" + currentcityid]["pos" + h][0];
        bldLvl = seed.buildings["city" + currentcityid]["pos" + h][1] - 1;
        var o = seed.knights["city" + currentcityid];
        var b = 0;
        if (o) {
            o = o["knt" + seed.leaders["city" + currentcityid].politicsKnightId];
            if (o) {
                b = parseInt(o.politics)
            }
        }
        if (bldLvl == 0) {
            n.push(g_js_strings.deconstructBuilding.lvl1deconstructdesc)
        }
        if (bldLvl > 0) {
            var d = Math.pow(2, (bldLvl - 1));
            var i = buildingcost["bdg" + bldType][7] * d;
            if (parseInt(bldType) < 6 && parseInt(bldType) > 0 && d == 1) {
                i = 15
            }
            i = parseInt(i / (1 + 0.005 * b + 0.1 * parseInt(seed.tech.tch16)));
            n.push(g_js_strings.deconstructBuilding.deconstructtakes.replace("%1$s", timestr(i)));
            var m = checkreq("bdg", bldType, bldLvl);
            var g = new Array();
            n.push("<table cellpadding='2' cellspacing='0'><tbody><tr>");
            var f = [resourceinfo.rec1, resourceinfo.rec2, resourceinfo.rec3, resourceinfo.rec4];
            var c = 1;
            for (var e = 0; e < m[0].length; e++) {
                if (f.indexOf(m[0][e]) != -1) {
                    var l = new Array();
                    l.push("<td class='recdesc'>" + m[0][e] + "</td>");
                    if (parseInt(m[1][e]) > 0) {
                        l.push("<td class='rec'>" + addCommas(parseInt(m[1][e])) + "</td>")
                    } else {
                        l.push("<td class='rec'>" + m[1][e] + "</td>")
                    }
                    if (c % 2 == 0) {
                        n.push(l.join("") + "</tr>")
                    } else {
                        n.push(l.join(""))
                    }
                    c++
                }
            }
            n.push("</tbody></table>")
        }
    } else {
        n.push(g_js_strings.deconstructBuilding.deconstructinvalid)
    }
    n.push("</div></div>");
    n.push("</div>");
    n.push("<div class='btns clearfix'>");
    n.push("<a  class='button20' onclick='deleteaction(" + bldType + "," + (bldLvl + 1) + "," + h + ");return false;'><span>" + g_js_strings.commonstr.decontruct + "</span></a>");
    n.push("<a  class='cancel' onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    n.push("</div></div>");
    Modal.showModal(400, 400, 130, 130, g_js_strings.modaltitles.deconstructbuild, n.join(""))
}

function deleteaction(bdgid, curlvl, citpos, gethelp) {
    if (bdgid == "20" || bdgid == 20) {
        if (seed.queue_craft["city" + currentcityid].length > 0) {
            var msg = g_js_strings.deleteaction.craftQueueFull;
            Modal.showAlert(msg);
            return false
        }
    }
    var mult = 0;
    var pollv = 0;
    var time = 0;
    var knt = seed.knights["city" + currentcityid];
    if (knt) {
        knt = knt["knt" + seed.leaders["city" + currentcityid].politicsKnightId];
        if (knt) {
            pollv = parseInt(knt.politics)
        }
    }
    if (curlvl > 1) {
        mult = Math.pow(2, curlvl - 1);
        time = buildingcost["bdg" + bdgid][7] * mult
    }
    if (parseInt(bdgid) < 6 && parseInt(bdgid) > 0 && mult == 1) {
        time = 15
    }
    time = time / (1 + 0.005 * pollv + 0.1 * parseInt(seed.tech.tch16));
    if (time % 1 > 0) {
        time = parseInt(time)
    }
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    params.bid = "";
    params.pos = citpos;
    params.lv = curlvl - 1;
    if (curlvl > 0) {
        params.bid = seed.buildings["city" + currentcityid]["pos" + citpos][3]
    }
    params.type = bdgid;
    new Ajax.Request(g_ajaxpath + "ajax/destruct.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                cm.sounds.play("demolish_building");
                time = rslt.timeNeeded;
                seed.queue_con["city" + currentcityid].push([bdgid, 0, parseInt(rslt.buildingId), unixtime(), unixtime() + time, 0, time, parseInt(citpos)]);
                Modal.hideModalAll();
                update_bdg();
                queue_changetab_building();
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
            } else {
                if (rslt.tracker) {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                } else {
                    var msg = (rslt.msg) ? rslt.msg : g_js_strings.deleteaction.somethingwentwrong;
                    Modal.showAlert(msg)
                }
            }
        },
        onFailure: function () {}
    })
}

function destructBuilding(b, a) {
    var c = new Array();
    c.push("<div id='modal_lv10'>");
    c.push("<div class='lv10 clearfix'>");
    c.push("<img src='");
    c.push(stimgUrl);
    c.push("img/items/70/9.jpg'/>");
    c.push("<div class='info'><div class='ttl'>");
    c.push(g_js_strings.destructBuilding.needtodestruct.replace("%1$s", itemlist.i9.name));
    c.push("</div><div class='own'>" + g_js_strings.commonstr.youown + ": ");
    if (seed.items.i9 > 0) {
        c.push(seed.items.i9)
    } else {
        c.push(0)
    }
    c.push("</div></div>");
    c.push("</div>");
    c.push("<div class='btns clearfix'>");
    if (seed.items.i9 > 0) {
        c.push("<a  class='button20' onclick='destructBuildingConfirm(" + b + "," + a + ");return false;'><span>" + g_js_strings.commonstr.destroy + "</span></a>")
    } else {
        c.push("<a  class='button20' onclick='Modal.hideModalAll();cm.ShopView.openShop();return false;'><span>" + g_js_strings.commonstr.getmore + "</span></a>")
    }
    c.push("<a  class='cancel' onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    c.push("</div></div>");
    Modal.showModal(400, 400, 130, 130, g_js_strings.modaltitles.destroybuild, c.join(""))
}

function destructBuildingConfirm(buildingId, bldSlotId) {
    var params = Object.clone(g_ajaxparams);
    params.requestType = "DESTROY_BUILDING_DRAGON_STOMP_MEDAL";
    params.cityId = currentcityid;
    params.buildingId = buildingId;
    params.pos = bldSlotId;
    new Ajax.Request(g_ajaxpath + "ajax/destroyBuilding.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                cm.sounds.play("destroy_building");
                Modal.hideModalAll();
                Modal.showAlert(g_js_strings.destructbuildingconfirm.builddestroyed);
                var bdgLvl = seed.buildings["city" + currentcityid]["pos" + bldSlotId][1];
                var bdgType = seed.buildings["city" + currentcityid]["pos" + bldSlotId][0];
                seed.items.i9 = Number(seed.items.i9) - 1;
                ksoItems[9].subtract();
                removeCityFromView(bldSlotId);
                if ($("mod_views_city").hasClassName("sel")) {
                    changeview_city($("mod_views_field"))
                } else {
                    if ($("mod_views_field").hasClassName("sel")) {
                        changeview_fields($("mod_views_field"))
                    }
                }
                var plyrMight = parseInt(seed.player.might);
                for (var j = bdgLvl - 1; j > -1; j--) {
                    plyrMight -= buildingmight[parseInt(bdgType)][j]
                }
                seed.player.might = plyrMight;
                update_might();
                if (!buildingmulti["b" + bdgType] && maxbdglvl["b" + bdgType]) {
                    delete maxbdglvl["b" + bdgType]
                }
                if (bdgType > 0 && bdgType < 5) {
                    var laborForce = parseInt(seed.citystats["city" + currentcityid]["pop"][3]);
                    var resCap = parseInt(seed.citystats["city" + currentcityid]["pop"][3]) + bdglvl * 10;
                    for (k = bdgLvl; k > 0; k--) {
                        laborForce -= k * 10
                    }
                    seed.citystats["city" + currentcityid]["pop"][3] = laborForce;
                    seed.citystats["city" + currentcityid]["pop"][3] = parseInt(seed.citystats["city" + currentcityid]["pop"][3]) + bdglvl * 10
                } else {
                    if (bdgType == 5) {
                        var popCap = seed.citystats["city" + currentcityid]["pop"][1];
                        var pop = seed.citystats["city" + currentcityid]["pop"][0];
                        for (k = bdgLvl; k > 0; k--) {
                            popCap -= k * 100
                        }
                        if (popCap < 51) {
                            popCap = 50
                        }
                        if (pop > popCap) {
                            seed.citystats["city" + currentcityid]["pop"][0] = popCap
                        }
                        seed.citystats["city" + currentcityid]["pop"][1] = popCap
                    } else {
                        if (bdgType == cm.BUILDING_TYPES.WATCH_TOWER) {
                            var watchTower = cm.WatchTowerList.getCityWatchTower(currentcityid);
                            if (watchTower) {
                                watchTower.demolish()
                            }
                        }
                    }
                }
                update_pop()
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function removeCityFromView(a) {
    delete seed.buildings["city" + currentcityid]["pos" + a];
    if ($("slot_" + a)) {
        $("slot_" + a).innerHTML = "";
        $("slot_" + a).className = "blank"
    }
    for (var b = 0; b < seed.queue_con["city" + currentcityid].length; b++) {
        if (parseInt(seed.queue_con["city" + currentcityid][b][7]) == parseInt(a)) {
            seed.queue_con["city" + currentcityid].splice(b, 1);
            break
        }
    }
    return true
}

function build_speedup(a) {
    Modal.hideModalAll();
    modal_speedup("bdg", a)
}

function getBuildingLevel(c) {
    var d = seed.buildings["city" + currentcityid],
        e = 0,
        b, a = parseInt(c, 10);
    if (a === 0) {
        e = parseInt(d.pos0[1], 10)
    } else {
        if (a === 19 && d.pos1) {
            e = parseInt(d.pos1[1], 10)
        } else {
            for (b in d) {
                if (parseInt(d[b][0], 10) === a && parseInt(d[b][1], 10) >= e) {
                    e = parseInt(d[b][1], 10)
                }
            }
        }
    }
    return e
}

function buildtutorial(a) {}

function modal_buildnew_tooltip(b, d, a) {
    var c = buildingcost["bdg" + b][10];
    showTooltip(c, d, a, "modal_newbuild")
}

function modal_buildnew(a) {
    var c = new Array();
    c.push("<div id='modal_newbuild'>");
    c.push("<div class='buildttl'>" + g_js_strings.modal_buildnew.whatbuild + "</div>");
    c.push("<div class='buildsubttl'>(" + g_js_strings.modal_buildnew.clicktoview.replace("%1$s", "<b>").replace("%2$s", "</b>") + ")</div>");
    c.push("<div class='clearfix buildlist'>");
    if (a > 1 && a < 100) {
        var h = 0;
        var g = 21;
        for (var e = 5; e < g; e++) {
            if (buildingcost["bdg" + e] && e != 19 && (!maxbdglvl["b" + e] || buildingmulti["b" + e])) {
                var b = checkreq("bdg", e, 1);
                var f = true;
                for (var d = 0; d < b[3].length; d++) {
                    if (parseInt(b[3][d]) == 0) {
                        f = false;
                        break
                    }
                }
                if (e != 20 || (e == 20 && cm.WorldSettings.isOn("DARK_FOREST_CRAFTING_KILLSWITCH"))) {
                    c.push("<div class='building");
                    h++;
                    if (!f) {
                        c.push(" invalid")
                    }
                    if (parseInt(seed.tutorial.t1) == 7 && e != 5) {
                        c.push(" invalid")
                    }
                    c.push("' onmouseover='modal_buildnew_tooltip(");
                    c.push(e);
                    c.push(",this,event);' onmouseout='removeTooltip();return false;'>");
                    c.push("<div class='rec'></div>");
                    c.push("<div class='bldg'>");
                    c.push("<div class='bldgttl'>");
                    c.push(buildingcost["bdg" + e][0]);
                    c.push("</div>");
                    c.push("<div class='buildingpic'>");
                    c.push("<div class='buildinginside b");
                    c.push(e);
                    c.push("_1'></div>");
                    c.push("</div>");
                    c.push("</div>");
                    if (!f) {
                        c.push("<div class='reqsnotmet'>" + g_js_strings.modal_buildnew.reqnotmet + "</div>")
                    }
                    c.push("<div class='btn clearfix'><a class='button");
                    c.push("25' onclick='");
                    if (!(parseInt(seed.tutorial.t1) == 7 && e != 5)) {
                        c.push("modal_build(");
                        c.push(a + "," + e);
                        c.push(");")
                    }
                    c.push("return false;'");
                    c.push("><span>");
                    if (!f) {
                        c.push(g_js_strings.modal_buildnew.viewinfo)
                    } else {
                        c.push(g_js_strings.commonstr.select)
                    }
                    c.push("</span></a></div>");
                    c.push("</div>")
                }
            }
            if (h % 6 == 0) {
                c.push("<div style='clear:both;'></div>")
            }
        }
    } else {
        if (a > 99) {
            for (var e = 1; e < 5; e++) {
                var b = checkreq("bdg", e, 1);
                var f = true;
                for (var d = 0; d < b[3].length; d++) {
                    if (parseInt(b[3][d]) == 0) {
                        f = false;
                        break
                    }
                }
                c.push("<div class='building");
                if (!f || (parseInt(seed.tutorial.t1) == 1 && e != 2)) {
                    c.push(" invalid")
                }
                c.push("' onmouseover='modal_buildnew_tooltip(");
                c.push(e);
                c.push(",this,event);' onmouseout='removeTooltip();return false;'>");
                c.push("<div class='rec'></div>");
                c.push("<div class='bldg'>");
                c.push("<div class='bldgttl'>");
                c.push(buildingcost["bdg" + e][0]);
                c.push("</div>");
                c.push("<div class='buildingpic'>");
                c.push("<div class='buildinginside b");
                c.push(e);
                c.push("_1'></div>");
                c.push("</div>");
                c.push("</div>");
                if (!f) {
                    c.push("<div class='reqsnotmet'>" + g_js_strings.modal_buildnew.reqnotmet + "</div>")
                }
                c.push("<div class='btn clearfix'><a  class='button");
                if (!f) {
                    c.push("Down")
                }
                c.push("25' onclick='");
                if (!(parseInt(seed.tutorial.t1) == 1 && e != 2)) {
                    c.push("modal_build(");
                    c.push(a + "," + e);
                    c.push(");")
                }
                c.push("return false;'><span>" + g_js_strings.commonstr.select + "</span></a></div>");
                c.push("</div>")
            }
        } else {
            if (a == 1) {
                c.push("<div class='building'>");
                c.push("<div class='rec'></div>");
                c.push("<div class='bldg'>");
                c.push("<div class='bldgttl'>");
                c.push(buildingcost.bdg19[0]);
                c.push("</div>");
                c.push("<div class='buildingpic'>");
                c.push("<div class='buildinginside b19_1'>");
                c.push("</div>");
                c.push("</div>");
                c.push("</div>");
                c.push("<div class='btn'><a  class='button25' onclick='modal_build(");
                c.push(a + ",19");
                c.push(");return false;'><span>" + g_js_strings.commonstr.select + "</span></a></div>");
                c.push("</div>")
            }
        }
    }
    c.push("</div>");
    c.push("</div>");
    Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.buildings, c.join(""), undefined, undefined, undefined, undefined, true);
    cm.TutorialEventDispatcher.dispatchTutorialEvent("complete", "CLICK_LOT_BUILD_SAWMILL");
    cm.TutorialEventDispatcher.dispatchTutorialEvent("complete", "CLICK_LOT_BUILD_COTTAGE")
}

function modal_buildnewFTEsawmill() {
    $("modalControls1").hide();
    if ($("modal_whats_this_link")) {
        $("modal_whats_this_link").style.visibility = "hidden"
    }
}

function modal_buildnewFTEsawmillBuild(a) {
    $("modalControls1").hide();
    if ($("modal_whats_this_link")) {
        $("modal_whats_this_link").style.visibility = "hidden"
    }
    seed.tutorial.t1 = (a + 1);
    tutorialCheck((a + 1))
}

function modal_buildnewFTECottage() {
    modal_buildnewFTEsawmill();
    $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialCheck.clickbuildnohelpcottage + "</div></div>";
    $("arrowtip").style.top = "175px";
    $("arrowtip").style.left = "379px";
    $("arrowtip").show()
}

function buildslot(d, c) {
    var b = d.id.split("_")[1];
    var a = seed.buildings["city" + currentcityid]["pos" + b];
    if (a == null) {
        modal_buildnew(b)
    } else {
        modal_build(b)
    }
}

function protect_off_confirm(c, d, b, e) {
    var a = new Array();
    a.push("<div class='modalactionwarning'>");
    a.push("<div>" + g_js_strings.protect_off_confirm.lvlupwarning + "</div>");
    a.push("<div class='confirmbtn clearfix'>");
    a.push("<a class='button25' onclick='build(" + c + "," + d + "," + b);
    if (e) {
        a.push("," + e)
    }
    a.push(");return false;'>");
    a.push("<span>" + g_js_strings.commonstr.build + "</span>");
    a.push("</a>");
    a.push("<a class='button25' onclick='Modal.hideModal();return false;'>");
    a.push("<span>" + g_js_strings.commonstr.cancel + "</span>");
    a.push("</a>");
    a.push("</div>");
    a.push("</div>");
    Modal.showModal(400, 400, 190, 175, g_js_strings.modaltitles.exitbeginnerprotection, a.join(""))
}

function getModalResourceBar() {
    var a = new Array();
    a.push("<div class='resourcebar clearfix'>");
    a.push("<div class='restext'>");
    a.push("Total Resources:");
    a.push("</div>");
    a.push("<div class='resbox resgold'>");
    a.push("<span id='modal_stat_gold_bar'>");
    a.push(addCommas(parseInt(seed.citystats["city" + currentcityid].gold[0])));
    a.push("</span>");
    a.push("</div>");
    a.push("<div class='resbox resfood'>");
    a.push("<span id='modal_stat_rec1_bar_num'>");
    a.push(addCommas(parseInt(seed.resources["city" + currentcityid].rec1[0] / 3600)));
    a.push("</span>");
    a.push("</div>");
    a.push("<div class='resbox reswood'>");
    a.push("<span id='modal_stat_rec2_bar_num'>");
    a.push(addCommas(parseInt(seed.resources["city" + currentcityid].rec2[0] / 3600)));
    a.push("</span>");
    a.push("</div>");
    a.push("<div class='resbox resstone'>");
    a.push("<span id='modal_stat_rec3_bar_num'>");
    a.push(addCommas(parseInt(seed.resources["city" + currentcityid].rec3[0] / 3600)));
    a.push("</span>");
    a.push("</div>");
    a.push("<div class='resbox resore'>");
    a.push("<span id='modal_stat_rec4_bar_num'>");
    a.push(addCommas(parseInt(seed.resources["city" + currentcityid].rec4[0] / 3600)));
    a.push("</span>");
    a.push("</div>");
    a.push("</div>");
    $("modal_build_resourcebar").innerHTML = a.join("")
}

function isBuildingExist(d, a) {
    var b = seed.buildings["city" + d],
        c = false;
    jQuery.each(b, function (e, f) {
        if (+(f[0]) === a) {
            c = true
        }
    });
    return c
};

function openCastle() {
    var w = 1;
    var m = parseInt(seed.citystats["city" + currentcityid]["pop"][0]);
    var n = parseInt(seed.citystats["city" + currentcityid]["pop"][3]);
    if (n > m) {
        w = m / n
    }
    var l = new Array();
    l.push("<div class='tabsbar clearfix' id='castleModalTabs'>");
    l.push("<a class='tab selected' onclick='changeCastleModalTabs(0);return false;'><span>");
    l.push(g_js_strings.commonstr.overview);
    l.push("</span></a>");
    l.push("<a class='tab' onclick='changeCastleModalTabs(1);return false;'><span>");
    l.push(g_js_strings.commonstr.buildings);
    l.push("</span></a>");
    l.push("<a class='tab' onclick='changeCastleModalTabs(2);return false;'><span>");
    l.push(g_js_strings.commonstr.wilderness);
    l.push("</span></a>");
    l.push("</div>");
    l.push("<div class='castletablewrap tablewrap' id='castle_0'>");
    l.push("<div class='topstatwrap clearfix'>");
    l.push("<div class='toppic'>");
    l.push("<img src='" + stimgUrl + "img/happiness.png'/>");
    l.push("</div>");
    l.push("<div class='topstat' id='topstat_happy_num'>");
    l.push($("stat_happy_num").innerHTML);
    l.push("</div>");
    l.push("<a class='button25'  onclick='increaseHappiness();return false;'><span>" + g_js_strings.openCastle.inchappiness + "</span></a>");
    l.push("<div class='toppic lborder'>");
    l.push("<img src='" + stimgUrl + "img/gold_30.png'/>");
    l.push("</div>");
    l.push("<div class='topstat'>");
    l.push($("stat_gold_num").innerHTML);
    l.push("</div>");
    l.push("<a class='button25'  onclick='raiseGold();return false;'><span>" + g_js_strings.openCastle.incgold + "</span></a>");
    l.push("<div class='toppic lborder'>");
    l.push("<img src='" + stimgUrl + "img/taxes.png'/>");
    l.push("</div>");
    l.push("<div class='topstat'>");
    l.push($("stat_tax_rate").innerHTML);
    l.push("</div>");
    l.push("<a class='button25'  onclick='changeTax();return false;'><span>" + g_js_strings.openCastle.chgtaxrate + "</span></a>");
    l.push("</div>");
    l.push("<div class='clearfix sanctuary'>");
    l.push("<div class='hide'><input type='radio' name='sanctuary' value='0' onclick='sanctuaryChange(0);' id='castle_sanctuary_0_ipt'");
    if (parseInt(seed.citystats["city" + currentcityid].gate) == 0) {
        l.push(" checked")
    }
    l.push("/><label for='castle_sanctuary_0_ipt'>" + g_js_strings.openCastle.hidesanct + "</label></div>");
    l.push("<div class='fight'><input type='radio' name='sanctuary' value='1' onclick='sanctuaryChange(1);' id='castle_sanctuary_1_ipt'");
    if (parseInt(seed.citystats["city" + currentcityid].gate) == 1) {
        l.push(" checked")
    }
    l.push("/><label for='castle_sanctuary_1_ipt'>" + g_js_strings.openCastle.orderdefend + "</label></div>");
    l.push("</div>");
    l.push("<div class='prodtablewrap'>");
    l.push("<div class='prodtableheader'>" + g_js_strings.openCastle.resprod);
    if (n > m) {
        l.push("<span class='right'>" + m + "/" + n + " " + g_js_strings.commonstr.workers.toLowerCase() + " (" + parseInt((m / n) * 100) + "% " + g_js_strings.commonstr.efficiency.toLowerCase() + ")</span>")
    }
    l.push("</div>");
    l.push("<table class='prodtable' border='0' cellspacing='0' cellpadding='0'>");
    l.push("<thead>");
    l.push("<tr class='hdg'>");
    l.push("<td class='stat'>");
    l.push(g_js_strings.commonstr.stat);
    l.push("</td>");
    l.push("<td>");
    l.push(resourceinfo.rec1);
    l.push("</td>");
    l.push("<td>");
    l.push(resourceinfo.rec2);
    l.push("</td>");
    l.push("<td>");
    l.push(resourceinfo.rec3);
    l.push("</td>");
    l.push("<td>");
    l.push(resourceinfo.rec4);
    l.push("</td>");
    l.push("</tr>");
    l.push("</thead>");
    var r = new Array();
    var g = new Array(0, 0, 0, 0, 0);
    l.push("<tbody>");
    l.push("<tr class='stripe hdg'>");
    l.push("<td class='stat'>");
    l.push(g_js_strings.openCastle.baseprod);
    l.push("</td>");
    for (var q = 1; q < 5; q++) {
        r[q] = parseInt(seed.resources["city" + currentcityid]["rec" + q][2] * w);
        g[q] = r[q];
        l.push("<td>");
        l.push(addCommas(r[q]));
        l.push("</td>")
    }
    l.push("</tr>");
    l.push("<tr class='stripe'><td class='stat'>" + g_js_strings.openCastle.knightbonus + "</td>");
    var t = 0;
    var c = seed.knights["city" + currentcityid];
    if (c) {
        c = c["knt" + seed.leaders["city" + currentcityid].resourcefulnessKnightId];
        if (c) {
            t = parseInt(c.resourcefulness);
            var a = new Date;
            if (c.resourcefulnessBoostExpireUnixtime > parseInt(a.getTime() / 1000)) {
                t *= 1.25
            }
        }
    }
    for (var q = 1; q < 5; q++) {
        var e = parseInt(r[q] * (t / 100));
        g[q] = g[q] + e;
        l.push("<td>");
        l.push(addCommas(e));
        l.push("</td>")
    }
    l.push("</tr>");
    l.push("<tr><td class='stat'>" + g_js_strings.openCastle.resbonus + "</td>");
    for (var q = 1; q < 5; q++) {
        var s = parseInt(r[q] * (parseInt(seed.tech["tch" + q]) / 10));
        g[q] = g[q] + s;
        l.push("<td>");
        l.push(addCommas(s));
        l.push("</td>")
    }
    l.push("</tr>");
    l.push("<tr  class='stripe'><td class='stat'>" + g_js_strings.openCastle.wildbonus + "</td>");
    var f = [0, 0, 0, 0, 0];
    if (!Object.isArray(seed.wilderness["city" + currentcityid])) {
        var v = Object.keys(seed.wilderness["city" + currentcityid]);
        for (var q = 0; q < v.length; q++) {
            var p = 0;
            switch (parseInt(seed.wilderness["city" + currentcityid][v[q]].tileType)) {
            case 10:
                p = 1;
                break;
            case 11:
                p = 1;
                break;
            case 20:
                p = 2;
                break;
            case 30:
                p = 3;
                break;
            case 40:
                p = 4;
                break
            }
            f[p] += parseInt(seed.wilderness["city" + currentcityid][v[q]].tileLevel)
        }
    }
    for (var q = 1; q < 5; q++) {
        var b = r[q] * 0.05 * f[q];
        g[q] = g[q] + b;
        l.push("<td>");
        l.push(addCommas(parseInt(b)));
        l.push("</td>")
    }
    l.push("</tr>");
    l.push("<tr><td class='stat'>" + g_js_strings.openCastle.provbonus + "</td><td>100</td><td>100</td><td>100</td><td>100</td></tr>");
    for (var q = 1; q < 5; q++) {
        g[q] += 100
    }
    l.push("<tr class='stripe'><td class='stat'>" + g_js_strings.openCastle.itembonus + "</td>");
    for (var q = 1; q < 5; q++) {
        var x = 0;
        if (parseInt(seed.playerEffects["r" + q + "BstExp"]) > unixtime()) {
            x = parseInt(r[q] * 0.25)
        }
        g[q] = g[q] + x;
        l.push("<td>");
        l.push(addCommas(x));
        l.push("</td>")
    }
    l.push("</tr>");
    l.push("<tr class='stripe'><td class='stat'>Throne Items</td>");
    var k = seed.throne.slotEquip[seed.throne.activeSlot],
        u, d, j, o;
    for (var q = 1; q < 5; q++) {
        l.push("<td>");
        o = 0;
        jQuery.each(k, function (i, y) {
            u = kocThroneItems[y];
            jQuery.each(u.effects, function (A, z) {
                if (+(A.split("slot")[1]) >= u.quality) {
                    return
                }
                d = +(cm.thronestats.tiers[z.id][z.tier].base);
                j = +(cm.thronestats.tiers[z.id][z.tier].growth);
                if (z.id === 82) {
                    o += d + ((u.level * u.level + u.level) * j * 0.5)
                }
                if (z.id === 83 && q === 1) {
                    o += d + ((u.level * u.level + u.level) * j * 0.5)
                }
                if (z.id === 84 && q === 2) {
                    o += d + ((u.level * u.level + u.level) * j * 0.5)
                }
                if (z.id === 85 && q === 3) {
                    o += d + ((u.level * u.level + u.level) * j * 0.5)
                }
                if (z.id === 86 && q === 4) {
                    o += d + ((u.level * u.level + u.level) * j * 0.5)
                }
            })
        });
        l.push(Math.ceil(g[q] * o / 100));
        l.push("</td>");
        g[q] = Math.ceil(g[q] * (1 + (o / 100)))
    }
    l.push("<tr><td class='stat'>" + g_js_strings.commonstr.upkeep + "</td>");
    for (var q = 1; q < 5; q++) {
        var h = parseInt(seed.resources["city" + currentcityid]["rec" + q][3]);
        g[q] = g[q] - h;
        l.push("<td class='neg'>");
        if (h > 0) {
            l.push("-")
        }
        l.push(addCommas(h));
        l.push("</td>")
    }
    l.push("</tr>");
    l.push("</tbody>");
    l.push("<tfoot>");
    l.push("<tr class='hdg stripe'>");
    l.push("<td class='stat'>");
    l.push(g_js_strings.openCastle.totalprod);
    l.push("</td>");
    for (var q = 1; q < 5; q++) {
        l.push("<td");
        if (g[q] < 0) {
            l.push(" class='neg'")
        }
        l.push(">");
        l.push(addCommas(g[q]));
        l.push("</td>")
    }
    l.push("</tr>");
    l.push("</tfoot>");
    l.push("</table>");
    l.push("</div>");
    l.push("</div>");
    l.push("<div class='castletablewrap tablewrap' id='castle_1' style='display:none;'>");
    l.push("<div class='waiting'></div>");
    l.push("</div>");
    l.push("<div class='castletablewrap tablewrap' id='castle_2' style='display:none;'>");
    l.push("<div class='waiting'></div>");
    l.push("</div>");
    $("modal_build_content").innerHTML = l.join("")
}

function sanctuaryChange(sanctype) {
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    params.state = sanctype;
    new Ajax.Request(g_ajaxpath + "ajax/gate.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                seed.citystats["city" + currentcityid].gate = sanctype;
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
            } else {
                Modal.hideModal();
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function changeTax() {
    var b = parseInt(seed.citystats["city" + currentcityid].gold[1]);
    var a = new Array();
    a.push("<div class='castlemessagewrap'>");
    a.push("<div class='castlemessage'>");
    a.push("<div class='desc'>" + g_js_strings.changeTax.changetaxdesc + "</div>");
    a.push("<div class='newratebox'><div>" + g_js_strings.changeTax.newtaxrate + "</div><div><input id='newTaxRate' value=''/>%</div></div>");
    a.push("<div class='errorbox'><div id='taxError' style='display:none;'>" + g_js_strings.changeTax.entertaxrate + "</div></div>");
    a.push("<div class='oldratebox'><div>" + g_js_strings.changeTax.taxrate + "</div><div><img src='" + stimgUrl + "img/taxes.png'/>" + b + "%</div></div>");
    a.push("</div>");
    a.push("<div class='btnlink clearfix'>");
    a.push("<a class='button25'  onclick='modal_change_tax();return false;'><span>" + g_js_strings.commonstr.submit + "</span></a>");
    a.push("<a class='link'  onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    a.push("</div>");
    a.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.changetaxrate, a.join(""))
}

function modal_change_tax() {
    if (isNaN(parseInt($("newTaxRate").value)) || parseInt($("newTaxRate").value) < 0 || parseInt($("newTaxRate").value) > 100) {
        $("taxError").show();
        return false
    } else {
        var params = Object.clone(g_ajaxparams);
        params.cid = currentcityid;
        params.rate = parseInt($("newTaxRate").value);
        new Ajax.Request(g_ajaxpath + "ajax/changeTax.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    Modal.hideModal();
                    if (rslt.updateSeed) {
                        update_seed(rslt.updateSeed);
                        var taxRate = rslt.updateSeed.city[currentcityid].production.taxRate;
                        $("stat_tax_rate").innerHTML = taxRate + "%";
                        seed.citystats["city" + currentcityid].gold[1] = taxRate
                    }
                    modal_change_tax_confirm();
                    update_gold()
                } else {
                    Modal.hideModal();
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                }
            },
            onFailure: function () {}
        })
    }
}

function modal_change_tax_confirm() {
    var a = new Array();
    a.push("<div class='castlemessagewrap'>");
    a.push("<div class='castlemessage'>");
    a.push("<div class='desc'>" + g_js_strings.modal_change_tax_confirm.yourtaxrate + ":</div>");
    a.push("<div class='stats'><img src='" + stimgUrl + "img/taxes.png'/> <span>" + seed.citystats["city" + currentcityid].gold[1] + "%</span></div>");
    a.push("</div>");
    a.push("<div class='btnlink clearfix'>");
    a.push("<a class='button25'  onclick='Modal.hideModal();openCastle();return false;'><span>" + g_js_strings.commonstr.ok + "</span></a>");
    a.push("</div>");
    a.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.changetaxrate, a.join(""))
}

function raiseGold() {
    var a = parseInt(seed.citystats["city" + currentcityid].pop[2]);
    var b = new Array();
    if (a < 20) {
        b.push("<div class='castlemessagewrap'>");
        b.push("<div class='castlemessage'>");
        b.push("<div class='desc'>" + g_js_strings.raiseGold.notenoughgold + "</div>");
        b.push("</div>");
        b.push("<div class='btnlink clearfix'>");
        b.push("<a class='button25' onclick='Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.ok + "</span></a>");
        b.push("</div>");
        b.push("</div>")
    } else {
        b.push("<div class='castlemessagewrap'>");
        b.push("<div class='castlemessage'>");
        b.push("<div class='desc'>" + g_js_strings.raiseGold.collectgolddesc + "</div>");
        b.push("<div class='stats'>" + g_js_strings.raiseGold.goldcollected + ": <span>" + addCommas(parseInt(seed.citystats["city" + currentcityid].pop[0]) * 10) + "</span></div>");
        b.push("<div class='stats'>" + g_js_strings.raiseGold.happdecreased + ": <span>20</span></div>");
        b.push("</div>");
        b.push("<div class='btnlink clearfix'>");
        b.push("<a class='button25' onclick='modal_raise_gold();return false;'><span>" + g_js_strings.commonstr.submit + "</span></a>");
        b.push("<a class='link' onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
        b.push("</div>");
        b.push("</div>")
    }
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.collectgold, b.join(""))
}

function modal_raise_gold() {
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/levyGold.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                Modal.hideModal();
                modal_raise_gold_confirm();
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
            } else {
                Modal.hideModal();
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function modal_raise_gold_confirm() {
    var b = parseInt(seed.citystats["city" + currentcityid].pop[0]) * 10 + seed.citystats["city" + currentcityid].gold[0];
    var a = new Array();
    a.push("<div class='castlemessagewrap'>");
    a.push("<div class='castlemessage'>");
    a.push("<div class='desc'>" + g_js_strings.modal_raise_gold_confirm.yourgoldinc + "</div>");
    a.push("<div class='stats'><img src='" + stimgUrl + "img/gold_30.png'/><span>" + addCommas(b) + "</span></div>");
    a.push("</div>");
    a.push("<div class='btnlink clearfix'>");
    a.push("<a class='button25' onclick='Modal.hideModal();openCastle();return false;'><span>" + g_js_strings.commonstr.ok + "</span></a>");
    a.push("</div>");
    a.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.collectgold, a.join(""))
}

function increaseHappiness() {
    var b = parseInt(seed.citystats["city" + currentcityid].pop[0]) * 10;
    var a = new Array();
    a.push("<div class='castlemessagewrap'>");
    a.push("<div class='castlemessage'>");
    a.push("<div class='desc'>" + g_js_strings.increaseHappiness.increasehappdesc + "</div>");
    a.push("<div class='stats'>" + g_js_strings.increaseHappiness.happinc + ": <span>10 (max 100%)</span></div>");
    a.push("<div class='stats'>" + g_js_strings.commonstr.cost + ": <span>" + addCommas(b) + " " + g_js_strings.commonstr.gold + "</span></div>");
    a.push("</div>");
    a.push("<div class='btnlink clearfix'>");
    a.push("<a class='button25'  onclick='modal_increase_happiness();return false;'><span>" + g_js_strings.commonstr.submit + "</span></a>");
    a.push("<a class='link'  onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    a.push("</div>");
    a.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.inchapp, a.join(""))
}

function modal_increase_happiness() {
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/spreadWealth.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                Modal.hideModal();
                modal_increase_happiness_confirm();
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
            } else {
                Modal.hideModal();
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function modal_increase_happiness_confirm() {
    var b = seed.citystats["city" + currentcityid].pop[2] + 10;
    var a = new Array();
    a.push("<div class='castlemessagewrap'>");
    a.push("<div class='castlemessage'>");
    a.push("<div class='desc'>" + g_js_strings.modal_increase_happiness_confirm.yourhapp + "</div>");
    a.push("<div class='stats'><img src='" + stimgUrl + "img/happiness.png'/> <span>" + b + "</span></div>");
    a.push("</div>");
    a.push("<div class='btnlink clearfix'>");
    a.push("<a class='button25' onclick='Modal.hideModal();openCastle();return false;'><span>" + g_js_strings.commonstr.ok + "</span></a>");
    a.push("</div>");
    a.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.inchapp, a.join(""))
}

function showMyWilderness() {
    var a = new Array();
    a.push("<div class='prodtablewrap'>");
    a.push("<div class='prodtableheader'>" + g_js_strings.showMyWilderness.conqueredwild + "<div class='right'>" + g_js_strings.commonstr.limit + ": ");
    if (getBuildingLevel(0) === 11) {
        a.push("12")
    } else {
        if (getBuildingLevel(0) === 12) {
            a.push("14")
        } else {
            a.push(seed.buildings["city" + currentcityid]["pos0"][1])
        }
    }
    a.push("</div></div>");
    a.push("<table class='prodtable wild' border='0' cellspacing='0' cellpadding='0'>");
    a.push("<thead>");
    a.push("<tr>");
    a.push("<td class='type'>");
    a.push(g_js_strings.commonstr.type);
    a.push("</td>");
    a.push("<td class='coord'>");
    a.push(g_js_strings.commonstr.coordinates);
    a.push("</td>");
    a.push("<td class='lvl'>");
    a.push(g_js_strings.commonstr.level);
    a.push("</td>");
    a.push("<td>");
    a.push(g_js_strings.commonstr.status);
    a.push("</td>");
    a.push("<td>");
    a.push(g_js_strings.commonstr.abandon);
    a.push("</td>");
    a.push("<td>");
    a.push(g_js_strings.commonstr.defend);
    a.push("</td>");
    a.push("</tr>");
    a.push("</thead>");
    a.push("<tbody>");
    if (seed.wilderness.length != 0 && seed.wilderness["city" + currentcityid].length != 0) {
        var b = new Hash(seed.wilderness["city" + currentcityid]);
        var c = true;
        b.each(function (e) {
            a.push("<tr" + ((c) ? " class='stripe'" : "") + ">");
            a.push("<td class='type'>");
            a.push(g_mapObject.typename[g_mapObject.types[parseInt(e.value.tileType)]].capitalize());
            a.push("</td>");
            a.push("<td class='coord'>");
            var d = new cm.utils.CoordinateLink(e.value.xCoord, e.value.yCoord);
            d.setClassName("coordinateLink");
            a.push(d.getHTML());
            a.push("</td>");
            a.push("<td class='lvl'>");
            a.push(e.value.tileLevel);
            a.push("</td>");
            a.push("<td>");
            a.push(g_js_strings.commonstr.normal);
            a.push("</td>");
            a.push("<td>");
            a.push("<a  class='button20' onclick='modal_wilderness_abandon(" + e.value.tileId + "," + e.value.tileLevel + "," + e.value.tileType + "," + e.value.xCoord + "," + e.value.yCoord + ");return false;'><span>" + g_js_strings.commonstr.abandon + "</span></a>");
            a.push("</td>");
            a.push("<td>");
            a.push("<a  class='button20' onclick='WildDefense.defenseModal(" + e.value.tileId + ",1);return false;'><span>" + g_js_strings.commonstr.defend + "</span></a>");
            a.push("</td>");
            a.push("</tr>");
            c = !c
        })
    }
    a.push("</tbody>");
    a.push("</table>");
    a.push("</div>");
    $("castle_2").innerHTML = a.join("")
}

function showMyBuildings() {
    var a = new Array();
    var e = new Array();
    var b = new Array();
    if (seed.buildings.length != 0) {
        var f = new Hash(seed.buildings["city" + currentcityid]);
        var d = true;
        var c = true;
        f.each(function (g) {
            if (parseInt(g.key.substring(3)) >= 100) {
                e.push("<tr" + ((d) ? " class='stripe'" : "") + ">");
                e.push("<td class='res'>");
                e.push(buildingcost["bdg" + g.value[0]][0]);
                e.push("</td>");
                e.push("<td>");
                e.push(g_js_strings.commonstr.normal);
                e.push("</td>");
                e.push("<td>");
                e.push(g.value[1]);
                e.push("</td>");
                e.push("</tr>");
                d = !d
            } else {
                b.push("<tr" + ((c) ? " class='stripe'" : "") + ">");
                b.push("<td class='res'>");
                b.push(buildingcost["bdg" + g.value[0]][0]);
                b.push("</td>");
                b.push("<td>");
                b.push(g_js_strings.commonstr.normal);
                b.push("</td>");
                b.push("<td>");
                b.push(g.value[1]);
                b.push("</td>");
                b.push("</tr>");
                c = !c
            }
        })
    }
    a.push("<div class='buildboxwrap clearfix'>");
    a.push("<div class='restablewrap'>");
    a.push("<div class='restableheader'>" + g_js_strings.commonstr.resources + "</div>");
    a.push("<table class='restable' border='0' cellspacing='0' cellpadding='0'>");
    a.push("<thead>");
    a.push("<tr>");
    a.push("<td class='res'>");
    a.push(g_js_strings.commonstr.resources);
    a.push("</td>");
    a.push("<td>");
    a.push(g_js_strings.commonstr.status);
    a.push("</td>");
    a.push("<td>");
    a.push(g_js_strings.commonstr.level);
    a.push("</td>");
    a.push("</tr>");
    a.push("</thead>");
    a.push("<tbody>");
    a.push(e.join(""));
    a.push("</tbody>");
    a.push("</table>");
    a.push("</div>");
    a.push("<div class='restablewrap'>");
    a.push("<div class='restableheader'>" + g_js_strings.commonstr.buildings + "</div>");
    a.push("<table class='restable' border='0' cellspacing='0' cellpadding='0'>");
    a.push("<thead>");
    a.push("<tr>");
    a.push("<td class='res'>");
    a.push(g_js_strings.commonstr.resources);
    a.push("</td>");
    a.push("<td>");
    a.push(g_js_strings.commonstr.status);
    a.push("</td>");
    a.push("<td>");
    a.push(g_js_strings.commonstr.level);
    a.push("</td>");
    a.push("</tr>");
    a.push("</thead>");
    a.push("<tbody>");
    a.push(b.join(""));
    a.push("</tbody>");
    a.push("</table>");
    a.push("</div>");
    a.push("</div>");
    $("castle_1").innerHTML = a.join("")
}

function changeCastleModalTabs(a) {
    var c = $("castleModalTabs").select("a");
    for (var b = 0; b < c.length; b++) {
        c[b].className = "tab";
        $("castle_" + b).hide()
    }
    c[parseInt(a)].className = "tab selected";
    $("castle_" + a).show();
    if (a == 0) {
        openCastle()
    } else {
        if (a == 1) {
            showMyBuildings()
        } else {
            if (a == 2) {
                showMyWilderness()
            }
        }
    }
    if (a == 0) {
        $("modal_build").className = "tab1"
    } else {
        if (a == 1) {
            $("modal_build").className = "tab2"
        } else {
            $("modal_build").className = "tab3"
        }
    }
}

function cityaction_abandonprompt() {
    Modal.hideModalAll();
    changeview_city($("mod_views_city"));
    var a = new Array();
    a.push('<div id="modal_abandonpromptdiv">');
    a.push('<div class="hdtx">' + g_js_strings.cityaction_abandonprompt.abandona.replace("%1$s", currentcityinfo[1]) + "</div>");
    a.push('<div class="instr">' + g_js_strings.cityaction_abandonprompt.confirmdesc + "</div>");
    a.push('<div class="ipt"><input type="text" id="modal_abandonpromptdiv_ipt" maxlength="15"/></div>');
    a.push("<div class='clearfix btns'><a class='button20' onclick='cityaction_abandonprompt_confirm();return false;'><span>" + g_js_strings.commonstr.abandon + "</span></a><a class='cancel' onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a></div>");
    a.push("</div>");
    Modal.showModal(500, 400, 130, 75, g_js_strings.modaltitles.abandoncity, a.join(""))
}

function cityaction_abandonprompt_confirm() {
    if ($("modal_abandonpromptdiv_ipt").value == currentcityinfo[1].split("").reverse().join("")) {
        cityaction_abandon(currentcityinfo[5], currentcityinfo[0], currentcityinfo[2], currentcityinfo[3])
    } else {
        Modal.showAlert(g_js_strings.cityaction_abandonprompt_confirm.typename)
    }
}

function cityaction_abandon(tileid, cityid, xcoord, ycoord) {
    var params = Object.clone(g_ajaxparams);
    params.cid = cityid;
    params.xCoord = xcoord;
    params.yCoord = ycoord;
    params.tid = tileid;
    new Ajax.Request(g_ajaxpath + "ajax/abandonCity.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                top.location = appUrl
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
};
cm.ChangeDomainController = function (h) {
    var q = false,
        u, k = {},
        n = {},
        r = [],
        e = 1,
        t, l = ["", false];
    var p = function (v) {
            v = v || {};
            u = v.selectedDomain || u || g_server;
            r = v.ads ? v.ads : r;
            if (v.selectableServers) {
                var w = v.selectableServers.servers;
                h.each(w, function (x, y) {
                    w[x].serverId = +x
                });
                k = w || k;
                n = h.extend(n, v.selectableServers.friendNames);
                q = true
            }
        };
    var m = function (v) {
            p(v);
            cm.ChangeDomainView.open({
                domainList: k,
                selectedDomain: u,
                friendsList: n
            });
            g(u);
            i(e);
            l = ["", false];
            b("domain")
        };
    var s = function (v) {
            if (k[v] === undefined) {
                return false
            }
            return k[v]
        };
    var o = function (v) {
            return n[v]
        };
    var j = function (v) {
            top.location = k[v].playUrl
        };
    var d = function (y) {
            var x = [],
                v = [],
                w = (y === "serverId" || y === "displayName");
            if (l[0] === y) {
                l[1] = !l[1]
            } else {
                l[0] = y;
                l[1] = false
            }
            w = w ? !l[1] : l[1];
            h.each(k, function (z, A) {
                var B = A[y];
                if (y === "friends") {
                    B = B.length
                }
                if (!B) {
                    if (y === "displayName") {
                        B = "zzzzzzzzzz"
                    } else {
                        B = 0
                    }
                }
                if (typeof B === "string") {
                    B = B.toLowerCase()
                }
                x.push([z, B])
            });
            x.sort(function (A, z) {
                if (A[1] < z[1]) {
                    return w ? -1 : 1
                }
                if (A[1] > z[1]) {
                    return w ? 1 : -1
                }
                if (A[0] < z[0]) {
                    return !l[1] ? -1 : 1
                }
                if (A[0] > z[0]) {
                    return !l[1] ? 1 : -1
                }
                return 0
            });
            h.each(x, function (z, A) {
                v.push(k[A[0]])
            });
            cm.ChangeDomainView.updateTableBody(v)
        };
    var g = function (v) {
            u = v;
            cm.ChangeDomainView.selectDomain(v)
        };
    var a = function () {
            var v = s(u);
            if (+u === +g_server && v.might === undefined) {
                cm.NewGameController.openNewPlayer({
                    domain: v
                })
            } else {
                j(u)
            }
        };
    var c = function (v) {
            g(v);
            a()
        };
    var f = function (v) {
            h.each(k, function (w, x) {
                switch (+v) {
                case -1:
                    if (w === u) {
                        g(w)
                    }
                    h("#serverId_" + w).show();
                    break;
                case 0:
                case 1:
                case 2:
                default:
                    if (+v === +x.serverType) {
                        if (w === u) {
                            g(w)
                        }
                        h("#serverId_" + w).show()
                    } else {
                        h("#serverId_" + w).hide()
                    }
                    break
                }
            })
        };
    var i = function (w) {
            if (!r.length) {
                return false
            }
            e = ((w - 1) % r.length) + 1;
            var v = r[e - 1];
            cm.ChangeDomainView.setPagination(e, r.length);
            cm.ChangeDomainView.updateImageRotator(v.imageUrl, v.actionText, v.actionLink);
            if (t) {
                clearTimeout(t)
            }
            if (h("#domainChangeRotated").length > 0) {
                t = setTimeout(function () {
                    i(e + 1)
                }, 10000)
            }
        };
    var b = function (w) {
            var v = "";
            switch (w) {
            case "domain":
                v = "serverId";
                break;
            case "lord":
                v = "displayName";
                break;
            case "lastVisit":
                v = "lastLogin";
                break;
            case "might":
            case "friends":
                v = w;
                break;
            default:
                v = "serverId"
            }
            d(v);
            f(cm.ChangeDomainView.getFilterBy());
            cm.ChangeDomainView.selectColumn(w)
        };
    return {
        init: p,
        isInit: function () {
            return q
        },
        open: m,
        getDomain: s,
        getFriendName: o,
        selectDomainEventClick: g,
        enterDomainEventClick: a,
        enterNewDomainEventClick: c,
        filterByEventClick: f,
        pageBulletEventClick: i,
        sortByColumnEventClick: b
    }
}(jQuery);
cm = cm || {};
cm.ChangeDomainView = function (j) {
    var k = function (s) {
            var r = "<h2>" + g_js_strings.modaltitles.changedomain + "</h2>",
                q = h(s) + m(s);
            cm.NewGameView.open(r, q, "");
            j("#newGameModal .scroll_content tr").click(function () {
                cm.ChangeDomainController.selectDomainEventClick((this.id).split("_")[1])
            });
            j("#newGameModal .scroll_content tr").dblclick(function () {
                cm.ChangeDomainController.enterNewDomainEventClick(this.id.split("_")[1])
            });
            j("#newGameModal .scroll_content .create_new").click(function () {
                cm.ChangeDomainController.enterNewDomainEventClick(this.id.split("_")[1])
            });
            j.each(s.domainList, function (u, v) {
                var t = "";
                j.each(v.friends, function (w, x) {
                    t += cm.ChangeDomainController.getFriendName(x) + "<br>"
                });
                if (v.friends.length > 0) {
                    cm.Tooltip.setTooltip({
                        htmlElement: j("#serverId_" + u + " div.friend"),
                        tooltip: "<div>" + t + "</div>"
                    })
                }
            });
            j("#newGameModal .enter_domain").click(function () {
                cm.ChangeDomainController.enterDomainEventClick()
            });
            j("#changeDomainFilterBy").change(function () {
                cm.ChangeDomainController.filterByEventClick(j(this).val())
            });
            j(".changeDomain .domain_container .domain_selector .fixed_header th").click(function () {
                var t = j(this).attr("class").split(" ");
                j.each(t, function (u, v) {
                    if (v !== "radio" && v !== "selected") {
                        cm.ChangeDomainController.sortByColumnEventClick(v)
                    }
                })
            })
        };
    var h = function (q) {
            return cm.Template.renderTemplate("ChangeDomain", "imageRotator", {})
        };
    var e = function (t, s, u) {
            var r = [],
                q = [g_appcallbackurlbase, "fbLoginButton.php?next=", encodeURIComponent(u)].join("");
            j("#domainChangeRotated").css("background-image", "url(" + t + ")");
            r.push('<a href="' + u + '" class="buttonv2 brown" target="_top">' + s + "</a>");
            r.push('<iframe src="' + q + '" frameborder="0" scrolling="no" class="buttonv2 login_iframe" target="_top"></iframe>');
            j("#domainChangeRotated").html(r.join(""))
        };
    var m = function (r) {
            var q = {
                radio: "",
                domain: g_js_strings.commonstr.domain,
                lord: g_js_strings.commonstr.ladylord,
                might: g_js_strings.commonstr.might,
                friends: g_js_strings.commonstr.friends,
                lastVisit: g_js_strings.modal_messages_viewreports_view.lastlogin
            };
            return cm.Template.renderTemplate("ChangeDomain", "domainSelector", {
                enterYourDomainText: g_js_strings.changeDomain.enterYourDomain,
                filterByText: g_js_strings.changeDomain.filterBy + ": ",
                filterOptions: g(),
                tableHeader: b(q),
                tableBody: l(r.domainList),
                newText: g_js_strings.commonstr.newString,
                newDescription: g_js_strings.changeDomain.newDescription,
                gloryText: g_js_strings.changeDomain.tournamentOfGlory,
                gloryDescription: g_js_strings.changeDomain.tournamentDescription,
                mightText: g_js_strings.changeDomain.tournamentOfmight,
                mightDescription: g_js_strings.changeDomain.tournamentDescription,
                actionButtons: '<div class="buttonv2 blue enter_domain">' + g_js_strings.changedomain_prompt.enterdomain + "</div>"
            })
        };
    var g = function () {
            var r = "",
                q = [{
                    label: g_js_strings.changeDomain.serverType,
                    value: -1
                }, {
                    label: g_js_strings.commonstr.all,
                    value: -1
                }, {
                    label: g_js_strings.commonstr.enhanced,
                    value: 1
                }];
            j.each(q, function (s, t) {
                r += '<option value="' + t.value + '">' + t.label + "</option>"
            });
            return r
        };
    var b = function (r) {
            var q = "";
            j.each(r, function (s, t) {
                q += '<th class="' + s + '">' + t + "</th>"
            });
            return q
        };
    var l = function (r) {
            var q = "";
            j.each(r, function (s, t) {
                q += cm.Template.renderTemplate("ChangeDomain", "domainRow", {
                    serverId: s,
                    selected: t.selected,
                    domainType: o(+t.serverType),
                    tournamentType: c(+t.tournamentType),
                    domainName: t.serverName,
                    name: t.displayName ? "<div>" + t.displayName + "</div>" : '<div id="createNew_' + s + '" class="buttonv2 brown create_new">' + g_js_strings.changeDomain.createNewCity + "</div>",
                    might: t.might || 0,
                    friends: t.friends.length,
                    lastVisit: t.lastLogin ? cm.utils.Date("j-M-y", t.lastLogin) : "New"
                })
            });
            return q
        };
    var d = function (r) {
            var q = "";
            j.each(r, function (s, t) {
                q += cm.Template.renderTemplate("ChangeDomain", "domainRow", {
                    serverId: t.serverId,
                    selected: t.selected,
                    domainType: o(+t.serverType),
                    tournamentType: c(+t.tournamentType),
                    domainName: t.serverName,
                    name: t.displayName ? "<div>" + t.displayName + "</div>" : '<div id="createNew_' + t.serverId + '" class="buttonv2 brown create_new">' + g_js_strings.changeDomain.createNewCity + "</div>",
                    might: t.might ? cm.resourceConverter.convert(addCommas(t.might)) : 0,
                    friends: t.friends.length,
                    lastVisit: t.lastLogin ? cm.utils.Date("j-M-y", t.lastLogin) : "New"
                })
            });
            j("#serverIds").html(q);
            j("#newGameModal .scroll_content tr").click(function () {
                cm.ChangeDomainController.selectDomainEventClick((this.id).split("_")[1])
            });
            j("#newGameModal .scroll_content tr").dblclick(function () {
                cm.ChangeDomainController.enterNewDomainEventClick(this.id.split("_")[1])
            });
            j("#newGameModal .scroll_content .create_new").click(function () {
                cm.ChangeDomainController.enterNewDomainEventClick(this.id.split("_")[1])
            });
            j.each(r, function (u, t) {
                var s = "";
                j.each(t.friends, function (v, w) {
                    s += cm.ChangeDomainController.getFriendName(w) + "<br>"
                });
                if (t.friends.length > 0) {
                    cm.Tooltip.setTooltip({
                        htmlElement: (j("#serverIds div.friend"))[u],
                        tooltip: "<div>" + s + "</div>"
                    })
                }
            })
        };
    var o = function (r) {
            var q = "";
            switch (r) {
            case cm.SERVER_TYPES.CLASSIC:
                q = "classic";
                break;
            case cm.SERVER_TYPES.ENHANCED:
                q = "enhanced";
                break;
            case cm.SERVER_TYPES.PREMIUM:
                q = "premier";
                break
            }
            return q
        };
    var c = function (q) {
            var r = "";
            switch (q) {
            case cm.CONTEST_TYPES.CONTEST_TYPE_MIGHT:
                r = "might";
                break;
            case cm.CONTEST_TYPES.CONTEST_TYPE_GLORY:
                r = "glory";
                break
            }
            return r
        };
    var f = function (q) {
            if (q) {
                j("#newGameModal .scroll_content").addClass("loading")
            } else {
                j("#newGameModal .scroll_content").removeClass("loading")
            }
        };
    var n = function (t, s) {
            var u = 5;
            s = Math.min(u, s);
            t = ((t - 1) % s) + 1;
            var r = "";
            for (var q = 1; q <= s; q++) {
                r += '<a class="bullet ' + (q === t ? "current" : "") + '"></a>'
            }
            j("#domainChangePager").html(r);
            j("#domainChangePager .bullet").click(function () {
                var v = j("#domainChangePager .bullet").index(this) + 1;
                cm.ChangeDomainController.pageBulletEventClick(v)
            })
        };
    var a = function (q) {
            j.each(j("#newGameModal .scroll_content tr"), function (r, s) {
                j(s).removeClass("selected")
            });
            j("#serverId_" + q).addClass("selected")
        };
    var p = function (q) {
            j(".fixed_header th").removeClass("selected");
            j(".fixed_header th." + q).addClass("selected")
        };
    var i = function () {
            return j("#changeDomainFilterBy").val()
        };
    return {
        open: k,
        selectDomain: a,
        setPagination: n,
        updateImageRotator: e,
        updateTableBody: d,
        showLoading: f,
        selectColumn: p,
        getFilterBy: i
    }
}(jQuery);
if (!window.Chat) {
    var Chat = new Object()
}
g_chatcurWritten = new Object();
g_chatcurWritten.c1 = -2;
g_chatcurWritten.c2 = -2;
g_chatcurWritten.c3 = -2;
g_chatcount = 0;
Chat.Properties = {
    chatType: 1,
    chatTypeId: 1,
    curNewest1: -1,
    curWritten1: -1,
    curNewest2: -1,
    curWritten2: -1,
    curNewest3: -1,
    curWritten3: -1,
    hasNewChat: [true, true, true],
    lastActiveState: true,
    recipients: new Object(),
    timestamp: 0,
    allianceChatPrefix: "__A_l_liance_Ch@tHelp__:"
};
Chat.Methods = {
    changeTab: function (a) {
        $("mod_comm_list" + this.chatType).hide();
        $("mod_comm_list" + a).show();
        $("comm_tabs").className = "comm_tabs seltab" + a;
        this.chatType = a
    },
    keyup: function (b) {
        var a;
        if (!b) {
            var b = window.event
        }
        if (b.keyCode) {
            a = b.keyCode
        } else {
            if (b.which) {
                a = b.which
            }
        }
        if (a == 13) {
            this.sendChat()
        }
    },
    ignoreUserConfirm: function (a) {
        var b = new Array();
        b.push("<div class='ignorebox'>");
        b.push("<div>" + g_js_strings.ignoreUserConfirm.ignoreuser + "</div>");
        b.push("<div class='clearfix' style='width: 140px; margin: 10px auto 0; padding-left: 2px;'>");
        b.push("<a  class='button20' style='width: 55px' onclick='Chat.ignoreUser(\"");
        b.push(a);
        b.push("\");return false;'><span>" + g_js_strings.commonstr.yes + "</span></a>");
        b.push("<a  class='button20' style='width: 55px' onclick='Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.no + "</span></a></div>");
        b.push("</div>");
        Modal.showModal(400, 400, 130, 220, g_js_strings.modaltitles.ignoreuser, b.join(""))
    },
    ignoreUser: function (userid) {
        if (Object.isArray(ignored)) {
            ignored = {}
        }
        ignored["u" + userid] = true;
        var params = Object.clone(g_ajaxparams);
        params.ignoreId = userid;
        params.set = 1;
        new Ajax.Request(g_ajaxpath + "ajax/ignore.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    Modal.hideModalAll()
                }
            },
            onFailure: function () {}
        })
    },
    silenceUserConfirm: function (a) {
        var b = new Array();
        b.push("<div class='ignorebox'>");
        b.push("<div>" + g_js_strings.silenceUserConfirm.silenceuser + "</div>");
        b.push("<div class='clearfix'><a class='button20' onclick='Chat.silenceUser(");
        b.push(a);
        b.push(");Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.yes + "</span></a><a onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.no + "</a></div>");
        b.push("</div>");
        Modal.showModal(400, 400, 130, 400, g_js_strings.modaltitles.silenceuser, b.join(""))
    },
    silenceUser: function (userid) {
        var params = Object.clone(g_ajaxparams);
        params.silenceId = userid;
        params.reason = prompt("Reason:", "");
        params.set = 1;
        new Ajax.Request(g_ajaxpath + "ajax/silence.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    Modal.hideModalAll()
                }
            },
            onFailure: function () {}
        })
    },
    renameUserConfirm: function (a) {
        var b = new Array();
        b.push("<div class='ignorebox'>");
        b.push("<div>" + g_js_strings.renameUserConfirm.renameuser + "</div>");
        b.push("<div class='clearfix'><a class='button20' onclick='Chat.renameUser(");
        b.push(a);
        b.push(");Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.yes + "</span></a><a  onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.no + "</a></div>");
        b.push("</div>");
        Modal.showModal(400, 400, 130, 400, g_js_strings.modaltitles.renameuser, b.join(""))
    },
    renameUser: function (userid) {
        var params = Object.clone(g_ajaxparams);
        params.renameId = userid;
        params.newName = prompt("Name:", "");
        params.set = 1;
        new Ajax.Request(g_ajaxpath + "ajax/rename.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    Modal.hideModalAll()
                } else {
                    Modal.showAlert(g_js_strings.renameUser.didnotwork)
                }
            },
            onFailure: function () {}
        })
    },
    whisper: function (b) {
        if (typeof b === "string" && b.length != 0) {
            var a = $("mod_comm_input").value.strip();
            if (a.charAt(0) == "@") {
                a = ""
            }
            $("mod_comm_input").value = "@" + b + " " + a;
            $("mod_comm_input").focus()
        }
    },
    viewProfile: function (f, a, c) {
        if (!cm.ProfileController.disabled) {
            cm.ProfileController.open(a);
            return
        }
        var e = new Array();
        e.push("<div class='ignorebox clearfix'>");
        e.push("<a  class='button20' onclick='changeview_court(");
        e.push(a);
        e.push(");return false;'><span>" + g_js_strings.commonstr.viewcourt + "</span></a>");
        if (!c) {
            e.push("<a class='button20' onclick='Chat.ignoreUserConfirm(");
            e.push(a);
            e.push(");return false;'><span>" + g_js_strings.commonstr.ignore + "</span></a>")
        }
        var d = false;
        for (var b = 0; b < officers.length; b++) {
            if (officers[b] == tvuid) {
                e.push("<a  class='button20' onclick='Chat.silenceUserConfirm(");
                e.push(a);
                e.push(");return false;'><span>" + g_js_strings.commonstr.silence + "</span></a>");
                if (tvuid != a && !c) {
                    e.push("<a  class='button20' onclick='Chat.renameUserConfirm(");
                    e.push(a);
                    e.push(");return false;'><span>" + g_js_strings.commonstr.rename + "</span></a>")
                }
                d = true;
                break
            }
        }
        if (!d) {
            for (var b = 0; b < moderators.length; b++) {
                if (moderators[b] == tvuid) {
                    e.push("<a class='button20' onclick='Chat.silenceUserConfirm(");
                    e.push(a);
                    e.push(");return false;'><span>" + g_js_strings.commonstr.silence + "</span></a>");
                    if (tvuid != a && !c) {
                        e.push("<a class='button20' onclick='Chat.renameUserConfirm(");
                        e.push(a);
                        e.push(");return false;'><span>" + g_js_strings.commonstr.rename + "</span></a>")
                    }
                    break
                }
            }
        }
        e.push("</div>");
        Modal.showModal(400, 400, 130, 400, f.innerHTML, e.join(""))
    },
    getChat: function () {
        var ut = unixtime();
        var chatloc = "";
        var can_get_chat = false;
        if (cm.WorldSettings.getSetting("CHAT_THROTTLE") != "true") {
            var chatoffset = parseInt(g_chatcount / 10);
            if (chatoffset > 20) {
                chatoffset = 20
            }
            if (ut - this.timestamp > (8 + chatoffset)) {
                can_get_chat = true
            }
        } else {
            can_get_chat = cm.chat.Active()
        }
        if (!can_get_chat) {
            return
        }
        g_chatcount++;
        this.timestamp = ut;
        var params = Object.clone(g_ajaxparams);
        params.ctype = this.chatType;
        params.ctypeId = this.chatTypeId;
        params.curNewest1 = this.curNewest1;
        params.curNewest2 = this.curNewest2;
        params.curNewest3 = this.curNewest3;
        params.sid = g_server;
        var that = this;
        cm.chat.Send();
        new Ajax.Request(g_ajaxpath + "ajax/getChat.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    cm.GloryView.SetNonMeGloryCache(rslt);
                    for (var i = 1; i < 4; i++) {
                        if (rslt.data.newChats[i].length > 0) {
                            if (parseInt(params["curNewest" + i]) > parseInt(g_chatcurWritten["c" + i])) {
                                g_chatcurWritten["c" + i] = parseInt(params["curNewest" + i])
                            } else {
                                rslt.data.newChats[i] = []
                            }
                        }
                        for (var j = 0; j < rslt.data.newChats[i].length; j++) {
                            if (ignored["u" + rslt.data.newChats[i][j][4]] == null) {
                                var chatwrap = document.createElement("div");
                                var chatwrapb = document.createElement("div");
                                if (i == 3) {
                                    cm.sounds.play("chat_received");
                                    chatwrap.className = "chatwrap clearfix direct";
                                    chatwrapb.className = "chatwrap clearfix direct";
                                    chatloc = "<b style='color:#A56631;font-size:9px;'> " + g_js_strings.getChat.whisperstoyou + ":</b> "
                                } else {
                                    if (i == 2) {
                                        chatwrap.className = "chatwrap clearfix";
                                        chatwrapb.className = "chatwrap clearfix";
                                        chatloc = "<b style='color:#A56631;font-size:9px;'> " + g_js_strings.getChat.saystoalliance + ":</b> "
                                    } else {
                                        chatwrap.className = "chatwrap clearfix global"
                                    }
                                }
                                if (parseInt(rslt.data.newChats[i][j][4]) == 0) {
                                    chatwrap.className = "chatwrap clearfix admin";
                                    if (rslt.data.newChats[i][j][3] == "RELOAD") {
                                        top.location.href = appUrl;
                                        return false
                                    }
                                } else {
                                    var chatid = parseInt(rslt.data.newChats[i][j][4]);
                                    var isofficer = false;
                                    var ismod = false;
                                    for (var k = 0; k < officers.length; k++) {
                                        if (chatid == parseInt(officers[k])) {
                                            chatwrap.className = "chatwrap clearfix officer";
                                            k = officers.length;
                                            isofficer = true
                                        }
                                    }
                                    if (!isofficer) {
                                        for (var k = 0; k < moderators.length; k++) {
                                            if (chatid == parseInt(moderators[k])) {
                                                chatwrap.className = "chatwrap clearfix moderator";
                                                k = moderators.length;
                                                ismod = true
                                            }
                                        }
                                    }
                                }
                                if (parseInt(rslt.data.newChats[i][j][6]) == 1) {
                                    var linkComment = true
                                } else {
                                    var linkComment = false
                                }
                                chatwrap.innerHTML = Chat.chatDivContent(1, rslt.data.newChats[i][j][0], rslt.data.newChats[i][j][1], rslt.data.newChats[i][j][2], rslt.data.newChats[i][j][3], rslt.data.newChats[i][j][4], rslt.data.newChats[i][j][5], chatloc, isofficer, ismod, linkComment);
                                chatwrapb.innerHTML = Chat.chatDivContent(1, rslt.data.newChats[i][j][0], rslt.data.newChats[i][j][1], rslt.data.newChats[i][j][2], rslt.data.newChats[i][j][3], rslt.data.newChats[i][j][4], rslt.data.newChats[i][j][5], chatloc, isofficer, ismod, linkComment);
                                if (i == 3 || i == 2) {
                                    that.insertChatMessage(2, {
                                        top: chatwrapb
                                    });
                                    that.insertChatMessage(1, {
                                        top: chatwrap
                                    })
                                } else {
                                    that.insertChatMessage(i, {
                                        top: chatwrap
                                    })
                                }
                            }
                        }
                        Chat["curNewest" + i] = parseInt(rslt.data.nextNewests[i])
                    }
                    if (parseInt(params.curNewest1) == -1) {
                        var chatguidelines = "<b>" + g_js_strings.getChat.chatrules + ":</b> " + g_js_strings.getChat.nobadlang + "";
                        $("mod_comm_list1").insert({
                            top: '<div class="chatwrap clearfix noalliance" style="padding:3px;">' + chatguidelines + "</div>"
                        });
                        $("mod_comm_list2").insert({
                            top: '<div class="chatwrap clearfix noalliance" style="padding:3px;">' + chatguidelines + "</div>"
                        })
                    }
                    calibratetime(rslt.resmicrotime)
                }
            },
            onFailure: function () {}
        })
    },
    chatDivContent: function (a, l, e, i, h, g, c, d, m, b, k) {
        h = cm.formatModel.exe(h, true);
        h = this.getAllianceHelpHtml(h);
        var j = m || b;
        var f = new Array();
        f.push("<img onclick='Chat.whisper(\"" + l.split(" ")[1] + "\"); return false;' ");
        f.push("src='");
        f.push(i);
        f.push("'/>");
        f.push("<div class='content'>");
        f.push("<div class='info'>");
        if (g && parseInt(g) != 0) {
            f.push("<a  class='nm' onclick='Chat.viewProfile(this,");
            f.push(g);
            f.push("," + j + ");return false;'>")
        } else {
            f.push("<span class='nm'>")
        }
        f.push(l);
        if (g && parseInt(g) != 0) {
            f.push("</a>")
        } else {
            f.push("</span>")
        }
        if (d != undefined) {
            if (d.length > 0) {
                f.push(d)
            }
        }
        f.push("<span class='time'>");
        f.push(e);
        f.push("</span>");
        f.push("</div>");
        f.push("<div class='message clearfix'>");
        f.push("<div class='tx'>");
        f.push(h);
        f.push("</div>");
        f.push(cm.GloryView.chatIcon(a, g && parseInt(g) != 0 ? g : tvuid));
        if (c) {
            f.push("<div class='flag f" + c + "'></div>")
        }
        f.push("</div>");
        f.push("</div>");
        return f.join("")
    },
    insertChatMessage: function (a, b) {
        $("mod_comm_list" + a).insert(b);
        this.hasNewChat[a] = true
    },
    sendChat: function (bhelpComment) {
        g_chatcount = 0;
        var comment = $("mod_comm_input").value.strip();
        if (bhelpComment) {
            var comment = bhelpComment.strip()
        }
        if (comment.length < 1) {
            return
        }
        jQuery(".comm_body").trigger("chatsent");
        $("mod_comm_input").value = "";
        var date = new Date(unixtime() * 1000);
        var chatloc = "";
        var chatwrap = document.createElement("div");
        if (comment.charAt(0) == "@" || comment.charAt(0) == "/") {
            chatwrap.className = "chatwrap clearfix direct"
        } else {
            chatwrap.className = "chatwrap clearfix"
        }
        var mins = date.getMinutes();
        if (mins < 10) {
            mins = "0" + mins
        }
        if (parseInt(this.chatType) == 2 && (!seed.allianceDiplomacies || parseInt(seed.allianceDiplomacies.allianceId) < 1)) {
            var chatwrap2 = document.createElement("div");
            chatwrap2.className = "chatwrap clearfix noalliance";
            chatwrap2.innerHTML = "<div>" + cm.GloryView.chatIcon() + g_js_strings.sendChat.talkingtoyourself + " <a  onclick='modal_alliance();return false;'>" + g_js_strings.sendChat.joinorcreate + "</a></div>";
            this.insertChatMessage(this.chatType, {
                top: chatwrap2
            });
            return false
        }
        var params = Object.clone(g_ajaxparams);
        if (comment.charAt(0) == "@" || comment.charAt(0) == "/") {
            params.ctype = 3;
            var comps = comment.split(" ");
            var nm = comps[0].substring(1);
            if (Chat.recipients[nm.toLowerCase()]) {
                params.recipient = Chat.recipients[nm.toLowerCase()]
            } else {
                params.name = nm
            }
            params.comment = comps.slice(1).join(" ");
            params.comment = params.comment.strip();
            if (params.comment == "") {
                return false
            }
            if (nm == "a") {
                params.ctype = 2;
                chatwrap.className = "chatwrap clearfix";
                comment = params.comment;
                chatloc = "<b style='color:#A56631;font-size:9px;'> " + g_js_strings.sendChat.saystoalliance + ":</b> ";
                if (!seed.allianceDiplomacies || parseInt(seed.allianceDiplomacies.allianceId) < 1) {
                    var chatwrap2 = document.createElement("div");
                    chatwrap2.className = "chatwrap clearfix noalliance";
                    chatwrap2.innerHTML = "<div>" + cm.GloryView.chatIcon() + g_js_strings.sendChat.talkingtoyourself + " <a  onclick='modal_alliance();return false;'>" + g_js_strings.sendChat.joinorcreate + "</a></div>";
                    this.insertChatMessage(1, {
                        top: chatwrap2
                    });
                    return false
                }
            } else {
                if (nm == "g") {
                    chatwrap.className = "chatwrap clearfix global";
                    params.ctype = 1;
                    comment = params.comment
                } else {
                    comment = params.comment
                }
            }
        } else {
            params.ctype = this.chatType;
            params.comment = comment;
            if (params.ctype == 2) {
                chatloc = "<b style='color:#A56631;font-size:9px;'> " + g_js_strings.sendChat.saystoalliance + ":</b> "
            }
        }
        params.ctypeId = this.chatTypeId;
        params.nm = nm;
        if (bhelpComment) {
            params.linkflag = true
        }
        var that = this;
        params.sid = g_server;
        new Ajax.Request(g_ajaxpath + "ajax/sendChat.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    if (params.name) {
                        Chat.recipients[params.name.toLowerCase()] = rslt.data.recipientId
                    }
                } else {}
                var courtflag = 0;
                for (var i = 0; i < seed.courtItems.length; i++) {
                    if (parseInt(seed.courtItems[i]) >= 860 && parseInt(seed.courtItems[i]) <= 893) {
                        courtflag = seed.courtItems[i]
                    }
                }
                var chatGlory = cm.GloryView.get();
                var chatwrap = document.createElement("div");
                var chatwrapb = document.createElement("div");
                var avatar = stimgUrl + "img/avatars/v2/25/" + ((seed.player.prefix == "Lord") ? "m" : "f") + seed.player.avatarId + ".png";
                if (rslt.data.recipientId == false) {
                    chatwrap.className = "chatwrap clearfix noalliance";
                    chatwrap.innerHTML = "<div>" + cm.GloryView.chatIcon() + params.name + " " + g_js_strings.sendChat.maybenotonline + "</div>";
                    chatwrapb.className = "chatwrap clearfix noalliance";
                    chatwrapb.innerHTML = "<div>" + cm.GloryView.chatIcon() + params.name + " " + g_js_strings.sendChat.maybenotonline + "</div>";
                    that.insertChatMessage(1, {
                        top: chatwrap
                    });
                    that.insertChatMessage(2, {
                        top: chatwrapb
                    })
                } else {
                    if (rslt.data.recipientId) {
                        chatwrap.className = "chatwrap clearfix direct";
                        chatwrapb.className = "chatwrap clearfix direct";
                        var nm = "<a  class='nm' onclick='Chat.viewProfile(this," + rslt.data.recipientId + "); return false;'>" + params.nm + "</a>";
                        var chatloc = "<b style='color:#A56631;font-size:9px;'> " + g_js_strings.sendChat.whispersto + " " + nm + ":</b> ";
                        chatwrap.innerHTML = Chat.chatDivContent(chatGlory, seed.player.prefix + " " + seed.player.name, date.getHours() + ":" + mins, avatar, params.comment, "", courtflag, chatloc);
                        that.insertChatMessage(1, {
                            top: chatwrap
                        });
                        chatwrapb.innerHTML = Chat.chatDivContent(chatGlory, seed.player.prefix + " " + seed.player.name, date.getHours() + ":" + mins, avatar, params.comment, "", courtflag, chatloc);
                        that.insertChatMessage(2, {
                            top: chatwrapb
                        })
                    } else {
                        if (params.ctype == 2) {
                            chatwrap.className = "chatwrap clearfix";
                            chatwrapb.className = "chatwrap clearfix";
                            chatloc = "<b style='color:#A56631;font-size:9px;'> " + g_js_strings.sendChat.saystoalliance + ":</b> ";
                            chatwrap.innerHTML = Chat.chatDivContent(chatGlory, seed.player.prefix + " " + seed.player.name, date.getHours() + ":" + mins, avatar, params.comment, "", courtflag, chatloc);
                            that.insertChatMessage(1, {
                                top: chatwrap
                            });
                            chatwrapb.innerHTML = Chat.chatDivContent(chatGlory, seed.player.prefix + " " + seed.player.name, date.getHours() + ":" + mins, avatar, params.comment, "", courtflag, chatloc);
                            that.insertChatMessage(2, {
                                top: chatwrapb
                            })
                        } else {
                            chatwrap.className = "chatwrap clearfix global";
                            chatwrapb.className = "chatwrap clearfix global";
                            chatwrap.innerHTML = Chat.chatDivContent(chatGlory, seed.player.prefix + " " + seed.player.name, date.getHours() + ":" + mins, avatar, params.comment, "", courtflag, chatloc);
                            that.insertChatMessage(1, {
                                top: chatwrap
                            })
                        }
                    }
                }
            },
            onFailure: function () {}
        })
    },
    sendAllianceHelpChat: function (a) {
        var c = [];
        for (var b in a) {
            c.push(b + "=" + a[b])
        }
        Chat.sendChat(Chat.allianceChatPrefix + c.join("&"))
    },
    getAllianceHelpHtml: function (h) {
        h = h.replace(/&#39;/g, "'");
        var e = h.split(this.allianceChatPrefix);
        if (e.length < 2) {
            return h
        }
        h = e[1].split("&");
        var d = {};
        for (var f = h.length - 1; f >= 0; --f) {
            var a = h[f].split("=");
            if (a.length < 2) {
                continue
            }
            d[a[0]] = a[1]
        }
        var b = {
            helpType: 1,
            helpId: 1,
            lvl: 1,
            aid: 1,
            inv: 1,
            cid: 1,
            player_prefix: 1,
            playerName: 1
        };
        for (var g in b) {
            if (undefined === d[g]) {
                return h
            }
        }
        for (var g in {
            helpId: 1,
            lvl: 1,
            aid: 1,
            inv: 1,
            cid: 1
        }) {
            var j = parseInt(d[g]);
            if (isNaN(j)) {
                return h
            }
        }
        if (!d.playerName.match(/^[\w\']{3,15}$/) && !d.playerName.match(/^[\w\'\u0000-\u024F\u1E00-\u1EFF\u2C60-\u2C7F\uA720-\uA7FF]{3,15}$/)) {
            return h
        }
        if (!d.player_prefix.match(/^[a-z]+$/i)) {
            return h
        }
        var k = 0;
        if (d.helpType == "tech") {
            d.bname = techcost["tch" + d.helpId][0];
            k = 2
        } else {
            if (d.helpType == "building") {
                d.bname = buildingcost["bdg" + d.helpId][0];
                k = 1
            }
        }
        var c = g_js_strings.postToAllianceChat.helpmebuild.replace("%1$s", d.lvl).replace("%2$s", d.bname);
        c += "<br/><a onclick='claimAllianceChatHelp(" + [k, d.aid, d.lvl, d.inv, d.cid, '"' + d.player_prefix + '"', '"' + cm.StringFormatter.htmlInlineSafeStringEncode(d.playerName) + '"'].join(",") + ");return false;'>";
        c += g_js_strings.postToAllianceChat.clicktobuild;
        c += "</a>";
        return c
    }
};
Object.extend(Chat, Chat.Methods);
Object.extend(Chat, Chat.Properties);
cm.chat = function (d) {
    var i = [10, 20, 30, 60];
    var c = {
        "10": 60,
        "20": 240,
        "30": 750,
        "60": Number.POSITIVE_INFINITY
    };
    var g = 0;
    var e = 0;
    var h = function () {
            e = a()
        };
    var f = function () {
            d("#comm_tabs a").bind("click", h);
            d(".chatlist").bind("scroll DOMMouseScroll mousewheel", h);
            d(".comm_body").bind("chatsent", h)
        };
    var b = function () {
            e = a() + 30;
            d(document).ready(f)
        };
    var a = function () {
            return (new Date()).getTime() / 1000
        };
    b();
    return {
        Send: function () {
            g = a()
        },
        Active: function () {
            var m = a();
            var l = m - e;
            var j = m - g;
            for (var n in i) {
                var k = i[n];
                if (l < c[k] && j >= k) {
                    return true
                }
            }
            return false
        }
    }
}(jQuery);
cm.cheatDetector = function (f) {
    var d = 0;
    var e = null;
    var c = 0;
    var b = false;

    function a() {
        var h = ["ptOfficial", "gmTabs", "KOCAttackToggle", "KOCAttackOptions", "KOCAttackTab", "KOCAttackOptionsLink", "main_engagement_tabs"];
        var i = {};
        c = 0;
        for (var g in h) {
            if (h.hasOwnProperty(g)) {
                i[h[g]] = (f("#" + h[g]).length > 0 ? "true" : "false");
                if (i[h[g]] == "true") {
                    c++
                }
            }
        }
        if (c > 0) {
            while (true) {
                cm.log.l("Cheater Detected!")
            }
        }
    }
    return {
        detect: function () {
            a()
        }
    }
}(jQuery);
var cm = cm || {};
cm.chestItemUsage = function ($) {
    function addItemsToSeed(items) {
        $.each(items, function (key, value) {
            if (seed.items["i" + key]) {
                seed.items["i" + key] = (parseInt(seed.items["i" + key]) + parseInt(value)).toString();
                ksoItems[key].add(Number(value))
            } else {
                seed.items["i" + key] = value.toString();
                ksoItems[key].add(Number(value))
            }
        })
    }

    function open(iid) {
        var params = Object.clone(g_ajaxparams);
        params.chestId = parseInt(iid);
        new Ajax.Request(g_ajaxpath + "ajax/useMysteryChest.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    cm.InventoryView.removeItemFromInventory(iid);
                    if (iid == 10029 || (iid >= 10043 && iid <= 10131)) {
                        cm.makeAnimatedChest.modal(rslt);
                        addItemsToSeed(rslt.items)
                    } else {
                        cm.log.l("chestItemUsage: I only make mysteryChest opens: iid=" + iid)
                    }
                } else {
                    cm.log.l("useMysteryChest.php err=" + (rslt.err || rslt.error || "unknown"))
                }
            },
            onFailure: function () {}
        })
    }
    return {
        open: function (iid) {
            open(iid)
        }
    }
}(jQuery);
var cm = cm || {};
cm.ChooseGiftController = (function (e) {
    var b = function () {
            var g = cm.ChooseGiftView.getRootHtmlElement();
            if (!g) {
                return
            }
            g = e(g);
            g.find(".button25").click(c)
        };
    var a = function () {
            cm.ChooseGiftModel.getGiftItems(f)
        };
    var f = function (g) {
            cm.ChooseGiftView.render(g);
            b()
        };
    var d = function (i) {
            var g = ("(" + i.responseText + ")").evalJSON();
            if (!g.ok || !g.invitation || !g.invitation.invitationTextGeneric || !g.invitation.invitationActionData) {
                Modal.showAlert(printLocalError((g.error_code || null), (g.msg || null), (g.feedback || null)));
                return
            }
            try {
                kraken.network.getUser(function (m) {
                    var j = m,
                        k = g.invitation.invitationTextGeneric,
                        l = {
                            body: g.invitation.invitationText,
                            data: Object.toJSON(g.invitation.invitationActionData.parts),
                            facebook__exclude_ids: g.invitation.excludedFriends,
                            googleplus__type: "invite"
                        };
                    k = k.replace(/REPLACE_DiSpLaYnAmE/g, m.name);
                    k = k.replace(/\(\s*REPLACE_LiNk\d\s*\)/g, "");
                    l.body = k;
                    kraken.network.getUser(function (n) {
                        kraken.network.makeRequest(l, function (o) {
                            var q = [],
                                p;
                            if (!o || !o.length) {
                                return
                            }
                            for (p = 0; p < o.length; ++p) {
                                q.push("ids[]=" + o[p])
                            }
                            cm.IframeUtil.post("_top", g.invitation.actionPage + "&" + q.join("&"))
                        })
                    })
                })
            } catch (h) {}
        };
    var c = function () {
            var g = e(cm.ChooseGiftView.getRootHtmlElement()).find("input"),
                j, h = null;
            for (j = g.length - 1; j >= 0; --j) {
                h = g[j];
                if (h.checked) {
                    break
                }
                h = null
            }
            if (!h) {
                return
            }
            var k = Object.clone(g_ajaxparams);
            k.ctrl = "NetworkRequest";
            k.action = "getRequest";
            k.inviteType = cm.InviteTypes.INVITE_TYPE_GIFT;
            k.giftId = h.value;
            new Ajax.Request(g_ajaxpath + "ajax/_dispatch.php" + g_ajaxsuffix, {
                method: "post",
                parameters: k,
                onSuccess: d,
                onFailure: function () {}
            })
        };
    return {
        openModal: a
    }
})(jQuery);
var cm = cm || {};
cm.ChooseGiftModel = (function (b) {
    var a = function (d) {
            var c = Object.clone(g_ajaxparams);
            c.ctrl = "GiftItems";
            c.action = "getGiftItems";
            new Ajax.Request(g_ajaxpath + "ajax/_dispatch.php" + g_ajaxsuffix, {
                method: "post",
                parameters: c,
                onSuccess: function (h) {
                    var e = ("(" + h.responseText + ")").evalJSON(),
                        f, g;
                    if (!e.ok) {
                        Modal.showAlert(printLocalError((e.error_code || null), (e.msg || null), (e.feedback || null)))
                    }
                    d(e.giftItems)
                },
                onFailure: function () {}
            })
        };
    return {
        getGiftItems: a
    }
})(jQuery);
var cm = cm || {};
cm.ChooseGiftView = (function (h) {
    var g = 400,
        d = 10,
        e = 10,
        a = 740,
        b = "modal_choose_gift",
        i = null;
    var c = function () {
            if (!i) {
                return
            }
            var k = h(i);
            k.find("*").unbind();
            k.unbind();
            k = null;
            i = null
        };
    var j = function () {
            return i
        };
    var f = function (l) {
            var m, n, k;
            c();
            Modal.onCloseCallback = c;
            k = [b, (new Date()).getTime(), Math.floor(Math.random() * 10000)].join("_");
            m = {
                self: cm.Template.getTemplate("ChooseGift_39", "self"),
                "self.items[*]": cm.Template.getTemplate("ChooseGift_39", "items[*]")
            };
            n = {
                g_js_strings: g_js_strings,
                items: l,
                modalId: k,
                site_image_url: stimgUrl
            };
            Modal.showModal(a, g, d, e, g_js_strings.popViralModalUEP.sendfreegifts, jsonT(n, m), undefined, undefined, undefined, {
                additionalClass: "modal_selgift"
            });
            i = document.getElementById(k)
        };
    return {
        cleanUp: c,
        getRootHtmlElement: j,
        render: f
    }
})(jQuery);
var cm = cm || {};
cm.CityIncomingAttackController = function (a) {
    var h = this;
    var k = a;
    var j = function (n) {
            var m = n.getTarget();
            var l = m.getMarchStatus();
            if (l == cm.MARCH_STATUS.MARCH_STATUS_INACTIVE || l == cm.MARCH_STATUS.MARCH_STATUS_ABORTING) {
                k.remove(m)
            }
        };
    var d = function () {
            if (cm.CurrentWatchTowerTimer && cm.CurrentWatchTowerTimer.isActive()) {
                cm.CurrentWatchTowerTimer.remove()
            }
        };
    var c = function (n) {
            n.addEventListener(cm.IncomingAttackEvent.STATUS_CHANGED, j);
            var m = n.getDestinationCityId();
            if (currentcityid != m) {
                return
            }
            var l = cm.WatchTowerList.getCityWatchTower(currentcityid);
            if (l) {
                var o = document.getElementById("slot_" + l.getSlot());
                cm.CurrentWatchTowerTimer = new cm.WatchTowerTimerView(n, k);
                cm.CurrentWatchTowerTimer.setParentElement(o);
                cm.CurrentWatchTowerTimer.show()
            }
        };
    var g = function (m) {
            var n = m.getTarget();
            n.removeEventListener(cm.IncomingAttackEvent.STATUS_CHANGED, j);
            if (k.getCount() > 0) {
                var l = k.getElementAtPosition(0);
                c(l)
            }
        };
    var i = function (m) {
            var l = m.getTarget();
            if (k.getElementAtPosition(0).getId() == l.getId()) {
                c(l)
            }
        };
    var e = function (m) {
            if (k.getCount() > 0) {
                var l = k.getElementAtPosition(0);
                c(l)
            }
        };
    var b = function (o) {
            var n = o.getTarget();
            var p = n.currentView;
            var m = n.previousView;
            if (p === "city") {
                if (k.getCount() > 0) {
                    var l = k.getElementAtPosition(0);
                    c(l)
                }
            }
        };
    var f = function () {
            k.addEventListener(cm.CollectionEvent.ELEMENT_ADDED, i);
            k.addEventListener(cm.CollectionEvent.ELEMENT_REMOVED, g);
            cm.CitySwitch.addEventListener(cm.CitySwitchEvent.CITY_CHANGED, e);
            cm.CitySwitch.addEventListener(cm.CitySwitchEvent.VIEW_CHANGED, b)
        };
    f()
};
cm = cm || {};
cm.CityModel = jQueryClass.extend({
    init: function (a) {
        this.cityId = Number(a[0]);
        this.name = a[1];
        this.x = Number(a[2]);
        this.y = Number(a[3]);
        this.provinceId = Number(a[4]);
        this.tileId = Number(a[5]);
        this.positionId = 0;
        this.silver = 0;
        this.taxRate = 0;
        this.resources = {};
        this.buildings = {};
        this.cityFortifications = {};
        this.wildFortifications = {};
        this.army = {};
        this.knights = {};
        this.leaders = {
            politics: null,
            combat: null,
            intelligence: null,
            resource: null
        };
        this.marches = {
            incoming: {},
            outgoing: {}
        };
        this.queues = {
            training: {},
            cityFortifications: {},
            wildFortifications: {},
            building: {},
            research: {}
        };
        this.wilds = {}
    }
});

function showClearingTooltip(d, b, a) {
    var c = cm.custom_tooltips[a] ? cm.custom_tooltips[a] : getMsg(a || d.id);
    showTooltip(c, d, b, "mod_maparea")
}
cm.custom_tooltips = {
    appleTop: ""
};

function getMsg(g) {
    var b = g.split("_")[1];
    var e = "<div>" + g_js_strings.showClearingTooltip.bdgsite + "</div>";
    var f = seed.buildings["city" + currentcityid]["pos" + b];
    var a = "";
    if (b == 500) {
        if (f == undefined) {
            f = ["50"]
        }
        f[1] = cm.guardianModalModel.getLevel();
        f[0] = "50";
        if (parseInt(f[1]) == 0) {
            return g_js_strings.guardian.tooltip
        }
        a = fUp(cm.guardianModalModel.getType()) + " Guardian"
    } else {
        if (f) {
            a = buildingcost["bdg" + f[0]][0]
        }
    }
    if (f) {
        e = "<div>" + a + " (" + g_js_strings.commonstr.lv + f[1] + ")</div>";
        if (parseInt(f[0]) < 5 && parseInt(f[0]) > 0) {
            var d = 0;
            for (var c = 1; c <= parseInt(f[1]); c++) {
                d += (100 * c)
            }
            if (parseInt(f[1]) === 8) {
                d = 4000
            } else {
                if (parseInt(f[1]) === 9) {
                    d = 5750
                } else {
                    if (parseInt(f[1]) === 10) {
                        d = 7700
                    } else {
                        if (parseInt(f[1]) === 11) {
                            d = 9850
                        } else {
                            if (parseInt(f[1]) === 12) {
                                d = 12200
                            }
                        }
                    }
                }
            }
            e += "<div>" + d + " " + resourceinfo["rec" + f[0]] + "/hr</div>"
        }
    }
    return e
};

function comingsoon() {
    Modal.showAlert(g_js_strings.comingsoon.comingsoon)
}

function load_start() {
    Modal.showModal(740, 400, 10, 10, "", g_js_strings.commonstr.loadingddd)
}

function load_stop() {
    Modal.hideModal()
}

function track_chrome_btn(a) {}

function common_postToProfile(a, l, b, c, g, m) {
    g.push(["REPLACE_CiTyId", currentcityid]);
    g.push(["REPLACE_CiTyNaMe", currentcityinfo[1]]);
    g.push(["REPLACE_TiTlEnAmE", titlenames[seed.player.title]]);
    g.push(["REPLACE_LoRdNaMe", seed.player.name]);
    if (seed.player.fname && seed.player.fname.length > 0) {
        var n = seed.player.fname + " " + seed.player.lname;
        g.push(["REPLACE_DiSpLaYnAmE", n])
    } else {
        g.push(["REPLACE_DiSpLaYnAmE", seed.player.name])
    }
    g.push(["REPLACE_PrEfIx", seed.player.prefix]);
    g.push(["REPLACE_LeVeL", seed.player.title]);
    g.push(["REPLACE_SeRvErId", g_server]);
    g.push(["REPLACE_SeRvErNaMe", domainName]);
    if (seed.allianceDiplomacies) {
        g.push(["REPLACE_AlLiAnCeId", seed.allianceDiplomacies.allianceId]);
        g.push(["REPLACE_AlLiAnCeNaMe", seed.allianceDiplomacies.allianceName])
    }
    for (var h = 0; h < g.length; h++) {
        var d = new RegExp(g[h][0], "g");
        if (l.caption) {
            l.caption = l.caption.replace(d, g[h][1])
        }
        if (l.name) {
            l.name = l.name.replace(d, g[h][1])
        }
        l.href = l.href.replace(d, g[h][1]);
        l.media[0].href = l.media[0].href.replace(d, g[h][1]);
        l.media[0].src = l.media[0].src.replace(d, g[h][1]);
        b[0].href = b[0].href.replace(d, g[h][1]);
        b[0].text = b[0].text.replace(d, g[h][1])
    }
    try {
        postToProfile(a, l, b, [], c, null, m)
    } catch (j) {
        var k
    }
}

function postToProfile(feedType, data, actionlink, tgt, confunc, arr, postTo) {
    var optionalmsg = "";
    if (document.getElementById("optionalmsg")) {
        optionalmsg = $("optionalmsg").value
    }
    var str = Object.toJSON(data);
    for (var i in arr) {
        str = str.replace(eval("/" + i + "/g"), arr[i])
    }
    if (typeof (g_jsarr) != "undefined") {
        for (var i in g_jsarr) {
            str = str.replace(eval("/" + i + "/g"), g_jsarr[i])
        }
    }
    var data = str.evalJSON();
    var params = Object.clone(g_ajaxparams);
    params.action = "feedOpened";
    params.situation = feedType;
    new Ajax.Request(g_ajaxpath + "ajax/trackSending.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {},
        onFailure: function () {}
    });
    kraken.network.publishStory({
        to: postTo,
        title: data.name,
        body: data.caption,
        image: data.img1,
        facebook__frictionless: false,
        link: actionlink[0].href,
        link_text: actionlink[0].text
    }, confunc)
}

function modal_disc(a) {
    var b = new Array();
    b.push("<iframe src='");
    b.push(a);
    b.push("' width='720' height='600' style='margin:10px 0 10px 10px;overflow:hidden;overflow-y:scroll;' frameborder='0'></iframe>");
    Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.discussion, b.join(""))
}

function changeview_city(c) {
    cm.sounds.music_play("field");
    var a = $("mod_views").getElementsByTagName("a");
    for (var b = 0; b < a.length; b++) {
        a[b].className = " buttonv2 nav h20";
        if (b === 3) {
            a[b].className += " throne"
        }
    }
    a[0].className = "buttonv2 nav h20 sel";
    $("maparea_city").show();
    $("maparea_fields").hide();
    $("maparea_map").hide();
    cm.CitySwitch.setView("city");
    cm.TutorialEventDispatcher.dispatchTutorialEvent("complete", "CLICK_CITY_TAB");
    cm.HUDIconShare.cityview()
}

function changeview_fields(e) {
    cm.sounds.music_play("field");
    var a = $("mod_views").getElementsByTagName("a");
    for (var b = 0; b < a.length; b++) {
        a[b].className = " buttonv2 nav h20";
        if (b === 3) {
            a[b].className += " throne"
        }
    }
    e.className = "buttonv2 nav h20 sel";
    $("maparea_city").hide();
    $("maparea_fields").show();
    var d = cm.cities.selectedIndex();
    var c = "fieldNum" + d;
    $("fieldmap").className = (d != 6 ? "fieldmap " : "") + c + " lv" + seed.buildings["city" + currentcityid].pos0[1];
    if (seed.courtItems) {
        if (seed.courtItems.indexOf("831") >= 0) {
            $("fieldmap").addClassName("red")
        } else {
            if (seed.courtItems.indexOf("832") >= 0) {
                $("fieldmap").addClassName("blue")
            } else {
                if (seed.courtItems.indexOf("833") >= 0) {
                    $("fieldmap").addClassName("purple")
                } else {
                    if (seed.courtItems.indexOf("834") >= 0) {
                        $("fieldmap").addClassName("green")
                    } else {
                        if (seed.courtItems.indexOf("835") >= 0) {
                            $("fieldmap").addClassName("yellow")
                        }
                    }
                }
            }
        }
    }
    $("maparea_map").hide();
    cm.TutorialEventDispatcher.dispatchTutorialEvent("complete", "CLICK_FIELD_TAB");
    cm.CitySwitch.setView("field");
    fields_generate();
    cm.HUDIconShare.fieldview()
}

function changeview_map(c) {
    cm.sounds.music_play("map");
    var a = $("mod_views").getElementsByTagName("a");
    for (var b = 0; b < a.length; b++) {
        a[b].className = "buttonv2 nav h20";
        if (b === 3) {
            a[b].className += " throne"
        }
    }
    c.className = "buttonv2 nav h20 sel";
    $("maparea_city").hide();
    $("maparea_fields").hide();
    $("maparea_map").show();
    cm.CitySwitch.setView("map");
    tutorialClear()
}

function fields_generate() {
    var c = new Array();
    var a = getBuildingLevel(0);
    var b = 10 + 3 * parseInt(seed.buildings["city" + currentcityid].pos0[1]);
    for (var d = 0; d < b; d++) {
        c.push("<a id='slot_");
        c.push(100 + d);
        c.push("' onclick='buildslot(this,event);return false;' class='");
        if (seed.buildings["city" + currentcityid]["pos" + (100 + d)] != null) {
            c.push("bldg_" + seed.buildings["city" + currentcityid]["pos" + (100 + d)][0] + "_" + seed.buildings["city" + currentcityid]["pos" + (100 + d)][1])
        } else {
            c.push("blank")
        }
        c.push("'  onmouseover='showClearingTooltip(this,event);return false;' onmouseout='removeTooltip();return false;'>");
        if (seed.buildings["city" + currentcityid]["pos" + (100 + d)] != null) {
            c.push("<span class='leveltag'>");
            c.push(seed.buildings["city" + currentcityid]["pos" + (100 + d)][1]);
            c.push("</span></a>")
        }
    }
    $("fieldmapbuildings").innerHTML = c.join("");
    update_bdg()
}

function queue_changetab_building() {
    $("queue_head_building").addClassName("sel");
    $("queue_head_train").removeClassName("sel");
    $("queue_head_market").removeClassName("sel");
    $("queue_train").hide();
    $("queue_market").hide();
    $("queue_building").show();
    if (!$("queue_list").visible()) {
        queue_toggle()
    }
}

function queue_changetab_train() {
    $("queue_head_building").removeClassName("sel");
    $("queue_head_market").removeClassName("sel");
    $("queue_head_train").addClassName("sel");
    $("queue_building").hide();
    $("queue_market").hide();
    $("queue_train").show();
    if (!$("queue_list").visible()) {
        queue_toggle()
    }
}

function queue_changetab_market() {
    $("queue_head_building").removeClassName("sel");
    $("queue_head_train").removeClassName("sel");
    $("queue_head_market").addClassName("sel");
    $("queue_building").hide();
    $("queue_train").hide();
    $("queue_market").show();
    if (!$("queue_list").visible()) {
        queue_toggle()
    }
}

function queue_toggle() {
    $("queue_list").toggle();
    if ($("queue_list").visible()) {
        $("queue_head_toggle").removeClassName("expand_button");
        $("queue_head_toggle").addClassName("collapse_button")
    } else {
        $("queue_head_toggle").removeClassName("collapse_button");
        f;
        $("queue_head_toggle").addClassName("expand_button")
    }
}
var parseInteger = function (a) {
        return a !== undefined ? parseInt(a) : 0
    };

function showResourceTooltip(r, n, j) {
    var d = [],
        l = r.id.split("_")[1],
        o, b = "",
        s = seed.resources["city" + currentcityid][l],
        h = 0,
        c = 0,
        q = 0,
        m = 0,
        t = 0,
        g = 0,
        u = 0,
        i = 0,
        a, e = 0;
    switch (l) {
    case "rec1":
        o = 1;
        b = resourceinfo.rec1;
        break;
    case "rec2":
        o = 2;
        b = resourceinfo.rec2;
        break;
    case "rec3":
        o = 3;
        b = resourceinfo.rec3;
        break;
    case "rec4":
        o = 4;
        b = resourceinfo.rec4;
        break;
    case "rec5":
        o = 5;
        b = resourceinfo.rec5;
        break
    }
    a = update_resource();
    d.push("<div>" + b + "</div>");
    if (o === 5) {
        h = +(cm.WorldSettings.getSetting("DARK_FOREST_AETHERSTONE_CAP")) || 0;
        c = cm.ThroneController.effectBonus(88);
        h = h + (h * (c / 100));
        d.push("<div>" + g_js_strings.commonstr.youown + ": " + Math.round(s[0]) + "</div>");
        d.push("<div>" + g_js_strings.commonstr.max + ": " + Math.round(h) + "</div>")
    } else {
        m = Math.round(s[0] / 3600);
        t = Math.round(s[1] / 3600);
        g = Math.round(s[3]);
        u = a["r" + o].persec;
        i = Math.floor(u + g);
        d.push("<div>" + g_js_strings.commonstr.youown + ": " + m + "</div>");
        d.push("<div>" + g_js_strings.showResourceTooltip.caplimit + ": " + t + "</div>");
        d.push("<div>" + g_js_strings.showResourceTooltip.hrprod + ": " + i + "</div>");
        if (o === 1) {
            d.push("<div>" + g_js_strings.showResourceTooltip.troopsupkeep + ": " + g + "</div>");
            e = parseInt(s[0] / 3600) / parseInt($("stat_" + l + "_grw").innerHTML.split(",").join(""));
            if (Math.abs(e) <= 24) {
                var k = g_js_strings.showResourceTooltip.foodrunningout;
                var p = g_js_strings.showResourceTooltip.foodrunningoutunit_m;
                if (Math.ceil(Math.abs(e)) == 1) {
                    p = g_js_strings.showResourceTooltip.foodrunningoutunit_s
                }
                d.push("<div class='red'>" + k + ": < " + Math.ceil(Math.abs(e)) + " " + p + "</div>")
            }
        }
    }
    showTooltip(d.join(""), r, n, j)
}

function showHappyTooltip(d, a, c) {
    var b = "<div class='title'>" + g_js_strings.commonstr.happiness + "</div>";
    b += "<div>" + g_js_strings.commonstr.happiness + ": " + seed.citystats["city" + currentcityid]["pop"][2] + "</div>";
    b += "<div>" + g_js_strings.showHappyTooltip.taxrate + ": " + seed.citystats["city" + currentcityid].gold[1];
    showTooltip(b, d, a, c)
}

function showGoldTooltip(h, m, k) {
    var d = "<div class='title'>" + resourceinfo.rec0 + "</div>";
    var i = 1;
    if (parseInt(seed.playerEffects.r0BstExp) > unixtime()) {
        i = 2
    }
    var e = +(seed.citystats["city" + currentcityid]["gold"][1]),
        p = +(seed.citystats["city" + currentcityid]["pop"][0]),
        l = e * p * 0.01 * i;
    var c = seed.citystats["city" + currentcityid]["gold"][2] * 10,
        o = seed.knights["city" + currentcityid],
        b, n = 0,
        a;
    if (o) {
        jQuery.each(o, function (r, q) {
            b = +(q.knightLevel);
            n += b * 2
        })
    }
    a = c + n;
    var g = parseInt(parseInt(seed.citystats["city" + currentcityid]["gold"][1] * seed.citystats["city" + currentcityid]["pop"][0]) * 0.01) * i;
    var j = parseInt(seed.citystats["city" + currentcityid]["gold"][2] * 10 * -1);
    d += "<div>" + g_js_strings.commonstr.youown + ": " + addCommas(seed.citystats["city" + currentcityid]["gold"][0]) + "</div>";
    d += "<div>" + g_js_strings.showGoldTooltip.taxrev + ": " + addCommas(l) + "</div>";
    d += "<div>" + g_js_strings.commonstr.salaries + ": " + addCommas(-1 * a) + "</div>";
    d += "<div>" + g_js_strings.showGoldTooltip.netincome + ": " + addCommas(l - a) + "</div>";
    showTooltip(d, h, m, k)
}

function showPopTooltip(c, k, i) {
    var d = seed.citystats["city" + currentcityid]["pop"][0];
    var e = seed.citystats["city" + currentcityid]["pop"][1];
    var a = seed.citystats["city" + currentcityid]["pop"][3];
    var g = d - a;
    var j = parseInt((seed.citystats["city" + currentcityid]["pop"][2] / 100) * e);
    var h = g_js_strings.commonstr.stable;
    if (d > j) {
        h = g_js_strings.commonstr.downward
    } else {
        if (d < j) {
            h = g_js_strings.commonstr.upward
        }
    }
    var b = "<div class='title'>" + g_js_strings.commonstr.population + "</div>";
    b += "<div>" + g_js_strings.showPopTooltip.poplimit + ": " + addCommas(e) + "</div>";
    b += "<div>" + g_js_strings.showPopTooltip.currpop + ": " + addCommas(d) + "</div>";
    b += "<div>" + g_js_strings.showPopTooltip.lbrforce + ": " + addCommas(a) + "</div>";
    b += "<div>" + g_js_strings.showPopTooltip.idlepop + ": " + addCommas(g) + "</div>";
    b += "<div>" + g_js_strings.showPopTooltip.poptrend + ": " + h + "</div>";
    showTooltip(b, c, k, i)
}

function showAddCityTooltip(d, a, c) {
    var b = "<div class='title'>" + g_js_strings.showAddCityTooltip.addcities + "</div>";
    showTooltip(b, d, a, c)
}

function showCityTooltip(d, l, i) {
    var k = parseInt(d.id.split("_")[1]) - 1;
    var h = seed.cities[k][0];
    var j = seed.cities[k][1];
    var g = seed.cities[k][2];
    var e = seed.cities[k][3];
    var c = seed.citystats["city" + h]["pop"][0];
    var b = parseInt(seed.resources["city" + h]["rec1"][0] / 3600);
    var m = seed.citystats["city" + h]["pop"][2];
    var a = "<div class='title'>" + j + " (" + g + ", " + e + ")</div>";
    a += "<div>" + g_js_strings.showPopTooltip.currpop + ": " + addCommas(c) + "</div>";
    a += "<div>" + g_js_strings.showCityTooltip.foodsupply + ": " + addCommas(b) + "</div>";
    a += "<div>" + g_js_strings.commonstr.happiness + ": " + addCommas(m) + "</div>";
    showTooltip(a, d, l, i)
}

function removeFriendTooltip() {
    if ($("friendlist_tooltip")) {
        $("friendlist_tooltip").remove()
    }
}

function showFriendTooltip(a, d, m, k) {
    Event.extend(m);
    var c = m.pointerX();
    var b = m.pointerY();
    removeFriendTooltip();
    var i = d;
    Element.extend(i);
    var o = document.createElement("div");
    Element.extend(o);
    var g = $(k);
    var n = i.cumulativeOffset()[0];
    var h = i.cumulativeOffset()[1] - g.cumulativeOffset()[1];
    var j = i.getWidth();
    var e = i.getHeight();
    o.id = "friendlist_tooltip";
    o.className = "friendlist_tooltip";
    var l = new Array();
    l.push(unescape(a));
    o.innerHTML = l.join("");
    g.appendChild(o)
}

function cityinfo_changetab(a) {
    $("cityinfo_tabs").className = "clearfix cityinfo_tabsel" + a;
    for (var b = 1; b < 5; b++) {
        $("cityinfo_" + b).hide()
    }
    $("cityinfo_" + a).show();
    switch (a) {
    case 1:
        break;
    case 2:
        break;
    case 3:
        cityinfo_army();
        break;
    case 4:
        cityinfo_defenses();
        break;
    default:
        return true
    }
}

function cityinfo_army() {
    var e = new Array();
    var b = Object.keys(seed.units["city" + currentcityid]);
    e.push("<table class='unitcontainer' cellpadding='0' cellspacing='0'><tbody>");
    var a = false;
    for (var c = 0; c < b.length; c++) {
        var d = b[c].split("unt")[1];
        if (c % 2 == 0) {
            e.push("<tr>")
        }
        e.push("<td>");
        e.push("<div class='unit' onmouseover='show_tooltip_cityinfo_army(this,event,\"kocmain_bottom\");return false;' onmouseout='removeTooltip();return false;' name='");
        e.push(unitcost[b[c]][0]);
        e.push("'><img src='");
        e.push(stimgUrl);
        e.push("img/units/unit_");
        e.push(d);
        e.push("_30_s34.jpg?6545'/>");
        e.push(seed.units["city" + currentcityid][b[c]]);
        e.push("</div>");
        e.push("</td>");
        if (c % 2 == 1) {
            e.push("</tr>");
            a = true
        } else {
            a = false
        }
    }
    if (!a) {
        e.push("</tr>")
    }
    e.push("</tbody></table>");
    $("cityinfo_3").innerHTML = e.join("")
}

function cityinfo_defenses() {
    var e = new Array();
    var b = Object.keys(seed.fortifications["city" + currentcityid]);
    e.push("<table class='unitcontainer' cellpadding='0' cellspacing='0'><tbody>");
    var a = false;
    for (var c = 0; c < b.length; c++) {
        var d = b[c].split("fort")[1];
        if (c % 2 == 0) {
            e.push("<tr>")
        }
        e.push("<td>");
        e.push("<div class='unit' onmouseover='show_tooltip_cityinfo_army(this,event,\"kocmain_bottom\");return false;' onmouseout='removeTooltip();return false;' name='");
        e.push(fortcost["frt" + d][0]);
        e.push("'><img src='");
        e.push(stimgUrl);
        e.push("img/units/unit_");
        e.push(d);
        e.push("_30.jpg'/>");
        e.push(seed.fortifications["city" + currentcityid][b[c]]);
        e.push("</div>");
        e.push("</td>");
        if (c % 2 == 1) {
            e.push("</tr>");
            a = true
        } else {
            a = false
        }
    }
    if (!a) {
        e.push("</tr>")
    }
    e.push("</tbody></table>");
    $("cityinfo_4").innerHTML = e.join("")
}

function show_tooltip_cityinfo_army(d, a, c) {
    var b = "<div class='title'>" + d.getAttribute("name") + "</div>";
    showTooltip(b, d, a, c)
}

function directory_friends_onlinestatus() {
    if ($("panel_friendlist").visible()) {
        var flist = new Array();
        var friends = $("panel_friendlist").select(".friend");
        for (var i = 0; i < friends.length; i++) {
            flist.push(friends[i].getAttribute("name"))
        }
        var params = Object.clone(g_ajaxparams);
        if (flist.length == 0) {
            return false
        }
        params.checkArr = flist.join(",");
        new Ajax.Request(g_ajaxpath + "ajax/getOnline.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    for (var i = 0; i < flist.length; i++) {
                        if ($("friend_onlinestatus_" + flist[i])) {
                            if (rslt.data[flist[i] + ""]) {
                                $("friend_onlinestatus_" + flist[i]).className = "online";
                                $("friend_onlinestatus_" + flist[i]).innerHTML = "(" + g_js_strings.commonstr.online + ")"
                            } else {
                                $("friend_onlinestatus_" + flist[i]).className = "offline";
                                $("friend_onlinestatus_" + flist[i]).innerHTML = "(" + g_js_strings.commonstr.offline + ")"
                            }
                        }
                    }
                }
            },
            onFailure: function () {}
        })
    }
}

function directory_changetab(tabnum) {
    for (var i = 1; i < 3; i++) {
        $("directory_tabs_" + i).hide()
    }
    $("directory_tabs_" + tabnum).show();
    $("directory_tabs").className = "clearfix directory_tabs directory_tabsel" + tabnum;
    if (tabnum == 1) {
        var params = Object.clone(g_ajaxparams);
        params.format = 1;
        new Ajax.Request(g_ajaxpath + "ajax/getLeaderboard.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    if (!rslt.data) {
                        $("tournament_tab").innerHTML = "<div class='leaderupsell'>" + g_js_strings.directory_changetab.tourncoming + "</div>"
                    } else {
                        var fhtml = new Array();
                        fhtml.push("<div class='leaderboardheader'>" + rslt.name + "</div>");
                        var arrlen = (rslt.data.length < 5) ? rslt.data.length : 5;
                        for (var i = 0; i < arrlen; i++) {
                            fhtml.push("<div class='leaderrow clearfix'>");
                            fhtml.push("<div class='ranking'>" + rslt.data[i].ranking + "</div>");
                            if (rslt.type == 24) {
                                fhtml.push("<div class='name'>" + rslt.data[i].alliance + "</div>")
                            } else {
                                fhtml.push("<div class='name'>" + rslt.data[i].name + "</div>")
                            }
                            fhtml.push("</div>")
                        }
                        fhtml.push("<div class='datefoot'>" + g_js_strings.commonstr.ends + ": <br/>" + new Date(parseInt(rslt.enddate) * 1000).toGMTString() + "</div>");
                        fhtml.push("<a  onclick='modal_tournaments();return false;' class='button20'><span>" + g_js_strings.directory_changetab.viewdet + "</span></a>");
                        $("tournament_tab").innerHTML = fhtml.join("")
                    }
                } else {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                }
            },
            onFailure: function () {}
        })
    } else {
        if (tabnum == 3) {
            var params = Object.clone(g_ajaxparams);
            new Ajax.Request(g_ajaxpath + "ajax/getAppFriends.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        seed.appFriends = rslt.data;
                        var friendlist = Object.keys(rslt.data);
                        var fhtml = new Array();
                        var numOfFriendsPlaying = 0;
                        for (var i = 0; i < friendlist.length && numOfFriendsPlaying == 0; i++) {
                            if (rslt.data[friendlist[i]].userId) {
                                numOfFriendsPlaying++
                            }
                        }
                        if (numOfFriendsPlaying == 0) {
                            fhtml.push("<div class='update_interval'>" + g_js_strings.directory_changetab.updateinterval + "</div>")
                        }
                        var indexHolder = 0;
                        var howmanyneeded = g_friendsperpage - (friendlist.length % g_friendsperpage);
                        for (var j = 0; j < howmanyneeded; j++, indexHolder++) {
                            fhtml.push('<a class="invite" onclick="invite_friends_popup(); return false;"><span>' + g_js_strings.commonstr.invite + "</span></a>")
                        }
                        for (var i = 0; i < friendlist.length; i++, indexHolder++) {
                            var msgTooltip = new Array();
                            if (rslt.data[friendlist[i]].displayName) {
                                msgTooltip.push(rslt.data[friendlist[i]].displayName + "<br/>")
                            } else {
                                msgTooltip.push(rslt.data[friendlist[i]].realName + "<br/>")
                            }
                            if (rslt.data[friendlist[i]].displayName) {
                                msgTooltip.push(rslt.data[friendlist[i]].realName + "<br/>")
                            }
                            if (rslt.data[friendlist[i]].might) {
                                msgTooltip.push(g_js_strings.commonstr.might + ":" + rslt.data[friendlist[i]].might + "<br/>")
                            }
                            fhtml.push('<a class="friend" onmouseout="removeFriendTooltip(); return false;" onmouseover="showFriendTooltip(\'' + msgTooltip.join("") + "',this,event,'friendlist_holder" + (indexHolder % g_friendsperpage) + "'); return false;\" onclick=\"getInfoForAnUser('" + rslt.data[friendlist[i]].userId + '\');return false;" name="' + rslt.data[friendlist[i]].userId + '">');
                            fhtml.push('<img class="pic" src="');
                            if (rslt.data[friendlist[i]].realPhoto == "") {
                                fhtml.push(kraken.network.getNoPictureUrl())
                            } else {
                                fhtml.push(rslt.data[friendlist[i]].realPhoto)
                            }
                            fhtml.push('"/>');
                            fhtml.push("<div>" + rslt.data[friendlist[i]].title + "</div>");
                            fhtml.push("</a>")
                        }
                        var totalfriends = howmanyneeded + friendlist.length;
                        var totalpages = totalfriends / g_friendsperpage;
                        var onepagewidth = g_friendsperpage * g_friendlistitemwidth;
                        var totalwidth = (onepagewidth * totalpages);
                        var totalleft = (totalwidth - onepagewidth) * (-1);
                        $("panel_friendlist").setStyle({
                            width: totalwidth + "px"
                        });
                        $("panel_friendlist").innerHTML = fhtml.join("");
                        g_numoffriendlistpages = totalpages;
                        g_currentfriendlistpage = totalpages;
                        friendlist_goto(1);
                        checkoutofdate(rslt.reqtime)
                    } else {
                        Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)));
                        checkoutofdate(rslt.reqtime)
                    }
                },
                onFailure: function () {}
            })
        }
    }
}

function update_friendlist() {
    var params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/getAppFriends.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                seed.appFriends = rslt.data;
                var friendlist = (0 === seed.appFriends.length) ? [] : Object.keys(rslt.data);
                var fhtml = new Array();
                var indexHolder = 0;
                var howmanyneeded = Math.max(g_friendsperpage - friendlist.length, 3);
                for (var j = 0; j < howmanyneeded; j++, indexHolder++) {
                    fhtml.push('<a class="invite" onclick="invite_friends_popup(); return false;"><span>' + g_js_strings.commonstr.invite + "</span></a>")
                }
                for (var i = 0; i < friendlist.length - 1; i++) {
                    for (var j = i + 1; j < friendlist.length; j++) {
                        if (parseInt(rslt.data[friendlist[j]].title) < parseInt(rslt.data[friendlist[i]].title)) {
                            var dummy = friendlist[i];
                            friendlist[i] = friendlist[j];
                            friendlist[j] = dummy
                        }
                    }
                }
                for (var i = 0; i < friendlist.length; i++, indexHolder++) {
                    var msgTooltip = new Array();
                    if (rslt.data[friendlist[i]].displayName) {
                        msgTooltip.push("<b>" + escape(rslt.data[friendlist[i]].displayName) + "</b><br/>")
                    } else {
                        msgTooltip.push(escape(rslt.data[friendlist[i]].realName) + "<br/>")
                    }
                    if (rslt.data[friendlist[i]].displayName && rslt.data[friendlist[i]].realName) {
                        msgTooltip.push(escape(rslt.data[friendlist[i]].realName) + "<br/>")
                    }
                    if (rslt.data[friendlist[i]].might) {
                        msgTooltip.push(g_js_strings.commonstr.might + ": " + rslt.data[friendlist[i]].might + "<br/>")
                    }
                    if (rslt.data[friendlist[i]].userId) {
                        fhtml.push('<a href="#top" class="friend" onmouseout="removeFriendTooltip(); return false;" onmouseover="showFriendTooltip(\'' + msgTooltip.join("") + "',this,event,'friendlist_holder" + (indexHolder % g_friendsperpage) + "'); return false;\" onclick=\"getInfoForAnUser('" + rslt.data[friendlist[i]].userId + '\');return true;" name="' + rslt.data[friendlist[i]].userId + '">');
                        fhtml.push('<img class="pic" src="');
                        if (rslt.data[friendlist[i]].realPhoto == "") {
                            fhtml.push(kraken.network.getNoPictureUrl())
                        } else {
                            fhtml.push(rslt.data[friendlist[i]].realPhoto)
                        }
                        fhtml.push('"/>');
                        fhtml.push("<div>" + rslt.data[friendlist[i]].title + "</div>");
                        fhtml.push("</a>")
                    } else {
                        fhtml.push('<a class="friend diff_server" onmouseout="removeFriendTooltip(); return false;" onmouseover="showFriendTooltip(\'' + msgTooltip.join("") + "',this,event,'friendlist_holder" + (indexHolder % g_friendsperpage) + '\'); return false;" onclick="return false;" name="' + rslt.data[friendlist[i]].userId + '">');
                        fhtml.push('<img class="pic" src="');
                        if (rslt.data[friendlist[i]].realPhoto == "") {
                            fhtml.push(kraken.network.getNoPictureUrl())
                        } else {
                            fhtml.push(rslt.data[friendlist[i]].realPhoto)
                        }
                        fhtml.push('"/>');
                        fhtml.push("<div>-</div>");
                        fhtml.push("</a>")
                    }
                }
                var totalfriends = howmanyneeded + friendlist.length;
                var totalpages = Math.ceil(totalfriends / g_friendsperpage);
                var onepagewidth = g_friendsperpage * g_friendlistitemwidth;
                var totalwidth = (onepagewidth * totalpages);
                var totalleft = (totalwidth - onepagewidth) * (-1);
                $("panel_friendlist").setStyle({
                    width: totalwidth + "px"
                });
                $("panel_friendlist").innerHTML = fhtml.join("");
                g_numoffriendlistpages = totalpages;
                g_currentfriendlistpage = totalpages;
                friendlist_goto(1);
                checkoutofdate(rslt.reqtime)
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)));
                checkoutofdate(rslt.reqtime)
            }
            arthurCheck(rslt.arthurCheckArray)
        },
        onFailure: function () {}
    })
}

function checkreq(g, t, s) {
    var h = Math.pow(2, (s - 1));
    var m = new Array();
    for (var x = 0; x < 5; x++) {
        m[x] = new Array()
    }
    var l = new Array();
    if (g == "tch") {
        var p = techcost["tch" + t][8]
    } else {
        if (g == "bdg") {
            var p = buildingcost["bdg" + t][8]
        } else {
            if (g == "unt") {
                var p = unitcost["unt" + t][8]
            } else {
                if (g == "frt") {
                    var p = fortcost["frt" + t][8]
                }
            }
        }
    }
    if (g == "bdg" && parseInt(s) > 10 && (parseInt(t) === 19 || parseInt(t) === 12 || parseInt(t) === 11 || parseInt(t) === 18 || parseInt(t) === 8 || parseInt(t) === 9 || parseInt(t) === 1 || parseInt(t) === 2 || parseInt(t) === 3 || parseInt(t) === 4)) {
        var u = getBuildingLevel(0);
        m[0].push(g_js_strings.commonstr.construction);
        m[1].push(g_js_strings.commonstr.lv + s + " " + buildingcost.bdg0[0]);
        m[2].push(g_js_strings.commonstr.lv + u + " " + buildingcost.bdg0[0]);
        if (u >= parseInt(s)) {
            m[3].push(1)
        } else {
            m[3].push(0)
        }
    }
    if (p.length == null) {
        var b = Object.keys(p);
        var y = new Array();
        var w = Object.keys(seed.buildings["city" + currentcityid]);
        for (var x = 0; x < w.length; x++) {
            var j = seed.buildings["city" + currentcityid][w[x]];
            if (y["b" + j[0]] == null) {
                y["b" + j[0]] = parseInt(j[1])
            } else {
                y["b" + j[0]] = (j[1] > y["b" + j[0]]) ? j[1] : y["b" + j[0]]
            }
        }
        for (var x = 0; x < b.length; x++) {
            m[0].push(g_js_strings.commonstr.construction);
            var D = b[x].split("b")[1];
            var c = 0;
            var e = (parseInt(y[b[x]]) > 0) ? (parseInt(y[b[x]])) : 0;
            var o = buildingcost["bdg" + D][0];
            if (parseInt(p[b[x]][0]) == 1) {
                c = parseInt(p[b[x]][1])
            } else {
                c = Math.min(buildingmaxlvl[D], s + parseInt(p[b[x]][1]))
            }
            if (g == "tch") {
                var A = [9, 15, 16, 17];
                if (A.indexOf(parseInt(D)) != -1 && parseInt(s) == 11) {
                    c = 10
                } else {
                    if (parseInt(D) == 11) {
                        c = Math.max(c, s)
                    }
                }
            }
            m[1].push(g_js_strings.commonstr.lv + c + " " + o);
            m[2].push(g_js_strings.commonstr.lv + e + " " + o);
            if (e < c) {
                m[3].push(0)
            } else {
                m[3].push(1)
            }
            m[4].push(null)
        }
    }
    var q = new Array();
    if (g == "tch") {
        var G = techcost["tch" + t][9]
    } else {
        if (g == "bdg") {
            var G = buildingcost["bdg" + t][9]
        } else {
            if (g == "unt") {
                var G = unitcost["unt" + t][9]
            } else {
                if (g == "frt") {
                    var G = fortcost["frt" + t][9]
                }
            }
        }
    }
    var k = Object.keys(G);
    if (G.length == null) {
        for (var x = 0; x < k.length; x++) {
            m[0].push(g_js_strings.commonstr.research);
            var n = k[x].split("t")[1];
            var B = 0;
            var F = parseInt(seed.tech["tch" + n]);
            var E = techcost["tch" + n][0];
            if (parseInt(G[k[x]][0]) == 1) {
                B = parseInt(G[k[x]][1])
            } else {
                B = s + parseInt(G[k[x]][1])
            }
            if (g == "bdg" && getBuildingLevel(t) === 10) {
                B = 10
            }
            m[1].push(g_js_strings.commonstr.lv + B + " " + E);
            m[2].push(g_js_strings.commonstr.lv + F + " " + E);
            if (F < B) {
                m[3].push(0)
            } else {
                m[3].push(1)
            }
            m[4].push(null)
        }
    }
    if (g == "tch") {
        var a = parseInt(techcost["tch" + t][5]) * h
    } else {
        if (g == "bdg") {
            var a = parseInt(buildingcost["bdg" + t][5]) * h
        } else {
            if (g == "unt") {
                var a = parseInt(unitcost["unt" + t][5]) * h
            } else {
                if (g == "frt") {
                    var a = parseInt(fortcost["frt" + t][5]) * h
                }
            }
        }
    }
    if (a > 0) {
        m[0].push(resourceinfo.rec0);
        var v = parseInt(seed.citystats["city" + currentcityid].gold[0]);
        m[1].push(a);
        m[2].push(v);
        if (v < a) {
            m[3].push(0)
        } else {
            m[3].push(1)
        }
        m[4].push(null)
    }
    for (var x = 1; x < 5; x++) {
        if (g == "tch") {
            var d = parseInt(techcost["tch" + t][x]) * h * 3600
        } else {
            if (g == "bdg") {
                var d = parseInt(buildingcost["bdg" + t][x]) * h * 3600
            } else {
                if (g == "unt") {
                    var d = parseInt(unitcost["unt" + t][x]) * h * 3600
                } else {
                    if (g == "frt") {
                        var d = parseInt(fortcost["frt" + t][x]) * h * 3600
                    }
                }
            }
        }
        if (d > 0) {
            m[0].push(resourceinfo["rec" + x]);
            var z = parseInt(seed.resources["city" + currentcityid]["rec" + x][0]);
            m[1].push(parseInt(parseInt(d) / 3600));
            m[2].push(parseInt(parseInt(z) / 3600));
            if (z < d) {
                m[3].push(0)
            } else {
                m[3].push(1)
            }
            switch (x) {
            case 1:
                m[4].push("Food");
                break;
            case 2:
                m[4].push("Wood");
                break;
            case 3:
                m[4].push("Stone");
                break;
            case 4:
                m[4].push("Ore");
                break
            }
        }
    }
    if (g == "tch") {
        var C = parseInt(techcost["tch" + t][6]) * h
    } else {
        if (g == "bdg") {
            var C = parseInt(buildingcost["bdg" + t][6]) * h
        } else {
            if (g == "unt") {
                var C = parseInt(unitcost["unt" + t][6]) * h
            } else {
                if (g == "frt") {
                    var C = parseInt(fortcost["frt" + t][6]) * h
                }
            }
        }
    }
    if (C > 0) {
        m[0].push(g_js_strings.commonstr.population);
        var r = parseInt(seed.citystats["city" + currentcityid].pop[0]) - parseInt(seed.citystats["city" + currentcityid].pop[3]);
        m[1].push(C);
        m[2].push(r);
        if (r < C) {
            m[3].push(0)
        } else {
            m[3].push(1)
        }
        m[4].push("Population")
    }
    return m
}

function modal_guide() {
    var a = new Array();
    a.push('<div class="guideframewrap">');
    a.push('<iframe src="' + guideUrl + 'guide.html" width="700" height="500" class="guideframe">');
    a.push("</iframe>");
    a.push("</div>");
    Modal.showModal(740, 740, 10, 100, "Guide", a.join(""))
}

function citysel_viewother(c) {
    var b = $("mod_citylist").select(".city");
    for (var a = 0; a < b.length; a++) {
        if (parseInt(c) == parseInt(b[a].getAttribute("name"))) {
            currentcityid = parseInt(c);
            changeview_city();
            citysel_click(b[a]);
            break
        }
    }
}

function citysel_click(b) {
    var j = parseInt(b.id.split("_")[1]) - 1;
    cm.cities.setIndex(j + 1);
    var g = seed.cities[j][0];
    var h = seed.cities[j][1];
    var e = parseInt(seed.cities[j][2]);
    var c = parseInt(seed.cities[j][3]);
    $("mapXCoor").value = e;
    $("mapYCoor").value = c;
    $("mod_maparea").className = "mod_maparea city_order_" + b.id.split("_")[1];
    var k = e;
    var a = c;
    g_mapObject = new MapObject(k, a);
    currentcityid = parseInt(g);
    update_gold();
    update_pop();
    for (var d = 0; d < seed.cities.length; d++) {
        if (parseInt(seed.cities[d][0]) == currentcityid) {
            currentcityinfo = seed.cities[d];
            break
        }
    }
    $("mod_cityinfo_cityname").innerHTML = currentcityinfo[1];
    if ($("mod_views_city").hasClassName("sel")) {
        changeview_city($("mod_views_city"))
    } else {
        if ($("mod_views_field").hasClassName("sel")) {
            changeview_fields($("mod_views_field"))
        }
    }
    update_citylist();
    update_bdg();
    cityinfo_changetab(1);
    update_knights();
    queue_changetab_building();
    attack_generatequeue();
    cm.CitySwitch.setCurrentCity(currentcityid);
    cm.guardianCity.rerender(true)
}

function changedomain_prompt() {
    var params = Object.clone(g_ajaxparams),
        options = {},
        profiler;
    if (cm.WorldSettings.isOn("NEW_GAME_V2")) {
        params.v2 = true;
        cm.ChangeDomainController.open({});
        jQuery(".newGame .close").show();
        if (cm.ChangeDomainController.isInit()) {
            return false
        }
        profiler = new cm.Profiler("ResponseTime", "myServers.php");
        cm.ChangeDomainView.showLoading(true);
        options = {
            method: "post",
            parameters: params,
            onSuccess: function (response) {
                profiler.stop();
                cm.ChangeDomainView.showLoading(false);
                var result = jQuery.parseJSON(response.responseText);
                if (result.ok) {
                    if (jQuery(".newGame").length > 0) {
                        cm.ChangeDomainController.open(result)
                    } else {
                        cm.ChangeDomainController.init(result)
                    }
                } else {
                    cm.ModalManager.alert({
                        text: printLocalError((result.error_code || null), (result.msg || null), (result.feedback || null)),
                        button_text: "Close"
                    })
                }
            },
            onFailure: function () {
                profiler.stop();
                cm.ChangeDomainView.showLoading(false)
            }
        }
    } else {
        profiler = new cm.Profiler("ResponseTime", "myServers.php");
        options = {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                profiler.stop();
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    var msgHtml = new Array();
                    msgHtml.push('<div id="modal_changedomaindiv">');
                    msgHtml.push("<div class='selhd'>" + g_js_strings.changedomain_prompt.selectdomain + "</div>");
                    msgHtml.push("<div class='clearfix selopt'>");
                    msgHtml.push(rslt.data);
                    msgHtml.push("</div><div class='clearfix enterbtn'>");
                    msgHtml.push("<a  class='button20' onclick='changedomain_prompt_enterdomain();return false;'><span>" + g_js_strings.changedomain_prompt.enterdomain + "</span></a>");
                    msgHtml.push("</div>");
                    msgHtml.push("<div class='orhd'>" + g_js_strings.changedomain_prompt.dord + "</div>");
                    msgHtml.push("<div class='newcity'><a href='");
                    msgHtml.push(newgameUrl);
                    msgHtml.push("' target='_top'>" + g_js_strings.changedomain_prompt.createcity + "</a></div>");
                    msgHtml.push("</div>");
                    Modal.showModal(500, 400, 130, 75, g_js_strings.modaltitles.changedomain, msgHtml.join(""))
                } else {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                }
            },
            onFailure: function () {
                profiler.stop()
            }
        }
    }
    new Ajax.Request(g_ajaxpath + "ajax/myServers.php" + g_ajaxsuffix, options)
}

function changedomain_prompt_enterdomain() {
    top.location = $("modal_changedomaindiv").select("select")[0].value
}

function change_avatar() {
    var c = (seed.player.prefix == "Lady") ? "f" : "m";
    var a = 16;
    var g = new Array();
    var d = "<img src='" + stimgUrl + "/img/shop_button_left.png'  class='arrow left'><img src='" + stimgUrl + "/img/shop_button_right.png' class='arrow right'>";
    g.push("<div class='avatarcontainer clearfix' id='avatarContainer'>" + d);
    g.push("<div class='c0 container'>");
    for (var b = 1; b <= 8; b++) {
        var e = (b == parseInt(seed.player.avatarId)) ? " selected" : "";
        g.push("<a name='" + b + "' onclick='selectAvatar(this);return false;' class='" + c + b + " avatars_100 avatarbox" + e + "'></a>")
    }
    g.push("</div><div class='c1 container'>");
    for (var b = 9; b <= 16; b++) {
        var e = (b == parseInt(seed.player.avatarId)) ? " selected" : "";
        g.push("<a name='" + b + "' onclick='selectAvatar(this);return false;' class='" + c + b + " avatars_100 avatarbox" + e + "'></a>")
    }
    g.push("</div></div>");
    g.push("<div class='avatarsavebuttons clearfix'>");
    g.push("<a class='button20' onclick='change_avatar_do();return false;'><span>" + g_js_strings.commonstr.save + "</span></a>");
    g.push("<a class='button20' onclick='Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.close + "</span></a>");
    g.push("</div>");
    Modal.showModal(500, 400, 210, 135, g_js_strings.modaltitles.pickavatar, g.join(""));
    jQuery(".avatarcontainer .arrow").unbind("click").bind("click", function () {
        jQuery(".avatarcontainer .container").toggle()
    })
}

function selectAvatar(b) {
    var a = $("avatarContainer").select(".selected")[0];
    if ($("avatarContainer").select(".selected") && a) {
        a.removeClassName("selected")
    }
    b.addClassName("selected")
}

function change_avatar_do() {
    var a = $("avatarContainer").select(".selected")[0].getAttribute("name");
    if (a == seed.player.avatarId) {
        Modal.hideModal();
        return false
    }
    var b = Object.clone(g_ajaxparams);
    b.aid = a;
    new Ajax.Request(g_ajaxpath + "ajax/changeAvatar.php" + g_ajaxsuffix, {
        method: "post",
        parameters: b,
        onSuccess: function (h) {
            Modal.hideModal();
            seed.player.avatarId = a;
            var d = seed.player.avatarurl.lastIndexOf("/");
            var c = seed.player.avatarurl.substr(d + 2);
            var e = a + ".png";
            seed.player.avatarurl = seed.player.avatarurl.replace(c, e);
            var g;
            ((seed.player.prefix == "Lord") ? g = "m" : g = "f");
            jQuery("#hudAvatarPic").attr("class", "avatars_50 " + g + seed.player.avatarId)
        },
        onFailure: function () {}
    })
}

function printLocalError(h, j, b) {
    if (h != null && g_js_strings.errorcode["err_" + h]) {
        var a = null;
        switch (h.toString()) {
        case "0":
            a = "Unexpected Error.";
            break;
        case "1":
            a = "Fatal Error.";
            break;
        case "2":
            a = "Construction is already starting.";
            break;
        case "3":
            a = "Unknown issue when updating game.";
            break;
        case "4":
            var k = b.split("-");
            if (k[0] == 5) {
                var e = resourceinfo["rec" + k[1]];
                return g_js_strings.errorcode.err_4.replace("%1$s", "resources").replace("%2$s", k[2]).replace("%3$s", e)
            } else {
                if (k[0] == 3) {
                    var e = unitcost["unt" + k[1]][0];
                    return g_js_strings.errorcode.err_4.replace("%1$s", "troops").replace("%2$s", k[2]).replace("%3$s", e)
                } else {
                    if (k[0] == 1) {
                        var c = buildingcost["bdg" + k[1]][0];
                        return g_js_strings.errorcode.err_4b.replace("%1$s", c).replace("%2$s", k[2])
                    } else {
                        if (k[0] == 8) {
                            var i = itemlist["i" + k[1]].name;
                            return g_js_strings.errorcode.err_4b.replace("%1$s", i).replace("%2$s", k[2])
                        } else {
                            return g_js_strings.errorcode.err_4z
                        }
                    }
                }
            }
            break;
        case "7":
            var d = new Date(parseInt(b) * 1000);
            return g_js_strings.errorcode.err_7.replace("%1$s", d);
            break;
        case "8":
            a = "Excess traffic.";
            cm.GATracker("Error", a + " (" + h + ")", g_server);
            break;
        case "102":
            a = "Another building already exists on the same spot!";
            break;
        case "103":
            var g = b;
            a = "Can't change to level " + g;
            return {
                tracker: true,
                errorCode: h.toString(),
                msg: a,
                text: g_js_strings.errorcode.err_103.replace("%1$s", g)
            };
            break;
        case "216":
            a = "Can't update knight.";
            break;
        case "1001":
            Modal.onCloseCallback = function () {
                top.location = appUrl
            };
            break;
        case "default":
            a = "Something has gone wrong.";
            cm.GATracker("Error", a + " (" + h + ")", g_server);
            break
        }
        if (a) {
            return {
                tracker: true,
                errorCode: h.toString(),
                msg: a
            }
        }
        return g_js_strings.errorcode["err_" + h]
    } else {
        if (j && !j.blank()) {
            return j
        }
    }
    cm.GATracker("Error", "Something has gone wrong", g_server);
    return {
        tracker: true,
        errorCode: "default",
        msg: "Something has gone wrong."
    }
}

function stopUpdateSeed() {
    if ($("updateSeedState") && $("updateSeedState").innerHTML == "ON") {
        $("updateSeedState").innerHTML = "OFF"
    } else {
        if ($("updateSeedState") && $("updateSeedState").innerHTML == "OFF") {
            $("updateSeedState").innerHTML = "ON";
            update_seed_ajax()
        }
    }
}

function stopGetChat() {
    if ($("getChatState") && $("getChatState").innerHTML == "ON") {
        $("getChatState").innerHTML = "OFF"
    } else {
        if ($("getChatState") && $("getChatState").innerHTML == "OFF") {
            $("getChatState").innerHTML = "ON";
            Chat.getChat()
        }
    }
}

function disableActionButton(b) {
    var a = Element.extend(b);
    a.setOpacity(0.5);
    a.setStyle("cursor:default");
    a.onclick = function () {
        return false
    }
}

function getWildIds(e, d) {
    var a = Object.keys(seed.wilderness["city" + e]);
    var c = [];
    for (var b = 0; b < a.length; b++) {
        if (seed.wilderness["city" + e][a[b]].tileType == d) {
            c.push(a[b])
        }
    }
    return c
}

function check_queue_tch(c) {
    var b = seed.queue_tch["city" + c];
    var a = false;
    if (b[0]) {
        a = b[0][0]
    }
    return a
}

function check_queue_con(c) {
    var b = seed.queue_con["city" + c];
    var a = false;
    if (b[0]) {
        a = b[0][2]
    }
    return a
}

function postToAllianceChat(k, a) {
    if (seed.allianceNames) {
        var c = seed.player.name;
        var b = {};
        var d = "";
        var l = 0;
        var n = 0;
        var g = tvuid;
        var m = 0;
        var h = "";
        var j = 0;
        if (k == 1) {
            l = Object.keys(seed.queue_tch);
            for (var e = 0; e < l.length; e++) {
                if (seed.queue_tch[l[e]][0] && (seed.queue_tch[l[e]][0][0] == a)) {
                    n = seed.queue_tch[l[e]][0][1];
                    m = l[e].split("city")[1];
                    h = "tech";
                    j = seed.queue_tch[l[e]][0][0];
                    break
                }
            }
        } else {
            l = Object.keys(seed.queue_con);
            for (var e = 0; e < l.length; e++) {
                if (seed.queue_con[l[e]][0] && (seed.queue_con[l[e]][0][2] == a)) {
                    n = seed.queue_con[l[e]][0][1];
                    m = l[e].split("city")[1];
                    h = "building";
                    j = seed.queue_con[l[e]][0][0];
                    break
                }
            }
        }
        b.helpType = h;
        b.helpId = j;
        b.lvl = n;
        b.aid = a;
        b.inv = g;
        b.cid = m;
        b.player_prefix = seed.player.prefix;
        b.playerName = c;
        Chat.changeTab(2);
        Chat.sendAllianceHelpChat(b)
    }
}

function claimAllianceChatHelp(resbld, aid, lvl, inv, cid, pref, nm) {
    var params = Object.clone(g_ajaxparams);
    params.tid = resbld;
    params.gid = aid;
    params.lid = lvl;
    params.inv = inv;
    params.cid = cid;
    nm = cm.StringFormatter.htmlInlineSafeStringDecode(nm);
    new Ajax.Request(g_ajaxpath + "ajax/helpAlliance.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (rslt.a) {
                    showChatMessage(1, pref, nm, rslt.a)
                }
            } else {
                showChatMessage(2, pref, nm, rslt.error_code)
            }
        },
        onFailure: function () {}
    })
}

function showChatMessage(b, e, c, d) {
    if (b == 1) {
        var g = g_js_strings.claimAllianceChatHelp.helpCount.replace("%1$s", d).replace("%2$s", e).replace("%3$s", c)
    } else {
        if (b == 2) {
            var g = g_js_strings.errorcode["err_" + d].replace("%1$s", e).replace("%2$s", c)
        }
    }
    var a = document.createElement("div");
    a.className = "chatwrap clearfix noalliance";
    a.innerHTML = "<div>" + g + "</div>";
    $("mod_comm_list" + Chat.chatType).insert({
        top: a
    })
}

function handleHelpCallback(a) {
    var g = Object.keys(a)[0];
    if (a[g].b) {
        var b = a[g].b;
        var d = Object.keys(seed.queue_con);
        for (var c = 0; c < d.length; c++) {
            if (seed.queue_con[d[c]].length > 0) {
                if (seed.queue_con[d[c]][0][2] == b) {
                    if (Object.isArray(seed.updateHelpConstruct)) {
                        seed.updateHelpConstruct = {}
                    }
                    seed.updateHelpConstruct[d[c]] = a;
                    break
                }
            }
        }
        postToAllianceChat(0, b)
    } else {
        if (a[g].t) {
            var e = a[g].t;
            var d = Object.keys(seed.queue_tch);
            for (var c = 0; c < d.length; c++) {
                if (seed.queue_tch[d[c]].length > 0) {
                    if (seed.queue_tch[d[c]][0][0] == e) {
                        if (Object.isArray(seed.updateHelpResearch)) {
                            seed.updateHelpResearch = {}
                        }
                        seed.updateHelpResearch[d[c]] = a;
                        break
                    }
                }
            }
            postToAllianceChat(1, e)
        }
    }
}

function getBuildHelpEligible(c, e) {
    var d = unixtime();
    var a = 60 * 60 * 12;
    var b = seed.queue_con["city" + e][0][1];
    if (!Object.isArray(seed.updateHelpConstruct) && seed.updateHelpConstruct["city" + e] && seed.updateHelpConstruct["city" + e]["b" + c]) {
        if (b == seed.updateHelpConstruct["city" + e]["b" + c].l && ((parseInt(seed.updateHelpConstruct["city" + e]["b" + c].time) + a) > d)) {
            return true
        }
    }
    return false
}

function getTechHelpEligible(d, e) {
    var c = unixtime();
    var a = 60 * 60 * 12;
    var b = seed.queue_tch["city" + e][0][1];
    if (!Object.isArray(seed.updateHelpResearch) && seed.updateHelpResearch["city" + e] && seed.updateHelpResearch["city" + e]["t" + d]) {
        if (b == seed.updateHelpResearch["city" + e]["t" + d].l && ((parseInt(seed.updateHelpResearch["city" + e]["t" + d].time) + a) > c)) {
            return true
        }
    }
    return false
}

function fteConversionTracker(a) {
    cm.MixPanelTracker.track(a, {
        last_fbuid_digit: lastFbuidDigit,
        distinct_id: user_id
    })
}

function tpDotDServer() {
    var a = Object.clone(g_ajaxparams);
    a.campaignId = "419";
    new Ajax.Request(g_ajaxpath + "ajax/frameTracker.php" + g_ajaxsuffix, {
        method: "post",
        parameters: a,
        onSuccess: function (b) {},
        onFailure: function () {}
    })
}

function fUp(a) {
    return a.substr(0, 1).toUpperCase() + a.substr(1)
};
cm.ComSat = function (f) {
    var g = "TaS_MoC",
        d = null,
        a = [];

    function b() {
        var j = e();
        j = c() || j;
        if (j) {
            h();
            clearInterval(d)
        }
        return j
    }

    function e() {
        var l = false,
            k = {
                ksx_ToolbarPlugin_ToolbarsPanel: 1,
                botbutton: 2,
                ptmain_outer: 3,
                ptOfficial: 4,
                KOCAttackOptions: 5
            };
        for (var j in k) {
            if (k.hasOwnProperty(j) && f("#" + j).length > 0) {
                a.push(k[j]);
                l = true
            }
        }
        return l
    }

    function c() {
        var j = false;
        if (typeof Components !== "undefined" && typeof Components.interfaces.gmIGreasemonkeyService !== "undefined") {
            a.push(101);
            j = true
        }
        return j
    }

    function i(j) {
        AjaxCall.gPostRequest("ajax/_dispatch.php", {
            ctrl: "Tracking",
            action: "update",
            type: j.join(",")
        }, function (k) {})
    }

    function h() {
        i(a)
    }
    f(document).ready(function () {
        if (cm.WorldSettings.isOn(g.split("").reverse().join("").toUpperCase())) {
            d = setInterval(b, Math.floor(Math.random() * 50000) + 5000)
        }
    });
    return
}(jQuery);
cm = cm || {};
var ContextMenus = {
    City: {
        "1": ["city", "reinforcements", "bookmark", "profile", "court"],
        "2": ["city", "march", "reinforcements", "bookmark", "profile", "court"],
        "3": ["march", "message", "bookmark", "profile", "court"],
        "4": ["march", "message", "bookmark", "profile", "court"],
        "5": ["march", "bookmark", "profile"]
    },
    Wilderness: {
        woods: ["march", "bookmark"],
        lake: ["march", "bookmark"],
        mountain: ["march", "bookmark"],
        hills: ["march", "bookmark"],
        boss: ["march", "bookmark"],
        grassland: ["march", "bookmark"],
        plain: ["march", "portal", "bookmark"],
        bog: ["bookmark"],
        bcity: ["march", "raid", "bookmark"]
    },
    OwnedWilderness: {
        woods: ["march", "defend", "view", "bookmark", "abandon"],
        lake: ["march", "defend", "view", "bookmark", "abandon"],
        mountain: ["march", "defend", "view", "bookmark", "abandon"],
        hills: ["march", "defend", "view", "bookmark", "abandon"],
        grassland: ["march", "defend", "view", "bookmark", "abandon"],
        plain: ["march", "build", "defend", "view", "bookmark", "abandon"]
    },
    Building: {}
};
var ContextMenuOffset = {
    topleft: {
        top: -20,
        left: -70
    },
    topright: {
        top: -20,
        left: 30
    },
    bottomleft: {
        top: -20,
        left: -60
    },
    bottomright: {
        top: 0,
        left: 0
    }
};
cm.ContextualMenuController = function (g) {
    var f = function (m, l) {
            var k, i = {},
                p = {},
                n = g(m).offset(),
                o, j = l.type;
            switch (l.type) {
            case "city":
            case "city_misted":
                k = g("#maparea_map");
                break;
            case "woods":
            case "plain":
            case "lake":
            case "mountain":
            case "hills":
            case "boss":
            case "grassland":
            case "bog":
            case "bcity":
                k = g("#maparea_map");
                break;
            case "building":
                k = g("#maparea_city");
                break;
            case "throne":
                k = g("#maparea_city");
            default:
                break
            }
            i.offset = k.offset();
            i.height = k.height();
            i.width = k.width();
            i.midHeight = i.height / 2;
            i.midWidth = i.width / 2;
            if (n.top > i.offset.top + i.midHeight) {
                p.vertical = "top"
            } else {
                p.vertical = "bottom"
            }
            if (n.left > i.offset.left + i.midWidth) {
                p.horizontal = "left"
            } else {
                p.horizontal = "right"
            }
            o = ContextMenuOffset[p.vertical + p.horizontal];
            n.top = n.top + o.top;
            n.left = n.left + o.left;
            return n
        };
    var c = function (i, j) {
            var k;
            switch (i) {
            case "city":
                k = a(j);
                break;
            case "wilderness":
                k = b(j);
                break;
            case "building":
                k = e(j);
                break;
            case "throne":
                k = cm.ContextualMenuThrone.calcItemMenu(j);
            default:
                break
            }
            return k
        };
    var a = function (j) {
            var l = h(j),
                i = ContextMenus.City[l],
                p = [],
                n, o, m, q = cm.BUILDING_TYPES.RALLY_POINT,
                k = isBuildingExist(currentcityid, q);
            g.each(i, function (r, t) {
                var s = {};
                switch (t) {
                case "city":
                    s.text = g_js_strings.modal_maptile.viewcity;
                    s.color = "blue";
                    s.action = function () {
                        citysel_viewother(j.city.id)
                    };
                    p.push(s);
                    break;
                case "reinforcements":
                    s.text = g_js_strings.modal_maptile.viewreinforcements;
                    s.color = "blue";
                    s.action = function () {
                        n = j.tile;
                        modal_wilderness_view(n.id, n.level, n.type, n.x, n.y)
                    };
                    p.push(s);
                    break;
                case "bookmark":
                    s.text = g_js_strings.modal_maptile.bookmarkloc;
                    s.color = "blue";
                    s.action = function () {
                        n = j.tile;
                        if (n.name) {
                            o = n.name
                        } else {
                            if (n.type) {
                                o = n.type
                            } else {
                                o = n.x + "," + n.y
                            }
                        }
                        setBookmarkLocation(n.id, o)
                    };
                    p.push(s);
                    break;
                case "profile":
                    s.text = g_js_strings.commonstr.view + " " + g_js_strings.commonstr.profile;
                    s.color = "blue";
                    s.action = function () {
                        cm.ProfileController.open(j.user.id)
                    };
                    p.push(s);
                    break;
                case "court":
                    s.text = g_js_strings.commonstr.viewcourt;
                    s.color = "blue";
                    s.action = function () {
                        changeview_court(j.user.id)
                    };
                    p.push(s);
                    break;
                case "march":
                    s.text = g_js_strings.commonstr.march;
                    if (k) {
                        s.color = "blue";
                        s.action = function () {
                            if (l === 2) {
                                m = 2
                            } else {
                                if (l === 3) {
                                    m = 1
                                } else {
                                    if (l === 4) {
                                        m = 4
                                    } else {
                                        m = 4
                                    }
                                }
                            }
                            modal_attack(m, j.tile.x, j.tile.y)
                        }
                    } else {
                        s.color = "gray";
                        s.action = function () {}
                    }
                    p.push(s);
                    break;
                case "message":
                    s.text = g_js_strings.getMessageWindow.sendmessage;
                    s.color = "blue";
                    s.action = function () {
                        getMessageWindow(j.user.id, escape(j.user.username))
                    };
                    p.push(s);
                    break;
                default:
                    break
                }
            });
            return p
        };
    var h = function (k) {
            var j = 0,
                i;
            if (seed.allianceDiplomacies) {
                i = (seed.allianceDiplomacies) ? +(seed.allianceDiplomacies.allianceId) : null
            } else {
                myAllianceID = null
            }
            if (k.city.id === +(currentcityid)) {
                j = 1
            } else {
                if (k.alliance.id === i) {
                    j = 3
                } else {
                    if (k.city.id === 0 && k.user.id === 0) {
                        j = 5
                    } else {
                        g.each(seed.cities, function (l, m) {
                            if (k.city.id === +(m[0])) {
                                j = 2;
                                return true
                            }
                        })
                    }
                }
            }
            if (j === 0) {
                j = 4
            }
            return j
        };
    var b = function (j) {
            var i, p = [],
                o, m, l, n, q = cm.BUILDING_TYPES.RALLY_POINT,
                k = isBuildingExist(currentcityid, q);
            if (seed.allianceDiplomacies) {
                l = +(seed.allianceDiplomacies.allianceId);
                n = seed.allianceDiplomacies.allianceName
            } else {
                l = null;
                n = null
            }
            if (l === j.alliance.id && j.user.id != +(tvuid)) {
                i = ["profile", "bookmark"]
            } else {
                if (j.tile.owned) {
                    i = ContextMenus.OwnedWilderness[j.tile.type]
                } else {
                    i = ContextMenus.Wilderness[j.tile.type]
                }
            }
            g.each(i, function (r, t) {
                var s = {};
                switch (t) {
                case "bookmark":
                    s.text = g_js_strings.modal_maptile.bookmarkloc;
                    s.color = "blue";
                    s.action = function () {
                        o = j.tile;
                        if (o.name) {
                            bookmarkName = o.name
                        } else {
                            if (o.type) {
                                bookmarkName = o.type
                            } else {
                                bookmarkName = o.x + "," + o.y
                            }
                        }
                        setBookmarkLocation(o.id, bookmarkName)
                    };
                    p.push(s);
                    break;
                case "march":
                    s.text = g_js_strings.commonstr.march;
                    if (k) {
                        s.color = "blue";
                        s.action = function () {
                            if (j.tile.owned) {
                                modal_attack(2, j.tile.x, j.tile.y)
                            } else {
                                modal_attack(4, j.tile.x, j.tile.y)
                            }
                        }
                    } else {
                        s.color = "gray";
                        s.action = function () {}
                    }
                    p.push(s);
                    break;
                case "raid":
                    s.text = g_js_strings.commonstr.raid;
                    s.color = "blue";
                    s.action = function () {
                        o = j.tile;
                        modal_attack(cm.MARCH_TYPES.MARCH_TYPE_BARBARIAN, o.x, o.y)
                    };
                    p.push(s);
                    break;
                case "portal":
                    s.text = g_js_strings.modal_myitems_use_teleport.teleport;
                    if (j.user.id === +(tvuid)) {
                        s.color = "gray";
                        s.action = function () {};
                        p.push(s)
                    } else {
                        s.color = "blue";
                        s.action = function () {
                            teleport_modal("", j.tile.x, j.tile.y)
                        };
                        p.push(s)
                    }
                    break;
                case "abandon":
                    s.text = g_js_strings.commonstr.abandon;
                    s.color = "blue";
                    s.action = function () {
                        o = j.tile;
                        modal_wilderness_abandon(o.id, o.level, g_mapObject.typeId[o.type], o.x, o.y)
                    };
                    p.push(s);
                    break;
                case "view":
                    s.text = g_js_strings.modal_maptile.viewtroops;
                    s.color = "blue";
                    s.action = function () {
                        o = j.tile;
                        modal_wilderness_view(o.id, o.level, o.type, o.x, o.y)
                    };
                    p.push(s);
                    break;
                case "defend":
                    s.text = g_js_strings.commonstr.defend;
                    s.color = "blue";
                    s.action = function () {
                        o = j.tile;
                        WildDefense.defenseModal(o.id)
                    };
                    p.push(s);
                    break;
                case "build":
                    if (seed.cities.length < cm.cities.max()) {
                        s.text = g_js_strings.modal_maptile.buildcity;
                        s.color = "blue";
                        s.action = function () {
                            o = j.tile;
                            AddCity.startBuildProcess(o.id, j.city.id)
                        };
                        p.push(s)
                    }
                    break;
                case "profile":
                    s.text = g_js_strings.commonstr.view + " " + g_js_strings.commonstr.profile;
                    s.color = "blue";
                    s.action = function () {
                        cm.ProfileController.open(j.user.id)
                    };
                    p.push(s);
                    break;
                default:
                    break
                }
            });
            return p
        };
    var e = function () {};
    var d = function () {};
    return {
        init: d,
        calcMenu: c,
        calcCityMenu: a,
        calcCityType: h,
        calcOffset: f
    }
}(jQuery);
cm.ContextualMenuThrone = function (e) {
    var h = function (l, j) {
            var n = "<div class='title'>" + g(l, j) + "</div>",
                i = c(l),
                m = d(l, j),
                k = {};
            k.title = n;
            k.body = i;
            k.menu = m;
            k.type = "throne";
            cm.ContextualMenuView.renderMenu(l, k)
        };
    var g = function (k, j) {
            var l, m = e(k).attr("id"),
                i;
            if (m.indexOf("Row") > -1) {
                l = "Purchase New Row"
            } else {
                if (m.indexOf("Item") > -1) {
                    l = j.type
                } else {
                    if (m.indexOf("Slot") > -1) {
                        l = "Purchase New Slot"
                    } else {
                        if (m.indexOf("Preset") > -1) {
                            l = "Purchase New Preset"
                        }
                    }
                }
            }
            return l
        };
    var d = function (m, l) {
            var o = [],
                k = [],
                i = +(seed.throne.activeSlot),
                n = seed.throne.slotEquip[i],
                j = [],
                p = e(m).attr("id");
            if (l) {
                if (l.isBroken) {
                    if (cm.WorldSettings.isOn("TR_KILLSWITCH_PH2")) {
                        o.push("repair")
                    }
                } else {
                    if (l.isEquipped === true) {
                        o.push("unequip")
                    } else {
                        o.push("equip")
                    }
                    if (cm.WorldSettings.isOn("TR_KILLSWITCH_PH2")) {
                        o.push("enhance");
                        o.push("upgrade");
                        o.push("salvage")
                    }
                }
            } else {
                if (p.indexOf("Row") > -1) {
                    o.push("buyRow")
                } else {
                    if (p.indexOf("Preset") > -1) {
                        o.push("buyPreset")
                    }
                }
            }
            e.each(o, function (q, s) {
                var r = {};
                switch (s) {
                case "unequip":
                    r.text = "Unequip";
                    r.color = "blue";
                    r.action = function () {
                        e("#contextMenu").remove();
                        cm.ThroneController.unequipItem(l)
                    };
                    k.push(r);
                    break;
                case "equip":
                    r.text = "Equip";
                    r.color = "blue";
                    r.action = function () {
                        e("#contextMenu").remove();
                        cm.ThroneController.equipItem(l)
                    };
                    k.push(r);
                    break;
                case "salvage":
                    r.text = "Salvage";
                    r.color = "red";
                    r.action = function () {
                        e("#contextMenu").remove();
                        cm.ThroneController.salvageItem(l)
                    };
                    k.push(r);
                    break;
                case "enhance":
                    r.text = g_js_strings.throneRoom.button_enhance;
                    r.color = "brown";
                    r.action = function () {
                        cm.ThronePanelView.renderPanel("enhance", l)
                    };
                    k.push(r);
                    break;
                case "upgrade":
                    r.text = g_js_strings.throneRoom.button_upgrade;
                    r.color = "brown";
                    r.action = function () {
                        cm.ThronePanelView.renderPanel("upgrade", l)
                    };
                    k.push(r);
                    break;
                case "modify":
                    r.text = g_js_strings.throneRoom.button_modify;
                    r.color = "grey";
                    r.action = function () {
                        cm.ModalManager.alert({
                            text: g_js_strings.comingsoon.comingsoon,
                            button_text: g_js_strings.commonstr.ok,
                            exe: function () {
                                cm.ModalManager.close()
                            }
                        })
                    };
                    k.push(r);
                    break;
                case "repair":
                    r.text = g_js_strings.throneRoom.button_repair;
                    r.color = "blue";
                    r.action = function () {
                        cm.ThronePanelView.renderBroken(l)
                    };
                    k.push(r);
                    break;
                case "instantRepair":
                    r.text = g_js_strings.throneRoom.button_instantRepair;
                    r.color = "green";
                    r.action = function () {
                        cm.ThronePanelController.instantRepair(l)
                    };
                    k.push(r);
                    break;
                case "buyRow":
                    r.text = "Buy";
                    r.color = "green";
                    r.action = function () {
                        e("#contextMenu").remove();
                        cm.ThroneController.buyRow(m)
                    };
                    k.push(r);
                    break;
                case "buyPreset":
                    r.text = "Buy";
                    r.color = "green";
                    r.action = function () {
                        e("#contextMenu").remove();
                        cm.ThroneController.buyPreset(m)
                    };
                    k.push(r);
                    break;
                default:
                    break
                }
            });
            return k
        };
    var c = function (l) {
            var i = "",
                n = e(l).attr("id"),
                k, j, m;
            if (n.indexOf("Row") > -1) {
                k = "row";
                j = "TR_ROW_COST_" + (seed.throne.rowNum + 1);
                m = cm.WorldSettings.getSetting(j)
            } else {
                if (n.indexOf("Item") > -1) {
                    k = "item"
                } else {
                    if (n.indexOf("Slot") > -1) {
                        k = "slot";
                        j = "TR_PRESET_COST_" + (seed.throne.slotNum + 1);
                        m = cm.WorldSettings.getSetting(j)
                    } else {
                        if (n.indexOf("Preset") > -1) {
                            k = "preset";
                            j = "TR_PRESET_COST_" + (seed.throne.slotNum + 1);
                            m = cm.WorldSettings.getSetting(j)
                        }
                    }
                }
            }
            switch (k) {
            case "item":
                i = "";
                break;
            case "row":
                i = "<div class='body'><span class='cost'>" + m + "</span></div>";
                break;
            case "slot":
                i = "<div class='body'><span class='cost'>" + m + "</span></div>";
                break;
            case "preset":
                i = "<div class='body'><span class='cost'>" + m + "</span></div>";
                break;
            default:
                i = "This thing is sooo broken!";
                break
            }
            return i
        };
    var b = function (k) {
            var i = +(seed.throne.activeSlot),
                l = seed.throne.slotEquip[i],
                j = [];
            e("#throneInventoryItem" + k.id).removeClass("equip");
            e("#throneInventoryItem" + k.id).unbind("click");
            e("#throneInventoryItem" + k.id).bind("click", function () {
                h(this, k)
            });
            cm.ThroneView.equipTimer();
            k.isEquipped = false;
            e.each(l, function (m, n) {
                if (n !== k.id) {
                    j.push(n)
                }
            });
            seed.throne.slotEquip[i] = j;
            cm.ThroneView.renderThrone();
            cm.ThroneView.renderStats()
        };
    var a = function (k) {
            var i = +(seed.throne.activeSlot),
                l = seed.throne.slotEquip[i],
                j = [];
            cm.ThroneController.checkType(k);
            cm.ThroneView.equipTimer();
            e("#throneInventoryItem" + k.id).addClass("equip");
            e("#throneInventoryItem" + k.id).unbind("click");
            e("#throneInventoryItem" + k.id).bind("click", function () {
                h(this, k)
            });
            k.isEquipped = true;
            seed.throne.slotEquip[i].push(k.id);
            cm.ThroneView.renderThrone();
            cm.ThroneView.renderStats()
        };
    var f = function () {};
    f();
    return {
        renderMenu: h
    }
}(jQuery);
cm = cm || {};
cm.ContextualMenuView = function (b) {
    var d = function (j, i) {
            removeTooltip();
            b("#contextMenu").remove();
            var l, g, h, f, k = i.title,
                e = i.body;
            l = cm.ContextualMenuController.calcOffset(j, i);
            g = b("<div/>");
            g.attr("id", "contextMenu");
            g.css("top", l.top);
            g.css("left", l.left);
            g.mouseleave(function (m) {
                m.stopPropagation();
                b("#contextMenu").remove()
            });
            g.append(k);
            if (e) {
                g.append(e)
            }
            b.each(i.menu, function (m, n) {
                f = b("<a/>");
                f.addClass("buttonv2 h20 " + n.color);
                f.html(n.text);
                f.bind("click", n.action);
                g.append(f)
            });
            b("#mainbody").append(g)
        };
    var c = function (g) {
            var h, e, f;
            if (g.tile.type === "city") {
                e = "<span class='type'> City </span>"
            } else {
                if (g.tile.type) {
                    if (g.tile.type === "bcity") {
                        e = "<span class='type'>" + g_js_strings.commonstr.barbariancamp + "</span> <span class='level'> " + g_js_strings.commonstr.lv + g.tile.level + "</span>"
                    } else {
                        if (g.tile.type === "boss") {
                            e = "<span class='type'>Dark Forest</span> <span class='level'> Lvl." + g.tile.level + "</span>"
                        } else {
                            e = "<span class='type'>" + g.tile.type + "</span> <span class='level'> Lvl." + g.tile.level + "</span>"
                        }
                    }
                }
            }
            h = b("<div/>");
            h.addClass("title");
            h.html(e);
            return h
        };
    var a = function () {};
    return {
        init: a,
        renderMenu: d
    }
}(jQuery);
var cm = cm || {};
cm.ClientSideCookieManager = {
    setCookie: function (c, d, b) {
        var a = "";
        if (b) {
            var a = "; expires=" + b.toGMTString()
        }
        document.cookie = c + "=" + d + a + "; path=/"
    },
    getCookie: function (a) {
        var e = a + "=";
        var d = document.cookie.split(";");
        for (var c = 0; c < d.length; c++) {
            var b = d[c];
            while (b.charAt(0) == " ") {
                b = b.substring(1, b.length)
            }
            if (b.indexOf(e) == 0) {
                return b.substring(e.length, b.length)
            }
        }
        return null
    },
    deleteCookie: function (a) {
        if (null == cm.ClientSideCookieManager.getCookie(a)) {
            return
        }
        cm.ClientSideCookieManager.setCookie(a, "", new Date())
    }
};
cm.ConversionTracker = new function () {
    this.track = function (d, a, b) {
        var c = a + g_conversionTrackerAppend;
        new Ajax.Request(g_ajaxpath + "ajax/track.php" + window.g_ajaxsuffix, {
            method: "post",
            parameters: jQuery.extend({
                userGroup: d,
                tag: c,
                opt: b
            }, g_ajaxparams),
            onSuccess: function (e) {}
        })
    }
};
cm.MixPanelTrackerSetting = new function () {
    var b = "MixPanelTracking";
    var a = cm.ClientSideCookieManager.getCookie(b) == "true";
    this.enable = function () {
        cm.ClientSideCookieManager.setCookie(b, "true");
        a = true
    };
    this.disable = function () {
        cm.ClientSideCookieManager.setCookie(b, "false");
        a = false
    };
    this.isEnabled = function () {
        return false
    }
};
cm.MixPanelTracker = new function () {
    var a = false;
    var b = function () {};
    var c = {
        init: b,
        track: b,
        track_funnel: b,
        register: b,
        register_once: b,
        register_funnel: b,
        identify: b,
        api_host: "no_host"
    };
    this.init = function (e) {
        mpmetrics = c;
        a = cm.MixPanelTrackerSetting.isEnabled();
        if (a) {
            try {
                mpmetrics = new MixpanelLib("20336e560bf9f33eb8ad661529dd45b7")
            } catch (d) {
                mpmetrics = c
            }
            if (e) {
                mpmetrics.register(e)
            }
        }
    };
    this.track = function (d, f) {
        if (a && mpmetrics) {
            var e = d + g_conversionTrackerAppend;
            mpmetrics.track(e, f)
        }
    };
    this.trackFunnel = function (h, e, d, f) {
        if (a && mpmetrics) {
            var g = h + g_conversionTrackerAppend;
            mpmetrics.track_funnel(h, e, d, f)
        }
    }
};
cm.GATracker = function (b, c, f, a) {
    try {
        _gaq.push(["_trackEvent", b, c, f, a])
    } catch (d) {}
};
cm.Profiler = function (c, d) {
    var b = null;
    var a = null;
    this.getStartTime = function () {
        return b
    };
    this.start = function (f) {
        try {
            if (arguments.length > 0 && !isNaN(parseInt(f))) {
                b = f
            } else {
                b = (new Date()).getTime()
            }
            return b
        } catch (g) {
            return -1
        }
    };
    this.stop = function (f, h) {
        try {
            f = f ? true : false;
            if ((arguments.length > 1) && !isNaN(parseInt(h))) {
                a = h
            } else {
                a = (new Date()).getTime()
            }
            if (f) {
                return a
            }
            cm.GATracker(c, d, g_server, a - b);
            return a
        } catch (g) {
            return -1
        }
    };
    this.start()
};
var CountDown = Class.create({
    initialize: function (b, c, a) {
        this.elementIds = b;
        this.setSecondsLeft(c);
        this.pe = new PeriodicalExecuter(this.updateCountDown.bind(this), 1);
        this.done = false;
        this.callbackWhenDone = a
    },
    setSecondsLeft: function (a) {
        this.secondsLeft = a;
        this.endDate = new Date(new Date()).getTime() + (a * 1000)
    },
    updateCountDown: function () {
        var a = new Date();
        var b = this.endDate - a;
        if (b <= 0) {
            this.pe.stop();
            this.done = true;
            var c = this;
            $w(this.elementIds).each(function (d) {
                if ($(d) && c.callbackWhenDone) {
                    c.callbackWhenDone(d)
                } else {
                    if ($(d)) {
                        $(d).update("Done!")
                    }
                }
            });
            return
        }
        $w(this.elementIds).each(function (d) {
            if ($(d)) {
                $(d).update(timestr(parseInt(b / 1000)))
            }
        })
    }
});
CountDown.countdownTimers = new Hash();
CountDown.addCountDown = function (c, d, b) {
    if (typeof (CountDown.countdownTimers.get(c)) === "undefined") {
        CountDown.countdownTimers.set(c, new CountDown(c, d, b))
    } else {
        var a = CountDown.countdownTimers.get(c);
        if (a.done && d > 0) {
            CountDown.countdownTimers.unset(c);
            CountDown.countdownTimers.set(c, new CountDown(c, d, b))
        } else {
            a.setSecondsLeft(d);
            if (b && d == 0) {
                b()
            }
        }
    }
};
CountDown.stopCountDown = function (a) {
    if (CountDown.countdownTimers._object[a]) {
        CountDown.countdownTimers._object[a].pe.stop();
        delete CountDown.countdownTimers._object[a]
    }
};

function changeview_court(b) {
    var a = new Array();
    a.push("<div id='courtView'>");
    a.push("<div class='waiting'></div>");
    a.push("</div>");
    Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.court, a.join(""));
    changeview_court_content(b)
}

function changeview_court_content(uid) {
    var pid = uid || tvuid;
    var params = Object.clone(g_ajaxparams);
    params.pid = pid;
    new Ajax.Request(g_ajaxpath + "ajax/viewCourt.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                var allianceMember = 0;
                if (seed.allianceDiplomacies && (seed.allianceDiplomacies.allianceId == rslt.playerInfo.allianceId)) {
                    allianceMember = 1
                }
                var mine = uid ? 0 : 1;
                var friend = 0;
                if (seed.appFriends && !mine) {
                    var friendids = Object.keys(seed.appFriends);
                    for (var i = 0; i < friendids.length; i++) {
                        if (friendids[i] == pid) {
                            friend = 1;
                            break
                        }
                    }
                }
                var action1 = parseInt(Math.random() * 100 / 25);
                var action2 = parseInt(Math.random() * 100 / 25);
                while (action2 == action1) {
                    action2 = parseInt(Math.random() * 100 / 25)
                }
                var actionFlag = parseInt(rslt.dailyActionFlag);
                var jesterFlag = 0;
                var dogsFlag = 0;
                var sculptFlag = 0;
                var metalFlag = 0;
                var glass = 0;
                var banner = 0;
                var painting = 0;
                var throne = 0;
                var weapons = 0;
                var curtains = "";
                var olympicflag = "";
                for (var i = 0; i < rslt.courtItems.length; i++) {
                    switch (parseInt(rslt.courtItems[i])) {
                    case 711:
                        jesterFlag = 1;
                        break;
                    case 721:
                        dogsFlag = 1;
                        break;
                    case 731:
                        sculptFlag = 1;
                        break;
                    case 741:
                        metalFlag = 1;
                        break;
                    case 801:
                        glass = 1;
                        break;
                    case 802:
                        glass = 2;
                        break;
                    case 803:
                        glass = 3;
                        break;
                    case 804:
                        glass = 4;
                        break;
                    case 805:
                        glass = 5;
                        break;
                    case 811:
                        banner = 1;
                        break;
                    case 812:
                        banner = 2;
                        break;
                    case 813:
                        banner = 3;
                        break;
                    case 814:
                        banner = 4;
                        break;
                    case 821:
                        painting = 1;
                        break;
                    case 822:
                        painting = 2;
                        break;
                    case 823:
                        painting = 3;
                        break;
                    case 824:
                        painting = 4;
                        break;
                    case 825:
                        painting = 5;
                        break;
                    case 831:
                        curtains = "red";
                        break;
                    case 832:
                        curtains = "blue";
                        break;
                    case 833:
                        curtains = "purple";
                        break;
                    case 834:
                        curtains = "green";
                        break;
                    case 835:
                        curtains = "yellow";
                        break;
                    case 891:
                        curtains = "orange";
                    case 841:
                        throne = 1;
                        break;
                    case 842:
                        throne = 2;
                        break;
                    case 843:
                        throne = 3;
                        break;
                    case 844:
                        throne = 4;
                        break;
                    case 845:
                        throne = 5;
                        break;
                    case 851:
                        weapons = 1;
                        break;
                    case 852:
                        weapons = 2;
                        break;
                    case 853:
                        weapons = 3;
                        break;
                    case 854:
                        weapons = 4;
                        break;
                    case 855:
                        weapons = 5;
                        break;
                    case 860:
                        olympicflag = "usa";
                        break;
                    case 861:
                        olympicflag = "uk";
                        break;
                    case 862:
                        olympicflag = "ca";
                        break;
                    case 863:
                        olympicflag = "au";
                        break;
                    case 864:
                        olympicflag = "se";
                        break;
                    case 865:
                        olympicflag = "dk";
                        break;
                    case 866:
                        olympicflag = "no";
                        break;
                    case 867:
                        olympicflag = "it";
                        break;
                    case 868:
                        olympicflag = "de";
                        break;
                    case 869:
                        olympicflag = "fr";
                        break;
                    case 870:
                        olympicflag = "at";
                        break;
                    case 871:
                        olympicflag = "gr";
                        break;
                    case 872:
                        olympicflag = "ir";
                        break;
                    case 873:
                        olympicflag = "br";
                        break;
                    case 874:
                        olympicflag = "ch";
                        break;
                    case 875:
                        olympicflag = "fn";
                        break;
                    case 876:
                        olympicflag = "nl";
                        break;
                    case 877:
                        olympicflag = "cn";
                        break;
                    case 878:
                        olympicflag = "ru";
                        break;
                    case 879:
                        olympicflag = "kr";
                        break;
                    case 880:
                        olympicflag = "pirate";
                        break;
                    case 881:
                        olympicflag = "taiwan";
                        break;
                    case 882:
                        olympicflag = "japan";
                        break;
                    case 883:
                        olympicflag = "spain";
                        break;
                    case 884:
                        olympicflag = "turkey";
                        break;
                    case 885:
                        olympicflag = "england";
                        break;
                    case 886:
                        olympicflag = "scotland";
                        break;
                    case 887:
                        olympicflag = "wales";
                        break;
                    case 888:
                        olympicflag = "philippines";
                        break;
                    case 889:
                        olympicflag = "mexico";
                        break;
                    case 890:
                        olympicflag = "halloween";
                        break;
                    case 892:
                        olympicflag = "giving";
                        break;
                    case 893:
                        olympicflag = "fey";
                        break;
                    default:
                        break
                    }
                }
                var actionStringArr = [g_js_strings.changeview_court_content.havefeast, g_js_strings.changeview_court_content.gohunt, g_js_strings.changeview_court_content.commsculpt, g_js_strings.changeview_court_content.inspectmines];
                var actionDescStringArr = [g_js_strings.changeview_court_content.bonusfood, g_js_strings.changeview_court_content.bonuswood, g_js_strings.changeview_court_content.bonusstone, g_js_strings.changeview_court_content.bonusore];
                var corhtml = new Array();
                corhtml.push("<div class='courtwrap'>");
                corhtml.push("<div class='ladyinfowrap clearfix'>");
                corhtml.push("<div class='profilepic'><img src='" + stimgUrl + "img/avatars/25/" + rslt.playerInfo.playerSex.toLowerCase() + rslt.playerInfo.avatarId + ".jpg'/></div>");
                var playerTitle = g_js_strings.commonstr.lord;
                if (rslt.playerInfo.playerSex == "M") {
                    playerTitle = g_js_strings.commonstr.lord
                } else {
                    playerTitle = g_js_strings.commonstr.lady
                }
                corhtml.push("<div class='profilename'>" + playerTitle + " " + rslt.playerInfo.displayName + "</div>");
                corhtml.push("<div class='profileiconmight'></div>");
                corhtml.push("<div class='profiletext profiletextmight'><span>" + g_js_strings.commonstr.might + ":</span>" + rslt.playerInfo.might + "</div>");
                corhtml.push("<div class='profileicontitle'></div>");
                corhtml.push("<div class='profiletext profiletexttitle'><span>" + g_js_strings.commonstr.title + ":</span>" + titlenames[rslt.playerInfo.title] + "</div>");
                corhtml.push("<div class='profiletext profiletextcities'><span>" + g_js_strings.changeview_court_content.numofcities + ":</span>" + rslt.cityCount + "</div>");
                corhtml.push("<div class='profiletext profiletextalliance'><span>" + g_js_strings.commonstr.alliance + ":</span>" + (rslt.playerInfo.allianceName || "---") + "</div>");
                corhtml.push("</div>");
                corhtml.push("<div class='maincourt'>");
                if (banner) {
                    corhtml.push("<div class='banner banner" + banner + " " + curtains + "'></div>")
                }
                if (curtains) {
                    corhtml.push("<div class='curtain " + curtains + "'></div>")
                }
                if (painting) {
                    corhtml.push("<div class='painting painting" + painting + "'></div>")
                }
                if (weapons) {
                    corhtml.push("<div class='weapons weapons" + weapons + "'></div>")
                }
                if (throne) {
                    corhtml.push("<div class='throne throne" + throne + "'></div>")
                }
                if (glass) {
                    corhtml.push("<div class='glass glass" + glass + "'></div>")
                }
                if (jesterFlag) {
                    corhtml.push("<div class='jester'></div>")
                }
                if (dogsFlag) {
                    corhtml.push("<div class='huntingdog'></div>")
                }
                if (sculptFlag) {
                    corhtml.push("<div class='sculptor'></div>")
                }
                if (metalFlag) {
                    corhtml.push("<div class='metallurgist'></div>")
                }
                if (!olympicflag.blank()) {
                    corhtml.push("<div class='olympicflag " + olympicflag + "'></div>")
                }
                corhtml.push("</div>");
                corhtml.push("<div class='actionbar clearfix'>");
                if (mine) {
                    corhtml.push("<a  class='button14' onclick='cm.InventoryView.openInventory();return false;'><span>" + g_js_strings.commonstr.inventory + "</span></a>")
                } else {
                    if (friend && !allianceMember) {
                        corhtml.push("<a  class='button14' onclick='getMessageWindow(" + rslt.playerInfo.userId + ',"' + ((rslt.playerInfo.playerSex == "F") ? g_js_strings.commonstr.lady + " " : g_js_strings.commonstr.lord + " ") + rslt.playerInfo.displayName + "\");return false;'><span>" + g_js_strings.commonstr.message + "</span></a>");
                        corhtml.push("<a href='" + appUrl + "?page=choosegift' class='button14' target='_top' ><span>" + g_js_strings.changeview_court_content.givegift + "</span></a>");
                        corhtml.push("<a href='" + profileUrl + rslt.playerInfo.fbuid + "' class='button14' target='_blank' ><span>" + g_js_strings.changeview_court_content.viewfbprofile + "</span></a>");
                        if (!actionFlag) {
                            corhtml.push("<div id='courtActionBox'>");
                            corhtml.push("<div class='actiontext'>" + g_js_strings.changeview_court_content.courtlyactions + "</div>");
                            corhtml.push("<a  class='button20' onclick='doCourtAction(" + action1 + "," + pid + ")'><span>" + actionStringArr[action1] + "</span></a>");
                            corhtml.push("<a  class='button20' onclick='doCourtAction(" + action2 + "," + pid + ")'><span>" + actionStringArr[action2] + "</span></a>");
                            corhtml.push("</div>")
                        }
                    } else {
                        if (friend && allianceMember) {
                            corhtml.push("<a  class='button14' onclick='getMessageWindow(" + rslt.playerInfo.userId + ',"' + ((rslt.playerInfo.playerSex == "F") ? g_js_strings.commonstr.lady + " " : g_js_strings.commonstr.lord + " ") + rslt.playerInfo.displayName + "\");return false;'><span>" + g_js_strings.commonstr.message + "</span></a>");
                            corhtml.push("<a href='" + appUrl + "?page=choosegift' class='button14' target='_top' ><span>" + g_js_strings.changeview_court_content.givegift + "</span></a>");
                            corhtml.push("<a href='" + profileUrl + rslt.playerInfo.fbuid + "' class='button14' target='_blank' ><span>" + g_js_strings.changeview_court_content.viewfbprofile + "</span></a>");
                            if (!actionFlag) {
                                corhtml.push("<div id='courtActionBox'>");
                                corhtml.push("<div class='actiontext'>" + g_js_strings.changeview_court_content.courtlyactions + "</div>");
                                corhtml.push("<a  class='button20' onclick='doCourtAction(" + action1 + "," + pid + ")'><span>" + actionStringArr[action1] + "</span></a>");
                                corhtml.push("<a  class='button20' onclick='doCourtAction(" + action2 + "," + pid + ")'><span>" + actionStringArr[action2] + "</span></a>");
                                corhtml.push("</div>")
                            }
                        } else {
                            if (!friend && allianceMember) {
                                corhtml.push("<a  class='button14' onclick='getMessageWindow(" + rslt.playerInfo.userId + ',"' + ((rslt.playerInfo.playerSex == "F") ? g_js_strings.commonstr.lady + " " : g_js_strings.commonstr.lord + " ") + rslt.playerInfo.displayName + "\");return false;'><span>" + g_js_strings.commonstr.message + "</span></a>");
                                if (!actionFlag) {
                                    corhtml.push("<div id='courtActionBox'>");
                                    corhtml.push("<div class='actiontext'>" + g_js_strings.changeview_court_content.courtlyactions + "</div>");
                                    corhtml.push("<a  class='button20' onclick='doCourtAction(" + action1 + "," + pid + ")'><span>" + actionStringArr[action1] + "</span></a>");
                                    corhtml.push("<a  class='button20' onclick='doCourtAction(" + action2 + "," + pid + ")'><span>" + actionStringArr[action2] + "</span></a>");
                                    corhtml.push("</div>")
                                }
                            } else {
                                corhtml.push("<a  class='button14' onclick='getMessageWindow(" + rslt.playerInfo.userId + ',"' + ((rslt.playerInfo.playerSex == "F") ? g_js_strings.commonstr.lady + " " : g_js_strings.commonstr.lord + " ") + rslt.playerInfo.displayName + "\");return false;'><span>" + g_js_strings.commonstr.message + "</span></a>")
                            }
                        }
                    }
                }
                corhtml.push("</div>");
                corhtml.push("</div>");
                $("courtView").innerHTML = corhtml.join("");
                if (!actionFlag && !mine && !(!friend && !allianceMember)) {
                    var coracthtml = [];
                    coracthtml.push("<div class='courtactionbox'>");
                    coracthtml.push("<div class='title'>" + ((rslt.playerInfo.playerSex == "F") ? g_js_strings.commonstr.lady + " " : g_js_strings.commonstr.lord + " ") + rslt.playerInfo.displayName + " " + g_js_strings.commonstr.says.toLowerCase() + ":</div>");
                    coracthtml.push("<div class='pictextwrap clearfix'>");
                    coracthtml.push("<div class='picleft'>");
                    coracthtml.push("<img src='" + stimgUrl + "img/avatars/100/" + rslt.playerInfo.playerSex.toLowerCase() + rslt.playerInfo.avatarId + ".jpg'/>");
                    coracthtml.push("</div>");
                    coracthtml.push("<div class='txtright'>");
                    coracthtml.push(g_js_strings.changeview_court_content.invitedesc.replace("%1$s", seed.player.prefix).replace("%2$s", seed.player.name));
                    coracthtml.push("</div>");
                    coracthtml.push("</div>");
                    coracthtml.push("<div class='actionwrap clearfix'>");
                    coracthtml.push("<div class='action'>");
                    coracthtml.push("<div class='clearfix'><a class='button20' onclick='Modal.hideModal();doCourtAction(" + action1 + "," + pid + ");return false;'><span>" + actionStringArr[action1] + "</span></a></div>");
                    coracthtml.push("<div class='actiontext'>" + actionDescStringArr[action1] + "</div>");
                    coracthtml.push("</div>");
                    coracthtml.push("<div class='action'>");
                    coracthtml.push("<div class='clearfix'><a class='button20' onclick='Modal.hideModal();doCourtAction(" + action2 + "," + pid + ");return false;'><span>" + actionStringArr[action2] + "</span></a></div>");
                    coracthtml.push("<div class='actiontext'>" + actionDescStringArr[action2] + "</div>");
                    coracthtml.push("</div>");
                    coracthtml.push("</div>");
                    coracthtml.push("</div>");
                    Modal.showModal(500, 400, 130, 100, g_js_strings.modaltitles.courtlyaction, coracthtml.join(""))
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function doCourtAction(action, pid) {
    var recid = 1;
    switch (parseInt(action) + 1) {
    case 1:
        var imageName = "action_item_feast.jpg";
        var resourceType = "Food";
        break;
    case 2:
        var imageName = "action_item_hunt.jpg";
        var resourceType = "Wood";
        recid = 2;
        break;
    case 4:
        var imageName = "action_item_mining.jpg";
        var resourceType = "Ore";
        recid = 4;
        break;
    case 3:
        var imageName = "action_item_sculptor.jpg";
        var resourceType = "Stone";
        recid = 3;
        break;
    default:
        var imageName = "action_item_sculptor.jpg";
        var resourceType = "Stone";
        recid = 3;
        break
    }
    var params = Object.clone(g_ajaxparams);
    params.atype = parseInt(action) + 1;
    params.toid = pid;
    params.givercityid = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/courtDoAction.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                $("courtActionBox").hide();
                var coracthtml = [];
                coracthtml.push("<div class='rewardbox'>");
                coracthtml.push("<div class='actionconfirm'><img src='" + stimgUrl + "img/court/" + imageName + "'/></div>");
                coracthtml.push("<div class='actionconfirmbar clearfix'>");
                coracthtml.push("<div class='title'>You received:</div>");
                coracthtml.push("<div class='stat'>+" + rslt.gold + " Gold</div>");
                coracthtml.push("<div class='stat'>+" + rslt.resource + " " + resourceType + "</div>");
                coracthtml.push("<a class='button20'  onclick='Modal.hideModal();return false;'><span>OK</span></a>");
                coracthtml.push("</div>");
                coracthtml.push("</div>");
                seed.citystats["city" + currentcityid].gold[0] = parseInt(seed.citystats["city" + currentcityid].gold[0]) + parseInt(rslt.gold);
                seed.resources["city" + currentcityid]["rec" + recid][0] = parseInt(seed.resources["city" + currentcityid]["rec" + recid][0]) + parseInt(rslt.resource) * 3600;
                update_gold();
                Modal.showModal(500, 400, 132, 89, "Congratulations!", coracthtml.join(""));
                UserEngagement.popViralModalUEP()
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
};
cm = cm || {};
cm.CraftingView = function (g) {
    var c = 1,
        j = 0,
        d = null,
        k = null,
        a, b;
    var f = function () {
            jQuery.each(seed.buildings["city" + currentcityid], function (x, w) {
                if (w[0] == "20" || w[0] == 20) {
                    cm.CraftingView.feySpire = w;
                    cm.CraftingView.feySpireLevel = w[1];
                    return false
                } else {
                    cm.CraftingView.feySpire = null;
                    cm.CraftingView.feySpireLevel = 0
                }
            });
            var q = kocRecipes[1],
                s = kocRecipes[1][0],
                o = cm.RecipeController.calcFailure(s),
                v = cm.RecipeController.calcInsurance(s),
                n = cm.CraftingView.feySpire,
                p = (n) ? ~~ (1 * cm.CraftingView.feySpireLevel) : 0,
                t = ~~ (1 * s.requirements.building),
                r = (p >= t) ? "blue" : "gray";
            if (!cm.WorldSettings.isOn("DARK_FOREST_CRAFTING_KILLSWITCH")) {
                r = "gray"
            }
            cm.CraftingView.selectedRecipes = q;
            cm.CraftingView.selectedRecipe = s;
            var u = cm.Template.renderTemplate("Crafting", "openCrafting", {
                title: g_js_strings.crafting.title,
                gemsString: g_js_strings.commonstr.gems,
                tabGeneral: g_js_strings.commonstr.general,
                tabSpeedup: g_js_strings.commonstr.speedup,
                tabCombat: g_js_strings.commonstr.combat,
                tabResources: g_js_strings.commonstr.resources,
                tabCourt: g_js_strings.commonstr.court,
                recipesList: cm.CraftingView.renderRecipesList(q),
                insuranceLabel: g_js_strings.crafting.insuranceLabel,
                insuranceHint: g_js_strings.crafting.insuranceHint,
                failureRate: o,
                insurancePrice: v,
                ingredientsList: cm.CraftingView.renderIngredientsList(s),
                outputItem: s.output,
                consolationItem: s.consolation,
                craftButtonType: r,
                craftButtonText: g_js_strings.commonstr.craft
            });
            return u
        };
    var h = function (s) {
            var p = [],
                q, o, r = cm.CraftingView.feySpire,
                n = (r) ? ~~ (1 * cm.CraftingView.feySpireLevel) : 0;
            cm.CraftingView.selectedRecipes = s;
            jQuery.each(s, function (u, t) {
                q = ksoItems[t.output];
                o = ~~ (1 * t.requirements.building);
                if (n >= o && u == 0) {
                    p.push("<li class='selected' onclick='cm.CraftingView.changeIngredientsList(" + t.id + ", this);'>")
                } else {
                    if (n >= o) {
                        p.push("<li class='active' onclick='cm.CraftingView.changeIngredientsList(" + t.id + ", this);'>")
                    } else {
                        p.push("<li class='inactive' onclick='cm.CraftingView.changeIngredientsList(" + t.id + ", this);'>")
                    }
                }
                p.push("<span class='recipe'>" + t.name + " L" + t.requirements.building + "</span>");
                p.push("<span class='item'>" + q.name + "</span>");
                p.push("</li>")
            });
            return p.join("")
        };
    var l = function (t) {
            var p = [],
                q = t.input,
                r, u = 1,
                v, n = seed.resources["city" + currentcityid]["rec5"][0];
            cm.CraftingView.recipeId = t.id;
            cm.CraftingView.selectedRecipe = t;
            jQuery.each(q.items, function (x, w) {
                v = ksoItems[x];
                p.push("<li class='element" + u + "'>");
                p.push("<span class='name'>" + v.name + "</span>");
                if (v.count >= w) {
                    p.push("<span class='amount sufficient'>" + v.count + "/" + w + "</span>")
                } else {
                    p.push("<span class='amount insufficient'>" + v.count + "/" + w + "</span>")
                }
                p.push(" <div class='item'>");
                p.push(" <span class='item" + v.id + "_70'> </span>");
                p.push(" <span class='frame'> </span>");
                p.push(" </div>");
                p.push("</li>");
                ++u
            });
            jQuery.each(q.resources, function (x, w) {
                p.push("<li class='element" + u + "'>");
                p.push("<span class='name'>" + g_js_strings.commonstr.aetherstone + "</span>");
                if (n >= w) {
                    p.push("<span class='amount sufficient'>" + n + "/" + w + "</span>")
                } else {
                    p.push("<span class='amount insufficient'>" + n + "/" + w + "</span>")
                }
                p.push(" <div class='item'>");
                p.push(" <span class='item resource5_70'> </span>");
                p.push(" <span class='frame'> </span>");
                p.push(" </div>");
                p.push("</li>");
                ++u
            });
            var s = [];
            for (var o = (u); o <= 6; ++o) {
                s.push(o)
            }
            jQuery.each(s, function (x, w) {
                p.push("<li class='element" + u + " empty'>");
                p.push(" <div class='item'>");
                p.push(" </div>");
                p.push("</li>");
                ++u
            });
            return p.join("")
        };
    var m = function (p, o) {
            var q = kocRecipes[p],
                n = cm.CraftingView.renderRecipesList(q);
            cm.CraftingView.categoryId = p;
            cm.CraftingView.selectedRecipes = q;
            jQuery("#recipeNavigationList").find("li.selected").removeClass("selected");
            g(o).addClass("selected");
            jQuery("#recipesList").html(n);
            cm.CraftingView.changeIngredientsList(0, jQuery("#recipesList").find("li")[0])
        };
    var e = function (s, u) {
            var n = cm.CraftingView.selectedRecipes,
                x = n[s],
                y = cm.CraftingView.renderIngredientsList(x),
                v = cm.RecipeController.calcFailure(x),
                z = cm.RecipeController.calcInsurance(x),
                o = cm.CraftingView.feySpire,
                q = (o) ? ~~ (1 * cm.CraftingView.feySpireLevel) : 0,
                w = ~~ (1 * x.requirements.building),
                t = (q >= w) ? "blue" : "gray",
                r = ksoItems[x.output].name,
                A = (x.consolation) ? ksoItems[x.consolation].name : null,
                p;
            if (!cm.WorldSettings.isOn("DARK_FOREST_CRAFTING_KILLSWITCH")) {
                t = "gray"
            }
            cm.CraftingView.recipeId = s;
            cm.CraftingView.selectedRecipe = x;
            jQuery("#recipesList").find("li.selected").removeClass("selected").addClass("active");
            g(u).addClass("selected");
            jQuery("#ingredientsList").html(y);
            jQuery("#recipeOutputItem").attr("class", "");
            jQuery("#recipeOutputItem").addClass("item" + x.output + "_70 outputItem");
            jQuery("#itemFrame").bind("mouseover", function (B) {
                p = g_js_strings.crafting.hoverOutputMessage.replace("%1$s", r);
                Tooltip.show(B, p, [-50, 0])
            });
            jQuery("#itemFrame").bind("mouseout", function () {
                Tooltip.hide()
            });
            jQuery("#recipeConsolationItem").attr("class", "");
            jQuery("#recipeConsolationItem").addClass("item" + x.consolation + "_30 consolation");
            jQuery("#recipeConsolationItem").bind("mouseover", function (B) {
                if (A != null) {
                    p = g_js_strings.crafting.hoverConsolationMessage.replace("%1$s", A)
                } else {
                    p = g_js_strings.crafting.hoverConsolationMessage2
                }
                Tooltip.show(B, p, [-10, 5])
            });
            jQuery("#recipeConsolationItem").bind("mouseout", function () {
                Tooltip.hide()
            });
            jQuery("#recipeRateIndicator").attr("class", "");
            jQuery("#recipeRateIndicator").addClass("rate " + v);
            jQuery("#recipeRateIndicator").html(v);
            jQuery("#recipeInsuranceAmount").html(z);
            jQuery("#recipeCraftButton").attr("class", "");
            jQuery("#recipeCraftButton").addClass("gemButton " + t);
            jQuery("#recipeCraftButton").unbind("click");
            if (cm.WorldSettings.isOn("DARK_FOREST_CRAFTING_KILLSWITCH")) {
                if (q >= w) {
                    jQuery("#recipeCraftButton").bind("click", function () {
                        cm.RecipeController.craft(x)
                    })
                } else {
                    jQuery("#recipeCraftButton").unbind("click")
                }
            } else {
                jQuery("#recipeCraftButton").bind("mouseover", function (B) {
                    Tooltip.show(B, g_js_strings.crafting.craftingDisabled, [-100, 50])
                });
                jQuery("#recipeCraftButton").bind("mouseout", function () {
                    Tooltip.hide()
                })
            }
        };
    var i = function () {};
    i();
    return {
        categoryId: c,
        recipeId: j,
        selectedRecipes: d,
        selectedRecipe: k,
        openCrafting: f,
        renderRecipesList: h,
        renderIngredientsList: l,
        changeCraftingCategory: m,
        changeIngredientsList: e
    }
}(jQuery);
cm = cm || {};
cm.CRMLink = function ($) {
    var url_ = {
        help: "",
        reportChat: "",
        reportMail: ""
    };
    var update_ = function () {
            ajax.Request(g_ajaxpath + "ajax/getHelpUrls.php" + g_ajaxsuffix, {
                method: "post",
                parameters: g_ajaxparams,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        for (var i in url_) {
                            if (rslt[i + "Url"]) {
                                url_[i] = rslt[i + "Url"]
                            }
                        }
                    }
                }
            })
        };
    return {
        update: update_,
        open: function (type) {
            if (type && url_[type]) {
                window.open(url_[type])
            }
        }
    }
}(jQuery);
cm = cm || {};
cm.DailyRewardsView = function (d) {
    var k, i, f, h = [],
        g = 5;
    var c = function () {
            var n = d("#hudThirdContainer");
            n.remove();
            b()
        };
    var m = function () {
            var q = "",
                s = (i > 5) ? i : 1,
                o = (i > 5) ? i + 5 : 5,
                r;
            for (var p = 0, n = (o - s); p <= n; ++p) {
                if ((i > 5) && (p == 0)) {
                    r = h[5];
                    rewardStatus = "checked"
                } else {
                    if ((i > 5) && (p > 0)) {
                        r = 999;
                        rewardStatus = "empty"
                    } else {
                        r = h[p];
                        rewardStatus = ((p + 1) <= i) ? "checked" : "empty"
                    }
                }
                dayCount = s + p;
                checkStatus = (rewardStatus == "redeemed") ? "checked" : "";
                shadow = (rewardStatus == "empty") ? "<div class='shadow'></div>" : "";
                q += cm.Template.renderTemplate("DailyRewards", "rewardInfo", {
                    rewardStatus: rewardStatus,
                    position: (p + 1),
                    dayLabel: g_js_strings.DailyRewards.day,
                    dayCount: dayCount,
                    checkStatus: checkStatus,
                    itemId: "i" + r,
                    shadown: shadow
                })
            }
            return q
        };
    var j = function () {
            var n;
            if (i <= 5) {
                n = (100 * (i / g))
            } else {
                n = 100
            }
            return n
        };
    var b = function () {
            var s, q;
            if (i <= 5) {
                s = h[i - 1]
            } else {
                s = h[5]
            }
            q = ksoItems[s].name;
            var o = m(),
                n = j(),
                r = g_js_strings.DailyRewards.title,
                p = cm.Template.renderTemplate("DailyRewards", "openMain", {
                    title: r,
                    notification: g_js_strings.DailyRewards.notification,
                    itemName: q,
                    itemAdded: g_js_strings.DailyRewards.itemAdded,
                    itemNotification: g_js_strings.DailyRewards.itemNotification,
                    dayLabel: g_js_strings.DailyRewards.day,
                    button: g_js_strings.DailyRewards.button,
                    rewardInfoHtml: o,
                    progressBar: n,
                    shareLabel: g_js_strings.DailyRewards.share
                });
            cm.ModalManager.add({
                body: p,
                closeNow: true,
                lower: false,
                "class": "dailyRewardModalContainer",
                curtain: true,
                width: 750,
                height: 500,
                left: 5,
                top: 5,
                z: 123456
            });
            d("#dailyRewardModalButton").bind("click", function () {
                a()
            });
            d(".dailyRewardModalContainer .close").bind("click", function () {
                l()
            });
            if (i > 5) {
                d("#progressBarContainer").remove()
            }
        };
    var l = function () {
            var n;
            if (i <= 5) {
                n = h[i - 1]
            } else {
                n = h[5]
            }
            AjaxCall.gPostRequest("ajax/_dispatch.php", {
                ctrl: "LoginRewards",
                action: "closeWithX"
            }, function () {
                cm.ModalManager.close();
                ksoItems[n].add();
                if (seed.beginnerPromo) {
                    cm.BeginnerPackageView.init(seed.beginnerPromo)
                }
                if (seed.sale) {
                    cm.SalesPromotionView.init(seed.sale)
                }
            })
        };
    var a = function () {
            var o, n = (d("#shareDailyRewardCheck:checked").length != 0);
            if (i <= 5) {
                o = h[i - 1]
            } else {
                o = h[5]
            }
            AjaxCall.gPostRequest("ajax/_dispatch.php", {
                ctrl: "LoginRewards",
                action: "claimReward",
                feedSent: ((n) ? 1 : 0)
            }, function () {
                cm.ModalManager.close();
                ksoItems[o].add();
                if (n) {
                    var q = new Array(),
                        p = seed.player.fname + " " + seed.player.lname;
                    common_postToProfile("303", Object.cloneFeed(template_data_303), Object.cloneFeed(actionlink_data_303), continuation_303, q)
                }
                if (seed.beginnerPromo) {
                    cm.BeginnerPackageView.init(seed.beginnerPromo)
                }
                if (seed.sale) {
                    cm.SalesPromotionView.init(seed.sale)
                }
            })
        };
    var e = function () {
            h = seed.loginReward.items || [];
            i = (~~ (1 * seed.loginReward.consec_days_logon) + 1) || 1;
            f = seed.loginReward.times_closed || 1;
            k = seed.loginReward.show_today;
            isShowHud = seed.loginReward.show_hud;
            var o = (seed.tutorial.t1 >= 19),
                n = cm.WorldSettings.hasKeyValuePair("LOGIN_REWARDS", "on");
            if (!isShowHud && k && o && n) {
                b()
            }
        };
    return {
        init: e,
        render: b,
        hudClick: c
    }
}(jQuery);

function formatDateByUnixTime(a) {
    return formatDate(new Date(a * 1000), "NNN dd, hh:mm a")
}
var MONTH_NAMES = new Array("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec");
var DAY_NAMES = new Array("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat");

function LZ(a) {
    return (a < 0 || a > 9 ? "" : "0") + a
}

function isDate(c, b) {
    var a = getDateFromFormat(c, b);
    if (a == 0) {
        return false
    }
    return true
}

function compareDates(e, f, c, d) {
    var b = getDateFromFormat(e, f);
    var a = getDateFromFormat(c, d);
    if (b == 0 || a == 0) {
        return -1
    } else {
        if (b > a) {
            return 1
        }
    }
    return 0
}

function formatDate(I, D) {
    D = D + "";
    var l = "";
    var v = 0;
    var G = "";
    var f = "";
    var j = I.getYear() + "";
    var g = I.getMonth() + 1;
    var F = I.getDate();
    var o = I.getDay();
    var n = I.getHours();
    var x = I.getMinutes();
    var q = I.getSeconds();
    var t, u, b, r, J, e, C, B, z, p, N, n, L, i, a, A;
    var w = new Object();
    if (j.length < 4) {
        j = "" + (j - 0 + 1900)
    }
    w.y = "" + j;
    w.yyyy = j;
    w.yy = j.substring(2, 4);
    w.M = g;
    w.MM = LZ(g);
    w.MMM = MONTH_NAMES[g - 1];
    w.NNN = MONTH_NAMES[g + 11];
    w.d = F;
    w.dd = LZ(F);
    w.E = DAY_NAMES[o + 7];
    w.EE = DAY_NAMES[o];
    w.H = n;
    w.HH = LZ(n);
    if (n == 0) {
        w.h = 12
    } else {
        if (n > 12) {
            w.h = n - 12
        } else {
            w.h = n
        }
    }
    w.hh = LZ(w.h);
    if (n > 11) {
        w.K = n - 12
    } else {
        w.K = n
    }
    w.k = n + 1;
    w.KK = LZ(w.K);
    w.kk = LZ(w.k);
    if (n > 11) {
        w.a = "PM"
    } else {
        w.a = "AM"
    }
    w.m = x;
    w.mm = LZ(x);
    w.s = q;
    w.ss = LZ(q);
    while (v < D.length) {
        G = D.charAt(v);
        f = "";
        while ((D.charAt(v) == G) && (v < D.length)) {
            f += D.charAt(v++)
        }
        if (w[f] != null) {
            l = l + w[f]
        } else {
            l = l + f
        }
    }
    return l
}

function _isInteger(c) {
    var b = "1234567890";
    for (var a = 0; a < c.length; a++) {
        if (b.indexOf(c.charAt(a)) == -1) {
            return false
        }
    }
    return true
}

function _getInt(f, d, e, c) {
    for (var a = c; a >= e; a--) {
        var b = f.substring(d, d + a);
        if (b.length < e) {
            return null
        }
        if (_isInteger(b)) {
            return b
        }
    }
    return null
}

function getDateFromFormat(w, p) {
    w = w + "";
    p = p + "";
    var v = 0;
    var l = 0;
    var r = "";
    var f = "";
    var u = "";
    var h, g;
    var b = new Date();
    var j = b.getYear();
    var t = b.getMonth() + 1;
    var s = 1;
    var d = b.getHours();
    var q = b.getMinutes();
    var n = b.getSeconds();
    var k = "";
    while (l < p.length) {
        r = p.charAt(l);
        f = "";
        while ((p.charAt(l) == r) && (l < p.length)) {
            f += p.charAt(l++)
        }
        if (f == "yyyy" || f == "yy" || f == "y") {
            if (f == "yyyy") {
                h = 4;
                g = 4
            }
            if (f == "yy") {
                h = 2;
                g = 2
            }
            if (f == "y") {
                h = 2;
                g = 4
            }
            j = _getInt(w, v, h, g);
            if (j == null) {
                return 0
            }
            v += j.length;
            if (j.length == 2) {
                if (j > 70) {
                    j = 1900 + (j - 0)
                } else {
                    j = 2000 + (j - 0)
                }
            }
        } else {
            if (f == "MMM" || f == "NNN") {
                t = 0;
                for (var o = 0; o < MONTH_NAMES.length; o++) {
                    var e = MONTH_NAMES[o];
                    if (w.substring(v, v + e.length).toLowerCase() == e.toLowerCase()) {
                        if (f == "MMM" || (f == "NNN" && o > 11)) {
                            t = o + 1;
                            if (t > 12) {
                                t -= 12
                            }
                            v += e.length;
                            break
                        }
                    }
                }
                if ((t < 1) || (t > 12)) {
                    return 0
                }
            } else {
                if (f == "EE" || f == "E") {
                    for (var o = 0; o < DAY_NAMES.length; o++) {
                        var m = DAY_NAMES[o];
                        if (w.substring(v, v + m.length).toLowerCase() == m.toLowerCase()) {
                            v += m.length;
                            break
                        }
                    }
                } else {
                    if (f == "MM" || f == "M") {
                        t = _getInt(w, v, f.length, 2);
                        if (t == null || (t < 1) || (t > 12)) {
                            return 0
                        }
                        v += t.length
                    } else {
                        if (f == "dd" || f == "d") {
                            s = _getInt(w, v, f.length, 2);
                            if (s == null || (s < 1) || (s > 31)) {
                                return 0
                            }
                            v += s.length
                        } else {
                            if (f == "hh" || f == "h") {
                                d = _getInt(w, v, f.length, 2);
                                if (d == null || (d < 1) || (d > 12)) {
                                    return 0
                                }
                                v += d.length
                            } else {
                                if (f == "HH" || f == "H") {
                                    d = _getInt(w, v, f.length, 2);
                                    if (d == null || (d < 0) || (d > 23)) {
                                        return 0
                                    }
                                    v += d.length
                                } else {
                                    if (f == "KK" || f == "K") {
                                        d = _getInt(w, v, f.length, 2);
                                        if (d == null || (d < 0) || (d > 11)) {
                                            return 0
                                        }
                                        v += d.length
                                    } else {
                                        if (f == "kk" || f == "k") {
                                            d = _getInt(w, v, f.length, 2);
                                            if (d == null || (d < 1) || (d > 24)) {
                                                return 0
                                            }
                                            v += d.length;
                                            d--
                                        } else {
                                            if (f == "mm" || f == "m") {
                                                q = _getInt(w, v, f.length, 2);
                                                if (q == null || (q < 0) || (q > 59)) {
                                                    return 0
                                                }
                                                v += q.length
                                            } else {
                                                if (f == "ss" || f == "s") {
                                                    n = _getInt(w, v, f.length, 2);
                                                    if (n == null || (n < 0) || (n > 59)) {
                                                        return 0
                                                    }
                                                    v += n.length
                                                } else {
                                                    if (f == "a") {
                                                        if (w.substring(v, v + 2).toLowerCase() == "am") {
                                                            k = "AM"
                                                        } else {
                                                            if (w.substring(v, v + 2).toLowerCase() == "pm") {
                                                                k = "PM"
                                                            } else {
                                                                return 0
                                                            }
                                                        }
                                                        v += 2
                                                    } else {
                                                        if (w.substring(v, v + f.length) != f) {
                                                            return 0
                                                        } else {
                                                            v += f.length
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    if (v != w.length) {
        return 0
    }
    if (t == 2) {
        if (((j % 4 == 0) && (j % 100 != 0)) || (j % 400 == 0)) {
            if (s > 29) {
                return 0
            }
        } else {
            if (s > 28) {
                return 0
            }
        }
    }
    if ((t == 4) || (t == 6) || (t == 9) || (t == 11)) {
        if (s > 30) {
            return 0
        }
    }
    if (d < 12 && k == "PM") {
        d = d - 0 + 12
    } else {
        if (d > 11 && k == "AM") {
            d -= 12
        }
    }
    var a = new Date(j, t - 1, s, d, q, n);
    return a.getTime()
}

function parseDate(h) {
    var f = (arguments.length == 2) ? arguments[1] : false;
    generalFormats = new Array("y-M-d", "MMM d, y", "MMM d,y", "y-MMM-d", "d-MMM-y", "MMM d");
    monthFirst = new Array("M/d/y", "M-d-y", "M.d.y", "MMM-d", "M/d", "M-d");
    dateFirst = new Array("d/M/y", "d-M-y", "d.M.y", "d-MMM", "d/M", "d-M");
    var b = new Array("generalFormats", f ? "dateFirst" : "monthFirst", f ? "monthFirst" : "dateFirst");
    var g = null;
    for (var e = 0; e < b.length; e++) {
        var a = window[b[e]];
        for (var c = 0; c < a.length; c++) {
            g = getDateFromFormat(h, a[c]);
            if (g != 0) {
                return new Date(g)
            }
        }
    }
    return null
};
var cm = cm || {};
cm.ClientSideTemplate = {
    getTemplate: function (b, a, c) {
        new Ajax.Request(b, {
            method: "get",
            onSuccess: a,
            onFailure: c
        })
    }
};
cm.DesertionReportLoader = {
    init: function () {
        cm.DESERTION_REPORT_PRESENTATION_MODEL = g_js_strings.modal_messages_viewdesertionreports;
        cm.DESERTION_REPORT_PRESENTATION_MODEL.troopsdeserted = g_js_strings.modal_messages_viewdisasterreports.troopsdeserted;
        cm.DESERTION_REPORT_PRESENTATION_MODEL.troops = g_js_strings.commonstr.troops;
        cm.DESERTION_REPORT_PRESENTATION_MODEL.backtoreports = g_js_strings.modal_messages_viewreports_view.backtoreports;
        cm.DESERTION_REPORT_RULES = {
            self: null,
            notEnoughFood: cm.DESERTION_REPORT_PRESENTATION_MODEL.cityunableprovideenoughfood,
            lostTroops: '<div class="detailTableBody"><div class="troopTitleRow"><div class="typeColumn">{PRESENTATION_MODEL.trooptypes}</div><div class="beforeColumn">{PRESENTATION_MODEL.beforedesertion}</div><div class="afterColumn">{PRESENTATION_MODEL.afterdesertion}</div><div class="lostColumn">{PRESENTATION_MODEL.troopslost}</div></div>{$}</div>',
            "lostTroops[*]": '<div class="troopRow"><div class="typeColumn"><img src="{$.image}" /> {$.name}</div><div class="beforeColumn">{$.before}</div><div class="afterColumn">{$.after}</div><div class="lostColumn">{$.lost}</div></div>'
        };
        cm.DESERTION_REPORT_RULES.self = cm.Template.getTemplate("desertionReport_24", "self")
    }
};
Event.observe(document, "dom:loaded", cm.DesertionReportLoader.init);
cm.DesertionReportView = function (b) {
    if (!cm.DESERTION_REPORT_RULES.self) {
        throw "Desertion Report Template failed to load.";
        return
    }
    b.PRESENTATION_MODEL = cm.DESERTION_REPORT_PRESENTATION_MODEL;
    var a = document.createElement("div");
    a.innerHTML = jsonT(b, cm.DESERTION_REPORT_RULES);
    _backToReportButton = $(a).getElementsByClassName("button20")[0];
    this.getHTMLElement = function () {
        return a
    };
    this.getBackToReportButton = function () {
        return _backToReportButton
    };
    this.onClose = null;
    this.close = function () {
        if (typeof (this.onclose) == "function") {
            this.onclose(myself)
        }
    }
};
cm.DesertionReportController = function (b, a) {
    var d = this;
    var e = b;
    var g = a;
    var c = function (h) {
            loadPage_pagination("modal_msg_list_pagination", pageNavigatorModel.getCurrentPage(), "modal_messages_viewreports", pageNavigatorModel.getPageCount());
            location.replace("#mainbody")
        };
    var f = g.getBackToReportButton();
    f.observe("click", c, false)
};
var cm = cm || {};
cm.LevelUpRewardDialog = function (f) {
    cm.BaseDialog.call(this);
    var l = this;
    var c = this.getHtmlElement();
    var i;
    var e;
    var a;
    var j;
    var k = this.show;
    var g = function () {
            var n = a;
            a = false;
            if (n) {
                b()
            }
        };
    this.show = function () {
        a = true;
        Modal.onCloseCallback = g;
        Modal.showModal(440, 100, 200, 100, "", "");
        $("modalControlsClose" + Modal.modalid).hide();
        this.setParentElement($("modalContent" + Modal.modalid));
        k()
    };
    var b = function () {
            Event.stopObserving(e, "click", m);
            Event.stopObserving(i, "click", d);
            var n = a;
            a = false;
            if (n) {
                Modal.hideModal()
            }
            l.close()
        };
    var d = function (o) {
            var n = new cm.DialogEvent(cm.DialogEvent.OK);
            n.setTarget(l);
            l.dispatchCustomEvent(n);
            b()
        };
    var m = function (n) {
            b()
        };
    var h = function () {
            var n = [];
            n.push('<div class="levelUpRewardDialog">');
            n.push('    <a class="closeButton">&nbsp;</a>');
            n.push('    <div class="titleBar">{text.levelUp}</div>');
            n.push('    <div class="congratulation">{text.congratulations}</div>');
            n.push('    <div class="avatarName">{avatar.name}</div>');
            n.push('    <div class="avatarPicture"><img src ="{avatar.pictureUrl}" alt="{avatar.name}" /></div>');
            n.push('    <div class="avatarTitle">{avatar.title}</div>');
            n.push('    <div class="rewards">');
            n.push('        <div class="rewardTitle">{text.yourReward}</div>');
            n.push('        <div class="reward gold">');
            n.push('            <img src="img/gold_qa.png" alt="gold" width="70" height="70" />');
            n.push('            <div class="body">');
            n.push("                <div>{text.gold}</div>");
            n.push('                <div class="amount">{reward.gold}</div>');
            n.push("            </div>");
            n.push("        </div>");
            n.push('        <div class="reward title">');
            n.push('            <img src="img/title_qa.png" alt="title" width="70" height="70" />');
            n.push('            <div class="body">');
            n.push("                <div>{avatar.title}</div>");
            n.push("            </div>");
            n.push("        </div>");
            n.push("    </div>");
            n.push('    <a class="celebrateButton" href="javascript:void(0)">{text.celebrate}</a>');
            n.push("</div>");
            c.innerHTML = cm.StringFormatter.applyTemplate(n.join("\n"), f);
            i = $(c).getElementsByClassName("celebrateButton")[0];
            Event.observe(i, "click", d);
            e = $(c).getElementsByClassName("closeButton")[0];
            Event.observe(e, "click", m)
        };
    h()
};
cm.OOP.inherits(cm.LevelUpRewardDialog, cm.BaseDialog);
cm.LevelUpRewardDialogController = function (b, c) {
    var a = function (f) {
            c.removeEventListener(cm.DialogEvent.CLOSE, a);
            c.removeEventListener(cm.DialogEvent.OK, e);
            seed.player.title = b.avatar.level;
            $("topnav_level").innerHTML = seed.player.title
        };
    var e = function (g) {
            if (cm.feedTracking.get("shareQuestComplete") !== false && !cm.TutorialManager.inTutorialMode()) {
                var f = cm.LevelUtil.getQuestId(b.avatar.level);
                shareQuestComplete(f)
            }
        };
    var d = function () {
            c.addEventListener(cm.DialogEvent.CLOSE, a);
            c.addEventListener(cm.DialogEvent.OK, e)
        };
    d()
};
cm.WatchTowerReportDialog = function (d) {
    cm.BaseDialog.call(this);
    var l = this;
    var j = this.getHtmlElement();
    var k;
    var q;
    var n;
    var i;
    var f;
    var g;
    var c = this.show;
    var p = this.close;
    var m = function () {
            var s = g;
            g = false;
            if (s) {
                b()
            }
        };
    this.show = function () {
        g = true;
        Modal.onCloseCallback = m;
        Modal.showModal(440, 100, 200, 100, "", "");
        $("modalControlsClose" + Modal.modalid).hide();
        this.setParentElement($("modalContent" + Modal.modalid));
        c()
    };
    var b = function () {
            var s = g;
            g = false;
            if (s) {
                Modal.hideModal()
            }
            l.close();
            q.unbind("click", e);
            n.attack.removeEventListener(cm.IncomingAttackEvent.ARRIVAL_TIME_CHANGED, o);
            n.attack.removeEventListener(cm.IncomingAttackEvent.STATUS_CHANGED, a)
        };
    var e = function (s) {
            b()
        };
    var r = function () {
            if (d.attack.getMarchStatus() == cm.MARCH_STATUS.MARCH_STATUS_ABORTING) {
                i.innerHTML = g_js_strings.ImpendingAttacks.recalled
            } else {
                var s = d.attack.getArrivalTime();
                if (s) {
                    var t = s - unixtime();
                    i.innerHTML = cm.TimeFormatter.format(t)
                } else {
                    i.innerHTML = "????"
                }
            }
        };
    var o = function () {
            r()
        };
    var a = function () {
            r()
        };
    this.getButtons = function () {
        return f
    };
    var h = function () {
            g = false;
            n = d;
            n.attack.addEventListener(cm.IncomingAttackEvent.ARRIVAL_TIME_CHANGED, o);
            n.attack.addEventListener(cm.IncomingAttackEvent.STATUS_CHANGED, a);
            var y = [];
            y.push('	<div class="incomingAttackDetailDialog">');
            y.push('		<a class="closeButton">&nbsp;</a>');
            y.push('		<div class="titleBar">{text.watchTowerReport}</div>');
            y.push('		<div class="arrowContainer">');
            y.push('			<div class="targetColumn">');
            y.push('				<span class="title">{text.target}:</span> {target}');
            y.push("			</div>");
            y.push('			<div class="marchTypeColumn">');
            y.push('				<span class="title">{text.marchType}:</span> {attack.getMarchName()}');
            y.push("			</div>");
            y.push("		</div>");
            y.push('		<div class="arrival">{text.estimatedArrival}: <span class="arrivalTime"></span></div>');
            y.push('		<div class="attackerContainer">');
            y.push('			<table class="attacker">');
            y.push("				<tr>");
            y.push('					<td class="leftColumn">');
            y.push('						<div class="simpleRow">');
            y.push('							<span class="title">{text.attacker}:</span> <span class="value">{attacker.name}</span>');
            y.push("						</div>");
            y.push('						<div class="simpleRow">');
            y.push('							<span class="title">{text.armySize}:</span> <span class="value">{troopBriefCount}</span>');
            y.push("						</div>");
            y.push('						<div class="simpleRow">');
            y.push('							<span class="title">{text.incomingTroops}:</span>');
            y.push("						</div>");
            y.push("						{troops}");
            y.push("					</td>");
            y.push('					<td class="rightColumn">');
            y.push('						<div class="simpleRow">');
            y.push('							<span class="title">{text.alliance}:</span> <span class="value">{alliance.name}</span>');
            y.push("						</div>");
            y.push('						<div class="simpleRow">');
            y.push('							<span class="title">{text.knightCombatLevel}:</span> <span class="value">{knight.combatLevel}</span>');
            y.push("						</div>");
            y.push('						<div class="simpleRow">');
            y.push('							<span class="title">{text.researchLevel}:</span>');
            y.push("						</div>");
            y.push("						{researches}");
            y.push("					</td>");
            y.push("				</tr>");
            y.push("			</table>");
            y.push("		</div>");
            y.push('		<div class="takeAction">');
            y.push('			<div class="takeActionText">{text.takeAction}</div>');
            y.push('			<div class="fight">');
            y.push('				<div class="actionTitle">Fight</div>');
            y.push('				<div class="buttonRow"><a class="inlineButton blue25" title="{text.trainTroopsTip}"><span>{text.trainTroops}</span></a></div>');
            y.push('				<div class="buttonRow"><a class="inlineButton blue25" title="{text.askForHelpTip}"><span>{text.askForHelp}</span></a></div>');
            y.push('				<div class="footer"></div>');
            y.push("			</div>");
            y.push('			<div class="defend">');
            y.push('				<div class="actionTitle">Defend</div>');
            y.push('				<div class="buttonRow"><a class="inlineButton blue25" title="{text.buildDefensesTip}"><span>{text.buildDefenses}</span></a></div>');
            y.push('				<div class="buttonRow"><a class="inlineButton blue25" title="{text.troopSettingsTip}"><span>{text.troopSettings}</span></a></div>');
            y.push('				<div class="footer"></div>');
            y.push("			</div>");
            y.push('			<div class="buffs">');
            y.push('				<div class="buffBody">');
            y.push('					<div class="actionTitle">Buffs</div>');
            y.push("					{items}");
            y.push("				</div>");
            y.push('				<div class="buffFooter"></div>');
            y.push("			</div>");
            y.push("		</div>");
            y.push('		<div class="footer"></div>');
            y.push("	</div>");
            var J = [];
            J.push('						<div class="troopContainer">');
            J.push('							<table class="troops">');
            J.push("								<thead>");
            J.push("									<tr>");
            J.push('										<td class="troopImage"></td>');
            J.push('										<td class="troopName">Troops</td>');
            J.push('										<td class="troopAmount">Amount</td>');
            J.push("									</tr>");
            J.push("								</thead>");
            J.push("								<tbody>");
            J.push("									{$}");
            J.push("								</tbody>");
            J.push("							</table>");
            J.push("						</div>");
            var z = [];
            z.push("									<tr>");
            z.push('										<td><img src="{$.imageUrl}" /></td>');
            z.push("										<td>{$.name}</td>");
            z.push("										<td>{$.amount}</td>");
            z.push("									</tr>");
            var t = [];
            t.push('						<table class="research">');
            t.push("							<thead>");
            t.push("								<tr>");
            t.push('									<td class="tech">Tech</td>');
            t.push('									<td class="level">Level</td>');
            t.push("								</tr>");
            t.push("							</thead>");
            t.push("							<tbody>");
            t.push("								{$}");
            t.push("							</tbody>");
            t.push("						</table>");
            var v = [];
            v.push("								<tr>");
            v.push("									<td>{$.name}</td>");
            v.push("									<td>{$.level}</td>");
            v.push("								</tr>");
            var B = "{$}";
            var u = [];
            u.push('					<div class="buffItem" id="buffItem{$.getId()}">');
            u.push('						<div class="leftColumn" title="{$.getDescription()}">');
            u.push('							<img src="{$.getImageUrl(30)}" class="icon" />');
            u.push('							<div class="amountRow">{$.getQuantity()}</div>');
            u.push("						</div>");
            u.push('						<div class="rightColumn">');
            u.push('							<div class="applyRow"><a class="inlineButton blue11 applyButton" name="{$.getId()}"><span>{text.apply}</span></a></div>');
            u.push('							<div class="buyRow"><span class="price">{$.getPrice()}</span><img src="{imagePath}img/gem.png" height="11" /><a class="buyButton" name="{$.getId()}">{text.buy}</a></div>');
            u.push("						</div>");
            u.push("					</div>");
            var w = {
                self: y.join(""),
                troops: J.join(""),
                "troops[*]": z.join(""),
                researches: t.join(""),
                "researches[*]": v.join(""),
                items: B,
                "items[*]": u.join("")
            };
            j.innerHTML = jsonT(n, w);
            i = jQuery(j).find(".arrivalTime")[0];
            r();
            q = jQuery(jQuery(j).find(".closeButton")[0]);
            q.bind("click", e);
            f = {};
            var C = jQuery(j).find(".fight")[0];
            var I = jQuery(C).find(".inlineButton");
            f.trainTroops = jQuery(I[0]);
            var x = cm.BuildingFinder.getFirstInCurrentCity(cm.BUILDING_TYPES.BARRACK);
            if (!x) {
                f.trainTroops.addClass("disabled")
            }
            var G = seed.allianceDiplomacies && parseInt(seed.allianceDiplomacies.allianceId) > 0;
            f.askForHelp = jQuery(I[1]);
            if (!G) {
                f.askForHelp.addClass("disabled")
            }
            var E = jQuery(j).find(".defend")[0];
            var F = jQuery(E).find(".inlineButton");
            f.buildDefenses = jQuery(F[0]);
            f.troopSettings = jQuery(F[1]);
            f.items = {};
            var D, H;
            for (D = 0; D < d.items.length; D++) {
                H = n.items[D];
                var A = H.getId().toString();
                var s = jQuery(j).find("#buffItem" + A)[0];
                f.items[A] = {};
                f.items[A].applyItem = jQuery(jQuery(s).find(".applyButton")[0]);
                if (H.getQuantity() < 1) {
                    f.items[A].applyItem.addClass("disabled")
                }
                f.items[A].buyItem = jQuery(jQuery(s).find(".buyButton")[0])
            }
        };
    h()
};
cm.OOP.inherits(cm.WatchTowerReportDialog, cm.BaseDialog);
cm.WatchTowerReportDialogController = function (d, k) {
    var f;
    var b;
    var n;
    var i;
    var c = function (t) {
            b.removeEventListener(cm.DialogEvent.CLOSE, c);
            f.trainTroops.unbind("click", m);
            f.troopSettings.unbind("click", a);
            f.buildDefenses.unbind("click", h);
            f.askForHelp.unbind("click", p);
            var s, u;
            for (u in f.items) {
                s = f.items[u];
                var r = s.applyItem;
                var q = s.buyItem;
                q.unbind("click", e);
                r.unbind("click", g)
            }
        };
    var m = function (r) {
            var q = cm.BuildingFinder.getFirstInCurrentCity(cm.BUILDING_TYPES.BARRACK);
            if (q) {
                buildslot(document.getElementById("slot_" + q.slot), r)
            }
        };
    var a = function (q) {
            buildslot(document.getElementById("slot_0"), q)
        };
    var h = function (q) {
            buildslot(document.getElementById("slot_1"), q)
        };
    var p = function (t) {
            var s = t.srcElement || t.currentTarget;
            s = s.tagName.toLowerCase() != "a" ? s.parentNode : s;
            if (jQuery(s).hasClass("disabled")) {
                return
            }
            Chat.changeTab(2);
            var v, r, u;
            var q = n.getTile();
            if (q.isCity) {
                v = new cm.utils.CoordinateLink(q.city.x, q.city.y);
                r = g_js_strings.ImpendingAttacks.askAllianceForHelpCity;
                u = {
                    cityName: q.city.name
                }
            } else {
                v = new cm.utils.CoordinateLink(q.wilderness.x, q.wilderness.y);
                r = g_js_strings.ImpendingAttacks.askAllianceForHelpWilderness;
                u = {
                    wilderness: q.wilderness.typeName
                }
            }
            v.setClassName("coordinateLink");
            u.coordinate = v.getHTML();
            document.getElementById("mod_comm_input").value = cm.StringFormatter.applyTemplate(r, u);
            Chat.sendChat();
            Modal.showAlert(g_js_strings.modal_messages_send.msgsent)
        };
    var o = function (s) {
            var q = s.getTarget();
            var t = q.getId();
            var r = q.getQuantity();
            if (r > 0) {
                jQuery("#buffItem" + t).find(".inlineButton").removeClass("disabled")
            }
            jQuery("#buffItem" + t).find(".amountRow").html(r);
            jQuery("#kochead_gems").html(seed.player.gems);
            mpmetrics.track("store_purchase", {
                item: q.name,
                cost: q.price,
                usr_gen: seed.player.g,
                usr_byr: seed.player.y,
                usr_ttl: titlenames[seed.player.title],
                distinct_id: tvuid
            })
        };
    var e = function (t) {
            var s = t.srcElement || t.currentTarget;
            var u = s.getAttribute("name");
            try {
                var r = i.itemLookup[u];
                if (r.getPrice() > seed.player.gems) {
                    modal_shop_buy_notenough()
                } else {
                    s.style.visibility = "hidden";
                    r.addEventListener(cm.ItemEvent.BOUGHT, o);
                    r.buyItem()
                }
            } catch (q) {} finally {
                s.style.visibility = "visible"
            }
        };
    var l = function (s) {
            var q = s.getTarget();
            var t = q.getId();
            var r = q.getQuantity();
            if (r == 0) {
                jQuery("#buffItem" + t).find(".inlineButton").addClass("disabled")
            }
            jQuery("#buffItem" + t).find(".amountRow").html(r);
            q.removeEventListener(cm.ItemEvent.APPLIED, l)
        };
    var g = function (t) {
            var s = t.srcElement || t.currentTarget;
            s = s.tagName.toLowerCase() != "a" ? s.parentNode : s;
            if (jQuery(s).hasClass("disabled")) {
                return
            }
            var u = s.getAttribute("name");
            s.style.visibility = "hidden";
            try {
                var r = i.itemLookup[u];
                r.addEventListener(cm.ItemEvent.APPLIED, l);
                r.applyItem()
            } catch (q) {} finally {
                s.style.visibility = "visible"
            }
        };
    var j = function () {
            i = d;
            n = i.attack;
            b = k;
            b.addEventListener(cm.DialogEvent.CLOSE, c);
            f = k.getButtons();
            f.trainTroops.bind("click", m);
            f.troopSettings.bind("click", a);
            f.buildDefenses.bind("click", h);
            f.askForHelp.bind("click", p);
            var s, t;
            for (t in f.items) {
                s = f.items[t];
                var r = s.applyItem;
                var q = s.buyItem;
                q.bind("click", e);
                r.bind("click", g)
            }
        };
    j()
};

function addReply(j, h) {
    var a = $("newpost");
    var f = $("topictitle").innerHTML;
    var g = $("replytopictitle");
    if (h) {
        var k = $("post_" + h);
        var d = $("replytopostid");
        d.value = h;
        var m = k.select(".postnum")[0].innerHTML;
        var c = k.select(".postername")[0].innerHTML;
        var b = m + " by " + c + " in " + f;
        g.innerHTML = b;
        var l = $("allposts").select(".post");
        for (var e = 0; e < l.length; e++) {
            if (l[e].id != ("post_" + h)) {
                l[e].hide()
            }
        }
    } else {
        g.innerHTML = f;
        $("allposts").hide()
    }
    a.show();
    $("topichead").hide()
}

function addReplyCancel() {
    var b = $("allposts").select(".post");
    for (var a = 0; a < b.length; a++) {
        b[a].show()
    }
    $("allposts").show();
    $("newpost").hide();
    $("topichead").show()
}

function addReplySubmit() {
    $("newpostform").submit()
}

function addReplyQuote(k, g) {
    var a = document.getElementById("newpost");
    var e = document.getElementById("topictitle").innerHTML;
    var f = document.getElementById("replytopictitle");
    if (g) {
        var l = $("post_" + g);
        var d = document.getElementById("replytopostid");
        d.value = g;
        var m = l.select(".postnum")[0].innerHTML;
        var c = l.select(".postername")[0].innerHTML;
        var j = l.select(".postbody")[0].innerHTML;
        var h = a.getElementsByTagName("textarea")[0];
        h.value = "<blockquote><p>" + c + " " + m + "</p>" + j + "</blockquote>";
        var b = m + " by " + c + " in " + e;
        f.innerHTML = b
    } else {
        f.innerHTML = e
    }
    a.style.display = "block"
}

function editPost(g) {
    var b = document.getElementById("editpost");
    var a = document.getElementById("editpostid");
    var e = document.getElementById("topictitle").innerHTML;
    a.value = g;
    var h = $("post_" + g);
    var k = h.select(".postnum")[0].innerHTML;
    var d = h.select(".postername")[0].innerHTML;
    var j = h.select(".postbody")[0].innerHTML;
    var c = k + " by " + d + " in " + e;
    edittopictitle.innerHTML = c;
    var f = b.getElementsByTagName("textarea")[0];
    f.value = j;
    b.style.display = "block"
}

function thumbs(assetid, thumbs, topicid) {
    var params = Object.clone(g_ajaxparams);
    params.action = "thumbs";
    params.assetid = assetid;
    params.thumbs = thumbs;
    new Ajax.Request("ajax/discussionAjaxLogin.php", {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var result = eval("(" + transport.responseText + ")");
            if (result.ok) {} else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {
            Modal.showAlert("no good")
        }
    })
}

function seeEdits(assetid) {
    var params = Object.clone(g_ajaxparams);
    params.action = "seeedits";
    params.assetid = assetid;
    new Ajax.Request("ajax/discussionAjaxPublic.php", {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var result = eval("(" + transport.responseText + ")");
            if (result.ok) {
                Modal.showAlert(result.data)
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {
            Modal.showAlert("no good")
        }
    })
}

function showPost(assetid) {
    var params = Object.clone(g_ajaxparams);
    params.action = "showpost";
    params.assetid = assetid;
    new Ajax.Request("ajax/discussionAjaxPublic.php", {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var result = eval("(" + transport.responseText + ")");
            if (result.ok) {
                Modal.showAlert(result.data)
            }
        },
        onFailure: function () {
            Modal.showAlert("no good")
        }
    })
}

function showBuried(assetid) {
    var params = Object.clone(g_ajaxparams);
    params.action = "showburied";
    params.assetid = assetid;
    new Ajax.Request("ajax/discussionAjaxPublic.php", {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var result = eval("(" + transport.responseText + ")");
            if (result.ok) {
                $("post_" + assetid).select(".postcontrols")[0].show();
                $("post_" + assetid).select(".postbody")[0].innerHTML = result.data
            }
        },
        onFailure: function () {
            Modal.showAlert("no good")
        }
    })
}

function showFolderMove(b) {
    var a = document.getElementById("foldermove");
    a.style.display = "block"
}

function modAction(assetid, action, set, toggle) {
    var params = Object.clone(g_ajaxparams);
    params.action = action;
    params.assetid = assetid;
    params.set = set;
    new Ajax.Request("ajax/discussionAjaxLogin.php", {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var result = eval("(" + transport.responseText + ")");
            if (result.ok) {
                var span1 = document.getElementById(assetid + "_" + action).style.display = "none";
                var span2 = document.getElementById(assetid + "_" + toggle).style.display = "inline"
            }
        },
        onFailure: function () {}
    })
}

function pollVote(assetid, tgt) {
    var params = Object.clone(g_ajaxparams);
    params.action = "pollvote";
    params.assetid = assetid;
    var choices = document.getElementsByName("pollchoice");
    var numchoices = choices.length;
    for (i = 0; i < numchoices; i++) {
        if (choices[i].checked) {
            choice = choices[i].value
        }
    }
    params.pollchoice = choice;
    new Ajax.Request("ajax/discussionAjaxLogin.php", {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var result = eval("(" + transport.responseText + ")");
            if (result.ok) {}
        },
        onFailure: function () {}
    })
}

function showPhoto(f, a) {
    var c = document.getElementById("window");
    c.style.display = "block";
    var b = c.getElementsByTagName("div");
    for (i = 0; i < b.length; i++) {
        if (i > 0) {
            c.removeChild(b[i])
        }
    }
    var e = document.createElement("img");
    e.setAttribute("src", a);
    var d = document.createElement("div");
    d.appendChild(e);
    c.appendChild(d)
}

function hideAttachments(c) {
    c.parentNode.style.display = "none";
    var a = c.parentNode.parentNode.getElementsByTagName("a");
    var b = a.length - 1;
    a[b].style.display = "inline"
}

function showAttachments(a) {
    a.parentNode.getElementsByTagName("div")[0].style.display = "block";
    a.style.display = "none"
};

function addTopic(a) {
    $("disc_modu_body").hide();
    $("newtopic").show()
}

function addTopicCancel() {
    $("newtopic").hide();
    $("disc_modu_body").show()
}

function addTopicSubmit() {
    $("newtopicform").submit()
}

function addPoll(a) {
    $("newpoll").show();
    $("disc_modu_body").hide()
}

function addPollCancel(a) {
    $("newpoll").hide();
    $("disc_modu_body").show()
}

function addPollSubmit() {
    $("newpollform").submit()
}

function addMorePollOptions(d) {
    var a = document.getElementById("newpoll");
    var h = a.getElementsByTagName("tr");
    var i = h.length;
    var e = i - 4;
    if (e > pollchoicemax) {
        d.parentNode.style.display = "none";
        return false
    }
    var g = h[i - 2];
    var f = document.createElement("tr");
    var c = document.createElement("td");
    var b = document.createElement("td");
    c.innerHTML = "Poll Option " + e + ":";
    b.innerHTML = "<input class='tx' type='text' name='option_" + e + "'/>";
    f.appendChild(c);
    f.appendChild(b);
    if (e == 10) {
        d.parentNode.parentNode.style.display = "none"
    }
    document.getElementById("newpolltable").insertBefore(f, g)
}

function addFolder(folderid) {
    var params = Object.clone(g_ajaxparams);
    params.action = "addchild";
    params.assetid = folderid;
    var name = "New Folder";
    var description = "Description of Folder";
    new Ajax.Request("ajax/discussionAjaxLogin.php", {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var result = eval("(" + transport.responseText + ")");
            if (result.ok) {
                if (result.data) {
                    Modal.showAlert(result.data);
                    renameFolder(result.data, name, description)
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function renameFolder(folderid, name, description) {
    var params = Object.clone(g_ajaxparams);
    params.action = "renamefolder";
    params.assetid = folderid;
    var name = prompt("Name:", name);
    var description = prompt("Description:", description);
    params.name = name;
    params.description = description;
    new Ajax.Request("ajax/discussionAjaxLogin.php", {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var result = eval("(" + transport.responseText + ")");
            if (result.ok) {
                document.location.reload()
            }
        },
        onFailure: function () {}
    })
}

function modAction(assetid, action, set, toggle) {
    var params = Object.clone(g_ajaxparams);
    params.action = action;
    params.assetid = assetid;
    params.set = set;
    new Ajax.Request("ajax/discussionAjaxLogin.php", {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var result = eval("(" + transport.responseText + ")");
            if (result.ok) {
                var span1 = document.getElementById(assetid + "_" + action).style.display = "none";
                var span2 = document.getElementById(assetid + "_" + toggle).style.display = "inline"
            }
        },
        onFailure: function () {}
    })
};
var divMessageHeaders = document.getElementById("messageHeaders");
var divMessageBody = document.getElementById("messageBody");
var divEmailStatus = document.getElementById("emailStatus");
var objAjax;
var activateAutoRefresh = false;
var checkNewMailInterval = 120 * 1000000;
var msgCheckTimer;
var msgCheckTimerFlag = true;
turnOnMessageChecking();

function turnOnMessageChecking() {
    msgCheckTimer = setInterval("refreshBoxes()", checkNewMailInterval);
    msgCheckTimerFlag = true
}

function turnOffMessageChecking() {
    clearInterval(msgCheckTimer);
    msgCheckTimerFlag = false
}

function refreshBoxes() {
    if (activateAutoRefresh) {
        checkNewEmails()
    }
}

function getEmailContent(messageId) {
    var params = Object.clone(g_ajaxparams);
    params.messageId = messageId;
    params.requestType = "GET_MESSAGE_FOR_ID";
    document.getElementById("emailStatus").innerHTML = "Loading...";
    new Ajax.Request(g_ajaxpath + "ajax/getEmail.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            document.getElementById("emailStatus").innerHTML = "";
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                document.getElementById("messageBody").innerHTML = rslt.messageBody;
                document.getElementById("messageId_" + messageId).className = "messageRead"
            }
        },
        onFailure: function () {}
    })
}

function getEmailHeaders(boxType) {
    var params = Object.clone(g_ajaxparams);
    params.requestType = "GET_MESSAGE_HEADERS_FOR_USER_INBOX";
    params.boxType = boxType;
    params.pageNo = document.getElementById("hdnPageNo").value;
    document.getElementById("hdnBoxType").value = boxType;
    document.getElementById("emailStatus").innerHTML = "Loading...";
    document.getElementById("messageBody").innerHTML = "";
    objAjax = new Ajax.Request(g_ajaxpath + "ajax/getEmail.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                document.getElementById("emailStatus").innerHTML = "";
                document.getElementById("messageHeaders").innerHTML = rslt.message;
                if (rslt.mostRecentMessageId) {
                    document.getElementById("hdnMostRecentMessageId").value = rslt.mostRecentMessageId
                }
                setPagination(rslt.pageNo, rslt.nextButton);
                activateAutoRefresh = true;
                if (!msgCheckTimerFlag) {
                    turnOnMessageChecking()
                }
            }
        },
        onFailure: function () {}
    })
}

function composeEmail() {
    turnOffMessageChecking();
    var a;
    a = "To: <input type='text' id='emailTo' length='50' /> <br/> ";
    a += "Subject: <input type='text' id='emailSubject' length='50'/><br/>";
    document.getElementById("messageHeaders").innerHTML = a;
    a = "<textarea id=\"txtComposeBody\" rows='3' cols='40'></textarea>";
    a += "<input type='button' value='Send' onclick='sendComposedMessage();'";
    document.getElementById("messageBody").innerHTML = a
}

function sendComposedMessage() {
    var params = Object.clone(g_ajaxparams);
    params.emailTo = document.getElementById("emailTo").value;
    params.subject = document.getElementById("emailSubject").value;
    params.message = document.getElementById("txtComposeBody").value;
    params.requestType = "COMPOSED_MAIL";
    new Ajax.Request(g_ajaxpath + "ajax/getEmail.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")")
        },
        onFailure: function () {
            Modal.showAlert(g_js_strings.modal_messages_send.oopscompose)
        }
    })
}

function checkNewEmails() {
    var params = Object.clone(g_ajaxparams);
    params.requestType = "CHECK_NEW_MESSAGES";
    params.recentMessageReceived = document.getElementById("hdnMostRecentMessageId").value;
    params.boxType = document.getElementById("hdnBoxType").value;
    document.getElementById("emailStatus").innerHTML = "Checking for new mails...";
    objAjax = new Ajax.Request(g_ajaxpath + "ajax/getEmail.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                if (rslt.newMailsArrived) {
                    getEmailHeaders(document.getElementById("hdnBoxType").value)
                }
            }
        },
        onFailure: function () {}
    })
}

function takeActionOnMessages() {
    var messageIdsSelected = messageIdsFromSelectedCheckBox();
    if (messageIdsSelected.length == 0) {
        return false
    }
    var actionChosen = document.getElementById("selAction").value;
    var params = Object.clone(g_ajaxparams);
    params.requestType = "ACTION_ON_MESSAGES";
    params.selectedAction = actionChosen;
    params.boxType = document.getElementById("hdnBoxType").value;
    params.selectedMessageIds = (messageIdsSelected).toString();
    objAjax = new Ajax.Request(g_ajaxpath + "ajax/getEmail.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                if (actionChosen == "markRead") {
                    changeStylesForActions(messageIdsSelected, "messageRead")
                } else {
                    if (actionChosen == "markUnread") {
                        changeStylesForActions(messageIdsSelected, "messageUnread")
                    } else {
                        if (actionChosen == "delete") {
                            changeStylesForActions(messageIdsSelected, "messageDeleted")
                        }
                    }
                }
                restoreDefaultSettings(messageIdsSelected)
            }
        },
        onFailure: function () {}
    })
}

function setPagination(a, b) {
    document.getElementById("hdnPageNo").value = a;
    document.getElementById("pagination").style.display = "block";
    if (a == 1) {
        document.getElementById("prevPage").style.display = "none"
    } else {
        document.getElementById("prevPage").style.display = "block"
    }
    if (b) {
        document.getElementById("nextPage").style.display = "block"
    } else {
        document.getElementById("nextPage").style.display = "none"
    }
}

function getNextPage() {
    document.getElementById("hdnPageNo").value = parseInt(document.getElementById("hdnPageNo").value) + 1;
    getEmailHeaders(document.getElementById("hdnBoxType").value)
}

function getPrevPage() {
    document.getElementById("hdnPageNo").value = parseInt(document.getElementById("hdnPageNo").value) - 1;
    getEmailHeaders(document.getElementById("hdnBoxType").value)
}

function messageIdsFromSelectedCheckBox() {
    var c = document.getElementsByTagName("input");
    var b = new Array();
    for (var a = 0; a < c.length; a++) {
        if (c[a].type == "checkbox" && ((c[a].id).substring(0, 14) == "chk_messageId_") && (c[a].checked)) {
            b.push((c[a].id).substring(14))
        }
    }
    return b
}

function changeStylesForActions(b, a) {
    for (i = 0; i < b.length; i++) {
        document.getElementById("messageId_" + b[i]).className = a
    }
}

function restoreDefaultSettings(c) {
    for (var a = 0; a < c.length; a++) {
        var b = "chk_messageId_" + c[a];
        if (document.getElementById(b).checked) {
            document.getElementById(b).checked = false
        }
    }
    document.getElementById("selAction").options[0].selected = true
};

function openEmbassy() {
    var c = new Array();
    c.push("<div class='tabsbar clearfix'>");
    c.push("<a class='tab selected' ><span>");
    c.push(g_js_strings.commonstr.alliance);
    c.push("</span></a>");
    c.push("</div>");
    c.push("<div class='embassyallibutton clearfix'>");
    c.push("<a class='button25' onclick='Modal.hideModalAll();modal_alliance();return false;'><span>" + g_js_strings.openEmbassy.viewall + "</span></a>");
    c.push("</div>");
    c.push("<div class='embassyalliancewrap'>");
    c.push("<div class='encampedttl'>" + g_js_strings.openEmbassy.encampall + "</div>");
    c.push("<div class='embassyencampedwrap'>");
    var a = false;
    var h = new Array();
    h.push("<table cellpadding='0' cellspacing='0'><thead><tr><td class='from'>" + g_js_strings.openEmbassy.sentfrom + "</td><td class='upkeep'>" + g_js_strings.commonstr.upkeep + "</td><td class='action'>" + g_js_strings.commonstr.actions + "</td></tr></thead><tbody>");
    var f = Object.keys(seed.queue_atkinc);
    for (var d = 0; d < f.length; d++) {
        var e = seed.queue_atkinc[f[d]];
        if (parseInt(e.toCityId) == currentcityid && parseInt(e.marchStatus) == 2 && parseInt(e.fromCityId) != parseInt(currentcityid)) {
            a = true;
            h.push("<tr><td class='from'>(");
            h.push(e.fromXCoord + "," + e.fromYCoord + ")");
            if (seed.players) {
                if (seed.players["u" + e.fromPlayerId]) {
                    h.push(" - " + seed.players["u" + e.fromPlayerId].n)
                }
            }
            h.push("</td><td class='upkeep'>");
            var g = 0;
            for (var b in cm.UNIT_TYPES) {
                b = cm.UNIT_TYPES[b];
                g += parseInt(e["unit" + b + "Return"]) * parseInt(unitupkeeps[b])
            }
            h.push(addCommas(g));
            h.push(" " + resourceinfo.rec1.toLowerCase() + "</td><td class='action'>");
            h.push("<a onclick='kickout_allies(" + e.marchId + "," + currentcityid + "," + e.fromPlayerId + "," + e.fromCityId + "," + g + ");return false;' class='button20'><span>" + g_js_strings.openEmbassy.senthome + "</span></a>");
            h.push("&nbsp;");
            h.push("</td></tr>")
        }
    }
    h.push("</tbody></table>");
    if (a) {
        c.push(h.join(""))
    } else {
        c.push("<div>" + g_js_strings.openEmbassy.noallcamp + "</div>")
    }
    c.push("</div>");
    c.push("</div>");
    $("modal_build_content").innerHTML = c.join("")
}

function kickout_allies(mid, cid, fromUid, fromCid, upkeep) {
    var params = Object.clone(g_ajaxparams);
    params.mid = mid;
    params.cid = cid;
    params.fromUid = fromUid;
    params.fromCid = fromCid;
    new Ajax.Request(g_ajaxpath + "ajax/kickoutReinforcements.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                Modal.showAlert(g_js_strings.kickout_allies.troopshome);
                seed.resources["city" + currentcityid].rec1[3] = parseInt(seed.resources["city" + currentcityid].rec1[3]) - upkeep;
                Modal.hideModalAll();
                if (parseInt(fromUid) == parseInt(tvuid)) {
                    var curmarch = seed.queue_atkp["city" + fromCid]["m" + mid];
                    var marchtime = Math.abs(parseInt(curmarch.destinationUnixTime) - parseInt(curmarch.eventUnixTime));
                    curmarch.returnUnixTime = unixtime() + marchtime;
                    curmarch.marchStatus = 8
                }
                delete seed.queue_atkinc["m" + mid]
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
};
var cm = cm || {};
var cm = function (b) {
        var d = b.error = b.error || {};
        var a = 0;
        var e = 5;

        function c() {
            if (a++ < e) {
                AjaxCall.gPostRequest("ajax/postError.php", {
                    window: this.window
                }, function () {}, function () {})
            }
        }
        return b
    }(cm);
cm.log = function () {
    return {
        err: function (a) {
            if (a.ok == false && a.msg) {
                Modal.showAlert(a.msg, "Ok")
            }
        },
        dir: function (a) {
            if (window.console && typeof console.dir == "function" && a && g_env == "dev") {
                console.dir(a)
            }
        },
        l: function (a) {
            if (window.console && typeof console.log == "function" && g_env == "dev") {
                console.log(a)
            }
            return a
        },
        convertToHMS: function (g, e) {
            e = e == undefined ? true : false;
            var c = e ? " " : "";
            if (g <= 0) {
                return "now"
            }
            var a = parseInt(g / 3600);
            var b = parseInt((g - (a * 3600)) / 60);
            var f = parseInt((g - (a * 3600) - (b * 60)));
            return (a > 0 ? a + c + "h " : "") + (b > 0 ? b + c + "m " : "") + f + c + "s"
        }
    }
}();
cm.test = function () {
    return {
        all: function () {
            for (var a in cm) {
                if (cm.hasOwnProperty(a) && cm[a].test) {
                    cm[a].test()
                }
            }
        },
        go: function (b, c, f) {
            var e = c == f;
            var d = 50 - b.length;
            for (var a = 0; a < d; a++) {
                b += " "
            }
            if (!e) {
                cm.log.l("got " + c + " but expected " + f)
            }
        }
    }
}();
var cm = cm || {};
var cm = function (b) {
        var d = b.feedTracking = b.feedTracking || {};
        var c = {};
        var a = "";
        d.setTrue = function () {
            c[a] = true
        };
        d.setFalse = function (e) {
            a = e;
            c[e] = false
        };
        d.get = function (e) {
            return c[e]
        };
        d.button = function (e, f) {
            if (c[e] !== false) {
                return f
            } else {
                return "<a class='buttonDown25' onclick='Modal.hideModal(); return false;'><span>" + g_js_strings.commonstr.ok + "</span></a>"
            }
        };
        return b
    }(cm);
var cm = cm || {};
var cm = function (b) {
        var c = b.flash = b.flash || {};
        var a = 2;
        c.setFTFlag = function (d) {
            a = d
        };
        c.getFTFlag = function (d) {
            return a
        };
        c.log = function (d) {
            cm.log.l("Flash App says: " + d)
        };
        c.close = function () {
            Modal.hideModal()
        };
        c.getWindow = function () {
            return window
        };
        c.getVars = function () {
            return {
                g_ajaxparams: g_ajaxparams,
                g_js_strings: g_js_strings,
                servicePath: g_servcallback_url + "amfphp/gateway.php",
                g_ajaxpath_base: g_servcallback_url
            }
        };
        c.getBaseDir = function () {
            return stimgUrl + "flash/"
        };
        c.incrementItem = function (d) {
            cm.mww.incrementItem(d)
        };
        c.postToProfile = function (d, e) {
            pid = "10001";
            if (!d) {
                d = "item"
            }
            if (!e) {
                e = 202
            }
            c.hideFlash();
            cm.mww.mmb_share(d, e, cm.flash.showFlash)
        };
        c.modal_getgems = function () {
            modal_getgems()
        };
        c.gameWon = function (e, d) {
            cm.flash.incrementItem(d);
            e = parseInt(e);
            gems = parseInt(seed.player.gems);
            if (isNaN(e) || isNaN(gems)) {
                return
            }
            if (1062 == parseInt(d)) {
                e -= 100
            }
            gems -= e;
            if (gems < 0) {
                gems = 0
            }
            seed.player.gems = gems;
            jQuery("#kochead_gems").html(gems)
        };
        c.hideFlash = function () {
            if ($$(".modal_mww")[0]) {
                $$(".modal_mww")[0].style.top = "2000px"
            }
        };
        c.showFlash = function () {
            var d = window.jQuery ? jQuery(".kocNavButtonContainer").offset().top - 13 : 225;
            if ($$(".modal_mww")[0] && !$$("#modal_getgemsdiv")[0]) {
                $$(".modal_mww")[0].style.top = d + "px"
            }
        };
        return b
    }(cm);
var cm = function (o) {
        var n = o.flash_init = o.flash_init || {};
        var h = (navigator.appVersion.indexOf("MSIE") != -1) ? true : false;
        var i = (navigator.appVersion.toLowerCase().indexOf("win") != -1) ? true : false;
        var f = (navigator.userAgent.indexOf("Opera") != -1) ? true : false;

        function g() {
            var p;
            var q;
            var r;
            try {
                q = new ActiveXObject("ShockwaveFlash.ShockwaveFlash.7");
                p = q.GetVariable("$version")
            } catch (r) {}
            if (!p) {
                try {
                    q = new ActiveXObject("ShockwaveFlash.ShockwaveFlash.6");
                    p = "WIN 6,0,21,0";
                    q.AllowScriptAccess = "always";
                    p = q.GetVariable("$version")
                } catch (r) {}
            }
            if (!p) {
                try {
                    q = new ActiveXObject("ShockwaveFlash.ShockwaveFlash.3");
                    p = q.GetVariable("$version")
                } catch (r) {}
            }
            if (!p) {
                try {
                    q = new ActiveXObject("ShockwaveFlash.ShockwaveFlash.3");
                    p = "WIN 3,0,18,0"
                } catch (r) {}
            }
            if (!p) {
                try {
                    q = new ActiveXObject("ShockwaveFlash.ShockwaveFlash");
                    p = "WIN 2,0,0,11"
                } catch (r) {
                    p = -1
                }
            }
            return p
        }

        function m() {
            var v = -1;
            if (navigator.plugins != null && navigator.plugins.length > 0) {
                if (navigator.plugins["Shockwave Flash 2.0"] || navigator.plugins["Shockwave Flash"]) {
                    var u = navigator.plugins["Shockwave Flash 2.0"] ? " 2.0" : "";
                    var p = navigator.plugins["Shockwave Flash" + u].description;
                    var t = p.split(" ");
                    var r = t[2].split(".");
                    var w = r[0];
                    var q = r[1];
                    var s = t[3];
                    if (s == "") {
                        s = t[4]
                    }
                    if (s[0] == "d") {
                        s = s.substring(1)
                    } else {
                        if (s[0] == "r") {
                            s = s.substring(1);
                            if (s.indexOf("d") > 0) {
                                s = s.substring(0, s.indexOf("d"))
                            }
                        }
                    }
                    var v = w + "." + q + "." + s
                }
            } else {
                if (navigator.userAgent.toLowerCase().indexOf("webtv/2.6") != -1) {
                    v = 4
                } else {
                    if (navigator.userAgent.toLowerCase().indexOf("webtv/2.5") != -1) {
                        v = 3
                    } else {
                        if (navigator.userAgent.toLowerCase().indexOf("webtv") != -1) {
                            v = 2
                        } else {
                            if (h && i && !f) {
                                v = g()
                            }
                        }
                    }
                }
            }
            return v
        }

        function c(u, s, r) {
            versionStr = m();
            if (versionStr == -1) {
                return false
            } else {
                if (versionStr != 0) {
                    if (h && i && !f) {
                        tempArray = versionStr.split(" ");
                        tempString = tempArray[1];
                        versionArray = tempString.split(",")
                    } else {
                        versionArray = versionStr.split(".")
                    }
                    var t = versionArray[0];
                    var p = versionArray[1];
                    var q = versionArray[2];
                    if (t > parseFloat(u)) {
                        return true
                    } else {
                        if (t == parseFloat(u)) {
                            if (p > parseFloat(s)) {
                                return true
                            } else {
                                if (p == parseFloat(s)) {
                                    if (q >= parseFloat(r)) {
                                        return true
                                    }
                                }
                            }
                        }
                    }
                    return false
                }
            }
        }

        function d(q, p) {
            if (q.indexOf("?") != -1) {
                return q.replace(/\?/, p + "?")
            } else {
                return q + p
            }
        }

        function k(p) {
            if (p.indexOf("swf") > -1) {
                return cm.flash.getBaseDir() + p
            } else {
                return p
            }
        }

        function j(t, s, p) {
            var r = "";
            if (h && i && !f) {
                r += "<object ";
                for (var q in t) {
                    r += q + '="' + t[q] + '" '
                }
                r += ">";
                for (var q in s) {
                    r += '<param name="' + q + '" value="' + k(s[q]) + '" /> '
                }
                r += "</object>"
            } else {
                r += "<embed ";
                for (var q in p) {
                    r += q + '="' + p[q] + '" '
                }
                r += "> </embed>"
            }
            cm.log.l("printed: " + r);
            b(r);
            cm.flash.showFlash()
        }

        function b(p) {
            document.getElementById("modal_mmb").innerHTML = p
        }

        function e() {
            var p = a(arguments, ".swf", "movie", "clsid:d27cdb6e-ae6d-11cf-96b8-444553540000", "application/x-shockwave-flash");
            p.embedAttrs.src = cm.flash.getBaseDir() + p.embedAttrs.src;
            j(p.objAttrs, p.params, p.embedAttrs)
        }

        function l() {
            var p = a(arguments, ".dcr", "src", "clsid:166B1BCA-3F9C-11CF-8075-444553540000", null);
            p.embedAttrs.src = cm.flash.getBaseDir() + p.embedAttrs.src;
            j(p.objAttrs, p.params, p.embedAttrs)
        }

        function a(q, t, v, s, w) {
            var p = new Object();
            p.embedAttrs = new Object();
            p.params = new Object();
            p.objAttrs = new Object();
            for (var r = 0; r < q.length; r = r + 2) {
                var u = q[r].toLowerCase();
                switch (u) {
                case "classid":
                    break;
                case "pluginspage":
                    p.embedAttrs[q[r]] = q[r + 1];
                    break;
                case "src":
                case "movie":
                    q[r + 1] = d(q[r + 1], t);
                    p.embedAttrs.src = q[r + 1];
                    p.params[v] = q[r + 1];
                    break;
                case "onafterupdate":
                case "onbeforeupdate":
                case "onblur":
                case "oncellchange":
                case "onclick":
                case "ondblclick":
                case "ondrag":
                case "ondragend":
                case "ondragenter":
                case "ondragleave":
                case "ondragover":
                case "ondrop":
                case "onfinish":
                case "onfocus":
                case "onhelp":
                case "onmousedown":
                case "onmouseup":
                case "onmouseover":
                case "onmousemove":
                case "onmouseout":
                case "onkeypress":
                case "onkeydown":
                case "onkeyup":
                case "onload":
                case "onlosecapture":
                case "onpropertychange":
                case "onreadystatechange":
                case "onrowsdelete":
                case "onrowenter":
                case "onrowexit":
                case "onrowsinserted":
                case "onstart":
                case "onscroll":
                case "onbeforeeditfocus":
                case "onactivate":
                case "onbeforedeactivate":
                case "ondeactivate":
                case "type":
                case "codebase":
                case "id":
                    p.objAttrs[q[r]] = q[r + 1];
                    break;
                case "width":
                case "height":
                case "align":
                case "vspace":
                case "hspace":
                case "class":
                case "title":
                case "accesskey":
                case "name":
                case "tabindex":
                    p.embedAttrs[q[r]] = p.objAttrs[q[r]] = q[r + 1];
                    break;
                default:
                    p.embedAttrs[q[r]] = p.params[q[r]] = q[r + 1]
                }
            }
            p.objAttrs.classid = s;
            if (w) {
                p.embedAttrs.type = w
            }
            return p
        }
        n.DetectFlashVer = c;
        n.exe = function () {
            var q = c(1, 1, 1);
            cm.log.l("flash installed=" + q);
            if (q == false) {
                var s = '<div class="flashError">			    <div class="headerSection">			        <a class="closeButton" onclick="Modal.hideModal();return false;">&nbsp;</a>			    </div>			    <div class="bodySection">			        <div class="errorText">Merlin&#39;s Wondrous Wheel needs Flash to run!</div>			        <a class="fakeButton" href="https://www.adobe.com/go/getflashplayer" target="_blank">&nbsp;</a>			    </div>			    </div>			    ';
                b(s)
            } else {
                var p = [];
                for (var r in g_ajaxparams) {
                    p.push(r + "=" + g_ajaxparams[r])
                }
                p.push("callPath=" + g_servcallback_url + "amfphp/gateway.php");
                p.push("absPath=" + cm.flash.getBaseDir());
                e("codebase", "https://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=10,0,0,0", "width", "743", "height", "563", "src", cm.flash.getBaseDir() + "mww", "quality", "high", "pluginspage", "https://www.adobe.com/go/getflashplayer", "align", "middle", "play", "true", "loop", "true", "scale", "showall", "wmode", "transparent", "devicefont", "false", "id", "WheelMiniGame", "bgcolor", "#000000", "name", "WheelMiniGame", "menu", "true", "allowFullScreen", "false", "allowScriptAccess", "always", "movie", "mww", "flashvars", p.join("&"), "salign", "")
            }
        };
        return o
    }(cm);

function CM_Modal_hideModalAll() {
    Modal.hideModalAll()
}

function CM_MWW_gameLoaded() {
    var a = document.getElementsByName("WheelMiniGame");
    if (a.length) {
        a[0].start()
    }
}

function CM_MMW_getSettings() {
    var a = document.getElementsByName("WheelMiniGame");
    if (a.length) {
        a = a[0]
    } else {
        cm.log.l("MMW is not found.");
        return
    }
    a.modal_setSkins({
        Wheelshadow: "_plh_wheelShadow",
        Winscreen: "_plh_winScreen",
        Wheel: "_plh_wheel",
        Playbtn_state1: "_plh_playBtn",
        Title_field: "tf_title",
        Btn_field1: "tf_playBtn_state1",
        Btn_field2: "tf_playBtn_state2",
        Btn_field3: "tf_playBtn_state3",
        VectorMask: "_plh_mask",
        Closebutton: "closeBtn",
        PointerPlaceholder: "_plh_pointer",
        Win_txt: "tf_ItemWin",
        WinItemLabel: "tf_itemName",
        WinDescription: "tf_itemDescription",
        Win_item: "_plh_icon",
        GemLabel: "tf_gemCount",
        edge_offset: 17,
        spoke_total: 12,
        clockwise: 0
    });
    a.modal_setLocalization({
        winTitleTxt_localized: g_js_strings.modal_mmb.youwon,
        spinTxt_localized: g_js_strings.modal_mmb.spin,
        gemsTxt_localized: g_js_strings.commonstr.gems,
        buyGems_localized: g_js_strings.modal_mmb.buymoregems
    });
    a.modal_setIcons({
        "1018": "Class_1018",
        "1048": "Class_1048",
        "1062": "Class_1062",
        "1300": "Class_1300",
        "1321": "Class_1321",
        "1410": "Class_1410",
        "142": "Class_142",
        "211": "Class_211",
        "261": "Class_261",
        "271": "Class_271",
        "55": "Class_55",
        "931": "Class_931"
    })
};
cm.formatModel = function (b) {
    function a(g) {
        var k = g;
        var h = /[ |>\(][0-9]{1,3},[0-9]{1,3}[ |<\)]/;
        var d = (h.exec(k) + "").replace("|", "").replace("|", "").replace(">", "").replace("<", "").replace("(", "").replace(")", "");
        var j = d.indexOf(",");
        var e = d.substr(0, j);
        var f = d.substr(j);
        var i = f.substr(1, f.length - 1);
        return k.replace(d, "<a href='javascript: cm.formatModel.jumpTo( " + e + ", " + i + " );'>" + d.replace(",", ",<span></span>") + "</a>")
    }

    function c(d) {
        return d.replace(/\b(((http[s]?:\/\/)?www.kabam.com)|(kabam(.com)?))\b/ig, "<a href='http://www.kabam.com' target='_blank'>$1</a>")
    }
    return {
        exe: function (d, f) {
            var e = 0;
            var g = "";
            d = "|" + d + "|";
            do {
                g = d;
                d = a(d)
            } while (d != g && e++ < 1000);
            d = d.replace("|", "").replace("|", "");
            if (f) {
                return c(d)
            }
            return d
        },
        jumpTo: function (e, d) {
            Modal.hideModal();
            changeview_map(b("#mod_views_map").get(0));
            reCenterMapWithCoor(e, d)
        }
    }
}(jQuery);
cm.GemGiftingModel = function (g) {
    var d = this;
    var b;
    var a;
    var c;
    var e;
    var f;
    this.getKey = function () {
        return b
    };
    this.getAmount = function () {
        return a
    };
    this.getGifter = function () {
        return c
    };
    this.getChestName = function () {
        return e
    };
    this.setRead = function () {
        if (!f) {
            var i = [b];
            var h = new cm.GemGiftingNotificationService();
            h.acknowledgeRead(i)
        }
        f = true
    };
    this.isRead = function () {
        return f
    };
    (function () {
        b = g.trnxId;
        a = g.giftAmount;
        c = {
            name: g.gifterName,
            alliance: g.gifterAlliance,
            world: g.gifterWorld
        };
        e = g.chestName;
        f = false
    })()
};
var cm = cm || {};
cm.GemGiftingNotificationController = function (a, j) {
    var d;
    var i;
    var f;
    var g;
    var h;
    var b = function (l) {
            if (d.hasPrevious()) {
                var k = d.previous();
                k.setRead()
            }
        };
    var c = function (l) {
            if (d.hasNext()) {
                var k = d.next();
                k.setRead()
            }
        };
    var e = function (m) {
            var l = _collection.getElementAtCurrentPosition();
            var k = l.getGifter();
            getInfoForAnUser(k.userId.toString())
        };
    onViewClose_ = function () {
        i.removeEventListener(cm.DialogEvent.CLOSE, onViewClose_);
        jQuery(f).unbind("click", b);
        jQuery(g).unbind("click", c);
        jQuery(h).unbind("click", e);
        return;
        var l = a.getCount();
        var m, n;
        var o = [];
        for (m = 0; m < l; m++) {
            n = d.getElementAtPosition(m);
            if (n.isRead()) {
                o.push(n.getKey())
            }
        }
        if (o.length > 0) {
            var k = new cm.GemGiftingNotificationService();
            k.acknowledgeRead(o)
        }
    };
    (function () {
        d = a;
        i = j;
        f = i.getPrevLink();
        jQuery(f).bind("click", b);
        g = i.getNextLink();
        jQuery(g).bind("click", c);
        h = i.getGifterLink();
        jQuery(h).bind("click", e);
        i.addEventListener(cm.DialogEvent.CLOSE, onViewClose_);
        if (!d.getCount()) {
            return
        }
        d.jumpTo(0);
        var m = [d.getElementAtCurrentPosition().getKey()];
        var l = null;
        while (l = d.next()) {
            m.push(l.getKey())
        }
        var k = new cm.GemGiftingNotificationService();
        k.acknowledgeRead(m)
    })()
};
var cm = cm || {};
cm.GemGiftingNotificationView = function (a) {
    cm.BaseDialog.call(this);
    var n = this;
    var e = this.getHtmlElement();
    var f;
    var k;
    var g;
    var i;
    var j;
    var o;
    var c;
    var m;
    this.getGifterLink = function () {
        return k
    };
    this.getPrevLink = function () {
        return g
    };
    this.getNextLink = function () {
        return i
    };
    var b = function () {
            var s = f.getElementAtCurrentPosition();
            var p = s.getGifter();
            var r = {
                gemAmount: parseInt(s.getAmount()),
                gifter: p,
                numberOfGifter: 1
            };
            while (s = f.next()) {
                r.gemAmount += parseInt(s.getAmount());
                r.numberOfGifter++
            }
            var q = null;
            if (r.numberOfGifter > 1) {
                q = "You have received a total of <b>{gemAmount}</b> gems as gifts from <b>{numberOfGifter}</b> of your friends or alliance members!"
            } else {
                q = (p.alliance && p.world) ? g_js_strings.gemGifting.notificationMessageAlliance : g_js_strings.gemGifting.notificationMessage
            }
            c.innerHTML = cm.StringFormatter.applyTemplate(q, r);
            o.innerHTML = " " + (f.getCurrentPosition() + 1) + "/" + f.getCount() + " ";
            k = c.getElementsByTagName("a")[0];
            g.className = f.hasPrevious() ? "navLink" : "navLink disabled";
            i.className = f.hasNext() ? "navLink" : "navLink disabled"
        };
    var l = function (p) {
            m()
        };
    m = function () {
        Event.stopObserving(_closeButton, "click", l);
        n.close()
    };
    var h = function (p) {
            b()
        };
    var d = function () {};
    (function () {
        f = a;
        f.addEventListener(cm.CollectionEvent.POSITION_CHANGED, d);
        var w = f.getElementAtPosition(0);
        e.className = "announcementContainer gemGifting";
        var r = document.createElement("div");
        r.className = "notificationDialog gemGifting";
        e.appendChild(r);
        var s = document.createElement("div");
        s.className = "titleBar";
        r.appendChild(s);
        _closeButton = document.createElement("a");
        _closeButton.className = "closeButton";
        Event.observe(_closeButton, "click", l);
        s.appendChild(_closeButton);
        var p = document.createElement("div");
        p.className = "dialogTitle";
        p.innerHTML = g_js_strings.gemGifting.congratulations;
        s.appendChild(p);
        var u = document.createElement("div");
        u.className = "dialogBody";
        r.appendChild(u);
        var q = document.createElement("div");
        q.className = "topWrap";
        u.appendChild(q);
        var t = document.createElement("div");
        t.className = "midWrap";
        u.appendChild(t);
        var v = document.createElement("div");
        v.className = "count";
        u.appendChild(v);
        g = document.createElement("a");
        g.innerHTML = "&lt;";
        v.appendChild(g);
        o = document.createElement("span");
        v.appendChild(o);
        i = document.createElement("a");
        i.innerHTML = "&gt;";
        v.appendChild(i);
        c = document.createElement("span");
        u.appendChild(c);
        b()
    })()
};
cm.OOP.inherits(cm.GemGiftingNotificationView, cm.BaseDialog);
cm.GemGiftingNotificationView.prototype.getPriority = function () {
    return 2
};
cm.GloryLeaderboardView = function (d) {
    var e = "glory";
    var b = 0;

    function g() {
        var m = new Array();
        m.push("<div id='lTabs' class='tabsbar clearfix' >");
        if (cm.WorldSettings.isOn("GLORY_FE")) {
            m.push("<a id='gloryLeaderboardTab' class='tab selected' ><span>");
            m.push(g_js_strings.commonstr.glory_leaderboard);
            m.push("</span></a>")
        }
        m.push("<a id='mightLeaderboardTab' class='tab'><span>");
        m.push(g_js_strings.commonstr.might_leaderboard);
        m.push("</span></a>");
        m.push("</div>");
        return m.join("")
    }

    function j(m) {
        if (cm.WorldSettings.isOn("GLORY_FE")) {
            m.stopPropagation();
            e = "glory";
            modal_fow_leaderboard("X")
        }
    }

    function h(m) {
        d("#lTabs .tab").removeClass("selected");
        d(m).addClass("selected")
    }

    function l(m) {
        m.stopPropagation();
        e = "might";
        modal_fow_leaderboard(0)
    }

    function f() {
        d("#gloryLeaderboardTab").unbind("click").bind("click", j);
        d("#mightLeaderboardTab").unbind("click").bind("click", l);
        h("#" + e + "LeaderboardTab")
    }

    function i() {
        return cm.WorldSettings.isOn("GLORY_FE") ? e : "might"
    }

    function c(m) {
        b = m;
        cm.timer.register("gloryLeaderboard", a)
    }

    function a() {
        var m = b - unixtime()
    }

    function k(m) {
        return "<img src='img/" + (m ? "up" : "down") + "_arrow.png' />"
    }
    return {
        tabs: g,
        bind: f,
        leaderboardType: i,
        startTimer: c,
        arrow: k
    }
}(jQuery);
cm.GloryView = function (d) {
    var b = {
        glory: 1
    };
    var g = {};

    function f() {
        var i = [900, 1900, 3900, 7900, 15900, 31900, 59100, 65000];
        for (var h = 0; h < i.length; h++) {
            var j = cm.GloryView.get(i[h])
        }
    }
    d(document).ready(f);

    function a(h) {
        return g[h] || 5
    }

    function c(i) {
        for (var h = 0; h < i.length; h++) {
            g[i[h][4]] = i[h][7]
        }
    }

    function e(h) {
        return typeof parseInt(h) == "number" ? parseInt(h) : 0
    }
    return {
        SetNonMeGloryCache: function (h) {
            if (h.data.newChats) {
                c(h.data.newChats[1]);
                c(h.data.newChats[2]);
                c(h.data.newChats[3])
            }
        },
        render: function () {
            if (cm.WorldSettings.isOn("GLORY_FE") && b.displayGlory) {
                var h = "<div class='glory_view'><span class='gained'>Glory Gained: <span class='num'>" + (b.glory || 0) + "</span></span></div>";
                if (b.wonGloryItem && cm.WorldSettings.isOn("GLORY_WIN_ITEMS")) {
                    h += "<div class='gloryItems'>" + g_js_strings.commonstr.found + ksoItems[b.wonGloryItem].name + "</div>"
                }
                return h
            } else {
                return ""
            }
        },
        set: function (h) {
            if (h) {
                b = h
            }
        },
        get: function (j) {
            var n = j || b.glory;
            var h = 0;
            var m = [];
            for (var l in seed.gloryChatMapping) {
                m[h] = l;
                h++
            }
            var k = 0;
            while (n > parseInt(m[k]) && k < 8) {
                k++
            }
            return k
        },
        topNavGlory: function (h) {
            b.glory = h;
            d(".avatarGlory span").html(h);
            if (!cm.WorldSettings.isOn("GLORY_FE")) {
                d(".avatarGlory").html("")
            }
        },
        chatIcon: function (k, i) {
            if (i !== false) {
                k = a(i)
            }
            if (parseInt(i) == parseInt(tvuid)) {
                var h = e(seed.player.maxGlory) > e(b.glory) ? e(seed.player.maxGlory) : e(b.glory);
                k = cm.GloryView.get(h)
            }
            var j = "background: url(img/chat_" + (k || 1) + ".png);";
            return cm.WorldSettings.isOn("GLORY_FE") ? "<div class='chatIcon' style='" + j + "' ></div>" : ""
        }
    }
}(jQuery);
var cm = cm || {};
cm.guardianArmorModel = function (i) {
    var v = null;
    var m = null;
    var r = 0;
    var b = [];
    var y = {};
    var g = {};
    var h = {};
    var k = {
        equip: "eqp",
        unequip: "ueqp",
        drop: "del"
    };

    function l() {
        p();
        if (!seed.inventory) {
            seed.inventory = []
        }
        m = seed.inventory;
        var z = t();
        if (seed.inventory_slots) {
            r = seed.inventory_slots - z
        } else {
            seed.inventory_slots = z
        }
    }

    function p() {
        if (!cm.guardianModalModel.gObj().armor) {
            cm.guardianModalModel.gObj().armor = {}
        }
        v = cm.guardianModalModel.gObj().armor;
        seed.inventory_slots = t() + r;
        q()
    }

    function t() {
        var A = 0;
        for (var z = 0; z < seed.guardian.length; z++) {
            if (seed.guardian[z].level > 0) {
                A++
            }
        }
        return A + 4
    }

    function x(B, A, D, C) {
        if (A == k.equip) {
            var z = cm.guardianConst.items[B]["type"];
            if (v[z]) {
                d(v[z]);
                j(v[z])
            }
            w(B);
            c(B)
        } else {
            if (A == k.unequip) {
                j(B);
                d(B)
            } else {
                if (A == k.drop && D) {
                    if (D == cm.guardianConst.itemHolder.inventory) {
                        w(B)
                    } else {
                        if (D == cm.guardianConst.itemHolder.equipment) {
                            j(B)
                        }
                    }
                }
            }
        }
        q();
        a();
        C({
            ok: true
        })
    }

    function c(A) {
        var z = cm.guardianConst.items[A]["type"];
        v[z] = A
    }

    function j(A) {
        var z = cm.guardianConst.items[A]["type"];
        if (v[z]) {
            delete v[z]
        }
    }

    function d(E) {
        var B = Object.keys(cm.guardianConst.armorAttr);
        var C = B.indexOf(cm.guardianConst.items[E]["type"]);
        for (var A = 0; A < m.length; A++) {
            var z = cm.guardianConst.items[m[A]]["type"];
            var D = B.indexOf(z);
            if (C == D) {
                if (parseInt(m[A]) >= parseInt(E)) {
                    m.splice(A, 0, E);
                    return
                }
            } else {
                if (C < D) {
                    m.splice(A, 0, E);
                    return
                }
            }
        }
        m.push(E)
    }

    function w(z) {
        if (m.indexOf(z) != -1) {
            m.splice(m.indexOf(z), 1)
        }
    }

    function s(B) {
        var z = B.split(" ")[2].toLowerCase();
        var A = B.split(" ")[0].replace("+", "").replace("%", "");
        b = [z, parseInt(A)]
    }

    function q() {
        if (Object.keys(v).length == 4) {
            for (var A = 0; A < cm.guardianConst.bonusSet.length; A++) {
                var C = cm.guardianConst.bonusSet[A]["ids"];
                for (var z = 0; z < C.length; z++) {
                    var B = cm.guardianConst.items[C[z]]["type"];
                    if (v[B] != C[z]) {
                        break
                    }
                    if (z == C.length - 1) {
                        h.data = cm.guardianConst.bonusSet[A]["bonus"];
                        h.text = u(A);
                        return
                    }
                }
            }
        }
        h.data = [];
        h.text = g_js_strings.guardian.setBonus_notavailable
    }

    function u(A) {
        var z = cm.guardianConst.bonusSet[A]["name"].replace(" ", "_");
        return g_js_strings.guardian["setBonus_" + z]
    }

    function a() {
        for (var A in cm.guardianConst.armorAttr) {
            var z = cm.guardianConst.armorAttr[A];
            if (v[A]) {
                y[z] = cm.guardianConst.items[v[A]]["bonus"];
                g[z] = cm.guardianConst.items[v[A]]["bonus"]
            } else {
                y[z] = 0;
                g[z] = 0
            }
            if (z == b[0]) {
                y[z] += b[1]
            }
            if (z == h.data[0]) {
                y[z] += h.data[1]
            }
        }
    }

    function f(A, B) {
        var z = false;
        if (m.indexOf(A) == -1) {
            B(o(g_js_strings.guardian_err.missItemFrInvt))
        } else {
            if (cm.guardianModalModel.upgrading()) {
                B(o(g_js_strings.guardian_err.upgrading))
            } else {
                if (m.length > seed.inventory_slots && v[cm.guardianConst.items[A]["type"]]) {
                    B(o(g_js_strings.guardian_err.invtFullWhenEquip))
                } else {
                    z = true
                }
            }
        }
        return z
    }

    function e(A, B) {
        var z = false;
        if (!v[cm.guardianConst.items[A]["type"]]) {
            B(o(g_js_strings.guardian_err.missItemFrEquip))
        } else {
            if (cm.guardianModalModel.upgrading()) {
                B(o(g_js_strings.guardian_err.upgrading))
            } else {
                if (m.length >= seed.inventory_slots) {
                    B(o(g_js_strings.guardian_err.invtFullWhenUnequip))
                } else {
                    z = true
                }
            }
        }
        return z
    }

    function n(A, C, B) {
        var z = false;
        if (C == cm.guardianConst.itemHolder.inventory) {
            if (m.indexOf(A) == -1) {
                B(o(g_js_strings.guardian_err.missItemFrInvt))
            } else {
                z = true
            }
        } else {
            if (C == cm.guardianConst.itemHolder.equipment) {
                if (!v[cm.guardianConst.items[A]["type"]]) {
                    B(o(g_js_strings.guardian_err.missItemFrEquip))
                } else {
                    if (cm.guardianModalModel.upgrading()) {
                        B(o(g_js_strings.guardian_err.upgrading))
                    } else {
                        z = true
                    }
                }
            }
        }
        return z
    }

    function o(z) {
        return {
            ok: false,
            msg: z
        }
    }
    return {
        init: l,
        refresh: p,
        addSlots: function (z) {
            r += (z) ? parseInt(z) : 1
        },
        addInvtItems: function (z) {
            for (var A = 0; A < z.length; A++) {
                d(z[A])
            }
        },
        setBoosts: function (z) {
            if (z.cl3) {
                s(z.cl3);
                a()
            }
        },
        getEquips: function () {
            return v
        },
        getInvItems: function () {
            return m
        },
        getTotalBoosts: function () {
            return y
        },
        getEquipBoosts: function () {
            return g
        },
        getBonus: function () {
            return h
        },
        getInvSlots: function () {
            return seed.inventory_slots
        },
        equipItem: function (z, A) {
            if (f(z, A)) {
                x(z, k.equip, null, A)
            }
        },
        unEquipItem: function (z, A) {
            if (e(z, A)) {
                x(z, k.unequip, null, A)
            }
        },
        dropItem: function (z, B, A) {
            if (n(z, B, A)) {
                x(z, k.drop, B, A)
            }
        }
    }
}(jQuery);
cm.guardianBonusView = function (d) {
    var c = ["food", "wood", "stone", "ore"];

    function a(e) {
        e.resources = {
            stone: 388,
            wood: 277,
            food: 28345,
            ore: 2228
        }
    }

    function b() {
        var f = {
            food: 0,
            wood: 0,
            stone: 0,
            ore: 0
        };
        var g = cm.guardianModalModel.gObj();
        var e = d.extend({}, f, g.resources || {});
        return e
    }
    return {
        get: function (e) {
            var f = parseInteger(e.substr(3)) - 1;
            return b()[[c[f]]]
        },
        html: function (f, e) {
            var h = b();
            f.push("<tr><td class='stat'>" + g_js_strings.openCastle.guardianbonus + "</td>");
            for (var g = 0; g < 4; g++) {
                var j = parseInt(h[c[g]]);
                e[g + 1] = e[g + 1] + j;
                f.push("<td>");
                f.push(addCommas(j));
                f.push("</td>")
            }
            f.push("</tr>")
        }
    }
}(jQuery);
var cm = cm || {};
cm.guardianConst = {
    disable: function (b) {
        var a = cm.guardianConst.enabled_types.indexOf(b);
        cm.guardianConst.enabled_types[a] = false;
        return a
    },
    enabled_types_count: function () {
        var a;
        for (a = 0; a < 5; a++) {
            if (!cm.guardianConst.enabled_types[a]) {
                return a
            }
        }
    },
    types: ["wood", "ore", "food", "stone"],
    enabled_types: ["wood", "ore", "food", "stone"],
    bdgTypes: {
        wood: 50,
        ore: 51,
        food: 52,
        stone: 53
    },
    numTypes: {
        50: "wood",
        51: "ore",
        52: "food",
        53: "stone"
    },
    items: {
        "2100": {
            type: "helm",
            name: "Simple Helm of Sustenance",
            bonus: 1
        },
        "2120": {
            type: "guantlets",
            name: "Simple Gloves of Sustenance",
            bonus: 1
        },
        "2140": {
            type: "chest",
            name: "Simple Mail of Sustenance",
            bonus: 1
        },
        "2160": {
            type: "greaves",
            name: "Simple Boots of Sustenance",
            bonus: 1
        },
        "2202": {
            type: "helm",
            name: "Durable Helm of Offense",
            bonus: 1
        },
        "2222": {
            type: "guantlets",
            name: "Durable Gloves of Offense",
            bonus: 3
        },
        "2242": {
            type: "chest",
            name: "Durable Mail of Offense",
            bonus: 2
        },
        "2262": {
            type: "greaves",
            name: "Durable Boots of Offense",
            bonus: 2
        }
    },
    armorAttr: {
        helm: "hp",
        guantlets: "atk",
        chest: "def",
        greaves: "spd",
        resource: "res"
    },
    bonusSet: [{
        name: "simple sustenance",
        ids: ["2100", "2120", "2140", "2160"],
        bonus: ["res", 2]
    }, {
        name: "durable offense",
        ids: ["2202", "2222", "2242", "2262"],
        bonus: ["atk", 5]
    }],
    itemHolder: {
        inventory: "inv",
        equipment: "eqp"
    },
    unlockItem: {
        ore: "2002",
        food: "2003",
        stone: "2004"
    },
    bonusAttr: {
        wood: "hp",
        ore: "attack",
        food: "speed",
        stone: "training"
    }
};
cm.guardianController = function (g) {
    function e(m) {
        if (m.ok !== false || m.building == false) {
            seed.queue_con["city" + currentcityid] = [];
            cm.guardianModalModel.open({
                onOpen: function () {
                    cm.ModalManager.alert({
                        text: g_js_strings.guardian.cancel
                    });
                    cm.guardianModalModel.setUpgrade(false);
                    cm.guardianCity.rerender(true)
                }
            })
        }
    }
    var d = function () {};
    var h = "";
    var l;

    function j(m) {
        g(".garbage").hide();
        d(h, cm.guardianModalView.renderItems)
    }

    function b(q) {
        var p = q.target.id;
        h = g("#" + p).attr("inventory_id");
        var m = p.indexOf("eq_") > -1;
        var n = m ? ".equipment" : ".inventory";
        var o = m ? ".inventory" : ".equipment";
        d = m ? cm.guardianArmorModel.unEquipItem : cm.guardianArmorModel.equipItem;
        l = m ? cm.guardianConst.itemHolder.equipment : cm.guardianConst.itemHolder.inventory;
        g(n).css("zIndex", 303000);
        g(o).css("zIndex", 302000);
        g(".garbage").show().droppable({
            drop: c
        })
    }

    function c(m) {
        cm.guardianArmorModel.dropItem(h, l, cm.guardianModalView.renderItems);
        g(".garbage").hide()
    }

    function f() {
        cm.ModalManager.close();
        cm.guardianModalView.rerender()
    }

    function k() {
        cm.ModalManager.alert({
            exe: function m() {
                cm.guardianModalModel.release(f)
            },
            text: g_js_strings.guardian.release,
            button_text: g_js_strings.guardian.release_text
        })
    }

    function i() {
        cm.guardianModalModel.upgrade()
    }

    function a() {
        cm.guardianTransformView.render(true)
    }
    return {
        cancel: function () {
            AjaxCall.gPostRequest("ajax/_dispatch.php", {
                ctrl: "Guardian",
                action: "cancelConstruction",
                cityId: currentcityid,
                type: cm.guardianModalModel.getType(),
                tvuid: tvuid
            }, e)
        },
        bind: function () {
            g(".guardianModal .cancelGuardian").unbind("click").bind("click", cm.guardianModalView.proposeCancel);
            g(".guardianModal .upr").unbind("click").bind("click", i)
        },
        bind_transform: function () {
            g(".guardianModal .non_desat .release").unbind("click").bind("click", k);
            g(".guardianModal .non_desat .transform").unbind("click").bind("click", cm.guardianTransformView.render)
        },
        equipment: function () {
            g(".guardianModal .inventory .item img, .guardianModal .equipment img").draggable({
                stop: j,
                start: b,
                zIndex: 800000
            })
        },
        askForHelpClicked: function (o) {
            var n = parseInt(cm.guardianModalModel.getDynamics().time);
            if (g(o).is(":checked")) {
                var m = Math.max(600, parseInt(n * 0.1));
                n = (n - m) < 0 ? 0 : (n - m)
            }
            cm.guardianModalModel.updateUprTime(n)
        }
    }
}(jQuery);
cm.guardianItem = function (c) {
    var a = "";
    var d = false;

    function b(j) {
        cm.ModalManager.alert({
            text: j,
            exe: function () {
                cm.guardianItem.render()
            }
        })
    }

    function i() {
        if (parseInt(seed.items.i2000) <= 0) {
            cm.log.l("You have 0 of those items.")
        }
        a = c(".guardian_item input").val();
        if (a.length <= 0) {
            cm.ModalManager.close();
            b(g_js_strings.guardian.nameEmpty)
        } else {
            if (a.indexOf(" ") > -1) {
                cm.ModalManager.close();
                b(g_js_strings.guardian.nospace)
            } else {
                AjaxCall.gPostRequest("ajax/_dispatch.php", {
                    ctrl: "Guardian",
                    action: "rename",
                    type: cm.guardianModalModel.getType(),
                    name: a,
                    cityId: currentcityid,
                    tvuid: tvuid
                }, g)
            }
        }
    }

    function e(j) {
        if (j.indexOf("Please create a name") == 0) {
            return g_js_strings.guardian.create
        } else {
            return j
        }
    }

    function g(j) {
        if (!j.ok) {
            cm.ModalManager.close();
            b(e(j.msg));
            return false
        }
        if (parseInt(seed.items.i2000) > 0) {
            seed.items.i2000 -= 1;
            ksoItems[2000].subtract()
        }
        cm.ModalManager.close();
        cm.guardianModalModel.setTitle(a);
        Modal.hideModal();
        if (d) {
            cm.InventoryView.openInventory()
        }
    }

    function f() {
        return "<div class='title'></div><div class='description'></div><input type='text' id='name' maxlength='15' value='Guardian' /><div class='name_item'></div><div class='count'></div><div class='use'></div>"
    }

    function h() {
        var j = g_js_strings.guardian_item;
        for (var n in j) {
            c(".guardian_item ." + n).html(j[n])
        }
        var l = !seed.items.i2000 || seed.items.i2000 == "" ? "0" : seed.items.i2000;
        c(".count").html(l);
        c(".guardian_item .use").unbind("click").bind("click", function () {
            i()
        });
        c("#name").val("Guardian");
        var k = cm.util.ieVersion();
        if (cm.util.isIE() && !cm.util.ie9()) {
            c(".guardian_item input").css("padding-top", 8)
        }
    }
    return {
        render: function (j) {
            d = j === true;
            cm.ModalManager.add({
                body: f(),
                closeNow: true,
                show: h,
                "class": "guardian_item",
                curtain: true,
                width: 360,
                height: 250,
                left: 225,
                top: 155
            })
        }
    }
}(jQuery);
cm.gtype_map = {
    wood: "01",
    ore: "02",
    food: "03",
    stone: "04"
};
cm.ntype_map = {
    "01": "wood",
    "02": "ore",
    "03": "food",
    "04": "stone"
};
cm.lev_map = {
    "0": "build_here",
    "1": "lvl1-3_normal",
    "2": "lvl1-3_normal",
    "3": "lvl1-3_normal",
    "4": "lvl4-5_normal",
    "5": "lvl4-5_normal",
    "6": "lvl6-9_normal",
    "7": "lvl6-9_normal",
    "8": "lvl6-9_normal",
    "9": "lvl6-9_normal",
    "10": "lvl10_normal",
    "11": "lvl10_normal",
    "12": "lvl10_normal"
};
cm.status_map = {
    "0": "",
    normal: "normal",
    damaged: "damaged"
};
cm.guardianCity = function (e) {
    function a() {
        if (!cm.WorldSettings.isOn("GUARDIAN_FOOD")) {
            cm.guardianConst.disable("food")
        }
        if (!cm.WorldSettings.isOn("GUARDIAN_STONE")) {
            cm.guardianConst.disable("stone")
        }
    }

    function f() {
        a();
        if (!buildingcost.bdg50) {
            buildingcost.bdg50 = ["Guardian", 200, 3000, 2500, 100, 0, 0, 900,
            {
                b19: [0, -2]
            }, [], "The guardian can be built from level 1 to 10."]
        }
        cm.UnlockController.register();
        cm.UnlockController.setTimer();
        if (e(".bldg_guardian_0").length == 0) {
            c()
        }
    }

    function c(k) {
        var j = cm.gtype_map[cm.guardianModalModel.getType()];
        var i = cm.status_map[status] == "" ? "" : "_";
        var h = parseInt(cm.guardianModalModel.gObj().level) + (k ? 1 : 0);
        var g = stimgUrl + "img/guardian/guardian" + j + "_" + (cm.guardianModalModel.upgrading() ? "build_cleaned.gif" : cm.lev_map[h] + ".png");
        e(".bldg_guardian_0").remove();
        e("#citymap").append("<div id='guardianContainer' class='guardianHover bldg_guardian_0' onmouseout='removeTooltip();'  onmouseover=\"showClearingTooltip(this,event,'slot_500');\"><img src='" + g + "'/></div>");
        e(".guardianHover").hover(b, d).unbind("click").bind("click", function () {
            if (cm.guardianModalModel.gObj().guardianCount == 0 && cm.WorldSettings.isOn("GUARDIAN_SUMMON") == true) {
                cm.guardianTransformView.render(true)
            } else {
                cm.guardianModalModel.open()
            }
        })
    }

    function b() {
        var g = e(this).find("img");
        var h = g.attr("src");
        g.attr("src", h.replace("guardian/", "guardian/hover_states_png8/"))
    }

    function d() {
        var g = e(this).find("img");
        var h = g.attr("src");
        g.attr("src", h.replace("guardian/hover_states_png8/", "guardian/"))
    }
    return {
        init: function () {
            f()
        },
        rerender: function (g, h) {
            if (g === true || cm.guardianModalModel.isGuardian(parseInt(g[0][0]))) {
                e(".bldg_guardian_0").remove();
                c(h)
            }
            cm.UnlockController.setTimer()
        }
    }
}(jQuery);
cm.guardianModalModel = function (b) {
    var s = {
        basic: false,
        time: false
    };
    var j = {
        barTitle: "loading...",
        name: "None",
        cl0: "",
        ul0: "",
        description: "Loading...",
        cl2: "loading...",
        ul2: "loading...",
        cl3: "loading...",
        ul3: "loading...",
        time: 123434,
        upgrade: "false",
        required: {
            food: 0,
            wood: 0,
            stone: 0,
            ore: 0
        },
        youOwn: {
            food: 0,
            wood: 0,
            stone: 0,
            ore: 0
        }
    };
    var t = {
        upgrade: g_js_strings.commonstr.upgrade,
        cl1: g_js_strings.guardian.cl1,
        ul1: g_js_strings.guardian.ul1,
        askForHelp: g_js_strings.guardian.askForHelp,
        main: g_js_strings.guardian.main
    };

    function r(u) {
        return parseInt(Math.random() * u)
    }

    function l(u) {
        u.cl0 = r(12);
        u.ul0 = parseInt(u.cl0) + 1;
        cm.guardianModalModel.gObj().level = u.cl0;
        cm.guardianModalModel.gObj().status = r(10) > 5 ? "0" : "1"
    }

    function q(v) {
        var u = cm.guardianModalModel.upgrading();
        return (u ? g_js_strings.guardian.upgradeStr : g_js_strings.guardian.timeStr) + ": <span class='timeChange'>" + timestr(parseInt(v)) + "</span>" + (u ? "<div class='cancelGuardian'>Cancel</div>" : "")
    }

    function e() {
        j.youOwn.food -= j.required.food;
        j.youOwn.wood -= j.required.wood;
        j.youOwn.stone -= j.required.stone;
        j.youOwn.ore -= j.required.ore;
        seed.resources["city" + currentcityid].rec1[0] -= j.required.food * 3600;
        seed.resources["city" + currentcityid].rec2[0] -= j.required.wood * 3600;
        seed.resources["city" + currentcityid].rec3[0] -= j.required.stone * 3600;
        seed.resources["city" + currentcityid].rec4[0] -= j.required.ore * 3600
    }

    function a(u) {
        if (u == cm.guardianConst.types[0]) {
            common_postToProfile(300, Object.cloneFeed(template_data_300), Object.cloneFeed(actionlink_data_300), continuation_300, [])
        } else {
            if (u == cm.guardianConst.types[1]) {
                common_postToProfile(301, Object.cloneFeed(template_data_301), Object.cloneFeed(actionlink_data_301), continuation_301, [])
            } else {
                if (u == cm.guardianConst.types[2]) {
                    common_postToProfile(304, Object.cloneFeed(template_data_304), Object.cloneFeed(actionlink_data_304), continuation_304, [])
                } else {
                    if (u == cm.guardianConst.types[3]) {
                        common_postToProfile(305, Object.cloneFeed(template_data_305), Object.cloneFeed(actionlink_data_305), continuation_305, [])
                    }
                }
            }
        }
    }

    function m(w) {
        cm.util.clearDouble("guardian");
        cm.log.err(w);
        var x = parseInt(cm.guardianModalModel.gObj().level);
        if (x == 9) {
            seed.items.i401 -= 1;
            ksoItems[401].subtract()
        }
        if (w.time) {
            cm.guardianModalModel.setUpgrade(true);
            if (w.guardian) {
                j = w.guardian
            }
            e();
            h(w.time, w.buildingId);
            if (b(".cmModalContainer .askFriends").is(":checked")) {
                build_gethelp(w.buildingId)
            } else {
                try {
                    if (x == 0) {
                        var u = cm.guardianModalModel.getType();
                        a(u)
                    }
                } catch (v) {}
            }
            cm.ModalManager.close();
            cm.guardianCity.rerender(true)
        }
    }

    function h(y, u) {
        var v = cm.guardianModalModel.gObj().level;
        var w = cm.guardianModalModel.getType();
        var x = cm.guardianConst.bdgTypes[w.toLowerCase()];
        seed.queue_con["city" + currentcityid].push([x, parseInt(v) + 1, parseInt(u), unixtime(), unixtime() + parseInt(y), 0, y, 500]);
        queue_changetab_building()
    }
    var o = 0;

    function g() {
        if (unixtime() % 10 == 0 && o < 30) {
            return true
        }
    }

    function d(u) {
        k = true;
        AjaxCall.gPostRequest("ajax/_dispatch.php", {
            ctrl: "Guardian",
            action: "build",
            cityId: currentcityid,
            tvuid: tvuid,
            type: cm.guardianModalModel.getType(),
            permission: u === true ? 1 : 0
        }, m)
    }
    var k = false;
    var n = 100;
    var i = false;
    var f = {
        0: 0,
        1: 1,
        2: 2,
        3: 3,
        4: 4,
        5: 6,
        6: 6,
        7: 7,
        8: 8,
        9: 9,
        10: 10,
        11: 11,
        12: 12
    };
    var c = {
        0: 0,
        1: 1,
        2: 1,
        3: 2,
        4: 2,
        5: 3,
        6: 3,
        7: 4,
        8: 5,
        9: 7,
        10: 10,
        11: 15,
        12: 20
    };
    var p = function (u) {
            cm.guardianModalModel.gObj().cityGuardianLevels = {
                wood: u[0].level,
                ore: u[1].level,
                food: u[2].level,
                stone: u[3].level
            }
        };
    return {
        updateCityGuardianLevelsReplace: function (u) {
            cm.guardianModalModel.gObj().cityGuardianLevels = u
        },
        whatsBuilding: function () {
            var w = seed.queue_con;
            if (w) {
                var v = w["city" + currentcityid];
                if (v) {
                    var u = w["city" + currentcityid][0];
                    if (u) {
                        return parseInt(u)
                    }
                }
            }
        },
        isGuardian: function (u) {
            return u == 50 || u == 51 || u == 52 || u == 53
        },
        update: function (u) {
            if (cm.guardianModalModel.gObj().upgrading) {
                k = true
            }
            n = u;
            var v = cm.guardianModalModel.whatsBuilding();
            if (b(".guardianModal .timeChange").length == 0 && (v == undefined || cm.guardianModalModel.isGuardian(v))) {
                b(".guardianModal .time").html(q(u))
            }
            if (cm.guardianModalModel.isGuardian(v)) {
                b(".guardianModal .timeChange").html(timestr(u))
            }
            if (u == 1) {
                cm.guardianModalModel.finish()
            }
        },
        updateUprTime: function (u) {
            n = u;
            b(".guardianModal .timeChange").html(timestr(u))
        },
        finish: function () {
            var v = cm.guardianModalModel.whatsBuilding();
            var u = cm.guardianConst.numTypes[v]
        },
        ref: function (v) {
            var u = -1;
            b.each(seed.guardian, function (w, x) {
                if (x.cityId && v == x.cityId) {
                    u = w
                }
            });
            return seed.guardian[u]
        },
        gObj: function () {
            var u = seed.guardian.filter(function (v) {
                return currentcityid == v.cityId
            })[0];
            if (u.type == -1) {
                u.type = "wood"
            }
            return u
        },
        setTitle: function (u) {
            j.barTitle = u + "  Level " + cm.guardianModalModel.gObj().level;
            j.name = u
        },
        getDynamics: function () {
            return j
        },
        setDynamics: function (u) {
            j = b.extend(j, u)
        },
        getData: function () {
            var u = b.extend({}, t, j);
            if (s.time) {
                j.time = 10000
            }
            u.time = cm.guardianModalModel.update(j.time);
            u.barTitle = fUp(u.type || "") + " Guardian " + fUp(g_js_strings.guardian.level) + " " + u.cl0;
            if (s.basic) {
                l(u)
            }
            return u
        },
        setChoose: function (u) {
            i = u
        },
        getChoose: function () {
            return i
        },
        open: function (v) {
            cm.util.clearDouble("guardian");
            var u = cm.util.clientTime();
            AjaxCall.gPostRequest("ajax/_dispatch.php", {
                ctrl: "Guardian",
                action: "buildModal",
                cityId: currentcityid,
                tvuid: tvuid,
                new_level: cm.guardianModalModel.getLevel(),
                type: i
            }, function (x) {
                cm.sounds.play("open_guardian");
                p(x.cityGuardians);
                var w = cm.util.clientTime();
                cm.epochTimeOffset.update(x.reqmicrotime, w - u);
                if (!x.guardian.type) {
                    x.guardian.type = "stone"
                }
                cm.guardianModalModel.setType(x.guardian.type);
                if (x.ok == false) {
                    if (x.msg) {
                        Modal.showAlert(x.msg)
                    }
                    return false
                }
                if (x.guardian && parseInt(x.guardian.cl0) > parseInt(j.cl0)) {
                    k = false
                }
                if (x.guardian) {
                    j = x.guardian
                }
                if (cm.guardianModalModel.getLevel() == 0 && !j.type) {
                    cm.guardianModalModel.setType(cm.guardianConst.types[0])
                }
                cm.guardianModalModel.setLevel(j.cl0);
                cm.guardianModalModel.setUpgrade(j.upgrade == true);
                cm.guardianSummonModel.init(x.cityGuardians, x.summonGuardian);
                cm.guardianModalView.open();
                if (v && v.onOpen) {
                    v.onOpen()
                }
            })
        },
        getType: function () {
            var u = cm.guardianModalModel.gObj().type;
            if (!cm.WorldSettings.isOn("GUARDIAN_ORE") && !u) {
                return "wood"
            }
            if (!u) {
                return false
            } else {
                if (cm.guardianConst.types.indexOf(u) == -1) {
                    return false
                }
            }
            return u
        },
        getStoneTrainingSpeedBonus: function () {
            var w = cm.guardianModalModel.getTrainBonus() / 100;
            var v = cm.guardianSummonModel.getSetBonus();
            var y = cm.guardianModalModel.getType() == "stone";
            var x = 0;
            if (y && v) {
                x = 1.5
            }
            if (y && !v) {
                x = 1
            }
            if (!y && v) {
                x = 0.5
            }
            if (!y && !v) {
                x = 0
            }
            var u = w * x;
            cm.log.l("Stone speed bonus = " + u);
            return u
        },
        getCurrentStoneGuardianLevel: function () {
            var u = cm.guardianModalModel.gObj().cityGuardianLevels.stone;
            cm.log.l("currentCityStoneGuardianLevel = " + u);
            u = u || 0;
            return +u
        },
        getMarchBonus: function () {
            var v = cm.guardianSummonModel.getSetBonus();
            var u = cm.guardianModalModel.gObj().cityGuardianLevels.food;
            u = u || 0;
            u = +u;
            var w = f[u];
            if (cm.guardianModalModel.getType() == "food") {
                if (v) {
                    w = w * 1.5
                }
            } else {
                if (v) {
                    w = w * 0.5
                } else {
                    w = 0
                }
            }
            cm.log.l("march boost=" + w);
            return w
        },
        getTrainBonus: function () {
            return c[cm.guardianModalModel.getCurrentStoneGuardianLevel()]
        },
        setType: function (u) {
            cm.guardianModalModel.gObj().type = u
        },
        getLevel: function () {
            return parseInt(cm.guardianModalModel.gObj().level)
        },
        setLevel: function (u) {
            if (!seed.buildings["city" + currentcityid]["pos" + 500]) {
                seed.buildings["city" + currentcityid]["pos" + 500] = []
            }
            seed.buildings["city" + currentcityid]["pos" + 500][1] = u;
            cm.guardianModalModel.gObj().level = u;
            cm.guardianModalModel.gObj().cityGuardianLevels[cm.guardianModalModel.getType()] = u
        },
        increaseLevel: function () {
            cm.guardianModalModel.setLevel(parseInt(cm.guardianModalModel.gObj().level) + 1)
        },
        release: function (u) {
            AjaxCall.gPostRequest("ajax/_dispatch.php", {
                ctrl: "Guardian",
                action: "release",
                cityId: currentcityid,
                tvuid: tvuid
            }, function (v) {
                if (v.ok) {
                    cm.guardianModalModel.setLevel(0)
                }
                u(v)
            })
        },
        setUpgrade: function (u) {
            cm.guardianModalModel.gObj().upgrading = u
        },
        upgrade: function () {
            if (cm.util.preventDoubleClick("guardian", 1)) {
                return false
            }
            if (cm.guardianModalModel.getLevel() == 9) {
                cm.ModalManager.alert({
                    text: g_js_strings.guardian.are_you_sure,
                    exe: function () {
                        d(true)
                    }
                })
            } else {
                d()
            }
        },
        upgrading: function () {
            return cm.guardianModalModel.gObj().upgrading == true
        }
    }
}(jQuery);
cm.guardianModalView = function (i) {
    var n = false;
    var j = "";
    var e = true;
    var q = 270;

    function k() {
        var r = (cm.guardianModalModel.getLevel() == 0 || cm.guardianModalModel.upgrading() ? "desat" : "non_desat");
        var t = n ? ("<div class='inventory'></div><div class='equipmentItems'></div><div class='equipment'></div><div class='equipment_labels'></div><div class='bonus_estr'></div><div class='garbage'></div>") : "";
        var s = j ? ("<div class='tl_bracket " + r + "'><div class='release but'>Release</div><div class='transform but'>Transform</div></div>") : "";
        s = "";
        return "<div class='barTitle'></div><div class='name' title='" + g_js_strings.guardian.tooltipName + "' style='" + (n ? "" : "height: 28px;") + "'></div><div class='total_stats'></div><div class='figure'></div><div class='rightTopContainer'><div class='description'></div><div class='time_table left'><div class='time'></div><div class='notenough'>" + g_js_strings.modal_build.reqnotmet + "</div></div><div class='time_table right'><div class='checkHolder'></div><div class='rightBottom'></div><div class='story_button'></div></div></div><div class='rightPanel'><div class='upgradeRequirements' >Upgrade Requirements</div><div class='upgradeBenefits' >Upgrade Benefits</div><div class='requiredSection' title='" + g_js_strings.guardian.tooltipResource + "'><div class='top'><span>" + g_js_strings.commonstr.resource + "</span><span>" + g_js_strings.commonstr.required + "</span><span>" + g_js_strings.commonstr.youown + "</span></div><div class='wild'><span>" + g_js_strings.commonstr.wilderness + "</span><span class='req'>0</span><span class='you'>0</span></div><div class='food'><span>" + g_js_strings.commonstr.food + "</span><span class='req'>loading...</span><span class='you'>loading...</span></div><div class='wood'><span>" + g_js_strings.commonstr.wood + "</span><span class='req'>loading...</span><span class='you'>loading...</span></div><div class='stone'><span>" + g_js_strings.commonstr.stone + "</span><span class='req'>loading...</span><span class='you'>loading...</span></div><div class='ore'><span>" + g_js_strings.commonstr.ore + "</span><span class='req'>loading...</span><span class='you'>loading...</span></div><div class='item'><span>" + g_js_strings.guardian.divineinsp + "</span><span class='req'>1</span><span class='you'>loading...</span></div></div><div class='currentLevelOuter lTile'><div class='cl0 bigNum'></div><div class='cl1 levDes'></div><div class='cl2'></div><div class='cl3'></div></div><div class='upgradeLevelOuter lTile'><div class='ul0 bigNum'></div><div class='ul1 levDes'></div><div class='ul2'></div><div class='ul3'></div></div><div class='arrow'></div><div class='bottom_boot'></div></div>" + t + s + "<div class='bottom'></div>"
    }

    function b() {
        var r = parseInt(cm.guardianModalModel.gObj().level);
        j = cm.WorldSettings.isOn("GUARDIAN_ORE");
        e = cm.WorldSettings.isOn("GUARDIAN_SUMMON");
        cm.ModalManager.add({
            body: k(),
            closeNow: true,
            close: function () {
                cm.guardianCity.rerender(true)
            },
            show: m,
            lower: true,
            "class": "guardianModal",
            curtain: true,
            width: 750,
            height: 768 - (e ? 0 : q),
            left: 5,
            top: 5
        })
    }

    function f(r) {
        return r == "wild" ? "Lv. " : ""
    }

    function a(r) {
        var u = false;
        if (r.required.item) {
            r.required.item = 1;
            r.youOwn.item = seed.items.i401 || 0
        }
        for (var s in r.required) {
            i(".guardianModal .requiredSection ." + s + " .req").html(f(s) + addCommas(r.required[s]));
            i(".guardianModal .requiredSection ." + s + " .you").html(f(s) + addCommas(r.youOwn[s]));
            if (parseInt(r.youOwn[s]) < parseInt(r.required[s])) {
                i(".guardianModal .requiredSection ." + s + " .req").addClass("unmet");
                u = true
            }
        }
        if (cm.guardianModalModel.upgrading()) {
            u = false
        }
        if (r.youOwn.wild) {
            i(".requiredSection .wild .you").html(f("wild") + r.youOwn.wild)
        }
        var t = parseInt(cm.guardianModalModel.gObj().level);
        i(".guardianModal .notenough")[u && t < 10 ? "show" : "hide"]();
        i(".guardianModal .rightBottom")[u ? "addClass" : "removeClass"]("notclickable");
        i(".guardianModal .item")[t == 9 ? "show" : "hide"]();
        i(".time, .checkHolder")[u ? "hide" : "show"]();
        if (t == 9) {
            i(".rightPanel").addClass("lv9")
        }
    }
    var p = [0, 1, 1, 1, 2, 2, 3, 3, 3, 3, 4, 5];

    function m() {
        var u = cm.guardianModalModel.getData();
        for (var A in u) {
            i(".guardianModal ." + A).html(u[A])
        }
        var z = cm.guardianModalModel.getType();
        i(".guardianModal .description").html(g_js_strings[z + "_guardian"].description);
        var v = cm.guardianModalModel.whatsBuilding();
        a(u);
        var w = [0, -330, -655, -965, -1280, -1650];
        var B = p[parseInt(u.cl0)];
        i(".guardianModal .figure").css("background", "url(" + stimgUrl + "img/guardian_" + z + ".png) " + w[B] + "px 0px");
        if (cm.guardianModalModel.upgrading()) {
            i(".guardianModal .rightBottom").html("Speed Up").addClass("spd").removeClass("upr");
            i(".checkHolder").html("").hide();
            var t = i(".guardianModal .story_button");
            var r = i(".guardianModal .rightBottom.spd");
            var y = seed.queue_con["city" + currentcityid][0][2];
            var C = getBuildHelpEligible(y, currentcityid);
            if (!C) {
                t.html(g_js_strings.modal_messages_viewreports_view.askforhelp).unbind("click").bind("click", function () {
                    build_gethelp(y)
                }).show();
                r.css("margin-top", "9px")
            } else {
                t.html("").hide();
                r.css("margin-top", "22px")
            }
        } else {
            var x = cm.guardianModalModel.getLevel() == 0 ? g_js_strings.commonstr.build : g_js_strings.commonstr.upgrade;
            i(".guardianModal .rightBottom").html(x).removeClass("spd").addClass("upr");
            i(".checkHolder").html("<input type='checkbox' class='askFriends' onclick='cm.guardianController.askForHelpClicked(this)'/><div class='askForHelp'>" + g_js_strings.modal_build.sharemessagebuildorresearch + "</div>").show();
            i(".guardianModal .story_button").html("").hide()
        }
        o(parseInt(u.cl0));
        if (!cm.guardianModalModel.isGuardian(v) && v != undefined) {
            i(".rightBottom").addClass("notclickable");
            i(".time").html(g_js_strings.modal_build.buildoneattime).addClass("unable")
        }
        var s = cm.guardianModalModel.gObj().level;
        if (i(".guardianModal .notclickable").length == 0 && parseInt(s) != 10) {
            cm.guardianController.bind()
        }
        i(".name").unbind("click").bind("click", cm.guardianItem.render);
        i(".guardianModal .spd").unbind("click").bind("click", function () {
            var D = seed.queue_con["city" + currentcityid][0][2];
            modal_speedup("bdg", D, undefined, "Guardian")
        });
        if (parseInt(s) == 10) {
            i(".guardianModal .rightBottom").removeClass("notclickable").removeClass("upr").removeClass("spd");
            i(".time_table, .upgradeRequirements").remove()
        }
        if (parseInt(s) == 0) {
            i(".guardianModal .figure").attr("title", g_js_strings.guardian.tooltipFigure_0)
        } else {
            i(".guardianModal .figure").attr("title", g_js_strings.guardian.tooltipFigure_1)
        }
        if (n) {
            cm.guardianModalView.renderItems()
        }
        if (j) {
            cm.guardianController.bind_transform()
        }
        if (e) {
            cm.UnlockView.render()
        }
    }

    function o(r) {
        if (r == 9) {
            i(".guardianModal").css("height", 788 - (cm.WorldSettings.isOn("GUARDIAN_SUMMON") ? 0 : q))
        } else {
            if (r == 10) {
                i(".rightBottom").html("").addClass("level10");
                i(".currentLevelOuter").addClass("currentLevelOuterLvl10");
                i(".time, .checkHolder, .arrow, .requiredSection, .upgradeLevelOuter").remove();
                i(".currentLevelOuter").appendTo(".rightTopContainer");
                i(".rightPanel").remove();
                i(".guardianModal").css("height", (cm.WorldSettings.isOn("GUARDIAN_SUMMON") ? 609 : 420))
            }
        }
    }

    function h(s, t, r) {
        return "<img id='loc_" + t + "' inventory_id='" + r + "' src='" + stimgUrl + "img/items/70/" + s + ".jpg' />"
    }

    function d() {
        var t = cm.guardianArmorModel.getInvItems();
        var u = "";
        var s = 24 > parseInt(t.length) ? 24 : parseInt(t.length);
        for (var r = 0; r < s; r++) {
            u += "<div class='item'>" + (t[r] ? h(t[r], "inv_" + r, t[r]) : "") + "</div>"
        }
        i(".guardianModal .inventory").html("<div class='sign'>" + g_js_strings.guardian.inventory + "</div>" + u)
    }

    function l() {
        var t = cm.guardianArmorModel.getEquips();
        var s = "";
        for (var r in t) {
            s += h(t[r], "eq_" + r, t[r])
        }
        i(".equipment").html(s)
    }

    function c(r) {
        return "<div class='outerResource'>" + g_js_strings.guardian.getResources + "<br><div class='requiredSection guareq' ><div class='top'><span>" + g_js_strings.commonstr.resource + "</span><span>" + g_js_strings.commonstr.get + "</span></div><div class='food'><span>" + g_js_strings.commonstr.food + "</span><span class='you'>" + r.food + "</span></div><div class='wood'><span>" + g_js_strings.commonstr.wood + "</span><span class='you'>" + r.wood + "</span></div><div class='stone'><span>" + g_js_strings.commonstr.stone + "</span><span class='you'>" + r.stone + "</span></div><div class='ore'><span>" + g_js_strings.commonstr.ore + "</span><span class='you'>" + r.ore + "</span></div></div></div>"
    }

    function g() {
        var u = cm.guardianArmorModel.getTotalBoosts();
        var s = cm.guardianArmorModel.getEquipBoosts();
        var w = cm.guardianArmorModel.getBonus();
        var t = 0;
        i(".total_stats").html("<div class='b0 stat_width'></div><div class='b1 stat_width'></div><div class='b2 stat_width'></div><div class='b3 stat_width'></div>");
        i(".equipment_labels").html("<div class='b0'></div><div class='b1'></div><div class='b2'></div><div class='b3'></div>");
        for (var r in u) {
            i(".total_stats .b" + t).html(u[r]);
            t++
        }
        t = 0;
        for (var v in s) {
            i(".equipment_labels .b" + t).html(s[v]);
            t++
        }
        i(".guardianModal .bonus_estr").html(w.text)
    }
    return {
        proposeCancel: function () {
            cm.ModalManager.alert({
                button_text: g_js_strings.commonstr.cancel,
                text: c(cm.guardianModalModel.getDynamics().required),
                "class": "guardian_cancel",
                exe: cm.guardianController.cancel
            })
        },
        open: function () {
            b()
        },
        rerender: function () {
            var r = i(".guardianModal").length > 0;
            if (r) {
                b()
            }
            return r
        },
        renderItems: function (r) {
            if (r && r.msg) {
                cm.ModalManager.alert(r.msg)
            }
            l();
            d();
            g();
            cm.guardianController.equipment()
        }
    }
}(jQuery);
var cm = cm || {};
cm.guardianSummonModel = function (c) {
    var d = [],
        b;

    function a(f, g) {
        for (var e = 0; e < d.length; e++) {
            if (d[e]) {
                if (d[e].type == f) {
                    d[e].status = "active";
                    cm.guardianModalModel.setDynamics(g)
                } else {
                    if (d[e].status == "active") {
                        d[e].status = "summon"
                    }
                }
            }
        }
    }
    return {
        init: function (e, f) {
            d = e;
            b = f
        },
        getData: function () {
            return d
        },
        getSetBonus: function () {
            return parseInt(cm.guardianModalModel.gObj().guardianCount) == 4
        },
        getSummonGuardian: function () {
            return b
        },
        getAttrBonus: function () {
            for (var f = 0; f < d.length; f++) {
                if (d[f] && d[f].status == "active") {
                    var e = {
                        type: cm.guardianConst.bonusAttr[d[f].type],
                        value: d[f].cl3.split(" ")[0]
                    };
                    return e
                }
            }
        },
        summon: function (e, f) {
            AjaxCall.gPostRequest("ajax/_dispatch.php", {
                ctrl: "Guardian",
                action: "summon",
                cityId: currentcityid,
                tvuid: tvuid,
                type: e
            }, function (h) {
                if (h.ok) {
                    var g = cm.guardianModalModel.gObj();
                    g.summonGuardian = {
                        summonFinishTime: parseInt(h.summonFinishTime),
                        level: h.summonGuardian.cl0,
                        type: h.summonGuardian.type,
                        upgrading: false
                    };
                    f({
                        finishTime: h.summonFinishTime,
                        summonFinishCallback: function () {
                            var i = seed.guardian.filter(function (j) {
                                return h.summonGuardian.cityId == j.cityId
                            })[0];
                            i.timeLeft = 0;
                            i.level = h.summonGuardian.cl0;
                            i.type = h.summonGuardian.type;
                            if (i.summonGuardian) {
                                delete i.summonGuardian
                            }
                            if (currentcityid == h.summonGuardian.cityId) {
                                a(h.summonGuardian.type, h.summonGuardian)
                            }
                        }
                    })
                }
            })
        },
        get_summon_finish: function (e) {
            return function () {
                var f = seed.guardian.filter(function (g) {
                    return e == g.cityId
                })[0];
                if (f.summonGuardian) {
                    f.timeLeft = 0;
                    f.level = f.summonGuardian.level;
                    f.type = f.summonGuardian.type;
                    delete f.summonGuardian;
                    if (currentcityid == e && b) {
                        a(b.type, b)
                    }
                }
            }
        }
    }
}(jQuery);
cm.guardianTransformController = function (a) {
    return {
        bind: function () {
            a(".left_triangle").unbind().bind("click", function () {
                var b = cm.guardianTransformModel.getPrev();
                cm.guardianTransformView.rerender(b)
            });
            a(".right_triangle").unbind().bind("click", function () {
                var b = cm.guardianTransformModel.getNext();
                cm.guardianTransformView.rerender(b)
            });
            a(".choose_button").unbind().bind("click", function () {
                var b = "" + cm.guardianTransformModel.getType();
                cm.ModalManager.close();
                cm.ModalManager.close();
                cm.guardianModalModel.open();
                cm.guardianModalModel.gObj().guardianCount++
            });
            a(".transform_price .buy a").unbind().bind("click", function () {
                var b = a(this);
                b.hide();
                cm.guardianTransformModel.buy(function (c) {
                    if (c.ok) {
                        a("#kochead_gems").html(seed.player.gems);
                        cm.guardianTransformView.rerender()
                    } else {
                        cm.ModalManager.alert({
                            text: c.msg,
                            button_text: g_js_strings.guardian_err.getMore,
                            exe: function () {
                                cm.ModalManager.close();
                                modal_getgems()
                            }
                        });
                        b.show()
                    }
                })
            });
            a(".transform_bottom_button").unbind().bind("click", function () {
                cm.guardianTransformModel.unlock(function (c) {
                    if (c.code) {
                        if (c.code == 2000) {
                            cm.ModalManager.alert({
                                text: g_js_strings.guardian_err.notEnoughGems,
                                button_text: g_js_strings.guardian_err.getMore,
                                exe: function () {
                                    cm.ModalManager.close();
                                    modal_getgems()
                                }
                            })
                        } else {
                            cm.ModalManager.alert({
                                text: c.msg
                            })
                        }
                    } else {
                        cm.ModalManager.close();
                        cm.ModalManager.close();
                        cm.guardianModalModel.open();
                        var b = "" + cm.guardianTransformModel.getType();
                        if (cm.guardianModalModel.gObj().guardianCount == 0) {
                            cm.guardianModalModel.gObj().guardianCount += 2
                        } else {
                            cm.guardianModalModel.gObj().guardianCount++
                        }
                    }
                })
            })
        }
    }
}(jQuery);
var cm = cm || {};
cm.guardianTransformModel = function (f) {
    var g, j, c = {};

    function d(k) {
        g = k
    }

    function i() {
        j = cm.guardianConst.types.length;
        for (var m = 0; m < j; m++) {
            var l = cm.guardianConst.types[m];
            if (!c[l]) {
                c[l] = {};
                c[l].type = l;
                c[l].nav = (j > 1);
                c[l].name = g_js_strings.guardian[l + "_name"];
                c[l].attr = g_js_strings.guardian[l + "_attr"];
                c[l].res = [g_js_strings.guardian[l + "_res0"], g_js_strings.guardian[l + "_res1"]];
                c[l].desc = g_js_strings.guardian[l + "_desc"];
                if (cm.guardianConst.unlockItem[l]) {
                    c[l].unlockText = g_js_strings.guardian[l + "_unlock"];
                    c[l].cost = g_js_strings.guardian[l + "_unlockCost"];
                    c[l].itemId = cm.guardianConst.unlockItem[l];
                    var k = 0;
                    if (seed.items["i" + c[l].itemId]) {
                        k = seed.items["i" + c[l].itemId]
                    }
                    c[l].numOfItems = k;
                    c[l].itemPrice = itemlist["i" + c[l].itemId].price;
                    c[l].btnText = g_js_strings.guardian.unlock
                } else {
                    c[l].btnText = g_js_strings.commonstr.choose
                }
            } else {
                var n = cm.guardianConst.unlockItem[l];
                c[l].numOfItems = seed.items["i" + n]
            }
        }
    }

    function e() {
        var k = cm.guardianConst.enabled_types.indexOf(g) - 1;
        j = cm.guardianConst.enabled_types_count();
        if (k == -1) {
            k = j - 1
        }
        d(cm.guardianConst.types[k])
    }

    function h() {
        var k = cm.guardianConst.enabled_types.indexOf(g) + 1;
        j = cm.guardianConst.enabled_types_count();
        cm.log.l("numOfGuardians=" + j);
        if (k == j) {
            k = 0
        }
        d(cm.guardianConst.types[k])
    }

    function b(k) {
        AjaxCall.gPostRequest("ajax/_dispatch.php", {
            ctrl: "Guardian",
            action: "unlock",
            cityId: currentcityid,
            tvuid: tvuid,
            type: g
        }, function (l) {
            if (l.ok) {
                if (c[g].numOfItems > 0) {
                    seed.items["i" + c[g].itemId] -= 1;
                    ksoItems[c[g].itemId].subtract();
                    c[g].numOfItems -= 1;
                    cm.guardianModalModel.setLevel(0)
                }
            }
            k(l)
        })
    }

    function a(k) {
        return {
            ok: false,
            msg: k
        }
    }
    return {
        init: function () {
            g = cm.guardianConst.types[0];
            i()
        },
        getData: function (k) {
            if (k && cm.guardianConst.types.indexOf(k) != -1) {
                d(k);
                if (!c[g]) {
                    i()
                }
                c[g].nav = (j > 2)
            }
            return c[g]
        },
        getPrev: function () {
            e();
            c[g].nav = (j > 1);
            return c[g]
        },
        getNext: function () {
            h();
            c[g].nav = (j > 1);
            return c[g]
        },
        getType: function () {
            return g
        },
        unlock: function (k) {
            b(k)
        },
        buy: function (k) {
            if (c[g].itemPrice > parseInt(seed.player.gems)) {
                k(a(g_js_strings.guardian_err.notEnoughGems))
            } else {
                cm.ShopController.easyBuy(c[g].itemId, function () {
                    c[g].numOfItems = parseInt(c[g].numOfItems) + 1;
                    k({
                        ok: true
                    })
                })
            }
        }
    }
}(jQuery);
cm.guardianTransformView = function (a) {
    return {
        render: function (b) {
            cm.guardianTransformModel.init();
            cm.guardianTransformView.rerender(undefined)
        },
        rerender: function (g) {
            var b = (g && g.res ? g : cm.guardianTransformModel.getData());
            var i = (b.itemPrice);
            var d = parseInt(b.numOfItems) > 0 ? true : false;
            var h = "";
            var e = true;
            if (b.type == "food" && !cm.WorldSettings.isOn("GUARDIAN_FOOD_BUY")) {
                e = false
            }
            if (b.itemPrice) {
                h = e ? "<div class='transform_price'><div class='pcost'>" + b.itemPrice + "</div><div class='little_gem'></div><div class='buy'><a class='inlineButton blue14' style='display: inline;'><span>Buy</span></a></div></div>" : "";
                h += "<div class='transform_to'>" + b.unlockText + "</div><div class='transform_cost'>" + b.cost + '</div><div class="icon_own"><img src="' + stimgUrl + "img/items/30/" + b.itemId + '.jpg" class="icon"><div class="own "><span id="item_stock">' + (b && b.numOfItems ? b.numOfItems : 0) + "</span></div>   </div>"
            }
            var f = "choose_button";
            if (i) {
                f = "transform_bottom_button";
                if (b.numOfItems == 0) {
                    f = "transform_bottom_button_gray"
                }
            }
            var c = "<div class='pic " + b.type + "'></div><div class='name'>" + b.name + "</div><div class='title'>" + g_js_strings.guardian[i ? "unlock_a_guardian" : "choose_a_guardian"] + "</div><div class='left_box_top'>" + b.attr + "</div><div class='left_box_bottom'>" + b.res[0] + "<br><span>" + b.res[1] + "</span></div><div class='description'>" + b.desc + "</div>" + h + "<div class='" + f + "'>" + b.btnText + "</div>" + (b.nav === true ? "<div class='left_triangle'></div><div class='right_triangle'></div>" : "");
            cm.ModalManager.add({
                body: c,
                closeNow: a(".choose_modal").length > 0,
                show: cm.guardianTransformController.bind,
                "class": "choose_modal " + (i ? "transform_modal" : ""),
                curtain: true,
                width: 655,
                height: i ? 581 : 510,
                left: 55,
                top: 110
            })
        }
    }
}(jQuery);
if (!window.HelpDesk) {
    var HelpDesk = new Object()
}
HelpDesk.Properties = {};
HelpDesk.Methods = {
    show: function (b) {
        if (undefined == cm.features.NO_RIGHTNOW_CRM || "true" == cm.features.NO_RIGHTNOW_CRM) {
            var a = "?iframe=1&" + Object.toQueryString(g_ajaxparams);
            if (b) {
                b = Math.min(5, parseInt(b));
                a += "&selectedTab=" + b
            }
            var d = "<iframe src='helpDesk_src.php" + a + "' frameborder='0' width='740px' height='620px' scrolling='no' allowTransparency='true'></iframe>";
            var e = unescape($("helpdesk_show").innerHTML);
            var c = new Template(e).evaluate({
                create_ticket_iframe: d
            });
            Modal.showModal(740, 580, 90, 10, g_js_strings.commonstr.help, c);
            return
        }
        switch (b) {
        case 6:
            cm.CRMLink.open("reportChat");
            break;
        case 7:
            cm.CRMLink.open("reportMail");
            break;
        default:
            cm.CRMLink.open("help")
        }
    }
};
Object.extend(HelpDesk, HelpDesk.Methods);
Object.extend(HelpDesk, HelpDesk.Properties);

function modal_help_request(a) {
    var b = new Array();
    b.push("<div class='helprequestbox'>");
    b.push("<div class='helptext'>" + g_js_strings.modal_help_request.choosecat + "</div>");
    b.push("<div class='cat_box'>");
    b.push("<select id='helpCat'>");
    b.push("<option value='0'>" + g_js_strings.modal_help_request.dsetcatd + "</option>");
    b.push("<option value='1'>" + g_js_strings.modal_help_request.billissue + "</option>");
    b.push("<option value='2'>" + g_js_strings.modal_help_request.bugreport + "</option>");
    b.push("<option value='3'>" + g_js_strings.modal_help_request.gamequestion + "</option>");
    b.push("<option value='4'>" + g_js_strings.modal_help_request.featsugg + "</option>");
    b.push("<option value='5'>" + g_js_strings.modal_help_request.report + "</option>");
    b.push("</select>");
    b.push("</div>");
    b.push("<div id='emCatError' class='helperror' style='display:none;'>" + g_js_strings.modal_help_request.selcat + "</div>");
    b.push("<div class='helptext'>" + g_js_strings.modal_help_request.descprob + "</div>");
    b.push("<div class='problem_box'>");
    b.push("<textarea id='helpProblem'></textarea>");
    b.push("</div>");
    b.push("<div id='emProbError' class='helperror' style='display:none;'>" + g_js_strings.modal_help_request.mustdescprob + "</div>");
    b.push("<div class='helptext'>" + g_js_strings.modal_help_request.enterem + "</div>");
    b.push("<div class='email_box'><input id='helpEmail' value=''/></div>");
    b.push("<div id='emAddrError' class='helperror' style='display:none;'>" + g_js_strings.modal_help_request.mustenterem + "</div>");
    b.push("<div class='btns clearfix'>");
    b.push("<a class='button25' onclick='sendHelpRequest();return false;'><span>" + g_js_strings.commonstr.submit + "</span></a>");
    b.push("<a class='button25' onclick='Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a>");
    b.push("</div>");
    b.push("</div>");
    Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.helprequest, b.join(""));
    if (a) {
        $("helpCat").value = a
    }
}

function sendHelpRequest() {
    var errFlag = false;
    var comment = $("helpProblem").value;
    var cat = $("helpCat").value;
    var emAddr = $("helpEmail").value;
    if (emAddr.blank() || !validateEmails(emAddr)) {
        $("emAddrError").show();
        errFlag = true
    } else {
        $("emAddrError").hide()
    }
    if (cat == 0) {
        $("emCatError").show();
        errFlag = true
    } else {
        $("emCatError").hide()
    }
    if (comment.blank()) {
        $("emProbError").show();
        errFlag = true
    } else {
        $("emProbError").hide()
    }
    if (!errFlag) {
        var params = Object.clone(g_ajaxparams);
        params.action = "REQUEST_FORM_CS";
        params.email = emAddr;
        params.type = cat;
        params.message = comment;
        new Ajax.Request(g_ajaxpath + "ajax/reportCs.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    Modal.hideModalAll();
                    var helpHtml = new Array();
                    helpHtml.push("<div class='helprequestconfirmbox'>");
                    helpHtml.push("<div>" + g_js_strings.sendHelpRequest.thankyou + "</div>");
                    helpHtml.push("<div><a href='https://support.watercooler-inc.com' target='_blank'>https://support.watercooler-inc.com</a></div>");
                    helpHtml.push("<div class='btns clearfix'><a class='button25' onclick='Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.ok + "</span></a></div>");
                    helpHtml.push("</div>");
                    Modal.showModal(400, 400, 180, 100, g_js_strings.modaltitles.helprequestsent, helpHtml.join(""))
                } else {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                }
            },
            onFailure: function () {}
        })
    }
};
var cm = cm || {};
cm.HUDInit = function (e) {
    if (!e || !e.length) {
        return
    }
    var c, d, a;
    var b = function (f) {
            d = cm.HUDIconFactory.getIcon(f);
            if (d) {
                d.setParentElement("hudBottomContainer");
                jQuery("#sharethis_icon").css("display", "none")
            }
        };
    c = e[0];
    d = cm.HUDIconFactory.getIcon(c);
    if (d) {
        d.setParentElement("hudTopContainer")
    }
    if (e.length < 2) {
        return
    }
    c = e[1];
    if (c.type != 9) {
        if (c.type == cm.HUDIconTypes.TRIALPAY_DEALSPOT2) {
            cm.ResourceLoader.add("js", "https://s-assets.tp-cdn.com/static3/js/api/payment_overlay.js", {
                async: true,
                callback: function () {
                    b(e[1])
                }
            })
        } else {
            b(c)
        }
    }
    if (e.length < 3) {
        return
    }
    c = e[2];
    d = cm.HUDIconFactory.getIcon(c);
    a = cm.WorldSettings.hasKeyValuePair("LOGIN_REWARDS", "on");
    if (d && seed.loginReward.show_hud && a) {
        d.setParentElement("hudThirdContainer")
    }
};
cm.HUDIcon = function (m) {
    var l = this;
    var a;
    var e;
    var b;
    var o;
    var f;
    var h;
    var n;
    var d;
    var g;
    var k = function () {
            o = m.images["icon"];
            a = document.createElement("a");
            a.href = m.url;
            a.target = "_top";
            a.className = m.cssClass;
            a.innerHTML = m.innerHTML || "";
            Event.observe(a, "click", j);
            Event.observe(a, "mouseover", c);
            Event.observe(a, "mouseout", i);
            f = document.createElement("img");
            f.src = o;
            a.appendChild(f);
            if (m.images["border"]) {
                b = document.createElement("img");
                b.src = m.images["border"];
                b.className = "borderImage";
                a.appendChild(b)
            }
            h = document.createElement("img");
            h.src = m.images["over"];
            n = m.tooltip;
            d = ["mapContainerId"]
        };
    this.setParentElement = function (p) {
        $(p).appendChild(a)
    };
    var j = function (p) {
            if (m.clickCallback) {
                var q = m.clickCallback;
                if (typeof (q == "function")) {
                    q(p)
                }
            }
        };
    var c = function (p) {
            f.src = h.src + "?v=1";
            showTooltip(n, a, p, "maparea_city")
        };
    var i = function (p) {
            f.src = o;
            removeTooltip()
        };
    k()
};
cm.HUDDealOfTheDayIcon = function (k) {
    var a;
    var e;
    var j;
    var b = k.flash.id;
    var l;
    var d;
    var f;
    var i = function () {
            a = document.createElement("a");
            a.href = k.url;
            a.className = k.cssClass;
            Event.observe(a, "click", h);
            Event.observe(a, "mouseover", c);
            Event.observe(a, "mouseout", c);
            j = document.createElement("div");
            j.id = b;
            a.appendChild(j);
            l = k.tooltip;
            d = k.mapContainerId
        };
    this.setParentElement = function (m) {
        $(m).appendChild(a);
        swfobject.registerObject("tpDotD", "9.0.0", "expressInstall.swf");
        swfobject.embedSWF(k.flash.swfUrl, b, k.flash.width, k.flash.height, "9.0.0", "expressInstall.swf", k.flash.flashvars, k.flash.params)
    };
    var h = function (m) {
            if (k.clickCallback) {
                var n = k.clickCallback;
                if (typeof (n == "function")) {
                    n(m)
                }
            }
        };
    var c = function (m) {
            if (l && l != "") {
                showTooltip(l, a, m, d)
            }
        };
    var g = function (m) {
            removeTooltip()
        };
    i()
};
cm.HUDDealSpot = function (j) {
    var a;
    var e;
    var i;
    var b = "dealSpotSwfStub";
    var k;
    var d;
    var f;
    var h = function () {
            a = document.createElement("a");
            a.className = j.cssClass;
            i = document.createElement("div");
            i.id = b;
            a.appendChild(i);
            setTimeout(function () {
                try {
                    TRIALPAY.social.render_dealspot_swf({
                        id: b,
                        app_id: appSettings.appId,
                        currency_url: g_paymentHost + "/payment/cog?gameid=1",
                        onOfferUnavailable: "TRIALPAY.social.delete_dealspot_swf",
                        onTransact: "cm.HUDDealSpot.handleTransactions",
                        mode: "fbpayments",
                        sid: tpuid,
                        width: "100%",
                        height: "100%"
                    });
                    return
                } catch (l) {}
            }, 0);
            Event.observe(a, "mouseover", c);
            Event.observe(a, "mouseout", c);
            k = j.tooltip;
            d = j.mapContainerId
        };
    this.setParentElement = function (l) {
        $(l).appendChild(a)
    };
    var c = function (l) {
            if (k && k != "") {
                showTooltip(k, a, l, d)
            }
        };
    var g = function (l) {
            removeTooltip()
        };
    h()
};
cm.HUDDealSpot.handleTransactions = function () {
    modal_getgems_check()
};
cm.HUDIconTimerController = function (a, c) {
    var h = a;
    var b;
    var f;
    var e = function () {
            f = 0;
            b = setInterval(d, c.interval * 1000)
        };
    var d = function () {
            var i = h[f];
            i.showBouncingArrow();
            setTimeout(g, 5000)
        };
    var g = function () {
            var i = h[f];
            i.hideBouncingArrow();
            f++;
            if (f >= h.length) {
                f = 0
            }
        };
    e()
};
cm.HUDIconTypes = {
    INVITE: 0,
    GIFT: 1,
    GIFT_OF_THE_DAY: 2,
    DEAL_OF_THE_DAY: 3,
    MERLINS_WHEEL: 4,
    NEXT_UNPURCHASED_PACKAGE: 5,
    SHARE: 6,
    DAILY_REWARD: 7,
    GEM_GIFTING: 8,
    DEAL_OF_THE_DAY_NEW: 10,
    VALENTINE_DAY_DEALSPOT: 11,
    TRIALPAY_DEALSPOT2: 12
};
cm.HUDIconFactory = {
    getIcon: function (b) {
        switch (b.type) {
        case cm.HUDIconTypes.DEAL_OF_THE_DAY:
            return new cm.HUDDealOfTheDayIcon(b);
            break;
        case cm.HUDIconTypes.DEAL_OF_THE_DAY_NEW:
            b.clickCallback = function () {
                var d = parent.KB.TrialPay.DealSpot.getInstance();
                d.setEnabled(true);
                d.show()
            };
            return new cm.HUDIcon(b);
            break;
        case cm.HUDIconTypes.INVITE:
            b.clickCallback = function () {
                invite_friends_popup()
            };
            return new cm.HUDIcon(b);
            break;
        case cm.HUDIconTypes.GIFT:
        case cm.HUDIconTypes.GIFT_OF_THE_DAY:
            return new cm.HUDIcon(b);
            break;
        case cm.HUDIconTypes.NEXT_UNPURCHASED_PACKAGE:
            b.clickCallback = function () {
                cm.ConversionTracker.track("payments", "MORE_GEMS_HUD", "");
                modal_getgems()
            };
            return new cm.HUDIcon(b);
            break;
        case cm.HUDIconTypes.MERLINS_WHEEL:
            b.clickCallback = function () {
                cm.mww.start(0)
            };
            return new cm.HUDIcon(b);
            break;
        case cm.HUDIconTypes.SHARE:
            b.clickCallback = cm.HUDIconShare.exe;
            return new cm.HUDIcon(b);
            break;
        case cm.HUDIconTypes.DAILY_REWARD:
            var a = ~~ (1 * (seed.loginReward.consec_days_logon)) + 1,
                c;
            if (a > 5) {
                c = "<span id='dailyRewardHudInside'>5+</span>"
            } else {
                c = "<span id='dailyRewardHudInside'>" + a + "</span>"
            }
            b.clickCallback = function () {
                cm.DailyRewardsView.hudClick()
            };
            b.innerHTML = c;
            return new cm.HUDIcon(b);
            break;
        case cm.HUDIconTypes.GEM_GIFTING:
            b.clickCallback = function () {
                cm.ConversionTracker.track("payments", "MORE_GEMS_HUD", "");
                modal_getgems()
            };
            return new cm.HUDIcon(b);
            break;
        case cm.HUDIconTypes.TRIALPAY_DEALSPOT2:
            return new cm.HUDDealSpot(b);
            b.clickCallback1 = function () {
                try {
                    TRIALPAY.social.render_dealspot_swf({
                        id: "trialpay_dealspot",
                        app_id: appSettings.appId,
                        currency_url: g_paymentHost + "/payment/cog?gameid=1",
                        onOfferUnavailable: "TRIALPAY.social.delete_dealspot_swf",
                        mode: "fbpayments",
                        sid: tpuid,
                        width: 50,
                        height: 50
                    });
                    return
                } catch (d) {}
                cm.log.l("TRIALPAY is not loaded.")
            };
            return new cm.HUDIcon(b);
            break;
        default:
            return null
        }
    }
};
cm.HUDIconShare = function (e) {
    var c = "#sharethis_icon";
    var b = "cm.HUDIconShare.tooltipIn( this, event );";
    var d = "cm.HUDIconShare.tooltipOut();";

    function a() {
        var f = stimgUrl + "/img/fb_icon_animated.gif";
        e(".st_facebook_large .stLarge").css("background-image", "url(" + f + ")")
    }
    return {
        tooltipIn: function (g, f) {
            showTooltip(g_js_strings.title.text, g, f, "mod_maparea")
        },
        tooltipOut: function () {
            removeTooltip()
        },
        fieldview: function () {
            e(c).css("top", 109).attr("title", g_js_strings.title.text).appendTo("#fieldmap")
        },
        cityview: function () {
            e(c).css("top", 82).attr("title", g_js_strings.title.text).prependTo("#hudBottomContainer")
        },
        redoImg: function () {
            setTimeout(a, 1000);
            setTimeout(a, 5000);
            setTimeout(a, 12000);
            setTimeout(a, 18000)
        },
        exe: function () {
            return false;
            var i = "https://apps.facebook.com/kingdomsofcamelot/";
            var h = "kofc";
            var g = stimgUrl + "img/share_knight.png";
            var f = "https://www.facebook.com/sharer.php?s= 100&p[title]=Kingdoms of Camelot &p[url]=https://apps.facebook.com/kingdomsofcamelot/?ref=ts&p[images][0]=" + g + "&p[summary]=Kingdoms is the most challenging strategy game with thousands of players and great PvP action, and countless alliances.";
            window.open(f, "shareWindow", "width=500; height=300; resizable=no; toolbar=no; location=no; status=no; menubar=no; directories=no; scrollbars=no; ")
        }
    }
}(jQuery);
cm.ImpendingAttackReportRow = function (e, l) {
    cm.CustomEventDispatcher.call(this);
    var k = this;
    var a;
    var b;
    var c;
    var f;
    var g;
    var m;
    this.getLink = function () {
        return f
    };
    this.show = function (n) {
        if (n && n < g.childNodes.length) {
            g.insertBefore(a, g.childNodes[n])
        } else {
            g.appendChild(a)
        }
    };
    this.getKey = function () {
        return e.getKey()
    };
    var i = function () {
            var p = m.getMarchStatus();
            var o = m.getArrivalTime();
            var n = o ? cm.TimeFormatter.format(m.getArrivalTime() - unixtime()) : "????";
            n = p === cm.MARCH_STATUS.MARCH_STATUS_ABORTING ? "---" : n;
            b.innerHTML = n
        };
    var j = function (n) {
            var o = n === cm.MARCH_STATUS.MARCH_STATUS_ABORTING ? g_js_strings.ImpendingAttacks.recalled : g_js_strings.ImpendingAttacks.incoming;
            c.innerHTML = o
        };
    var d = function (n) {
            i()
        };
    this.remove = function () {
        try {
            g.removeChild(a);
            var n = new cm.ImpendingAttackReportRowEvent(cm.ImpendingAttackReportRowEvent.REMOVED);
            n.setTarget(k);
            k.dispatchCustomEvent(n)
        } catch (o) {} finally {
            m.removeEventListener(cm.IncomingAttackEvent.ARRIVAL_TIME_CHANGED, d)
        }
    };
    var h = function () {
            g = l;
            m = e;
            var w = m.getMarchType();
            var u = m.getMarchStatus();
            var x = w == cm.MARCH_TYPES.MARCH_TYPE_SCOUT ? "scout" : "attack";
            x = u == cm.MARCH_STATUS.MARCH_STATUS_ABORTING ? "recalled" : x;
            a = document.createElement("tr");
            a.className = x;
            var s = document.createElement("td");
            s.className = "marchTypeColumn";
            f = document.createElement("a");
            s.appendChild(f);
            var n = m.getAttacker();
            if (w) {
                var t = {
                    genderTitle: "",
                    name: "????"
                };
                if (n) {
                    var t = {
                        genderTitle: n.gender,
                        name: n.name
                    }
                }
                t.marchType = m.getMarchName();
                f.innerHTML = cm.StringFormatter.applyTemplate(g_js_strings.ImpendingAttacks.marchTypeFrom, t)
            } else {
                f.innerHTML = "????"
            }
            a.appendChild(s);
            var v = document.createElement("td");
            v.className = "targetColumn";
            var p, r, q;
            var o = m.getTile();
            if (o.isCity) {
                p = new cm.utils.CoordinateLink(o.city.x, o.city.y);
                r = g_js_strings.ImpendingAttacks.targetCity;
                q = {
                    cityName: o.city.name
                }
            } else {
                p = new cm.utils.CoordinateLink(o.wilderness.x, o.wilderness.y);
                r = g_js_strings.ImpendingAttacks.targetWilderness;
                q = {
                    wilderness: o.wilderness.typeName
                }
            }
            p.setClassName("coordinateLink");
            q.coordinate = p.getHTML();
            v.innerHTML = cm.StringFormatter.applyTemplate(r, q);
            a.appendChild(v);
            b = document.createElement("td");
            b.className = "timeRemainingColumn";
            a.appendChild(b);
            i();
            c = document.createElement("td");
            c.className = "statusColumn";
            a.appendChild(c);
            j(u);
            if (u != cm.MARCH_STATUS.MARCH_STATUS_ABORTING) {
                m.addEventListener(cm.IncomingAttackEvent.ARRIVAL_TIME_CHANGED, d)
            }
        };
    h()
};
cm.OOP.inherits(cm.ImpendingAttackReportRow, cm.CustomEventDispatcher);
cm.ImpendingAttackReportRowEvent = function (a) {
    cm.CustomEvent.call(this, a)
};
cm.OOP.inherits(cm.ImpendingAttackReportRowEvent, cm.CustomEvent);
cm.ImpendingAttackReportRowEvent.REMOVED = "removed";
cm.ImpendingAttackReportRowController = function (f, d) {
    var h;
    var b;
    var c;
    var g = this;
    var i = function (y) {
            var k = h.getTroops();
            var w = h.getTile();
            var m, E, l;
            if (w.isCity) {
                E = new cm.utils.CoordinateLink(w.city.x, w.city.y);
                l = g_js_strings.ImpendingAttacks.targetCity;
                m = {
                    cityName: w.city.name
                }
            } else {
                E = new cm.utils.CoordinateLink(w.wilderness.x, w.wilderness.y);
                l = g_js_strings.ImpendingAttacks.targetWilderness;
                m = {
                    wilderness: w.wilderness.typeName
                }
            }
            E.setClassName("coordinateLink");
            m.coordinate = E.getHTML();
            var D = cm.StringFormatter.applyTemplate(l, m);
            var v = 86400;
            var B = {};
            var o = 271;
            var u = Object.clone(itemlist["i" + o]);
            u.id = o;
            u.effect = {};
            u.effect.name = "defExpire";
            u.effect.duration = 1 * v;
            var t = new cm.CombatBoostItem(u);
            B[o.toString()] = t;
            var s = 272;
            var r = Object.clone(itemlist["i" + s]);
            r.id = s;
            r.effect = {};
            r.effect.name = "defExpire";
            r.effect.duration = 7 * v;
            var z = new cm.CombatBoostItem(r);
            B[s.toString()] = z;
            var q = [t, z];
            var n = {};
            n.combatLevel = h.getKnight() && h.getKnight().combatLevel ? h.getKnight().combatLevel : "????";
            var p = h.getResearches().length > 0 ? h.getResearches() : [{
                id: "????",
                name: "????",
                level: "????"
            }];
            var k = {};
            k.briefCount = h.getTroops().briefCount ? h.getTroops().briefCount : "????";
            k.collection = h.getTroops().collection.length > 0 ? h.getTroops().collection : [{
                id: "????",
                name: "????",
                imageUrl: "img/transparent.gif",
                amount: "????"
            }];
            var C = h.getAttacker() ? h.getAttacker() : {
                name: "????",
                gender: "????"
            };
            var j = {
                attack: h,
                text: {
                    watchTowerReport: g_js_strings.ImpendingAttacks.watchTowerReport,
                    target: g_js_strings.commonstr.target,
                    marchType: g_js_strings.modal_attack.marchtype,
                    estimatedArrival: g_js_strings.attack_generateincoming.estimatedarrival,
                    attacker: g_js_strings.commonstr.attacker,
                    armySize: g_js_strings.attack_viewimpending_view.armysize,
                    incomingTroops: g_js_strings.attack_viewimpending_view.incomingtroops,
                    alliance: g_js_strings.commonstr.alliance,
                    knightCombatLevel: g_js_strings.attack_viewimpending_view.knightcomlvl,
                    researchLevel: g_js_strings.attack_viewimpending_view.techlevels,
                    troops: g_js_strings.commonstr.troops,
                    amount: g_js_strings.commonstr.amount,
                    tech: g_js_strings.commonstr.tech,
                    level: g_js_strings.commonstr.level,
                    takeAction: g_js_strings.ImpendingAttacks.takeAction,
                    buffs: g_js_strings.ImpendingAttacks.buffs,
                    defend: g_js_strings.commonstr.defend,
                    fight: g_js_strings.ImpendingAttacks.fight,
                    apply: g_js_strings.commonstr.apply,
                    buy: g_js_strings.commonstr.buy,
                    buildDefenses: g_js_strings.modal_openWalls.builddefenses,
                    buildDefensesTip: g_js_strings.ImpendingAttacks.buildDefensesTip,
                    troopSettings: g_js_strings.ImpendingAttacks.troopSettings,
                    troopSettingsTip: g_js_strings.ImpendingAttacks.troopSettingsTip,
                    trainTroops: g_js_strings.modal_openBarracks.trainttl,
                    trainTroopsTip: g_js_strings.ImpendingAttacks.trainTroopsTip,
                    askForHelp: g_js_strings.modal_quests.askhelp,
                    askForHelpTip: g_js_strings.ImpendingAttacks.askForHelpTip
                },
                items: q,
                itemLookup: B,
                troops: k.collection,
                troopBriefCount: k.briefCount,
                knight: n,
                researches: p,
                alliance: h.getAlliance(),
                attacker: C,
                target: D,
                imagePath: stimgUrl
            };
            var x = new cm.WatchTowerReportDialog(j);
            var A = new cm.WatchTowerReportDialogController(j, x);
            x.show()
        };
    var a = function (j) {
            c.unbind("click", i);
            b.removeEventListener(cm.ImpendingAttackReportRowEvent.REMOVED, a)
        };
    var e = function () {
            h = f;
            b = d;
            c = jQuery(b.getLink());
            c.bind("click", i);
            b.addEventListener(cm.ImpendingAttackReportRowEvent.REMOVED, a)
        };
    e()
};
cm.ImpendingAttackReport = function (i) {
    var b;
    var k;
    var n;
    var h;
    var e;
    var g;
    var j;
    var d;
    this.getHtmlElement = function () {
        return b
    };
    this.show = function () {
        k.appendChild(b)
    };
    this.getHtmlElement = function () {
        return b
    };
    var q = function () {
            d.appendChild(g)
        };
    var o = function () {
            try {
                d.removeChild(g)
            } catch (r) {}
        };
    var p = function (u, r) {
            o();
            var t = new cm.ImpendingAttackReportRow(u, d);
            var s = cm.ImpendingAttackReportRowController(u, t);
            n.add(t);
            t.show(r)
        };
    var l = function (s) {
            var r = n.getElementByKey(s.getKey());
            n.remove(r);
            r.remove()
        };
    var f = function (t) {
            var s = t.getTarget();
            if (s.getMarchStatus() == cm.MARCH_STATUS.MARCH_STATUS_ABORTING) {
                p(s)
            } else {
                var r = h.getElementPosition(s);
                p(s, r)
            }
        };
    var c = function (r) {
            var s = r.getTarget();
            l(s);
            if (n.getCount() <= 0) {
                q()
            }
        };
    var a = function (r) {
            r.addEventListener(cm.CollectionEvent.ELEMENT_ADDED, f);
            r.addEventListener(cm.CollectionEvent.ELEMENT_REMOVED, c);
            var t = r.getCount();
            var s, u;
            for (s = 0; s < t; s++) {
                u = r.getElementAtPosition(s);
                p(u)
            }
        };
    this.remove = function () {
        var s, u;
        var r = n.getCount();
        for (s = 0; s < r; s++) {
            u = n.getElementAtPosition(s);
            u.remove()
        }
        try {
            k.removeChild(b)
        } catch (t) {}
        h.addEventListener(cm.CollectionEvent.ELEMENT_ADDED, f);
        h.addEventListener(cm.CollectionEvent.ELEMENT_REMOVED, c);
        e.addEventListener(cm.CollectionEvent.ELEMENT_ADDED, f);
        e.addEventListener(cm.CollectionEvent.ELEMENT_REMOVED, c)
    };
    var m = function () {
            n = new cm.BaseCollection();
            k = i.parentElement;
            b = document.createElement("table");
            b.className = "impendingAttacks";
            j = document.createElement("thead");
            b.appendChild(j);
            d = document.createElement("tbody");
            b.appendChild(d);
            var u = document.createElement("tr");
            j.appendChild(u);
            var t = document.createElement("th");
            t.className = "marchTypeColumn";
            t.innerHTML = i.text.marchType;
            u.appendChild(t);
            var r = document.createElement("th");
            r.className = "targetColumn";
            r.innerHTML = i.text.target;
            u.appendChild(r);
            var w = document.createElement("th");
            w.className = "timeRemainingColumn";
            w.innerHTML = i.text.timeRemaining;
            u.appendChild(w);
            var v = document.createElement("th");
            v.className = "statusColumn";
            v.innerHTML = i.text.status;
            u.appendChild(v);
            g = document.createElement("tr");
            var s = document.createElement("td");
            s.innerHTML = g_js_strings.ImpendingAttacks.noIncomingAttacks;
            s.setAttribute("colspan", "4");
            g.appendChild(s);
            q();
            h = i.attacks;
            a(h);
            e = i.recalledAttacks;
            a(e)
        };
    m()
};
var cm = cm || {};
cm.IncomingAttackController = function (c) {
    var g = this;
    var f;
    var i = function (m) {
            var n = m.getTarget();
            if (n instanceof cm.IncomingAttack) {
                var l = n.getMarchStatus();
                switch (l) {
                case cm.MARCH_STATUS.MARCH_STATUS_INACTIVE:
                    c.remove(n);
                    break;
                case cm.MARCH_STATUS.MARCH_STATUS_ABORTING:
                    c.remove(n);
                    var k = new cm.IncomingAttackRecalledDialog(n);
                    var j = new cm.IncomingAttackDialogController(n, k);
                    cm.NotificationDialogManager.popup(k);
                    cm.IncomingAttackManager.recall(n);
                    break
                }
            }
        };
    var b = function (k) {
            k.addEventListener(cm.IncomingAttackEvent.STATUS_CHANGED, i);
            var j = new cm.IncomingAttackNotificationDialog(k);
            var l = new cm.IncomingAttackDialogController(k, j);
            cm.NotificationDialogManager.popup(j)
        };
    var a = function (k) {
            if (f) {
                f.remove()
            }
            f = new cm.IncomingAttackTopNavNotification(k, $("impendingAttackContainer"));
            var j = new cm.IncomingAttackTopNavNotificationController(k, f);
            f.show()
        };
    var e = function (l) {
            var m = l.getTarget();
            m.removeEventListener(cm.IncomingAttackEvent.STATUS_CHANGED, i);
            var k = "m" + m.getId();
            if (seed.queue_atkinc[k]) {
                delete seed.queue_atkinc[k];
                if (Object.keys(seed.queue_atkinc).length === 0) {
                    seed.queue_atkinc = []
                }
            }
            if (c.getCount() > 0) {
                var j = c.getElementAtPosition(0);
                a(j)
            }
        };
    var h = function (k) {
            var j = k.getTarget();
            b(j);
            if (c.getElementAtPosition(0).getId() == j.getId()) {
                a(j)
            }
        };
    var d = function () {
            c.addEventListener(cm.CollectionEvent.ELEMENT_ADDED, h);
            c.addEventListener(cm.CollectionEvent.ELEMENT_REMOVED, e)
        };
    d()
};
cm.IncomingAttackRecalledController = function (b) {
    var c = this;
    var a = function (f) {
            var g = f.getTarget();
            b.remove(g)
        };
    var d = function (g) {
            var f = g.getTarget();
            f.addEventListener(cm.IncomingAttackEvent.RECALL_DISSMISSED, a)
        };
    var e = function () {
            b.addEventListener(cm.CollectionEvent.ELEMENT_ADDED, d)
        };
    e()
};
cm.BootLoader.add(function () {
    cm.IncomingAttackManager.init();
    var f, a;
    if (!(seed.queue_atkinc instanceof Array) && typeof (seed.queue_atkinc) == "object") {
        for (f in seed.queue_atkinc) {
            a = seed.queue_atkinc[f];
            a.mid = f.substr(1);
            var d = a.marchType;
            var c = a.score !== undefined;
            var g = a.marchStatus !== cm.MARCH_STATUS.MARCH_STATUS_INACTIVE && a.marchStatus !== cm.MARCH_STATUS.MARCH_STATUS_ABORTING;
            if (c && g) {
                var b = parseInt(a.arrivalTime);
                if (isNaN(b) || b > unixtime()) {
                    var e = new cm.IncomingAttack(a);
                    cm.IncomingAttackManager.add(e)
                }
            }
        }
    }
});
cm.IncomingAttack = function (h) {
    cm.CustomEventDispatcher.call(this);
    var t = this;
    var c;
    var b;
    var l;
    var A;
    var y;
    var m;
    var o;
    var v;
    var p;
    var i;
    var e;
    var s;
    var x;
    var d;
    var u;
    var g;
    var B;
    var f;
    var k;
    var z;
    var r;
    var n;
    var a;
    var w;
    var q;
    var j = function () {
            if (h && h.mid) {
                c = h.mid;
                b = h.marchStatus || cm.MARCH_STATUS.MARCH_STATUS_OUTBOUND;
                l = h.aid;
                A = h.arrivalTime;
                x = A - unixtime();
                y = h.cnt;
                m = h.departureTime;
                o = h.marchType;
                v = h.pid;
                p = h.players;
                i = h.score;
                e = h.toCityId;
                s = h.toTileId;
                u = h.kLv;
                g = h.knt;
                B = h.unts;
                f = h.tech;
                z = null;
                if (u) {
                    z = {};
                    z.level = u
                }
                if (g && g.cbt) {
                    z = z || {};
                    z.combatLevel = g.cbt
                }
                var K = [];
                var H, J;
                for (H in B) {
                    J = cm.TroopFactory.getUnit(H);
                    J.amount = i > 6 ? B[H] : "????";
                    K.push(J)
                }
                r = {
                    briefCount: h.cnt,
                    collection: K
                };
                k = [];
                var D, E;
                for (D in f) {
                    E = cm.ResearchFactory.getResearch(D);
                    E.level = f[D];
                    k.push(E)
                }
                n = {
                    id: l,
                    name: g_js_strings.commonstr.none
                };
                if (l && seed.allianceNames && seed.allianceNames["a" + l]) {
                    n.name = seed.allianceNames["a" + l]
                }
                a = null;
                var I = v;
                var G = seed.players;
                var C = I ? (G["u" + I] || p["u" + I]) : null;
                if (I && C) {
                    a = {};
                    a.name = C.n;
                    var F = C.s;
                    a.gender = F == "F" ? g_js_strings.commonstr.lady : g_js_strings.commonstr.lord
                }
                q = cm.UserTileInfoFactory.getTileInfo(e, s)
            } else {
                throw "Invalid Argument Error"
            }
        };
    this.setMarchStatus = function (C) {
        if (b != C) {
            b = C;
            var D = new cm.IncomingAttackEvent(cm.IncomingAttackEvent.STATUS_CHANGED);
            D.setTarget(t);
            t.dispatchCustomEvent(D)
        }
    };
    this.getMarchStatus = function () {
        return b
    };
    this.getId = function () {
        return c
    };
    this.recall = function () {
        if (b === cm.MARCH_STATUS.MARCH_STATUS_ABORTING) {
            c += "_recalled_" + unixtime();
            d = cm.IncomingAttack.RECALL_DISMISS_TIME
        }
    };
    this.getKey = function () {
        return c.toString() || "undefined"
    };
    this.getAllianceId = function () {
        return l
    };
    this.getArrivalTime = function () {
        return A
    };
    this.update = function () {
        if (b === cm.MARCH_STATUS.MARCH_STATUS_INACTIVE) {
            return
        }
        var C;
        if (d !== undefined) {
            d--;
            if (d <= 0) {
                d = undefined;
                C = new cm.IncomingAttackEvent(cm.IncomingAttackEvent.RECALL_DISSMISSED);
                C.setTarget(t);
                t.dispatchCustomEvent(C)
            }
        }
        if (typeof (A) !== "string" && typeof (A) !== "number") {
            return
        }
        var D = A - unixtime();
        if (D <= 0) {
            this.setMarchStatus(cm.MARCH_STATUS.MARCH_STATUS_INACTIVE)
        } else {
            if (x != D) {
                x = D;
                C = new cm.IncomingAttackEvent(cm.IncomingAttackEvent.ARRIVAL_TIME_CHANGED);
                C.setTarget(t);
                t.dispatchCustomEvent(C)
            }
        }
    };
    this.getCount = function () {
        return y
    };
    this.getDepartureTime = function () {
        return m
    };
    this.getMarchType = function () {
        return o
    };
    this.getPlayerId = function () {
        return v
    };
    this.getAttacker = function () {
        return a
    };
    this.setPlayers = function (C) {
        p = C
    };
    this.getScore = function () {
        return i
    };
    this.getDestinationCityId = function () {
        return e
    };
    this.getDestinationTileId = function () {
        return s
    };
    this.getKnight = function () {
        return z
    };
    this.getTroops = function () {
        return r
    };
    this.getResearches = function () {
        return k
    };
    this.getAlliance = function () {
        return n
    };
    this.getMarchName = function () {
        if (o) {
            return o == cm.MARCH_TYPES.MARCH_TYPE_SCOUT ? g_js_strings.commonstr.scout : g_js_strings.commonstr.attack
        } else {
            return "????"
        }
    };
    this.getTile = function () {
        return q
    };
    j()
};
cm.OOP.inherits(cm.IncomingAttack, cm.CustomEventDispatcher);
cm.IncomingAttack.RECALL_DISMISS_TIME = 300;
cm.IncomingAttackEvent = function (a) {
    cm.CustomEvent.call(this, a)
};
cm.OOP.inherits(cm.IncomingAttackEvent, cm.CustomEvent);
cm.IncomingAttackEvent.STATUS_CHANGED = "statusChanged";
cm.IncomingAttackEvent.ARRIVAL_TIME_CHANGED = "arrivalTimeChanged";
cm.IncomingAttackEvent.RECALL_DISSMISSED = "recallDismissed";
cm.IncomingAttackCompare = function (d, b) {
    var c = d.getArrivalTime() ? d.getArrivalTime() : Number.MAX_VALUE;
    var a = b.getArrivalTime() ? b.getArrivalTime() : Number.MAX_VALUE;
    return d.getArrivalTime() - b.getArrivalTime()
};
var cm = cm || {};
cm.IncomingAttackManager = new function () {
    var c;
    var a;
    var f = {};
    var e = {};
    var b;
    var d;
    this.add = function (i) {
        c.add(i, cm.IncomingAttackCompare);
        var g = i.getDestinationCityId().toString();
        var h;
        if (!f[g]) {
            h = new cm.BaseCollection();
            f[g] = h;
            e[g] = new cm.CityIncomingAttackController(h)
        }
        h = f[g];
        h.add(i, cm.IncomingAttackCompare)
    };
    this.remove = function (i) {
        c.remove(i);
        var g = i.getDestinationCityId().toString();
        if (f[g]) {
            var h = f[g];
            h.remove(i)
        }
    };
    this.getAttacksByCity = function (g) {
        return f[g.toString()]
    };
    this.getAllAttacks = function () {
        return c
    };
    this.getRecalledAttacks = function () {
        return b
    };
    this.recall = function (g) {
        if (!g || g.getMarchStatus() !== cm.MARCH_STATUS.MARCH_STATUS_ABORTING) {
            return
        }
        g.recall();
        b.add(g)
    };
    this.init = function () {
        c = new cm.BaseCollection();
        a = new cm.IncomingAttackController(c);
        b = new cm.BaseCollection();
        d = new cm.IncomingAttackRecalledController(b)
    }
}();
var cm = cm || {};
cm.IncomingAttackNotificationDialog = function (h) {
    cm.BaseDialog.call(this);
    var l = this;
    var c = this.getHtmlElement();
    var m = h;
    var i;
    var g;
    var f;
    var e;
    this.getLink = function () {
        return i
    };
    var a;
    var n = function () {
            var o = m.getArrivalTime();
            if (o) {
                g.innerHTML = cm.TimeFormatter.format(m.getArrivalTime() - unixtime())
            } else {
                g.innerHTML = ""
            }
        };
    var d = function (p) {
            var o = m.getMarchStatus();
            if (o == cm.MARCH_STATUS.MARCH_STATUS_INACTIVE || o == cm.MARCH_STATUS.MARCH_STATUS_ABORTING) {
                a()
            }
        };
    var b = function (o) {
            n()
        };
    var k = function (o) {
            a()
        };
    a = function () {
        Event.stopObserving(f, "click", k);
        m.removeEventListener(cm.IncomingAttackEvent.STATUS_CHANGED, d);
        m.removeEventListener(cm.IncomingAttackEvent.ARRIVAL_TIME_CHANGED, b);
        l.close()
    };
    var j = function () {
            m.addEventListener(cm.IncomingAttackEvent.STATUS_CHANGED, d);
            m.addEventListener(cm.IncomingAttackEvent.ARRIVAL_TIME_CHANGED, b);
            c.className = "announcementContainer incomingAttack";
            var r = document.createElement("div");
            r.className = "notificationDialog watchTower";
            c.appendChild(r);
            var s = document.createElement("div");
            s.className = "titleBar";
            r.appendChild(s);
            f = document.createElement("a");
            f.className = "closeButton";
            Event.observe(f, "click", k);
            s.appendChild(f);
            e = document.createElement("div");
            e.className = "count";
            s.appendChild(e);
            var q = document.createElement("div");
            q.className = "dialogTitle";
            q.innerHTML = g_js_strings.attack_generateincoming.impendingattack;
            s.appendChild(q);
            var t = document.createElement("div");
            t.className = "dialogBody";
            r.appendChild(t);
            i = document.createElement("a");
            i.href = "javascript:void(0)";
            var p = document.createTextNode(g_js_strings.attack_generateincoming.estimatedarrival + ": ");
            var o = m.getArrivalTime();
            if (!o) {
                p = document.createTextNode(g_js_strings.ImpendingAttacks.clickHere)
            }
            g = document.createElement("span");
            i.appendChild(p);
            i.appendChild(g);
            t.appendChild(i);
            n()
        };
    j()
};
cm.OOP.inherits(cm.IncomingAttackNotificationDialog, cm.BaseDialog);
cm.IncomingAttackDialogController = function (d, e) {
    var h;
    var b;
    var c;
    var a = function (l) {
            var i = cm.UserTileInfoFactory.getTileInfo(b.getDestinationCityId(), b.getDestinationTileId());
            var k = document.getElementById("citysel_" + (i.city.number + 1));
            citysel_click(k);
            var j = cm.WatchTowerList.getCityWatchTower(currentcityid);
            if (j) {
                modal_build(j.getSlot())
            }
        };
    var g = function (i) {
            h.removeEventListener(cm.DialogEvent.CLOSE, g);
            c.unbind("click", a)
        };
    var f = function () {
            b = d;
            h = e;
            h.addEventListener(cm.DialogEvent.CLOSE, g);
            c = jQuery(h.getLink());
            c.bind("click", a)
        };
    f()
};
cm.IncomingAttackTopNavNotification = function (i, k) {
    cm.CustomEventDispatcher.call(this);
    var j = this;
    var c;
    var g;
    var e;
    var f;
    var l;
    var b;
    var m = function () {
            var n = unixtime();
            if (!b) {
                b = unixtime()
            } else {
                if (n - b > 60) {
                    b = n;
                    g.src = g.src
                }
            }
        };
    var a = function (n) {
            m()
        };
    var d = function () {
            var n = l.getMarchStatus();
            if (n == cm.MARCH_STATUS.MARCH_STATUS_INACTIVE || n == cm.MARCH_STATUS.MARCH_STATUS_ABORTING) {
                j.remove()
            }
        };
    this.show = function () {
        e.appendChild(c);
        jQuery("#promoTimeLeft").hide()
    };
    this.remove = function () {
        try {
            e.removeChild(c);
            jQuery("#promoTimeLeft").show();
            var n = new cm.IncomingAttackTopNavNotificationEvent(cm.IncomingAttackTopNavNotificationEvent.REMOVED);
            n.setTarget(j);
            j.dispatchCustomEvent(n);
            l.removeEventListener(cm.IncomingAttackEvent.STATUS_CHANGED, d);
            l.removeEventListener(cm.IncomingAttackEvent.ARRIVAL_TIME_CHANGED, a)
        } catch (o) {}
    };
    this.getHtmlElement = function () {
        return c
    };
    var h = function () {
            e = k;
            l = i;
            c = document.createElement("a");
            g = document.createElement("img");
            g.src = stimgUrl + "img/nav/attack_arrow.gif";
            c.appendChild(g);
            var o = document.createElement("div");
            o.className = "textContainer";
            c.appendChild(o);
            var n = document.createElement("span");
            n.className = "impendingAttackText";
            n.innerHTML = g_js_strings.ImpendingAttacks.impengingAttackGoToCity;
            o.appendChild(n);
            m();
            l.addEventListener(cm.IncomingAttackEvent.STATUS_CHANGED, d);
            l.addEventListener(cm.IncomingAttackEvent.ARRIVAL_TIME_CHANGED, a)
        };
    h()
};
cm.OOP.inherits(cm.IncomingAttackTopNavNotification, cm.CustomEventDispatcher);
cm.IncomingAttackTopNavNotificationEvent = function (a) {
    cm.CustomEvent.call(this, a)
};
cm.OOP.inherits(cm.IncomingAttackTopNavNotificationEvent, cm.CustomEvent);
cm.IncomingAttackTopNavNotificationEvent.REMOVED = "removed";
cm.IncomingAttackTopNavNotificationController = function (g, e) {
    var h = this;
    var i;
    var c;
    var d;
    var b = function (m) {
            var j = cm.UserTileInfoFactory.getTileInfo(i.getDestinationCityId(), i.getDestinationTileId());
            var l = document.getElementById("citysel_" + (j.city.number + 1));
            citysel_click(l);
            var k = cm.WatchTowerList.getCityWatchTower(currentcityid);
            if (k) {
                modal_build(k.getSlot())
            }
        };
    var a = function (j) {
            d.unbind("click", _onNotificationClicked);
            c.removeEventListener(cm.IncomingAttackTopNavNotificationEvent.REMOVED, _onNotificationRemoved)
        };
    var f = function () {
            c = e;
            i = g;
            d = jQuery(c.getHtmlElement());
            d.bind("click", b);
            c.addEventListener(cm.IncomingAttackTopNavNotificationEvent.REMOVED, a)
        };
    f()
};
var cm = cm || {};
cm.IncomingAttackRecalledDialog = function (e) {
    cm.BaseDialog.call(this);
    var i = this;
    var b = this.getHtmlElement();
    var j = e;
    var f;
    var d;
    var c;
    this.getLink = function () {
        return f
    };
    var a = function () {
            e.removeEventListener(cm.IncomingAttackEvent.RECALL_DISSMISSED, k);
            i.close()
        };
    var k = function (l) {
            a()
        };
    var h = function (l) {
            a()
        };
    var g = function () {
            b.className = "announcementContainer";
            var t = document.createElement("div");
            t.className = "notificationDialog watchTower recalled";
            b.appendChild(t);
            var r = document.createElement("div");
            r.className = "titleBar";
            t.appendChild(r);
            var n = document.createElement("a");
            n.className = "closeButton";
            r.appendChild(n);
            c = document.createElement("div");
            c.className = "count";
            r.appendChild(c);
            var l = document.createElement("div");
            l.className = "dialogTitle";
            l.innerHTML = g_js_strings.incomingattack.attackrecalled;
            r.appendChild(l);
            var q = document.createElement("div");
            q.className = "dialogBody";
            t.appendChild(q);
            var p = e.getPlayerId();
            var s = g_js_strings.incomingattack.unknown;
            if (p) {
                var m = j.getAttacker();
                s = m.name
            }
            f = document.createElement("a");
            f.href = "javascript:void(0)";
            var o = g_js_strings.incomingattack.attackfromattackerrecalled.replace("%1$s", s);
            f.innerHTML = cm.StringFormatter.ellipsis(o, 34);
            f.setAttribute("title", o);
            q.appendChild(f);
            e.addEventListener(cm.IncomingAttackEvent.RECALL_DISSMISSED, k);
            Event.observe(n, "click", h)
        };
    g()
};
cm.OOP.inherits(cm.IncomingAttackRecalledDialog, cm.BaseDialog);
var cm = cm || {};
cm.intelligentOrdering = function () {
    var d = [],
        a = [],
        e = [];
    e[1] = 60;
    e[2] = 900;
    e[3] = 3600;
    e[4] = 3600 * 2.5;
    e[5] = 3600 * 8;
    e[6] = 3600 * 15;
    e[7] = 3600 * 24;
    e[8] = 3600 * 60;
    e[10] = 3600 * 96;
    var g = e.clone().reverse();

    function b(k) {
        var j = e.length;
        for (var i = 1; i < j; i++) {
            if (e[i] >= k) {
                return "i" + i
            }
        }
        return "i" + (j - 1)
    }

    function h(k, m, j, l) {
        var i = l ? e : g;
        return i.reduce(function (p, o, n) {
            var r = l ? "i" + n : "i" + (e.length - 1 - n);
            var q = parseInt(o) > m;
            if (c(d, r) && k != r && !c(p, r) && ((j && q) || (!j && !q))) {
                return p.concat(r)
            } else {
                return p
            }
        }, [])
    }

    function c(j, k) {
        for (var i in j) {
            if (j.hasOwnProperty(i)) {
                if (i == k) {
                    return true
                }
            }
        }
        return false
    }

    function f(j) {
        for (var i in j) {
            if (parseInt(j[i]) == 0) {
                delete j[i]
            }
        }
        return j
    }
    return {
        getReduceTime: function (j) {
            return e[j]
        },
        get: function (k, i) {
            d = f(k);
            var j = b(i);
            return [j].concat(h(j, i, true, true), h(j, i, false, false))
        },
        test: function () {
            var i = [];
            i[0] = {
                i1: 23,
                i3: 178,
                i6: 2000,
                i9: 100
            };
            i[1] = {
                i3: 23,
                i4: 178,
                i8: 2000
            };
            i[2] = {
                i1: 23,
                i2: 178,
                i3: 2000,
                i4: 178,
                i5: 2000,
                i6: 178,
                i7: 2000,
                i8: 2000,
                i9: 200,
                i10: 2000
            };
            i[3] = {
                i2: 384,
                i4: 178,
                i7: 2000,
                i10: 203
            };
            i[4] = {
                i3: 253
            };
            i[5] = {
                i3: 423
            };
            cm.test.go("cm.intelligentOrdering", this.get(i[0], 1000).join(","), "i3,i6,i1");
            cm.test.go("cm.intelligentOrdering", this.get(i[0], 30).join(","), "i1,i3,i6");
            cm.test.go("cm.intelligentOrdering", this.get(i[0], 7200).join(","), "i4,i6,i3,i1");
            cm.test.go("cm.intelligentOrdering", this.get(i[1], 7280).join(","), "i4,i8,i3");
            cm.test.go("cm.intelligentOrdering", this.get(i[1], 5557280).join(","), "i10,i8,i4,i3");
            cm.test.go("cm.intelligentOrdering", this.get(i[2], 8540000).join(","), "i10,i8,i7,i6,i5,i4,i3,i2,i1");
            cm.test.go("cm.intelligentOrdering", this.get(i[2], 34).join(","), "i1,i2,i3,i4,i5,i6,i7,i8,i10");
            cm.test.go("cm.intelligentOrdering", this.get(i[2], 888).join(","), "i2,i3,i4,i5,i6,i7,i8,i10,i1");
            cm.test.go("cm.intelligentOrdering", this.get(i[3], 32888).join(","), "i6,i7,i10,i4,i2");
            cm.test.go("cm.intelligentOrdering", this.get(i[4], 1000).join(","), "i3");
            cm.test.go("cm.intelligentOrdering", this.get(i[5], 1000).join(","), "i3")
        }
    }
}();
cm.speedUpModalTimer = function (d) {
    var c, b = [],
        a;
    return {
        update: function (f, g, e) {
            if (f == c) {
                d(".speedUpModalTimeLeft").html(timestr(e))
            }
            b[f] = e;
            if (g == "1s" || e <= 1) {
                cm.speedUpModalTimer.endSpeedUpModal(f)
            }
        },
        endSpeedUpModal: function (e) {
            if ((e == c) && d("#modal_speedup").length > 0) {
                Modal.hideModal()
            }
            if (e == "bdg" && cm.guardianModalModel.upgrading()) {
                cm.ModalManager.close();
                cm.guardianModalModel.setUpgrade(false);
                cm.guardianModalModel.increaseLevel();
                cm.guardianCity.rerender(true)
            }
        },
        open: function (e) {
            c = e
        },
        removeType: function (e) {
            this.endSpeedUpModal(e);
            delete b[e]
        },
        getTimeLeft: function (e) {
            if (undefined === b[e]) {
                return 0
            }
            return b[e]
        },
        getCurrentModalTimeLeft: function () {
            return this.getTimeLeft(c)
        },
        redisplayModal: function (e) {
            if ((e && d("#modal_speedup").length > 0) || !e) {
                modal_speedup(a.type, a.typeid, a.slotid, a.subjectCurrentlyBuilding)
            }
        },
        saveLastSpeedUpModal: function (e) {
            a = e
        },
        goToSpeedups: function () {
            cm.ShopView.openShop(2)
        }
    }
}(jQuery);
cm = cm || {};
cm.InventoryView = function (t) {
    var G = [],
        F = [],
        E = [],
        D = [],
        C = [],
        B = [],
        A, j, x = 9;
    var n = function (O) {
            O = O || 1;
            j = 1;
            var M = g_js_strings.changeview_court_content.myitems;
            var N;
            if (cm.WorldSettings.hasKeyValuePair("MIGRATION1", "true")) {
                N = g_js_strings.modal_shop_buy_banner.banner_exclusiveitemsonkabam;
                var L;
                if (seed.platform.type == "facebook") {
                    L = "<div class='msg'><a href='" + seed.platform.url + "' target='_top'>" + N + "</a></div>"
                } else {
                    L = "<div class='msg'>" + N + "</div>"
                }
                var K = "new"
            } else {
                N = g_js_strings.modal_shop_buy_banner.banner_feycitycomingsoon;
                var L = "<div class='msg'>" + N + "</div>",
                    K = "old"
            }
            Modal.showModal(740, 400, 10, 10, M, cm.Template.renderTemplate("Inventory", "inventoryModal", {
                gemsString: g_js_strings.commonstr.gems,
                getmoregemsString: g_js_strings.modaltitles.getmoregems,
                getmoreitemsString: g_js_strings.modal_myitems.getmoreitems,
                generalString: g_js_strings.commonstr.general,
                speedupString: g_js_strings.commonstr.speedup,
                combatString: g_js_strings.commonstr.combat,
                resourcesString: g_js_strings.commonstr.resources,
                chestString: g_js_strings.commonstr.chest,
                courtString: g_js_strings.commonstr.court
            }));
            t("#inventoryGemQuantity").text(seed.player.gems);
            t("#inventoryBanner").html(L);
            t("#inventoryBanner").addClass(K);
            a();
            g(O)
        };
    var a = function () {
            var K;
            G = [];
            F = [];
            E = [];
            D = [];
            C = [];
            B = [];
            t.each(ksoItems, function (L, M) {
                if (![1062, 598].include(M.id)) {
                    if (M && M.count > 0) {
                        switch (M.category) {
                        case 1:
                            G.push(M);
                            break;
                        case 2:
                            F.push(M);
                            break;
                        case 3:
                            E.push(M);
                            break;
                        case 4:
                            D.push(M);
                            break;
                        case 5:
                            C.push(M);
                            break;
                        case 6:
                            B.push(M);
                            break;
                        default:
                            G.push(M);
                            break
                        }
                    }
                }
            })
        };
    var g = function (K) {
            j = 1;
            t("div#inventoryMessage").hide();
            t("li#inventoryTab" + A).removeClass("selected");
            A = Number(K);
            t("li#inventoryTab" + A).addClass("selected");
            a();
            b()
        };
    var b = function () {
            var K, L, P, Q;
            switch (A) {
            case 1:
                K = G;
                break;
            case 2:
                K = F;
                break;
            case 3:
                K = E;
                break;
            case 4:
                K = D;
                break;
            case 5:
                K = C;
                break;
            case 6:
                K = B;
                break;
            default:
                K = G;
                break
            }
            q(K.length);
            w(K.length);
            if (j < 0) {
                j = 1
            }
            L = (j - 1) * x;
            P = j * x;
            K = K.slice(L, P);
            t("#inventoryItemsContainerList").empty();
            if (K.length > 0) {
                t.each(K, function (S, T) {
                    var U = "",
                        R = "";
                    if (T.usable) {
                        U = g_js_strings.commonstr.use
                    } else {
                        if (T.equippable) {
                            if (T.isEquipped) {
                                U = g_js_strings.commonstr.unequip
                            } else {
                                U = g_js_strings.commonstr.equip
                            }
                        }
                    }
                    if (U !== "") {
                        R = cm.Template.renderTemplate("Inventory", "itemButton", {
                            id: T.id,
                            actionString: U
                        })
                    }
                    Q = stimgUrl + "img/items/70/" + T.id + ".jpg";
                    t(cm.Template.renderTemplate("Inventory", "itemContainer", t.extend({
                        actionbutton: R,
                        ownedString: g_js_strings.commonstr.owned,
                        imageSource: Q
                    }, T))).appendTo("#inventoryItemsContainerList")
                })
            } else {
                var O = "",
                    M = "";
                switch (A) {
                case 1:
                    O = g_js_strings.modal_myitems.ownnogeneral;
                    M = "Modal.hideModal(); cm.ShopView.openShop(1); return false;";
                    break;
                case 2:
                    O = g_js_strings.modal_myitems.ownnospeedup;
                    M = "Modal.hideModal(); cm.ShopView.openShop(2); return false;";
                    break;
                case 3:
                    O = g_js_strings.modal_myitems.ownnoattack;
                    M = "Modal.hideModal(); cm.ShopView.openShop(3); return false;";
                    break;
                case 4:
                    O = g_js_strings.modal_myitems.ownnoprod;
                    M = "Modal.hideModal(); cm.ShopView.openShop(4); return false;";
                    break;
                case 5:
                    O = g_js_strings.modal_myitems.ownnochest;
                    M = "Modal.hideModal(); cm.ShopView.openShop(5); return false;";
                    break;
                case 6:
                    O = g_js_strings.modal_myitems.ownnocourt;
                    M = "Modal.hideModal(); cm.ShopView.openShop(6); return false;";
                    break;
                default:
                    O = g_js_strings.modal_myitems.ownnogeneral;
                    M = "Modal.hideModal(); cm.ShopView.openShop(1); return false;";
                    break
                }
                var N = "<li><div id='emptyInventory'><p>" + O + "</p><div class='buttonCotainer'><a class='button20' onclick='" + M + "'><span>" + g_js_strings.commonstr.buymore + "</span></a></div></div></li>";
                t(N).appendTo("#inventoryItemsContainerList")
            }
        };
    var w = function (O) {
            var M = Math.ceil(O / x),
                L = [],
                N = [];
            if (M != 1) {
                for (var K = 1; K <= M; ++K) {
                    N.push("<li class='page'>");
                    if (K == j) {
                        N.push("<span class='current'>" + K + "</span>")
                    } else {
                        N.push("<span onclick='cm.InventoryView.goToPage(" + K + ");'>" + K + "</span>")
                    }
                    N.push("</li>")
                }
                if (t("#inventoryPaginationList").length != 0) {
                    t("#inventoryPaginationList").empty();
                    t("#inventoryPaginationList").append(N.join(""))
                } else {
                    L.push("<ul id='inventoryPaginationList'>");
                    L.push(N.join(""));
                    L.push("</ul>");
                    t("#inventoryBanner").append(L.join(""))
                }
            } else {
                t("#inventoryPaginationList").remove()
            }
        };
    var q = function (M) {
            var L = Math.ceil(M / x),
                K = t("a#inventoryPrevPageButton"),
                N = t("a#inventoryNextPageButton").hide();
            if (L > 1) {
                if (j > 1) {
                    if ((j < L) && (j > 1)) {
                        K.show();
                        N.show()
                    } else {
                        if (j == L) {
                            K.show();
                            N.hide()
                        } else {
                            K.hide();
                            N.show()
                        }
                    }
                } else {
                    K.hide();
                    N.show()
                }
            } else {
                K.hide();
                N.hide()
            }
        };
    var f = function () {
            ++j;
            b();
            a();
            b()
        };
    var J = function () {
            --j;
            a();
            b()
        };
    var k = function (K) {
            j = K;
            a();
            b()
        };
    var i = function (L, K) {
            showTooltip(L.getAttribute("name"), L, K, "inventoryItemsContainer")
        };
    var r = function (N) {
            seed.items["i" + N] = Number(seed.items["i" + N]) - 1;
            ksoItems[N].subtract();
            var L = seed.items["i" + N],
                M = ksoItems[N].count;
            if (L === 0 && M === 0) {
                t("#item" + N).remove()
            } else {
                t("#item" + N + "Count").text(seed.items["i" + N].toString());
                t("#item" + N + "Count").text(ksoItems[N].count.toString())
            }
            if (t(".item").length === 0) {
                J()
            } else {
                a();
                b()
            }
            var K = g_js_strings.modal_myitems_use.uused.replace("%1$s", itemlist["i" + N].name);
            t("#inventoryMessage").text(K);
            t("#inventoryMessage").show();
            if (t("#tooltip")) {
                t("#tooltip").remove()
            }
        };
    var z = function (K) {
            if (ksoItems[K].isEquipped) {
                t("span#item" + K + "ButtonText").text(g_js_strings.commonstr.unequip)
            } else {
                t("span#item" + K + "ButtonText").text(g_js_strings.commonstr.equip)
            }
        };
    var y = function (K, L) {
            var M = itemlist["i" + L].name || ksoItems[L].name;
            Modal.showModal(500, 500, 10, 10, M, cm.Template.renderTemplate("Inventory", "itemsInChestModal", {
                itemsGainedString: g_js_strings.modal_chest_itemusage.itemsgained,
                okString: g_js_strings.commonstr.ok
            }));
            e(K)
        };
    var e = function (K) {
            t(cm.Template.renderTemplate("Inventory", "itemsInChestContainer", K)).appendTo("#itemsInChestContainerList")
        };
    var H = function (N) {
            var L, K = [];
            var M = itemlist["i" + N].name || ksoItems[N];
            Modal.showModal(500, 500, 10, 10, M, cm.Template.renderTemplate("Inventory", "portalOfRefugeModal", {
                currentProvString: g_js_strings.modal_myitems_use_teleportprovince.yourcurrentprov,
                newProvString: g_js_strings.modal_myitems_use_teleportprovince.newprov,
                submitString: g_js_strings.commonstr.submit,
                cancelString: g_js_strings.commonstr.cancel
            }));
            t.each(provincenames, function (O, P) {
                L = {};
                L.value = O.split("p")[1];
                L.name = P;
                K.push(L)
            });
            t(cm.Template.renderTemplate("Inventory", "provinceNameContainer", K)).appendTo("#provinceNamesList");
            t("span#currentProvinceName").text(provincenames["p" + currentcityinfo[4]])
        };
    var l = function (N, K, O) {
            var L = g_js_strings.modal_myitems_use_teleportprovince_do.aused.replace("%1$s", itemlist["i" + N].name),
                M = g_js_strings.modal_myitems_use_teleportprovince_do.teleportto + ": " + K + "," + O;
            title = itemlist["i" + N].name || ksoItems[N];
            Modal.showModal(500, 500, 10, 10, title, cm.Template.renderTemplate("Inventory", "portalConfirmModal", {
                okString: g_js_strings.commonstr.ok
            }));
            t("#portalItemNameContainer").text(L);
            t("#teleportCoordinateContainer").text(M);
            if (N == 912 || N == 911) {
                t("#portalConfirmOKButton").attr("onclick", "");
                t("#portalConfirmOKButton").click(function () {
                    top.location = appUrl
                })
            }
        };
    var v = function (N) {
            var M = itemlist["i" + N].name || ksoItems[N],
                K = currentcityinfo[2],
                L = currentcityinfo[3];
            Modal.showModal(500, 500, 10, 10, M, cm.Template.renderTemplate("Inventory", "portalOfOrderModal", {
                currentCoordString: g_js_strings.modal_myitems_use_teleport.currentcoor,
                newCoordString: g_js_strings.modal_myitems_use_teleport.newcoor,
                submitString: g_js_strings.commonstr.submit,
                cancelString: g_js_strings.commonstr.cancel
            }));
            t("#xCoordinate").text(K);
            t("#yCoordinate").text(L)
        };
    var h = function () {
            var L = g_js_strings.modaltitles.renamecelebration,
                M;
            Modal.showModal(500, 500, 10, 10, L, cm.Template.renderTemplate("Inventory", "renamingCelebrationModal", {
                currentCityString: g_js_strings.modal_rename_celebration.currentcity,
                newCityNameString: g_js_strings.modal_rename_celebration.newcityname,
                submitString: g_js_strings.commonstr.submit,
                cancelString: g_js_strings.commonstr.cancel
            }));
            for (var K = 0; K < seed.cities.length; K++) {
                if (Number(seed.cities[K][0]) == Number(currentcityid)) {
                    M = seed.cities[K][1];
                    break
                }
            }
            t("#currentCityName").text(M)
        };
    var c = function (K, L) {
            var M = g_js_strings.modal_rename_celebration.newcityname;
            Modal.showModal(500, 500, 10, 10, M, cm.Template.renderTemplate("Inventory", "renamingCelebrationConfirmModal", {
                newCityNameString: g_js_strings.modal_rename_celebration.newcityname,
                okString: g_js_strings.commonstr.ok
            }));
            t("#confirmMessage").text(K);
            t("#newCityName").text(L);
            t("#renamingCelebrationConfirmOKButton").click(function () {
                top.location = appUrl
            })
        };
    var d = function () {};
    var u = function () {
            var K = g_js_strings.modaltitles.magiccloak;
            Modal.showModal(500, 500, 10, 10, K, cm.Template.renderTemplate("Inventory", "merlinsCloakModal", {
                yourCurrentNameString: g_js_strings.modal_get_cloak_name.yourcurrentname,
                newNameString: g_js_strings.modal_get_cloak_name.newname,
                submitString: g_js_strings.commonstr.submit,
                cancelString: g_js_strings.commonstr.cancel
            }));
            t("#newNamePrefix").text(seed.player.prefix);
            t("#merlinsCloakCurrentName").text(seed.player.prefix + " " + seed.player.name)
        };
    var I = function (N) {
            var M = itemlist["i" + 924].name,
                K = currentcityinfo[2],
                L = currentcityinfo[3];
            Modal.showModal(500, 500, 10, 10, M, cm.Template.renderTemplate("Inventory", "merlinsEscapeModal", {
                yourCurrentNameString: g_js_strings.modal_get_cloak_name.yourcurrentname,
                newNameString: g_js_strings.modal_get_cloak_name.newname,
                currentCoordString: g_js_strings.modal_myitems_use_teleport.currentcoor,
                newCoordString: g_js_strings.modal_myitems_use_escape.newcoor,
                submitString: g_js_strings.commonstr.submit,
                cancelString: g_js_strings.commonstr.cancel
            }));
            t("#merlinsCloakCurrentName").text(seed.player.prefix + " " + seed.player.name);
            t("#newNamePrefix").text(seed.player.prefix);
            t("#xCoordinate").text(K);
            t("#yCoordinate").text(L)
        };
    var m = function (P, L, Q) {
            var O = itemlist["i" + P].name || ksoItems[P].name,
                N, M, K;
            N = g_js_strings.modal_myitems_use_escape_do.aused.replace("%1$s", itemlist["i" + P].name);
            M = g_js_strings.modal_myitems_use_escape_do.namechangedto + " " + seed.player.prefix + " " + seed.player.name;
            K = g_js_strings.modal_myitems_use_escape_do.teleportto + " " + L + "," + Q;
            Modal.showModal(500, 500, 10, 10, O, cm.Template.renderTemplate("Inventory", "merlinsEscapeConfirmModal", {
                okString: g_js_strings.commonstr.ok
            }));
            t("#itemUsedContainer").text(N);
            t("#nameChangedContainer").text(M);
            t("#teleportedToContainer").text(K);
            t("#merlinsEscapeConfirmButton").click(function () {
                top.location = appUrl
            })
        };
    var p = function () {
            var K = g_js_strings.modaltitles.notice;
            Modal.showModal(400, 400, 150, 150, K, cm.Template.renderTemplate("Inventory", "potionOfMistModal", {
                mistWarningString: g_js_strings.modal_myitems_confirm_potion_mist.mistwarning,
                useMistsString: g_js_strings.modal_myitems_confirm_potion_mist.usemists,
                cancelString: g_js_strings.commonstr.cancel
            }))
        };
    var s = function (M) {
            var L = g_js_strings.modaltitles.notice,
                K = (M == 902) ? g_js_strings.vacationMode.modal_myitems_confirm_vacation3_msg : g_js_strings.vacationMode.modal_myitems_confirm_vacation7_msg;
            Modal.showModal(400, 400, 150, 150, L, cm.Template.renderTemplate("Inventory", "vacationModeModal", {
                itemId: (+M === 902) ? 902 : 903,
                useVacationString: g_js_strings.modal_myitems_confirm_potion_mist.usevacation,
                cancelString: g_js_strings.commonstr.cancel
            }));
            t("#vacationModeWarning").text(g_js_strings.modal_myitems_warning);
            t("#vacationModeMessage").text(K)
        };
    var o = function () {};
    o();
    return {
        showItemTooltip: i,
        openInventory: n,
        openTab: g,
        goNextPage: f,
        goPrevPage: J,
        goToPage: k,
        removeItemFromInventory: r,
        openItemsInChestModal: y,
        toggleCourtItem: z,
        openPortalOfRefugeModal: H,
        openPortalOfOrderModal: v,
        openPortalConfirmModal: l,
        openMerlinsCloakModal: u,
        openMerlinsEscapeModal: I,
        openMerlinsEscapeConfirmModal: m,
        openRenamingCelebrationModal: h,
        openRenamingCelebrationConfirmModal: c,
        openRenamingRitualModal: d,
        openVacationModeModal: s,
        openPotionOfMistModal: p,
        removeItemFromInventory: r
    }
}(jQuery);
var cm = cm || {};
cm.InviteTypes = {
    INVITE_TYPE_GENERAL: 1,
    INVITE_TYPE_FAST_BUILDER: 2,
    INVITE_TYPE_GIFTING: 3,
    INVITE_TYPE_TELLFRIENDS: 10,
    INVITE_TYPE_GIFT: 5,
    INVITE_TYPE_APPOINTKNIGHT: 6,
    INVITE_TYPE_NEWSLETTER: 8,
    INVITE_TYPE_DAILY_GIFT: 9,
    INVITE_TYPE_SUGGEST_INVITE: 13,
    INVITE_TYPE_CASTLE_LV_2: 14,
    INVITE_TYPE_VIRALUEP_0: 15,
    INVITE_TYPE_VIRALUEP_1: 16,
    INVITE_TYPE_WELCOME: 17,
    INVITE_TYPE_TUTORIAL: 18,
    INVITE_TYPE_SKIP: 19
};
var cm = function (b, d) {
        var e = b.invite = b.invite || {};
        var c = false;
        var a;
        d(document).ready(function () {
            d(".invite_friends").live("click", e.open);
            a = g_popInviteType ? g_popInviteType : cm.InviteTypes.INVITE_TYPE_GENERAL
        });
        e.open = function () {
            d("#invitePopup").show();
            c = true
        };
        e.close = function () {
            d("#invitePopup").hide();
            c = false
        };
        e.load = function (g, f) {
            if (a !== g || f) {
                a = g;
                cm.IframeUtil.post("invitePopup", g_baseInviteIframeURL + "&type=" + g)
            }
        };
        e.isShowing = function () {
            return c
        };
        return b
    }(cm, jQuery);
cm = cm || {};
cm.ItemController = function ($) {
    var init_ = function () {};
    var use = function (itemId) {
            itemId = Number(itemId);
            if ([101, 102, 111, 112, 121, 122, 131, 132, 141, 142].include(itemId)) {
                useProductionBoost(itemId)
            } else {
                if ([261, 262, 271, 272, 276, 277, 278, 279, 280, 281, 282, 283, 285, 286].include(itemId)) {
                    useCombatBoost(itemId)
                } else {
                    if ((itemId >= 273 && itemId <= 275) || itemId == 284) {
                        useTroopUpkeepBoost(itemId)
                    } else {
                        if ([501, 502, 503, 504, 505, 531, 10038].include(itemId)) {
                            useMultiItemChest(itemId)
                        } else {
                            if ([511, 512, 513, 514].include(itemId)) {
                                useKnightInABox(itemId)
                            } else {
                                if ([521, 522, 523, 524].include(itemId) || (itemId >= 1300 && itemId <= 1477)) {
                                    useUnitsItem(itemId)
                                } else {
                                    if (itemId > 700 && itemId < 900) {
                                        useCourtItem(itemId)
                                    } else {
                                        if (itemId > 1000 && itemId < 1050) {
                                            useResourceItem(itemId)
                                        } else {
                                            if (itemId == 10028) {
                                                useMysteryChest(itemId)
                                            } else {
                                                if (itemId == 10029 || (itemId >= 10043 && itemId <= 10131)) {
                                                    cm.chestItemUsage.open(itemId)
                                                } else {
                                                    if ((itemId >= 10000 && itemId <= 10020) || (itemId >= 10022 && itemId <= 10027) || (itemId >= 10030 && itemId <= 10037) || [942, 10132, 10133].include(itemId)) {
                                                        useItemChest(itemId)
                                                    } else {
                                                        switch (itemId) {
                                                        case 351:
                                                            useFertileWinds(itemId);
                                                            break;
                                                        case 355:
                                                            useMassHypnosis(itemId);
                                                            break;
                                                        case 599:
                                                            cm.mww.modal_mmb();
                                                            break;
                                                        case 901:
                                                            useDoveOfPeace(itemId);
                                                            break;
                                                        case 902:
                                                            cm.InventoryView.openVacationModeModal(itemId);
                                                            break;
                                                        case 903:
                                                            cm.InventoryView.openVacationModeModal(itemId);
                                                            break;
                                                        case 911:
                                                            cm.InventoryView.openPortalOfRefugeModal(itemId);
                                                            break;
                                                        case 912:
                                                            cm.InventoryView.openPortalOfOrderModal(itemId);
                                                            break;
                                                        case 922:
                                                            cm.InventoryView.openMerlinsCloakModal(itemId);
                                                            break;
                                                        case 923:
                                                            cm.InventoryView.openRenamingCelebrationModal(itemId);
                                                            break;
                                                        case 924:
                                                            cm.InventoryView.openMerlinsEscapeModal(itemId);
                                                            break;
                                                        case 2000:
                                                            cm.item.use(2000);
                                                            break;
                                                        case 10021:
                                                            cm.InventoryView.openPotionOfMistModal(itemId);
                                                            break
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        };
    var useProductionBoost = function (iid) {
            var params = Object.clone(g_ajaxparams);
            params.iid = iid;
            params.cid = currentcityid;
            new Ajax.Request(g_ajaxpath + "ajax/boostProduction.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        if (rslt.updateSeed) {
                            update_seed(rslt.updateSeed)
                        }
                        if (seed.playerEffects.length == 0) {
                            seed.playerEffects = new Object
                        }
                        var ut = unixtime();
                        var bst = 86400;
                        if (iid == 101 || iid == 102) {
                            if (!(parseInt(seed.playerEffects.r0BstExp) > ut)) {
                                seed.playerEffects.r0BstExp = ut
                            }
                            if (iid == 102) {
                                bst = 604800
                            }
                            seed.playerEffects.r0BstExp = parseInt(seed.playerEffects.r0BstExp) + bst
                        }
                        if (iid == 111 || iid == 112) {
                            if (!(parseInt(seed.playerEffects.r1BstExp) > ut)) {
                                seed.playerEffects.r1BstExp = ut
                            }
                            if (iid == 112) {
                                bst = 604800
                            }
                            seed.playerEffects.r1BstExp = parseInt(seed.playerEffects.r1BstExp) + bst
                        }
                        if (iid == 121 || iid == 122) {
                            if (!(parseInt(seed.playerEffects.r2BstExp) > ut)) {
                                seed.playerEffects.r2BstExp = ut
                            }
                            if (iid == 122) {
                                bst = 604800
                            }
                            seed.playerEffects.r2BstExp = parseInt(seed.playerEffects.r2BstExp) + bst
                        }
                        if (iid == 131 || iid == 132) {
                            if (!(parseInt(seed.playerEffects.r3BstExp) > ut)) {
                                seed.playerEffects.r3BstExp = ut
                            }
                            if (iid == 132) {
                                bst = 604800
                            }
                            seed.playerEffects.r3BstExp = parseInt(seed.playerEffects.r3BstExp) + bst
                        }
                        if (iid == 141 || iid == 142) {
                            if (!(parseInt(seed.playerEffects.r4BstExp) > ut)) {
                                seed.playerEffects.r4BstExp = ut
                            }
                            if (iid == 142) {
                                bst = 604800
                            }
                            seed.playerEffects.r4BstExp = parseInt(seed.playerEffects.r4BstExp) + bst
                        }
                        cm.InventoryView.removeItemFromInventory(iid);
                        update_boosts()
                    }
                },
                onFailure: function () {}
            })
        };
    var useCombatBoost = function (iid) {
            var params = Object.clone(g_ajaxparams);
            params.iid = iid;
            params.cid = currentcityid;
            new Ajax.Request(g_ajaxpath + "ajax/boostCombat.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        if (rslt.updateSeed) {
                            update_seed(rslt.updateSeed)
                        }
                        if (seed.playerEffects.length == 0) {
                            seed.playerEffects = new Object
                        }
                        var ut = unixtime();
                        var bst = 86400;
                        var hours4 = 60 * 60 * 4;
                        if (iid == 261 || iid == 262) {
                            if (!(parseInt(seed.playerEffects.atkExpire) > ut)) {
                                seed.playerEffects.atkExpire = ut
                            }
                            if (iid == 262) {
                                bst = 604800
                            }
                            seed.playerEffects.atkExpire = parseInt(seed.playerEffects.atkExpire) + bst
                        } else {
                            if (iid == 271 || iid == 272) {
                                if (!(parseInt(seed.playerEffects.defExpire) > ut)) {
                                    seed.playerEffects.defExpire = ut
                                }
                                if (iid == 272) {
                                    bst = 604800
                                }
                                seed.playerEffects.defExpire = parseInt(seed.playerEffects.defExpire) + bst
                            } else {
                                if (iid == 280) {
                                    if (!(parseInt(seed.playerEffects.atk2Expire) > ut)) {
                                        seed.playerEffects.atk2Expire = ut
                                    }
                                    seed.playerEffects.atk2Expire = parseInt(seed.playerEffects.atk2Expire) + hours4;
                                    if (seed.playerEffects.atkExpire && parseInt(seed.playerEffects.atkExpire) > ut) {
                                        seed.playerEffects.atkExpire = parseInt(seed.playerEffects.atkExpire) + hours4
                                    }
                                }
                            }
                        }
                        if (iid == 281) {
                            if (!(parseInt(seed.playerEffects.def2Expire) > ut)) {
                                seed.playerEffects.def2Expire = ut
                            }
                            seed.playerEffects.def2Expire = parseInt(seed.playerEffects.def2Expire) + hours4;
                            if (seed.playerEffects.defExpire && parseInt(seed.playerEffects.defExpire) > ut) {
                                seed.playerEffects.defExpire = parseInt(seed.playerEffects.defExpire) + hours4
                            }
                        } else {
                            if (iid >= 276 && iid <= 278) {
                                bst = 3600 * Math.pow(2, (iid - 276));
                                if (!(parseInt(seed.playerEffects.loadExpire) > ut)) {
                                    seed.playerEffects.loadExpire = ut
                                }
                                seed.playerEffects.loadExpire = parseInt(seed.playerEffects.loadExpire) + bst
                            } else {
                                if (iid == 279) {
                                    bst = 3600;
                                    if (!(parseInt(seed.playerEffects.returnExpire) > ut)) {
                                        seed.playerEffects.returnExpire = ut
                                    }
                                    seed.playerEffects.returnExpire = parseInt(seed.playerEffects.returnExpire) + bst
                                } else {
                                    if (iid == 282 || iid == 283) {
                                        var expireTime;
                                        bst = (iid == 282) ? 86400 : 604800;
                                        if (seed.playerEffects.lifeExpire) {
                                            expireTime = Number(seed.playerEffects.lifeExpire);
                                            if (expireTime < unixtime()) {
                                                seed.playerEffects.lifeExpire = unixtime() + bst
                                            } else {
                                                seed.playerEffects.lifeExpire = expireTime + bst
                                            }
                                        } else {
                                            seed.playerEffects.lifeExpire = unixtime() + bst
                                        }
                                    } else {
                                        if (iid == 285) {
                                            var baseTime = 3600;
                                            if (!(parseInt(seed.playerEffects.aurasExpire) > ut)) {
                                                seed.playerEffects.aurasExpire = ut
                                            }
                                            seed.playerEffects.aurasExpire = parseInt(seed.playerEffects.aurasExpire) + baseTime
                                        } else {
                                            if (iid == 286) {
                                                var baseTime = 3600;
                                                if (!(parseInt(seed.playerEffects.auras2Expire) > ut)) {
                                                    seed.playerEffects.auras2Expire = ut
                                                }
                                                seed.playerEffects.auras2Expire = parseInt(seed.playerEffects.auras2Expire) + baseTime;
                                                if (seed.playerEffects.aurasExpire && parseInt(seed.playerEffects.aurasExpire) > ut) {
                                                    seed.playerEffects.aurasExpire = parseInt(seed.playerEffects.aurasExpire) + baseTime
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        cm.InventoryView.removeItemFromInventory(iid);
                        update_boosts()
                    }
                },
                onFailure: function () {}
            })
        };
    var useTroopUpkeepBoost = function (itemId) {
            var boostTime, params = Object.clone(g_ajaxparams);
            params.iid = itemId;
            new Ajax.Request(g_ajaxpath + "ajax/reduceTroopUpkeep.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        if (rslt.updateSeed) {
                            update_seed(rslt.updateSeed)
                        }
                        if (seed.playerEffects.length == 0) {
                            seed.playerEffects = new Object
                        }
                        if (itemId == 273) {
                            boostTime = 28800
                        } else {
                            if (itemId == 274) {
                                boostTime = 86400
                            } else {
                                if (itemId == 275) {
                                    boostTime = 259200
                                } else {
                                    if (itemId == 284) {
                                        boostTime = 604800
                                    }
                                }
                            }
                        }
                        if (!(Number(seed.playerEffects.troopUpkeepReductExp) > unixtime())) {
                            seed.playerEffects.troopUpkeepReductExp = unixtime()
                        }
                        if (seed.playerEffects.troopUpkeepReductExp) {
                            seed.playerEffects.troopUpkeepReductExp = Number(seed.playerEffects.troopUpkeepReductExp) + boostTime
                        } else {
                            seed.playerEffects.troopUpkeepReductExp = unixtime() + boostTime
                        }
                        cm.InventoryView.removeItemFromInventory(itemId);
                        update_boosts()
                    }
                },
                onFailure: function () {}
            })
        };
    var useMultiItemChest = function (iid) {
            var params = Object.clone(g_ajaxparams);
            params.itemId = iid;
            params.cid = currentcityid;
            new Ajax.Request(g_ajaxpath + "ajax/medals.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        cm.InventoryView.removeItemFromInventory(iid);
                        addItemsToInventory(rslt.medals, iid)
                    }
                }
            })
        };
    var useKnightInABox = function (itemId) {
            modal_get_knight(itemId)
        };
    var useUnitsItem = function (iid) {
            var params = Object.clone(g_ajaxparams);
            params.cid = currentcityid;
            params.iid = iid;
            new Ajax.Request(g_ajaxpath + "ajax/volunteee.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        if (rslt.updateSeed) {
                            update_seed(rslt.updateSeed)
                        }
                        var allUnitsGained = new Hash(rslt.unitsGained),
                            unitId, unitAmount;
                        allUnitsGained.each(function (pair) {
                            unitId = pair.key.substring(4);
                            unitAmount = pair.value;
                            seed.units["city" + currentcityid]["unt" + unitId] = Number(seed.units["city" + currentcityid]["unt" + unitId]) + unitAmount
                        });
                        cm.InventoryView.removeItemFromInventory(iid);
                        modal_volunteer_gain(rslt.unitsGained, iid)
                    }
                },
                onFailure: function () {}
            })
        };
    var useResourceItem = function (iid) {
            var params = Object.clone(g_ajaxparams);
            params.iid = iid;
            params.cid = currentcityid;
            new Ajax.Request(g_ajaxpath + "ajax/resourceCrate.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        if (rslt.updateSeed) {
                            update_seed(rslt.updateSeed)
                        }
                        if (Number(rslt.rtype) == 0) {
                            update_gold()
                        } else {}
                        cm.InventoryView.removeItemFromInventory(iid)
                    }
                },
                onFailure: function () {}
            })
        };
    var useItemChest = function (iid) {
            var items = {},
                item, params = Object.clone(g_ajaxparams);
            params.iid = iid;
            new Ajax.Request(g_ajaxpath + "ajax/itemChest.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        cm.InventoryView.removeItemFromInventory(iid);
                        var key;
                        $.each(rslt.items, function (key, value) {
                            key = key.split("i")[1];
                            items[key] = value
                        });
                        addItemsToInventory(items, iid)
                    }
                }
            })
        };
    var useMysteryChest = function (itemId) {
            var items = {},
                params = Object.clone(g_ajaxparams);
            params.chestId = itemId;
            params.cid = currentcityid;
            new Ajax.Request(g_ajaxpath + "ajax/useMysteryChest.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        cm.InventoryView.removeItemFromInventory(itemId);
                        addItemsToInventory(rslt.items, itemId)
                    }
                },
                onFailure: function () {}
            })
        };
    var addItemsToInventory = function (itemsReceived, itemId) {
            var originalItemId = itemId,
                item, itemId, itemQuantity, itemName, rewrittenItem, rewrittenItemObjects = [];
            $.each(itemsReceived, function (itemKey) {
                itemId = Number(itemKey);
                item = ksoItems[itemId];
                itemQuantity = Number(itemsReceived[itemKey]);
                itemName = item.name;
                rewrittenItem = {};
                rewrittenItem.id = itemId;
                rewrittenItem.name = itemName;
                rewrittenItem.count = itemQuantity;
                rewrittenItemObjects.push(rewrittenItem);
                seed.items["i" + itemId] = Number(seed.items["i" + itemId]) + itemQuantity;
                item.add(itemQuantity)
            });
            cm.InventoryView.openItemsInChestModal(rewrittenItemObjects, originalItemId)
        };
    var useCourtItem = function (itemId) {
            var isEquippedFlag = (ksoItems[itemId].isEquipped) ? 2 : 1;
            var params = Object.clone(g_ajaxparams);
            params.item = itemId;
            params.setflag = isEquippedFlag;
            new Ajax.Request(g_ajaxpath + "ajax/courtSelectItem.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        if (ksoItems[itemId].isEquipped) {
                            ksoItems[itemId].isEquipped = false;
                            $.each(seed.courtItems, function (index, courtItem) {
                                if (Number(courtItem) == itemId) {
                                    seed.courtItems.splice(index, index + 1)
                                }
                            })
                        } else {
                            ksoItems[itemId].isEquipped = true;
                            seed.courtItems.push(itemId.toString())
                        }
                        cm.InventoryView.toggleCourtItem(itemId);
                        if ($("#courtView")) {
                            changeview_court_content()
                        }
                        update_bdg()
                    }
                },
                onFailure: function () {}
            })
        };
    var useTroopHealthBoost = function () {};
    var useFertileWinds = function (itemId) {
            var params = Object.clone(g_ajaxparams);
            params.cid = currentcityid;
            new Ajax.Request(g_ajaxpath + "ajax/fertilizePeople.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        if (rslt.updateSeed) {
                            update_seed(rslt.updateSeed)
                        }
                        cm.InventoryView.removeItemFromInventory(itemId)
                    }
                },
                onFailure: function () {}
            })
        };
    var useMassHypnosis = function (iid) {
            var params = Object.clone(g_ajaxparams);
            params.cid = currentcityid;
            new Ajax.Request(g_ajaxpath + "ajax/hypnotize.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        if (rslt.updateSeed) {
                            update_seed(rslt.updateSeed)
                        }
                        cm.InventoryView.removeItemFromInventory(iid)
                    }
                },
                onFailure: function () {}
            })
        };
    var useDoveOfPeace = function (iid) {
            var cityKey, marchKey, cityMarches, march, isAttacking;
            for (cityKey in seed.queue_atkp) {
                cityMarches = seed.queue_atkp[cityKey];
                for (marchKey in cityMarches) {
                    march = cityMarches[marchKey];
                    isAttacking = (march.marchType == cm.MARCH_TYPES.MARCH_TYPE_SCOUT || march.marchType == cm.MARCH_TYPES.MARCH_TYPE_ATTACK) && march.marchStatus == cm.MARCH_STATUS.MARCH_STATUS_OUTBOUND;
                    if (isAttacking) {
                        Modal.showAlert(g_js_strings.errorcode.err_207c);
                        return
                    }
                }
            }
            var allIncomingAttacks = cm.IncomingAttackManager.getAllAttacks();
            var isUnderAttack = allIncomingAttacks.getCount() > 0;
            if (isUnderAttack) {
                Modal.showAlert(g_js_strings.errorcode.err_207d);
                return
            }
            var params = Object.clone(g_ajaxparams);
            new Ajax.Request(g_ajaxpath + "ajax/doveOut.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        if (rslt.updateSeed) {
                            update_seed(rslt.updateSeed)
                        }
                        var boostTime = 43200;
                        seed.player.truceExpireUnixTime = unixtime() + boostTime;
                        seed.player.warStatus = 3;
                        cm.InventoryView.removeItemFromInventory(iid);
                        update_boosts()
                    } else {
                        Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                    }
                },
                onFailure: function () {}
            })
        };
    var usePortalOfRefuge = function (iid) {
            var params = Object.clone(g_ajaxparams);
            params.iid = iid;
            params.cid = currentcityid;
            params.pid = parseInt($("#provinceNamesList").val());
            new Ajax.Request(g_ajaxpath + "ajax/relocate.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        var newXCoordinate = rslt.x,
                            newYCoordinate = rslt.y;
                        Modal.hideModal();
                        currentcityinfo[2] = newXCoordinate;
                        currentcityinfo[3] = newYCoordinate;
                        for (var i = 0; i < seed.cities.length; i++) {
                            if (Number(seed.cities[i][0]) == Number(currentcityid)) {
                                seed.cities[i][2] = newXCoordinate;
                                seed.cities[i][3] = newYCoordinate;
                                break
                            }
                        }
                        $("#mapXCoor").val(newXCoordinate);
                        $("#mapYCoor").val(newYCoordinate);
                        reCenterMapWithCoor();
                        cm.InventoryView.removeItemFromInventory(iid);
                        cm.InventoryView.openPortalConfirmModal(iid, newXCoordinate, newYCoordinate)
                    } else {
                        if (rslt.msg) {
                            $("#teleportError").text(rslt.msg);
                            $("#teleportError").show()
                        }
                    }
                },
                onFailure: function () {}
            })
        };
    var usePortalOfOrder = function (iid) {
            var params = Object.clone(g_ajaxparams);
            params.iid = iid;
            params.cid = currentcityid;
            params.xcoord = Number($("#newXCoordinate").val());
            params.ycoord = Number($("#newYCoordinate").val());
            new Ajax.Request(g_ajaxpath + "ajax/relocate.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        var newXCoordinate = rslt.x,
                            newYCoordinate = rslt.y;
                        Modal.hideModal();
                        currentcityinfo[2] = newXCoordinate;
                        currentcityinfo[3] = newYCoordinate;
                        for (var i = 0; i < seed.cities.length; i++) {
                            if (Number(seed.cities[i][0]) == Number(currentcityid)) {
                                seed.cities[i][2] = newXCoordinate;
                                seed.cities[i][3] = newYCoordinate;
                                break
                            }
                        }
                        $("#mapXCoor").val(newXCoordinate);
                        $("#mapYCoor").val(newYCoordinate);
                        reCenterMapWithCoor();
                        cm.InventoryView.removeItemFromInventory(iid);
                        cm.InventoryView.openPortalConfirmModal(iid, newXCoordinate, newYCoordinate)
                    } else {
                        if (rslt.msg) {
                            $("#teleportError").text(rslt.msg);
                            $("#teleportError").show()
                        }
                    }
                },
                onFailure: function () {
                    if (rslt.msg) {
                        $("#teleportError").text(rslt.msg);
                        $("#teleportError").show()
                    }
                }
            })
        };
    var useMerlinsCloak = function (itemId) {
            var newNameValue = $("#merlinsCloakNewName").val(),
                hudNameDom = $("#topnavDisplayName"),
                errorDom = $("#merlinsCloakError");
            if (!newNameValue || newNameValue.length < 3 || newNameValue.length > 15) {
                errorDom.text(g_js_strings.setNewDisplayName.entername);
                errorDom.show();
                return false
            }
            var params = Object.clone(g_ajaxparams);
            params.displayname = newNameValue;
            params.cid = currentcityid;
            params.iid = itemId;
            new Ajax.Request(g_ajaxpath + "ajax/changename.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        Modal.hideModal();
                        seed.player.name = newNameValue;
                        hudNameDom.text(seed.player.prefix + " " + newNameValue);
                        cm.InventoryView.removeItemFromInventory(itemId)
                    } else {
                        if (rslt.msg) {
                            errorDom.text(rslt.msg);
                            errorDom.show()
                        }
                    }
                },
                onFailure: function () {
                    if (rslt.msg) {
                        errorDom.text(rslt.msg);
                        errorDom.show()
                    }
                }
            })
        };
    var useRenamingCelebration = function (itemId) {
            var newName = $("#newCityName").val();
            if (!newName || newName.length < 3 || newName.length > 15) {
                $("#cityNameError").text(g_js_strings.modal_rename_celebration.entername);
                $("#cityNameError").show();
                return false
            }
            var params = Object.clone(g_ajaxparams);
            params.cityname = newName;
            params.cid = currentcityid;
            params.iid = itemId;
            new Ajax.Request(g_ajaxpath + "ajax/changeCityName.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        Modal.hideModal();
                        $("#mod_cityinfo_cityname").text(newName);
                        for (var i = 0; i < seed.cities.length; i++) {
                            if (Number(seed.cities[i][0]) == Number(currentcityid)) {
                                seed.cities[i][1] = newName;
                                break
                            }
                        }
                        cm.InventoryView.removeItemFromInventory(itemId);
                        var message = g_js_strings.modal_myitems_use_teleportprovince_do.aused.replace("%1$s", itemlist["i" + itemId].name);
                        cm.InventoryView.openRenamingCelebrationConfirmModal(message, newName)
                    } else {
                        if (rslt.msg) {
                            $("#cityNameError").text(rslt.msg);
                            $("#cityNameError").show()
                        }
                    }
                },
                onFailure: function () {}
            })
        };
    var useMerlinsEscape = function (itemId) {
            var newNameValue = $("#merlinsEscapeNewName").val(),
                xCoordinate = Number($("#newXCoordinate").val()),
                yCoordinate = Number($("#newYCoordinate").val());
            if (!newNameValue || newNameValue < 3 || newNameValue.length > 15) {
                $("#merlinsEscapeNewName").val(g_js_strings.setNewDisplayName.entername);
                $("#merlinsEscapeNewName").show();
                return false
            }
            var params = Object.clone(g_ajaxparams);
            params.iid = itemId;
            params.cid = currentcityid;
            params.displayname = newNameValue;
            params.xcoord = xCoordinate;
            params.ycoord = yCoordinate;
            new Ajax.Request(g_ajaxpath + "ajax/relocateAndChangename.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        Modal.hideModal();
                        currentcityinfo[2] = xCoordinate;
                        currentcityinfo[3] = yCoordinate;
                        for (var i = 0; i < seed.cities.length; i++) {
                            if (Number(seed.cities[i][0]) == Number(currentcityid)) {
                                seed.cities[i][2] = xCoordinate;
                                seed.cities[i][3] = yCoordinate;
                                break
                            }
                        }
                        $("mapXCoor").val(xCoordinate);
                        $("mapYCoor").val(yCoordinate);
                        reCenterMapWithCoor();
                        seed.player.name = newNameValue;
                        $("topnavDisplayName").text(seed.player.prefix + " " + newNameValue);
                        cm.InventoryView.removeItemFromInventory(itemId);
                        cm.InventoryView.openMerlinsEscapeConfirmModal(itemId, xCoordinate, yCoordinate)
                    } else {
                        if (rslt.msg) {
                            $("#escapeError").text(rslt.msg);
                            $("#escapeError").show()
                        }
                    }
                },
                onFailure: function () {}
            })
        };
    var useRenamingRitual = function (itemId) {};
    var usePotionOfMist = function (itemId) {
            var params = Object.clone(g_ajaxparams);
            new Ajax.Request(g_ajaxpath + "ajax/fogUser.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        if (rslt.updateSeed) {
                            update_seed(rslt.updateSeed)
                        }
                        Modal.hideModal();
                        var boostTime = 604800,
                            message;
                        if (seed.playerEffects.length == 0) {
                            seed.playerEffects = new Object
                        }
                        if (!(parseInt(seed.playerEffects.fogExpire) > unixtime())) {
                            seed.playerEffects.fogExpire = unixtime()
                        }
                        seed.playerEffects.fogExpire = Number(seed.playerEffects.fogExpire) + boostTime;
                        cm.InventoryView.removeItemFromInventory(itemId);
                        update_boosts();
                        g_mapObject.getMoreSlots()
                    } else {
                        Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                    }
                },
                onFailure: function () {}
            })
        };
    var useVacationMode = function (itemId) {
            new Ajax.Request(g_ajaxpath + "ajax/vacationMode.php?iid=" + itemId, {
                method: "post",
                parameters: Object.clone(g_ajaxparams),
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        var vacationExpire = Math.floor(rslt.updateSeed.playerEffects.vacationExpire),
                            troopUpkeepExpire = Math.floor(rslt.updateSeed.playerEffects.troopUpkeepReductExp),
                            fogExpire = Math.floor(rslt.updateSeed.playerEffects.fogExpire),
                            truceExpire = Math.floor(rslt.updateSeed.player.truceExpireUnixTime);
                        seed.playerEffects.troopUpkeepReductExp = troopUpkeepExpire;
                        seed.playerEffects.fogExpire = fogExpire;
                        seed.playerEffects.vacationExpire = vacationExpire;
                        seed.player.truceExpireUnixTime = truceExpire;
                        update_boosts();
                        Modal.hideModal();
                        cm.InventoryView.removeItemFromInventory(itemId)
                    } else {
                        if (rslt.msg) {
                            Modal.showAlert(rslt.msg)
                        }
                    }
                },
                onFailure: function () {}
            })
        };
    init_();
    return {
        use: use,
        usePortalOfRefuge: usePortalOfRefuge,
        usePortalOfOrder: usePortalOfOrder,
        useMerlinsCloak: useMerlinsCloak,
        useMerlinsEscape: useMerlinsEscape,
        useRenamingCelebration: useRenamingCelebration,
        useRenamingRitual: useRenamingRitual,
        usePotionOfMist: usePotionOfMist,
        useVacationMode: useVacationMode
    }
}(jQuery);
var cm = cm || {};
cm.item = function (f) {
    var c;
    var m;
    var d;
    var b = [];

    function g() {
        var n = {
            use: a,
            confirmSpec: {
                execute: function () {
                    new Ajax.Request(g_ajaxpath + "ajax/vacationMode.php?iid=" + c, {
                        method: "post",
                        parameters: Object.clone(g_ajaxparams),
                        onSuccess: l
                    })
                },
                warning: function (o) {
                    return o == 902 ? g_js_strings.modal_myitems_confirm_vacation3 : g_js_strings.modal_myitems_confirm_vacation7
                },
                useButton: g_js_strings.modal_myitems_confirm_potion_mist.usevacation
            },
            stop_action: i
        };
        b[2000] = {
            use: function () {
                cm.guardianItem.render(true)
            }
        }
    }
    g();

    function a() {
        Modal.multiButton({
            buttons: [{
                txt: m.confirmSpec.useButton,
                exe: j
            }, {
                txt: g_js_strings.commonstr.cancel,
                exe: function () {
                    Modal.hideModal()
                }
            }],
            body: m.confirmSpec.warning(c)
        })
    }

    function i(n) {
        if (!seed.playerEffects.vacationExpire || (unixtime() > seed.playerEffects.vacationExpire)) {
            return false
        } else {
            e(seed.playerEffects.vacationExpire);
            Modal.multiButton({
                buttons: [{
                    txt: g_js_strings.modal_myitems_confirm_vacation_continue_button,
                    exe: function () {
                        seed.playerEffects.vacationExpire = unixtime() - 1;
                        seed.player.truceExpireUnixTime = unixtime() - 1;
                        seed.playerEffects.troopUpkeepReductExp = unixtime() - 1;
                        seed.playerEffects.fogExpire = unixtime() - 1;
                        update_boosts();
                        if (n) {
                            n()
                        }
                    }
                }, {
                    txt: g_js_strings.commonstr.cancel,
                    exe: function () {
                        Modal.hideModal()
                    }
                }],
                body: g_js_strings.modal_attack_vacation
            });
            return true
        }
    }

    function j() {
        Modal.hideModal();
        m.confirmSpec.execute()
    }

    function l(n) {
        seed.items["i" + c] = parseInt(seed.items["i" + c]) - 1;
        ksoItems[c].subtract();
        f("#modal_itemowned_" + c).html(seed.items["i" + c]);
        if (seed.items["i" + c] <= 0) {
            f("#modal_item_" + c).remove();
            modal_fix_paginate(5, 12)
        }
        k(n);
        f("#modal_shop_message").html(itemlist["i" + c].name + " used!");
        f("#modal_shop_message").show()
    }

    function e(o) {
        var n = (o - unixtime())
    }

    function k(n) {
        if (n.responseText) {
            var p = jQuery.parseJSON(n.responseText).updateSeed;
            var o = p.playerEffects.vacationExpire;
            if (o) {
                d = parseInt(c) == 902 ? 3 * 24 * 3600 : 7 * 24 * 3600;
                h(p);
                e(o)
            } else {
                cm.log.l("parsedSeed.playerEffects.vacationExpire Is NOT set.  Brad: Please set me from the backend of the ajax call.")
            }
        } else {
            cm.log.l("finishItemUsage: rslt does not have responseText.")
        }
    }

    function h(n) {
        seed.playerEffects.troopUpkeepReductExp = parseInt(n.playerEffects.troopUpkeepReductExp);
        seed.playerEffects.fogExpire = parseInt(n.playerEffects.fogExpire);
        seed.player.truceExpireUnixTime = parseInt(n.player.truceExpireUnixTime);
        update_boosts()
    }
    return {
        use: function (n) {
            c = "" + n;
            m = b[c];
            m.use()
        },
        markup: function (n) {
            return "<div class='useitem clearfix'><a onclick=\"cm.item.use('" + n + "');return false;\" class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>"
        },
        get: function (n) {
            return b[n]
        },
        fire: function (n, o) {
            for (var p in b) {
                m = b[p];
                if (m[n] && m[n](o)) {
                    return true
                }
            }
            return false
        }
    }
}(jQuery);
cm.BaseItem = function (d) {
    cm.CustomEventDispatcher.call(this);
    var f = this;
    var e;
    var c;
    var a;
    var h;
    var b;
    this.getId = function () {
        return e
    };
    this.getDescription = function () {
        return a
    };
    this.getQuantity = function () {
        var i = parseInt(seed.items["i" + e]);
        return !isNaN(i) && i > 0 ? i : 0
    };
    this.setQuantity = function (i) {
        seed.items["i" + e] = !isNaN(i) && i > 0 ? i : 0
    };
    this.getPrice = function () {
        return b
    };
    this.getImageUrl = function (i) {
        return stimgUrl + "img/items/" + i + "/" + e + ".jpg"
    };
    this.buy = function () {};
    this.applyItem = function () {};
    var g = function () {
            if (d) {
                e = d.id;
                c = d.name;
                a = d.description;
                b = d.price
            }
        };
    g()
};
cm.OOP.inherits(cm.BaseItem, cm.CustomEventDispatcher);
cm.CombatBoostItem = function (a) {
    cm.BaseItem.call(this, a);
    var d = this;
    var f;
    var c = function (m) {
            var l = m.getTarget();
            l.removeEventListener(cm.ItemServiceEvent.APPLY_SUCCESS, c);
            var i = m.getResponse();
            var q = jQuery.parseJSON(i.responseText);
            if (q.ok) {
                var n = d.getId();
                if (seed.playerEffects.length == 0) {
                    seed.playerEffects = {}
                }
                var g = unixtime();
                var o = f.name;
                var j = f.duration;
                var p = parseInt(seed.playerEffects[o]);
                if (p < g) {
                    p = g
                }
                seed.playerEffects[o] = p + j;
                var h = d.getQuantity();
                d.setQuantity(h - 1);
                if (q.updateSeed) {
                    update_seed(q.updateSeed)
                }
                update_boosts();
                var k = new cm.ItemEvent(cm.ItemEvent.APPLIED);
                k.setTarget(d);
                d.dispatchCustomEvent(k)
            }
        };
    var b = function (l) {
            var h = l.getTarget();
            var i = l.getResponse();
            h.removeEventListener(cm.ItemServiceEvent.BUY_SUCCESS, b);
            var g = jQuery.parseJSON(i.responseText);
            if (!g.ok) {
                Modal.showAlert(printLocalError((g.error_code || null), (g.msg || null), (g.feedback || null)));
                return
            }
            seed.player.gems -= d.getPrice();
            var k = d.getQuantity();
            d.setQuantity(k + 1);
            var j = new cm.ItemEvent(cm.ItemEvent.BOUGHT);
            j.setTarget(d);
            d.dispatchCustomEvent(j)
        };
    this.applyItem = function () {
        var g = new cm.CombatBoostItemService(d);
        g.addEventListener(cm.ItemServiceEvent.APPLY_SUCCESS, c);
        g.applyItem(d)
    };
    this.buyItem = function () {
        var g = new cm.CombatBoostItemService(d);
        g.addEventListener(cm.ItemServiceEvent.BUY_SUCCESS, b);
        g.buyItem(d)
    };
    var e = function () {
            f = {};
            f.name = a.effect.name;
            f.duration = a.effect.duration
        };
    e()
};
cm.OOP.inherits(cm.CombatBoostItem, cm.BaseItem);
cm.ItemEvent = function (a) {
    cm.CustomEvent.call(this, a)
};
cm.OOP.inherits(cm.ItemEvent, cm.CustomEvent);
cm.ItemEvent.BOUGHT = "bought";
cm.ItemEvent.APPLIED = "applied";
cm = cm || {};
cm.ItemModel = jQueryClass.extend({
    init: function (b, a) {
        this.id = Number(b);
        this.name = itemlist["i" + this.id].name;
        this.description = itemlist["i" + this.id].description;
        this.category = Number(a.category);
        this.subCategory = Number(a.subCategory);
        this.count = 0;
        this.isNew = false;
        this.isOnSale = false;
        this.defaultPrice = Number(a.price);
        this.featuredInfo = undefined;
        this.price = this.defaultPrice;
        this.isFeatured = false;
        this.usable = this.canUse(this.id);
        this.equippable = this.canEquip(this.id);
        this.collectable = this.canCollect(this.id);
        this.isEquipped = false
    },
    setFeatured: function () {
        if (this.featuredInfo !== undefined) {
            var a = Number(this.featuredInfo[0]),
                b = Number(this.featuredInfo[1]),
                c = Number(this.featuredInfo[2]);
            if (a > 0 && unixtime() < a) {
                this.isNew = true
            } else {
                this.isNew = false
            }
            if (b > 0 && b < unixtime() && c > 0 && c > unixtime()) {
                this.salePrice = Math.floor(Number(this.featuredInfo[3]));
                this.isOnSale = true
            } else {
                this.salePrice = undefined;
                this.isOnSale = false
            }
            this.price = this.salePrice && this.salePrice > 0 ? this.salePrice : this.defaultPrice;
            this.isFeatured = this.isNew || this.isOnSale
        }
    },
    canUse: function (a) {
        a = Number(a);
        var b = [101, 102, 111, 112, 121, 122, 131, 132, 141, 142, 261, 262, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 351, 355, 501, 502, 503, 504, 505, 511, 512, 513, 514, 521, 522, 523, 524, 531, 599, 901, 902, 903, 911, 912, 922, 923, 924, 942, 2000];
        if ((a >= 1000 && a <= 1050) || (a >= 1300 && a <= 1477) || (a >= 10000 && a <= 10038) || (a >= 10043 && a <= 10133)) {
            return true
        } else {
            if (b.include(a)) {
                return true
            } else {
                return false
            }
        }
    },
    canEquip: function (a) {
        if (a >= 711 && a <= 895) {
            return true
        } else {
            return false
        }
    },
    canCollect: function (a) {
        if (a > 1100 && a < 1210) {
            return true
        } else {
            return false
        }
    },
    add: function (a) {
        a = Number(a) || 1;
        this.count = this.count + a;
        return this.count
    },
    subtract: function (a) {
        a = Number(a) || 1;
        this.count = this.count - a;
        if (this.count < 0) {
            this.count = 0
        }
        return this.count
    },
    use: function () {}
});

function modal_myitems(c) {
    var a = new Array();
    a.push("<div class='modal_shop_container'>");
    a.push("<div id='modal_shop_body' name='1'>");
    a.push("<div class='modal_shop_hd'>");
    a.push("<div id='geminfo' class='geminfo'>");
    a.push("<div class='mygems'>" + g_js_strings.commonstr.gems + ":<span id='modal_shop_gems'>");
    a.push(seed.player.gems);
    a.push("</span><img src='");
    a.push(stimgUrl);
    a.push("img/gem.png'/></div>");
    a.push("<div class='getgems clearfix'><a onclick='cm.ConversionTracker.track(\"payments\", \"MORE_GEMS_MY_ITEMS\", \"\");modal_getgems();return false;' class='buttonGreen20'><span>+&nbsp;&nbsp;" + g_js_strings.modaltitles.getmoregems + "</span></a></div>");
    a.push("</div>");
    a.push("<div class='gotoshop'><a  class='button20' onclick='modal_myitems_getmoreitems();return false;'><span>" + g_js_strings.modal_myitems.getmoreitems + "</span></a></div>");
    a.push("</div>");
    var j = new Array();
    var n = new Array();
    var f = new Array();
    var b = new Array();
    var g = new Array();
    var m = new Array();
    var e = Object.keys(seed.items);
    var l = Object.isArray(seed.items);
    for (var d = 0; d < e.length; d++) {
        var h = e[d].split("i")[1];
        if (h == 10025 || h == 1062) {
            continue
        }
        if (!itemlist["i" + h]) {
            cm.log.l("Item " + h + " is not defined.  Items are defined in the data_en.js by a backend process, ask Brad.")
        }
        if (itemlist["i" + h] && parseInt(seed.items[e[d]]) > 0) {
            var p = renderItemBox(h);
            var k = parseInt(itemlist[e[d]].category);
            var o = new Array();
            h = parseInt(h);
            if (h == 599 || h == 10018 || h == 10019) {
                o.push(p.join(""))
            }
            if (k == 1) {
                if (o.length > 0) {
                    b = o.concat(b)
                } else {
                    b.push(p.join(""))
                }
            } else {
                if (k == 2) {
                    if (o.length > 0) {
                        j = o.concat(j)
                    } else {
                        j.push(p.join(""))
                    }
                } else {
                    if (k == 3) {
                        if (o.length > 0) {
                            m = o.concat(m)
                        } else {
                            m.push(p.join(""))
                        }
                    } else {
                        if (k == 4) {
                            if (o.length > 0) {
                                n = o.concat(n)
                            } else {
                                n.push(p.join(""))
                            }
                        } else {
                            if (k == 5) {
                                if (o.length > 0) {
                                    f = o.concat(f)
                                } else {
                                    f.push(p.join(""))
                                }
                            } else {
                                if (k == 6) {
                                    if (o.length > 0) {
                                        g = o.concat(g)
                                    } else {
                                        g.push(p.join(""))
                                    }
                                } else {
                                    if (o.length > 0) {
                                        b = o.concat(b)
                                    } else {
                                        b.push(p.join(""))
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    a.push("<div class='modal_shop_body'>");
    a.push("<div class='tabsbar clearfix' id='modal_shop_tabs'>");
    a.push("<a  id='modal_shop_tab1' onclick='modal_shop_changetab(1);return false;' class='tab selected'><span>" + g_js_strings.commonstr.general + "</span></a>");
    a.push("<a  id='modal_shop_tab2' onclick='modal_shop_changetab(2);return false;' class='tab'><span>" + g_js_strings.commonstr.speedup + "</span></a>");
    a.push("<a  id='modal_shop_tab3' onclick='modal_shop_changetab(3);return false;' class='tab'><span>" + g_js_strings.commonstr.combat + "</span></a>");
    a.push("<a  id='modal_shop_tab4' onclick='modal_shop_changetab(4);return false;' class='tab'><span>" + g_js_strings.commonstr.resources + "</span></a>");
    a.push("<a  id='modal_shop_tab5' onclick='modal_shop_changetab(5);return false;' class='tab'><span>" + g_js_strings.commonstr.chest + "</span></a>");
    a.push("<a  id='modal_shop_tab6' onclick='modal_shop_changetab(6);return false;' class='tab'><span>" + g_js_strings.commonstr.court + "</span></a>");
    a.push("</div>");
    a.push("<div id='modal_shop_message' style='display:none;'></div>");
    a.push("<div id='modal_shop_paginate' style='display:none;'><div class='comingSoon'> 7th city is HERE! </div><span class='page'>" + g_js_strings.commonstr.page + ":</span> <span id='modal_shop_page_list'></span></div>");
    a.push("<div class='itemlistboxwrap'>");
    a.push("<a id='modal_shop_page_prev' onclick='modal_shop_prevpage();return false;'></a>");
    a.push("<a id='modal_shop_page_next' onclick='modal_shop_nextpage();return false;'></a>");
    a.push("<div class='itemlistbox'>");
    a.push("<div class='itemlist clearfix' id='modal_shop_items_1'>");
    if (b.length > 0) {
        a.push(b.join(""))
    } else {
        a.push("<div class='noitem'><div>" + g_js_strings.modal_myitems.ownnogeneral + "</div><div class='clearfix btn'><a class='button20' onclick='Modal.hideModal();cm.ShopView.openShop(2); return false;');return false;'><span>" + g_js_strings.commonstr.buymore + "</span></a></div></div>")
    }
    a.push("</div>");
    a.push("<div class='itemlist clearfix' id='modal_shop_items_2' style='display:none;'>");
    if (j.length > 0) {
        a.push(j.join(""))
    } else {
        a.push("<div class='noitem'><div>" + g_js_strings.modal_myitems.ownnospeedup + "</div><div class='clearfix btn'><a  class='button20' onclick='Modal.hideModal();cm.ShopView.openShop(3);return false;'><span>" + g_js_strings.commonstr.buymore + "</span></a></div></div>")
    }
    a.push("</div>");
    a.push("<div class='itemlist clearfix' id='modal_shop_items_3' style='display:none;'>");
    if (m.length > 0) {
        a.push(m.join(""))
    } else {
        a.push("<div class='noitem'><div>" + g_js_strings.modal_myitems.ownnoattack + "</div><div class='clearfix btn'><a  class='button20' onclick='Modal.hideModal();cm.ShopView.openShop(4);return false;'><span>" + g_js_strings.commonstr.buymore + "</span></a></div></div>")
    }
    a.push("</div>");
    a.push("<div class='itemlist clearfix' id='modal_shop_items_4' style='display:none;'>");
    if (n.length > 0) {
        a.push(n.join(""))
    } else {
        a.push("<div class='noitem'><div>" + g_js_strings.modal_myitems.ownnoprod + "</div><div class='clearfix btn'><a  class='button20' onclick='Modal.hideModal();cm.ShopView.openShop(5);return false;'><span>" + g_js_strings.commonstr.buymore + "</span></a></div></div>")
    }
    a.push("</div>");
    a.push("<div class='itemlist clearfix' id='modal_shop_items_5' style='display:none;'>");
    if (f.length > 0) {
        a.push(f.join(""))
    } else {
        a.push("<div class='noitem'><div>" + g_js_strings.modal_myitems.ownnochest + "</div><div class='clearfix btn'><a  class='button20' onclick='Modal.hideModal();cm.ShopView.openShop(6);return false;'><span>" + g_js_strings.commonstr.buymore + "</span></a></div></div>")
    }
    a.push("</div>");
    a.push("<div class='itemlist clearfix' id='modal_shop_items_6' style='display:none;'>");
    if (g.length > 0) {
        a.push(g.join(""))
    } else {
        a.push("<div class='noitem'><div>" + g_js_strings.modal_myitems.ownnocourt + "</div><div class='clearfix btn'><a  class='button20' onclick='Modal.hideModal();cm.ShopView.openShop(7);return false;'><span>" + g_js_strings.commonstr.buymore + "</span></a></div></div>")
    }
    a.push("</div>");
    a.push("</div>");
    a.push("</div>");
    a.push("</div>");
    a.push("</div></div>");
    Modal.show({
        winWidth: 740,
        winHeight: 400,
        winLeft: 10,
        winTop: 10,
        winTitle: g_js_strings.commonstr.inventory,
        winContent: a.join(""),
        callback: modal_myitems_init,
        shutdown: function () {
            cm.speedUpModalTimer.redisplayModal(true)
        }
    });
    if (c) {
        modal_shop_changetab(c)
    }
    if (parseInt(seed.tutorial.t1) == 10) {
        seed.tutorial.t1 = 11;
        modal_shop_changetab(5);
        tutorialCheck(11)
    }
}

function renderItemBox(b) {
    var a = new Array();
    a.push('<div class="item" class="modal_item_' + b + '" id="modal_item_');
    a.push(b);
    a.push('" onmouseover="modal_shop_tooltip(this,event);return false;" onmouseout="removeTooltip();return false;" name="');
    a.push(itemlist["i" + b].description);
    a.push('">');
    a.push("<div class='itemname'>");
    a.push(itemlist["i" + b].name);
    a.push("</div>");
    a.push("<div class='clearfix iteminfo'>");
    a.push("<img src='");
    a.push(stimgUrl);
    a.push("img/items/70/");
    a.push(b);
    a.push(".jpg?5c10831'/>");
    a.push(modal_myitems_use_link(b));
    a.push("<div class='myitemowned'>" + g_js_strings.commonstr.owned + ": <span class='modal_itemowned_" + b + "' id='modal_itemowned_");
    a.push(b);
    a.push("'>");
    a.push(seed.items["i" + b]);
    a.push("</span></div>");
    a.push("</div>");
    a.push("</div>");
    return a
}

function modal_myitems_init() {
    modal_shop_pageinit(1)
}

function modal_myitems_use_link(b) {
    var a = new Array();
    var c = parseInt(b);
    if (c == 10029) {
        a.push("<div class='useitem clearfix'><a  onclick='cm.chestItemUsage.open(");
        a.push(c);
        a.push(");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
    } else {
        if (cm.item.get(c)) {
            a.push(cm.item.markup(c))
        } else {
            if (itemlist["i" + c].subCategory == 100) {
                a.push("<div class='useitem clearfix'><a  onclick='modal_myitems_use_mystery_chest(");
                a.push(c);
                a.push(");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
            } else {
                if (c == 101 || c == 102 || c == 111 || c == 112 || c == 121 || c == 122 || c == 131 || c == 132 || c == 141 || c == 142) {
                    a.push("<div class='useitem clearfix'><a  onclick='modal_boost_production_use(" + c + ");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                } else {
                    if (c == 261 || c == 262 || c == 271 || c == 272 || (c >= 276 && c <= 279) || c == 280 || c == 281) {
                        a.push("<div class='useitem clearfix'><a  onclick='modal_boost_combat_use(" + c + ");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                    } else {
                        if (c == 273 || c == 274 || c == 275) {
                            a.push("<div class='useitem clearfix'><a  onclick='modal_reduce_troop_upkeep_use(" + c + ");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                        } else {
                            if (c == 351) {
                                a.push("<div class='useitem clearfix'><a  onclick='modal_fertilize();return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                            } else {
                                if (c == 355) {
                                    a.push("<div class='useitem clearfix'><a  onclick='modal_hypnotize();return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                } else {
                                    if (c == 511 || c == 512 || c == 513 || c == 514) {
                                        a.push("<div class='useitem clearfix'><a  onclick='modal_get_knight(" + b + ");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                    } else {
                                        if (c > 520 && c < 525) {
                                            a.push("<div class='useitem clearfix'><a  onclick='modal_volunteer(" + b + ");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                        } else {
                                            if (c == 599) {
                                                a.push("<div class='useitem clearfix'><a  onclick='cm.mww.start(2);return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                            } else {
                                                if (c == 922) {
                                                    a.push("<div class='useitem clearfix'><a  onclick='modal_get_cloak_name();return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                                } else {
                                                    if (c == 923) {
                                                        a.push("<div class='useitem clearfix'><a  onclick='modal_rename_celebration();return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                                    } else {
                                                        if (c == 924) {
                                                            a.push("<div class='useitem clearfix'><a  onclick='modal_myitems_use_escape(");
                                                            a.push(c);
                                                            a.push(");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                                        } else {
                                                            if (c == 942) {
                                                                a.push("<div class='useitem clearfix'><a  onclick='unpackFountainPack();return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                                            } else {
                                                                if (c > 1000 && c < 1050) {
                                                                    a.push("<div class='useitem clearfix'><a  onclick='modal_myitems_use(");
                                                                    a.push(c);
                                                                    a.push(");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                                                } else {
                                                                    if (c >= 1300 && c <= 1419) {
                                                                        a.push("<div class='useitem clearfix'><a onclick='modal_volunteer(");
                                                                        a.push(c);
                                                                        a.push(");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                                                    } else {
                                                                        if ((c > 500 && c <= 505) || c == 531) {
                                                                            a.push("<div class='useitem clearfix'><a  onclick='modal_myitems_use_chest(");
                                                                            a.push(c);
                                                                            a.push(");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                                                        } else {
                                                                            if (c == 901) {
                                                                                a.push("<div class='useitem clearfix'><a  onclick='modal_myitems_use_peace_dove(");
                                                                                a.push(c);
                                                                                a.push(");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                                                            } else {
                                                                                if (c == 911) {
                                                                                    a.push("<div class='useitem clearfix'><a  onclick='modal_myitems_use_teleportprovince(");
                                                                                    a.push(c);
                                                                                    a.push(");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                                                                } else {
                                                                                    if (c == 912) {
                                                                                        a.push("<div class='useitem clearfix'><a  onclick='modal_myitems_use_teleport(");
                                                                                        a.push(c);
                                                                                        a.push(");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                                                                    } else {
                                                                                        if (c == 10021) {
                                                                                            a.push("<div class='useitem clearfix'><a onclick='modal_myitems_confirm_potion_mist(");
                                                                                            a.push(c);
                                                                                            a.push(");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                                                                        } else {
                                                                                            if (c >= 10000 && c < 20000) {
                                                                                                a.push("<div class='useitem clearfix'><a  onclick='modal_chest_itemusage(");
                                                                                                a.push(c);
                                                                                                a.push(");return false;' class='button20'><span>" + g_js_strings.commonstr.use + "</span></a></div>")
                                                                                            } else {
                                                                                                if (c > 700 && c < 900) {
                                                                                                    a.push("<div class='useitem clearfix'><a  onclick='modal_myitems_use_court(");
                                                                                                    a.push(c);
                                                                                                    if (seed.courtItems.indexOf(b) >= 0) {
                                                                                                        a.push(");return false;' class='button20'><span class='equiptext " + g_ajaxparams.lang + "'>" + g_js_strings.commonstr.unequip + "</span></a></div>")
                                                                                                    } else {
                                                                                                        a.push(");return false;' class='button20'><span class='equiptext'>" + g_js_strings.commonstr.equip + "</span></a></div>")
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    return a.join("")
}

function modal_myitems_use_peace_dove(itemid) {
    var params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/doveOut.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                var ut = unixtime();
                var bst = 43200;
                if (!(parseInt(seed.player.truceExpireUnixTime) > ut)) {
                    seed.player.truceExpireUnixTime = ut
                }
                seed.player.truceExpireUnixTime = parseInt(seed.player.truceExpireUnixTime) + bst;
                seed.player.warStatus = 3;
                seed.items["i" + itemid] = parseInt(seed.items["i" + itemid]) - 1;
                $("modal_itemowned_" + itemid).innerHTML = seed.items["i" + itemid];
                if (seed.items["i" + itemid] == 0) {
                    $("modal_shop_items_3").removeChild($("modal_item_" + itemid));
                    modal_fix_paginate(1)
                }
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                update_boosts();
                $("modal_shop_message").innerHTML = itemlist["i" + itemid].name + " used!";
                $("modal_shop_message").show()
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function modal_myitems_confirm_potion_mist(b) {
    var c = new Array();
    var a = new Array();
    c.push("<div class='mistwarn'>");
    c.push(g_js_strings.modal_myitems_confirm_potion_mist.mistwarning);
    c.push("</div>");
    a.push("<a class='button20' onclick='Modal.hideModal();modal_myitems_use_potion_mist(" + b + ");return false;'><span>");
    a.push(g_js_strings.modal_myitems_confirm_potion_mist.usemists);
    a.push("</span></a>");
    a.push("<a class='button20' onclick='Modal.hideModal();return false;'><span>");
    a.push(g_js_strings.commonstr.cancel);
    a.push("</span></a>");
    Modal.showAlert(c.join(""), a.join(""))
}

function modal_myitems_use_potion_mist(itemid) {
    var iid = itemid;
    var params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/fogUser.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (seed.playerEffects.length == 0) {
                    seed.playerEffects = new Object
                }
                var ut = unixtime();
                var bst = 604800;
                if (!(parseInt(seed.playerEffects.fogExpire) > ut)) {
                    seed.playerEffects.fogExpire = ut
                }
                seed.playerEffects.fogExpire = parseInt(seed.playerEffects.fogExpire) + bst;
                seed.items["i" + iid] = parseInt(seed.items["i" + iid]) - 1;
                $("modal_itemowned_" + iid).innerHTML = seed.items["i" + iid];
                if (seed.items["i" + iid] == 0) {
                    $("modal_shop_items_1").removeChild($("modal_item_" + iid));
                    modal_fix_paginate(1)
                }
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                update_boosts();
                $("modal_shop_message").innerHTML = g_js_strings.modal_myitems_use_teleportprovince_do.aused.replace("%1$s", itemlist["i" + iid].name);
                $("modal_shop_message").show();
                g_mapObject.getMoreSlots()
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function modal_myitems_use_court(itemid) {
    var pflag = ($("modal_item_" + itemid).select(".equiptext")[0].innerHTML == g_js_strings.commonstr.equip) ? 1 : 2;
    var params = Object.clone(g_ajaxparams);
    params.item = itemid;
    params.setflag = pflag;
    new Ajax.Request(g_ajaxpath + "ajax/courtSelectItem.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (pflag == 1) {
                    var newItemInfo = itemlist["i" + itemid];
                    if (newItemInfo.subCategory != 0) {
                        seed.courtItems.slice(0)._each(function (i) {
                            if (parseInt(i) == 0) {
                                return
                            }
                            if (itemlist["i" + i].subCategory == newItemInfo.subCategory) {
                                $("modal_item_" + i).select(".equiptext")[0].innerHTML = g_js_strings.commonstr.equip;
                                seed.courtItems.splice(seed.courtItems.indexOf(i), 1)
                            }
                        })
                    }
                    seed.courtItems.push(itemid.toString());
                    $("modal_item_" + itemid).select(".equiptext")[0].innerHTML = g_js_strings.commonstr.unequip;
                    if ($("courtView")) {
                        changeview_court_content()
                    }
                } else {
                    var itemIdx = seed.courtItems.indexOf(itemid.toString());
                    seed.courtItems.splice(itemIdx, 1);
                    $("modal_item_" + itemid).select(".equiptext")[0].innerHTML = g_js_strings.commonstr.equip;
                    if ($("courtView")) {
                        changeview_court_content()
                    }
                }
                update_bdg()
            }
        },
        onFailure: function () {}
    })
}

function modal_myitems_use_teleportprovince(e) {
    var a = Math.floor(Math.random() * 25);
    var b = new Array();
    b.push("<div class='cloakmessagewrap'>");
    b.push("<div class='cloakmessage'>");
    b.push("<div class='desc'>" + g_js_strings.modal_myitems_use_teleportprovince.yourcurrentprov + " - <span>" + provincenames["p" + currentcityinfo[4]] + "</span></div>");
    b.push("<div class='desc'>" + g_js_strings.modal_myitems_use_teleportprovince.newprov + ":</div>");
    b.push("<div class='newname'><select id='teleportProvinceSel'>");
    var d = Object.keys(provincenames);
    for (var c = 0; c < d.length; c++) {
        var f = (c == a) ? "selected" : "";
        b.push("<option " + f + " value='");
        b.push(d[c].split("p")[1]);
        b.push("'>");
        b.push(provincenames[d[c]]);
        b.push("</option>")
    }
    b.push("</select></div>");
    b.push("<div id='teleportError' style='display:none;'></div>");
    b.push("</div>");
    b.push("<div class='btnlink clearfix'>");
    b.push("<a class='button25'  onclick='modal_myitems_use_teleportprovince_do(");
    b.push(e);
    b.push(");return false;'><span>" + g_js_strings.commonstr.submit + "</span></a>");
    b.push("<a class='link'  onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    b.push("</div>");
    b.push("</div>");
    if (parseInt(e) == 911) {
        Modal.showModal(500, 500, 10, 10, itemlist["i" + e].name, b.join(""))
    }
}

function modal_myitems_use_teleportprovince_do(iid) {
    var params = Object.clone(g_ajaxparams);
    params.iid = iid;
    params.cid = currentcityid;
    params.pid = parseInt($("teleportProvinceSel").value);
    new Ajax.Request(g_ajaxpath + "ajax/relocate.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                Modal.hideModal();
                seed.items["i" + iid] = parseInt(seed.items["i" + iid]) - 1;
                if (seed.items["i" + iid] == 0) {
                    $("modal_shop_items_1").removeChild($("modal_item_" + iid));
                    modal_fix_paginate(1)
                } else {
                    $("modal_itemowned_" + iid).innerHTML = seed.items["i" + iid]
                }
                currentcityinfo[2] = rslt.x;
                currentcityinfo[3] = rslt.y;
                for (var i = 0; i < seed.cities.length; i++) {
                    if (parseInt(seed.cities[i][0]) == parseInt(currentcityid)) {
                        seed.cities[i][2] = rslt.x;
                        seed.cities[i][3] = rslt.y;
                        break
                    }
                }
                $("mapXCoor").value = rslt.x;
                $("mapYCoor").value = rslt.y;
                reCenterMapWithCoor();
                var msghtml = new Array();
                msghtml.push("<div class='cloakmessagewrap'>");
                msghtml.push("<div class='cloakmessage'>");
                msghtml.push("<div class='desc' style='padding:10px 0 20px 0;'>" + g_js_strings.modal_myitems_use_teleportprovince_do.aused.replace("%1$s", itemlist["i" + iid].name) + "</div>");
                msghtml.push("<div class='desc'>" + g_js_strings.modal_myitems_use_teleportprovince_do.teleportto + " <b>" + rslt.x + "," + rslt.y + "</b></div>");
                msghtml.push("</div>");
                msghtml.push("<div class='btnlink clearfix' style='display:block;margin-left:210px;'>");
                msghtml.push("<a class='button25'  onclick='top.location=\"" + appUrl + "\";return false;'><span>" + g_js_strings.commonstr.ok + "</span></a>");
                msghtml.push("</div></div>");
                Modal.showModal(500, 500, 10, 10, itemlist["i" + iid].name, msghtml.join(""))
            } else {
                if (rslt.msg) {
                    $("teleportError").innerHTML = rslt.msg;
                    $("teleportError").show()
                }
            }
        },
        onFailure: function () {}
    })
}

function modal_myitems_use_teleport(b) {
    var a = new Array();
    a.push("<div class='cloakmessagewrap'>");
    a.push("<div class='cloakmessage'>");
    a.push("<div class='desc'>" + g_js_strings.modal_myitems_use_teleport.currentcoor + " - <span>X:" + currentcityinfo[2] + " Y:" + currentcityinfo[3] + "</span></div>");
    a.push("<div class='desc'>New Coordinates:</div>");
    a.push("<div class='newname newcoords'>X: <input id='teleportXCoord' value='' maxlength='3'/> Y: <input id='teleportYCoord' value='' maxlength='3'/></div>");
    a.push("<div id='teleportError' style='display:none;'></div>");
    a.push("</div>");
    a.push("<div class='btnlink clearfix'>");
    a.push("<a class='button25'  onclick='modal_myitems_use_teleport_do(");
    a.push(b);
    a.push(");return false;'><span>" + g_js_strings.commonstr.submit + "</span></a>");
    a.push("<a class='link'  onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    a.push("</div>");
    a.push("</div>");
    if (parseInt(b) == 912) {
        Modal.showModal(500, 500, 10, 10, itemlist["i" + b].name, a.join(""))
    }
}

function modal_myitems_use_teleport_do(iid) {
    var params = Object.clone(g_ajaxparams);
    params.iid = iid;
    params.cid = currentcityid;
    params.xcoord = parseInt($("teleportXCoord").value);
    params.ycoord = parseInt($("teleportYCoord").value);
    new Ajax.Request(g_ajaxpath + "ajax/relocate.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                Modal.hideModal();
                seed.items["i" + iid] = parseInt(seed.items["i" + iid]) - 1;
                if (seed.items["i" + iid] == 0) {
                    $("modal_shop_items_1").removeChild($("modal_item_" + iid));
                    modal_fix_paginate(1)
                } else {
                    $("modal_itemowned_" + iid).innerHTML = seed.items["i" + iid]
                }
                currentcityinfo[2] = params.xcoord;
                currentcityinfo[3] = params.ycoord;
                for (var i = 0; i < seed.cities.length; i++) {
                    if (parseInt(seed.cities[i][0]) == parseInt(currentcityid)) {
                        seed.cities[i][2] = params.xcoord;
                        seed.cities[i][3] = params.ycoord;
                        break
                    }
                }
                $("mapXCoor").value = params.xcoord;
                $("mapYCoor").value = params.ycoord;
                reCenterMapWithCoor();
                var msghtml = new Array();
                msghtml.push("<div class='cloakmessagewrap'>");
                msghtml.push("<div class='cloakmessage'>");
                msghtml.push("<div class='desc' style='padding:10px 0 20px 0;'>" + g_js_strings.modal_myitems_use_teleportprovince_do.aused.replace("%1$s", itemlist["i" + iid].name) + "</div>");
                msghtml.push("<div class='desc'>Teleported to <b>" + params.xcoord + "," + params.ycoord + "</b></div>");
                msghtml.push("</div>");
                msghtml.push("<div class='btnlink clearfix' style='display:block;margin-left:210px;'>");
                msghtml.push("<a class='button25'  onclick='top.location=\"" + appUrl + "\";return false;'><span>" + g_js_strings.commonstr.ok + "</span></a>");
                msghtml.push("</div></div>");
                Modal.showModal(500, 500, 10, 10, itemlist["i" + iid].name, msghtml.join(""))
            } else {
                if (rslt.msg) {
                    $("teleportError").innerHTML = rslt.msg;
                    $("teleportError").show()
                }
            }
        },
        onFailure: function () {}
    })
}

function modal_myitems_use_escape(b) {
    var a = new Array();
    a.push("<div class='escapemessagewrap'>");
    a.push("<div class='escapemessage'>");
    a.push("<div class='renamemessage'>");
    a.push("<div class='desc'>" + g_js_strings.modal_myitems_use_escape.yourcurrentname + ": <span>" + seed.player.prefix + " " + seed.player.name + "</span></div>");
    a.push("<div class='desc'>" + g_js_strings.modal_myitems_use_escape.newname + ":</div>");
    a.push("<div class='newname'>" + seed.player.prefix + " <input id='newEscapeName' value=''/></div>");
    a.push("</div>");
    a.push("<div class='portalmessage'>");
    a.push("<div class='desc'>" + g_js_strings.modal_myitems_use_escape.currentcoor + " - <span>X:" + currentcityinfo[2] + " Y:" + currentcityinfo[3] + "</span></div>");
    a.push("<div class='desc'>" + g_js_strings.modal_myitems_use_escape.newcoor + "</div>");
    a.push("<div class='newname newcoords'>X: <input id='escapeXCoord' value='' maxlength='3'/> Y: <input id='escapeYCoord' value='' maxlength='3'/></div>");
    a.push("</div>");
    a.push("<div id='escapeError' style='display:none;'></div>");
    a.push("</div>");
    a.push("<div class='btnlink clearfix'>");
    a.push("<a class='button25'  onclick='modal_myitems_use_escape_do(");
    a.push(b);
    a.push(");return false;'><span>" + g_js_strings.commonstr.submit + "</span></a>");
    a.push("<a class='link'  onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    a.push("</div>");
    a.push("</div>");
    if (parseInt(b) == 924) {
        Modal.showModal(500, 500, 10, 10, itemlist["i" + b].name, a.join(""))
    }
}

function modal_myitems_use_escape_do(iid) {
    var newName = $("newEscapeName").value;
    if (!newName || newName.length < 3 || newName.length > 15) {
        $("newEscapeName").innerHTML = g_js_strings.setNewDisplayName.entername;
        $("newEscapeName").show();
        return false
    }
    var params = Object.clone(g_ajaxparams);
    params.iid = iid;
    params.cid = currentcityid;
    params.displayname = newName;
    params.xcoord = parseInt($("escapeXCoord").value);
    params.ycoord = parseInt($("escapeYCoord").value);
    new Ajax.Request(g_ajaxpath + "ajax/relocateAndChangename.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                Modal.hideModal();
                seed.items["i" + iid] = parseInt(seed.items["i" + iid]) - 1;
                if (seed.items["i" + iid] == 0) {
                    $("modal_shop_items_1").removeChild($("modal_item_" + iid));
                    modal_fix_paginate(1)
                } else {
                    $("modal_itemowned_" + iid).innerHTML = seed.items["i" + iid]
                }
                currentcityinfo[2] = params.xcoord;
                currentcityinfo[3] = params.ycoord;
                for (var i = 0; i < seed.cities.length; i++) {
                    if (parseInt(seed.cities[i][0]) == parseInt(currentcityid)) {
                        seed.cities[i][2] = params.xcoord;
                        seed.cities[i][3] = params.ycoord;
                        break
                    }
                }
                $("mapXCoor").value = params.xcoord;
                $("mapYCoor").value = params.ycoord;
                reCenterMapWithCoor();
                seed.player.name = newName;
                $("topnavDisplayName").innerHTML = seed.player.prefix + " " + newName;
                var msghtml = new Array();
                msghtml.push("<div class='cloakmessagewrap'>");
                msghtml.push("<div class='cloakmessage'>");
                msghtml.push("<div class='desc' style='padding:10px 0 10px 0;'>" + g_js_strings.modal_myitems_use_escape_do.aused.replace("%1$s", itemlist["i" + iid].name) + "</div>");
                msghtml.push("<div class='desc'>" + g_js_strings.modal_myitems_use_escape_do.namechangedto + " <b>" + seed.player.prefix + " " + params.displayname + "</b></div>");
                msghtml.push("<div class='desc'>" + g_js_strings.modal_myitems_use_escape_do.teleportto + " <b>" + params.xcoord + "," + params.ycoord + "</b></div>");
                msghtml.push("</div>");
                msghtml.push("<div class='btnlink clearfix' style='display:block;margin-left:210px;'>");
                msghtml.push("<a class='button25'  onclick='top.location=\"" + appUrl + "\";return false;'><span>" + g_js_strings.commonstr.ok + "</span></a>");
                msghtml.push("</div></div>");
                Modal.showModal(500, 500, 10, 10, itemlist["i" + iid].name, msghtml.join(""))
            } else {
                if (rslt.msg) {
                    $("escapeError").innerHTML = rslt.msg;
                    $("escapeError").show()
                }
            }
        },
        onFailure: function () {}
    })
}

function unpackFountainPack() {
    var iid = 942;
    var singleiid = 941;
    var params = Object.clone(g_ajaxparams);
    params.iid = iid;
    new Ajax.Request(g_ajaxpath + "ajax/itemChest.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                seed.items["i" + iid] = (parseInt(seed.items["i" + iid]) - 1).toString();
                seed.items["i" + singleiid] = (seed.items["i" + singleiid]) ? (parseInt(seed.items["i" + singleiid]) + 5).toString() : "5";
                if (seed.items["i" + iid] == 0) {
                    $("modal_shop_items_5").removeChild($("modal_item_" + iid));
                    modal_fix_paginate(5)
                } else {
                    $("modal_itemowned_" + iid).innerHTML = seed.items["i" + iid]
                }
            } else {
                if (rslt.msg) {
                    $("cloakNameError").innerHTML = rslt.msg;
                    $("cloakNameError").show()
                }
            }
        },
        onFailure: function () {}
    })
}

function modal_rename_celebration() {
    var b = new Array();
    var a = "No Name";
    b.push("<div class='celebrationwrap'>");
    b.push("<div class='celebrationmessage'>");
    for (var c = 0; c < seed.cities.length; c++) {
        if (parseInt(seed.cities[c][0]) == parseInt(currentcityid)) {
            a = seed.cities[c][1];
            break
        }
    }
    b.push("<div class='desc'>" + g_js_strings.modal_rename_celebration.currentcity + ": <span>" + a + "</span></div>");
    b.push("<div class='desc'>" + g_js_strings.modal_rename_celebration.newcityname + ":</div>");
    b.push("<div class='newname'><input id='newCityName' value=''/></div>");
    b.push("<div id='cityNameError' style='display:none;'></div>");
    b.push("</div>");
    b.push("<div class='btnlink clearfix'>");
    b.push("<a class='button25'  onclick='setNewCityName();return false;'><span>" + g_js_strings.commonstr.submit + "</span></a>");
    b.push("<a class='link'  onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    b.push("</div>");
    b.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.renamecelebration, b.join(""))
}

function setNewCityName() {
    var newName = $("newCityName").value;
    if (!newName || newName.length < 3 || newName.length > 15) {
        $("cityNameError").innerHTML = g_js_strings.modal_rename_celebration.entername;
        $("cityNameError").show();
        return false
    }
    var iid = 923;
    var params = Object.clone(g_ajaxparams);
    params.cityname = newName;
    params.cid = currentcityid;
    params.iid = iid;
    new Ajax.Request(g_ajaxpath + "ajax/changeCityName.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                seed.items["i" + iid] = parseInt(seed.items["i" + iid]) - 1;
                $("modal_itemowned_" + iid).innerHTML = seed.items["i" + iid];
                if (seed.items["i" + iid] == 0) {
                    $("modal_shop_items_1").removeChild($("modal_item_" + iid))
                }
                for (var i = 0; i < seed.cities.length; i++) {
                    if (parseInt(seed.cities[i][0]) == parseInt(currentcityid)) {
                        seed.cities[i][1] = newName;
                        break
                    }
                }
                $("mod_cityinfo_cityname").innerHTML = newName;
                var msghtml = new Array();
                msghtml.push("<div class='cloakmessagewrap'>");
                msghtml.push("<div class='cloakmessage'>");
                msghtml.push("<div class='desc' style='padding:10px 0 20px 0;'>" + g_js_strings.modal_myitems_use_teleportprovince_do.aused.replace("%1$s", itemlist["i" + iid].name) + "</div>");
                msghtml.push("<div class='desc'>" + g_js_strings.modal_rename_celebration.newcityname + ": " + params.cityname + "</div>");
                msghtml.push("</div>");
                msghtml.push("<div class='btnlink clearfix' style='display:block;margin-left:210px;'>");
                msghtml.push("<a class='button25' onclick='top.location=\"" + appUrl + "\";return false;'><span>" + g_js_strings.commonstr.ok + "</span></a>");
                msghtml.push("</div></div>");
                Modal.hideModal();
                Modal.showModal(500, 500, 10, 10, itemlist["i" + iid].name, msghtml.join(""))
            } else {
                if (rslt.msg) {
                    $("cityNameError").innerHTML = rslt.msg;
                    $("cityNameError").show()
                }
            }
        },
        onFailure: function () {}
    })
}

function modal_get_cloak_name() {
    var a = new Array();
    a.push("<div class='cloakmessagewrap'>");
    a.push("<div class='cloakmessage'>");
    a.push("<div class='desc'>" + g_js_strings.modal_get_cloak_name.yourcurrentname + ": <span>" + seed.player.prefix + " " + seed.player.name + "</span></div>");
    a.push("<div class='desc'>" + g_js_strings.modal_get_cloak_name.newname + ":</div>");
    a.push("<div class='newname'>" + seed.player.prefix + " <input id='newCloakName' value=''/></div>");
    a.push("<div id='cloakNameError' style='display:none;'></div>");
    a.push("</div>");
    a.push("<div class='btnlink clearfix'>");
    a.push("<a class='button25'  onclick='setNewDisplayName();return false;'><span>" + g_js_strings.commonstr.submit + "</span></a>");
    a.push("<a class='link'  onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    a.push("</div>");
    a.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.magiccloak, a.join(""))
}

function setNewDisplayName() {
    var newName = $("newCloakName").value;
    if (!newName || newName.length < 3 || newName.length > 15) {
        $("cloakNameError").innerHTML = g_js_strings.setNewDisplayName.entername;
        $("cloakNameError").show();
        return false
    }
    var iid = 922;
    var params = Object.clone(g_ajaxparams);
    params.displayname = newName;
    params.cid = currentcityid;
    params.iid = iid;
    new Ajax.Request(g_ajaxpath + "ajax/changename.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                seed.items["i" + iid] = (parseInt(seed.items["i" + iid]) - 1).toString();
                seed.player.name = newName;
                $("topnavDisplayName").innerHTML = seed.player.prefix + " " + newName;
                Modal.hideModalAll();
                modal_myitems()
            } else {
                if (rslt.msg) {
                    $("cloakNameError").innerHTML = rslt.msg;
                    $("cloakNameError").show()
                }
            }
        },
        onFailure: function () {}
    })
}

function modal_get_knight(b) {
    var a = new Array();
    a.push("<div class='appointknightwrap'>");
    a.push("<center><div class='name'><b>" + g_js_strings.modal_knight_info.knightname + "</b></div>");
    a.push("<div class='knightname'><div><input id='knightname' value='' maxlength='15' /></div></div>");
    a.push("<div class='errorbox'><div id='nameError' style='display:none' font-color='red'>" + g_js_strings.modal_knight_info.entername + "</div></div>");
    a.push("<br/><div class='btnlink clearfix' ><a  class='button25' onclick='use_knight(" + b + ");return false;'><span>" + g_js_strings.modal_appoint.appointknight + "</span></a></div></center>");
    a.push("</div></center>");
    a.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.appointknight, a.join(""))
}

function use_knight(kid) {
    var kname = $("knightname").value;
    if (kname.length < 3) {
        $("nameError").show();
        return false
    } else {
        var params = Object.clone(g_ajaxparams);
        params.ktype = kid;
        params.cid = currentcityid;
        params.kname = kname;
        new Ajax.Request(g_ajaxpath + "ajax/hireSpecialKnight.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    Modal.hideModal();
                    var msghtml = new Array();
                    msghtml.push("<div class='appointknightwrap'>");
                    msghtml.push("<div class='appointbox clearfix'>");
                    msghtml.push("<div class='leftpic'>");
                    msghtml.push("<div class='pic'><img src='" + stimgUrl + "img/items/70/" + kid + ".jpg'></div>");
                    msghtml.push("<div class='leftstat'>" + g_js_strings.commonstr.level + ":<span>" + rslt.klv + "</span></div>");
                    msghtml.push("</div>");
                    msghtml.push("<div class='rightinfo'>");
                    msghtml.push("<div class='title' id='topAppointLine'>" + g_js_strings.modal_knight_info.knightname + "</div>");
                    msghtml.push("<div class='name'>" + kname + "</div>");
                    msghtml.push("<div class='title' id='bottomAppointLine'></div>");
                    msghtml.push("<div class='reqbox'>");
                    msghtml.push("<div class='title'>" + g_js_strings.commonstr.requirement + "</div>");
                    msghtml.push("<div class='rightstat'>" + g_js_strings.commonstr.salary + ": <span>" + (20 * parseInt(rslt.klv)) + " " + g_js_strings.commonstr.goldperhour + "</span></div>");
                    msghtml.push("</div>");
                    msghtml.push("</div>");
                    msghtml.push("</div>");
                    msghtml.push("<div class='exp'><span>" + g_js_strings.modal_knight_info.knightskills + "</span> </div>");
                    msghtml.push("<div class='knightstatsbox clearfix'>");
                    msghtml.push("<div class='stat'>");
                    msghtml.push("<div class='title'>" + g_js_strings.commonstr.resourcefulness + "</div>");
                    msghtml.push("  <div class='number'>" + rslt.randomnums[0] + "</div>");
                    msghtml.push("  </div>");
                    msghtml.push("  <div class='stat'>");
                    msghtml.push("  <div class='title'>" + g_js_strings.commonstr.politics + "</div>");
                    msghtml.push("    <div class='number'>" + rslt.randomnums[1] + "</div>");
                    msghtml.push("  </div>");
                    msghtml.push("<div class='stat'>");
                    msghtml.push("  <div class='title'>" + g_js_strings.commonstr.combat + "</div>");
                    msghtml.push("  <div class='number'>" + rslt.randomnums[2] + "</div>");
                    msghtml.push("</div>");
                    msghtml.push("  <div class='stat'>");
                    msghtml.push("    <div class='title'>" + g_js_strings.commonstr.intelligence + "</div>");
                    msghtml.push("  <div class='number'>" + rslt.randomnums[3] + "</div>");
                    msghtml.push("  </div>");
                    msghtml.push("</div>");
                    msghtml.push("<center><div class='btnlink clearfix' ><a  class='button25' onclick='Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.ok + "</span></a></div></center>");
                    msghtml.push("</div>");
                    var newKnightObj = Object.clone(knighttemplate[1]);
                    newKnightObj.baseResourcefullness = rslt.baseskills.toString();
                    newKnightObj.basePolitics = rslt.baseskills.toString();
                    newKnightObj.baseCombat = rslt.baseskills.toString();
                    newKnightObj.baseIntelligence = rslt.baseskills.toString();
                    newKnightObj.resourcefulness = rslt.randomnums[0].toString();
                    newKnightObj.politics = rslt.randomnums[1].toString();
                    newKnightObj.combat = rslt.randomnums[2].toString();
                    newKnightObj.intelligence = rslt.randomnums[3].toString();
                    newKnightObj.cityId = currentcityid.toString();
                    newKnightObj.knightFbuid = "0";
                    newKnightObj.knightId = rslt.knightId.toString();
                    newKnightObj.knightLevel = rslt.klv.toString();
                    newKnightObj.experience = rslt.kexp.toString();
                    newKnightObj.skillPointsApplied = rslt.klv.toString();
                    newKnightObj.knightLordUserid = tvuid.toString();
                    newKnightObj.knightName = kname;
                    newKnightObj.pic_square = stimgUrl + "img/items/70/" + kid + ".jpg";
                    if (Object.isArray(seed.knights)) {
                        seed.knights = new Object
                    }
                    if (!seed.knights["city" + currentcityid]) {
                        seed.knights["city" + currentcityid] = new Object
                    }
                    seed.knights["city" + currentcityid]["knt" + rslt.knightId] = newKnightObj;
                    update_knights();
                    cm.InventoryView.removeItemFromInventory(kid);
                    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.appointknight, msghtml.join(""))
                } else {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                }
            },
            onFailure: function () {}
        })
    }
}

function modal_volunteer(iid) {
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    params.iid = iid;
    new Ajax.Request(g_ajaxpath + "ajax/volunteee.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                var units = new Hash(rslt.unitsGained);
                units.each(function (pair) {
                    var unitkey = pair.key.substring(4);
                    seed.units["city" + currentcityid]["unt" + unitkey] = parseInt(seed.units["city" + currentcityid]["unt" + unitkey]) + pair.value
                });
                seed.items["i" + iid] = parseInt(seed.items["i" + iid]) - 1;
                if (seed.items["i" + iid] == 0) {
                    $("modal_shop_items_3").removeChild($("modal_item_" + iid))
                } else {
                    $("modal_itemowned_" + iid).innerHTML = seed.items["i" + iid]
                }
                modal_volunteer_gain(rslt.unitsGained, iid)
            }
        },
        onFailure: function () {}
    })
}

function modal_chest_itemusage(iid) {
    var params = Object.clone(g_ajaxparams);
    params.iid = iid;
    new Ajax.Request(g_ajaxpath + "ajax/itemChest.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                seed.items["i" + iid] = parseInt(seed.items["i" + iid]) - 1;
                if (seed.items["i" + iid] == 0) {
                    if (parseInt(iid) == 10018) {
                        $("modal_shop_items_1").removeChild($("modal_item_" + iid))
                    } else {
                        $("modal_shop_items_5").removeChild($("modal_item_" + iid))
                    }
                } else {
                    $("modal_itemowned_" + iid).innerHTML = seed.items["i" + iid]
                }
                var msghtml = new Array();
                msghtml.push("<div class='volunteerpackagelist'>");
                msghtml.push("<div><b>" + g_js_strings.modal_chest_itemusage.itemsgained + "</b></div>");
                var items = Object.keys(rslt.items);
                msghtml.push("<table cellpadding='0' cellspacing='0'><tbody>");
                for (var i = 0; i < items.length; i++) {
                    var uid = items[i].split("i")[1];
                    msghtml.push("<tr><td><img src='");
                    msghtml.push(stimgUrl);
                    msghtml.push("img/items/70/");
                    msghtml.push(uid);
                    msghtml.push(".jpg?5c10831' style='width:30px;height:30px;'/></td><td class='unm'>");
                    msghtml.push(itemlist["i" + uid].name);
                    msghtml.push("</td><td class='gain'>x");
                    msghtml.push(rslt.items[items[i]]);
                    msghtml.push("</td></tr>");
                    seed.items["i" + uid] = (seed.items["i" + uid]) ? (parseInt(seed.items["i" + uid]) + parseInt(rslt.items[items[i]])) : parseInt(rslt.items[items[i]])
                }
                msghtml.push("</tbody></table>");
                if (parseInt(seed.tutorial.t1) == 11 && parseInt(iid) == 10020) {
                    msghtml.push("<div class='btnlink clearfix'><a  class='button25' onclick='closeConfirmFTE();return false;'><span>" + g_js_strings.commonstr.ok + "</span></a></div>");
                    tutorialAdvance(1, 12)
                } else {
                    msghtml.push("<div class='btnlink clearfix'><a  class='button25' onclick='Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.ok + "</span></a></div>")
                }
                msghtml.push("</div>");
                Modal.hideModal();
                Modal.showModal(500, 500, 10, 10, itemlist["i" + iid].name, msghtml.join(""))
            } else {}
        },
        onFailure: function () {}
    })
}

function closeConfirmFTE() {
    changeview_map($("mod_views_map"));
    Modal.hideModalAll();
    seed.tutorial.t1 = 12;
    tutorialCheck(12)
}

function modal_volunteer_gain(f, e) {
    var b = new Array();
    b.push("<div class='volunteerpackagelist'>");
    b.push("<div><b>" + g_js_strings.modal_volunteer_gain.unitsgained + "</b></div>");
    var a = Object.keys(f);
    b.push("<table cellpadding='0' cellspacing='0'><tbody>");
    for (var d = 0; d < a.length; d++) {
        var c = a[d].split("unit")[1];
        b.push("<tr><td><img src='");
        b.push(stimgUrl);
        b.push("img/units/unit_");
        b.push(c);
        b.push("_30_s34.jpg'/></td><td class='unm'>");
        b.push(unitcost["unt" + c][0]);
        b.push("</td><td class='gain'>");
        b.push(f[a[d]]);
        b.push("</td></tr>")
    }
    b.push("</tbody></table>");
    b.push("<div class='btnlink clearfix'><a  class='button25' onclick='Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.ok + "</span></a></div>");
    b.push("</div>");
    Modal.showModal(500, 500, 10, 10, itemlist["i" + e].name, b.join(""))
}

function modal_fertilize() {
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/fertilizePeople.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                seed.items.i351 = (parseInt(seed.items.i351) - 1).toString();
                Modal.hideModal();
                modal_myitems()
            }
        },
        onFailure: function () {}
    })
}

function modal_hypnotize() {
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/hypnotize.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                seed.items.i355 = (parseInt(seed.items.i355) - 1).toString();
                Modal.hideModal();
                modal_myitems();
                $("modal_shop_message").innerHTML = itemlist.i355.name + " used!";
                $("modal_shop_message").show()
            }
        },
        onFailure: function () {}
    })
}

function modal_myitems_use_chest(iid) {
    var params = Object.clone(g_ajaxparams);
    params.requestType = "DRAW_ITEM";
    params.itemId = iid;
    params.cid = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/medals.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                var medals = new Hash(rslt.medals);
                medals.each(function (pair) {
                    if (seed.items["i" + pair.key]) {
                        seed.items["i" + pair.key] = (parseInt(seed.items["i" + pair.key]) + parseInt(pair.value)).toString()
                    } else {
                        seed.items["i" + pair.key] = pair.value.toString()
                    }
                });
                seed.items["i" + iid] = parseInt(seed.items["i" + iid]) - 1;
                if (seed.items["i" + iid] == 0) {
                    $("modal_shop_items_5").removeChild($("modal_item_" + iid))
                } else {
                    $("modal_itemowned_" + iid).innerHTML = seed.items["i" + iid]
                }
                modal_myitems_use_chest_gain(rslt.medals, iid);
                addGainedItemsToInventory(rslt.medals)
            }
        },
        onFailure: function () {}
    })
}

function addGainedItemsToInventory(b) {
    var a = Object.keys(b);
    a.each(function (f) {
        var k = f;
        var c = jQuery("#modal_itemowned_" + k);
        var h = parseInt(itemlist["i" + k].category);
        if (c.size() > 0) {
            c.html(seed.items["i" + k])
        } else {
            var l = jQuery("#modal_shop_items_" + h);
            var d = renderItemBox(k).join("");
            l.append(d);
            if (l.css("display") != "none") {
                var g = parseInt($("modal_shop_page_list").select(".pagenum").length);
                var j = l.find(".item").size();
                var i = parseInt(Math.ceil(j / 9));
                if (i > g) {
                    var e = parseInt($("modal_shop_page_list").select(".curpage")[0].innerHTML);
                    modal_shop_pagelist(e, i);
                    jQuery("#modal_shop_page_next").show()
                }
            }
        }
    });
    cm.itemCleanup.exe()
}
var cm = cm || {};
cm.itemCleanup = function (a) {
    return {
        exe: function () {
            for (var b = 1; b < 7; b++) {
                var c = a("#modal_shop_items_" + b + " .item").length;
                if (c > 0) {
                    a("#modal_shop_items_" + b + " .noitem").remove()
                }
            }
        }
    }
}(jQuery);

function modal_myitems_use_mystery_chest(iid) {
    var l_self = this;
    var l_oldOnclick = l_self.onclick;
    var params = Object.clone(g_ajaxparams);
    params.chestId = iid;
    params.cid = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/useMysteryChest.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                var medals = new Hash(rslt.items);
                medals.each(function (pair) {
                    if (seed.items["i" + pair.key]) {
                        seed.items["i" + pair.key] = (parseInt(seed.items["i" + pair.key]) + parseInt(pair.value)).toString()
                    } else {
                        seed.items["i" + pair.key] = pair.value.toString()
                    }
                });
                seed.items["i" + iid] = parseInt(seed.items["i" + iid]) - 1;
                var l_elem = null;
                if (seed.items["i" + iid] == 0) {
                    jQuery("#modal_item_" + iid).remove()
                } else {
                    l_elem = $("modal_itemowned_" + iid);
                    if (l_elem) {
                        l_elem.innerHTML = seed.items["i" + iid]
                    }
                }
                modal_myitems_use_chest_gain(rslt.items, iid);
                addGainedItemsToInventory(rslt.items)
            }
            l_self.onclick = l_oldOnclick
        },
        onFailure: function () {}
    })
}

function modal_myitems_use_chest_gain(b, e) {
    var a = new Array();
    a.push("<div class='volunteerpackagelist'>");
    var d = Object.keys(b);
    a.push("<table cellpadding='0' cellspacing='0'><tbody>");
    for (var c = 0; c < d.length; c++) {
        var f = d[c];
        a.push("<tr><td><img src='");
        a.push(stimgUrl);
        a.push("img/items/70/");
        a.push(f);
        a.push(".jpg?5c10831'/></td><td class='unm'>");
        a.push(itemlist["i" + f].name);
        a.push("</td><td class='gain'>");
        a.push(b[d[c]]);
        a.push("</td></tr>")
    }
    a.push("</tbody></table>");
    a.push("<div class='btnlink clearfix'><a  class='button25' onclick='Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.ok + "</span></a></div>");
    a.push("</div>");
    Modal.showModal(500, 500, 10, 10, itemlist["i" + e].name, a.join(""))
}

function modal_reduce_troop_upkeep_use(iid) {
    var params = Object.clone(g_ajaxparams);
    params.iid = iid;
    new Ajax.Request(g_ajaxpath + "ajax/reduceTroopUpkeep.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (seed.playerEffects.length == 0) {
                    seed.playerEffects = new Object
                }
                var ut = unixtime();
                var bst = 28800;
                if (iid == 274) {
                    bst = 86400
                } else {
                    if (iid == 275) {
                        bst = 259200
                    }
                }
                if (!(parseInt(seed.playerEffects.troopUpkeepReductExp) > ut)) {
                    seed.playerEffects.troopUpkeepReductExp = ut
                }
                seed.playerEffects.troopUpkeepReductExp = parseInt(seed.playerEffects.troopUpkeepReductExp) + bst;
                seed.items["i" + iid] = parseInt(seed.items["i" + iid]) - 1;
                $("modal_itemowned_" + iid).innerHTML = seed.items["i" + iid];
                if (seed.items["i" + iid] == 0) {
                    $("modal_shop_items_3").removeChild($("modal_item_" + iid));
                    modal_fix_paginate(1)
                }
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                update_boosts();
                $("modal_shop_message").innerHTML = g_js_strings.modal_myitems_use_teleportprovince_do.aused.replace("%1$s", itemlist["i" + iid].name);
                $("modal_shop_message").show()
            }
        },
        onFailure: function () {}
    })
}

function modal_boost_combat_use(iid) {
    var params = Object.clone(g_ajaxparams);
    params.iid = iid;
    params.cid = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/boostCombat.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (seed.playerEffects.length == 0) {
                    seed.playerEffects = new Object
                }
                var ut = unixtime();
                var bst = 86400;
                var hours4 = 60 * 60 * 4;
                if (iid == 261 || iid == 262) {
                    if (!(parseInt(seed.playerEffects.atkExpire) > ut)) {
                        seed.playerEffects.atkExpire = ut
                    }
                    if (iid == 262) {
                        bst = 604800
                    }
                    seed.playerEffects.atkExpire = parseInt(seed.playerEffects.atkExpire) + bst
                } else {
                    if (iid == 271 || iid == 272) {
                        if (!(parseInt(seed.playerEffects.defExpire) > ut)) {
                            seed.playerEffects.defExpire = ut
                        }
                        if (iid == 272) {
                            bst = 604800
                        }
                        seed.playerEffects.defExpire = parseInt(seed.playerEffects.defExpire) + bst
                    } else {
                        if (iid == 280) {
                            if (!(parseInt(seed.playerEffects.atk2Expire) > ut)) {
                                seed.playerEffects.atk2Expire = ut
                            }
                            seed.playerEffects.atk2Expire = parseInt(seed.playerEffects.atk2Expire) + hours4;
                            if (seed.playerEffects.atkExpire && parseInt(seed.playerEffects.atkExpire) > ut) {
                                seed.playerEffects.atkExpire = parseInt(seed.playerEffects.atkExpire) + hours4
                            }
                        }
                    }
                }
                if (iid == 281) {
                    if (!(parseInt(seed.playerEffects.def2Expire) > ut)) {
                        seed.playerEffects.def2Expire = ut
                    }
                    seed.playerEffects.def2Expire = parseInt(seed.playerEffects.def2Expire) + hours4;
                    if (seed.playerEffects.defExpire && parseInt(seed.playerEffects.defExpire) > ut) {
                        seed.playerEffects.defExpire = parseInt(seed.playerEffects.defExpire) + hours4
                    }
                } else {
                    if (iid >= 276 && iid <= 278) {
                        bst = 3600 * Math.pow(2, (iid - 276));
                        if (!(parseInt(seed.playerEffects.loadExpire) > ut)) {
                            seed.playerEffects.loadExpire = ut
                        }
                        seed.playerEffects.loadExpire = parseInt(seed.playerEffects.loadExpire) + bst
                    } else {
                        if (iid == 279) {
                            bst = 3600;
                            if (!(parseInt(seed.playerEffects.returnExpire) > ut)) {
                                seed.playerEffects.returnExpire = ut
                            }
                            seed.playerEffects.returnExpire = parseInt(seed.playerEffects.returnExpire) + bst
                        }
                    }
                }
                seed.items["i" + iid] = parseInt(seed.items["i" + iid]) - 1;
                $("modal_itemowned_" + iid).innerHTML = seed.items["i" + iid];
                if (seed.items["i" + iid] == 0) {
                    $("modal_shop_items_3").removeChild($("modal_item_" + iid));
                    modal_fix_paginate(1)
                }
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                update_boosts();
                $("modal_shop_message").innerHTML = g_js_strings.modal_myitems_use_teleportprovince_do.aused.replace("%1$s", itemlist["i" + iid].name);
                $("modal_shop_message").show()
            }
        },
        onFailure: function () {}
    })
}

function modal_boost_production_use(iid) {
    var params = Object.clone(g_ajaxparams);
    params.iid = iid;
    params.cid = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/boostProduction.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (seed.playerEffects.length == 0) {
                    seed.playerEffects = new Object
                }
                var ut = unixtime();
                var bst = 86400;
                if (iid == 101 || iid == 102) {
                    if (!(parseInt(seed.playerEffects.r0BstExp) > ut)) {
                        seed.playerEffects.r0BstExp = ut
                    }
                    if (iid == 102) {
                        bst = 604800
                    }
                    seed.playerEffects.r0BstExp = parseInt(seed.playerEffects.r0BstExp) + bst
                }
                if (iid == 111 || iid == 112) {
                    if (!(parseInt(seed.playerEffects.r1BstExp) > ut)) {
                        seed.playerEffects.r1BstExp = ut
                    }
                    if (iid == 112) {
                        bst = 604800
                    }
                    seed.playerEffects.r1BstExp = parseInt(seed.playerEffects.r1BstExp) + bst
                }
                if (iid == 121 || iid == 122) {
                    if (!(parseInt(seed.playerEffects.r2BstExp) > ut)) {
                        seed.playerEffects.r2BstExp = ut
                    }
                    if (iid == 122) {
                        bst = 604800
                    }
                    seed.playerEffects.r2BstExp = parseInt(seed.playerEffects.r2BstExp) + bst
                }
                if (iid == 131 || iid == 132) {
                    if (!(parseInt(seed.playerEffects.r3BstExp) > ut)) {
                        seed.playerEffects.r3BstExp = ut
                    }
                    if (iid == 132) {
                        bst = 604800
                    }
                    seed.playerEffects.r3BstExp = parseInt(seed.playerEffects.r3BstExp) + bst
                }
                if (iid == 141 || iid == 142) {
                    if (!(parseInt(seed.playerEffects.r4BstExp) > ut)) {
                        seed.playerEffects.r4BstExp = ut
                    }
                    if (iid == 142) {
                        bst = 604800
                    }
                    seed.playerEffects.r4BstExp = parseInt(seed.playerEffects.r4BstExp) + bst
                }
                seed.items["i" + iid] = parseInt(seed.items["i" + iid]) - 1;
                $("modal_itemowned_" + iid).innerHTML = seed.items["i" + iid];
                if (seed.items["i" + iid] == 0) {
                    $("modal_shop_items_4").removeChild($("modal_item_" + iid));
                    modal_fix_paginate(3)
                }
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                update_boosts();
                $("modal_shop_message").innerHTML = g_js_strings.modal_myitems_use_teleportprovince_do.aused.replace("%1$s", itemlist["i" + iid].name);
                $("modal_shop_message").show()
            }
        },
        onFailure: function () {}
    })
}

function modal_myitems_use(iid) {
    if (parseInt(iid) > 1000 && parseInt(iid) < 1050) {
        var params = Object.clone(g_ajaxparams);
        params.iid = iid;
        params.cid = currentcityid;
        new Ajax.Request(g_ajaxpath + "ajax/resourceCrate.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    if (parseInt(rslt.rtype) == 0) {
                        seed.citystats["city" + currentcityid].gold[0] = parseInt(seed.citystats["city" + currentcityid].gold[0]) + parseInt(rslt.amt);
                        update_gold()
                    } else {
                        seed.resources["city" + currentcityid]["rec" + rslt.rtype][0] = parseInt(seed.resources["city" + currentcityid]["rec" + rslt.rtype][0]) + parseInt(rslt.amt) * 3600
                    }
                    seed.items["i" + iid] = parseInt(seed.items["i" + iid]) - 1;
                    $("modal_itemowned_" + iid).innerHTML = seed.items["i" + iid];
                    if (seed.items["i" + iid] == 0) {
                        $("modal_shop_items_4").removeChild($("modal_item_" + iid));
                        modal_fix_paginate(3)
                    }
                    $("modal_shop_message").innerHTML = g_js_strings.modal_myitems_use.aadded.replace("%1$s", itemlist["i" + iid].name);
                    $("modal_shop_message").show();
                    if (rslt.updateSeed) {
                        update_seed(rslt.updateSeed)
                    }
                }
            },
            onFailure: function () {}
        })
    }
}

function modal_myitems_getmoreitems() {
    var a = parseInt($("modal_shop_body").getAttribute("name")) + 1;
    Modal.hideModalAll();
    cm.ShopView.openShop(a)
}

function modal_shop(c) {
    cm.ShopView.openShop(c);
    return;
    var b = new Array();
    b.push("<div class='modal_shop_container'>");
    b.push("<div id='modal_shop_body'>");
    b.push("</div></div>");
    if (c) {
        var a = c
    } else {
        var a = 0
    }
    Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.shop, b.join(""), modal_shop_load, a)
}

function modal_shop_load(tab) {
    var params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/showShop.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (rslt.data.gems) {
                    seed.player.gems = rslt.data.gems;
                    $("kochead_gems").innerHTML = rslt.data.gems
                }
                if (rslt.data.inventory) {
                    seed.player.items = rslt.data.inventory
                }
                var shophtml = new Array();
                var stab_featured = new Array();
                var stab_speed = new Array();
                var stab_prod = new Array();
                var stab_chest = new Array();
                var stab_gen = new Array();
                var stab_court = new Array();
                var stab_attack = new Array();
                var datakeys = rslt.data.shopOrder;
                var featuredOrder = rslt.data.featuredOrder;
                var featuredInfo = rslt.data.featureInfo;
                for (var i = 0; i < datakeys.length; i++) {
                    if (itemlist["i" + datakeys[i]]) {
                        var cat = parseInt(itemlist["i" + datakeys[i]].category);
                        var itemNew = false;
                        var itemSale = false;
                        var ut = unixtime();
                        if (featuredOrder) {
                            if (featuredOrder.indexOf(parseInt(datakeys[i])) != -1) {
                                var newExpire = parseInt(featuredInfo["i" + datakeys[i]][0]);
                                var saleStart = parseInt(featuredInfo["i" + datakeys[i]][1]);
                                var saleEnd = parseInt(featuredInfo["i" + datakeys[i]][2]);
                                var salePrice = parseInt(featuredInfo["i" + datakeys[i]][3]);
                                if (newExpire > 0 && (ut < newExpire)) {
                                    itemNew = true
                                } else {
                                    if (saleStart > 0 && saleStart < ut && saleEnd > 0 && saleEnd > ut) {
                                        itemSale = true
                                    }
                                }
                            }
                        }
                        var item = new Array();
                        item.push('<div class="item');
                        if (itemNew) {
                            item.push(" newitem")
                        } else {
                            if (itemSale) {
                                item.push(" saleitem")
                            }
                        }
                        item.push('" id="modal_item_');
                        item.push(datakeys[i]);
                        item.push('" onmouseover="modal_shop_tooltip(this,event);return false;" onmouseout="removeTooltip();return false;" name="');
                        item.push(itemlist["i" + datakeys[i]].description);
                        item.push('">');
                        item.push("<div class='itemname'>");
                        item.push(itemlist["i" + datakeys[i]].name);
                        item.push("</div>");
                        item.push("<div class='clearfix iteminfo'>");
                        item.push("<img src='");
                        item.push(stimgUrl);
                        item.push("img/items/70/");
                        item.push(datakeys[i]);
                        item.push(".jpg?5c10831'/>");
                        item.push("<div class='itemprice'>");
                        if (itemSale) {
                            item.push("<span class='saleprice'>" + salePrice + "</span>")
                        }
                        item.push("<span class='oldprice' id='modal_itemprice_");
                        item.push(datakeys[i]);
                        item.push("'>");
                        item.push(itemlist["i" + datakeys[i]].price);
                        item.push("</span><img src='");
                        item.push(stimgUrl);
                        item.push("img/gem.png'/></div>");
                        if (parseInt(datakeys[i]) == 10019) {
                            item.push("<div class='buyitem'><a onclick='modal_shop_buy_gift(")
                        } else {
                            item.push("<div class='buyitem'><a onclick='modal_shop_buy(")
                        }
                        item.push(datakeys[i]);
                        if (itemSale) {
                            item.push("," + salePrice)
                        }
                        item.push(");return false;' class='buttonGreen20'><span>" + g_js_strings.commonstr.buyitem + "</span></a></div>");
                        if (parseInt(datakeys[i]) != 10019) {
                            item.push("<div class='itemowned'>" + g_js_strings.commonstr.owned + ": <span class='modal_itemowned_" + datakeys[i] + "' id='modal_itemowned_");
                            item.push(datakeys[i]);
                            item.push("'>");
                            item.push(seed.items["i" + datakeys[i]] || "0");
                            item.push("</span></div>")
                        }
                        item.push("</div>");
                        item.push("</div>");
                        var itemhd = new Array();
                        if (parseInt(datakeys[i]) == 599 || parseInt(datakeys[i]) == 10018 || parseInt(datakeys[i]) == 10019) {
                            itemhd.push(item.join(""))
                        }
                        if (itemNew || itemSale) {
                            if (!(cat == 6 && seed.items["i" + datakeys[i]] && parseInt(seed.items["i" + datakeys[i]]) > 0)) {
                                if (itemhd.length > 0) {
                                    stab_featured = itemhd.concat(stab_featured)
                                } else {
                                    stab_featured.push(item.join(""))
                                }
                            }
                        }
                        if (cat == 1) {
                            if (itemhd.length > 0) {
                                stab_gen = itemhd.concat(stab_gen)
                            } else {
                                stab_gen.push(item.join(""))
                            }
                        } else {
                            if (cat == 2) {
                                if (itemhd.length > 0) {
                                    stab_speed = itemhd.concat(stab_speed)
                                } else {
                                    stab_speed.push(item.join(""))
                                }
                            } else {
                                if (cat == 3) {
                                    if (itemhd.length > 0) {
                                        stab_attack = itemhd.concat(stab_attack)
                                    } else {
                                        stab_attack.push(item.join(""))
                                    }
                                } else {
                                    if (cat == 4) {
                                        if (itemhd.length > 0) {
                                            stab_prod = itemhd.concat(stab_prod)
                                        } else {
                                            stab_prod.push(item.join(""))
                                        }
                                    } else {
                                        if (cat == 5) {
                                            if (itemhd.length > 0) {
                                                stab_chest = itemhd.concat(stab_chest)
                                            } else {
                                                stab_chest.push(item.join(""))
                                            }
                                        } else {
                                            if (cat == 6) {
                                                if (!seed.items["i" + datakeys[i]] || parseInt(seed.items["i" + datakeys[i]]) == 0) {
                                                    if (itemhd.length > 0) {
                                                        stab_court = itemhd.concat(stab_court)
                                                    } else {
                                                        stab_court.push(item.join(""))
                                                    }
                                                }
                                            } else {
                                                if (itemhd.length > 0) {
                                                    stab_gen = itemhd.concat(stab_gen)
                                                } else {
                                                    stab_gen.push(item.join(""))
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                var gi = new Array();
                gi.push("<div class='mygems'>" + g_js_strings.commonstr.gems + ":<span id='modal_shop_gems'>");
                gi.push(rslt.data.gems);
                gi.push("</span><img src='");
                gi.push(stimgUrl);
                gi.push("img/gem.png'/></div>");
                gi.push("<div class='getgems clearfix'><a onclick='cm.ConversionTracker.track(\"payments\", \"MORE_GEMS_SHOP\", \"\");modal_getgems();return false;' class='buttonGreen20'><span>+&nbsp;&nbsp;" + g_js_strings.modaltitles.getmoregems + "</span></a></div>");
                $("modal_shop_body").setAttribute("name", 1);
                shophtml.push("<div class='modal_shop_hd'>");
                shophtml.push("<div id='geminfo' class='geminfo'></div>");
                shophtml.push("<div class='gotoshop'><a  class='button20' onclick='Modal.hideModalAll();cm.InventoryView.openInventory();return false;'><span>" + g_js_strings.commonstr.inventory + "</span></a></div>");
                shophtml.push("</div>");
                shophtml.push("<div class='modal_shop_body'>");
                shophtml.push("<div class='tabsbar clearfix' id='modal_shop_tabs'>");
                shophtml.push("<a  id='modal_shop_tab1' onclick='modal_shop_changetab(1);return false;' class='tab featuredtab selected'><span>" + g_js_strings.commonstr.featured + "</span></a>");
                shophtml.push("<a  id='modal_shop_tab2' onclick='modal_shop_changetab(2);return false;' class='tab'><span>" + g_js_strings.commonstr.general + "</span></a>");
                shophtml.push("<a  id='modal_shop_tab3' onclick='modal_shop_changetab(3);return false;' class='tab'><span>" + g_js_strings.commonstr.speedup + "</span></a>");
                shophtml.push("<a  id='modal_shop_tab4' onclick='modal_shop_changetab(4);return false;' class='tab'><span>" + g_js_strings.commonstr.combat + "</span></a>");
                shophtml.push("<a  id='modal_shop_tab5' onclick='modal_shop_changetab(5);return false;' class='tab'><span>" + g_js_strings.commonstr.resources + "</span></a>");
                shophtml.push("<a  id='modal_shop_tab6' onclick='modal_shop_changetab(6);return false;' class='tab'><span>" + g_js_strings.commonstr.chest + "</span></a>");
                shophtml.push("<a  id='modal_shop_tab7' onclick='modal_shop_changetab(7);return false;' class='tab'><span>" + g_js_strings.commonstr.court + "</span></a>");
                shophtml.push("</div>");
                shophtml.push("<div id='modal_shop_message' style='display:none;'></div>");
                if (cm.WorldSettings.hasKeyValuePair("MIGRATION1", "true")) {
                    if (seed.platform.type == "kabam") {
                        shophtml.push("<div id='modal_shop_paginate' style='display:none;'><div class='comingSoonText'>Buy new and exclusive items at Kabam.com!</div>" + g_js_strings.commonstr.page + ":</span> <span id='modal_shop_page_list'></span></div>")
                    } else {
                        shophtml.push("<div id='modal_shop_paginate' style='display:none;'><div class='comingSoonText'><a style='text-decoration: underline;' href='" + seed.platform.url + "' target='_top'>Buy new and exclusive items at Kabam.com!</a></div>" + g_js_strings.commonstr.page + ":</span> <span id='modal_shop_page_list'></span></div>")
                    }
                } else {
                    shophtml.push("<div id='modal_shop_paginate' class='old' style='display:none;'><div class='comingSoonText'> " + g_js_strings.modal_shop_buy_banner.banner_7thcityhere + " </div>" + g_js_strings.commonstr.page + ":</span> <span id='modal_shop_page_list'></span></div>")
                }
                shophtml.push("<div class='itemlistboxwrap'>");
                shophtml.push("<a id='modal_shop_page_prev' onclick='modal_shop_prevpage();return false;'></a>");
                shophtml.push("<a id='modal_shop_page_next' onclick='modal_shop_nextpage();return false;'></a>");
                shophtml.push("<div class='itemlistbox'>");
                shophtml.push("<div class='itemlist clearfix' id='modal_shop_items_1'>");
                shophtml.push(stab_featured.join(""));
                shophtml.push("</div>");
                shophtml.push("<div class='itemlist clearfix' id='modal_shop_items_2' style='display:none;'>");
                shophtml.push(stab_gen.join(""));
                shophtml.push("</div>");
                shophtml.push("<div class='itemlist clearfix' id='modal_shop_items_3' style='display:none;'>");
                shophtml.push(stab_speed.join(""));
                shophtml.push("</div>");
                shophtml.push("<div class='itemlist clearfix' id='modal_shop_items_4' style='display:none;'>");
                shophtml.push(stab_attack.join(""));
                shophtml.push("</div>");
                shophtml.push("<div class='itemlist clearfix' id='modal_shop_items_5' style='display:none;'>");
                shophtml.push(stab_prod.join(""));
                shophtml.push("</div>");
                shophtml.push("<div class='itemlist clearfix' id='modal_shop_items_6' style='display:none;'>");
                shophtml.push(stab_chest.join(""));
                shophtml.push("</div>");
                shophtml.push("<div class='itemlist clearfix' id='modal_shop_items_7' style='display:none;'>");
                shophtml.push(stab_court.join(""));
                shophtml.push("</div>");
                shophtml.push("</div>");
                shophtml.push("</div>");
                shophtml.push("</div>");
                $("modal_shop_body").innerHTML = shophtml.join("");
                $("geminfo").innerHTML = gi.join("");
                modal_shop_pageinit(1);
                if (tab > 0) {
                    modal_shop_changetab(tab)
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function getShopPixel() {
    return;
    window.google_conversion_id = 1059019849;
    window.google_conversion_language = "en";
    window.google_conversion_format = "3";
    window.google_conversion_color = "666666";
    window.google_conversion_label = "p1zQCKvv5gEQybj9-AM";
    window.google_conversion_value = 0;
    var a = document.createElement("script");
    a.type = "text/javascript";
    a.src = "https://www.googleadservices.com/pagead/conversion.js?v=shop";
    document.getElementsByTagName("head")[0].appendChild(a)
}

function modal_shop_tooltip(b, a) {
    showTooltip(b.getAttribute("name"), b, a, "modal_shop_body")
}

function modal_shop_pageinit(b) {
    var c = $("modal_shop_items_" + b).select(".item").length;
    if (c > 9) {
        var a = parseInt(c / 9);
        if (a < (c / 9)) {
            a++
        }
        modal_shop_pagelist(1, a);
        $("modal_shop_page_prev").hide();
        $("modal_shop_page_next").show();
        $("modal_shop_paginate").show();
        $("modal_shop_items_" + b).style.top = "0px"
    } else {
        modal_shop_pagelist(1, 1);
        $("modal_shop_paginate").show();
        $("modal_shop_page_prev").hide();
        $("modal_shop_page_next").hide()
    }
}

function modal_shop_pagelist(d, c) {
    var b = new Array();
    for (var a = 1; a <= c; a++) {
        if (d == a) {
            b.push("<span class='curpage pagenum'>" + a + "</span>")
        } else {
            b.push("<a class='linkpage pagenum' onclick='modal_shop_gotopage(" + a + "," + c + ");return false;'>" + a + "</a>")
        }
        if (a != c) {
            b.push(" | ")
        }
    }
    $("modal_shop_page_list").innerHTML = b.join("")
}

function modal_shop_gotopage(e, d) {
    var b = $("modal_shop_body").getAttribute("name");
    var a = d;
    var c = e;
    $("modal_shop_items_" + b).style.top = (-360 * (c - 1)) + "px";
    if (c == 1) {
        $("modal_shop_page_prev").hide()
    } else {
        $("modal_shop_page_prev").show()
    }
    if (c == a) {
        $("modal_shop_page_next").hide()
    } else {
        $("modal_shop_page_next").show()
    }
    $("modal_shop_message").hide();
    modal_shop_pagelist(c, a)
}

function modal_shop_nextpage() {
    var b = $("modal_shop_body").getAttribute("name");
    var a = parseInt($("modal_shop_page_list").select(".pagenum").length);
    var c = parseInt($("modal_shop_page_list").select(".curpage")[0].innerHTML);
    c++;
    $("modal_shop_items_" + b).style.top = (-360 * (c - 1)) + "px";
    $("modal_shop_page_prev").show();
    if (c == a) {
        $("modal_shop_page_next").hide()
    }
    $("modal_shop_message").hide();
    modal_shop_pagelist(c, a)
}

function modal_shop_prevpage() {
    var b = $("modal_shop_body").getAttribute("name");
    var a = parseInt($("modal_shop_page_list").select(".pagenum").length);
    var c = parseInt($("modal_shop_page_list").select(".curpage")[0].innerHTML);
    c--;
    $("modal_shop_items_" + b).style.top = (-360 * (c - 1)) + "px";
    $("modal_shop_page_next").show();
    if (c == 1) {
        $("modal_shop_page_prev").hide()
    }
    $("modal_shop_message").hide();
    modal_shop_pagelist(c, a)
}

function modal_shop_changetab(b) {
    $("modal_shop_message").hide();
    var a = $("modal_shop_body").getAttribute("name");
    $("modal_shop_tabs").select(".selected")[0].removeClassName("selected");
    $("modal_shop_tab" + b).addClassName("selected");
    $("modal_shop_body").setAttribute("name", b);
    $("modal_shop_items_" + a).hide();
    $("modal_shop_items_" + b).show();
    modal_shop_pageinit(b)
}

function modal_shop_buy_gift(c) {
    var b = parseInt($("modal_itemprice_" + c).innerHTML);
    if (b > seed.player.gems) {
        modal_shop_buy_notenough()
    } else {
        var a = new Array();
        a.push("<div class='giftnameconfirm'>");
        a.push("<div class='desc'>");
        a.push(g_js_strings.modal_shop_buy_gift.entername);
        a.push("</div>");
        a.push("<div class='cost'>");
        a.push(g_js_strings.commonstr.cost + ": " + b + " " + g_js_strings.commonstr.gems);
        a.push("</div>");
        a.push("<div id='nameinputerror' style='display:none;'>");
        a.push(g_js_strings.modal_shop_buy_gift.nameerror);
        a.push("</div>");
        a.push("<div class='nameinput'>");
        a.push("<input value='' id='giftplayername'/>");
        a.push("</div>");
        a.push("<div class='btnrow clearfix'>");
        a.push("<a class='button20' onclick='modal_shop_buy_gift_player_check(" + c + ");return false;'><span>" + g_js_strings.commonstr.gift + "</span></a>");
        a.push("<a class='button20' onclick='Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a>");
        a.push("</div>");
        a.push("</div>");
        Modal.showModal(400, 400, 130, 10, g_js_strings.modaltitles.giftitem, a.join(""))
    }
}

function modal_shop_buy_gift_player_check(itemid) {
    var giftee = $("giftplayername").value;
    if (giftee.blank()) {
        $("nameinputerror").show();
        return false
    } else {
        var params = Object.clone(g_ajaxparams);
        params.name = giftee;
        new Ajax.Request(g_ajaxpath + "ajax/checkUser.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (message) {
                var rslt = eval("(" + message.responseText + ")");
                if (rslt.ok) {
                    $("nameinputerror").hide();
                    Modal.hideModal();
                    var gifthtml = new Array();
                    gifthtml.push("<div class='giftnameconfirm'>");
                    gifthtml.push("<div class='desc'>");
                    gifthtml.push(g_js_strings.modal_shop_buy_gift_player_check.confirmgift.replace("%1$s", giftee));
                    gifthtml.push("</div>");
                    gifthtml.push("<div class='btnrow clearfix'>");
                    gifthtml.push("<a class='button20' onclick='modal_shop_buy_gift_do(" + itemid + "," + rslt.data + ");return false;'><span>" + g_js_strings.commonstr.gift + "</span></a>");
                    gifthtml.push("<a class='button20' onclick='Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a>");
                    gifthtml.push("</div>");
                    gifthtml.push("</div>");
                    Modal.showModal(400, 400, 130, 10, g_js_strings.modaltitles.giftitem, gifthtml.join(""))
                } else {
                    $("nameinputerror").show()
                }
            },
            onFailure: function () {}
        })
    }
}

function modal_shop_buy_gift_do(itemid, pid) {
    var itemcost = parseInt($("modal_itemprice_" + itemid).innerHTML);
    var params = Object.clone(g_ajaxparams);
    params.rid = pid;
    params.iid = itemid;
    new Ajax.Request(g_ajaxpath + "ajax/sendPackage.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                Modal.hideModal();
                seed.player.gems = seed.player.gems - itemcost;
                $("kochead_gems").innerHTML = seed.player.gems;
                $("modal_shop_gems").innerHTML = seed.player.gems;
                $("modal_shop_message").innerHTML = g_js_strings.modal_shop_buy.purchasealert.replace("%1$s", $("modal_item_" + itemid).select(".itemname")[0].innerHTML);
                $("modal_shop_message").show();
                cm.MixPanelTracker.track("store_purchase", {
                    item: itemlist["i" + itemid].name,
                    cost: itemcost,
                    usr_gen: seed.player.g,
                    usr_byr: seed.player.y,
                    usr_ttl: titlenames[seed.player.title],
                    distinct_id: tvuid
                })
            } else {
                $("nameinputerror").show()
            }
        },
        onFailure: function () {}
    })
}

function modal_shop_buy(itemid, saleprice, redisplaySpeedUpModal, e) {
    if (saleprice) {
        var itemcost = parseInt(saleprice)
    } else {
        var itemcost = parseInt($("modal_itemprice_" + itemid).innerHTML)
    }
    var iid = itemid;
    if (itemcost > seed.player.gems) {
        modal_shop_buy_notenough()
    } else {
        var selsub = $("modal_item_" + iid);
        if (selsub) {
            selsub.select(".buyitem")[0].hide()
        }
        var targetElement;
        if (e) {
            targetElement = e.srcElement || e.currentTarget;
            targetElement = targetElement.tagName.toLowerCase() === "a" ? targetElement : targetElement.parentNode;
            $(targetElement).setStyle({
                visibility: "hidden"
            })
        }
        var params = Object.clone(g_ajaxparams);
        params.iid = iid;
        if (saleprice) {
            params.sale = 1
        }
        var profiler = new cm.Profiler("ResponseTime", "buyItem.php");
        new Ajax.Request(g_ajaxpath + "ajax/buyItem.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (message) {
                profiler.stop();
                var rslt = eval("(" + message.responseText + ")");
                if (rslt.ok) {
                    var ownedboxes, quant, inShop;
                    inShop = $("modal_item_" + iid);
                    if ($("modal_item_" + iid)) {
                        $("modal_item_" + iid).select(".buyitem")[0].show();
                        ownedboxes = $("modal_shop_body").select(".modal_itemowned_" + iid);
                        quant = parseInt(ownedboxes[0].innerHTML)
                    }
                    seed.player.gems = seed.player.gems - itemcost;
                    var xi = seed.items["i" + iid];
                    if (isNaN(xi)) {
                        seed.items["i" + iid] = 0
                    }
                    seed.items["i" + iid] = parseInt(seed.items["i" + iid]) + 1;
                    ksoItems[iid].add();
                    if (inShop) {
                        for (var i = 0; i < ownedboxes.length; i++) {
                            ownedboxes[i].innerHTML = quant + 1
                        }
                    }
                    $("kochead_gems").innerHTML = seed.player.gems;
                    if (inShop) {
                        $("modal_shop_gems").innerHTML = seed.player.gems;
                        $("modal_shop_message").innerHTML = g_js_strings.modal_shop_buy.purchasealert.replace("%1$s", $("modal_item_" + iid).select(".itemname")[0].innerHTML);
                        $("modal_shop_message").show()
                    }
                    if (cm.BuyOnceItems.match(iid)) {
                        $("modal_item_" + iid).remove()
                    } else {
                        if (iid == 10018) {
                            $("modal_item_10018").remove();
                            common_postToProfile("20", Object.clone(template_data_20), Object.clone(actionlink_data_20), continuation_20, new Array())
                        }
                    }
                    if (iid == 2) {
                        if (seed.player.spentFiveGems && seed.player.spentFiveGems == 0) {
                            seed.player.spentFiveGems = 1
                        }
                    }
                    cm.MixPanelTracker.track("store_purchase", {
                        item: itemlist["i" + iid].name,
                        cost: itemcost,
                        usr_gen: seed.player.g,
                        usr_byr: seed.player.y,
                        usr_ttl: titlenames[seed.player.title],
                        distinct_id: tvuid
                    });
                    if (redisplaySpeedUpModal) {
                        cm.speedUpModalTimer.redisplayModal()
                    }
                    if (targetElement) {
                        $(targetElement).setStyle({
                            visibility: ""
                        })
                    }
                } else {
                    if (rslt.error_code && rslt.error_code == 701) {
                        var txt = g_js_strings.modal_shop_buy.nolongersale.replace("%1$s", rslt.feedback);
                        var btns = "<a class='button20' onclick='Modal.hideModal();modal_shop_buy(" + iid + ");return false;'>";
                        btns += "<span>";
                        btns += g_js_strings.commonstr.buy;
                        btns += "</span>";
                        btns += "</a>";
                        btns += "<a class='button20' onclick='$(\"modal_item_" + iid + '").select(".buyitem")[0].show();Modal.hideModal();return false;\'>';
                        btns += "<span>";
                        btns += g_js_strings.commonstr.cancel;
                        btns += "</span>";
                        btns += "</a>";
                        Modal.showAlert(txt, btns)
                    } else {
                        Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                    }
                }
            },
            onFailure: function () {
                profiler.stop()
            }
        })
    }
}

function modal_shop_buy_notenough() {
    var a = new Array();
    a.push("<div id='modal_shop_buy_notenough'><div class='infobx'><div class='tp'>" + g_js_strings.modal_shop_buy_notenough.notenoughgems + "</div><div>" + g_js_strings.modal_shop_buy_notenough.thatsokay + "</div><div class='clearfix btn'><a  class='button20' onclick='Modal.hideModal();modal_getgems();return false;'><span>" + g_js_strings.modal_shop_buy_notenough.getmoregems + "</span></a></div></div></div>");
    Modal.showModal(500, 400, 130, 10, g_js_strings.modaltitles.getmoregems, a.join(""))
}

function modal_fix_paginate(b) {
    var a = $("modal_shop_items_" + b).select(".item").length;
    if (a % 9 == 0 && a > 8) {
        Modal.hideModal();
        modal_myitems(b)
    }
}
cm.BuyOnceItems = new function () {
    this.match = function (a) {
        return a > 700 && a < 900 || a >= 1202 && a <= 1210
    }
};
(function (a) {
    a.fn.soundView = function (b) {
        var c = {
            music: true,
            effects: true
        };
        var d = {
            music: true,
            effects: true
        };
        var e = false;
        var g = a.extend({}, c, b);
        var k = function () {
                e = !e;
                if (e) {
                    a(".sfx_effects").slideDown();
                    a(".sfx_music").slideDown();
                    a(".sfx_mech").removeClass("closed")
                } else {
                    a(".sfx_effects").slideUp();
                    a(".sfx_music").slideUp();
                    a(".sfx_mech").addClass("closed")
                }
                f()
            };
        var i = function () {
                a(".sfx_mech").unbind().bind("click", k);
                a(".sfx_effects.off").unbind().bind("click", function () {
                    if (typeof g.effects_click_on == "function") {
                        g.effects_click_on()
                    }
                    d.effects = true;
                    f();
                    i()
                });
                a(".sfx_effects.on").unbind().bind("click", function () {
                    if (typeof g.effects_click_off == "function") {
                        g.effects_click_off()
                    }
                    d.effects = false;
                    f();
                    i()
                });
                a(".sfx_music.off").unbind().bind("click", function () {
                    if (typeof g.music_click_on == "function") {
                        g.music_click_on()
                    }
                    d.music = true;
                    h();
                    i()
                });
                a(".sfx_music.on").unbind().bind("click", function () {
                    if (typeof g.music_click_off == "function") {
                        g.music_click_off()
                    }
                    d.music = false;
                    h();
                    i()
                })
            };
        var f = function () {
                if (d.effects) {
                    a(".sfx_effects").removeClass("off").addClass("on")
                } else {
                    a(".sfx_effects").removeClass("on").addClass("off")
                }
            };
        var h = function () {
                if (d.music) {
                    a(".sfx_music").removeClass("off").addClass("on")
                } else {
                    a(".sfx_music").removeClass("on").addClass("off")
                }
            };
        var j = function () {
                a(".sfx_effects").hide();
                a(".sfx_music").hide();
                a(".sfx_mech").addClass("closed")
            };
        return this.each(function () {
            d.effects = g.effects;
            d.music = g.music;
            a(this).html("<div class='sfx_mech'></div><div class='sfx_effects'></div><div class='sfx_music'></div>");
            j();
            f();
            h();
            i()
        })
    }
})(jQuery);
(function (b) {
    var c = {};
    var a = "";
    c.get = function () {
        var d = [];
        b("script").each(function (e, g) {
            var f = g.src || g.href;
            if (f) {
                var h = f.lastIndexOf("/") + 1;
                a = f.substr(0, h);
                d[d.length] = f.substr(h)
            }
        });
        return d.sort()
    };
    c.load = function () {
        var d = {};
        return {
            redo: function () {
                c.load.go(d.url)
            },
            go: function (f) {
                d = {
                    url: f
                };
                var e = a + f;
                var g = false;
                if (e.indexOf(".css") > -1) {
                    g = true
                }
                var h = {
                    url: e + "?r=" + parseInt(Math.random() * 1000000),
                    success: function (i) {
                        if (g) {
                            b("body").append("<style>" + i + "</style>")
                        }
                        c.display.success()
                    }
                };
                if (!g) {
                    h.dataType = "script"
                }
                c.display.loading();
                b.ajax(h)
            }
        }
    }();
    c.display = function () {
        function d() {
            return "<select>" + c.get().reduce(function (f, e) {
                return f + (e ? ("<option value='" + e + "'>" + e + "</option>") : "")
            }, "") + "</select>"
        }
        return {
            init: function () {
                if (cm.util.live()) {
                    return false
                }
                var e = "paschwanden09";
                if (window.location.href.indexOf(e) > -1) {
                    b("body").append("<div class='js_loader' style='font-size: 14px; background-color: #eeeeee;position: absolute; margin-top: 1200px; padding: 15px; border: 1px solid black;z-index: 1000000; left: 0px; top: 0px;'><input type='button' style='color: black;' value='Release Current Guardian' onclick='cm.guardianModalModel.release()' />" + d() + "<input type='button' value='Redo' class='redo' /><div class='success' style='border: 1px solid green; background-color: #EEEEEE; padding: 5px;'></div>tvuid=" + tvuid + "</div>");
                    b(".js_loader").draggable();
                    c.control()
                }
            },
            loading: function () {
                b(".js_loader .success").html("loading...")
            },
            success: function () {
                b(".js_loader .success").html("success")
            }
        }
    }();
    c.control = function () {
        b(".js_loader select").bind("change", function () {
            var d = b(this).val();
            c.load.go(d)
        });
        b(".js_loader .redo").unbind("click").bind("click", c.load.redo)
    };
    b(document).ready(c.display.init)
})(jQuery);

function jsonT(self, rules) {
    var T = {
        output: false,
        init: function () {
            for (var rule in rules) {
                if (rule.substr(0, 4) != "self") {
                    rules["self." + rule] = rules[rule]
                }
            }
            return this
        },
        apply: function (expr) {
            var trf = function (s) {
                    return s.replace(/{([A-Za-z0-9_\$\.\[\]\'@\(\)]+)}/g, function ($0, $1) {
                        return T.processArg($1, expr)
                    })
                },
                x = expr.replace(/\[[0-9]+\]/g, "[*]"),
                res;
            if (x in rules) {
                if (typeof (rules[x]) == "string") {
                    res = trf(rules[x])
                } else {
                    if (typeof (rules[x]) == "function") {
                        res = trf(rules[x](eval(expr)).toString())
                    }
                }
            } else {
                res = T.eval(expr)
            }
            return res
        },
        processArg: function (arg, parentExpr) {
            var expand = function (a, e) {
                    return (e = a.replace(/^\$/, e)).substr(0, 4) != "self" ? ("self." + e) : e
                },
                res = "";
            T.output = true;
            if (arg.charAt(0) == "@") {
                res = eval(arg.replace(/@([A-za-z0-9_]+)\(([A-Za-z0-9_\$\.\[\]\']+)\)/, function ($0, $1, $2) {
                    return "rules['self." + $1 + "'](" + expand($2, parentExpr) + ")"
                }))
            } else {
                if (arg != "$") {
                    res = T.apply(expand(arg, parentExpr))
                } else {
                    res = T.eval(parentExpr)
                }
            }
            T.output = false;
            return res
        },
        eval: function (expr) {
            var v = eval(expr),
                res = "";
            if (typeof (v) != "undefined") {
                if (v instanceof Array) {
                    for (var i = 0; i < v.length; i++) {
                        if (typeof (v[i]) != "undefined") {
                            res += T.apply(expr + "[" + i + "]")
                        }
                    }
                } else {
                    if (typeof (v) == "object") {
                        for (var m in v) {
                            if (typeof (v[m]) != "undefined") {
                                res += T.apply(expr + "." + m)
                            }
                        }
                    } else {
                        if (T.output) {
                            res += v
                        }
                    }
                }
            }
            return res
        }
    };
    return T.init().apply("self")
};
var KB = {
    Browser: (function () {
        var f = navigator.userAgent.toLowerCase(),
            b = 0,
            a = false,
            d = false,
            c = false,
            h = false;
        if (f.match("chrome")) {
            a = true;
            b = Number(f.split("chrome/")[1].split(".")[0])
        } else {
            if (f.match("safari")) {
                d = true;
                try {
                    b = Number(f.split("version/")[1].split(".")[0])
                } catch (g) {}
            } else {
                if (f.match("firefox")) {
                    c = true;
                    b = Number(f.split("firefox/")[1].split(".")[0]);
                    b += Number(f.split("firefox/")[1].split(".")[1]) * 0.1
                } else {
                    if (f.match("msie")) {
                        h = true;
                        b = Number(f.split("msie ")[1].split(".")[0])
                    }
                }
            }
        }
        return {
            Chrome: a,
            Safari: d,
            Firefox: c,
            IE: h,
            WebKit: d || a,
            Version: b,
            hasLocalStorage: (function () {
                try {
                    if ("localStorage" in window && window.localStorage !== null) {
                        return true
                    }
                } catch (i) {
                    return false
                }
            }()),
            hasAudio: !! document.createElement("audio").canPlayType
        }
    }())
};
KB.Sound = {};
KB.Sound.DEFAULT_VOLUME = 100;
KB.Sound.SOURCE_DIRECTORY = stimgUrl + "sounds/";
KB.SoundFactory = {
    getSound: function (c, a) {
        a = a || {};
        if ( !! document.createElement("audio").canPlayType) {
            if (KB.Browser.Firefox) {
                a.extension = ".ogg";
                return new KB.HTML5Sound(c, a)
            } else {
                a.extension = ".mp3";
                try {
                    return new KB.HTML5Sound(c, a)
                } catch (b) {
                    cm.log.l(b)
                }
                return null
            }
        } else {
            if (KB.Browser.IE && KB.Browser.Version <= 8) {
                a.extension = ".mp3";
                return new KB.EmbedSound(c, a)
            } else {
                return null
            }
        }
    }
};
KB.EmbedSound = function (f, n) {
    var k = this,
        d, o, l, i, e, h, m, c, b, g, a, j;
    this.audio = null;
    this.volume = null;
    this.duration = null;
    this.velocity = null;
    this.play = function () {
        try {
            if (d && g) {
                return
            }
            this.stop();
            this.audio.play();
            g = d ? true : false
        } catch (p) {
            if (j > 0) {
                j -= 1;
                setTimeout(function () {
                    k.play()
                }, 2000)
            }
        }
    };
    this.stop = function () {
        try {
            g = false;
            this.audio.stop();
            this.setVolume(o)
        } catch (p) {}
    };
    this.pause = function () {
        try {
            this.audio.pause()
        } catch (p) {}
    };
    this.seek = function (p) {
        try {
            if (p > this.audio.duration) {
                p = this.audio.duration
            } else {
                if (p < 0) {
                    p = 0
                }
            }
            this.audio.currentposition = p
        } catch (q) {}
    };
    this.setVolume = function (q) {
        try {
            this.volume = q;
            if (this.volume > 100) {
                this.volume = 100
            } else {
                if (this.volume < 0) {
                    this.volume = 0
                }
            }
            var r;
            if (this.volume >= 50) {
                r = this.volume * 12.04 - 1204
            } else {
                if (this.volume >= 25) {
                    r = this.volume * 1711.92 - 44535
                } else {
                    r = this.volume * 94.4 - 4096
                }
            }
            this.audio.volume = r
        } catch (p) {}
    };
    this.toggleMute = function () {
        try {
            this.audio.mute = !this.audio.mute
        } catch (p) {}
    };
    this.fadeIn = function () {
        try {
            if (KB.Browser.IE && KB.Browser.Version <= 8) {
                this.play();
                return
            }
        } catch (p) {}
    };
    this.fadeOut = function () {
        try {
            this.stop();
            return
        } catch (p) {}
    };
    this.getName = function () {
        return l
    };
    this.purge = function () {
        document.body.removeChild(this.audio)
    };
    (function () {
        if (!f) {
            return
        }
        j = 5;
        c = b = false;
        n = n || {};
        d = n.loop === true ? n.loop : false;
        o = n.volume || KB.Sound.DEFAULT_VOLUME;
        k.volume = o;
        l = f;
        i = KB.Sound.SOURCE_DIRECTORY + l;
        k.duration = n.duration || 0;
        k.velocity = n.velocity || 50;
        i += ".mp3";
        k.audio = document.createElement("embed");
        k.audio.setAttribute("src", i);
        k.audio.setAttribute("autoStart", "false");
        k.audio.setAttribute("autoPlay", "false");
        k.audio.setAttribute("loop", d.toString());
        k.audio.setAttribute("enablejavascript", "true");
        k.audio.setAttribute("hidden", "true");
        k.audio.setAttribute("volume", k.volume.toString());
        k.audio.setAttribute("type", "application/x-mplayer2");
        if (document.body) {
            document.body.appendChild(k.audio)
        }
        k.setVolume(k.volume)
    }())
};
KB.HTML5Sound = function (f, m) {
    var j = this,
        d, n, k, i, e, h, l, c, b, g, a;
    this.audio = null;
    this.volume = null;
    this.duration = null;
    this.velocity = null;
    this.setSource = function (o) {
        this.audio.src = o
    };
    this.play = function () {
        if (d && g) {
            return
        }
        if (!this.audio.paused) {
            this.stop()
        }
        this.audio.play()
    };
    this.stop = function () {
        this.audio.pause();
        if (this.audio.readyState === 4) {
            this.audio.currentTime = 0
        }
        setTimeout(function () {
            j.setVolume(n)
        }, 200)
    };
    this.pause = function () {
        this.audio.pause()
    };
    this.seek = function (o) {
        if (o > this.audio.duration) {
            o = this.audio.duration
        } else {
            if (o < 0) {
                o = 0
            }
        }
        this.audio.currentTime = o
    };
    this.setVolume = function (o) {
        this.volume = o;
        if (this.volume > 100) {
            this.volume = 100
        } else {
            if (this.volume < 0) {
                this.volume = 0
            }
        }
        this.audio.volume = this.volume * 0.01
    };
    this.toggleMute = function () {
        this.audio.muted = !this.audio.muted
    };
    this.fadeIn = function () {
        if (c) {
            return
        }
        if (b) {
            clearInterval(h)
        }
        c = true;
        b = false;
        var t = this.duration * 1000;
        if (t > 0) {
            clearInterval(e);
            var r = this.volume;
            if (!this.audio.isPlaying) {
                this.play();
                r = 0
            }
            this.setVolume(r);
            var q = t / this.velocity,
                p = n / q,
                o = 0,
                s;
            e = setInterval(function () {
                r += p;
                s = Math.min(n, Math.ceil(r));
                j.setVolume(s);
                if (o >= q) {
                    c = false;
                    clearInterval(e)
                }
                o += 1
            }, this.velocity)
        }
    };
    this.fadeOut = function () {
        if (b) {
            return
        }
        if (c) {
            clearInterval(e)
        }
        c = false;
        b = true;
        var t = this.duration * 1000;
        if (t > 0) {
            clearInterval(h);
            var q = t / this.velocity,
                p = this.volume / q,
                r = this.volume,
                s, o = 0;
            h = setInterval(function () {
                r -= p;
                s = Math.max(0, Math.ceil(r));
                j.setVolume(s);
                if (o >= q) {
                    b = false;
                    clearInterval(h);
                    j.stop()
                }
                o += 1
            }, this.velocity)
        }
    };
    this.getName = function () {
        return k
    };
    this.purge = function () {};
    (function () {
        if (!f) {
            return
        }
        c = b = false;
        m = m || {};
        d = m.loop === true ? m.loop : false;
        n = m.volume || KB.Sound.DEFAULT_VOLUME;
        j.volume = n;
        k = f;
        a = m.extension;
        i = KB.Sound.SOURCE_DIRECTORY + k + a;
        e = null;
        h = null;
        j.duration = m.duration || 0;
        j.velocity = m.velocity || 50;
        j.audio = new Audio();
        j.audio.src = i;
        j.audio.loop = d;
        if (d && KB.Browser.Firefox) {
            j.audio.addEventListener("ended", function () {
                j.audio.currentTime = 0
            }, false)
        }
        j.setVolume(j.volume)
    }())
};
cm = cm || {};
cm.KnightModel = jQueryClass.extend({
    init: function (a) {
        this.id = Number();
        this.fbuid = Number();
        this.name = "";
        this.level = Number();
        this.status = Number();
        this.pic = "";
        this.pointsApplied = Number();
        this.experience = Number();
        this.cityId = Number();
        this.lordsLevel = Number();
        this.basePolitics = Number();
        this.currentPolitics = Number();
        this.politicsExpireTimeStamp = "";
        this.politicsExpireUnixTime = Number();
        this.baseCombat = Number();
        this.currentCombat = Number();
        this.combatExpireTimeStamp = "";
        this.combatExpireUnixTime = Number();
        this.baseIntelligence = Number();
        this.currentIntelligence = Number();
        this.intelligenceExpireTimeStamp = "";
        this.intelligenceExpireUnixTime = Number();
        this.baseResource = Number();
        this.currentResource = Number();
        this.resourceExpireTimeStamp = "";
        this.resourceExpireUnixTime = Number();
        this.loyalty = Number()
    }
});

function openKnights() {
    var knights = new Hash(seed.knights["city" + currentcityid]);
    var msghtml = new Array();
    msghtml.push("<a name='appointKnightSection'></a><a name='chromeAnchor'></a><div class='tabsbar clearfix' id='knightModalTabs'>");
    msghtml.push("<a id='appointKnightsTab' class='tab selected' onclick='changeKnightModalTabs(0);return false;'><span>");
    msghtml.push(g_js_strings.openKnights.appknights);
    msghtml.push("</span></a>");
    msghtml.push("<a id='myKnightsTab' class='tab' onclick='changeKnightModalTabs(1);return false;'><span>");
    msghtml.push(g_js_strings.openKnights.myknights);
    msghtml.push("</span></a>");
    msghtml.push("</div>");
    msghtml.push("<div class='knighttablewrap' id='knightshall_0'>");
    msghtml.push("<div class='waiting'></div>");
    msghtml.push("</div>");
    msghtml.push("<div class='knighttablewrap' id='knightshall_1' style='display:none;'>");
    msghtml.push("<div class='knighttableheader clearfix'>");
    msghtml.push("<div class='knight'>" + g_js_strings.commonstr.knight + "</div>");
    msghtml.push("<div class='exper'>" + g_js_strings.commonstr.experience + "</div>");
    msghtml.push("<div class='knightcol'>" + g_js_strings.commonstr.pol + "</div>");
    msghtml.push("<div class='knightcol'>" + g_js_strings.commonstr.com + "</div>");
    msghtml.push("<div class='knightcol'>" + g_js_strings.commonstr.intabbr + "</div>");
    msghtml.push("<div class='knightcol'>" + g_js_strings.commonstr.res + "</div>");
    msghtml.push("<div class='loyalty'>" + g_js_strings.commonstr.loyalty + "</div>");
    msghtml.push("<div class='actions'>" + g_js_strings.commonstr.actions + "</div>");
    msghtml.push("</div>");
    msghtml.push("<div id='myKnightsTBody'>");
    msghtml.push("</div>");
    msghtml.push("</div>");
    $("modal_build_content").innerHTML = msghtml.join("");
    var params = Object.clone(g_ajaxparams);
    params.pid = currentcityinfo[4];
    new Ajax.Request(g_ajaxpath + "ajax/seekknight.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                var members = rslt.data[0];
                var membersCnt = members.length;
                var nonmembers = rslt.data[1];
                var user = rslt.data[2];
                var entryTag = "";
                if (!user.entryTag) {
                    var entryTag = ""
                } else {
                    var entryTag = user.entryTag
                }
                var nonmembersCnt = nonmembers.length;
                msghtml = new Array();
                msghtml.push("<div class='friendtableheader clearfix'>");
                msghtml.push("<div class='friend'>" + g_js_strings.commonstr.friend + "</div>");
                msghtml.push("<div class='level'>" + g_js_strings.commonstr.level + "</div>");
                msghtml.push("<div class='friendcol'>" + g_js_strings.openKnights.resheading + "</div>");
                msghtml.push("<div class='friendcol'>" + g_js_strings.commonstr.politics + "</div>");
                msghtml.push("<div class='friendcol'>" + g_js_strings.commonstr.combat + "</div>");
                msghtml.push("<div class='friendcol'>" + g_js_strings.openKnights.intheading + "</div>");
                msghtml.push("<div class='friendcol'>" + g_js_strings.commonstr.loyalty + "</div>");
                msghtml.push("<div class='salary'>" + g_js_strings.commonstr.salary + "</div>");
                msghtml.push("</div>");
                msghtml.push("<div class='friendtablecontent'>");
                msghtml.push("<table class='knighttable' border='0' cellspacing='0' cellpadding='2'>");
                msghtml.push("<tbody>");
                var stripeFlag = true;
                if (members) {
                    for (var i = 0; i < membersCnt; i++) {
                        var stripe = (stripeFlag) ? "class='stripe'" : "";
                        msghtml.push("<tr id='f_" + members[i].uid + "'" + stripe + ">");
                        msghtml.push("<td class='friendpic'><img src='" + members[i].pic_square + "' /></td>");
                        msghtml.push("<td class='friendname'><span>" + members[i].name + "</span></td>");
                        msghtml.push("<td class='friendapp'><a  class='button14' onclick='quickAppointKnight(\"" + members[i].pic_square + '",' + members[i].uid + ',"' + members[i].name.replace("'", "&#39;") + "\",1);return false;'><span>" + g_js_strings.commonstr.appoint + "</span></a></td>");
                        msghtml.push("<td class='level'>1</td>");
                        msghtml.push("<td class='friendcol'>55</td>");
                        msghtml.push("<td class='friendcol'>55</td>");
                        msghtml.push("<td class='friendcol'>55</td>");
                        msghtml.push("<td class='friendcol'>55</td>");
                        msghtml.push("<td class='friendcol'>70</td>");
                        msghtml.push("<td class='salary'>20<br/>" + g_js_strings.openKnights.goldhourly + "</td>");
                        msghtml.push("</tr>");
                        stripeFlag = !stripeFlag
                    }
                }
                if (nonmembers) {
                    for (var i = 0; i < nonmembersCnt; i++) {
                        var stripe = (stripeFlag) ? "class='stripe'" : "";
                        msghtml.push("<tr id='f_" + nonmembers[i].uid + "'" + stripe + ">");
                        msghtml.push("<td class='friendpic'><img src='" + nonmembers[i].pic_square + "' /></td>");
                        msghtml.push("<td class='friendname'><span>" + nonmembers[i].name + "</span></td>");
                        msghtml.push("<td class='friendapp'><a  class='button14' onclick='quickAppointKnight(\"" + nonmembers[i].pic_square + '",' + nonmembers[i].uid + ',"' + nonmembers[i].name.replace("'", "&#39;") + "\",0);return false;'><span>" + g_js_strings.commonstr.appoint + "</span></a></td>");
                        msghtml.push("<td class='level'>1</td>");
                        msghtml.push("<td class='friendcol'>50</td>");
                        msghtml.push("<td class='friendcol'>50</td>");
                        msghtml.push("<td class='friendcol'>50</td>");
                        msghtml.push("<td class='friendcol'>50</td>");
                        msghtml.push("<td class='friendcol'>70</td>");
                        msghtml.push("<td class='salary'>20<br/>" + g_js_strings.openKnights.goldhourly + "</td>");
                        msghtml.push("</tr>");
                        stripeFlag = !stripeFlag
                    }
                }
                msghtml.push("</tbody>");
                msghtml.push("</table>");
                msghtml.push("</div>");
                $("knightshall_0").innerHTML = msghtml.join("")
            } else {
                if (!rslt.error_code || rlst.error_code != 1001) {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                }
            }
        },
        onFailure: function () {}
    })
}

function quickAppointKnight(d, c, b, a) {
    if (a) {
        modal_appoint(d, b, 1, c, "");
        appointKnight(c, b)
    } else {
        modal_appoint(d, b, 0, c, "");
        inviteKnight(c, b, "", true)
    }
}

function modal_appoint(d, c, g, b, e) {
    var f = 50;
    if (g == 1) {
        f = 55
    }
    var a = new Array();
    a.push("<div class='appointknightwrap'>");
    a.push("<div class='appointbox clearfix'>");
    a.push("<div class='leftpic'>");
    a.push("<div class='pic'><img src='" + d + "'></div>");
    a.push("<div class='leftstat'>" + g_js_strings.commonstr.level + ":<span>1</span></div>");
    a.push("<div class='leftstat'>" + g_js_strings.commonstr.loyalty + ":<span>70</span></div>");
    a.push("</div>");
    a.push("<div class='rightinfo'>");
    a.push("<div class='title' id='topAppointLine'>" + g_js_strings.modal_appoint.appointasknight + "</div>");
    a.push("<div class='name'>" + c + "</div>");
    a.push("<div class='title' id='bottomAppointLine'></div>");
    a.push("<div class='reqbox'>");
    a.push("<div class='title'>" + g_js_strings.commonstr.requirement + "</div>");
    a.push("<div class='rightstat'>" + g_js_strings.modal_appoint.appointfee + ": <span>1,000 " + g_js_strings.commonstr.gold + "</span></div>");
    a.push("<div class='rightstat'>" + g_js_strings.commonstr.salary + ": <span>20 " + g_js_strings.commonstr.goldperhour + "</span></div>");
    a.push("</div>");
    a.push("</div>");
    a.push("</div>");
    a.push("<div class='exp'>" + g_js_strings.modal_appoint.knightskillsdesc + "</div>");
    a.push("<div class='knightstatsbox clearfix'>");
    a.push("<div class='stat'>");
    a.push("<div class='title'>" + g_js_strings.commonstr.resourcefulness + "</div>");
    a.push("  <div class='number'>" + f + "</div>");
    a.push("  </div>");
    a.push("  <div class='stat'>");
    a.push("  <div class='title'>" + g_js_strings.commonstr.politics + "</div>");
    a.push("    <div class='number'>" + f + "</div>");
    a.push("  </div>");
    a.push("<div class='stat'>");
    a.push("  <div class='title'>" + g_js_strings.commonstr.combat + "</div>");
    a.push("  <div class='number'>" + f + "</div>");
    a.push("</div>");
    a.push("  <div class='stat'>");
    a.push("    <div class='title'>" + g_js_strings.commonstr.intelligence + "</div>");
    a.push("  <div class='number'>" + f + "</div>");
    a.push("  </div>");
    a.push("</div>");
    a.push("<div class='centerbutton clearfix' id='appointBtnWrap'>");
    a.push("  <a class='button25'   onclick='appointKnight(" + b + ',"' + c.replace("'", "&#39;") + "\");return false;'><span>" + g_js_strings.commonstr.share + " " + g_js_strings.commonstr.glory + "</span></a>");
    a.push("</div>");
    a.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.appointknight, a.join(""))
}

function postToKnightWall(c, a) {
    var b = new Array();
    var d = a.replace("'", "&#39;");
    b.push(["REPLACE_KnIgHtNaMe", d]);
    common_postToProfile("120", Object.cloneFeed(template_data_120), Object.cloneFeed(actionlink_data_120), continuation_120, b, c)
}

function updateKnightSeed(c, b, a) {
    var e = $("f_" + c);
    if (e.getElementsByTagName("td")[4].innerHTML == "50") {
        var d = Object.clone(knighttemplate[1])
    } else {
        var d = Object.clone(knighttemplate[0])
    }
    d.cityId = currentcityid.toString();
    d.knightFbuid = c.toString();
    d.knightId = a.toString();
    d.knightLordUserid = tvuid.toString();
    d.knightName = b.toString();
    d.pic_square = e.getElementsByTagName("td")[0].getElementsByTagName("img")[0].src.toString();
    $("f_" + c).remove();
    if (Object.isArray(seed.knights)) {
        seed.knights = new Object
    }
    if (!seed.knights["city" + currentcityid]) {
        seed.knights["city" + currentcityid] = new Object
    }
    seed.knights["city" + currentcityid]["knt" + a] = d;
    changeKnightModalTabs(1);
    update_knights()
}

function inviteKnight(uid, name, entryTag, postToWall) {
    citygold = parseInt(seed.citystats["city" + currentcityid].gold[0]);
    if (citygold >= 1000) {
        var params = Object.clone(g_ajaxparams);
        params.friendpfid = uid;
        params.cid = currentcityid;
        new Ajax.Request(g_ajaxpath + "ajax/hireknight.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    kid = rslt.knightId;
                    updateKnightSeed(uid, name, kid);
                    cm.feedTracking.setFalse("inviteKnight");
                    $("topAppointLine").remove();
                    $("bottomAppointLine").innerHTML = g_js_strings.appointKnight.knightsuccess;
                    $("appointBtnWrap").innerHTML = cm.feedTracking.button("popupAppointKnight", "<a class='button25'  onclick='postAppointKnight(" + uid + ',"' + name.replace("'", "&#39;") + '","' + rslt.knightId + "\",1);return false;'><span>" + g_js_strings.commonstr.share + " " + g_js_strings.commonstr.glory + "</span></a>");
                    if (postToWall) {
                        postToKnightWall(uid, name)
                    }
                } else {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                }
            },
            onFailure: function () {}
        })
    } else {
        Modal.showAlert(g_js_strings.inviteKnight.unabletopay)
    }
}

function appointKnight(uid, name) {
    var citygold = parseInt(seed.citystats["city" + currentcityid].gold[0]);
    if (citygold < 1000) {
        Modal.showAlert(g_js_strings.inviteKnight.unabletopay);
        return false
    }
    var params = Object.clone(g_ajaxparams);
    params.friendpfid = uid;
    params.cid = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/hireknight.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                kid = rslt.knightId;
                updateKnightSeed(uid, name, kid);
                $("appointBtnWrap").innerHTML = cm.feedTracking.button("popupAppointKnight", "<a class='button25'  onclick='postAppointKnight(" + uid + ',"' + name.replace("'", "&#39;") + '","' + rslt.knightId + "\",1);return false;'><span>" + g_js_strings.commonstr.share + " " + g_js_strings.commonstr.glory + "</span></a>");
                cm.feedTracking.setFalse("popupAppointKnight");
                $("appointBtnWrap").className = "okbutton";
                $("topAppointLine").remove();
                if ($("notplayerline")) {
                    $("notplayerline").remove()
                }
                $("bottomAppointLine").innerHTML = g_js_strings.appointKnight.knightsuccess
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function postAppointKnight(e, b, a, d) {
    if (d == 1) {
        var c = new Array();
        var f = b.replace("'", "&#39;");
        c.push(["REPLACE_KnIgHtNaMe", f]);
        common_postToProfile("96", Object.cloneFeed(template_data_96), Object.cloneFeed(actionlink_data_96), continuation_96, c)
    }
    Modal.hideModal()
}

function timedUpdateXP() {
    var a = 1;
    var b = new Hash(seed.buildings["city" + currentcityid]);
    if (b) {
        b.each(function (f) {
            if (f.value[0] == 7) {
                a = parseInt(f.value[1])
            }
        })
    }
    var e = seed.knights["city" + currentcityid];
    var c = new Hash(e);
    if (c && c.size()) {
        c.each(function (g) {
            var f = parseInt(g.value.experience) + a;
            e[g.key].experience = f.toString()
        });
        var d = new Hash(seed.leaders["city" + currentcityid]);
        if (d) {
            d.each(function (g) {
                if (!g.key.match(/KnightId$/) || parseInt(g.value) < 1) {
                    return
                }
                var f = e["knt" + g.value];
                if (!f) {
                    return
                }
                f.experience = parseInt(f.experience) + a
            })
        }
    }
}

function showMyKnights() {
    var c = new Hash(seed.knights["city" + currentcityid]);
    var a = new Array();
    a.push("<div class='knighttablecontent'>");
    if (c) {
        var b = true;
        c.each(function (t) {
            var m = t.value;
            var q = m.knightId;
            var f = convertKnightExpToLvl(m.experience);
            var k = (f) - parseInt(m.skillPointsApplied);
            var l = Math.pow((f), 2) * 75;
            var r = Math.pow((f - 1), 2) * 75;
            var o = l - parseInt(m.experience);
            var s = l - r;
            var j = (1 - (o / s)) * 100;
            j = j < 1 ? 1 : parseInt(j);
            var p = (parseInt(f) - 1) - parseInt(m.skillPointsApplied);
            var u = polBoost = resBoost = combatBoost = 0;
            var h = polClass = resClass = combatClass = "";
            var e = parseInt(unixtime());
            var v = parseInt(m.politics);
            var n = parseInt(m.combat);
            var i = parseInt(m.intelligence);
            var d = parseInt(m.resourcefulness);
            if (parseInt(m.combatBoostExpireUnixtime) - e > 0) {
                combatBoost = Math.floor((parseInt(m.combatBoostExpireUnixtime) - e) / 60 / 60 / 24);
                combatBoost = combatBoost == 0 ? 1 : combatBoost;
                n = parseInt(n * 1.25);
                combatClass = "enchanted"
            }
            if (parseInt(m.intelligenceBoostExpireUnixtime) - e > 0) {
                u = Math.floor((parseInt(m.intelligenceBoostExpireUnixtime) - e) / 60 / 60 / 24);
                u = u == 0 ? 1 : u;
                i = parseInt(i * 1.25);
                h = "enchanted"
            }
            if (parseInt(m.politicsBoostExpireUnixtime) - e > 0) {
                polBoost = Math.floor((parseInt(m.politicsBoostExpireUnixtime) - e) / 60 / 60 / 24);
                polBoost = polBoost == 0 ? 1 : polBoost;
                v = parseInt(v * 1.25);
                polClass = "enchanted"
            }
            if (parseInt(m.resourcefulnessBoostExpireUnixtime) - e > 0) {
                resBoost = Math.floor((parseInt(m.resourcefulnessBoostExpireUnixtime) - e) / 60 / 60 / 24);
                resBoost = resBoost == 0 ? 1 : resBoost;
                d = parseInt(d * 1.25);
                resClass = "enchanted"
            }
            var w = g_js_strings.commonstr.idle;
            if (seed.leaders["city" + currentcityid].combatKnightId == q) {
                w = g_js_strings.commonstr.marshal
            } else {
                if (seed.leaders["city" + currentcityid].intelligenceKnightId == q) {
                    w = g_js_strings.commonstr.alchemystic
                } else {
                    if (seed.leaders["city" + currentcityid].politicsKnightId == q) {
                        w = g_js_strings.commonstr.foreman
                    } else {
                        if (seed.leaders["city" + currentcityid].resourcefulnessKnightId == q) {
                            w = g_js_strings.commonstr.steward
                        } else {
                            if (parseInt(m.knightStatus) == 10) {
                                w = g_js_strings.commonstr.marching
                            }
                        }
                    }
                }
            }
            var g = 0;
            if (m.baseCombat == 55) {
                g = 1
            }
            a.push("<div class='knightrow clearfix" + ((b) ? " stripe" : "") + "'>");
            a.push("<div class='knightpic'><img src='" + (m.pic_square || kraken.network.getNoPictureUrl()) + "' /></div>");
            a.push("<div class='knightname'>");
            a.push("<div class='name'>" + m.knightName + "</div>");
            a.push("<div class='info'>" + g_js_strings.showMyKnights.unasspts + ":" + k + "</div>");
            a.push("<div class='info'>" + g_js_strings.assign_role_modal.currentrole + ":" + w + "</div>");
            if (g == 0 && parseInt(m.knightFbuid) != 0) {
                a.push("<div class='clearfix'>");
                a.push("<a class='button14' onclick='invite_friends_popup();return false;'><span>" + g_js_strings.commonstr.invite + "</span></a>");
                a.push("</div>")
            }
            a.push("</div>");
            a.push("<div class='exper'><div class='stat'>" + g_js_strings.commonstr.level + ": " + f + "</div>");
            a.push("<div class='stat'>" + g_js_strings.commonstr.xp + ": " + m.experience + "</div>");
            a.push("<div class='statbar'><div class='cnt' style='width:" + j + "px;'>&nbsp;</div><div class='cnttext'>" + g_js_strings.showMyKnights.xpnextlvl.replace("%1$s", o) + "</div></div>");
            a.push("<a  class='button14' onclick='xpBoost_modal(" + q + ");return false;'><span>" + g_js_strings.showMyKnights.increasexp + "</span></a>");
            a.push("</div>");
            a.push("<div class='knightcol " + polClass + "'>");
            a.push("<div class='stat'>" + v + "</div>");
            if (polBoost > 0) {
                a.push("<span>+25% " + g_js_strings.commonstr.fortx.toLowerCase() + " <" + polBoost + " " + g_js_strings.commonstr.days.toLowerCase() + "</span>")
            } else {
                a.push("<a class='button14'  onclick='boost_modal(1," + q + ");return false;'><span>" + g_js_strings.commonstr.boost + "</span></a>")
            }
            a.push("</div>");
            a.push("<div class='knightcol " + combatClass + "'>");
            a.push("<div class='stat'>" + n + "</div>");
            if (combatBoost > 0) {
                a.push("<span>+25% for <" + combatBoost + " days</span>")
            } else {
                a.push("<a class='button14'  onclick='boost_modal(2," + q + ");return false;'><span>" + g_js_strings.commonstr.boost + "</span></a>")
            }
            a.push("</div>");
            a.push("<div class='knightcol " + h + "'>");
            a.push("<div class='stat'>" + i + "</div>");
            if (u > 0) {
                a.push("<span>+25% " + g_js_strings.commonstr.fortx.toLowerCase() + " <" + u + " " + g_js_strings.commonstr.days.toLowerCase() + "</span>")
            } else {
                a.push("<a class='button14'  onclick='boost_modal(3," + q + ");return false;'><span>" + g_js_strings.commonstr.boost + "</span></a>")
            }
            a.push("</div>");
            a.push("<div class='knightcol " + resClass + "'>");
            a.push("<div class='stat'>" + d + "</div>");
            if (resBoost > 0) {
                a.push("<span>+25% " + g_js_strings.commonstr.fortx.toLowerCase() + " <" + resBoost + " " + g_js_strings.commonstr.days.toLowerCase() + "</span>")
            } else {
                a.push("<a class='button14'  onclick='boost_modal(4," + q + ");return false;'><span>" + g_js_strings.commonstr.boost + "</span></a>")
            }
            a.push("</div>");
            a.push("<div class='knightcol'>");
            a.push("<div class='stat'>" + m.loyalty + "</div>");
            a.push("<a class='button14'  onclick='loyalBoost_modal(" + q + ");return false;'><span>" + g_js_strings.commonstr.reward + "</span></a>");
            a.push("</div>");
            a.push("<div class='actions'>");
            if (m.knightStatus == 1) {
                a.push("<a class='button14'  onclick='assign_skill_modal(" + q + ");return false;'><span>" + g_js_strings.showMyKnights.assignskill + "</span></a>");
                a.push("<a class='button14'  onclick='assign_role_modal(" + q + ");return false;'><span>" + g_js_strings.showMyKnights.assignrole + "</span></a>");
                a.push("<a class='buttonDown14'  onclick='dismiss_modal(" + q + ");return false;'><span>" + g_js_strings.commonstr.dismiss + "</span></a>")
            }
            a.push("</div>");
            a.push("</div>");
            b = !b
        })
    }
    a.push("</div>");
    $("myKnightsTBody").innerHTML = a.join("")
}

function xpBoost_modal(h) {
    var d = new Array();
    var a = ["i361", "i362", "i363"];
    d.push("<div class='boostitemlist'>");
    for (var e = 0; e < a.length; e++) {
        var c = itemlist[a[e]].name;
        var f = itemlist[a[e]].description;
        var b = 0;
        var g = ~~ (1 * a[e].split("i")[1]);
        if (ksoItems[g]) {
            b = ksoItems[g].count
        }
        d.push("<div class='itemwrap clearfix'>");
        d.push("<div class='itempic'>");
        d.push("<img src='" + stimgUrl + "img/items/70/" + a[e].substring(1) + ".jpg'/>");
        d.push("</div>");
        d.push("<div class='iteminfo'>");
        d.push("<div class='name'>" + c + "</div>");
        if (b == 0) {
            d.push("<div class='btn'><a  class='button20' onclick='Modal.hideModalAll();cm.ShopView.openShop();return false;'><span>" + g_js_strings.commonstr.getmore + "</span></a></div>")
        } else {
            d.push("<div class='btn'><a  class='button20' onclick='increaseXPItem(\"" + a[e] + '",' + h + ");return false;'><span>" + g_js_strings.commonstr.apply + "</span></a></div>")
        }
        d.push("<div class='desc'>" + f + "</div>");
        d.push("<div class='own'>" + g_js_strings.commonstr.youown + ": " + b + ".  <a  onclick='Modal.hideModalAll();cm.ShopView.openShop(1);return false;'>" + g_js_strings.commonstr.getmore + "</a></div>");
        d.push("</div>");
        d.push("</div>")
    }
    d.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.selectitem, d.join(""))
}

function increaseXPItem(iid, kid) {
    var itemId = iid.substring(1);
    var params = Object.clone(g_ajaxparams);
    params.iid = iid.substring(1);
    params.cid = currentcityid;
    params.kid = kid;
    new Ajax.Request(g_ajaxpath + "ajax/experienceKnight.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                Modal.hideModal();
                seed.items[iid] = parseInt(seed.items[iid]) - 1;
                ksoItems[itemId].subtract();
                seed.knights["city" + currentcityid]["knt" + kid].experience = rslt.experience;
                changeKnightModalTabs(1);
                cm.MixPanelTracker.track("item_use", {
                    item: itemlist["i" + params.iid].name,
                    usr_gen: seed.player.g,
                    usr_byr: seed.player.y,
                    usr_ttl: titlenames[seed.player.title],
                    distinct_id: tvuid
                });
                update_knights()
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function convertKnightExpToLvl(a) {
    return Math.floor(Math.sqrt((+a) / 75)) + 1
}

function loyalBoost_modal(j) {
    var a = seed.knights["city" + currentcityid]["knt" + j];
    var g = a.knightName;
    var i = convertKnightExpToLvl(a.experience);
    var c = kraken.network.getNoPictureUrl();
    if (a.pic_square) {
        c = a.pic_square
    }
    var f = (parseInt(a.skillPointsApplied) + 1) * 20;
    var d = a.loyalty;
    var e = a.experience;
    var b = (parseInt(a.skillPointsApplied) + 1) * 1000;
    var h = new Array();
    h.push("<div class='knightconfirmwrap'>");
    h.push("<div class='confirmbox clearfix'>");
    h.push("<div class='leftpic'>");
    h.push("<img src='" + c + "'>");
    h.push("</div>");
    h.push("<div class='rightinfo'>");
    h.push("<div class='name'>" + g + "</div>");
    h.push("<div class='infobox'>");
    h.push("<div class='rightstat'>" + g_js_strings.commonstr.salary + ":<span>" + f + " " + g_js_strings.commonstr.goldperhour.toLowerCase() + "</span></div>");
    h.push("<div class='rightstat'>" + g_js_strings.commonstr.loyalty + ":<span>" + d + "</span></div>");
    h.push("<div class='rightstat'>" + g_js_strings.commonstr.level + ":<span>" + i + "</span></div>");
    h.push("<div class='rightstat'>" + g_js_strings.loyalBoost_modal.skillpointsapplied + ":<span>" + parseInt(a.skillPointsApplied) + "</span></div>");
    h.push("</div>");
    h.push("</div>");
    h.push("</div>");
    h.push("<div class='rewardtypebox'>");
    h.push("<div class='rewardboxtitle'>" + g_js_strings.loyalBoost_modal.rewardknight + "</div>");
    h.push("<div class='ddrow'>" + g_js_strings.loyalBoost_modal.rewardwith + ": <select id='rewardType' onchange='toggleRewardExp(this);return false;'><option value='1'>" + g_js_strings.commonstr.crest + "</option><option value='2'>" + g_js_strings.commonstr.gold + "</option></select></div>");
    h.push("<div class='rewardexp' id='rewardExp' style='display:none;'>" + g_js_strings.loyalBoost_modal.rewardknightgolddesc.replace("%1$s", b) + "</div>");
    h.push("<div class='insfunds' id='insufficientFunds' style='display:none;'>" + g_js_strings.loyalBoost_modal.notenoughgold + "</div>");
    h.push("</div>");
    h.push("<div class='buttonlink clearfix' id='appointBtnWrap'>");
    h.push("<a class='button25'  onclick='rewardKnight(" + j + "," + b + ");return false;'><span>" + g_js_strings.commonstr.reward + "</span></a>");
    h.push("<a class='appointlink'  onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    h.push("</div>");
    h.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.rewardknight, h.join(""))
}

function toggleRewardExp(a) {
    if (a.value == 2) {
        $("rewardExp").show()
    } else {
        $("rewardExp").hide();
        $("insufficientFunds").hide()
    }
}

function applyItemCrest(iid, kid) {
    var knight = seed.knights["city" + currentcityid]["knt" + kid];
    var kloyal = knight.loyalty;
    var loyPts = 0;
    switch (parseInt(iid.substring(1))) {
    case 1101:
        loyPts = 5;
        break;
    case 1102:
        loyPts = 10;
        break;
    case 1103:
        loyPts = 15;
        break;
    case 1104:
        loyPts = 20;
        break;
    case 1105:
        loyPts = 25;
        break;
    case 1106:
        loyPts = 30;
        break;
    case 1107:
        loyPts = 40;
        break;
    case 1108:
        loyPts = 50;
        break;
    case 1109:
        loyPts = 60;
        break;
    default:
        loyPts = 5
    }
    if ((parseInt(kloyal) + parseInt(loyPts)) > 100) {
        Modal.showAlert(g_js_strings.errorcode.err_330);
        return false
    }
    var params = Object.clone(g_ajaxparams);
    params.rid = iid.substring(1);
    params.cid = currentcityid;
    params.kid = kid;
    new Ajax.Request(g_ajaxpath + "ajax/rewardKnight.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                seed.knights["city" + currentcityid]["knt" + kid].loyalty = parseInt(knight.loyalty) + loyPts;
                Modal.hideModal();
                seed.items[iid] = parseInt(seed.items[iid]) - 1;
                ksoItems[Number((iid).split("i")[1])].subtract();
                reward_confirm_modal(kid, 0, loyPts, itemlist[iid].name);
                cm.MixPanelTracker.track("item_use", {
                    item: itemlist["i" + params.rid].name,
                    usr_gen: seed.player.g,
                    usr_byr: seed.player.y,
                    usr_ttl: titlenames[seed.player.title],
                    distinct_id: tvuid
                })
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function rewardKnight(kid, gneed) {
    var knight = seed.knights["city" + currentcityid]["knt" + kid],
        kloyal = knight.loyalty;
    if (kloyal == 100) {
        Modal.showAlert(g_js_strings.errorcode.err_330);
        return false
    }
    if ($("rewardType").value == 1) {
        trophy_modal(kid)
    } else {
        if (parseInt(seed.citystats["city" + currentcityid].gold[0]) < gneed) {
            $("insufficientFunds").show()
        } else {
            var params = Object.clone(g_ajaxparams);
            params.rid = 0;
            params.cid = currentcityid;
            params.kid = kid;
            new Ajax.Request(g_ajaxpath + "ajax/rewardKnight.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        Modal.hideModal();
                        seed.citystats["city" + currentcityid].gold[0] = parseInt(seed.citystats["city" + currentcityid].gold[0]) - gneed;
                        seed.knights["city" + currentcityid]["knt" + kid].loyalty = parseInt(knight.loyalty) + 5;
                        reward_confirm_modal(kid, gneed, 5, "")
                    } else {
                        Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                    }
                },
                onFailure: function () {}
            })
        }
    }
}

function reward_confirm_modal(n, k, j, g) {
    var a = seed.knights["city" + currentcityid]["knt" + n];
    var i = a.knightName;
    var m = convertKnightExpToLvl(a.experience);
    var d = kraken.network.getNoPictureUrl();
    if (a.pic_square) {
        d = a.pic_square
    }
    var h = (parseInt(a.skillPointsApplied) + 1) * 20;
    var e = a.loyalty;
    var f = a.experience;
    var c = (parseInt(a.skillPointsApplied) + 1) * 100;
    if (k > 0) {
        var b = g_js_strings.reward_confirm_modal.increasedbygold.replace("%1$s", k).replace("%2$s", j)
    } else {
        var b = g_js_strings.reward_confirm_modal.increasedbytrophy.replace("%1$s", g).replace("%2$s", j)
    }
    var l = new Array();
    l.push("<div class='knightconfirmwrap'>");
    l.push("<div class='confirmbox clearfix'>");
    l.push("<div class='leftpic'>");
    l.push("<img src='" + d + "'>");
    l.push("</div>");
    l.push("<div class='rightinfo'>");
    l.push("<div class='name'>" + i + "</div>");
    l.push("<div class='infobox'>");
    l.push("<div class='rightstat'>" + g_js_strings.commonstr.salary + ":<span>" + h + " " + g_js_strings.commonstr.goldperhour.toLowerCase() + "</span></div>");
    l.push("<div class='rightstat'>" + g_js_strings.commonstr.loyalty + ":<span>" + e + "</span></div>");
    l.push("<div class='rightstat'>" + g_js_strings.commonstr.level + ":<span>" + m + "</span></div>");
    l.push("</div>");
    l.push("</div>");
    l.push("</div>");
    l.push("<div class='rewardconfirm'>");
    l.push(b);
    l.push("</div>");
    l.push("<table width='1%' align='center'>");
    l.push("<tr>");
    l.push("<td nowrap='nowrap'>");
    l.push("<a  onclick='Modal.hideModal();changeKnightModalTabs(1);return false;' class='button25'><span>" + g_js_strings.commonstr.ok + "</span></a>");
    l.push("</td>");
    l.push("</tr>");
    l.push("</table>");
    l.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.knightrewarded, l.join(""))
}

function assign_role_modal(g) {
    var b = seed.knights["city" + currentcityid]["knt" + g];
    var m = b.knightName;
    var o = convertKnightExpToLvl(b.experience);
    var e = kraken.network.getNoPictureUrl();
    if (b.pic_square) {
        e = b.pic_square
    }
    var k = (parseInt(b.skillPointsApplied) + 1) * 20;
    var f = b.loyalty;
    var i = b.experience;
    var d = parseInt(unixtime());
    var a = seed.leaders["city" + currentcityid].intelligenceKnightId;
    var j = seed.leaders["city" + currentcityid].politicsKnightId;
    var l = seed.leaders["city" + currentcityid].combatKnightId;
    var c = seed.leaders["city" + currentcityid].resourcefulnessKnightId;
    var h = g_js_strings.commonstr.idle;
    switch (g.toString()) {
    case a:
        h = g_js_strings.commonstr.alchemystic;
        break;
    case j:
        h = g_js_strings.commonstr.foreman;
        break;
    case l:
        h = g_js_strings.commonstr.marshal;
        break;
    case c:
        h = g_js_strings.commonstr.steward;
        break;
    default:
        break
    }
    var d = parseInt(unixtime());
    var n = new Array();
    n.push("<div class='knightconfirmwrap'>");
    n.push("<div class='confirmbox clearfix'>");
    n.push("<div class='leftpic'>");
    n.push("<img src='" + e + "'>");
    n.push("</div>");
    n.push("<div class='rightinfo'>");
    n.push("<div class='name'>" + m + "</div>");
    n.push("<div class='infobox'>");
    n.push("<div class='rightstat'>" + g_js_strings.commonstr.salary + ":<span>" + k + " " + g_js_strings.commonstr.goldperhour.toLowerCase() + "</span></div>");
    n.push("<div class='rightstat'>" + g_js_strings.commonstr.loyalty + ":<span>" + f + "</span></div>");
    n.push("<div class='rightstat'>" + g_js_strings.commonstr.level + ":<span>" + o + "</span></div>");
    n.push("</div>");
    n.push("</div>");
    n.push("</div>");
    n.push("<div class='title'>");
    n.push(g_js_strings.commonstr.skills);
    n.push("</div>");
    n.push("<div class='knightassignstatsbox' id='knightAssignStatsBox'>");
    n.push("<div class='stat'>");
    n.push("<div class='title'>" + g_js_strings.commonstr.politics + "</div>");
    n.push("<div class='number clearfix'>");
    n.push("<div class='assignnumber'>" + b.politics + "</div>");
    if (parseInt(b.politicsBoostExpireUnixtime) - d > 0) {
        n.push("<div class='adjustednumber'><div>" + parseInt(parseInt(b.politics) * 1.25) + "</div><span>" + g_js_strings.commonstr.current + "</span></div>")
    }
    n.push("</div>");
    n.push("</div>");
    n.push("<div class='stat'>");
    n.push("<div class='title'>" + g_js_strings.commonstr.combat + "</div>");
    n.push("<div class='number clearfix'>");
    n.push("<div class='assignnumber'>" + b.combat + "</div>");
    if (parseInt(b.combatBoostExpireUnixtime) - d > 0) {
        n.push("<div class='adjustednumber'><div>" + parseInt(parseInt(b.combat) * 1.25) + "</div><span>" + g_js_strings.commonstr.current + "</span></div>")
    }
    n.push("</div>");
    n.push("</div>");
    n.push("<div class='stat'>");
    n.push("<div class='title'>" + g_js_strings.commonstr.intelligence + "</div>");
    n.push("<div class='number clearfix'>");
    n.push("<div class='assignnumber'>" + b.intelligence + "</div>");
    if (parseInt(b.intelligenceBoostExpireUnixtime) - d > 0) {
        n.push("<div class='adjustednumber'><div>" + parseInt(parseInt(b.intelligence) * 1.25) + "</div><span>" + g_js_strings.commonstr.current + "</span></div>")
    }
    n.push("</div>");
    n.push("</div>");
    n.push("<div class='stat'>");
    n.push("<div class='title'>" + g_js_strings.commonstr.resourcefulness + "</div>");
    n.push("<div class='number clearfix'>");
    n.push("<div class='assignnumber'>" + b.resourcefulness + "</div>");
    if (parseInt(b.resourcefulnessBoostExpireUnixtime) - d > 0) {
        n.push("<div class='adjustednumber'><div>" + parseInt(parseInt(b.resourcefulness) * 1.25) + "</div><span>" + g_js_strings.commonstr.current + "</span></div>")
    }
    n.push("</div>");
    n.push("</div>");
    n.push("</div>");
    n.push("<div class='title'>");
    n.push(g_js_strings.assign_role_modal.assignroles);
    n.push("</div>");
    n.push("<div class='subtitlerow clearfix'>");
    n.push("<div class='subtitle'>" + g_js_strings.assign_role_modal.currentrole + ": <span id='currentRole'>" + h + "</span></div>");
    n.push("</div>");
    n.push("<div class='knightrolebox clearfix'>");
    n.push("<div class='heading'>" + g_js_strings.commonstr.roles + "</div>");
    n.push("<div class='knightrole'>");
    n.push("<div class='foremanpic'></div>");
    n.push("<div class='knighttitle'>" + g_js_strings.commonstr.foreman + "</div>");
    n.push("<div class='knightdesc'>" + g_js_strings.assign_role_modal.foremandesc + "</div>");
    n.push("<div class='btn'>");
    if (j == 0) {
        n.push("<a class='button14' onclick='assignKnightRole(1," + g + ",12,this);return false;'><span>" + g_js_strings.commonstr.assign + "</span></a>")
    } else {
        if (j == g) {
            n.push("<a class='button14 unassignbtn' id='unassignButton_12' onclick='assignKnightRole(0," + g + ",12,this);return false;'><span>" + g_js_strings.commonstr.unassign + "</span></a>");
            n.push("<div class='current'>" + g_js_strings.assign_role_modal.currentrole + "</div>")
        } else {
            n.push("<a class='button14' onclick='assignKnightRole(1," + g + ",12,this);return false;'><span>" + g_js_strings.commonstr.replace + "</span></a>")
        }
    }
    n.push("</div>");
    n.push("</div>");
    n.push("<div class='knightrole'>");
    n.push("<div class='marshalpic'></div>");
    n.push("<div class='knighttitle'>" + g_js_strings.commonstr.marshal + "</div>");
    n.push("<div class='knightdesc'>" + g_js_strings.assign_role_modal.marshaldesc + "</div>");
    n.push("<div class='btn'>");
    if (l == 0) {
        n.push("<a class='button14' onclick='assignKnightRole(1," + g + ",13,this);return false;'><span>" + g_js_strings.commonstr.assign + "</span></a>")
    } else {
        if (l == g) {
            n.push("<a class='button14 unassignbtn' id='unassignButton_13' onclick='assignKnightRole(0," + g + ",13,this);return false;'><span>" + g_js_strings.commonstr.unassign + "</span></a>");
            n.push("<div class='current'>" + g_js_strings.assign_role_modal.currentrole + "</div>")
        } else {
            n.push("<a class='button14' onclick='assignKnightRole(1," + g + ",13,this);return false;'><span>" + g_js_strings.commonstr.replace + "</span></a>")
        }
    }
    n.push("</div>");
    n.push("</div>");
    n.push("<div class='knightrole'>");
    n.push("<div class='alchemysticpic'></div>");
    n.push("<div class='knighttitle'>" + g_js_strings.commonstr.alchemystic + "</div>");
    n.push("<div class='knightdesc'>" + g_js_strings.assign_role_modal.alchedesc + "</div>");
    n.push("<div class='btn'>");
    if (a == 0) {
        n.push("<a class='button14' onclick='assignKnightRole(1," + g + ",14,this);return false;'><span>" + g_js_strings.commonstr.assign + "</span></a>")
    } else {
        if (a == g) {
            n.push("<a class='button14 unassignbtn' id='unassignButton_14' onclick='assignKnightRole(0," + g + ",14,this);return false;'><span>" + g_js_strings.commonstr.unassign + "</span></a>");
            n.push("<div class='current'>" + g_js_strings.assign_role_modal.currentrole + "</div>")
        } else {
            n.push("<a class='button14' onclick='assignKnightRole(1," + g + ",14,this);return false;'><span>" + g_js_strings.commonstr.replace + "</span></a>")
        }
    }
    n.push("</div>");
    n.push("</div>");
    n.push("<div class='knightrole'>");
    n.push("<div class='stewardpic'></div>");
    n.push("<div class='knighttitle'>" + g_js_strings.commonstr.steward + "</div>");
    n.push("<div class='knightdesc'>" + g_js_strings.assign_role_modal.stewarddesc + "</div>");
    n.push("<div class='btn'>");
    if (c == 0) {
        n.push("<a class='button14' onclick='assignKnightRole(1," + g + ",11,this);return false;'><span>" + g_js_strings.commonstr.assign + "</span></a>")
    } else {
        if (c == g) {
            n.push("<a class='button14 unassignbtn' id='unassignButton_11' onclick='assignKnightRole(0," + g + ",11,this);return false;'><span>" + g_js_strings.commonstr.unassign + "</span></a>");
            n.push("<div class='current'>" + g_js_strings.assign_role_modal.currentrole + "</div>")
        } else {
            n.push("<a class='button14' onclick='assignKnightRole(1," + g + ",11,this);return false;'><span>" + g_js_strings.commonstr.replace + "</span></a>")
        }
    }
    n.push("</div>");
    n.push("</div>");
    n.push("</div>");
    n.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.assignrole, n.join(""))
}

function dismiss_modal(a) {
    var d = seed.knights["city" + currentcityid]["knt" + a];
    var e = d.knightName;
    var c = d.pic_square;
    var b = new Array();
    b.push("<div class='dismissbox'>");
    b.push("<div class='itemwrap clearfix'>");
    b.push("<div class='itempic'>");
    b.push("<img src='" + (c || kraken.network.getNoPictureUrl()) + "' />");
    b.push("</div>");
    b.push("<div class='iteminfo'>");
    b.push(g_js_strings.dismiss_modal.dismissknightconfirm.replace("%1$s", e));
    b.push("</div>");
    b.push("</div>");
    b.push("<div class='buttonlink clearfix'>");
    b.push("<a class='button25'  onclick='dismissKnight(" + a + ");return false;'><span>" + g_js_strings.commonstr.dismiss + "</span></a>");
    b.push("<a class='appointlink'  onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    b.push("</div>");
    b.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.dismissknight, b.join(""))
}

function dismissKnight(kid) {
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    params.kid = kid;
    new Ajax.Request(g_ajaxpath + "ajax/fireKnight.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                delete seed.knights["city" + currentcityid]["knt" + kid];
                Modal.hideModal();
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                changeKnightModalTabs(1)
            } else {
                Modal.hideModal();
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function assignKnightRole(assignflag, kid, pos, tgt) {
    var params = Object.clone(g_ajaxparams);
    params.pos = pos;
    if (assignflag == 0) {
        params.kid = 0
    } else {
        params.kid = kid
    }
    params.cid = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/assignknight.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (assignflag == 0) {
                    tgt.parentNode.innerHTML = "<a class='button14' onclick='assignKnightRole(1," + kid + "," + pos + ",this);return false;'><span>" + g_js_strings.commonstr.assign + "</span></a>";
                    $("currentRole").innerHTML = "Idle";
                    switch (pos) {
                    case 11:
                        seed.leaders["city" + currentcityid].resourcefulnessKnightId = "0";
                        break;
                    case 12:
                        seed.leaders["city" + currentcityid].politicsKnightId = "0";
                        break;
                    case 13:
                        seed.leaders["city" + currentcityid].combatKnightId = "0";
                        break;
                    case 14:
                        seed.leaders["city" + currentcityid].intelligenceKnightId = "0";
                        break
                    }
                } else {
                    var rolebox = tgt.parentNode.parentNode.parentNode;
                    Element.extend(rolebox);
                    if (rolebox.select("a.unassignbtn")[0]) {
                        var uPos = rolebox.select("a.unassignbtn")[0].id.split("_")[1];
                        rolebox.select("a.unassignbtn")[0].parentNode.innerHTML = "<a class='button14' onclick='assignKnightRole(1," + kid + "," + uPos + ",this);return false;'><span>" + g_js_strings.commonstr.assign + "</span></a>"
                    }
                    tgt.parentNode.innerHTML = "<a class='button14 unassignbtn' id='unassignButton_" + pos + "' onclick='assignKnightRole(0," + kid + "," + pos + ",this);return false;'><span>" + g_js_strings.commonstr.unassign + "</span></a><div class='current'>" + g_js_strings.assign_role_modal.currentrole + "</div>";
                    var leaders = new Hash(seed.leaders["city" + currentcityid]);
                    leaders.each(function (pair) {
                        if (pair.value == kid.toString()) {
                            seed.leaders["city" + currentcityid][pair.key] = "0"
                        }
                    });
                    var cityName = currentcityinfo[1];
                    var rolename = "";
                    switch (pos) {
                    case 11:
                        $("currentRole").innerHTML = g_js_strings.commonstr.steward;
                        rolename = g_js_strings.commonstr.steward;
                        seed.leaders["city" + currentcityid].resourcefulnessKnightId = kid.toString();
                        break;
                    case 12:
                        $("currentRole").innerHTML = g_js_strings.commonstr.foreman;
                        rolename = g_js_strings.commonstr.foreman;
                        seed.leaders["city" + currentcityid].politicsKnightId = kid.toString();
                        break;
                    case 13:
                        $("currentRole").innerHTML = g_js_strings.commonstr.marshal;
                        rolename = g_js_strings.commonstr.marshal;
                        seed.leaders["city" + currentcityid].combatKnightId = kid.toString();
                        break;
                    case 14:
                        $("currentRole").innerHTML = g_js_strings.commonstr.alchemystic;
                        rolename = g_js_strings.commonstr.alchemystic;
                        seed.leaders["city" + currentcityid].intelligenceKnightId = kid.toString();
                        break;
                    default:
                    }
                    var rolestr = g_js_strings.assign_role_modal.roleconfirm.replace("%1$s", seed.knights["city" + currentcityid]["knt" + kid].knightName).replace("%2$s", cityName).replace("%3$s", rolename);
                    var msghtml = new Array();
                    msghtml.push("<div class='role_confirm_wrapper clearfix'>");
                    msghtml.push("<div class='role " + rolename.toLowerCase() + "'></div>");
                    msghtml.push("<div class='role_text'><span>" + rolestr + "</span></div>");
                    msghtml.push("</div>");
                    msghtml.push("<table width='45%' align='center' nowrap='nowrap'>");
                    msghtml.push("<tr><td nowrap='nowrap'>");
                    if (cm.feedTracking.get("assignKnightRole") !== false) {
                        msghtml.push("<a class='button25' style='margin-left: 15px;' onclick='role_confirm_postToProfile(" + kid + "," + pos + ");return false;'><span>" + g_js_strings.commonstr.share + " " + g_js_strings.commonstr.glory + "</span></a>");
                        cm.feedTracking.setFalse("assignKnightRole")
                    } else {
                        msghtml.push("<a style='margin-left: 15px;' class='buttonDown25' onclick='Modal.hideModal(); return false;'><span>" + g_js_strings.commonstr.ok + "</span></a>")
                    }
                    msghtml.push("</td></tr>");
                    msghtml.push("</table>");
                    Modal.showModal(400, 400, 65, 90, g_js_strings.modaltitles.knightroleassigned, msghtml.join(""))
                }
                if ($("knightshall_1") && $("knightshall_1").visible()) {
                    changeKnightModalTabs(1)
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function role_confirm_postToProfile(a, c) {
    Modal.hideModalAll();
    var b = new Array();
    b.push(["REPLACE_KnIgHtNaMe", seed.knights["city" + currentcityid]["knt" + a].knightName]);
    switch (c) {
    case 11:
        common_postToProfile("100", Object.cloneFeed(template_data_100), Object.cloneFeed(actionlink_data_100), continuation_100, b);
        break;
    case 12:
        common_postToProfile("98", Object.cloneFeed(template_data_98), Object.cloneFeed(actionlink_data_98), continuation_98, b);
        break;
    case 13:
        common_postToProfile("99", Object.cloneFeed(template_data_99), Object.cloneFeed(actionlink_data_99), continuation_99, b);
        break;
    case 14:
        common_postToProfile("101", Object.cloneFeed(template_data_101), Object.cloneFeed(actionlink_data_101), continuation_101, b);
        break;
    default:
    }
}

function assign_skill_modal(e) {
    var a = seed.knights["city" + currentcityid]["knt" + e];
    var k = a.knightName;
    var m = convertKnightExpToLvl(a.experience);
    var c = kraken.network.getNoPictureUrl();
    if (a.pic_square) {
        c = a.pic_square
    }
    var i = (parseInt(a.skillPointsApplied) + 1) * 20;
    var d = a.loyalty;
    var g = a.experience;
    var j = (m) - parseInt(a.skillPointsApplied);
    var h = "";
    if (j == 0) {
        h = "disaddbutton"
    }
    var b = parseInt(unixtime());
    var l = new Array();
    l.push("<div class='knightconfirmwrap' id='knightconfirmwrap'>");
    l.push("<div class='confirmbox clearfix'>");
    l.push("<div class='leftpic'>");
    l.push("<img src='" + c + "'>");
    l.push("</div>");
    l.push("<div class='rightinfo'>");
    l.push("<div class='name'>" + k + "</div>");
    l.push("<div class='infobox'>");
    l.push("<div class='rightstat'>" + g_js_strings.commonstr.salary + ":<span>" + i + " " + g_js_strings.commonstr.goldperhour.toLowerCase() + "</span></div>");
    l.push("<div class='rightstat'>" + g_js_strings.commonstr.loyalty + ":<span>" + d + "</span></div>");
    l.push("<div class='rightstat'>" + g_js_strings.commonstr.level + ":<span>" + m + "</span></div>");
    var f = g_js_strings.commonstr.idle;
    if (seed.leaders["city" + currentcityid].combatKnightId == e) {
        f = g_js_strings.commonstr.marshal
    } else {
        if (seed.leaders["city" + currentcityid].intelligenceKnightId == e) {
            f = g_js_strings.commonstr.alchemystic
        } else {
            if (seed.leaders["city" + currentcityid].politicsKnightId == e) {
                f = g_js_strings.commonstr.foreman
            } else {
                if (seed.leaders["city" + currentcityid].resourcefulnessKnightId == e) {
                    f = g_js_strings.commonstr.steward
                }
            }
        }
    }
    l.push("<div class='rightstat'>" + g_js_strings.commonstr.roles + ": <span>" + f + "</span></div>");
    l.push("</div>");
    l.push("</div>");
    l.push("</div>");
    l.push("<div class='title'>");
    l.push(g_js_strings.assign_skill_modal.assignedskills);
    l.push("</div>");
    l.push("<div class='subtitlerow clearfix'>");
    l.push("<div class='subtitle'>" + g_js_strings.assign_skill_modal.skillptsunassigned + ": <span id='skillPointsLeft'>" + j + "</span></div>");
    if (parseInt(a.skillPointsApplied) > 0) {
        l.push("<div class='btn'><a  class='button14' onclick='redistribute_modal(" + e + ",this);return false;'><span>" + g_js_strings.assign_skill_modal.redistributeskills + "</span></a></div>")
    }
    l.push("</div>");
    l.push("<div class='knightassignstatsbox' id='knightAssignStatsBox'>");
    l.push("<div class='stat'>");
    l.push("<div class='title'>" + g_js_strings.commonstr.politics + "</div>");
    l.push("<div class='number clearfix'>");
    l.push("<div class='assignnumber'>" + a.politics + "</div>");
    if (+a.politics < 255) {
        l.push("<a  class='addbutton " + h + "' onmouseout='removeTooltip();return false;' onmouseover='showTooltip(\"" + g_js_strings.assign_skill_modal.foremantooltip + "\",this,event,\"mainbody\");return false;' onclick='addSkillPoint(this);return false;'></a>")
    }
    if (parseInt(a.politicsBoostExpireUnixtime) - b > 0) {
        l.push("<div class='adjustednumber'><div>" + parseInt(parseInt(a.politics) * 1.25) + "</div><span>" + g_js_strings.commonstr.current + "</span></div>")
    }
    l.push("</div>");
    l.push("</div>");
    l.push("<div class='stat'>");
    l.push("<div class='title'>" + g_js_strings.commonstr.combat + "</div>");
    l.push("<div class='number clearfix'>");
    l.push("<div class='assignnumber'>" + a.combat + "</div>");
    if (+a.combat < 255) {
        l.push("<a  class='addbutton " + h + "' onmouseout='removeTooltip();return false;' onmouseover='showTooltip(\"" + g_js_strings.assign_skill_modal.marshaltooltip + "\",this,event,\"mainbody\");return false;' onclick='addSkillPoint(this);return false;'></a>")
    }
    if (parseInt(a.combatBoostExpireUnixtime) - b > 0) {
        l.push("<div class='adjustednumber'><div>" + parseInt(parseInt(a.combat) * 1.25) + "</div><span>" + g_js_strings.commonstr.current + "</span></div>")
    }
    l.push("</div>");
    l.push("</div>");
    l.push("<div class='stat'>");
    l.push("<div class='title'>" + g_js_strings.commonstr.intelligence + "</div>");
    l.push("<div class='number clearfix'>");
    l.push("<div class='assignnumber'>" + a.intelligence + "</div>");
    if (+a.intelligence < 255) {
        l.push("<a  class='addbutton " + h + "' onmouseout='removeTooltip();return false;' onmouseover='showTooltip(\"" + g_js_strings.assign_skill_modal.alchetooltip + "\",this,event,\"mainbody\");return false;' onclick='addSkillPoint(this);return false;'></a>")
    }
    if (parseInt(a.intelligenceBoostExpireUnixtime) - b > 0) {
        l.push("<div class='adjustednumber'><div>" + parseInt(parseInt(a.intelligence) * 1.25) + "</div><span>" + g_js_strings.commonstr.current + "</span></div>")
    }
    l.push("</div>");
    l.push("</div>");
    l.push("<div class='stat'>");
    l.push("<div class='title'>" + g_js_strings.commonstr.resourcefulness + "</div>");
    l.push("<div class='number clearfix'>");
    l.push("<div class='assignnumber'>" + a.resourcefulness + "</div>");
    if (+a.resourcefulness < 255) {
        l.push("<a  class='addbutton " + h + "' onmouseout='removeTooltip();return false;' onmouseover='showTooltip(\"" + g_js_strings.assign_skill_modal.stewardtooltip + "\",this,event,\"mainbody\");return false;' onclick='addSkillPoint(this);return false;'></a>")
    }
    if (parseInt(a.resourcefulnessBoostExpireUnixtime) - b > 0) {
        l.push("<div class='adjustednumber'><div>" + parseInt(parseInt(a.resourcefulness) * 1.25) + "</div><span>" + g_js_strings.commonstr.current + "</span></div>")
    }
    l.push("</div>");
    l.push("</div>");
    l.push("</div>");
    l.push("<div class='buttonlink clearfix' id='appointBtnWrap'>");
    l.push("<a class='button25'  onclick='save_skill(" + e + ");return false;'><span>" + g_js_strings.commonstr.save + "</span></a>");
    l.push("<a class='appointlink'  onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    l.push("</div>");
    l.push("</div>");
    Modal.showModal(500, 500, 115, 85, g_js_strings.modaltitles.assignskills, l.join(""))
}

function redistribute_modal(a, h) {
    var f = Math.ceil(parseInt(seed.knights["city" + currentcityid]["knt" + a].skillPointsApplied) / 10);
    var e = "i941";
    var d = new Array();
    d.push("<div class='boostitemlist'>");
    var c = itemlist[e].name;
    var g = itemlist[e].description;
    var b = 0;
    if (seed.items[e]) {
        b = parseInt(seed.items[e])
    }
    d.push("<div class='itemwrap fountain clearfix'>");
    d.push("<div class='itempic'>");
    d.push("<img src='" + stimgUrl + "img/items/70/" + e.substring(1) + ".jpg'/>");
    d.push("</div>");
    d.push("<div class='iteminfo'>");
    d.push("<div class='name'>" + c + "</div>");
    if (b < f) {
        d.push("<div class='btn'><a  class='button20' onclick='Modal.hideModalAll();cm.ShopView.openShop();return false;'><span>" + g_js_strings.commonstr.getmore + "</span></a></div>")
    } else {
        d.push("<div class='btn'><a  class='button20' onclick='applyFountain(\"" + e + '",' + a + "," + f + ");return false;'><span>" + g_js_strings.commonstr.apply + "</span></a></div>")
    }
    d.push("<div class='desc'>" + g + "</div>");
    d.push("<div class='own'>" + g_js_strings.commonstr.youneed + ": " + f + "</div>");
    d.push("<div class='own'>" + g_js_strings.commonstr.youown + ": " + b + ".  <a  onclick='Modal.hideModalAll();cm.ShopView.openShop();return false;'>" + g_js_strings.commonstr.getmore + "</a></div>");
    d.push("</div>");
    d.push("</div>");
    d.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.selectitem, d.join(""))
}

function applyFountain(item, kid, fountainsNeeded) {
    var itemId = Number((item).split("i")[1]),
        knight = seed.knights["city" + currentcityid]["knt" + kid],
        params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    params.kid = kid;
    new Ajax.Request(g_ajaxpath + "ajax/resetKnight.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                seed.items[item] = parseInt(seed.items[item]) - fountainsNeeded;
                ksoItems[itemId].subtract(fountainsNeeded);
                Modal.hideModal();
                var genericBaseNumber = knight.baseCombat;
                var assignmodal = $("knightAssignStatsBox");
                var stat = assignmodal.select("div.stat");
                var klevel = convertKnightExpToLvl(knight.experience);
                var unassignedPts = klevel;
                for (var i = 0; i < stat.length; i++) {
                    stat[i].select("div.assignnumber")[0].innerHTML = genericBaseNumber;
                    if (stat[i].select("div.adjustednumber")[0]) {
                        stat[i].select("div.adjustednumber")[0].getElementsByTagName("div")[0].innerHTML = parseInt(genericBaseNumber * 1.25)
                    }
                    if (stat[i].select("a.disaddbutton")[0] && unassignedPts > 0) {
                        stat[i].select("a.disaddbutton")[0].removeClassName("disaddbutton")
                    }
                }
                $("skillPointsLeft").innerHTML = unassignedPts;
                seed.knights["city" + currentcityid]["knt" + kid].skillPointsApplied = 0;
                seed.knights["city" + currentcityid]["knt" + kid].combat = seed.knights["city" + currentcityid]["knt" + kid].intelligence = seed.knights["city" + currentcityid]["knt" + kid].resourcefulness = seed.knights["city" + currentcityid]["knt" + kid].politics = genericBaseNumber;
                Modal.hideModal();
                changeKnightModalTabs(1);
                cm.MixPanelTracker.track("item_use", {
                    item: itemlist.i941.name,
                    usr_gen: seed.player.g,
                    usr_byr: seed.player.y,
                    usr_ttl: titlenames[seed.player.title],
                    distinct_id: tvuid
                })
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function save_skill(kid) {
    var skillnumbers = $("knightAssignStatsBox").select("div.assignnumber");
    var knight = seed.knights["city" + currentcityid]["knt" + kid];
    var klevel = convertKnightExpToLvl(knight.experience);
    var unassignedPts = (klevel) - parseInt(knight.skillPointsApplied);
    var upCnt = 0;
    upCnt = (parseInt(skillnumbers[0].innerHTML) - parseInt(knight.politics)) + (parseInt(skillnumbers[1].innerHTML) - parseInt(knight.combat)) + (parseInt(skillnumbers[2].innerHTML) - parseInt(knight.intelligence)) + (parseInt(skillnumbers[3].innerHTML) - parseInt(knight.resourcefulness));
    if (upCnt == 0) {
        Modal.hideModal();
        return false
    } else {
        if (upCnt > unassignedPts) {
            Modal.hideModal();
            return false
        }
    }
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    params.kid = kid;
    params.p = parseInt(skillnumbers[0].innerHTML);
    params.c = parseInt(skillnumbers[1].innerHTML);
    params.i = parseInt(skillnumbers[2].innerHTML);
    params.r = parseInt(skillnumbers[3].innerHTML);
    new Ajax.Request(g_ajaxpath + "ajax/skillupKnight.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                seed.knights["city" + currentcityid]["knt" + kid].politics = skillnumbers[0].innerHTML;
                seed.knights["city" + currentcityid]["knt" + kid].combat = skillnumbers[1].innerHTML;
                seed.knights["city" + currentcityid]["knt" + kid].intelligence = skillnumbers[2].innerHTML;
                seed.knights["city" + currentcityid]["knt" + kid].resourcefulness = skillnumbers[3].innerHTML;
                seed.knights["city" + currentcityid]["knt" + kid].skillPointsApplied = (parseInt(knight.skillPointsApplied) + upCnt).toString();
                Modal.hideModal();
                changeKnightModalTabs(1)
            } else {
                Modal.hideModal();
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function addSkillPoint(g) {
    var f = parseInt($("skillPointsLeft").innerHTML);
    if (f <= 0) {
        return false
    }
    $("skillPointsLeft").innerHTML = f - 1;
    var e = g.parentNode;
    Element.extend(e);
    var d = parseInt(e.select("div.assignnumber")[0].innerHTML) + 1;
    e.select("div.assignnumber")[0].innerHTML = d;
    if (d < 255) {
        g.show()
    } else {
        g.hide()
    }
    if (e.select("div.adjustednumber").length > 0) {
        e.select("div.adjustednumber")[0].getElementsByTagName("div")[0].innerHTML = parseInt(d * 1.25)
    }
    if ((f - 1) <= 0) {
        var a = g.parentNode.parentNode.parentNode;
        Element.extend(a);
        var c = a.select("div.stat");
        for (var b = 0; b < c.length; b++) {
            c[b].getElementsByTagName("a")[0].addClassName("disaddbutton")
        }
    }
}

function trophy_modal(g) {
    var c = new Array();
    var f = ["i1101", "i1102", "i1103", "i1104", "i1105", "i1106", "i1107", "i1108", "i1109"];
    c.push("<div class='boostitemlist boostitemlistlong'>");
    for (var d = 0; d < f.length; d++) {
        var b = itemlist[f[d]].name;
        var e = itemlist[f[d]].description;
        var a = 0;
        if (seed.items[f[d]]) {
            a = seed.items[f[d]]
        }
        c.push("<div class='itemwrap clearfix'>");
        c.push("<div class='itempic'>");
        c.push("<img src='" + stimgUrl + "img/items/70/" + f[d].substring(1) + ".jpg'/>");
        c.push("</div>");
        c.push("<div class='iteminfo'>");
        c.push("<div class='name'>" + b + "</div>");
        if (a == 0) {
            c.push("<div class='btn'><a  class='button20' onclick='Modal.hideModalAll();cm.ShopView.openShop();return false;'><span>" + g_js_strings.commonstr.getmore + "</span></a></div>")
        } else {
            c.push("<div class='btn'><a  class='button20' onclick='applyItemCrest(\"" + f[d] + '",' + g + ");return false;'><span>" + g_js_strings.commonstr.apply + "</span></a></div>")
        }
        c.push("<div class='desc'>" + e + "</div>");
        c.push("<div class='own'>" + g_js_strings.commonstr.youown + ": " + a + ".  <a  onclick='Modal.hideModalAll();cm.ShopView.openShop();return false;'>" + g_js_strings.commonstr.getmore + "</a></div>");
        c.push("</div>");
        c.push("</div>")
    }
    c.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.selectitem, c.join(""))
}

function boost_modal(d, g) {
    var e;
    switch (d) {
    case 1:
        e = "i211";
        break;
    case 2:
        e = "i221";
        break;
    case 3:
        e = "i231";
        break;
    case 4:
        e = "i241";
        break;
    default:
        return false
    }
    var c = new Array();
    c.push("<div class='boostitemlist'>");
    var b = itemlist[e].name;
    var f = itemlist[e].description;
    var a = 0;
    if (seed.items[e]) {
        a = seed.items[e]
    }
    c.push("<div class='itemwrap clearfix'>");
    c.push("<div class='itempic'>");
    c.push("<img src='" + stimgUrl + "img/items/70/" + e.substring(1) + ".jpg'/>");
    c.push("</div>");
    c.push("<div class='iteminfo'>");
    c.push("<div class='name'>" + b + "</div>");
    if (a == 0) {
        c.push("<div class='btn'><a class='button20' onclick='Modal.hideModalAll();cm.ShopView.openShop();return false;'><span>" + g_js_strings.commonstr.getmore + "</span></a></div>")
    } else {
        c.push("<div class='btn'><a class='button20' onclick='applyBoostItem(\"" + e + '",' + g + ");return false;'><span>" + g_js_strings.commonstr.apply + "</span></a></div>")
    }
    c.push("<div class='desc'>" + f + "</div>");
    c.push("<div class='own'>" + g_js_strings.commonstr.youown + ": " + a + ".  <a  onclick='Modal.hideModalAll();cm.ShopView.openShop();return false;'>" + g_js_strings.commonstr.getmore + "</a></div>");
    c.push("</div>");
    c.push("</div>");
    c.push("</div>");
    Modal.showModal(500, 500, 10, 10, g_js_strings.modaltitles.selectitem, c.join(""))
}

function applyBoostItem(item, kid) {
    var params = Object.clone(g_ajaxparams);
    params.iid = item.substring(1);
    params.cid = currentcityid;
    params.kid = kid;
    new Ajax.Request(g_ajaxpath + "ajax/boostKnight.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                switch (item) {
                case "i211":
                    seed.knights["city" + currentcityid]["knt" + kid].politicsBoostExpireUnixtime = rslt.expiration.toString();
                    break;
                case "i221":
                    seed.knights["city" + currentcityid]["knt" + kid].combatBoostExpireUnixtime = rslt.expiration.toString();
                    break;
                case "i231":
                    seed.knights["city" + currentcityid]["knt" + kid].intelligenceBoostExpireUnixtime = rslt.expiration.toString();
                    break;
                case "i241":
                    seed.knights["city" + currentcityid]["knt" + kid].resourcefulnessBoostExpireUnixtime = rslt.expiration.toString();
                    break;
                default:
                    return false
                }
                Modal.hideModal();
                seed.items[item] = parseInt(seed.items[item]) - 1;
                ksoItems[item.substring(1)].subtract();
                changeKnightModalTabs(1);
                cm.MixPanelTracker.track("item_use", {
                    item: itemlist[item].name,
                    usr_gen: seed.player.g,
                    usr_byr: seed.player.y,
                    usr_ttl: titlenames[seed.player.title],
                    distinct_id: tvuid
                })
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function changeKnightModalTabs(a) {
    var c = $("knightModalTabs").getElementsByTagName("a");
    for (var b = 0; b < c.length; b++) {
        c[b].className = "tab";
        Element.extend(c[b]);
        $("knightshall_" + b).hide()
    }
    $("knightshall_" + a).show();
    if (a == 1) {
        showMyKnights()
    } else {
        openKnights()
    }
    c[a].addClassName("selected");
    if (a == 0) {
        $("modal_build").className = "tab1"
    } else {
        $("modal_build").className = "tab2"
    }
}

function openKnightsHall() {
    var c = seed.buildings["city" + currentcityid],
        b, a;
    for (b in c) {
        if (c[b][0] == "7") {
            a = c[b][2];
            break
        }
    }
    modal_build(a)
}

function viewAppointKnight() {
    openKnights();
    document.location.hash = "chromeAnchor";
    document.location.hash = "appointKnightSection";
    window.scrollTo(0, 0)
};
var KB = KB || {};
KB.OOP = (function () {
    this.inherits = function (a, b) {
        if (typeof (a) !== "function" || typeof (b) !== "function") {
            throw "Illegal Arguments: both child class and parent class must be a function."
        }
        a.prototype = new b();
        a.prototype.constructor = b
    }
}());
KB.CustomEventDispatcher = function () {
    var b = {},
        a = function (f, g) {
            var c = -1,
                h = b[f],
                d, j, e;
            if (b[f]) {
                d = b[f].length;
                for (e = 0; e < d; e += 1) {
                    j = h[e];
                    if (j === g) {
                        c = e;
                        break
                    }
                }
            }
            return c
        };
    this.addEventListener = function (c, d) {
        if (typeof (d) !== "function") {
            return
        }
        if (b[c]) {
            if (a(c, d) < 0) {
                b[c].push(d)
            }
        } else {
            b[c] = [d]
        }
    };
    this.removeEventListener = function (d, f) {
        var c = a(d, f);
        if (c >= 0) {
            var e = b[d];
            e.splice(c, 1)
        }
    };
    this.dispatchCustomEvent = function (g) {
        var f = g.getType(),
            j = b[f],
            c, d, k, e;
        if (j) {
            c = j.slice(0);
            d = c.length;
            for (e = 0; e < d; e += 1) {
                k = c[e];
                if (typeof (k) === "function") {
                    try {
                        k(g)
                    } catch (h) {}
                }
            }
            c = null
        }
    }
};
KB.CustomEvent = function (c) {
    var b = c,
        a = null;
    this.getTarget = function () {
        return a
    };
    this.setTarget = function (d) {
        a = d
    };
    this.getType = function () {
        return b
    }
};
KB.ClientSideCookieManager = {
    setCookie: function (c, d, b) {
        var a = "";
        if (b) {
            a = "; expires=" + b.toGMTString()
        }
        document.cookie = c + "=" + d + a + "; path=/"
    },
    getCookie: function (a) {
        var e = a + "=",
            d = document.cookie.split(";"),
            c, b;
        for (b = 0; b < d.length; b += 1) {
            c = d[b];
            while (c.charAt(0) === " ") {
                c = c.substring(1, c.length)
            }
            if (c.indexOf(e) === 0) {
                return c.substring(e.length, c.length)
            }
        }
        return null
    },
    deleteCookie: function (a) {
        if (KB.ClientSideCookieManager.getCookie(a) === null) {
            return
        }
        KB.ClientSideCookieManager.setCookie(a, "", new Date())
    }
};
KB.HashedQueue = function (b) {
    var c, a;
    this.enQueue = function (d, e) {
        c.push(d);
        a[d] = e;
        return this.deQueue()
    };
    this.deQueue = function () {
        var e = c.shift(),
            d = a[e];
        if (d) {
            delete a[e]
        }
        return d
    };
    this.moveToLast = function (f) {
        var e, d;
        for (e = 0; e < c.length; e += 1) {
            d = c[e];
            if (d === f) {
                c.splice(e, 1);
                c.push(f)
            }
        }
    };
    this.getElement = function (d) {
        return a[d]
    };
    this.getLastElement = function () {
        var d = c[c.length - 1];
        return a[d]
    };
    this.getHashedTable = function () {
        return a
    };
    this.getQueue = function () {
        return c
    };
    (function () {
        c = [b];
        a = {}
    }())
};
KB.EventUtils = {
    addEventListener: function (c, b, d, a) {
        a = a === true ? true : false;
        if (c.attachEvent) {
            c.attachEvent("on" + b, d)
        } else {
            c.addEventListener(b, d, a)
        }
    },
    removeEventListener: function (c, b, d, a) {
        a = a === true ? true : false;
        if (c.detachEvent) {
            c.detachEvent("on" + b, d)
        } else {
            c.removeEventListener(b, d, a)
        }
    }
};
KB.HTMLUtils = {
    getElementPosition: function (b) {
        var a = 0,
            c = 0;
        if (b.offsetParent) {
            do {
                a += b.offsetLeft;
                c += b.offsetTop
            } while (b = b.offsetParent)
        }
        return {
            x: a,
            y: c
        }
    }
};
KB.StringUtils = {
    format: function (a, c) {
        var b = new Template(a);
        return b.evaluate(c)
    }
};

function modal_fow_leaderboard(d, a) {
    var c = Object.clone(g_ajaxparams);
    c.perPage = 10;
    if (a) {
        c.displayName = a
    } else {
        delete c.displayName
    }
    c.page = d;
    var b = cm.GloryLeaderboardView.leaderboardType();
    c.type = b;
    AjaxCall.gPostRequest("ajax/getUserLeaderboard.php" + g_ajaxsuffix, c, function (e) {
        if (e.ok) {
            Modal.hideModalAll();
            var g = new Array();
            g.push("<div class='modal_tourny_container leader_container'>");
            if (e.emptySet) {
                g.push("<div class='emptymessage'>");
                g.push(g_js_strings.modal_fow_leaderboard.emptyessage);
                g.push("</div>")
            } else {
                var j = parseInt(e.totalPages);
                var h = parseInt(e.page);
                g.push("<div class='paginate'>");
                g.push("<span class='pageno'>" + g_js_strings.commonstr.page + ": " + h + " " + g_js_strings.commonstr.oftx + " " + j + "</span>");
                if (h > 1) {
                    g.push("<a onclick='modal_fow_leaderboard(1);return false;'>" + g_js_strings.commonstr.first + "</a>");
                    g.push("<a onclick='modal_fow_leaderboard(" + (h - 1) + ");return false;'>" + g_js_strings.commonstr.prev + "</a>")
                }
                if (h < j) {
                    g.push("<a onclick='modal_fow_leaderboard(" + (h + 1) + ");return false;'>" + g_js_strings.commonstr.next + "</a>")
                }
                g.push("</div>");
                g.push(cm.GloryLeaderboardView.tabs());
                g.push("<div class='brown_wrap'><div class='inner_brown_wrap'><div class='tournylistwrap'>");
                cm.GloryLeaderboardView.startTimer(e.gloryResetTime);
                if (parseInt(e.totalResults) > 0) {
                    g.push("<div class='timeRemainingToAchieve'></div>");
                    g.push("<table class='tourny_list_table' cellpadding='0' cellspacing='0' border='0'>");
                    g.push("<thead>");
                    g.push("<tr>");
                    g.push("<td class='rankcol'>");
                    g.push("<div>" + g_js_strings.commonstr.rank + "</div>");
                    g.push("</td>");
                    g.push("<td class='name'>");
                    g.push("<div>" + g_js_strings.commonstr.nametx + "</div>");
                    g.push("</td>");
                    g.push("<td class='might'>");
                    g.push("<div>" + (b == "glory" ? g_js_strings.commonstr.glory : g_js_strings.commonstr.might) + "</div>");
                    g.push("</td>");
                    g.push("<td class='alliname'>");
                    g.push("<div>" + g_js_strings.commonstr.alliance + "</div>");
                    g.push("</td>");
                    g.push("<td class='numcities'>");
                    g.push("<div>" + g_js_strings.commonstr.cities + "</div>");
                    g.push("</td>");
                    g.push("<td class='viewbtn'>");
                    g.push("<div>&nbsp;</div>");
                    g.push("</td>");
                    g.push("</tr>");
                    g.push("</thead>");
                    g.push("<tbody>");
                    for (var f = 0; f < e.results.length; f++) {
                        var k = e.results[f];
                        if (k.userId == 0) {
                            g.push("<tr class='misty'>");
                            g.push("<td colspan='6'>Under the Mists of Avalon</td>");
                            g.push("</tr>")
                        } else {
                            if (parseInt(k.userId) == tvuid) {
                                g.push("<tr class='myrow'>")
                            } else {
                                if (f % 2 == 1) {
                                    g.push("<tr>")
                                } else {
                                    g.push("<tr class='stripe'>")
                                }
                            }
                            g.push("<td class='rankcol'>");
                            g.push("<div>" + k.rank + "</div>");
                            g.push("</td>");
                            g.push("<td class='name'>");
                            g.push("<div>" + ((k.playerSex == "M") ? g_js_strings.commonstr.lord : g_js_strings.commonstr.lady) + " " + k.displayName + "</div>");
                            g.push("</td>");
                            g.push("<td class='might'>");
                            g.push("<div>" + (b == "glory" ? k.glory : k.might) + "</div>");
                            g.push("</td>");
                            g.push("<td class='alliname'>");
                            g.push("<div>" + ((k.allianceName && k.allianceId) ? "<a onclick='modal_list_alliance(1," + parseInt(k.allianceId) + ");return false;'>" + k.allianceName + "</a>" : "----") + "</div>");
                            g.push("</td>");
                            g.push("<td class='numcities'>");
                            g.push("<div>" + k.numCities + "</div>");
                            g.push("</td>");
                            g.push("<td class='viewbtn'>");
                            g.push("<div class='clearfix'>" + ((b == "glory" && cm.WorldSettings.isOn("GLORY_RANK_ARROWS")) ? cm.GloryLeaderboardView.arrow(parseInt(k.increased) == 1) : "<a onclick='modal_leaderboard_profile(" + parseInt(k.userId) + ");return false;' class='button20'><span>" + g_js_strings.commonstr.view + "</span></a>") + "</div>");
                            g.push("</td>");
                            g.push("</tr>")
                        }
                    }
                    g.push("</tbody>");
                    g.push("</table>")
                } else {
                    g.push("<div class='leadersearcherror'>");
                    g.push(g_js_strings.modal_fow_leaderboard.nomatcherr);
                    g.push("</div>")
                }
                g.push("</div>");
                g.push("<div class='leadersearch clearfix'>");
                g.push("<div class='userbox'>");
                g.push("<div>" + g_js_strings.modal_fow_leaderboard.searchuser + ":</div>");
                g.push("<div class='clearfix'>");
                g.push("<input value='' id='userSearch'/>");
                g.push("<a class='button20' onclick='getUserSearch();return false;'><span>" + g_js_strings.modal_fow_leaderboard.finduser + "</span></a>");
                g.push("</div>");
                g.push("</div>");
                g.push("<div class='allibox'>");
                g.push("<div>" + g_js_strings.modal_fow_leaderboard.searchalli + ":</div>");
                g.push("<div class='clearfix'>");
                g.push("<input value='' id='allianceSearch'/>");
                g.push("<a class='button20' onclick='getAllianceSearch();return false;'><span>" + g_js_strings.modal_fow_leaderboard.findalli + "</span></a>");
                g.push("</div>");
                g.push("</div>");
                g.push("</div>");
                g.push("<div class='backlink'><a onclick='modal_fow_leaderboard();return false;'>" + g_js_strings.modal_fow_leaderboard.backtoleader + "</a></div>");
                g.push("<div id='searchErrorMsg' class='searcherror' style='display:none;'></div>");
                g.push("<div class='timestampmsg'>");
                g.push(g_js_strings.modal_fow_leaderboard.updatemsg);
                g.push("</div>")
            }
            g.push("</div></div></div>");
            Modal.showModal(740, 740, 10, 10, g_js_strings.modaltitles.leaderboard, g.join(""), "");
            cm.GloryLeaderboardView.bind();
            if (jQuery.browser.webkit) {
                jQuery(".brown_wrap").css("top", "0px")
            }
            if (!cm.WorldSettings.isOn("GLORY_FE")) {
                jQuery("#mightLeaderboardTab").addClass("selected")
            }
        } else {
            Modal.showAlert(printLocalError((e.error_code || null), (e.msg || null), (e.feedback || null)))
        }
    })
}

function getAllianceSearch() {
    var a = $("allianceSearch").value;
    if (!a.blank() && a.length >= 3) {
        modal_list_alliance(1, 0, a);
        $("searchErrorMsg").hide()
    } else {
        $("searchErrorMsg").innerHTML = g_js_strings.getAllianceSearch.searcherrmsg;
        $("searchErrorMsg").show()
    }
}

function modal_list_alliance(pgno, allianceId, allianceName) {
    var params = Object.clone(g_ajaxparams);
    params.perPage = 10;
    if (allianceName) {
        params.allianceName = allianceName
    }
    params.page = pgno;
    if (allianceId && allianceId != 0) {
        params.allianceId = allianceId
    }
    var leaderboardType = cm.GloryLeaderboardView.leaderboardType();
    params.type = leaderboardType;
    new Ajax.Request(g_ajaxpath + "ajax/getUserLeaderboard.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                Modal.hideModalAll();
                var tournyhtml = new Array();
                tournyhtml.push("<div class='modal_tourny_container leader_container'>");
                var tpages = parseInt(rslt.totalPages);
                var cpage = parseInt(rslt.page);
                var allianceId = parseInt(rslt.allianceId);
                tournyhtml.push("<div class='paginate'>");
                tournyhtml.push("<span class='pageno'>" + g_js_strings.commonstr.page + ": " + cpage + " " + g_js_strings.commonstr.oftx + " " + tpages + "</span>");
                if (cpage > 1) {
                    tournyhtml.push("<a onclick='modal_list_alliance(1);return false;'>" + g_js_strings.commonstr.first + "</a>");
                    tournyhtml.push("<a onclick='modal_list_alliance(" + (cpage - 1) + "," + allianceId + ");return false;'>" + g_js_strings.commonstr.prev + "</a>")
                }
                if (cpage < tpages) {
                    tournyhtml.push("<a onclick='modal_list_alliance(" + (cpage + 1) + "," + allianceId + ");return false;'>" + g_js_strings.commonstr.next + "</a>")
                }
                tournyhtml.push("</div>");
                tournyhtml.push(cm.GloryLeaderboardView.tabs());
                tournyhtml.push("<div class='brown_wrap'><div class='inner_brown_wrap'><div class='tournylistwrap'>");
                cm.GloryLeaderboardView.startTimer(rslt.gloryResetTime);
                if (parseInt(rslt.totalResults) > 0) {
                    tournyhtml.push("<div class='timeRemainingToAchieve'>" + (leaderboardType == "glory" ? g_js_strings.commonstr.timeRemainingToAchieve + ": <span class='timeRemaining'></span>" : "") + "</div>");
                    tournyhtml.push("<div class='scroller_list'><table class='tourny_list_table' cellpadding='0' cellspacing='0' border='0'>");
                    tournyhtml.push("<thead>");
                    tournyhtml.push("<tr>");
                    tournyhtml.push("<td class='pname'>");
                    tournyhtml.push("<div>" + g_js_strings.modal_list_alliance.playername + "</div>");
                    tournyhtml.push("</td>");
                    tournyhtml.push("<td class='prank'>");
                    tournyhtml.push("<div>" + g_js_strings.commonstr.rank + "</div>");
                    tournyhtml.push("</td>");
                    tournyhtml.push("<td class='might'>");
                    tournyhtml.push("<div>" + (leaderboardType == "glory" ? g_js_strings.commonstr.glory : g_js_strings.commonstr.might) + "</div>");
                    tournyhtml.push("</td>");
                    tournyhtml.push("<td class='location'>");
                    tournyhtml.push("<div>" + g_js_strings.commonstr.location + "</div>");
                    tournyhtml.push("</td>");
                    tournyhtml.push("<td class='orank'>");
                    tournyhtml.push("<div>" + g_js_strings.modal_list_alliance.offrank + "</div>");
                    tournyhtml.push("</td>");
                    tournyhtml.push("<td class='viewbtn'>");
                    tournyhtml.push("<div>&nbsp;</div>");
                    tournyhtml.push("</td>");
                    tournyhtml.push("</tr>");
                    tournyhtml.push("</thead>");
                    tournyhtml.push("<tbody>");
                    for (var i = 0; i < rslt.results.length; i++) {
                        var row = rslt.results[i];
                        if (i % 2 == 1) {
                            tournyhtml.push("<tr>")
                        } else {
                            tournyhtml.push("<tr class='stripe'>")
                        }
                        tournyhtml.push("<td class='pname'>");
                        tournyhtml.push("<div>" + ((row.playerSex == "M") ? g_js_strings.commonstr.lord : g_js_strings.commonstr.lady) + " " + row.displayName + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td class='prank'>");
                        tournyhtml.push("<div>" + row.rank + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td class='might'>");
                        tournyhtml.push("<div>" + (leaderboardType == "glory" ? row.glory : row.might) + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td class='location'>");
                        for (var j = 0; j < row.cities.length; j++) {
                            tournyhtml.push("<div>");
                            var coordinateLink = new cm.utils.CoordinateLink(row.cities[j].xCoord, row.cities[j].yCoord);
                            coordinateLink.setClassName("coordinateLink");
                            tournyhtml.push(coordinateLink.getHTML());
                            tournyhtml.push("</div>")
                        }
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td class='orank'>");
                        tournyhtml.push("<div>");
                        if (row.officerType == 1) {
                            tournyhtml.push(g_js_strings.commonstr.chancellor)
                        } else {
                            if (row.officerType == 2) {
                                tournyhtml.push(g_js_strings.commonstr.vicechancellor)
                            } else {
                                if (row.officerType == 3) {
                                    tournyhtml.push(g_js_strings.commonstr.officer)
                                } else {
                                    tournyhtml.push(g_js_strings.commonstr.member)
                                }
                            }
                        }
                        tournyhtml.push("</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td class='viewbtn'>");
                        tournyhtml.push("<div class='clearfix'><a onclick='modal_leaderboard_profile(" + parseInt(row.userId) + ");return false;' class='button20'><span>" + g_js_strings.commonstr.view + "</span></a></div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("</tr>")
                    }
                    tournyhtml.push("</tbody>");
                    tournyhtml.push("</table></div>")
                } else {
                    tournyhtml.push("<div class='leadersearcherror'>");
                    tournyhtml.push(g_js_strings.modal_fow_leaderboard.nomatcherr);
                    tournyhtml.push("</div>")
                }
                tournyhtml.push("</div>");
                tournyhtml.push("<div class='leadersearch clearfix'>");
                tournyhtml.push("<div class='userbox'>");
                tournyhtml.push("<div>" + g_js_strings.modal_fow_leaderboard.searchuser + ":</div>");
                tournyhtml.push("<div class='clearfix'>");
                tournyhtml.push("<input value='' id='userSearch'/>");
                tournyhtml.push("<a class='button20' onclick='getUserSearch();return false;'><span>" + g_js_strings.modal_fow_leaderboard.finduser + "</span></a>");
                tournyhtml.push("</div>");
                tournyhtml.push("</div>");
                tournyhtml.push("<div class='allibox'>");
                tournyhtml.push("<div>" + g_js_strings.modal_fow_leaderboard.searchalli + ":</div>");
                tournyhtml.push("<div class='clearfix'>");
                tournyhtml.push("<input value='' id='allianceSearch'/>");
                tournyhtml.push("<a class='button20' onclick='getAllianceSearch();return false;'><span>" + g_js_strings.modal_fow_leaderboard.findalli + "</span></a>");
                tournyhtml.push("</div>");
                tournyhtml.push("</div>");
                tournyhtml.push("</div>");
                tournyhtml.push("<div class='backlink'><a onclick='modal_fow_leaderboard();return false;'>" + g_js_strings.modal_fow_leaderboard.backtoleader + "</a></div>");
                tournyhtml.push("<div id='searchErrorMsg' class='searcherror' style='display:none;'></div>");
                tournyhtml.push("<div class='timestampmsg'>");
                tournyhtml.push(g_js_strings.modal_fow_leaderboard.updatemsg);
                tournyhtml.push("</div>");
                tournyhtml.push("</div>");
                Modal.showModal(740, 740, 10, 10, rslt.allianceName, tournyhtml.join(""), "");
                cm.GloryLeaderboardView.bind()
            }
        },
        onFailure: function () {}
    })
}

function getUserSearch() {
    var a = $("userSearch").value;
    if (!a.blank() && a.length >= 3) {
        modal_fow_leaderboard(1, a);
        $("searchErrorMsg").hide()
    } else {
        $("searchErrorMsg").innerHTML = g_js_strings.getUserSearch.searcherrmsg;
        $("searchErrorMsg").show()
    }
}

function modal_leaderboard_profile(uid) {
    var params = Object.clone(g_ajaxparams);
    params.userId = uid;
    new Ajax.Request(g_ajaxpath + "ajax/getUserLeaderboard.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                var row = rslt.results[0];
                var pic = row.playerSex.toLowerCase() + row.avatarId;
                var lordy = ((row.playerSex == "M") ? g_js_strings.commonstr.lord : g_js_strings.commonstr.lady);
                var username = row.displayName;
                var might = row.might;
                var title = row.title;
                var alliance = row.allianceName;
                var status = "";
                var cities = row.cities;
                var userId = row.userId;
                switch (parseInt(row.warStatus)) {
                case 1:
                    status = g_js_strings.commonstr.normal;
                    break;
                case 2:
                    status = g_js_strings.MapObject.begprotect;
                    break;
                case 3:
                    status = g_js_strings.commonstr.truce;
                    break;
                case 4:
                    status = g_js_strings.commonstr.vacation;
                    break;
                default:
                    status = g_js_strings.commonstr.normal
                }
                var maptilehtml = new Array();
                maptilehtml.push("<div class='maptilewrap'>");
                maptilehtml.push("<div class='maptileuserwrap clearfix'>");
                maptilehtml.push("<div class='leftpic'><img src='" + stimgUrl + "img/avatars/100/" + pic + ".jpg'/></div>");
                maptilehtml.push("<div class='rightinfo'>");
                maptilehtml.push("<div class='name'>" + lordy + " " + username + "</div>");
                maptilehtml.push("<div>" + g_js_strings.commonstr.might + ": " + might + "</div>");
                maptilehtml.push("<div>" + g_js_strings.commonstr.title + ": " + titlenames[parseInt(title)] + "</div>");
                maptilehtml.push("<div>" + g_js_strings.commonstr.alliance + ": " + (alliance || "---") + "</div>");
                maptilehtml.push("<div>" + g_js_strings.commonstr.status + ": " + status + "</div>");
                maptilehtml.push("</div>");
                maptilehtml.push("</div>");
                for (var i = 0; i < cities.length; i++) {
                    var city = cities[i];
                    maptilehtml.push("<div class='maptileinfowrap'>");
                    maptilehtml.push("<div>" + g_js_strings.commonstr.city + ": <span>" + city.cityName + "</span></div>");
                    maptilehtml.push("<div>" + g_js_strings.commonstr.coordinates + ": ");
                    var coordinateLink = new cm.utils.CoordinateLink(city.xCoord, city.yCoord);
                    coordinateLink.setClassName("coordinateLink");
                    maptilehtml.push(coordinateLink.getHTML());
                    maptilehtml.push("</div>");
                    maptilehtml.push("<div>" + g_js_strings.commonstr.province + ": <span>" + provincenames["p" + city.tileProvinceId] + "</span></div>");
                    maptilehtml.push("</div>")
                }
                maptilehtml.push("<div class='citybtnrow clearfix'>");
                maptilehtml.push("<a  class='button20' onclick='Modal.hideModal();changeview_court(" + userId + ");return false;'><span>" + g_js_strings.modal_maptile.visitcourt + "</span></a>");
                maptilehtml.push("<a  class='button20' onclick='getMessageWindow(" + userId + ',"' + username + "\");return false;'><span>" + g_js_strings.commonstr.message + "</span></a>");
                maptilehtml.push("</div>");
                maptilehtml.push("</div>");
                Modal.showModal(500, 400, 120, 190, g_js_strings.modaltitles.profile, maptilehtml.join(""))
            }
        },
        onFailure: function () {}
    })
};
var currentcityid = null;
var currentcityinfo = null;
var g_timeoff = 0;
var citylist = null;
var startingTime = 0;
var ksoItems = {};
var kocRecipes = {};
kocRecipes["1"] = {};
kocRecipes["2"] = {};
kocRecipes["3"] = {};
kocRecipes["4"] = {};
kocRecipes["5"] = {};
kocRecipes["6"] = {};
var kocQuests = {};
var kocThroneItems = {};
Array.prototype.sum = function () {
    for (var a = 0, b = 0; a < this.length; b += this[a++]) {}
    return b
};

function setcamelottime() {
    var b = new Date(unixtime() * 1000);
    var a = parseInt(b.getMinutes()) < 10 ? "0" + b.getMinutes() : b.getMinutes();
    $("kochead_time").innerHTML = b.getHours() + ":" + a
}

function starttime() {
    return parseInt(startingTime) + g_timeoff
}

function unixtime(a) {
    return parseInt((new Date()).getTime() / 1000) + g_timeoff
}

function calibratetime(b) {
    var a = unixtime()
}

function timestr(e, d) {
    var f = "";
    if (e < 61) {
        if (d == 1) {
            f = e + g_js_strings.timestr.timesec
        } else {
            f = e + g_js_strings.timestr.times
        }
    } else {
        if (e < 3601) {
            var b = parseInt(e / 60);
            e = e - (60 * b);
            if (d == 1) {
                f = b + g_js_strings.timestr.timemin + " " + e + g_js_strings.timestr.timesec
            } else {
                f = b + g_js_strings.timestr.timem + " " + e + g_js_strings.timestr.times
            }
        } else {
            if (e < 86401) {
                var c = parseInt(e / 3600);
                var b = parseInt((e - (c * 3600)) / 60);
                if (d == 1) {
                    f = c + g_js_strings.timestr.timehr + " " + b + g_js_strings.timestr.timemin
                } else {
                    if (2 == d) {
                        f = [c, g_js_strings.timestr.timeh, " ", b, g_js_strings.timestr.timem, " ", e - c * 3600 - b * 60, g_js_strings.timestr.times].join("")
                    } else {
                        f = c + g_js_strings.timestr.timeh + " " + b + g_js_strings.timestr.timem
                    }
                }
            } else {
                var a = parseInt(e / 86400);
                var c = parseInt((e - (a * 86400)) / 3600);
                var b = parseInt((e - (c * 3600) - (a * 86400)) / 60);
                if (d == 1) {
                    f = a + g_js_strings.timestr.timeday + " " + c + g_js_strings.timestr.timehr + " " + b + g_js_strings.timestr.timemin
                } else {
                    if (2 == d) {
                        f = [a, g_js_strings.timestr.timed, c, g_js_strings.timestr.timeh, " ", b, g_js_strings.timestr.timem, " ", e - a * 86400 - c * 3600 - b * 60, g_js_strings.timestr.times].join("")
                    } else {
                        f = a + g_js_strings.timestr.timed + " " + c + g_js_strings.timestr.timeh + " " + b + g_js_strings.timestr.timem
                    }
                }
            }
        }
    }
    return f
}

function secondupdate() {
    update_resource();
    if (!$("getChatState") || ($("getChatState") && $("getChatState").innerHTML == "ON")) {
        Chat.getChat()
    }
    update_citylist();
    update_queue();
    attack_generatequeue();
    attack_generateincoming();
    if ($("marketmain_transactions_status")) {
        var l = $("marketmain_transactions_status").select(".time");
        var e = unixtime();
        for (var g = 0; g < l.length; g++) {
            var d = parseInt(l[g].getAttribute("name").split("_")[0]);
            var j = parseInt(l[g].getAttribute("name").split("_")[1]);
            if (d > e) {
                l[g].innerHTML = timestr(d - e)
            } else {
                if (seed.queue_mkt.city2[d] && seed.queue_mkt.city2[d][j]) {
                    seed.queue_mkt.city2[d][j].eventUnixTime = "1"
                }
                break;
                modal_marketplace_viewtransactions()
            }
        }
    }
    var f = cm.IncomingAttackManager.getAllAttacks();
    var c = f ? f.toArray() : [];
    var m = c.length;
    for (g = 0; g < m; g++) {
        c[g].update()
    }
    var h = cm.IncomingAttackManager.getRecalledAttacks();
    var b = h ? h.toArray() : [];
    var a = b.length;
    for (g = 0; g < a; g++) {
        b[g].update()
    }
}

function statusupdate() {
    if (!$("updateSeedState") || ($("updateSeedState") && $("updateSeedState").innerHTML == "ON")) {
        update_seed_ajax()
    }
    var a = quests_validquests();
    quest_allcompleted(a.valid);
    modal_quests_generate(a.valid, a.recommended, 0);
    setcamelottime();
    update_boosts()
}

function threeminupdate() {
    if ($("panel_friendlist").visible()) {
        directory_friends_onlinestatus()
    } else {
        if ($("directory_tabs_2").visible()) {
            getDirectoryTabAllianceMembers()
        }
    }
}

function fullupdate() {
    timedUpdateXP()
}
var g_checkedoutofdate = false;

function checkoutofdate(b) {
    if (!g_checkedoutofdate) {
        g_checkedoutofdate = true;
        if (Math.abs(g_reqtime - b) > 3600) {
            var a = confirm(g_js_strings.checkoutofdate.reloadconfirm);
            if (a) {
                top.location = appUrl
            }
        }
    }
}

function update_might() {
    $("topnav_might").innerHTML = seed.player.might;
    var b = parseInt(seed.tutorial.t1) >= 22;
    if (cm.WorldSettings.hasKeyValuePair("LevelUpPopupEnabled", "true") && b) {
        if (!cm.currentPlayer) {
            var e = {
                level: seed.player.title
            };
            cm.currentPlayer = new cm.Player(e);
            var d = new cm.PlayerController(cm.currentPlayer)
        }
        var c = parseInt(jQuery("#modal_mmb").length) > 0;
        var a = unixtime() - starttime();
        if (!c && a > 45) {
            cm.currentPlayer.setMight(seed.player.might)
        }
    }
}

function update_knights() {
    var a = new Array();
    var b = new Hash(seed.knights["city" + currentcityid]);
    a.push("<table class='knightlist' cellpadding='0' cellspacing='0'>");
    a.push("<thead>");
    a.push("<tr>");
    a.push("<td class='kpic'></td>");
    a.push("<td class='kname'>" + g_js_strings.commonstr.knight + "</td>");
    a.push("<td class='klevel'>" + g_js_strings.commonstr.level + "</td>");
    a.push("</tr>");
    a.push("</thead>");
    b.each(function (e) {
        var d = parseInt(Math.sqrt(parseInt(e.value.experience) / 75)) + 1;
        var c = kraken.network.getNoPictureUrl();
        if (e.value.pic_square) {
            c = e.value.pic_square
        }
        a.push("<tr>");
        a.push("<td class='kpic'><img src='" + c + "'/></td>");
        a.push("<td class='kname'><span>" + e.value.knightName + "</span></td>");
        a.push("<td class='klevel'>" + d + "</td>");
        a.push("</tr>")
    });
    a.push("</table>");
    $("cityinfo_2").innerHTML = a.join("")
}

function update_pop() {
    var d = parseInt(seed.citystats["city" + currentcityid].pop[0]);
    var c = +(seed.citystats["city" + currentcityid].pop[2]);
    $("stat_pop_num").innerHTML = addCommas(d);
    var b = d - parseInt(seed.citystats["city" + currentcityid]["pop"][3]);
    if (b < 0) {
        $("stat_pop_idle_num").className = "noidle"
    } else {
        $("stat_pop_idle_num").className = "hasidle"
    }
    $("stat_pop_idle_num").innerHTML = b;
    var a = cm.ThroneController.effectBonus(90);
    c = Math.floor(c + (c * (a / 100)));
    if (c > 100) {
        c = 100
    }
    $("stat_happy_num").innerHTML = c
}

function update_gold() {
    $("stat_gold_bar_num").innerHTML = cm.resourceConverter.convert(addCommas(seed.citystats["city" + currentcityid].gold[0]));
    $("stat_gold_num").innerHTML = addCommas(seed.citystats["city" + currentcityid].gold[0]);
    var e = 1;
    if (parseInt(seed.playerEffects.r0BstExp) > unixtime()) {
        e = 2
    }
    var d = +(seed.citystats["city" + currentcityid]["gold"][1]),
        h = +(seed.citystats["city" + currentcityid]["pop"][0]),
        f = d * h * 0.01 * e;
    var c = seed.citystats["city" + currentcityid]["gold"][2] * 10,
        g = seed.knights["city" + currentcityid],
        b, i = 0,
        a;
    if (g) {
        jQuery.each(g, function (l, j) {
            b = +(j.knightLevel);
            i += b * 2
        })
    }
    a = c + i;
    $("stat_gold_grw").innerHTML = addCommas(f - a);
    $("stat_tax_rate").innerHTML = d + "%";
    return true
}

function update_resource() {
    var g = unixtime(),
        m = new Date,
        a = m.getTime(),
        p, j = [0, 0, 0, 0, 0],
        l = seed.wilderness["city" + currentcityid],
        h = seed.resources["city" + currentcityid],
        d = seed.knights["city" + currentcityid],
        u = 0,
        c = {},
        n = {},
        r = seed.citystats["city" + currentcityid]["pop"],
        z = {},
        b = {};
    p = g - citylist["city" + currentcityid];
    citylist["city" + currentcityid] = g;
    if (l && !Object.isArray(l)) {
        jQuery.each(l, function (i, t) {
            switch (+t.tileType) {
            case cm.TILE_TYPES.TILE_TYPE_GRASSLAND:
                u = 1;
                break;
            case cm.TILE_TYPES.TILE_TYPE_LAKE:
                u = 1;
                break;
            case cm.TILE_TYPES.TILE_TYPE_WOODS:
                u = 2;
                break;
            case cm.TILE_TYPES.TILE_TYPE_HILL:
                u = 3;
                break;
            case cm.TILE_TYPES.TILE_TYPE_MOUNTAIN:
                u = 4;
                break
            }
            j[u] += +(t.tileLevel)
        })
    }
    for (var v = 1; v < 6; v++) {
        c["r" + v] = {};
        c["r" + v].city = h["rec" + v];
        z.laborprod = 1;
        z.current = +(r[0]);
        z.labor = +(r[3]);
        if (z.labor > z.current) {
            z.laborprod = z.current / z.labor
        }
        n.level = 0;
        if (d) {
            n.id = seed.leaders["city" + currentcityid].resourcefulnessKnightId;
            n.resourceKnight = d["knt" + n.id];
            if (n.resourceKnight) {
                n.level = n.resourceKnight.resourcefulness;
                if (n.resourceKnight.resourcefulnessBoostExpireUnixtime > +(a / 1000)) {
                    n.level *= 1.25
                }
            }
        }
        b["r" + v] = {};
        b["r" + v].amount = 0;
        b["r" + v].time = +(seed.playerEffects["r" + v + "BstExp"]) || 0;
        if (b["r" + v].time > g) {
            b["r" + v].amount = 0.25
        }
        var q, y, f, e, o, s = 0;
        q = seed.throne.slotEquip[seed.throne.activeSlot];
        jQuery.each(q, function (i, t) {
            y = kocThroneItems[t];
            jQuery.each(y.effects, function (B, A) {
                if (+(B.split("slot")[1]) >= y.quality) {
                    return
                }
                e = +(cm.thronestats.tiers[A.id][A.tier].base);
                o = +(cm.thronestats.tiers[A.id][A.tier].growth);
                if (A.id === 82) {
                    s += e + ((y.level * y.level + y.level) * o * 0.5)
                }
                if (A.id === 83 && v === 1) {
                    s += e + ((y.level * y.level + y.level) * o * 0.5)
                }
                if (A.id === 84 && v === 2) {
                    s += e + ((y.level * y.level + y.level) * o * 0.5)
                }
                if (A.id === 85 && v === 3) {
                    s += e + ((y.level * y.level + y.level) * o * 0.5)
                }
                if (A.id === 86 && v === 4) {
                    s += e + ((y.level * y.level + y.level) * o * 0.5)
                }
            })
        });
        c["r" + v].persec = (c["r" + v].city[2] * (1 + seed.tech["tch" + v] / 10 + n.level / 100 + b["r" + v].amount + 0.05 * j[v]) * z.laborprod + 100);
        c["r" + v].persec = c["r" + v].persec + (c["r" + v].persec * (s / 100));
        c["r" + v].persec -= +(c["r" + v].city[3]);
        if (v == 1 && c["r" + v].persec < 0) {
            if (c["r" + v].city[0] + c["r" + v].persec * 3600 * 24 <= 0) {
                $("stat_rec" + v + "_num").addClassName("red");
                $("stat_rec" + v + "_bar_num").addClassName("red");
                $("stat_rec" + v + "_grw").addClassName("red")
            } else {
                $("stat_rec" + v + "_num").removeClassName("red");
                $("stat_rec" + v + "_bar_num").removeClassName("red");
                $("stat_rec" + v + "_grw").removeClassName("red")
            }
        }
        if (c["r" + v].city[0] < c["r" + v].city[1]) {
            c["r" + v].city[0] += c["r" + v].persec * p;
            if (c["r" + v].city[0] > c["r" + v].city[1]) {
                c["r" + v].city[0] = c["r" + v].city[1]
            } else {
                if (c["r" + v].city[0] < 0) {
                    c["r" + v].city[0] = 0
                }
            }
        } else {
            if (c["r" + v].persec < 0) {
                c["r" + v].city[0] += c["r" + v].persec * p
            }
        }
        if (v == 5) {
            if ($("stat_rec" + v + "_num")) {
                $("stat_rec" + v + "_num").innerHTML = addCommas(+(c["r" + v].city[0]))
            }
            if ($("stat_rec" + v + "_bar_num")) {
                $("stat_rec" + v + "_bar_num").innerHTML = cm.resourceConverter.convert(addCommas(+(c["r" + v].city[0])))
            }
            if ($("stat_rec" + v + "_grw")) {
                $("stat_rec" + v + "_grw").innerHTML = ""
            }
        } else {
            var x = Math.floor(c["r" + v].city[0] / 3600);
            var w = Math.floor(c["r" + v].persec);
            $("stat_rec" + v + "_num").innerHTML = addCommas(x);
            $("stat_rec" + v + "_bar_num").innerHTML = cm.resourceConverter.convert(addCommas(x));
            $("stat_rec" + v + "_grw").innerHTML = addCommas(w)
        }
    }
    return c
}

function changecity(f) {
    currentcityid = f.value;
    var d = seed.citystats["city" + currentcityid].pop[0];
    var b = seed.citystats["city" + currentcityid].pop[1];
    var c = seed.citystats["city" + currentcityid].pop[2];
    var e = popgoldchg(d, b, seed.citystats["city" + currentcityid].gold[1], c);
    update_pop();
    update_gold();
    seed.citystats["city" + currentcityid].pop[2];
    var a = cm.ThroneController.effectBonus(90);
    c = Math.floor(c + (c * (a / 100)));
    if (c > 100) {
        c = 100
    }
    $("stat_happy_num").innerHTML = c + "%";
    update_bdg()
}

function upg_tch(n, g, a) {
    var d = Math.pow(2, parseInt(g) - 1);
    var j = checkreq("tch", n, g)[3];
    var h = false;
    for (var e = 0; e < j.length; e++) {
        if (j[e] == 0) {
            h = true;
            break
        }
    }
    if (seed.queue_tch["city" + currentcityid].length > 0) {
        h = true
    }
    if (h) {
        Modal.showAlert(g_js_strings.upg_tch.unableres);
        return false
    } else {
        seed.resources["city" + currentcityid].rec1[0] -= parseInt(techcost["tch" + n][1]) * d * 3600;
        seed.resources["city" + currentcityid].rec2[0] -= parseInt(techcost["tch" + n][2]) * d * 3600;
        seed.resources["city" + currentcityid].rec3[0] -= parseInt(techcost["tch" + n][3]) * d * 3600;
        seed.resources["city" + currentcityid].rec4[0] -= parseInt(techcost["tch" + n][4]) * d * 3600;
        seed.citystats["city" + currentcityid].gold[0] -= parseInt(techcost["tch" + n][5]) * d;
        var f = 0;
        var m = seed.knights["city" + currentcityid];
        if (m) {
            m = m["knt" + seed.leaders["city" + currentcityid].intelligenceKnightId];
            if (m) {
                f = parseInt(m.intelligence);
                f = ((parseInt(m.intelligenceBoostExpireUnixtime) - unixtime()) > 0) ? (f * 1.25) : f
            }
        }
        var b = parseInt(techcost["tch" + n][7] * d * (1 / (1 + 0.005 * f)));
        var l = cm.ThroneController.effectBonus(80);
        b = b / (1 + (l / 100));
        var c = Object.clone(g_ajaxparams);
        c.cid = currentcityid;
        c.lv = g;
        c.tid = n;
        new Ajax.Request(g_ajaxpath + "ajax/research.php" + g_ajaxsuffix, {
            method: "post",
            parameters: c,
            onSuccess: function (p) {
                var i = ("(" + p.responseText + ")").evalJSON();
                if (i.ok) {
                    b = i.timeNeeded;
                    cm.sounds.play("started_research");
                    seed.queue_tch["city" + currentcityid].push([n, g, unixtime(), unixtime() + b, 0, b]);
                    var o = "no";
                    if (a == 1) {
                        o = "yes";
                        tch_gethelp(n)
                    }
                    queue_changetab_building();
                    Modal.hideModalAll();
                    if (i.updateSeed) {
                        update_seed(i.updateSeed)
                    }
                    UserEngagement.popViralModalUEP(1)
                } else {
                    Modal.showAlert(printLocalError((i.error_code || null), (i.msg || null), (i.feedback || null)))
                }
            },
            onFailure: function () {}
        })
    }
}

function tch_gethelp(b) {
    Modal.hideModalAll();
    var c = parseInt(seed.tech["tch" + b]) + 1;
    var d = Object.clone(g_ajaxparams);
    d.rid = b;
    d.ctrl = "AskForHelp";
    d.action = "getHelpData";
    ajax.Request(g_ajaxpath + "ajax/_dispatch.php" + g_ajaxsuffix, {
        method: "post",
        parameters: d,
        onSuccess: function (g) {
            var f = ("(" + g.responseText + ")").evalJSON();
            if (f.ok && f.data) {
                handleHelpCallback(f.data)
            } else {
                Modal.showAlert(printLocalError((f.error_code || null), (f.msg || null), (f.feedback || null)))
            }
        },
        onFailure: function () {}
    });
    var a = new Array();
    a.push(["REPLACE_TeChNaMe", techcost["tch" + b][0]]);
    a.push(["REPLACE_LeVeLiD", c]);
    a.push(["REPLACE_AsSeTiD", b]);
    var e = function (f, g) {
            continuation_107(f, g);
            if (!f) {
                var h = cm.SpeedUpType.research;
                cm.ClientSideCookieManager.setCookie(h, false)
            }
        };
    common_postToProfile("107", Object.cloneFeed(template_data_107), Object.cloneFeed(actionlink_data_107), e, a)
}
var g_ajaxpath = "";
var g_ajaxsuffix = "";

function build(e, a, f, h) {
    if (parseInt(a) >= 9) {
        var c = "i401";
        if (parseInt(e, 10) === 0) {
            if (parseInt(a) == 10) {
                c = "i402"
            } else {
                if (parseInt(a) == 11) {
                    c = "i404"
                }
            }
        } else {
            if (parseInt(a) > 10) {
                c = "i403"
            }
        }
        var b = parseInt(a) + 1,
            g = [];
        g.push("<div id='modal_lv10'>");
        g.push("<div class='lv10 clearfix'>");
        g.push("<img src='");
        g.push(stimgUrl);
        g.push("img/items/70/" + c.substring(1) + ".jpg'/>");
        g.push("<div class='info'><div class='ttl'>" + g_js_strings.commonstr.youneed + ": ");
        g.push(itemlist[c].name);
        g.push(" to get to Level " + b + ".</div><div class='own'>" + g_js_strings.commonstr.youown + ": ");
        var d = ~~ (1 * c.split("i")[1]);
        if (ksoItems[d].count > 0) {
            g.push(ksoItems[d].count)
        } else {
            g.push(0)
        }
        g.push("</div></div>");
        g.push("</div>");
        g.push("<div class='btns clearfix'>");
        if (ksoItems[d].count > 0) {
            if (!h) {
                h = false
            }
            g.push("<a class='button20' onclick='buildaction(" + e + "," + a + "," + f + "," + h + ",1);return false;'><span>" + g_js_strings.commonstr.apply + "</span></a>")
        } else {
            g.push("<a class='button20' onclick='Modal.hideModalAll();cm.ShopView.openShop();return false;'><span>" + g_js_strings.commonstr.getmore + "</span></a>")
        }
        g.push("<a  class='cancel' onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
        g.push("</div></div>");
        Modal.showModal(400, 400, 130, 130, "Level " + b, g.join(""))
    } else {
        buildaction(e, a, f, h)
    }
}

function build_divine() {
    if (seed.items.i401 > 0) {
        seed.items.i401 = parseInt(seed.items.i401) - 1;
        ksoItems[401].subtract();
        return true
    } else {
        return false
    }
}

function buildaction(q, c, o, a, f, j) {
    var g = Math.pow(2, c);
    var m = checkreq("bdg", q, c)[3];
    var l = false;
    for (var h = 0; h < m.length; h++) {
        if (m[h] == 0) {
            l = true;
            break
        }
    }
    if (seed.queue_con["city" + currentcityid].length > 0) {
        l = true
    }
    if (l) {
        Modal.showAlert(g_js_strings.buildaction.cannotbuild);
        return false
    } else {
        var b = 0;
        var r = seed.knights["city" + currentcityid];
        if (r) {
            r = r["knt" + seed.leaders["city" + currentcityid].politicsKnightId];
            if (r) {
                b = parseInt(r.politics)
            }
        }
        var d = buildingcost["bdg" + q][7] * g;
        if (parseInt(q) < 6 && parseInt(q) > 0 && g == 1) {
            d = 15
        }
        d = d / (1 + 0.005 * b + 0.1 * parseInt(seed.tech.tch16));
        if (d % 1 > 0) {
            d = parseInt(d)
        }
        var n = cm.ThroneController.effectBonus(78);
        d = d - (d * (n / 100));
        modal_build_waiting_state();
        var e = Object.clone(g_ajaxparams);
        if (j) {
            e = j
        }
        e.cid = currentcityid;
        e.bid = "";
        e.pos = o;
        e.lv = c + 1;
        if (e.lv > 1) {
            e.bid = seed.buildings["city" + currentcityid]["pos" + o][3]
        }
        e.type = q;
        var p = new cm.Profiler("ResponseTime", "construct.php");
        e.permission = jQuery("#modal_lv10").length > 0 ? 1 : 0;
        ajax.Request(g_ajaxpath + "ajax/construct.php" + g_ajaxsuffix, {
            method: "post",
            parameters: e,
            onSuccess: function (y) {
                p.stop();
                cm.MarchModal.setBackedOff(false);
                var t = ("(" + y.responseText + ")").evalJSON();
                if (t.ok) {
                    cm.sounds.play("build_start");
                    modal_build_show_state();
                    seed.resources["city" + currentcityid].rec1[0] -= parseInt(buildingcost["bdg" + q][1]) * g * 3600;
                    seed.resources["city" + currentcityid].rec2[0] -= parseInt(buildingcost["bdg" + q][2]) * g * 3600;
                    seed.resources["city" + currentcityid].rec3[0] -= parseInt(buildingcost["bdg" + q][3]) * g * 3600;
                    seed.resources["city" + currentcityid].rec4[0] -= parseInt(buildingcost["bdg" + q][4]) * g * 3600;
                    seed.citystats["city" + currentcityid].gold[0] -= parseInt(buildingcost["bdg" + q][5]) * g;
                    seed.queue_con["city" + currentcityid].push([q, c + 1, parseInt(t.buildingId), unixtime(), unixtime() + +(t.timeNeeded), 0, +(t.timeNeeded), parseInt(o)]);
                    if (c == 0) {
                        seed.buildings["city" + currentcityid]["pos" + o] = [q, 0, o, t.buildingId]
                    }
                    var x = "no";
                    var w = "401";
                    if (parseInt(q, 10) === 0) {
                        if (parseInt(c) == 10) {
                            w = "402"
                        } else {
                            if (parseInt(c) == 11) {
                                w = "404"
                            }
                        }
                    } else {
                        if (parseInt(c) > 10) {
                            w = "403"
                        }
                    }
                    if (f && seed.items["i" + w] > 0) {
                        seed.items["i" + w] = parseInt(seed.items["i" + w]) - 1;
                        ksoItems[w].subtract()
                    }
                    Modal.hideModalAll();
                    update_bdg();
                    queue_changetab_building();
                    if (cm.TutorialManager.inTutorialMode()) {
                        cm.TutorialEventDispatcher.dispatchTutorialEvent("complete", "CLICK_BUILD_BUTTON_SAWMILL");
                        cm.TutorialEventDispatcher.dispatchTutorialEvent("complete", "CLICK_BUILD_BUTTON_COTTAGE")
                    } else {
                        if (e.pos == 0 && e.lv == 2) {
                            var s = false;
                            var v = Object.keys(seed.buildings);
                            for (var u = 0; u < v.length; u++) {
                                if (parseInt(seed.buildings[v[u]].pos0[1]) >= 2) {
                                    s = true
                                }
                            }
                            if (!s) {
                                pop_castle_two_modal()
                            }
                        }
                    }
                    if (t.updateSeed) {
                        update_seed(t.updateSeed)
                    }
                    if (a) {
                        build_gethelp(t.buildingId);
                        x = "yes"
                    }
                } else {
                    if (processUserAction(t, function () {
                        buildaction(q, c, o, a, f, e)
                    }, e)) {
                        return
                    }
                    if (parseInt(seed.tutorial.t1) == 15) {
                        Modal.hideModalAll();
                        seed.tutorial.t1 = 18;
                        tutorialCheck(18);
                        return false
                    } else {
                        if (parseInt(seed.tutorial.t1) == 21) {
                            Modal.hideModalAll();
                            tutorialClear();
                            return false
                        }
                    }
                    modal_build_show_state();
                    Modal.showAlert(printLocalError((t.error_code || null), (t.msg || null), (t.feedback || null)))
                }
                UserEngagement.popViralModalUEP()
            },
            onFailure: function () {
                p.stop();
                cm.MarchModal.setBackedOff(false);
                if (parseInt(seed.tutorial.t1) == 15) {
                    Modal.hideModalAll();
                    seed.tutorial.t1 = 18;
                    tutorialCheck(18);
                    return false
                } else {
                    if (parseInt(seed.tutorial.t1) == 21) {
                        Modal.hideModalAll();
                        tutorialClear();
                        return false
                    }
                }
            }
        })
    }
}

function build_gethelp(g) {
    var f = qlist = seed.queue_con["city" + currentcityid];
    var j = 0;
    var e = 0;
    var a = null;
    for (var c = 0; c < f.length; c++) {
        if (parseInt(f[c][2]) == parseInt(g)) {
            j = parseInt(f[c][0]);
            e = parseInt(f[c][1]);
            a = parseInt(f[c][2]);
            break
        }
    }
    if (null === a) {
        return
    }
    var b = Object.clone(g_ajaxparams);
    b.bid = a;
    b.ctrl = "AskForHelp";
    b.action = "getHelpData";
    ajax.Request(g_ajaxpath + "ajax/_dispatch.php" + g_ajaxsuffix, {
        method: "post",
        parameters: b,
        onSuccess: function (l) {
            var i = ("(" + l.responseText + ")").evalJSON();
            if (i.ok && i.data) {
                handleHelpCallback(i.data)
            } else {
                Modal.showAlert(printLocalError((i.error_code || null), (i.msg || null), (i.feedback || null)))
            }
        },
        onFailure: function () {}
    });
    var d = new Array();
    d.push(["REPLACE_LeVeLbUiLdInG", e]);
    d.push(["REPLACE_BuIlDiNgNaMe", buildingcost["bdg" + j][0]]);
    d.push(["REPLACE_LeVeLiD", e]);
    d.push(["REPLACE_AsSeTiD", g]);
    var h = function (i, l) {
            continuation_95(i, l);
            if (!i) {
                var m = e > 1 ? cm.SpeedUpType.upgrade : cm.SpeedUpType.build;
                cm.ClientSideCookieManager.setCookie(m, false)
            }
        };
    common_postToProfile("95", Object.cloneFeed(template_data_95), Object.cloneFeed(actionlink_data_95), h, d)
}

function update_citylist() {
    var h = Array();
    var g = 0;
    var e = {};
    if (!Object.isArray(seed.queue_atkinc) && Object.keys(seed.queue_atkinc) && Object.keys(seed.queue_atkinc).length > 0) {
        var m = Object.keys(seed.queue_atkinc);
        var a, n, b;
        for (var f = 0; f < m.length; f++) {
            marchId = m[f];
            a = seed.queue_atkinc[m[f]];
            n = a.marchType;
            var b = a.score != undefined;
            if (a.mid && (a.fromPlayerId != tvuid) && b) {
                if (e[a.toCityId]) {
                    e[a.toCityId]++
                } else {
                    e[a.toCityId] = 1
                }
            }
        }
    }
    for (var f = 0; f < seed.cities.length; f++, g++) {
        var d = parseInt(seed.cities[f][0]);
        var l = "";
        if (e[d]) {
            l = "city_attack"
        } else {
            if (d == currentcityid) {
                l = "city_selected"
            } else {
                l = "city_unselected"
            }
        }
        h.push('<a id="citysel_' + (f + 1) + '" onmouseover="showCityTooltip(this,event,\'mod_maparea\');return false;" onmouseout="removeTooltip();return false;" onclick="citysel_click(this);return false;" name="' + d + '" class="city ' + l + '"><span>' + roman[f] + "</span></a>")
    }
    if (seed.cities.length < cm.cities.max()) {
        h.push('<a onclick="modal_addcityhelp();return false;" onmouseout="removeTooltip();return false;" onmouseover="showAddCityTooltip(this,event,\'mod_maparea\');return false;" class="city_new"><span class="pluscity">+</span></a>');
        g++
    }
    for (var c = g; c < 8; c++) {
        h.push('<div class="city_locked"></div>')
    }
    $("mod_citylist").innerHTML = h.join("")
}

function update_queue() {
    var an = false;
    var M = false;
    var S = $("queue_building").visible();
    if (S) {
        var R = new Array()
    }
    var ag = seed.queue_con["city" + currentcityid];
    var Z = false;
    var ac = -1;
    for (var am = 0; am < ag.length; am++) {
        var O = unixtime();
        var l = parseInt(ag[am][4]) - O;
        if (l > 0) {
            cm.speedUpModalTimer.update("bdg", cm.log.convertToHMS(l, false), l);
            cm.guardianModalModel.update(l);
            an = true;
            M = true;
            if (S) {
                var C = cm.guardianModalModel.upgrading() ? fUp(cm.guardianModalModel.getType()) + " Guardian" : buildingcost["bdg" + ag[am][0]][0];
                var p = ag[am][5] / ag[am][6] + ((O - ag[am][3]) / (ag[am][4] - ag[am][3])) * ((ag[am][6] - ag[am][5]) / ag[am][6]);
                var ab = parseInt(270 * p);
                R.push('<div class="queue_item">');
                R.push('<div class="info"><div class="stat"><span class="item">');
                R.push(C);
                var L = C;
                if (parseInt(ag[am][1]) > 0) {
                    R.push(" (" + g_js_strings.commonstr.lv + ag[am][1]);
                    R.push(")");
                    L += " (" + g_js_strings.commonstr.lv + ag[am][1] + ")"
                } else {
                    R.push(" (" + g_js_strings.commonstr.destroy + ")");
                    L += " (" + g_js_strings.commonstr.destroy + ")"
                }
                R.push('</span><span class="time">');
                R.push(timestr(l));
                R.push('</span><div class="speedup"><a class="inlineButton red14" name="' + ag[am][2] + '" onclick="cm.BuildingSpeedupController.queueClick(event, &quot;' + L + '&quot;);">');
                R.push("<span>" + g_js_strings.commonstr.speedup + '</span></a></div></div><div class="bar" style="width:');
                R.push(ab);
                R.push('px;">&nbsp;</div></div>');
                R.push('<div class="stats">');
                R.push('<span class="friends">' + g_js_strings.update_queue.frhelp + ": <span>");
                var E = seed.updateHelpConstruct["city" + currentcityid];
                if (E) {
                    var N = seed.updateHelpConstruct["city" + currentcityid]["b" + ag[am][2]];
                    if (N && parseInt(N.n) > 0) {
                        R.push(N.n)
                    } else {
                        R.push("0")
                    }
                } else {
                    R.push("0")
                }
                R.push("</span></span>");
                R.push('<span class="allis">' + g_js_strings.update_queue.allihelp + ": <span>");
                if (E) {
                    var N = seed.updateHelpConstruct["city" + currentcityid]["b" + ag[am][2]];
                    if (N && parseInt(N.a) > 0) {
                        R.push(N.a)
                    } else {
                        R.push("0")
                    }
                } else {
                    R.push("0")
                }
                R.push("</span></span>");
                R.push("</div>");
                R.push("</div>");
                if ($("modal_build_timeremaining")) {
                    $("modal_build_timeremaining").innerHTML = timestr(l)
                }
            }
        } else {
            cm.sounds.play("finished_building");
            cm.speedUpModalTimer.endSpeedUpModal("bdg");
            var G = parseInt(ag[am][1]);
            var h = ag[am][7];
            if (G == 0) {
                ac = parseInt(ag[am][0]);
                bdgOriginalLvl = parseInt(seed.buildings["city" + currentcityid]["pos" + h][1]);
                if (!seed.buildings["city" + currentcityid]["pos" + h]) {
                    return false
                }
                bdgType = parseInt(seed.buildings["city" + currentcityid]["pos" + h][0]);
                removeCityFromView(h);
                if (bdgOriginalLvl > 1) {
                    mult = Math.pow(2, bdgOriginalLvl - 2);
                    seed.resources["city" + currentcityid].rec1[0] += parseInt(buildingcost["bdg" + bdgType][1]) * mult * 3600;
                    seed.resources["city" + currentcityid].rec2[0] += parseInt(buildingcost["bdg" + bdgType][2]) * mult * 3600;
                    seed.resources["city" + currentcityid].rec3[0] += parseInt(buildingcost["bdg" + bdgType][3]) * mult * 3600;
                    seed.resources["city" + currentcityid].rec4[0] += parseInt(buildingcost["bdg" + bdgType][4]) * mult * 3600;
                    seed.citystats["city" + currentcityid].gold[0] += parseInt(buildingcost["bdg" + bdgType][5]) * mult
                }
                if (bdgType > 0 && bdgType < 5) {
                    var I = parseInt(seed.citystats["city" + currentcityid]["pop"][3]);
                    for (k = bdgOriginalLvl; k > 0; k--) {
                        I -= k * 10
                    }
                    seed.citystats["city" + currentcityid]["pop"][3] = I
                } else {
                    if (bdgType == 5) {
                        var af = seed.citystats["city" + currentcityid]["pop"][1];
                        var Q = seed.citystats["city" + currentcityid]["pop"][0];
                        for (k = bdgOriginalLvl; k > 0; k--) {
                            af -= k * 100
                        }
                        if (af < 51) {
                            af = 50
                        }
                        if (Q > af) {
                            seed.citystats["city" + currentcityid]["pop"][0] = af
                        }
                        seed.citystats["city" + currentcityid]["pop"][1] = af
                    } else {
                        if (bdgType == cm.BUILDING_TYPES.WATCH_TOWER) {
                            var U = cm.WatchTowerList.getCityWatchTower(currentcityid);
                            if (U) {
                                U.demolish()
                            }
                        }
                    }
                }
                seed.queue_con["city" + currentcityid].splice(am, 1);
                am--;
                Z = true;
                var A = parseInt(seed.player.might);
                for (var al = bdgOriginalLvl - 1; al > -1; al--) {
                    A -= buildingmight[parseInt(ac)][al]
                }
                seed.player.might = A;
                update_might();
                update_pop()
            } else {
                seed.con_hlp["b" + ag[am][2]] = 0;
                if (!seed.buildings["city" + currentcityid]["pos" + h]) {
                    return false
                }
                seed.buildings["city" + currentcityid]["pos" + h] = [ag[am][0], ag[am][1], h, seed.buildings["city" + currentcityid]["pos" + h][3]];
                ac = parseInt(ag[am][0]);
                seed.queue_con["city" + currentcityid].splice(am, 1);
                am--;
                Z = true;
                if (buildingmight[parseInt(ac)]) {
                    seed.player.might = parseInt(seed.player.might) + parseInt(buildingmight[parseInt(ac)][G - 1])
                }
                update_might();
                if (ac > 0 && ac < 5) {
                    seed.citystats["city" + currentcityid]["pop"][3] = parseInt(seed.citystats["city" + currentcityid]["pop"][3]) + G * 10
                } else {
                    if (ac == 5) {
                        var o = parseInt(seed.citystats["city" + currentcityid]["pop"][1]);
                        if (o < 51) {
                            seed.citystats["city" + currentcityid]["pop"][1] = G * 100;
                            seed.citystats["city" + currentcityid]["pop"][0] = 50
                        } else {
                            seed.citystats["city" + currentcityid]["pop"][1] = parseInt(seed.citystats["city" + currentcityid]["pop"][1]) + G * 100
                        }
                        seed.citystats["city" + currentcityid]["pop"][0] = parseInt(seed.citystats["city" + currentcityid]["pop"][0]) + G * 50;
                        update_pop()
                    } else {
                        if (ac == cm.BUILDING_TYPES.WATCH_TOWER) {
                            var U = cm.WatchTowerList.getCityWatchTower(currentcityid);
                            if (U) {
                                U.setLevel(G)
                            } else {
                                buildingId = seed.buildings["city" + currentcityid]["pos" + h][3];
                                watchTowerInfo = {
                                    buildingId: buildingId,
                                    cityId: currentcityid.toString(),
                                    slot: h,
                                    level: G
                                };
                                var U = new cm.WatchTower(watchTowerInfo);
                                cm.WatchTowerList.add(U)
                            }
                        }
                    }
                }
            }
        }
    }
    if (ac > -1) {
        update_bdg();
        fields_generate();
        cm.TutorialEventDispatcher.dispatchTutorialEvent("complete", "WATCH_SAWMILL_PROGRESS");
        var F = quests_validquests();
        quest_allcompleted(F.valid);
        modal_quests_generate(F.valid, F.recommended, 0)
    }
    var s = seed.queue_tch["city" + currentcityid];
    for (var am = 0; am < s.length; am++) {
        var O = unixtime();
        var l = parseInt(s[am][3]) - O;
        if (l > 0) {
            cm.speedUpModalTimer.update("tch", cm.log.convertToHMS(l, false), l);
            an = true;
            M = true;
            if (S) {
                var p = parseInt(s[am][4]) / parseInt(s[am][5]) + ((O - parseInt(s[am][2])) / (parseInt(s[am][3]) - parseInt(s[am][2]))) * ((parseInt(s[am][5]) - parseInt(s[am][4])) / parseInt(s[am][5]));
                var ab = parseInt(270 * p);
                R.push('<div class="queue_item">');
                R.push('<div class="info"><div class="stat"><span class="item" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 150px; display: inline-block;">');
                R.push(techcost["tch" + s[am][0]][0] + " (" + g_js_strings.commonstr.lv + s[am][1]);
                R.push(')</span><span class="time" style="line-height: 20px; display: block; float: right;">');
                R.push(timestr(l));
                R.push('</span><div class="speedup"><a class="inlineButton red14" name="' + s[am][0] + '" onclick="cm.ResearchSpeedupController.queueClick(event);">');
                R.push("<span>" + g_js_strings.commonstr.speedup + '</span></a></div></div><div class="bar" style="width:');
                R.push(ab);
                R.push('px;">&nbsp;</div></div>');
                R.push('<div class="stats">');
                R.push('<span class="friends">' + g_js_strings.update_queue.frhelp + ": <span>");
                if (seed.updateHelpResearch["city" + currentcityid]) {
                    if (parseInt(seed.updateHelpResearch["city" + currentcityid]["t" + s[am][0]].n) > 0) {
                        R.push(seed.updateHelpResearch["city" + currentcityid]["t" + s[am][0]].n)
                    } else {
                        R.push("0")
                    }
                } else {
                    R.push("0")
                }
                R.push("</span></span>");
                R.push('<span class="allis">' + g_js_strings.update_queue.allihelp + ": <span>");
                if (seed.updateHelpResearch["city" + currentcityid]) {
                    if (parseInt(seed.updateHelpResearch["city" + currentcityid]["t" + s[am][0]].a) > 0) {
                        R.push(seed.updateHelpResearch["city" + currentcityid]["t" + s[am][0]].a)
                    } else {
                        R.push("0")
                    }
                } else {
                    R.push("0")
                }
                R.push("</span></span>");
                R.push("</div>");
                R.push("</div>");
                if ($("alchemymodal")) {
                    $("alchemymodal_tch" + s[am][0] + "_queue_timeleft").innerHTML = timestr(l)
                }
            }
        } else {
            cm.sounds.play("finished_research");
            seed.tech["tch" + s[am][0]] = parseInt(s[am][1]);
            seed.tch_hlp["t" + s[am][0]] = 0;
            seed.queue_tch["city" + currentcityid].splice(am, 1);
            if ($("alchemymodal")) {
                modal_openAlchemy()
            }
            cm.speedUpModalTimer.endSpeedUpModal("tch")
        }
    }
    var aa = seed.queue_craft["city" + currentcityid],
        r, a, b, P, v, t, f, ae, ai, d, y;
    if (aa) {
        if (aa.length > 0) {}
    } else {
        aa = []
    }
    for (var ar = 0, H = aa.length; ar < H; ++ar) {
        r = unixtime();
        a = Number(aa[ar].craftingUnixTime);
        b = Number(aa[ar].craftingEtaUnixTime);
        P = b - r;
        d = Number(aa[ar].craftingId);
        if (!aa[ar].categoryId || !aa[ar].recipeIndex) {
            jQuery.each(recipelist, function (c, i) {
                jQuery.each(i, function (m, j) {
                    if (Number(j.recipe_id) == Number(aa[ar].recipeId)) {
                        f = j.name;
                        ai = Number(c);
                        seed.queue_craft["city" + currentcityid][ar].categoryId = ai;
                        seed.queue_craft["city" + currentcityid][ar].recipeIndex = m;
                        aa[ar].categoryId = ai;
                        aa[ar].recipeIndex = m;
                        return false
                    }
                })
            })
        }
        if (P > 0) {
            an = true;
            M = true;
            cm.speedUpModalTimer.update("craft", cm.log.convertToHMS(P, false), P);
            if (S) {
                v = (r - a) / (b - a);
                t = 270 * v;
                f = recipelist[Number(aa[ar].categoryId)][Number(aa[ar].recipeIndex)].name;
                R.push("<div class='queue_item'>");
                R.push("<div class='info'>");
                R.push("<div class='stat'>");
                R.push("<span class='item'>" + f + "</span>");
                R.push("<span class='time'>" + timestr(P) + "</span>");
                R.push("<div class='speedup'>");
                R.push("<a class='inlineButton red14' onclick='modal_speedup(\"craft\", " + d + ', null, "' + f + "\" );' name=''>");
                R.push("<span>" + g_js_strings.commonstr.speedup + "</span>");
                R.push("</a>");
                R.push("</div>");
                R.push("</div>");
                R.push("<div class='bar' style='width:" + t + "px;'> &nbsp; </div>");
                R.push("</div>");
                R.push("<div class='stats'>");
                R.push("<span class='friends'>" + g_js_strings.update_queue.frhelp + ": <span>0</span></span>");
                R.push("<span class='allis'>" + g_js_strings.update_queue.allihelp + ": <span>0</span></span>");
                R.push("</div>");
                R.push("</div>")
            }
        } else {
            cm.sounds.play("player_completes_a_craft");
            var u = seed.queue_craft["city" + currentcityid][0].categoryId,
                ap = seed.queue_craft["city" + currentcityid][0].recipeIndex,
                e = recipelist[u][ap];
            seed.queue_craft["city" + currentcityid].splice(am, 1);
            cm.speedUpModalTimer.endSpeedUpModal("craft");
            update_seed_ajax()
        }
    }
    var B = unixtime();
    var at = +(seed.queue_throne.start);
    var z = +(seed.queue_throne.end);
    var Y = z - B;
    var T = seed.queue_throne.itemId;
    if (Y > 0) {
        cm.speedUpModalTimer.update("throne", cm.log.convertToHMS(Y, false), Y)
    } else {
        if (T != undefined) {
            kocThroneItems[T].status = 1
        }
        cm.speedUpModalTimer.endSpeedUpModal("throne");
        seed.queue_throne = {}
    }
    var ak = $("queue_train").visible();
    var ah = false;
    if (ak) {
        var ad = new Array()
    }
    var n = -1;
    var ag = seed.queue_unt["city" + currentcityid];
    var aq = Math.min(ag.length, 1);
    for (var am = 0; am < Math.min(ag.length, 1); am++) {
        var O = unixtime();
        var l = parseInt(ag[am][3]) - O;
        if (l > 0) {
            cm.speedUpModalTimer.update("trn", cm.log.convertToHMS(l, false), l);
            an = true;
            ah = true;
            if (ak) {
                var p = parseInt(ag[am][4]) / parseInt(ag[am][5]) + ((O - parseInt(ag[am][2])) / (parseInt(ag[am][3]) - parseInt(ag[am][2]))) * ((parseInt(ag[am][5]) - parseInt(ag[am][4])) / parseInt(ag[am][5]));
                var ab = parseInt(270 * p);
                ad.push('<div class="queue_item">');
                ad.push('<div class="info"><div class="stat"><span class="item">');
                var ao = unitcost["unt" + ag[am][0]][0];
                ad.push(ao);
                ad.push('</span><span class="time">');
                ad.push(timestr(l));
                ad.push("</span>");
                ad.push('<div class="speedup"><a class="inlineButton red14" name="" onclick="modal_speedup( \'trn\', 2, 2, \'' + ao + "', 0 );\">");
                ad.push("<span>" + g_js_strings.commonstr.speedup + "</span></a></div>");
                ad.push('</div><div class="bar" style="width:');
                ad.push(ab);
                ad.push('px;">&nbsp;</div></div>');
                ad.push('<div class="stats">' + g_js_strings.commonstr.amt + ": ");
                ad.push(ag[am][1]);
                if (seed.queue_unt["city" + currentcityid].length > 1) {
                    ad.push('<span class="troop_queue">' + g_js_strings.update_queue.troopqueue + ": " + (seed.queue_unt["city" + currentcityid].length - 1) + "</span>")
                }
                ad.push("</div>");
                ad.push("</div>")
            }
        } else {
            cm.sounds.play("finished_training");
            cm.speedUpModalTimer.endSpeedUpModal("trn");
            seed.units["city" + currentcityid]["unt" + ag[am][0]] = parseInt(seed.units["city" + currentcityid]["unt" + ag[am][0]]) + parseInt(ag[am][1]);
            if ((am + 1) < ag.length) {
                var x = O - parseInt(ag[am + 1][2]);
                ag[am + 1][2] = O;
                ag[am + 1][3] = parseInt(ag[am + 1][3]) + x
            }
            seed.queue_unt["city" + currentcityid].splice(am, 1);
            am--;
            Z = true
        }
    }
    var ag = seed.queue_fort["city" + currentcityid];
    for (var am = 0; am < Math.min(ag.length, 1); am++) {
        var O = unixtime();
        var l = parseInt(ag[am][3]) - O;
        if (l > 0) {
            cm.speedUpModalTimer.update("frt", cm.log.convertToHMS(l, false), l);
            an = true;
            ah = true;
            if (ak) {
                var p = parseInt(ag[am][4]) / parseInt(ag[am][5]) + ((O - parseInt(ag[am][2])) / (parseInt(ag[am][3]) - parseInt(ag[am][2]))) * ((parseInt(ag[am][5]) - parseInt(ag[am][4])) / parseInt(ag[am][5]));
                var ab = parseInt(270 * p);
                ad.push('<div class="queue_item">');
                ad.push('<div class="info"><div class="stat"><span class="item">');
                ad.push(fortcost["frt" + ag[am][0]][0]);
                ad.push('</span><span class="time">');
                ad.push(timestr(l));
                ad.push("</span>");
                ad.push('<div class="speedup"><a class="inlineButton red14" onclick="modal_speedup(');
                ad.push(["'frt'", ag[am][0], 0, "'" + g_js_strings.commonstr.fortification + "'", ag[am][2]].join(","));
                ad.push(');return false;"><span>' + g_js_strings.commonstr.speedup + "</span></a></div>");
                ad.push('</div><div class="bar" style="width:');
                ad.push(ab);
                ad.push('px;">&nbsp;</div>');
                ad.push('</div><div class="stats">' + g_js_strings.commonstr.amt + ": ");
                ad.push(ag[am][1]);
                ad.push("</div>");
                ad.push("</div>")
            }
        } else {
            cm.speedUpModalTimer.endSpeedUpModal("frt");
            seed.fortifications["city" + currentcityid]["fort" + ag[am][0]] = parseInt(seed.fortifications["city" + currentcityid]["fort" + ag[am][0]]) + parseInt(ag[am][1]);
            cityinfo_defenses();
            if ((am + 1) < ag.length) {
                var x = O - parseInt(ag[am + 1][2]);
                ag[am + 1][2] = O;
                ag[am + 1][3] = parseInt(ag[am + 1][3]) + x
            }
            seed.queue_fort["city" + currentcityid].splice(am, 1);
            am--;
            Z = true
        }
    }
    var aj = seed.queue_mkt["city" + currentcityid];
    var V = $("queue_market").visible();
    var J = false;
    if (V) {
        var X = new Array()
    }
    var K = -1;
    var aj = seed.queue_mkt["city" + currentcityid];
    if (!Object.isArray(aj)) {
        var W = Object.keys(aj);
        for (var am = 0; am < W.length; am++) {
            var O = unixtime();
            var D = aj[W[am]];
            for (var al = 0; al < D.length; al++) {
                var l = parseInt(D[al].eventUnixTime) - O;
                if (l > 0) {
                    cm.speedUpModalTimer.update("market", cm.log.convertToHMS(l, false), l);
                    an = true;
                    J = true;
                    if (V) {
                        switch (parseInt(D[al].resourceType)) {
                        case 1:
                            var g = resourceinfo.rec1;
                            break;
                        case 2:
                            var g = resourceinfo.rec2;
                            break;
                        case 3:
                            var g = resourceinfo.rec3;
                            break;
                        case 4:
                            var g = resourceinfo.rec4;
                            break;
                        default:
                        }
                        var p = 1 - (l / (60 * 30));
                        var ab = parseInt(270 * p);
                        var w = (D[al].unitPricex1000) / 1000;
                        X.push('<div class="queue_item">');
                        X.push('<div class="info"><div class="stat"><span class="item">');
                        X.push(g_js_strings.update_queue.akbatc.replace("%1$s", D[al].quantityK).replace("%2$s", g).replace("%3$s", w));
                        X.push('</span><span class="time">');
                        X.push(timestr(l));
                        X.push("</span>");
                        X.push('<div class="speedup"><a class="inlineButton red14" onclick="modal_speedup_market(');
                        X.push(D[al].eventUnixTime + "," + al + "," + D[al].marketDeliveryId);
                        X.push(');return false;"><span>' + g_js_strings.commonstr.speedup + "</span></a></div>");
                        X.push('</div><div class="bar" style="width:');
                        X.push(ab);
                        X.push('px;">&nbsp;</div></div>');
                        X.push("</div>")
                    }
                } else {
                    cm.speedUpModalTimer.endSpeedUpModal("market");
                    seed.queue_mkt["city" + currentcityid][W[am]].splice(al, 1);
                    if (seed.queue_mkt["city" + currentcityid][W[am]].length < 1) {
                        delete seed.queue_mkt["city" + currentcityid][W[am]]
                    }
                    if (Object.keys(seed.queue_mkt["city" + currentcityid]).length < 1) {
                        seed.queue_mkt["city" + currentcityid] = []
                    }
                }
            }
        }
    }
    if (Z) {}
    if (S) {
        $("queue_building").innerHTML = R.join("")
    } else {
        if (ak) {
            $("queue_train").innerHTML = ad.join("")
        } else {
            if (V) {
                $("queue_market").innerHTML = X.join("")
            }
        }
    }
    if (!M) {
        $("queue_building").hide()
    }
    if (!ah) {
        $("queue_train").hide()
    }
    if (!J) {
        $("queue_market").hide()
    }
    if (M || ah || J) {
        $("queue_head_toggle").show();
        if ($("queue_list").visible()) {
            $("queue_head_toggle").removeClassName("expand_button");
            $("queue_head_toggle").addClassName("collapse_button")
        } else {
            $("queue_head_toggle").removeClassName("collapse_button");
            $("queue_head_toggle").addClassName("expand_button")
        }
    } else {
        $("queue_head_toggle").hide();
        $("queue_head_toggle").removeClassName("collapse_button");
        $("queue_head_toggle").addClassName("expand_button")
    }
}
var cm = cm || {};
cm.view = function (a) {
    return {
        setBackground: function () {
            var b = "city06_bg_lvl1";
            var c = [1, 1, 1, 3, 3, 5, 5, 7, 7, 7, 10, 10];
            a.each(c, function (d, e) {
                if (a(".bldg_0_" + d).length > 0) {
                    b = "city06_bg_lvl" + e
                }
            });
            a(".cityNum6").addClass(b)
        },
        addBlank: function () {
            a("#citymap").append("<div class='mapfill_2'>&nbsp;</div>")
        }
    }
}(jQuery);
var maxbdglvl = new Object();

function update_bdg() {
    var l = seed.buildings["city" + currentcityid];
    maxbdglvl = new Object();
    var j = parseInt(cm.cities.selectedIndex());
    var d = "cityNum" + j;
    $("citymap").className = (j == 6 ? "" : "citymap ") + d + " city_" + l.pos0[1];
    if (seed.courtItems) {
        if (seed.courtItems.indexOf("831") >= 0) {
            $("citymap").addClassName("red")
        } else {
            if (seed.courtItems.indexOf("832") >= 0) {
                $("citymap").addClassName("blue")
            } else {
                if (seed.courtItems.indexOf("833") >= 0) {
                    $("citymap").addClassName("purple")
                } else {
                    if (seed.courtItems.indexOf("834") >= 0) {
                        $("citymap").addClassName("green")
                    } else {
                        if (seed.courtItems.indexOf("835") >= 0) {
                            $("citymap").addClassName("yellow")
                        } else {
                            if (seed.courtItems.indexOf("891") >= 0) {
                                $("citymap").addClassName("halloween")
                            }
                        }
                    }
                }
            }
        }
    }
    if (cm.WatchTowerList) {
        var a = cm.WatchTowerList.getCityWatchTower(currentcityid);
        if (a) {
            if (cm.CurrentWatchTowerTimer && cm.CurrentWatchTowerTimer.isActive()) {
                try {
                    document.getElementById("slot_" + a.getSlot()).removeChild(cm.CurrentWatchTowerTimer.getHtmlElement())
                } catch (g) {}
            }
        }
    }
    var m = -1;
    for (var h = 0; h < 33; h++) {
        var q = l["pos" + h];
        if (q == null) {
            $("slot_" + h).className = "blank";
            $("slot_" + h).innerHTML = ""
        } else {
            var f = q[1];
            var o = q[0];
            if (parseInt(f) == 0) {
                f = 1
            }
            $("slot_" + h).className = "bldg_" + o + "_" + f;
            if (h == 0) {
                $("slot_" + h).innerHTML = "<span class='leveltag'>" + f + "</span><span class='statues'></span>"
            } else {
                $("slot_" + h).innerHTML = "<span class='leveltag'>" + f + "</span>"
            }
            maxbdglvl["b" + q[0]] = parseInt(q[1]);
            if (o == cm.BUILDING_TYPES.WATCH_TOWER) {
                m = h
            }
        }
        $("slot_" + h).setOpacity(1)
    }
    for (var h = 0; h < seed.queue_con["city" + currentcityid].length; h++) {
        var n = seed.queue_con["city" + currentcityid][h];
        var e = $("slot_" + n[7]);
        if (e != null) {
            var f = n[1];
            var c = n[2];
            e.innerHTML = "";
            e.addClassName("inprocess");
            var b = document.createElement("span");
            b.className = "backgroundContainer";
            b.innerHTML = "<span class='leveltag'>" + f + "</span><span class='currentlybuilding'></span>";
            e.appendChild(b);
            var p = document.createElement("span");
            p.className = "speedupButton";
            p.innerHTML = "<a class='inlineButton20Red' name='" + c + "' onclick='cm.BuildingSpeedupController.buildingClick(event)'><span>" + g_js_strings.commonstr.speedup + "</span></a>";
            e.appendChild(p)
        }
    }
    cm.view.setBackground();
    cm.view.addBlank();
    if (cm.WatchTowerList) {
        var a = cm.WatchTowerList.getCityWatchTower(currentcityid);
        if (a) {
            if (cm.CurrentWatchTowerTimer && cm.CurrentWatchTowerTimer.isActive()) {
                cm.CurrentWatchTowerTimer.show()
            }
        }
    }
}

function popgoldchg(g, b, a, e) {
    if ((e + a) > 100) {
        e--
    } else {
        if ((e + a) < 100) {
            e++
        }
    }
    var d = g;
    var h = parseInt(b * e / 100);
    var c = 0;
    if (g < h) {
        c = parseInt(((100 - a) * 0.0005) * h);
        d = Math.min(g + c, h)
    } else {
        if (g > h) {
            c = -parseInt((a * 0.0005) * g);
            d = Math.max(g + c, h)
        }
    }
    var f = parseInt(d * (a / 100));
    return [c, f]
}

function invite_friends_popup() {
    var a = Object.clone(g_ajaxparams);
    a.ctrl = "NetworkRequest";
    a.action = "getRequest";
    a.inviteType = cm.InviteTypes.INVITE_TYPE_GENERAL;
    new Ajax.Request(g_ajaxpath + "ajax/_dispatch.php" + g_ajaxsuffix, {
        method: "post",
        parameters: a,
        onSuccess: function (f) {
            var b = ("(" + f.responseText + ")").evalJSON();
            if (!b.ok || !b.invitation || !b.invitation.invitationText || !b.invitation.invitationActionData) {
                Modal.showAlert(printLocalError((b.error_code || null), (b.msg || null), (b.feedback || null)));
                return
            }
            try {
                var c = {
                    body: b.invitation.invitationText,
                    data: Object.toJSON(b.invitation.invitationActionData.parts),
                    googleplus__type: "invite"
                };
                kraken.network.getUser(function (e) {
                    kraken.network.makeRequest(c)
                });
                return
            } catch (d) {}
        },
        onFailure: function () {}
    })
}

function invite_friends_popup_knight() {
    top.location = knightinviteUrl
}

function init() {
    cm.stopwatch.mark("init");
    if (cm.RedundancyManager.init_count++ > 3) {
        return false
    }
    try {
        cm.MixPanelTracker.init()
    } catch (g) {}
    if (seed.playerSettings.s1 == "a") {
        Chat.chatType = 2
    }
    seed.prevtick = unixtime();
    currentcityid = seed.cities[0][0];
    cm.CitySwitch.setCurrentCity(currentcityid);
    cm.guardianCity.init();
    currentcityinfo = seed.cities[0];
    var s = new Array();
    citylist = new Object();
    cm.HUDIconShare.redoImg();
    for (var o = 0; o < seed.cities.length; o++) {
        var n = seed.cities[o][0];
        citylist["city" + n] = seed.prevtick;
        if (o == 0) {
            s.push('<a id="oldcitysel_1" class="sel city"></a>')
        } else {
            s.push('<a id="oldcitysel_' + (o + 1) + '" class="city"></a>')
        }
        seed.citystats["city" + n].pop[0] = parseInt(seed.citystats["city" + n].pop[0]);
        seed.citystats["city" + n].pop[1] = parseInt(seed.citystats["city" + n].pop[1]);
        seed.citystats["city" + n].pop[2] = parseInt(seed.citystats["city" + n].pop[2]);
        seed.citystats["city" + n].gold[0] = parseInt(seed.citystats["city" + n].gold[0]);
        seed.citystats["city" + n].gold[1] = parseInt(seed.citystats["city" + n].gold[1]);
        seed.newTradeReports = parseInt(seed.newTradeReports);
        for (var m = 1; m < 5; m++) {
            seed.resources["city" + n]["rec" + m][0] = parseInt(seed.resources["city" + n]["rec" + m][0]);
            seed.resources["city" + n]["rec" + m][1] = parseInt(seed.resources["city" + n]["rec" + m][1]);
            seed.resources["city" + n]["rec" + m][2] = parseInt(seed.resources["city" + n]["rec" + m][2]);
            seed.resources["city" + n]["rec" + m][3] = parseInt(seed.resources["city" + n]["rec" + m][3])
        }
        var b = seed.queue_con["city" + n];
        var d = Object.keys(seed.buildings["city" + n]);
        for (var h = 0; h < b.length; h++) {
            for (var m = 0; m < d.length; m++) {
                if (seed.buildings["city" + n][d[m]][3] == b[h][2]) {
                    b[h][7] = seed.buildings["city" + n][d[m]][2];
                    break
                }
            }
        }
    }
    if (Object.isArray(seed.items)) {
        if (seed.items.length == 0) {
            seed.items = new Object()
        }
    }
    if (seed.queue_throne.length == 0) {
        seed.queue_throne = {}
    }
    createItems();
    createRecipes();
    createThroneItems();
    var c = Object.keys(seed.tech);
    for (var o = 0; o < c.length; o++) {
        seed.tech[c[o]] = parseInt(seed.tech[c[o]])
    }
    g_reqtime = parseInt(g_reqtime);
    g_restime = parseInt(g_restime);
    g_timeoff = g_restime - parseInt((new Date()).getTime() / 1000);
    startingTime = parseInt((new Date()).getTime() / 1000);
    var f = seed.citystats["city" + currentcityid].pop[0];
    var l = seed.citystats["city" + currentcityid].pop[1];
    var p = seed.citystats["city" + currentcityid].pop[2];
    var e = popgoldchg(f, l, seed.citystats["city" + currentcityid].gold[1], p);
    var r = cm.ThroneController.effectBonus(90);
    p = Math.floor(p + (p * (r / 100)));
    if (p > 100) {
        p = 100
    }
    update_pop();
    update_gold();
    $("stat_happy_num").innerHTML = p + "%";
    if (s.length < 3) {}
    $("maparea_citysel").innerHTML = s.join("");
    $("topnav_level").innerHTML = seed.player.title;
    cm.CitySwitch.init(currentcityid, "city");
    update_bdg();
    var a = quests_validquests();
    quest_allcompleted(a.valid);
    if (window.messages_update_count && typeof messages_update_count == "function") {
        messages_update_count()
    }
    update_knights();
    update_boosts();
    jQuery("#kocinitloading .pBar_full").stop().animate({
        width: "618px"
    }, 20, function () {
        jQuery("#kocinitloading").fadeOut(20, function () {
            if (jQuery("#crossPromoBarContainer").html() != "") {
                jQuery("#crossPromoBarContainer").fadeIn(140)
            }
            jQuery("#main_engagement_tabs").fadeIn(140);
            jQuery("#kochead").fadeIn(140);
            jQuery("#kocmain").fadeIn(140);
            jQuery(".kocFooter").fadeIn(140);
            setcamelottime();
            var i = parseInt(seed.tutorial.t1);
            var x = false;
            var u = false;
            var w = g_showNewTutorial ? cm.BLTutorialSteps : cm.MerlinTutorialSteps;
            if (i == 0) {
                tutorialAdvance(1, 10);
                cm.TutorialManager.init(w);
                cm.TutorialManager.startFromBeginning();
                u = true;
                cm.MixPanelTracker.track("fte_conv_founded_a_kingdom")
            } else {
                if (i == 10) {
                    tutorialAdvance(1, 10);
                    cm.TutorialManager.init(w);
                    cm.TutorialManager.startFromBeginning();
                    u = true
                } else {
                    if (i < 8 && i > 0) {
                        cm.BLTutorialSteps = cm.MerlinTutorialSteps = null;
                        tutorialAdvance(1, 97)
                    } else {
                        if (i > 10 && i < 22) {
                            var y = confirm(g_js_strings.init.tutorialcont);
                            if (y) {
                                cm.TutorialManager.init(w);
                                cm.TutorialManager.startFromBeginning();
                                u = true
                            } else {
                                seed.tutorial.t1 = 99;
                                tutorialAdvance(1, 99);
                                tutorialClear();
                                Modal.hideModalAll();
                                cm.BLTutorialSteps = cm.MerlinTutorialSteps = null
                            }
                        } else {
                            cm.BLTutorialSteps = cm.MerlinTutorialSteps = null
                        }
                    }
                }
            }
            update_might();
            directory_changetab(1);
            update_friendlist();
            if (!cm.TutorialManager.inTutorialMode()) {
                cm.TownCrierFetcher.fetchAnnoucements();
                var j = new cm.InGameDestination();
                if (cm.WorldSettings.hasKeyValuePair("IN_GAME_DESTINATION_ENABLED", "true") && j.isValid()) {
                    j.proceed()
                } else {
                    if (g_allianceWindow != "") {
                        openAllianceWindow(g_allianceWindow);
                        x = true
                    } else {
                        if (g_messageWindow != "") {
                            openMessageWindow(g_messageWindow);
                            x = true
                        } else {
                            if (g_popInviteType) {
                                try {
                                    cm.AlmActivationView.tryRender()
                                } catch (t) {}
                            } else {
                                if (seed.platform.type == "kabam" && cm.WorldSettings.hasKeyValuePair("MWW_ON", "true")) {} else {
                                    if (mmbfreeplay == true) {
                                        cm.mww.start(1);
                                        x = true
                                    }
                                }
                                try {
                                    cm.AlmActivationView.tryRender()
                                } catch (t) {}
                            }
                        }
                    }
                }
            }
            new PeriodicalExecuter(secondupdate, 1);
            new PeriodicalExecuter(statusupdate, 30);
            new PeriodicalExecuter(user_engagement_popup, 240);
            new PeriodicalExecuter(threeminupdate, 180);
            new PeriodicalExecuter(fullupdate, 360);
            Event.observe("mainbody", "click", function () {
                if (g_chatcount > 100) {
                    g_chatcount = 100
                }
            });
            if (!u) {
                jQuery(document).trigger("tutorialEnd");
                ProgressBar.initializeProgressBar(1, true, function () {
                    jQuery("#progressBar").show()
                }, true)
            }
            var v = 2;
            if (window.g_paymentVersion) {
                v = g_paymentVersion
            }
            var q = {
                v: v
            };
            cm.PreloadedPaymentXMLService = new cm.PaymentXMLService(v);
            if (g_modal) {
                if (g_modal == 1) {
                    HelpDesk.show()
                } else {
                    if (g_modal == 2 || g_modal == 3) {
                        modal_getgems()
                    }
                }
            }
            if (seed.beginnerPromo) {
                cm.BeginnerPackageView.init(seed.beginnerPromo)
            }
            if (seed.sale) {
                cm.SalesPromotionView.init(seed.sale)
            }
            cm.DailyRewardsView.init();
            cm.CRMLink.update();
            cm.stopwatch.mark("init_end");
            cm.stopwatch.report()
        })
    });
    update_seed_ajax();
    if (cm.WorldSettings.hasKeyValuePair("LOST_KNIGHTS", "on")) {
        AjaxCall.gPostRequest("ajax/_dispatch.php", {
            ctrl: "LostKnightsRecs",
            action: "getRecommendations"
        }, function () {})
    }
    cm.ReportView.development()
}
jQuery(document).ready(function () {
    cm.stopwatch.mark("document_ready")
});

function createItems() {
    Object.keys(itemlist).each(function (b) {
        var a = Number(b.split("i")[1]);
        ksoItems[a] = new cm.ItemModel(a, itemlist["i" + a]);
        ksoItems[a].count = seed.items["i" + a] ? Number(seed.items["i" + a]) : 0
    });
    (seed.courtItems).each(function (b) {
        if (Number(b) != 0) {
            b = Number(b);
            var a = ksoItems[b];
            a.isEquipped = true
        }
    })
}

function createRecipes() {
    var a, b;
    jQuery.each(recipelist, function (d, c) {
        a = ~~ (1 * d);
        switch (a) {
        case 1:
            jQuery.each(c, function (f, e) {
                b = new cm.RecipeModel(f, e);
                kocRecipes[1][b.id] = b
            });
            break;
        case 2:
            break;
        case 3:
            jQuery.each(c, function (f, e) {
                b = new cm.RecipeModel(f, e);
                kocRecipes[3][b.id] = b
            });
            break;
        case 4:
            kocRecipes.resource = {};
            break;
        case 5:
            kocRecipes.chest = {};
            break;
        case 6:
            kocRecipes.court = {};
            break
        }
    })
}

function createThroneItems() {
    var d, e = seed.throne,
        b = +(e.activeSlot),
        g = e.slotEquip[b],
        f = e.inventory,
        c = [],
        a = {};
    jQuery.each(f, function (h, i) {
        c.push(+h)
    });
    c.sort();
    jQuery.each(c, function (h, i) {
        d = new cm.ThroneItemModel(i, f[i]);
        kocThroneItems[d.id] = d
    });
    if (g) {
        jQuery.each(g, function (h, i) {
            kocThroneItems[i].isEquipped = true
        })
    }
    kocThroneItems = cm.Sort.object(kocThroneItems)
}

function ABTestFriendInviter() {
    var a = (parseInt(user_id) % 2 == 0);
    cm.log.l("ABTestFriendInviter()  user_id=" + user_id + "   evenUser=" + a);
    if (a) {
        cm.invite.load(2);
        cm.invite.open()
    }
}
cm.BootLoader.add(new cm.BootLoaderCallback(init, null, 10));
var g_numoffriendlistpages = 0;
var g_currentfriendlistpage = 0;
var g_friendsperpage = 8;
var g_friendlistitemwidth = 84 + 2;

function friendlist_prev() {
    friendlist_goto(g_currentfriendlistpage - 1)
}

function friendlist_next() {
    friendlist_goto(g_currentfriendlistpage + 1)
}

function friendlist_first() {
    friendlist_goto(1)
}

function friendlist_last() {
    friendlist_goto(g_numoffriendlistpages)
}

function friendlist_goto(a) {
    if (a >= 1 && a <= g_numoffriendlistpages) {
        var c = g_friendsperpage * g_friendlistitemwidth;
        var b = (c * (a - 1)) * (-1);
        $("panel_friendlist").setStyle({
            left: b + "px"
        });
        g_currentfriendlistpage = a
    } else {
        if (a < 1) {
            g_currentfriendlistpage = 1
        } else {
            g_currentfriendlistpage = g_numoffriendlistpages
        }
    }
    friendlist_navstatusupdate()
}

function friendlist_navstatusupdate() {
    if (g_currentfriendlistpage == g_numoffriendlistpages) {
        $("button_friendlist_next").removeClassName("next");
        $("button_friendlist_next").addClassName("next_");
        $("button_friendlist_last").removeClassName("last");
        $("button_friendlist_last").addClassName("last_")
    } else {
        $("button_friendlist_next").removeClassName("next_");
        $("button_friendlist_next").addClassName("next");
        $("button_friendlist_last").removeClassName("last_");
        $("button_friendlist_last").addClassName("last")
    }
    if (g_currentfriendlistpage == 1) {
        $("button_friendlist_prev").removeClassName("prev");
        $("button_friendlist_prev").addClassName("prev_");
        $("button_friendlist_first").removeClassName("first");
        $("button_friendlist_first").addClassName("first_")
    } else {
        $("button_friendlist_prev").removeClassName("prev_");
        $("button_friendlist_prev").addClassName("prev");
        $("button_friendlist_first").removeClassName("first_");
        $("button_friendlist_first").addClassName("first")
    }
}

function main_beginnerupsell_hover(c, a, b) {
    showTooltip(g_js_strings.init.main_beginnnerupsell_hoverexc.replace("%1$s", itemlist.i10000.name), c, a, b)
}
krakenReady = function () {
    jQuery("head").append(g_networkStyleSheet)
};
var cm = cm || {};
cm.makeAnimatedChest = function (f) {
    var j, g, d = 1000,
        l = 3600;
    if (cm.util.isIE() || cm.util.isChrome()) {
        l = 2400
    }

    function c(n) {
        var o = 0;
        for (var m in n) {
            o++
        }
        return o
    }

    function h(m, n) {
        return "<div class='" + m + "' >" + n + "</div>"
    }

    function i(m) {
        var p = c(m.items);
        var n = p * 85;
        var o = (p > 1 ? "These prizes have now " : "This prize has ") + " been added to <strong>Inventory</strong>";
        return b("prize_message_bg", "prize_message_bg.png") + h("title", "Exciting Mystery Chest") + h("txt", o) + "<div class='subItemsContainer'><div class='subItems' style='width: " + n + "px;'>" + e(m) + "</div></div>"
    }

    function b(m, n, o) {
        return "<div class='" + m + "' style='background: url(" + stimgUrl + "img/" + n + ");'>" + (o || "") + "</div>"
    }

    function e(m) {
        var p = "";
        var o = 0;
        for (var n in m.items) {
            p += a(o++, m.items[n], n)
        }
        return p
    }

    function a(m, o, t) {
        var s = t;
        var r = stimgUrl + "img/items/70/" + s + ".jpg?0";
        var n = " style='background: url(" + stimgUrl + "img/icon_bg_x" + o + ".png);'";
        var q = itemlist["i" + s].name + " ~ " + itemlist["i" + s].description;
        var p = q.replace('"', "'");
        return "<div class='sub" + m + " icon_bg' " + n + "><img class='item' src='" + r + "' title=\"" + p + '" />' + b("number_bg", "number_bg.png", "x" + o) + "</div>"
    }

    function k() {
        if (j < g) {
            f(".subItems .sub" + (j++)).fadeIn(d, k)
        }
    }
    return {
        modal: function (m) {
            j = 0;
            g = c(m.items);
            setTimeout(k, l);
            cm.ModalManager.add({
                show: function (n) {
                    f(".chest_animation").remove();
                    var o = "?r=" + cm.util.rand(0, 1000);
                    f(n).append(b("chest_animation", "chest_animation.gif" + o))
                },
                body: i(m),
                style: "background: url(" + stimgUrl + "img/bg_chest_modal.jpg);",
                "class": "animatedChestModal",
                curtain: true,
                width: 591,
                height: 364,
                left: 85,
                top: 100
            });
            f(".icon_bg").hide()
        },
        test: function (m) {
            m = m || 0;
            var n = [];
            n[0] = {
                items: {
                    "7": 1
                }
            };
            n[1] = {
                items: {
                    "7": 1,
                    "401": 2
                }
            };
            n[2] = {
                items: {
                    "7": 1,
                    "401": 2,
                    "4": 3
                }
            };
            n[3] = {
                items: {
                    "7": 1,
                    "401": 2,
                    "4": 3,
                    "211": 4
                }
            };
            n[4] = {
                items: {
                    "7": 1,
                    "401": 2,
                    "4": 3,
                    "211": 4,
                    "512": 5
                }
            };
            n[5] = {
                items: {
                    "7": 1,
                    "401": 2,
                    "4": 3,
                    "211": 4,
                    "512": 5,
                    "522": 5
                }
            };
            n[6] = {
                items: {
                    "7": 1,
                    "401": 1,
                    "4": 1,
                    "211": 1,
                    "512": 1,
                    "522": 1
                }
            };
            n[7] = {
                items: {
                    "7": 5,
                    "401": 5,
                    "4": 5,
                    "211": 5,
                    "512": 5,
                    "522": 5
                }
            };
            cm.makeAnimatedChest.modal(n[m])
        }
    }
}(jQuery);

function modal_maptile(t, v, p, q, r, g, A, E, m, d, b, f, y, c, l, x, n, e, k) {
    if ((new Date()).getTime() - g_mapObject.dragStopTime < 400) {
        return
    }
    g = g == "null" ? "" : unescape(g);
    E = E == "null" ? "" : E;
    var w = g_js_strings.commonstr.ladylord;
    if (r.charAt(0) == "f") {
        w = g_js_strings.commonstr.lady
    } else {
        if (r.charAt(0) == "m") {
            w = g_js_strings.commonstr.lord
        }
    }
    if (v != "null") {
        var C = v
    } else {
        if (v == "null" && f != "null") {
            var C = e
        } else {
            var C = p + "," + q
        }
    }
    var u = new Array();
    var a = false;
    if (f == "city") {
        var j = 0;
        var s = 0;
        if (x) {
            if (x == currentcityid) {
                s = 2
            } else {
                for (var z = 0; z < seed.cities.length; z++) {
                    if (x == seed.cities[z][0]) {
                        s = 1
                    }
                }
            }
        }
        if (s == 2) {
            j = 3
        } else {
            if (s == 1) {
                j = 2
            } else {
                if (l && seed.allianceDiplomacies && seed.allianceDiplomacies.allianceId) {
                    var D = seed.allianceDiplomacies.friendly;
                    if (seed.allianceDiplomacies.allianceId == l) {
                        s = 3;
                        j = 1
                    } else {
                        if (D) {
                            var o = new Hash(D);
                            o.each(function (i) {
                                if (i.key == "a" + l) {
                                    j = 1
                                }
                            })
                        }
                    }
                }
            }
        }
        u.push("<div class='maptilewrap'>");
        u.push("<div class='maptileuserwrap clearfix'>");
        u.push("<div class='leftpic'><img src='" + stimgUrl + "img/avatars/100/" + r + ".jpg'/></div>");
        u.push("<div class='rightinfo'>");
        u.push("<div class='name'>" + w + " " + g + "</div>");
        u.push("<div>" + g_js_strings.commonstr.might + ": " + A + "</div>");
        u.push("<div>" + g_js_strings.commonstr.title + ": " + titlenames[parseInt(E)] + "</div>");
        u.push("<div>" + g_js_strings.commonstr.alliance + ": " + (m == "null" ? "---" : m) + "</div>");
        u.push("<div>" + g_js_strings.commonstr.status + ": " + y + "</div>");
        u.push("</div>");
        u.push("</div>");
        u.push("<div class='maptileinfowrap'>");
        u.push("<div>" + g_js_strings.commonstr.city + ": <span>" + unescape(v) + "</span></div>");
        u.push("<div>" + g_js_strings.commonstr.coordinates + ": ");
        var B = new cm.utils.CoordinateLink(p, q);
        B.setClassName("coordinateLink");
        u.push(B.getHTML());
        u.push("</div>");
        u.push("<div>" + g_js_strings.commonstr.province + ": <span>" + provincenames["p" + b] + "</span></div>");
        u.push("<div><a  onclick='setBookmarkLocation(" + t + ',"' + C + "\");return false;'>" + g_js_strings.modal_maptile.bookmarkloc + "</a></div>");
        u.push("</div>");
        if (j == 3) {
            u.push("<div class='citybtnrow clearfix'>");
            u.push("<a  class='button20' onclick='Modal.hideModal();changeview_city($(\"mod_views_field\"));return false;'><span>" + g_js_strings.modal_maptile.viewcity + "</span></a>");
            u.push("<a  class='button20' onclick='modal_wilderness_view(" + t + "," + c + ',"' + f + '",' + p + "," + q + ");return false;'><span>" + g_js_strings.modal_maptile.viewreinforcements + "</span></a>");
            u.push("<a  class='button20' onclick='Modal.hideModal();changeview_court();return false;'><span>" + g_js_strings.modal_maptile.visitcourt + "</span></a>");
            u.push("</div>")
        } else {
            if (j == 2) {
                u.push("<div class='btnrowleft clearfix'>");
                u.push("<a  class='button20' onclick='Modal.hideModal();citysel_viewother(" + x + ");return false;'><span>" + g_js_strings.modal_maptile.viewcity + "</span></a>");
                u.push("<a id='btnTransport' class='button20' onclick='modal_attack(1," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.transport + "</span></a>");
                u.push("<a id='btnReinforce' class='button20' onclick='modal_attack(2," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.reinforce + "</span></a>");
                u.push("<a  class='button20' onclick='modal_wilderness_view(" + t + "," + c + ',"' + f + '",' + p + "," + q + ");return false;'><span>" + g_js_strings.modal_maptile.viewreinforcements + "</span></a>");
                u.push("<a id='btnReassign' class='button20' onclick='modal_attack(5," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.reassign + "</span></a>");
                u.push("<a  class='button20' onclick='Modal.hideModal();changeview_court();return false;'><span>" + g_js_strings.modal_maptile.visitcourt + "</span></a>");
                u.push("</div>");
                u.push("<div id='error_overmarch'></div>")
            } else {
                if (j == 1) {
                    u.push("<div class='btnrowleft clearfix'>");
                    u.push("<a  class='button20' onclick='Modal.hideModal();cm.ProfileController.open(" + n + ");return false;'><span>" + g_js_strings.commonstr.profile + "</span></a>");
                    u.push("<a  class='button20' onclick='Modal.hideModal();changeview_court(" + n + ");return false;'><span>" + g_js_strings.modal_maptile.visitcourt + "</span></a>");
                    u.push("<a id='btnTransport' class='button20' onclick='modal_attack(1," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.transport + "</span></a>");
                    if (s != 0) {
                        u.push("<a id='btnReinforce' class='button20' onclick='modal_attack(2," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.reinforce + "</span></a>")
                    }
                    u.push("<a  class='button20' onclick='getMessageWindow(" + n + ',"' + escape(g) + "\");return false;'><span>" + g_js_strings.commonstr.message + "</span></a>");
                    u.push("</div>");
                    u.push("<div id='error_overmarch'></div>")
                } else {
                    u.push("<div class='btnrowleft clearfix'>");
                    u.push("<a  class='button20' onclick='Modal.hideModal();changeview_court(" + n + ");return false;'><span>" + g_js_strings.modal_maptile.visitcourt + "</span></a>");
                    u.push("<a id='btnScout' class='button20' onclick='modal_attack(3," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.scout + "</span></a>");
                    u.push("<a id='btnAttack'  class='button20' onclick='modal_attack(4," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.attack + "</span></a>");
                    u.push("<a  class='button20' onclick='getMessageWindow(" + n + ',"' + escape(g) + "\");return false;'><span>" + g_js_strings.commonstr.message + "</span></a>");
                    u.push("</div>");
                    u.push("<div id='error_overmarch'></div>")
                }
            }
        }
        u.push("</div>")
    } else {
        if (f == "bcity") {
            u.push("<div class='maptilewrap'>");
            u.push("<div class='maptileuserwrap clearfix'>");
            u.push("<div class='leftpic'><img src='" + stimgUrl + "img/building_icons/" + f + "_lvl4.png'/></div>");
            u.push("<div class='rightinfo'>");
            u.push("<div class='name'>" + e + " " + g_js_strings.commonstr.lv + c + "</div>");
            u.push("<div>" + g_js_strings.modal_maptile.barbarianinvasion + "</div>");
            u.push("</div>");
            u.push("</div>");
            u.push("<div class='maptileinfowrap'>");
            u.push("<div>" + g_js_strings.commonstr.coordinates + ": ");
            var B = new cm.utils.CoordinateLink(p, q);
            B.setClassName("coordinateLink");
            u.push(B.getHTML());
            u.push("</div>");
            u.push("<div>" + g_js_strings.commonstr.province + ": <span>" + provincenames["p" + b] + "</span></div>");
            u.push("<div><a  onclick='setBookmarkLocation(" + t + ',"' + C + "\");return false;'>" + g_js_strings.modal_maptile.bookmarkloc + "</a></div>");
            u.push("</div>");
            u.push("<div class='btnrow2'>");
            u.push("<a id='btnScout'  class='inlineButton blue20' onclick='modal_attack(3," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.scout + "</span></a>");
            u.push("<a id='btnAttack'  class='inlineButton blue20' onclick='modal_attack(4," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.attack + "</span></a>");
            if (("on" == cm.features.AUTO_ATTACK) && (seed.player.title >= cm.AutoAttackLevelLock)) {
                u.push("<a id='btnRaid' class='inlineButton blue20' onclick='modal_attack(" + cm.MARCH_TYPES.MARCH_TYPE_BARBARIAN + "," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.raid + "</span></a>")
            }
            u.push("</div>");
            u.push("<div id='error_overmarch'></div>");
            u.push("</div>")
        } else {
            if (f == "city_mist") {
                u.push("<div class='maptilewrap'>");
                u.push("<div class='maptileuserwrap clearfix'>");
                u.push("<div class='leftpic'></div>");
                u.push("<div class='rightinfo'>");
                u.push("<div class='name'>???</div>");
                u.push("<div>" + w + ": " + (g || "---") + "</div>");
                u.push("<div>" + g_js_strings.commonstr.might + ": " + (A || "---") + "</div>");
                u.push("<div>" + g_js_strings.commonstr.title + ": " + (titlenames[parseInt(E)] || "---") + "</div>");
                u.push("<div>" + g_js_strings.commonstr.alliance + ": " + (m == "null" ? "---" : m) + "</div>");
                u.push("</div>");
                u.push("</div>");
                u.push("<div class='maptileinfowrap'>");
                u.push("<div>" + g_js_strings.commonstr.coordinates + ": ");
                var B = new cm.utils.CoordinateLink(p, q);
                B.setClassName("coordinateLink");
                u.push(B.getHTML());
                u.push("</div>");
                u.push("<div>" + g_js_strings.commonstr.province + ": <span>" + provincenames["p" + b] + "</span></div>");
                u.push("<div><a  onclick='setBookmarkLocation(" + t + ',"' + C + "\");return false;'>" + g_js_strings.modal_maptile.bookmarkloc + "</a></div>");
                u.push("</div>");
                if (n == tvuid) {
                    if (f == "plain") {
                        if (seed.cities.length < 5) {
                            u.push("<div class='btnrow clearfix' style='margin-left:50px;'>");
                            u.push("<a class='button20' onclick='AddCity.startBuildProcess(" + t + "," + x + ");return false;'><span>" + g_js_strings.modal_maptile.buildcity + "</span></a>")
                        } else {
                            u.push("<div class='btnrow clearfix' style='margin-left:100px;'>")
                        }
                    } else {
                        u.push("<div class='btnrow clearfix' style='margin-left:100px;'>")
                    }
                    u.push("<a  class='button20' onclick='modal_wilderness_view(" + t + "," + c + ',"' + e + '",' + p + "," + q + ");return false;'><span>" + g_js_strings.modal_maptile.viewtroops + "</span></a>");
                    if (x == currentcityid) {
                        u.push("<a  class='button20' onclick='modal_wilderness_abandon(" + t + "," + c + "," + g_mapObject.typeId[f] + "," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.abandon + "</span></a>")
                    } else {
                        u.push("<a  class='button20 unmet' onclick='return false;'><span>" + g_js_strings.commonstr.abandon + "</span></a>")
                    }
                    u.push("<a id='btnReinforce' class='button20' onclick='modal_attack(2," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.reinforce + "</span></a>");
                    u.push("</div>");
                    u.push("<div id='error_overmarch'></div>")
                } else {
                    if (f != "bog") {
                        u.push("<div class='btnrow clearfix'>");
                        u.push("<a id='btnScout'  class='button20' onclick='modal_attack(3," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.scout + "</span></a>");
                        u.push("<a id='btnAttack'  class='button20' onclick='modal_attack(4," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.attack + "</span></a>");
                        u.push("</div>");
                        u.push("<div id='error_overmarch'></div>")
                    }
                }
                u.push("</div>")
            } else {
                a = true;
                var h = (f == "lake" || f == "woods" || f == "grassland" || f == "hills" || f == "mountain" || f == "plain") ? g_js_strings.commonstr.wilderness + " - " : "";
                u.push("<div class='maptilewrap'>");
                u.push("<div class='maptileuserwrap clearfix'>");
                u.push("<div class='leftpic'><img src='" + stimgUrl + "img/building_icons/" + f + "_lvl4.png'/></div>");
                u.push("<div class='rightinfo'>");
                u.push("<div class='name'>" + h + e + " " + g_js_strings.commonstr.lv + c + "</div>");
                if (k) {
                    u.push("<div class='misted'>");
                    u.push(g_js_strings.modal_maptile.ownermisted);
                    u.push("</div>")
                }
                if (f == "bog") {
                    u.push(" <div> " + g_js_strings.modal_maptile.boghint + " </div> ")
                } else {
                    if (f == "boss") {
                        u.push(" <div> " + g_js_strings.modal_maptile.bosshint + " </div> ")
                    } else {
                        u.push("<div>" + w + ": " + (g || "---") + "</div>");
                        u.push("<div>" + g_js_strings.commonstr.might + ": " + (A || "---") + "</div>");
                        u.push("<div>" + g_js_strings.commonstr.title + ": " + (titlenames[parseInt(E)] || "---") + "</div>");
                        u.push("<div>" + g_js_strings.commonstr.alliance + ": " + (m == "null" ? "---" : m) + "</div>")
                    }
                }
                u.push("</div>");
                u.push("</div>");
                u.push("<div class='maptileinfowrap'>");
                u.push("<div>" + g_js_strings.commonstr.coordinates + ": ");
                var B = new cm.utils.CoordinateLink(p, q);
                B.setClassName("coordinateLink");
                u.push(B.getHTML());
                u.push("</div>");
                u.push("<div>" + g_js_strings.commonstr.province + ": <span>" + provincenames["p" + b] + "</span></div>");
                u.push("<div><a  onclick='setBookmarkLocation(" + t + ',"' + C + "\");return false;'>" + g_js_strings.modal_maptile.bookmarkloc + "</a></div>");
                u.push("</div>");
                if (n == tvuid) {
                    if (f == "plain") {
                        if (seed.cities.length < cm.cities.max()) {
                            u.push("<div class='btnrow clearfix' style='margin-left:50px;'>");
                            u.push("<a  class='button20' onclick='AddCity.startBuildProcess(" + t + "," + x + ");return false;'><span>" + g_js_strings.modal_maptile.buildcity + "</span></a>")
                        } else {
                            u.push("<div class='btnrow clearfix' style='margin-left:50px;'>")
                        }
                    } else {
                        u.push("<div class='btnrow clearfix' style='margin-left:50px;'>")
                    }
                    u.push("<a  class='button20' onclick='modal_wilderness_view(" + t + "," + c + ',"' + e + '",' + p + "," + q + ");return false;'><span>" + g_js_strings.modal_maptile.viewtroops + "</span></a>");
                    if (x == currentcityid) {
                        u.push("<a  class='button20' onclick='modal_wilderness_abandon(" + t + "," + c + "," + g_mapObject.typeId[f] + "," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.abandon + "</span></a>")
                    } else {
                        u.push("<a  class='button20 unmet' onclick='return false;'><span>" + g_js_strings.commonstr.abandon + "</span></a>")
                    }
                    u.push("<a id='btnReinforce' class='button20' onclick='modal_attack(2," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.reinforce + "</span></a>");
                    u.push("<a class='button20' onclick='WildDefense.defenseModal(" + t + ");return false;'><span>" + g_js_strings.commonstr.defend + "</span></a>");
                    if (cm.WorldSettings.hasKeyValuePair("PORTAL_BUTTON", "true") && f == "plain") {
                        u.push("<a onmouseover=\"Tooltip.show(event,'" + g_js_strings.modal_maptile.cantportal + '\', [0,0]);" onmouseout="Tooltip.hide();" class="inlineButton gray20"><span>' + g_js_strings.modal_myitems_use_teleport.teleport + "</span></a>")
                    }
                    u.push("</div>");
                    u.push("<div id='error_overmarch'></div>")
                } else {
                    u.push("<div class='btnrow clearfix'>");
                    if (f == "bog") {
                        u.push("<a id='btnScout' class='inlineButton gray20'><span>" + g_js_strings.commonstr.scout + "</span></a>");
                        u.push("<a id='btnAttack' class='inlineButton gray20'><span>" + g_js_strings.commonstr.attack + "</span></a>")
                    } else {
                        if (n) {
                            u.push("<a  class='button20' onclick='Modal.hideModal();cm.ProfileController.open(" + n + ");return false;'><span>" + g_js_strings.commonstr.profile + "</span></a>")
                        }
                        u.push("<a id='btnScout' class='button20' onclick='modal_attack(3," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.scout + "</span></a>");
                        u.push("<a id='btnAttack' class='button20' onclick='modal_attack(4," + p + "," + q + ");return false;'><span>" + g_js_strings.commonstr.attack + "</span></a>")
                    }
                    if (f == "plain" && cm.WorldSettings.hasKeyValuePair("PORTAL_BUTTON", "true")) {
                        if (x != Number(currentcityid) && x != null && x != 0) {
                            u.push("<a id='btnScout' class='inlineButton gray20'><span>" + g_js_strings.modal_myitems_use_teleport.teleport + "</span></a>")
                        } else {
                            u.push("<a id='btnScout' class='button20' onclick='teleport_modal(\"cityname\"," + p + "," + q + ");'><span>" + g_js_strings.modal_myitems_use_teleport.teleport + "</span></a>")
                        }
                    }
                    u.push("</div>");
                    u.push("<div id='error_overmarch'></div>")
                }
                u.push("</div>")
            }
        }
    }
    Modal.showModal(500, 400, 120, 190, g_js_strings.modaltitles.profile, u.join(""));
    if (a) {
        alliances_check(l)
    }
    attack_checkOverMarch()
}

function alliances_check(c) {
    if (c && seed.allianceDiplomacies && seed.allianceDiplomacies.allianceId) {
        if (seed.allianceDiplomacies.allianceId == c) {
            var a = ["btnScout", "btnAttack"];
            for (var b = 0; b < a.length; b++) {
                if ($(a[b])) {
                    $(a[b]).setOpacity(0.5);
                    $(a[b]).setStyle("cursor: default");
                    $(a[b]).onclick = function () {
                        return false
                    }
                }
            }
        }
    }
}

function teleport_modal(d, n, l) {
    var j = {
        cancel: {
            txt: g_js_strings.commonstr.cancel,
            cls: "inlineButton brown20",
            exe: function () {
                Modal.hideModal()
            }
        },
        okay: {
            id: "mapProfileOkButton",
            txt: g_js_strings.modal_maptile.portalmodalOkButton,
            cls: (ksoItems[912].count > 0) ? "inlineButton blue20" : "inlineButton gray20",
            exe: function () {
                if (ksoItems[912].count > 0) {
                    teleport_modal_use(n, l)
                }
            }
        }
    };
    var m;
    var k = seed.cities;
    for (var f = 0, h = k.length; f < h; ++f) {
        if (k[f][0] == currentcityid) {
            m = k[f][1]
        }
    }
    var b = g_js_strings.modal_maptile.portalmodalNotification.replace("%1$s", m);
    b += " to (" + n + "," + l + ")?";
    var e = stimgUrl + "img/items/70/912.jpg";
    var p = ksoItems[912].count;
    var a = ksoItems[912].price;
    var g = g_js_strings.commonstr.buy;
    var c = ksoItems[912].name;
    var o = cm.Template.renderTemplate("MapProfile", "mapPortal", {
        notification: b,
        portalSrc: e,
        portalQuantity: p,
        gemAmount: a,
        buyLabel: g,
        itemLabel: c
    });
    Modal.multiButton({
        additionalClass: "v2 mapPortalContainer",
        title: g_js_strings.modal_maptile.portalmodalTitle,
        body: o,
        buttons: j,
        buttonContainerClass: "inlineButtonRow clearfix",
        hasInlineDescription: false
    })
}

function teleport_modal_buy() {
    var c = ~~ (1 * seed.player.gems),
        b = ksoItems[912].price,
        a = (c >= b) ? true : false;
    if (a) {
        cm.ShopController.easyBuy(912, function () {
            $("mapProfilePortalAmount").innerHTML = ksoItems[912].count;
            $("mapProfileGemAmount").innerHTML = ksoItems[912].price;
            if (ksoItems[912].count > 0) {
                $("mapProfileOkButton").className = "blue20 inlineButton"
            } else {
                $("mapProfileOkButton").className = "gray20 inlineButton"
            }
        })
    } else {
        cm.ModalManager.alert({
            text: g_js_strings.guardian_err.notEnoughGems,
            button_text: g_js_strings.guardian_err.getMore,
            exe: function () {
                cm.ModalManager.close();
                modal_getgems()
            }
        })
    }
}

function teleport_modal_use(x, y) {
    var params = Object.clone(g_ajaxparams);
    params.iid = 912;
    params.cid = currentcityid;
    params.xcoord = x;
    params.ycoord = y;
    new Ajax.Request(g_ajaxpath + "ajax/relocate.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                top.location = appUrl
            } else {
                if (rslt.msg) {
                    $("mapProfileErrorMessage").innerHTML = rslt.msg;
                    $("mapProfileErrorMessage").show()
                }
            }
        },
        onFailure: function () {
            if (rslt.msg) {
                $("mapProfileErrorMessage").innerHTML = rslt.msg;
                $("mapProfileErrorMessage").show()
            }
        }
    })
};

function reCenterMapWithCoor(f, e) {
    var d = typeof f == "number" ? f : parseInt($("mapXCoor").value);
    var c = typeof e == "number" ? e : parseInt($("mapYCoor").value);
    d = (isNaN(d)) ? 0 : d;
    d = (d > 749) ? 749 : d;
    d = (d < 0) ? 0 : d;
    c = (isNaN(c)) ? 0 : c;
    c = (c > 749) ? 749 : c;
    c = (c < 0) ? 0 : c;
    $("mapXCoor").value = d;
    $("mapYCoor").value = c;
    var b = d;
    var a = c;
    g_mapObject = new MapObject(b, a)
}

function startMap(c) {
    cm.WildernessNameLookup = {
        "10": g_js_strings.commonstr.grassland,
        "11": g_js_strings.commonstr.lake,
        "20": g_js_strings.commonstr.woods,
        "30": g_js_strings.commonstr.hills,
        "40": g_js_strings.commonstr.mountain,
        "50": g_js_strings.commonstr.plain
    };
    currentcityinfo = seed.cities[0];
    var b = currentcityinfo[2];
    var a = currentcityinfo[3];
    $("mapXCoor").value = b;
    $("mapYCoor").value = a;
    g_mapObject = new MapObject(b, a)
}
var MapObject = Class.create({
    initialize: function (a, c) {
        that = this;
        this.horWindowSizeHalf = 380;
        this.verWindowSizeHalf = 227;
        this.map = $("map1");
        this.centerleft = a;
        this.centertop = c;
        this.lastCenterLeft = a;
        this.lastCenterTop = c;
        this.hpxmultiplier = 96;
        this.vpxmultiplier = 58;
        this.blockmaxcount = 75;
        this.maxtilerow = 750;
        this.maxtilecol = 750;
        this.leftedgesize = 480;
        this.topedgesize = 290;
        this.tileCache = {};
        this.loadingQueue = {
            requestCount: 0,
            isLoading: false
        };
        this.setPosition();
        this.getMoreSlots();
        this.dragStopTime = 0;
        this.isDragging = false;
        var b = jQuery("#map1");
        var d = this;
        if ("on" == cm.features.JQUERY_MAPDRAG) {
            b.draggable({
                start: function (e) {
                    that.isDragging = true;
                    removeTooltip()
                },
                stop: function (e) {
                    that.isDragging = false;
                    that.dragStopTime = (new Date()).getTime();
                    that.changePosition()
                }
            })
        } else {
            this.mapdrag = new Draggable("map1", {
                revert: false,
                onStart: function (e, g) {
                    var f = g.target.onclick;
                    g.target.onclick = function () {
                        g.target.onclick = f;
                        return false
                    }
                },
                onEnd: function () {
                    that.changePosition()
                }
            })
        }(function (h) {
            if ("on" != cm.features.MAP_FPS) {
                return
            }
            var k = null;
            var e = null;
            var f = {
                65: 1,
                68: 1,
                83: 1,
                87: 1
            };
            var j = h("#maparea_map");
            var m = h("#mapXCoor");
            var l = h("#mapYCoor");
            var i = null;
            var g = function (n) {
                    var o = (new Date).getTime();
                    if (o - i > 1000) {
                        return
                    }
                    if (n && (o > n)) {
                        setTimeout(function () {
                            g(o + 30)
                        }, 10);
                        return
                    }
                    if (!k) {
                        return
                    }
                    var q = 0;
                    var p = 0;
                    switch (k) {
                    case 87:
                        p = +30;
                        break;
                    case 83:
                        p = -30;
                        break;
                    case 65:
                        q = 30;
                        break;
                    case 68:
                        q = -30;
                        break
                    }
                    var r = b.offset();
                    r.top += p;
                    r.left += q;
                    b.offset(r);
                    setTimeout(function () {
                        g(o + 60)
                    }, 50);
                    d.changePositionQueued();
                    m.val(d.centerleft);
                    l.val(d.centertop)
                };
            h(window.document).keydown(function (n) {
                if ((undefined == f[n.which]) || (j.css("display") === "none") || Modal.modalid || (n.target.tagName == "INPUT")) {
                    return
                }
                i = (new Date()).getTime();
                if (k) {
                    return
                }
                k = n.which;
                g()
            });
            h(window.document).keyup(function (n) {
                if (k) {
                    k = null
                }
            })
        })(jQuery);
        this.typeId = {
            bog: 0,
            grassland: 10,
            lake: 11,
            woods: 20,
            hills: 30,
            mountain: 40,
            plain: 50,
            city: 51,
            ruin: 52,
            boss: 54,
            city_mist: 53,
            camelot1: 101,
            camelot2: 102,
            camelot3: 103,
            camelot4: 104,
            camelot5: 105,
            camelot6: 106
        };
        this.types = [];
        this.types[this.typeId.bog] = "bog";
        this.types[this.typeId.grassland] = "grassland";
        this.types[this.typeId.lake] = "lake";
        this.types[this.typeId.woods] = "woods";
        this.types[this.typeId.hills] = "hills";
        this.types[this.typeId.mountain] = "mountain";
        this.types[this.typeId.plain] = "plain";
        this.types[this.typeId.city] = "city";
        this.types[this.typeId.ruin] = "ruin";
        this.types[this.typeId.boss] = "boss";
        this.types[this.typeId.city_mist] = "city_mist";
        this.types[this.typeId.camelot1] = "camelot1";
        this.types[this.typeId.camelot2] = "camelot2";
        this.types[this.typeId.camelot3] = "camelot3";
        this.types[this.typeId.camelot4] = "camelot4";
        this.types[this.typeId.camelot5] = "camelot5";
        this.types[this.typeId.camelot6] = "camelot6";
        this.ttMsg = [];
        this.ttMsg.bcity = g_js_strings.MapObject.bcitydesc2;
        this.ttMsg.lake = g_js_strings.MapObject.lakedesc2;
        this.ttMsg.woods = g_js_strings.MapObject.woodsdesc2;
        this.ttMsg.grassland = g_js_strings.MapObject.grassdesc2;
        this.ttMsg.hills = g_js_strings.MapObject.hillsdesc2;
        this.ttMsg.mountain = g_js_strings.MapObject.mtndesc2;
        this.ttMsg.plain = g_js_strings.MapObject.plaindesc2;
        this.ttMsg.ruin = g_js_strings.MapObject.ruindesc2;
        this.ttMsg.bog = g_js_strings.MapObject.bogdesc2;
        this.ttMsg.boss = g_js_strings.MapObject.bossdesc2;
        this.typename = [];
        this.typename.bcity = g_js_strings.commonstr.barbariancamp;
        this.typename.bog = g_js_strings.commonstr.bog;
        this.typename.grassland = g_js_strings.commonstr.grassland;
        this.typename.lake = g_js_strings.commonstr.lake;
        this.typename.woods = g_js_strings.commonstr.woods;
        this.typename.hills = g_js_strings.commonstr.hills;
        this.typename.mountain = g_js_strings.commonstr.mountain;
        this.typename.plain = g_js_strings.commonstr.plain;
        this.typename.city = g_js_strings.commonstr.city;
        this.typename.ruin = g_js_strings.commonstr.ruin;
        this.typename.boss = g_js_strings.commonstr.boss;
        this.typename.camelot1 = "Camelot";
        this.typename.camelot2 = "Camelot";
        this.typename.camelot3 = "Camelot";
        this.typename.camelot4 = "Camelot";
        this.typename.camelot5 = "Camelot";
        this.typename.camelot6 = "Camelot"
    },
    setPosition: function () {
        that.map.style.left = "-" + ((that.centerleft * that.hpxmultiplier) + that.leftedgesize - that.horWindowSizeHalf) + "px";
        that.map.style.top = "-" + ((that.centertop * that.vpxmultiplier) + that.topedgesize - that.verWindowSizeHalf) + "px"
    },
    setCenterSlot: function () {
        var b = that.map.positionedOffset()[0];
        var a = that.map.positionedOffset()[1];
        that.centerleft = parseInt(((b * -1) + that.horWindowSizeHalf - that.leftedgesize) / that.hpxmultiplier);
        that.centertop = parseInt(((a * -1) + that.verWindowSizeHalf - that.topedgesize) / that.vpxmultiplier);
        if (that.centerleft <= 0) {
            that.centerleft = 740;
            that.setPosition()
        } else {
            if (that.centerleft >= 750) {
                that.centerleft = 5;
                that.setPosition()
            }
        }
        if (that.centertop <= -3) {
            that.centertop = 743;
            that.setPosition()
        } else {
            if (that.centertop >= 750) {
                that.centertop = 3;
                that.setPosition()
            }
        }
    },
    getSlotCity: function (b, a) {
        var f = seed.cities;
        for (var e = 0; e < f.length; e++) {
            var g = f[e][0];
            if (b == 1) {
                if (g == a) {
                    return (roman[e])
                }
            } else {
                var d = Object.keys(seed.wilderness["city" + g]);
                for (var c = 0; c < d.length; c++) {
                    if (seed.wilderness["city" + g][d[c]].tileId == a) {
                        return (roman[e])
                    }
                }
            }
        }
        return ""
    },
    populateSlots: function (w, x, o) {
        var aa = new Hash(w);
        var A = aa.keys();
        var X = A.length;
        var s = "";
        for (var V = 0; V < X; V++) {
            var u = A[V];
            var Y = "tip_" + A[V];
            var M = aa.get(u);
            var ab = parseInt(M.xCoord);
            var y = parseInt(M.yCoord);
            var R = that.types[M.tileType];
            var Q = M.tileLevel;
            var N = (ab * that.hpxmultiplier + that.leftedgesize) + "px";
            var c = (y * that.vpxmultiplier + that.topedgesize) + "px";
            var S = 150;
            var L = M.misted;
            var z = null;
            var l = null;
            var J = null;
            var Z = null;
            var G = null;
            var d = null;
            var W = null;
            var K = null;
            if (M.tileUserId) {
                var k = o["u" + M.tileUserId];
                if (k && k.length != 0) {
                    z = k.n;
                    l = k.m;
                    J = k.t;
                    Z = k.s.toLowerCase() + k.i;
                    switch (parseInt(k.w)) {
                    case 1:
                        G = g_js_strings.commonstr.normal;
                        break;
                    case 2:
                        G = g_js_strings.MapObject.begprotect;
                        break;
                    case 3:
                        G = g_js_strings.commonstr.truce;
                        break;
                    case 4:
                        G = g_js_strings.commonstr.vacation;
                        break;
                    default:
                        G = g_js_strings.commonstr.normal
                    }
                    if (k.a && k.a != 0) {
                        d = x["a" + k.a];
                        W = k.a
                    }
                }
            }
            var B = "";
            var t = "";
            var q = "";
            if (y % S == 0) {
                B += "border-top:2px dashed #a02932;";
                q += "border-top:2px dashed #a02932;"
            }
            if (ab % S == 0) {
                B += "border-left:2px dashed #a02932;";
                t += "border-left:2px dashed #a02932;"
            }
            if (y == 749) {
                B += "border-bottom:2px dashed #a02932;";
                q += "border-bottom:2px dashed #a02932;"
            }
            if (ab == 749) {
                B += "border-right:2px dashed #a02932;";
                t += "border-right:2px dashed #a02932;"
            }
            if (R == "city" && !M.tileUserId) {
                R = "bcity"
            }
            var g = $("maparea_citysel").select(".sel")[0].id;
            var f = 0;
            if (g) {
                f = parseInt(g.split("_")[1]) - 1
            }
            var E = seed.cities[f][2];
            var r = seed.cities[f][3];
            var n = this.distance(E, r, ab, y);
            var m = g_js_strings.commonstr.distance + ": <span class='distance'>" + n + "</span>";
            if (M.tileType == 54 || M.tileType == "54") {}
            var v = "";
            var C = "";
            var h = "";
            var P = "";
            if (M.tileType >= 100) {
                v = "<div>(" + ab + "," + y + ") Camelot</div>"
            } else {
                if (M.tileUserId && M.tileUserId == tvuid) {
                    var a = "";
                    P = "rogreen";
                    if (M.tileType == 51) {
                        a = this.getSlotCity(1, M.tileCityId)
                    } else {
                        a = this.getSlotCity(2, M.tileId)
                    }
                    C = "<div class='roicon'>" + a + "</div>";
                    if (M.tileType == 51) {
                        if (currentcityid == M.tileCityId) {
                            h += "<div>(" + ab + "," + y + ") " + M.cityName || g_js_strings.MapObject.cityname + "</div>"
                        } else {
                            h += "<div>(" + ab + "," + y + ") " + m + "</div><div>" + M.cityName || g_js_strings.MapObject.cityname + "</div>"
                        }
                        h += "<div>" + g_js_strings.commonstr.might + ": " + (l || "----") + "</div>";
                        h += "<div>" + g_js_strings.commonstr.alliance + ": " + (d || "----") + "</div>"
                    } else {
                        var e = (seed.wildDef["t" + M.tileId]) ? parseInt(seed.wildDef["t" + M.tileId].fort60Count) : 0;
                        var I = (seed.wildDef["t" + M.tileId]) ? WildDefense.c_mercenaryList[parseInt(seed.wildDef["t" + M.tileId].mercLevel)] : "";
                        var U = "";
                        if (e > 0) {
                            U += e + " " + g_js_strings.commonstr.traps + "<br>"
                        }
                        if (I != "") {
                            U += g_js_strings.commonstr.mercenary + " - " + I
                        }
                        h += "<div>(" + ab + "," + y + ") " + m + "</div>";
                        h += "<div>" + g_js_strings.commonstr.wilderness + " - " + that.typename[R] + " " + g_js_strings.commonstr.lv + Q + "</div>";
                        h += "<div>" + g_js_strings.MapObject.ownedbyyou + "(" + seed.player.name + ") </div>";
                        h += "<div>" + ((U == "") ? "No defenses" : U) + "</div>"
                    }
                } else {
                    if (M.tileUserId && parseInt(M.tileUserId) > 0) {
                        C = "<div class='roicon'></div>";
                        h += "<div>(" + ab + "," + y + ") " + m + "</div>";
                        if (M.tileType == 51) {
                            h += "<div>" + M.cityName || g_js_strings.MapObject.cityname + "</div>"
                        } else {
                            h += "<div>" + g_js_strings.commonstr.wilderness + " - " + that.typename[R] + " " + g_js_strings.commonstr.lv + Q + "</div>"
                        }
                        h += "<div>" + g_js_strings.MapObject.ownedby + ": " + (z || "----") + "</div>";
                        h += "<div>" + g_js_strings.commonstr.might + ": " + (l || "----") + "</div>";
                        if (W) {
                            h += "<div>" + g_js_strings.commonstr.alliance + ": " + (d || "----");
                            h += "(";
                            if (seed.allianceDiplomacies && seed.allianceDiplomacies.allianceId == W) {
                                P = "roblue";
                                h += g_js_strings.commonstr.yours
                            } else {
                                if (seed.allianceDiplomacies && seed.allianceDiplomacies.hostile && seed.allianceDiplomacies.hostile["a" + W]) {
                                    P = "rored";
                                    h += g_js_strings.commonstr.hostile
                                } else {
                                    if (seed.allianceDiplomacies && ((seed.allianceDiplomacies.friendly && seed.allianceDiplomacies.friendly["a" + W]) || (seed.allianceDiplomacies.friendlyToThem && seed.allianceDiplomacies.friendlyToThem["a" + W]))) {
                                        P = "roblue";
                                        h += g_js_strings.commonstr.friendly
                                    } else {
                                        P = "royellow";
                                        h += g_js_strings.commonstr.neutral
                                    }
                                }
                            }
                            h += ")"
                        } else {
                            P = "royellow"
                        }
                        h += "</div>"
                    } else {
                        if (R == "city_mist") {
                            P = "royellow";
                            C = "<div class='roicon'></div>";
                            h += "<div>(" + ab + "," + y + ") " + m + "</div>";
                            h += "<div>?????</div>";
                            h += "<div>" + g_js_strings.commonstr.might + ": ?????</div>";
                            h += "<div>" + g_js_strings.commonstr.alliance + ": ?????</div>"
                        } else {
                            if (L) {
                                P = "royellow";
                                C = "<div class='roicon'></div>";
                                h += "<div>(" + ab + "," + y + ") " + m + "</div>";
                                h += "<div>" + g_js_strings.commonstr.wilderness + " - " + that.typename[R] + " " + g_js_strings.commonstr.lv + Q + "</div>";
                                h += "<div>" + g_js_strings.commonstr.might + ": ?????</div>";
                                h += "<div>" + g_js_strings.commonstr.alliance + ": ?????</div>"
                            } else {
                                P = "royellow";
                                C = "<div class='roicon'></div>";
                                h += "<div>(" + ab + "," + y + ") " + m + "</div>";
                                if (R == "lake" || R == "woods" || R == "grassland" || R == "hills" || R == "mountain") {
                                    h += "<div>" + g_js_strings.commonstr.wilderness + " - " + that.typename[R] + " " + g_js_strings.commonstr.lv + Q + "</div>";
                                    h += "<div>" + that.ttMsg[R].replace("%1$s", ((5 * parseInt(Q)) + "%")) + "</div>"
                                } else {
                                    h += "<div>" + that.typename[R] + " " + g_js_strings.commonstr.lv + Q + "</div>";
                                    h += "<div>" + that.ttMsg[R] + "</div>"
                                }
                            }
                        }
                    }
                }
            }
            v = escape("<div class='" + P + "'>" + h + C + "</div>");
            var D = "";
            var b = "";
            if (M.tileType != 0 && R != "bcity" && R != "ruin" && R != "city_mist" && M.tileType <= 100) {
                if (M.tileUserId && M.tileUserId == tvuid) {
                    D = " mapcastle";
                    if (M.tileType == 51) {
                        b = this.getSlotCity(1, M.tileCityId)
                    } else {
                        b = this.getSlotCity(2, M.tileId)
                    }
                } else {
                    if (M.tileUserId && M.tileUserId > 0) {
                        if (seed.allianceDiplomacies && (seed.allianceDiplomacies.allianceId == W)) {
                            D = " shield"
                        } else {
                            if (seed.allianceDiplomacies && ((seed.allianceDiplomacies.friendly && seed.allianceDiplomacies.friendly["a" + W]) || (seed.allianceDiplomacies.friendlyToThem && seed.allianceDiplomacies.friendlyToThem["a" + W]))) {
                                D = " shield"
                            } else {
                                if (seed.allianceDiplomacies && seed.allianceDiplomacies.hostile && seed.allianceDiplomacies.hostile["a" + W]) {
                                    D = " sword"
                                }
                            }
                        }
                    }
                }
            }
            var O = "_" + Q + D;
            var T = R + O;
            var j = M && parseInt(M.cityNum) > 5 ? "city" + M.cityNum + O : T;
            if (M.tileUserId && M.tileUserId == tvuid && M.tileType == 51 && parseInt(seed.playerEffects.fogExpire) > F) {
                j = "city_mist_0"
            }
            if (M.tileType == 54 || M.tileType == "54") {}
            var F = unixtime();
            if (seed.con_hlp == 5) {
                s += "<a style='" + B + "top:" + c + ";left:" + N + ";' class='" + j + " slot'><span>HELLO</span></a>"
            } else {
                s += "<a onclick='modal_maptile(" + M.tileId + ',"' + escape(M.cityName) + '",' + ab + "," + y + ',"' + Z + '","' + escape(z) + '",' + (l || '"--------"') + ',"' + J + '","' + d + '",' + K + "," + M.tileProvinceId + ',"' + R + '","' + G + '",' + Q + "," + W + "," + M.tileCityId + "," + M.tileUserId + ',"' + that.typename[R] + '",' + L + ");return false;' onmouseover='showMapTileTooltip(\"" + v + '",this,event,"mapwindow", ' + ab + ", " + y + ");return false;' onmouseout='removeTooltip();return false;' id='" + u + "' style='" + B + "top:" + c + ";left:" + N + ";' class='" + j + " slot'><span>" + b + "</span></a>"
            }
            if (ab >= 745) {
                var H = ((ab - 745) * that.hpxmultiplier) + "px";
                var ac = "eh_" + u;
                s += "<a onclick='modal_maptile(" + M.tileId + ',"' + escape(M.cityName) + '",' + ab + "," + y + ',"' + Z + '","' + escape(z) + '",' + (l || '"--------"') + ',"' + J + '","' + d + '",' + K + "," + M.tileProvinceId + ',"' + R + '","' + G + '",' + Q + "," + W + "," + M.tileCityId + "," + M.tileUserId + ',"' + that.typename[R] + '",' + L + ");return false;' onmouseover='showMapTileTooltip(\"" + v + '",this,event,"mapwindow", ' + ab + ", " + y + ");return false;' onmouseout='removeTooltip();return false;' id='" + ac + "' style='" + q + "top:" + c + ";left:" + H + ";' class='" + j + " slot'><span></span></a>"
            } else {
                if (ab < 5) {
                    var ac = "eh_" + u;
                    var H = (((ab + 750) * that.hpxmultiplier) + that.leftedgesize) + "px";
                    s += "<a onclick='modal_maptile(" + M.tileId + ',"' + escape(M.cityName) + '",' + ab + "," + y + ',"' + Z + '","' + escape(z) + '",' + (l || '"--------"') + ',"' + J + '","' + d + '",' + K + "," + M.tileProvinceId + ',"' + R + '","' + G + '",' + Q + "," + W + "," + M.tileCityId + "," + M.tileUserId + ',"' + that.typename[R] + '",' + L + ");return false;' onmouseover='showMapTileTooltip(\"" + v + '",this,event,"mapwindow", ' + ab + ", " + y + ");return false;' onmouseout='removeTooltip();return false;' id='" + ac + "' style='" + q + "top:" + c + ";left:" + H + ";' class='" + j + " slot'><span></span></a>"
                }
            }
            if (y >= 745) {
                var ac = "ev_" + u;
                var p = ((y - 745) * that.vpxmultiplier) + "px";
                s += "<a onclick='modal_maptile(" + M.tileId + ',"' + escape(M.cityName) + '",' + ab + "," + y + ',"' + Z + '","' + escape(z) + '",' + (l || '"--------"') + ',"' + J + '","' + d + '",' + K + "," + M.tileProvinceId + ',"' + R + '","' + G + '",' + Q + "," + W + "," + M.tileCityId + "," + M.tileUserId + ',"' + that.typename[R] + '",' + L + ");return false;' onmouseover='showMapTileTooltip(\"" + v + '",this,event,"mapwindow", ' + ab + ", " + y + ");return false;' onmouseout='removeTooltip();return false;' id='" + ac + "' style='" + t + "top:" + p + ";left:" + N + ";' class='" + j + " slot'><span></span></a>"
            } else {
                if (y < 5) {
                    var ac = "ev_" + u;
                    var p = (((y + 750) * that.vpxmultiplier) + that.topedgesize) + "px";
                    s += "<a onclick='modal_maptile(" + M.tileId + ',"' + escape(M.cityName) + '",' + ab + "," + y + ',"' + Z + '","' + escape(z) + '",' + (l || '"--------"') + ',"' + J + '","' + d + '",' + K + "," + M.tileProvinceId + ',"' + R + '","' + G + '",' + Q + "," + W + "," + M.tileCityId + "," + M.tileUserId + ',"' + that.typename[R] + '",' + L + ");return false;' onmouseover='showMapTileTooltip(\"" + v + '",this,event,"mapwindow", ' + ab + ", " + y + ");return false;' onmouseout='removeTooltip();return false;' id='" + ac + "' style='" + t + "top:" + p + ";left:" + N + ";' class='" + j + " slot'><span></span></a>"
                }
            }
            if (y >= 745 && ab >= 745) {
                var p = ((y - 745) * that.vpxmultiplier) + "px";
                var H = ((ab - 745) * that.hpxmultiplier) + "px";
                var ac = "c_" + u;
                s += "<a onclick='modal_maptile(" + M.tileId + ',"' + escape(M.cityName) + '",' + ab + "," + y + ',"' + Z + '","' + escape(z) + '",' + (l || '"--------"') + ',"' + J + '","' + d + '",' + K + "," + M.tileProvinceId + ',"' + R + '","' + G + '",' + Q + "," + W + "," + M.tileCityId + "," + M.tileUserId + ',"' + that.typename[R] + '",' + L + ");return false;' onmouseover='showMapTileTooltip(\"" + v + '",this,event,"mapwindow", ' + ab + ", " + y + ");return false;' onmouseout='removeTooltip();return false;' id='" + ac + "' style='top:" + p + ";left:" + H + ";' class='" + j + " slot'><span></span></a>"
            }
            if (y < 5 && ab >= 745) {
                var p = (((y + 750) * that.vpxmultiplier) + that.topedgesize) + "px";
                var H = ((ab - 745) * that.hpxmultiplier) + "px";
                var ac = "c_" + u;
                s += "<a onclick='modal_maptile(" + M.tileId + ',"' + escape(M.cityName) + '",' + ab + "," + y + ',"' + Z + '","' + escape(z) + '",' + (l || '"--------"') + ',"' + J + '","' + d + '",' + K + "," + M.tileProvinceId + ',"' + R + '","' + G + '",' + Q + "," + W + "," + M.tileCityId + "," + M.tileUserId + ',"' + that.typename[R] + '",' + L + ");return false;' onmouseover='showMapTileTooltip(\"" + v + '",this,event,"mapwindow", ' + ab + ", " + y + ");return false;' onmouseout='removeTooltip();return false;' id='" + ac + "' style='top:" + p + ";left:" + H + ";' class='" + j + " slot'><span></span></a>"
            }
            if (y < 5 && ab < 5) {
                var p = (((y + 750) * that.vpxmultiplier) + that.topedgesize) + "px";
                var H = (((ab + 750) * that.hpxmultiplier) + that.leftedgesize) + "px";
                var ac = "c_" + u;
                s += "<a onclick='modal_maptile(" + M.tileId + ',"' + escape(M.cityName) + '",' + ab + "," + y + ',"' + Z + '","' + escape(z) + '",' + (l || '"--------"') + ',"' + J + '","' + d + '",' + K + "," + M.tileProvinceId + ',"' + R + '","' + G + '",' + Q + "," + W + "," + M.tileCityId + "," + M.tileUserId + ',"' + that.typename[R] + '",' + L + ");return false;' onmouseover='showMapTileTooltip(\"" + v + '",this,event,"mapwindow", ' + ab + ", " + y + ");return false;' onmouseout='removeTooltip();return false;' id='" + ac + "' style='top:" + p + ";left:" + H + ";' class='" + j + " slot'><span></span></a>"
            }
            if (y >= 745 && ab < 5) {
                var H = (((ab + 750) * that.hpxmultiplier) + that.leftedgesize) + "px";
                var p = ((y - 745) * that.vpxmultiplier) + "px";
                var ac = "c_" + u;
                s += "<a onclick='modal_maptile(" + M.tileId + ',"' + escape(M.cityName) + '",' + ab + "," + y + ',"' + Z + '","' + escape(z) + '",' + (l || '"--------"') + ',"' + J + '","' + d + '",' + K + "," + M.tileProvinceId + ',"' + R + '","' + G + '",' + Q + "," + W + "," + M.tileCityId + "," + M.tileUserId + ',"' + that.typename[R] + '",' + L + ");return false;' onmouseover='showMapTileTooltip(\"" + v + '",this,event,"mapwindow", ' + ab + ", " + y + ");return false;' onmouseout='removeTooltip();return false;' id='" + ac + "' style='top:" + p + ";left:" + H + ";' class='" + j + " slot'><span></span></a>"
            }
        }
        that.map.innerHTML = s
    },
    getMoreSlots: function () {
        var d = that.generateBlockList();
        var b = d.length;
        var a = d.join(",");
        var c = Object.clone(g_ajaxparams);
        c.blocks = a;
        new Ajax.Request(g_ajaxpath + "ajax/fetchMapTiles.php" + g_ajaxsuffix, {
            method: "post",
            parameters: c,
            onSuccess: function (f) {
                var e = ("(" + f.responseText + ")").evalJSON();
                if (e.ok) {
                    that.populateSlots(e.data, e.allianceNames, e.userInfo)
                }
            },
            onFailure: function () {}
        })
    },
    getMoreSlotsQueued: function () {
        var b = this;
        if (this.loadingQueue.isLoading) {
            if (this.loadingQueue.requestCount > 2) {
                return
            }
            setTimeout(function () {
                b.getMoreSlots()
            }, 100);
            return
        }
        if ((this.lastCenterLeft == this.centerleft) && (this.lastCenterTop == this.centertop)) {
            return
        }
        var a = function (c) {
                b.loadingQueue.isLoading = false;
                b.loadingQueue.requestCount = Math.max(0, b.loadingQueue.requestCount - 1);
                if (c && c.ok) {
                    b.populateSlots(c.data, c.allianceNames, c.userInfo);
                    b.lastCenterLeft = this.centerleft;
                    b.lastCenterTop = this.centertop
                }
            };
        this.loadingQueue.isLoading = true;
        this.loadingQueue.requestCount++;
        this.getTileDataCached(this.generateBlockList(), a, a)
    },
    getTileData: function (d, c, a) {
        var b = Object.clone(g_ajaxparams);
        b.blocks = d.join(",");
        new Ajax.Request(g_ajaxpath + "ajax/fetchMapTiles.php" + g_ajaxsuffix, {
            method: "post",
            parameters: b,
            onSuccess: function (e) {
                c(("(" + e.responseText + ")").evalJSON())
            },
            onFailure: function () {
                if (a) {
                    a()
                }
            }
        })
    },
    getTileDataCached: function (d, m, e) {
        var l = [];
        var j = [];
        var b = (new Date()).getTime();
        var a = b - 120000;
        var g;
        for (g = d.length - 1; g >= 0; --g) {
            var k = d[g];
            if (this.tileCache[k] && this.tileCache[k].timestamp >= a) {
                j.push(k);
                continue
            }
            l.push(k)
        }
        var h = this;
        var c = function (o) {
                var p = {};
                var q = {};
                var s;
                for (var r = j.length - 1; r >= 0; --r) {
                    var v = j[r];
                    var u = h.tileCache[v].timestamp;
                    var t = h.tileCache[v].data;
                    for (s in t) {
                        o.data[s] = t[s]
                    }
                    t = h.tileCache[v].userInfo;
                    for (s in t) {
                        if (p[s] && p[s].timestamp > u) {
                            continue
                        }
                        p[s] = {
                            timestamp: u,
                            data: t[s]
                        }
                    }
                    t = h.tileCache[v].allianceNames;
                    for (s in t) {
                        if (q[s] && q[s].timestamp > u) {
                            continue
                        }
                        q[s] = {
                            timestamp: u,
                            data: t[s]
                        }
                    }
                }
                for (s in p) {
                    if (undefined == o.userInfo[s]) {
                        o.userInfo[s] = p[s].data
                    }
                }
                for (s in q) {
                    if (undefined == o.allianceNames[s]) {
                        o.allianceNames[s] = q[s].data
                    }
                }
            };
        if (l.length < 1) {
            var n = {
                ok: true,
                data: {},
                userInfo: {},
                allianceNames: {}
            };
            c(n);
            m(n);
            return
        }
        var f = Object.clone(g_ajaxparams);
        f.blocks = l.join(",");
        new Ajax.Request(g_ajaxpath + "ajax/fetchMapTiles.php" + g_ajaxsuffix, {
            method: "post",
            parameters: f,
            onSuccess: function (G) {
                var w = ("(" + G.responseText + ")").evalJSON();
                if (!w.ok) {
                    m(w)
                }
                var H = w.data;
                var q = w.userInfo;
                var E = w.allianceNames;
                var r, F, z, o, A;
                var D, p, s, v, u;
                var t, C, B;
                for (D = l.length - 1; D >= 0; --D) {
                    r = l[D];
                    F = r.split("_");
                    p = parseInt(F[1]);
                    s = parseInt(F[3]);
                    t = {
                        timestamp: b,
                        data: {},
                        userInfo: {},
                        allianceNames: {}
                    };
                    if (isNaN(p) || isNaN(s)) {
                        m({
                            ok: false
                        })
                    }
                    for (v = p + 4; v >= p; --v) {
                        for (u = s + 4; u >= s; --u) {
                            z = ["l", v, "t", u].join("_");
                            B = H[z];
                            t.data[z] = B;
                            if (B.tileUserId) {
                                o = "u" + B.tileUserId;
                                if (!q[o]) {
                                    continue
                                }
                                t.userInfo[o] = q[o];
                                if (q[o].a) {
                                    A = "a" + q[o].a;
                                    t.allianceNames[A] = E[A]
                                }
                            }
                        }
                    }
                    h.tileCache[r] = t
                }
                c(w);
                m(w)
            },
            onFailure: function () {
                if (e) {
                    e()
                }
            }
        })
    },
    changePosition: function () {
        that.setCenterSlot();
        that.getMoreSlots()
    },
    changePositionQueued: function () {
        that.setCenterSlot();
        that.getMoreSlotsQueued()
    },
    removeSlots: function (c, k) {
        var d = c * 10;
        var m = k * 10;
        for (var f = d; f < (d + 10); f++) {
            for (var e = m; e < (m + 10); e++) {
                var h = "l_" + f + "_t_" + e;
                if ($(h)) {
                    that.map.removeChild($(h))
                }
                var g = "eh_" + h;
                if ($(g)) {
                    that.map.removeChild($(g))
                }
                var b = "ev_" + h;
                if ($(b)) {
                    that.map.removeChild($(b))
                }
                var a = "c_" + h;
                if ($(a)) {
                    that.map.removeChild($(a))
                }
            }
        }
    },
    freeMoreSlots: function () {
        var h = parseInt(that.centerleft / 10);
        var b = parseInt(that.centertop / 10);
        var g = h - 1;
        var d = h + 1;
        g = g < 0 ? that.blockmaxcount + g : g;
        d = d > (that.blockmaxcount - 1) ? (d - that.blockmaxcount) : d;
        var a = b - 1;
        var f = b + 1;
        a = a < 0 ? (that.blockmaxcount + a) : a;
        f = f > (that.blockmaxcount - 1) ? (f - that.blockmaxcount) : f;
        for (var e = 0; e < 75; e++) {
            for (var c = 0; c < 75; c++) {
                if (that.blockslots[e][c] == true && ((e < g && e > d) || (c < a && c > f))) {
                    that.blockslots[e][c] = false;
                    that.removeSlots(e, c)
                }
            }
        }
    },
    generateBlockList: function () {
        var h = [];
        var g = parseInt(that.centerleft / 5) * 5;
        var b = parseInt(that.centertop / 5) * 5;
        for (var e = (g - 5); e <= (g + 5); e += 5) {
            var f = e;
            if (e < 0) {
                f = that.maxtilerow - 5
            }
            if (e > (that.maxtilerow - 5)) {
                f = 0
            }
            for (var c = (b - 5); c <= (b + 5); c += 5) {
                var a = c;
                if (c < 0) {
                    a = that.maxtilecol - 5
                }
                if (c > (that.maxtilecol - 5)) {
                    a = 0
                }
                var d = "bl_" + f + "_bt_" + a;
                h.push(d)
            }
        }
        return h
    },
    distance: function (e, g, d, f) {
        var b = 750;
        var a = b / 2;
        var c = Math.abs(d - e);
        if (c > a) {
            c = b - c
        }
        var h = Math.abs(f - g);
        if (h > a) {
            h = b - h
        }
        return Math.round(100 * Math.sqrt(c * c + h * h)) / 100
    }
});

function showMapTileTooltip(j, h, n, f, l, k) {
    if (g_mapObject.isDragging) {
        return
    }
    var b = document.createElement("div");
    b.innerHTML = unescape(j);
    var m, g;
    for (var e = 0; e < seed.cities.length; e++) {
        m = seed.cities[e];
        g = m[0];
        if (g == currentcityid) {
            var a = m[2];
            var p = m[3];
            var d = g_mapObject.distance(a, p, l, k);
            var o = $(b).getElementsByClassName("distance");
            if (o && o.length > 0) {
                var c = o[0];
                c.innerHTML = d
            }
            showTooltip(b.innerHTML, h, n, f)
        }
    }
}
cm.BootLoader.add(startMap, null, 9);
cm = cm || {};
cm.MarchProgressBar = function (d) {
    var c = {};
    var e = function (f) {
            c[f] = true
        };
    var b = function (f) {
            f = f || currentcityid;
            if (undefined == c[f]) {
                c[f] = false
            } else {
                c[f] = !c[f]
            }
            a()
        };
    var a = function (g) {
            if (undefined == c[currentcityid]) {
                c[currentcityid] = true
            }
            var h = d("#untqueue_head_toggle");
            var f = d("#untqueue_list");
            if (undefined != g) {
                f.html(g)
            }
            if ("" == f.html().replace(/ /g, "")) {
                h.hide();
                return
            }
            h.show();
            if (c[currentcityid]) {
                f.show();
                h.removeClass("expand_button");
                h.addClass("collapse_button")
            } else {
                f.hide();
                h.removeClass("collapse_button");
                h.addClass("expand_button")
            }
        };
    return {
        forceOn: e,
        toggle: b,
        updateView: a
    }
}(jQuery);
cm = cm || {};
cm.MarchReportController = function (c) {
    var b = function () {
            var f = arguments[0],
                e = arguments[1],
                g = {},
                d;
            g.reportId = f[0];
            g.side = f[1];
            g.tileType = f[2];
            g.tileLevel = f[3];
            g.defenderId = f[4];
            g.defenderName = f[5];
            g.defenderGender = f[6];
            g.attackerName = f[7];
            g.attackerGender = f[8];
            g.marchType = f[9];
            g.defenderXCoordinate = f[10];
            g.defenderYCoordinate = f[11];
            g.timestamp = f[12];
            g.readStatus = f[13];
            g.attackerXCoordinate = f[14];
            g.attackerYCoordinate = f[15];
            g.rslt = e;
            switch (g.marchType) {
            case 1:
                d = new cm.TransportReportModel(g);
                d = d.render();
                break;
            case 3:
                d = new cm.ScoutReportModel(g);
                d = d.render();
                break;
            case 4:
                d = new cm.AttackReportModel(g);
                d = d.render();
                break;
            case 8:
            case 9:
                d = new cm.AttackReportModel(g);
                d = d.render();
                break;
            case 10:
                d = new cm.BossAttackReportModel(g);
                d = d.render();
                break;
            case 11:
                d = new cm.BossScoutReportModel(g);
                d = d.render()
            }
            return d
        };
    var a = function () {};
    a();
    return {
        getMarchReport: b
    }
}(jQuery);
var MarchReport = Class.create({
    initialize: function (b, o, e, h, d, a, p, i, c, l, f, n, k, g, j, q, m) {
        this.rptid = b;
        this.side = o;
        this.tiletype = e;
        this.tilelv = h;
        this.defid = d;
        this.defnm = a;
        this.defgen = p;
        this.atknm = i;
        this.atkgen = c;
        this.marchtype = l;
        this.xcoord = f;
        this.ycoord = n;
        this.timestamp = k;
        this.unread = g;
        this.atkxcoord = j;
        this.atkycoord = q;
        this.rslt = m;
        this.tpgs = pageNavigatorModel.getPageCount();
        this.currpg = pageNavigatorModel.getCurrentPage()
    },
    generateBackButton: function () {
        return "<div class='clearfix' style='float:left'><a  class='button20' onclick='loadPage_pagination(\"modal_msg_list_pagination\",\"" + this.currpg + '","modal_messages_viewreports",' + this.tpgs + ");return false;'><span>" + g_js_strings.modal_messages_viewreports_view.backtoreports + "</span></a></div>"
    },
    render: function () {},
    renderReportTitle: function (c) {
        var a = new Array();
        a.push("<div class='reportdetail clearfix'>");
        a.push("<div class='side'>");
        a.push("<div class='report_title'> #{title}");
        if (parseInt(this.tiletype) != 51) {
            a.push(g_mapObject.types[parseInt(this.tiletype)].capitalize());
            a.push(" " + g_js_strings.commonstr.lv + this.tilelv)
        } else {
            if (parseInt(this.defid) == 0) {
                a.push(g_js_strings.commonstr.barbariancamp);
                a.push(" " + g_js_strings.commonstr.lv + this.tilelv)
            }
        }
        var d = new cm.utils.CoordinateLink(this.xcoord, this.ycoord);
        d.setClassName("coordinateLink");
        a.push(" " + d.getHTML());
        if (this.marchtype != 1) {
            if (parseInt(this.rslt.conquered) == 1) {
                a.push(" - <b class='conq'>" + g_js_strings.commonstr.conquered + "</b>")
            }
        }
        a.push("</div>");
        a.push("</div>");
        a.push("<div class='reporttimestamp'>" + formatDateByUnixTime(this.timestamp) + "</div>");
        a.push("<div class='reportid'>" + g_js_strings.modal_messages_viewreports_view.reportno + " " + this.rptid + " </div>");
        a.push("</div>");
        var b = new Template(a.join(""));
        return b.evaluate(c)
    },
    renderWildernessCannotBeConquered: function () {
        var a = new Array();
        try {
            if ((!this.rslt.conquered || this.rslt.conquered == false || parseInt(this.rslt.conquered) == 0) && parseInt(this.rslt.winner) == 1 && parseInt(this.tiletype) != 51 && parseInt(this.side) == 1) {
                a.push("<div class='reportdetail clearfix' style='margin-left: 0px; color: black;'>");
                a.push("<b class='conq'>" + g_js_strings.modal_messages_viewreports_view.cannotbeconq + "</b>");
                a.push("</div>")
            }
        } catch (b) {
            a.push("renderCannotBeConquered Exception: " + b)
        }
        return a.join("")
    },
    renderAttackResult: function () {
        var a = new Array();
        try {
            if (!(Object.keys(this.rslt.fght.s0).length == 0 && Object.keys(this.rslt.fght.s1) == 0)) {
                a.push("<div class='reportdetail mLeft' >");
                a.push("<div class='reportttl'>");
                switch (this.getAttackReportType()) {
                case "wilderness_win":
                    a.push(g_js_strings.modal_messages_viewreports_view.attack_result_wilderness_barbarian_win);
                    break;
                case "wilderness_lose":
                    a.push(g_js_strings.modal_messages_viewreports_view.attack_result_wilderness_barbarian_lose);
                    break;
                case "barbarian_win":
                    a.push(g_js_strings.modal_messages_viewreports_view.attack_result_wilderness_barbarian_win);
                    break;
                case "barbarian_lose":
                    a.push(g_js_strings.modal_messages_viewreports_view.attack_result_wilderness_barbarian_lose);
                    break;
                case "attack_win":
                    a.push(g_js_strings.modal_messages_viewreports_view.attack_result_attacked_enemy_win);
                    break;
                case "defend_victory":
                    a.push(g_js_strings.modal_messages_viewreports_view.attack_result_attack_by_enemy_win);
                    break;
                case "defend_defeat":
                    a.push(g_js_strings.modal_messages_viewreports_view.attack_result_attack_by_enemy_lose);
                    break;
                case "attack_defeat":
                    a.push(g_js_strings.modal_messages_viewreports_view.attack_result_attacked_enemy_lose);
                    break;
                case "barbarianraid_win1":
                case "barbarianraid_win2":
                    a.push(g_js_strings.barbarian.barbarianwin);
                    break;
                case "barbarianraid_lose1":
                case "barbarianraid_lose2":
                    a.push(g_js_strings.barbarian.barbarianlose);
                    break;
                default:
                    throw "No attack result found"
                }
                a.push("</div>");
                a.push("<div class='nobreach'>");
                if (parseInt(this.rslt.winner) == 1 && typeof (this.rslt.wall) != "undefined") {
                    if (parseInt(this.tiletype) == 51) {
                        a.push(g_js_strings.modal_messages_viewreports_view.wallbreach + " ")
                    } else {
                        a.push(g_js_strings.modal_messages_viewreports_view.securedwilderness + " ")
                    }
                }
                a.push(this.renderWildernessCannotBeConquered());
                if (parseInt(this.rslt.winner) == 2) {
                    if (parseInt(this.tiletype) == 51) {
                        a.push(g_js_strings.modal_messages_viewreports_view.nowallbreach + " ")
                    } else {
                        a.push(g_js_strings.modal_messages_viewreports_view.nosecuredwilderness + " ");
                        if (typeof (this.rslt.wall) != "undefined") {
                            a.push(this.rslt.wall);
                            a.push(g_js_strings.modal_messages_viewreports_view.wildernesspercsec)
                        }
                    }
                }
                if (parseInt(this.rslt.winner) == 1 && parseInt(this.side) == 0 && parseInt(this.tiletype) == 51) {
                    if (typeof (this.rslt.wall) != "undefined") {
                        a.push(this.rslt.wall);
                        a.push(g_js_strings.modal_messages_viewreports_view.percdamage)
                    }
                    if (parseInt(this.rslt.wall) == 100) {
                        a.push(" " + g_js_strings.modal_messages_viewreports_view.pendingcancel)
                    }
                }
                a.push("</div>");
                a.push("</div>")
            }
        } catch (b) {
            a.push("renderAttackResult Exception: " + b)
        }
        return a.join("")
    },
    renderBattleReport: function () {
        var d = new Array();
        try {
            if (Object.keys(this.rslt.fght.s0).length == 0 && Object.keys(this.rslt.fght.s1) == 0) {
                d.push("<div class='reportdetail clearfix' style='display:none;'>")
            } else {
                d.push("<div class='reportdetail clearfix'>")
            }
            d.push("<div class='side leftside'>");
            d.push("<div class='sidettl'><b style='font-size:14px;'>" + g_js_strings.commonstr.attackers + "</b><span class='who'>(");
            if (this.atknm != "") {
                d.push(this.atknm);
                d.push(")");
                if (this.atkxcoord != undefined || this.atkxcoord != null) {
                    d.push(" - <b>");
                    var h = new cm.utils.CoordinateLink(this.atkxcoord, this.atkycoord);
                    h.setClassName("coordinateLink");
                    d.push(h.getHTML());
                    d.push("</b>")
                }
                d.push("</span>")
            } else {
                d.push(g_js_strings.commonstr.enemy);
                d.push(")</span>")
            }
            if ((parseInt(this.rslt.winner) == 1) || (parseInt(this.rslt.winner) == 2)) {
                d.push("<b class='winner'>" + g_js_strings.commonstr.winner + "</b>")
            }
            if (parseInt(this.marchtype) != 3 && this.rslt.s1KCombatLv) {
                d.push("<br/>" + g_js_strings.modal_messages_viewreports_view.knightskills + ": " + this.rslt.s1KCombatLv);
                if (typeof (this.rslt.s1atkBoost) != "undefined" && this.rslt.s1atkBoost != 0) {
                    d.push("<br/>" + g_js_strings.modal_messages_viewreports_view.attackboosted + ": " + this.rslt.s1atkBoost * 100 + "%")
                }
                if (false) {
                    this.rslt.s0guardianDefBoost = 0.16;
                    this.rslt.s1guardianAtkBoost = 0.18;
                    this.rslt.s1guardianMarchBoost = 0.24
                }
                if (this.rslt.s1guardianAtkBoost) {
                    d.push("<br/>" + g_js_strings.modal_messages_viewreports_view.guardian_attackboosted + ": " + this.rslt.s1guardianAtkBoost * 100 + "%")
                }
                if (this.rslt.s1guardianMarchBoost) {
                    d.push("<br/>" + g_js_strings.modal_messages_viewreports_view.guardian_marchboosted + ": " + this.rslt.s1guardianMarchBoost * 100 + "%")
                }
                if (typeof (this.rslt.s1defBoost) != "undefined" && this.rslt.s1defBoost != 0) {
                    d.push("<br/>" + g_js_strings.modal_messages_viewreports_view.defenseboosted + ": " + this.rslt.s1defBoost * 100 + "%")
                }
            }
            d.push("</div>");
            d.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
            d.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.troops + "</td><td class='startcol'>" + g_js_strings.commonstr.fought + "</td><td class='endcol'>" + g_js_strings.commonstr.survived + "</td></tr></thead><tbody>");
            var c = Object.keys(this.rslt.fght.s1);
            for (var f = 0; f < c.length; f++) {
                var b = parseInt(this.rslt.fght.s1[c[f]][0]);
                var a = parseInt(this.rslt.fght.s1[c[f]][1]);
                d.push("<tr><td><img src='");
                d.push(stimgUrl);
                d.push("img/units/unit_");
                if (c[f].split("u")[0] == "") {
                    d.push(c[f].split("u")[1]);
                    d.push("_30_s34.jpg'/></td><td class='trnm'>");
                    d.push(unitcost["unt" + c[f].split("u")[1]][0])
                } else {
                    d.push(c[f].split("f")[1]);
                    d.push("_30.jpg'/></td><td class='trnm'>");
                    d.push(fortcost["frt" + c[f].split("f")[1]][0])
                }
                d.push("</td><td class='startcol'>");
                d.push(b);
                d.push("</td><td class='endcol");
                if (a < b) {
                    d.push(" loseunt")
                }
                d.push("'>");
                d.push(a);
                d.push("</td></tr>")
            }
            d.push("</tbody></table>");
            d.push("</div>");
            d.push("<div class='side rightside'>");
            d.push("<div class='sidettl'><b style='font-size:14px;'>" + g_js_strings.commonstr.defenders + "</b><span class='who'>(");
            d.push(unescape(this.defnm));
            d.push(")</span>");
            if (parseInt(this.rslt.winner) == 0) {
                d.push("<b class='winner'>" + g_js_strings.commonstr.winner + "</b>")
            }
            if (parseInt(this.marchtype) != 3 && this.rslt.s0KCombatLv) {
                d.push("<br/>" + g_js_strings.modal_messages_viewreports_view.knightskills + ": " + this.rslt.s0KCombatLv);
                if (typeof (this.rslt.s0atkBoost) != "undefined" && this.rslt.s0atkBoost != 0) {
                    d.push("<br/>" + g_js_strings.modal_messages_viewreports_view.attackboosted + ": " + parseInt(this.rslt.s0atkBoost * 100) + "%")
                }
                if (this.rslt.s0guardianDefBoost) {
                    d.push("<br/>" + g_js_strings.modal_messages_viewreports_view.guardian_defenseboosted + ": " + parseInt(this.rslt.s0guardianDefBoost * 100) + "%")
                }
                if (typeof (this.rslt.s0defBoost) != "undefined" && this.rslt.s0defBoost != 0) {
                    d.push("<br/>" + g_js_strings.modal_messages_viewreports_view.defenseboosted + ": " + parseInt(this.rslt.s0defBoost * 100) + "%")
                }
            }
            d.push("</div>");
            var c = Object.keys(this.rslt.fght.s0);
            if (this.rslt.overwhelmed) {
                d.push(g_js_strings.modal_messages_viewreports_view.overwhelmedinbattle);
                d.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                d.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.troops + "</td><td class='endcol'>" + g_js_strings.commonstr.killed + "</td></tr></thead><tbody>");
                for (var f = 0; f < c.length; f++) {
                    var b = parseInt(this.rslt.fght.s0[c[f]][0]);
                    var a = parseInt(this.rslt.fght.s0[c[f]][1]);
                    d.push("<tr><td><img src='");
                    d.push(stimgUrl);
                    d.push("img/units/unit_");
                    if (c[f].split("u")[0] == "") {
                        d.push(c[f].split("u")[1]);
                        d.push("_30_s34.jpg'/></td><td class='trnm'>");
                        d.push(unitcost["unt" + c[f].split("u")[1]][0])
                    } else {
                        d.push(c[f].split("f")[1]);
                        d.push("_30.jpg'/></td><td class='trnm'>");
                        d.push(fortcost["frt" + c[f].split("f")[1]][0])
                    }
                    d.push("</td><td class='endcol");
                    d.push(" loseunt");
                    d.push("'>");
                    d.push(b - a);
                    d.push("</td></tr>")
                }
                d.push("</tbody></table>")
            } else {
                if (c.length > 0) {
                    d.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                    d.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.troops + "</td><td class='startcol'>" + g_js_strings.commonstr.fought + "</td><td class='endcol'>" + g_js_strings.commonstr.survived + "</td></tr></thead><tbody>");
                    for (var f = 0; f < c.length; f++) {
                        var b = parseInt(this.rslt.fght.s0[c[f]][0]);
                        var a = parseInt(this.rslt.fght.s0[c[f]][1]);
                        d.push("<tr><td><img src='");
                        d.push(stimgUrl);
                        d.push("img/units/unit_");
                        if (c[f].split("u")[0] == "") {
                            d.push(c[f].split("u")[1]);
                            d.push("_30_s34.jpg'/></td><td class='trnm'>");
                            d.push(unitcost["unt" + c[f].split("u")[1]][0])
                        } else {
                            d.push(c[f].split("f")[1]);
                            d.push("_30.jpg'/></td><td class='trnm'>");
                            d.push(fortcost["frt" + c[f].split("f")[1]][0])
                        }
                        d.push("</td><td class='startcol'>");
                        d.push(b);
                        d.push("</td><td class='endcol");
                        if (a < b) {
                            d.push(" loseunt")
                        }
                        d.push("'>");
                        d.push(a);
                        d.push("</td></tr>")
                    }
                    d.push("</tbody></table>")
                }
            }
            if (c.length == 0) {
                d.push(g_js_strings.modal_messages_viewreports_view.notroopsdef)
            }
            d.push("</div>");
            d.push("</div>")
        } catch (g) {
            d.push("Render Battle Report Exception: " + g)
        }
        return d.join("")
    },
    renderMarchLoot: function () {
        var b = new Array();
        try {
            b.push("<div class='loot_vertical'>");
            if (this.rslt.loot && (parseInt(this.rslt.loot[0]) > 0 || parseInt(this.rslt.loot[1]) > 0 || parseInt(this.rslt.loot[2]) > 0 || parseInt(this.rslt.loot[3]) > 0 || parseInt(this.rslt.loot[4]) > 0 || !Object.isArray(this.rslt.loot[5]))) {
                if (parseInt(this.side) == 1) {
                    b.push(g_js_strings.commonstr.loot)
                } else {
                    if (parseInt(this.side) == 0) {
                        b.push("<span style='color:#A02932;'>" + g_js_strings.commonstr.plundered + "</span>")
                    }
                }
                b.push("<div class='item'><img src='");
                b.push(stimgUrl);
                var d = 0;
                var a = addCommas(this.rslt.loot[0]);
                if (parseInt(this.side) == 1) {
                    d += this.rslt.loot[0];
                    b.push("img/gold_30.png'/><b>" + resourceinfo.rec0 + ":</b> " + a + "</div>")
                } else {
                    if (parseInt(this.rslt.loot[0]) > 0 && parseInt(this.side) == 0) {
                        b.push("img/gold_30.png'/><b>" + resourceinfo.rec0 + ":</b><span style='color:#A02932;'> -" + a + "</span></div>")
                    } else {
                        if (parseInt(this.rslt.loot[0]) == 0 && parseInt(this.side) == 0) {
                            b.push("img/gold_30.png'/><b>" + resourceinfo.rec0 + ":</b><span style='color:#A02932;'> " + a + "</span></div>")
                        }
                    }
                }
                for (var c = 1; c < 5; c++) {
                    b.push("<div class='item'><img src='");
                    b.push(stimgUrl);
                    b.push("img/");
                    switch (c) {
                    case 1:
                        b.push("food");
                        break;
                    case 2:
                        b.push("wood");
                        break;
                    case 3:
                        b.push("stone");
                        break;
                    case 4:
                        b.push("iron");
                        break
                    }
                    b.push("_30.png'/><b>");
                    b.push(resourceinfo["rec" + c]);
                    var j = addCommas(this.rslt.loot[c]);
                    if (parseInt(this.side) == 1) {
                        d += this.rslt.loot[c];
                        b.push(":</b> " + j + "</div>")
                    } else {
                        if (parseInt(this.rslt.loot[c]) > 0 && parseInt(this.side) == 0) {
                            b.push(":</b><span style='color:#A02932;'> -" + j + "</span></div>")
                        } else {
                            if (parseInt(this.rslt.loot[c]) == 0 && parseInt(this.side) == 0) {
                                b.push(":</b><span style='color:#A02932;'> " + j + "</span></div>")
                            }
                        }
                    }
                }
                if (!Object.isArray(this.rslt.loot[5]) && Object.keys(this.rslt.loot[5]).length > 0) {
                    var h = Object.keys(this.rslt.loot[5]);
                    b.push("<div class='loot crests clearfix'>");
                    for (var c = 0; c < h.length; c++) {
                        b.push("<div class='item'><img style='width:30px;' src='");
                        b.push(stimgUrl);
                        b.push("img/items/70/");
                        b.push(h[c]);
                        b.push(".png'/><b>");
                        b.push(itemlist["i" + h[c]].name);
                        b.push(": </b> ");
                        b.push(this.rslt.loot[5][h[c]]);
                        b.push("</div>")
                    }
                    b.push("</div>")
                }
            } else {
                var f = new Template("<div class='item'><img src='" + stimgUrl + "img/#{item}_30.png'/><b>#{item_name}:</b><span style='color:#77823C;'>#{number_item}</span></div>");
                b.push(f.evaluate({
                    item: "gold",
                    item_name: resourceinfo.rec0,
                    number_item: 0
                }));
                b.push(f.evaluate({
                    item: "food",
                    item_name: resourceinfo.rec1,
                    number_item: 0
                }));
                b.push(f.evaluate({
                    item: "wood",
                    item_name: resourceinfo.rec2,
                    number_item: 0
                }));
                b.push(f.evaluate({
                    item: "stone",
                    item_name: resourceinfo.rec3,
                    number_item: 0
                }));
                b.push(f.evaluate({
                    item: "iron",
                    item_name: resourceinfo.rec4,
                    number_item: 0
                }))
            }
            b.push("</div>")
        } catch (g) {
            b.push("renderMarchLoot Exception: " + g)
        }
        return b.join("")
    },
    renderMarchScenery: function (b) {
        var a = new Array();
        try {
            a.push("<div class='loot_and_scene'>");
            a.push(this.renderMarchLoot());
            a.push("<div class='scene'><img src='" + stimgUrl + "img/marchreport/" + b + "'/></div><div style='clear:both'></div>");
            a.push("</div>")
        } catch (c) {
            a.push("renderMarchScenery Exception: " + c)
        }
        return a.join("")
    },
    renderButtons: function () {
        var a = new Array();
        a.push("<div class='reportbuttons'>");
        a.push(this.generateBackButton());
        a.push("</div>");
        a.push("<div style='clear:both'></div>");
        return a.join("")
    }
});
MarchReport.getMarchReport = function () {
    var h = arguments[0];
    var q = arguments[1];
    var n = h[0];
    var a = h[1];
    var p = h[2];
    var e = h[3];
    var m = h[4];
    var f = h[5];
    var l = h[6];
    var i = h[7];
    var g = h[8];
    var s = h[9];
    var j = h[10];
    var k = h[11];
    var b = h[12];
    var t = h[13];
    var c = h[14];
    var d = h[15];
    var o = formatDateByUnixTime(b);
    var r = null;
    if (s == 1) {
        r = new TransportReport(n, a, p, e, m, f, l, i, g, s, j, k, b, t, c, d, q)
    } else {
        if (s == 3) {
            r = new ScoutReport(n, a, p, e, m, f, l, i, g, s, j, k, b, t, c, d, q)
        } else {
            if (s == 4) {
                r = new AttackReport(n, a, p, e, m, f, l, i, g, s, j, k, b, t, c, d, q)
            } else {
                if (s == 8) {
                    r = new AttackReport(n, a, p, e, m, f, l, i, g, s, j, k, b, t, c, d, q)
                }
            }
        }
    }
    return r
};
MarchReport.showFeedHover = function (d, b, a) {
    var c = "";
    switch (a) {
    case "wilderness_win":
        c = g_js_strings.modal_messages_viewreports_view.incentive_msg_hover_winwithrec;
        break;
    case "wilderness_lose":
        c = g_js_strings.modal_messages_viewreports_view.incentive_msg_hover_norec;
        break;
    case "barbarian_win":
        c = g_js_strings.modal_messages_viewreports_view.incentive_msg_hover_winwithrec;
        break;
    case "barbarian_lose":
        c = g_js_strings.modal_messages_viewreports_view.incentive_msg_hover_norec;
        break;
    case "attack_win":
        c = g_js_strings.modal_messages_viewreports_view.incentive_msg_hover_winwithrec;
        break;
    case "defend_victory":
        c = g_js_strings.modal_messages_viewreports_view.incentive_msg_hover_norec;
        break;
    case "defend_defeat":
        c = g_js_strings.modal_messages_viewreports_view.incentive_msg_hover_norec;
        break;
    case "attack_defeat":
        c = g_js_strings.modal_messages_viewreports_view.incentive_msg_hover_norec;
        break;
    default:
        throw "No text found"
    }
    showTooltip(g_js_strings.modal_messages_viewreports_view.incentive_msg_hover_numassist + " " + c, d, b, "modal_msg_body")
};
var TransportReport = Class.create(MarchReport, {
    render: function () {
        var a = new Array();
        try {
            a.push(this.renderReportTitle({
                title: g_js_strings.modal_messages_viewreports_view.transpto + " "
            }));
            a.push(this.renderTransportReport());
            a.push(this.renderButtons())
        } catch (b) {
            a.push(b)
        }
        return a.join("")
    },
    renderTransportReport: function () {
        var a = new Array();
        try {
            a.push(this.renderMarchScenery("transport_scene.jpg"))
        } catch (b) {
            a.push(b)
        }
        return a.join("")
    },
    renderMarchLoot: function () {
        var a = new Array();
        try {
            var b = new Template("<div class='item'><img src='" + stimgUrl + "img/#{item}_30.png'/><b>#{item_name}:</b><span style='color:#77823C;'>#{number_item}</span></div>");
            a.push("<div class='loot_vertical'>");
            a.push(b.evaluate({
                item: "gold",
                item_name: resourceinfo.rec0,
                number_item: addCommas(this.rslt.gold)
            }));
            a.push(b.evaluate({
                item: "food",
                item_name: resourceinfo.rec1,
                number_item: addCommas(this.rslt.resource1)
            }));
            a.push(b.evaluate({
                item: "wood",
                item_name: resourceinfo.rec2,
                number_item: addCommas(this.rslt.resource2)
            }));
            a.push(b.evaluate({
                item: "stone",
                item_name: resourceinfo.rec3,
                number_item: addCommas(this.rslt.resource3)
            }));
            a.push(b.evaluate({
                item: "iron",
                item_name: resourceinfo.rec4,
                number_item: addCommas(this.rslt.resource4)
            }));
            a.push("</div>")
        } catch (c) {
            a.push("renderMarchLoot Exception: " + c)
        }
        return a.join("")
    }
});
var ScoutReport = Class.create(MarchReport, {
    render: function () {
        var c = new Array();
        try {
            var h = g_js_strings.modal_messages_viewreports_view.antiscoutingat + " ";
            if (parseInt(this.side) == 1) {
                h = g_js_strings.modal_messages_viewreports_view.scoutingat + " "
            }
            c.push(this.renderReportTitle({
                title: h
            }));
            if (parseInt(this.rslt.score) > 0) {
                c.push("<div class='reportdetail'>");
                c.push("<div class='side clearfix'>");
                c.push("<div class='scoutttl'>" + g_js_strings.modal_messages_viewreports_view.scoutrpt + "</div>");
                c.push("<div class='reporttablewrap'>");
                c.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                c.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.nametx + "</td><td class='startcol'>" + g_js_strings.commonstr.count + "</td></tr></thead><tbody>");
                if (this.rslt.unts && !Object.isArray(this.rslt.unts)) {
                    var b = Object.keys(this.rslt.unts);
                    for (var d = 0; d < b.length; d++) {
                        c.push("<tr><td><img src='");
                        c.push(stimgUrl);
                        c.push("img/units/unit_");
                        c.push(b[d].split("u")[1]);
                        c.push("_30_s34.jpg'/></td><td class='trnm'>");
                        c.push(unitcost["unt" + b[d].split("u")[1]][0]);
                        c.push("</td><td class='startcol'>");
                        c.push(this.rslt.unts[b[d]]);
                        c.push("</td></tr>")
                    }
                } else {
                    c.push("<tr><td colspan='3'>" + g_js_strings.modal_messages_viewreports_view.nounits + "</td></tr>")
                }
                c.push("</tbody></table>");
                c.push("</div>");
                if (this.rslt.lstlgn) {
                    c.push("<div class='reporttablewrap'>");
                    c.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                    c.push("<thead><tr><td colspan='2'>" + g_js_strings.modal_messages_viewreports_view.lastlogin + "</td></tr></thead><tbody>");
                    c.push("<tr><td colspan='2'>");
                    c.push(new Date(this.rslt.lstlgn * 1000).toGMTString());
                    c.push("</td></tr>");
                    c.push("</tbody></table>");
                    c.push("</div>")
                }
                if (this.rslt.knght && this.rslt.knght.cbt) {
                    c.push("<div class='reporttablewrap'>");
                    c.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                    c.push("<thead><tr><td colspan='2'>" + g_js_strings.modal_messages_viewreports_view.knightcomabtlv + "</td></tr></thead><tbody>");
                    c.push("<tr><td colspan='2'>");
                    c.push(this.rslt.knght.cbt);
                    c.push("</td></tr>");
                    c.push("</tbody></table>");
                    c.push("</div>")
                }
                if (this.rslt.frt && !Object.isArray(this.rslt.frt)) {
                    c.push("<div class='reporttablewrap'>");
                    c.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                    c.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.nametx + "</td><td class='startcol'>" + g_js_strings.commonstr.count + "</td></tr></thead><tbody>");
                    var b = Object.keys(this.rslt.frt);
                    for (var d = 0; d < b.length; d++) {
                        c.push("<tr><td><img src='");
                        c.push(stimgUrl);
                        c.push("img/units/unit_");
                        c.push(b[d].split("f")[1]);
                        c.push("_30.png'/></td><td class='trnm'>");
                        c.push(fortcost["frt" + b[d].split("f")[1]][0]);
                        c.push("</td><td class='startcol'>");
                        c.push(this.rslt.frt[b[d]]);
                        c.push("</td></tr>")
                    }
                    c.push("</tbody></table>");
                    c.push("</div>")
                }
                if (this.rslt.blds && !Object.isArray(this.rslt.blds)) {
                    c.push("<div class='reporttablewrap'>");
                    c.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                    c.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.building + "</td><td class='startcol'>" + g_js_strings.commonstr.levels + "</td></tr></thead><tbody>");
                    var b = Object.keys(this.rslt.blds);
                    for (var d = 0; d < b.length; d++) {
                        var a = parseInt(b[d].split("b")[1]);
                        c.push("<tr><td>&nbsp;</td><td class='trnm'>");
                        c.push(buildingcost["bdg" + a][0]);
                        c.push("</td><td class='startcol'>");
                        c.push(this.rslt.blds[b[d]].join(", "));
                        c.push("</td></tr>")
                    }
                    c.push("</tbody></table>");
                    c.push("</div>")
                }
                if (this.rslt.rsc && !Object.isArray(this.rslt.rsc)) {
                    c.push("<div class='reporttablewrap'>");
                    c.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                    c.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.resource + "</td><td class='startcol'>" + g_js_strings.commonstr.quantity + "</td></tr></thead><tbody>");
                    var b = Object.keys(this.rslt.rsc);
                    for (var d = 0; d < b.length; d++) {
                        var f = parseInt(b[d].split("r")[1]);
                        c.push("<tr><td><img src='");
                        c.push(stimgUrl);
                        c.push("img/");
                        if (f == 1) {
                            c.push("food")
                        } else {
                            if (f == 2) {
                                c.push("wood")
                            } else {
                                if (f == 3) {
                                    c.push("stone")
                                } else {
                                    if (f == 4) {
                                        c.push("iron")
                                    }
                                }
                            }
                        }
                        c.push("_30.png'/></td><td class='trnm'>");
                        c.push(resourceinfo["rec" + f]);
                        c.push("</td><td class='startcol'>");
                        c.push(addCommas(parseInt(this.rslt.rsc[b[d]])));
                        c.push("</td></tr>")
                    }
                    c.push("</tbody></table>");
                    c.push("</div>")
                }
                if (this.rslt.tch && !Object.isArray(this.rslt.tch)) {
                    c.push("<div class='reporttablewrap'>");
                    c.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                    c.push("<thead><tr><td class='trnm'>" + g_js_strings.commonstr.research + "</td><td class='startcol'>" + g_js_strings.commonstr.levels + "</td></tr></thead><tbody>");
                    var b = Object.keys(this.rslt.tch);
                    for (var d = 0; d < b.length; d++) {
                        c.push("<tr><td class='trnm'>");
                        c.push(techcost["tch" + b[d].split("t")[1]][0]);
                        c.push("</td><td class='startcol'>");
                        c.push(this.rslt.tch[b[d]]);
                        c.push("</td></tr>")
                    }
                    c.push("</tbody></table>");
                    c.push("</div>")
                }
                c.push("</div></div>")
            } else {
                if (parseInt(this.side) == 1) {
                    c.push("<div class='reportdetail clearfix'><div class='side'><div class='scoutttl'>" + g_js_strings.modal_messages_viewreports_view.scoutfail + "</div></div></div>")
                }
            }
            c.push(this.renderBattleReport());
            if (parseInt(seed.tech.tch6) < 11) {
                c.push("<div class='reportdetail clearfix'>" + g_js_strings.modal_messages_viewreports_view.eagleeyes + "</div>")
            }
        } catch (g) {
            c.push(g)
        }
        c.push(this.renderButtons());
        return c.join("")
    }
});
var AttackReport = Class.create(MarchReport, {
    render: function () {
        var a = new Array();
        try {
            a.push(this.renderReportTitle({
                title: g_js_strings.modal_messages_viewreports_view.battleat + " "
            }));
            a.push(this.renderAttackResult());
            a.push(this.renderAttackScenery());
            a.push(this.renderIncentiveText());
            a.push(this.renderButtons());
            a.push(this.renderBattleReport());
            a.push(this.renderButtons())
        } catch (b) {
            a.push("Attack Report render :" + b)
        }
        return a.join("")
    },
    renderAttackScenery: function () {
        var a = this.getAttackReportType();
        if (a.indexOf("barbarian") != -1) {
            a += "_s33"
        }
        return this.renderMarchScenery(a + ".jpg")
    },
    showFeedButton: function () {
        return false;
        var b = new Date().getTime();
        var j = b - (this.timestamp * 1000);
        var e = (j < 23 * 60 * 60 * 1000);
        var a = false;
        if (this.getAttackReportType() == "wilderness_lose") {
            return false
        }
        if (this.isViewerWinner()) {
            if (this.rslt.loot && (parseInt(this.rslt.loot[0]) > 100 || parseInt(this.rslt.loot[1]) > 100 || parseInt(this.rslt.loot[2]) > 100 || parseInt(this.rslt.loot[3]) > 100 || parseInt(this.rslt.loot[4]) > 100)) {
                a = true
            } else {
                a = false
            }
        } else {
            if (this.rslt.side == 0) {
                var h = Object.keys(this.rslt.fght.s0);
                for (var f = 0; f < h.length; f++) {
                    var c = parseInt(this.rslt.fght.s0[h[f]][0]);
                    var g = parseInt(this.rslt.fght.s0[h[f]][1]);
                    var d = c - g;
                    if (d > 100) {
                        a = true;
                        break
                    }
                }
            } else {
                var h = Object.keys(this.rslt.fght.s1);
                for (var f = 0; f < h.length; f++) {
                    var c = parseInt(this.rslt.fght.s1[h[f]][0]);
                    var g = parseInt(this.rslt.fght.s1[h[f]][1]);
                    var d = c - g;
                    if (d > 100) {
                        a = true;
                        break
                    }
                }
            }
        }
        return e && a
    },
    renderIncentiveText: function () {
        var b = new Array();
        try {
            if (this.showFeedButton()) {
                var a = new Template("<div class='report_incentive_paragraph'>#{incentiveText}</div>");
                var c = {
                    incentiveText: g_js_strings.modal_messages_viewreports_view.incentive_paragraph
                };
                switch (this.getAttackReportType()) {
                case "wilderness_win":
                    c.incentiveText = g_js_strings.modal_messages_viewreports_view.incentive_msg_main_sharestorywithrec;
                    break;
                case "wilderness_lose":
                    c.incentiveText = g_js_strings.modal_messages_viewreports_view.incentive_msg_main_sharestory;
                    break;
                case "barbarian_win":
                    c.incentiveText = g_js_strings.modal_messages_viewreports_view.incentive_msg_main_sharestorywithrec;
                    break;
                case "barbarian_lose":
                    c.incentiveText = g_js_strings.modal_messages_viewreports_view.incentive_msg_main_sharestory;
                    break;
                case "attack_win":
                    c.incentiveText = g_js_strings.modal_messages_viewreports_view.incentive_msg_main_sharestorywithrec;
                    break;
                case "defend_victory":
                    c.incentiveText = g_js_strings.modal_messages_viewreports_view.incentive_msg_main_sharestory;
                    break;
                case "defend_defeat":
                    c.incentiveText = g_js_strings.modal_messages_viewreports_view.incentive_msg_main_sharestory;
                    break;
                case "attack_defeat":
                    c.incentiveText = g_js_strings.modal_messages_viewreports_view.incentive_msg_main_sharestory;
                    break;
                case "barbarianraid_win1":
                case "barbarianraid_win2":
                case "barbarianraid_lose1":
                case "barbarianraid_lose2":
                    c.incentiveText = "";
                    break;
                default:
                    throw "No text found"
                }
                b.push(a.evaluate(c))
            }
        } catch (d) {
            b.push("incentive text error " + d)
        }
        return b.join("")
    },
    renderButtons: function () {
        var a = new Array();
        a.push("<div style='clear:both;margin:10px 0px 10px 24px'>");
        a.push(this.generateBackButton());
        a.push(this.renderFeedButton());
        a.push("</div>");
        a.push("<div style='clear:both'></div>");
        return a.join("")
    },
    renderFeedButton: function () {
        var a = new Array();
        try {
            if (this.showFeedButton()) {
                var d = 0;
                if (this.rslt.loot && (parseInt(this.rslt.loot[0]) > 0 || parseInt(this.rslt.loot[1]) > 0 || parseInt(this.rslt.loot[2]) > 0 || parseInt(this.rslt.loot[3]) > 0 || parseInt(this.rslt.loot[4]) > 0 || !Object.isArray(this.rslt.loot[5]))) {
                    if (parseInt(this.side) == 1) {
                        for (var b = 0; b < 5; b++) {
                            d += this.rslt.loot[b]
                        }
                    }
                }
                var g = new Template('<div class=\'clearfix\' style=\'float:left;\'><a  class=\'button20\' onclick=\'modal_share_victory("#{tileName}",#{tilelv}, #{total_res},"#{defnm}", "#{atknm}", "#{defgen}" ,"#{atkgen}",  #{feed_id},#{rptid},#{side})\' onmouseover=\'MarchReport.showFeedHover(this,event,"' + this.getAttackReportType() + "\");' onmouseout='removeTooltip();'><span>#{button_text}</span></a></div>");
                var c = {
                    tilelv: this.tilelv,
                    total_res: d,
                    defnm: this.defnm,
                    atknm: this.atknm,
                    defgen: this.defgen,
                    atkgen: this.atkgen,
                    rptid: this.rptid,
                    side: this.side
                };
                switch (this.getAttackReportType()) {
                case "wilderness_win":
                    c = {
                        tilelv: this.tilelv,
                        total_res: d,
                        defnm: "null",
                        atknm: "null",
                        defgen: "null",
                        atkgen: "null",
                        rptid: this.rptid,
                        side: this.side
                    };
                    c.tileName = g_mapObject.types[parseInt(this.tiletype)].capitalize();
                    c.button_text = g_js_strings.commonstr.sharetowall;
                    c.feed_id = 110;
                    break;
                case "wilderness_lose":
                    c = {
                        tilelv: this.tilelv,
                        total_res: d,
                        defnm: "null",
                        atknm: "null",
                        defgen: "null",
                        atkgen: "null",
                        rptid: this.rptid,
                        side: this.side
                    };
                    c.tileName = g_mapObject.types[parseInt(this.tiletype)].capitalize();
                    c.button_text = g_js_strings.modal_messages_viewreports_view.sharetorecovertroops;
                    c.feed_id = 114;
                    break;
                case "barbarian_win":
                    c.tileName = g_mapObject.types[parseInt(this.tiletype)].capitalize();
                    c.button_text = g_js_strings.commonstr.sharetowall;
                    c.feed_id = 111;
                    break;
                case "barbarian_lose":
                    c.tileName = g_mapObject.types[parseInt(this.tiletype)].capitalize();
                    c.button_text = g_js_strings.modal_messages_viewreports_view.sharetorecovertroops;
                    c.feed_id = 115;
                    break;
                case "attack_win":
                    c.tileName = g_mapObject.types[parseInt(this.tiletype)].capitalize();
                    c.button_text = g_js_strings.commonstr.sharetowall;
                    c.feed_id = 112;
                    break;
                case "defend_victory":
                    c.tileName = g_mapObject.types[parseInt(this.tiletype)].capitalize();
                    c.button_text = g_js_strings.modal_messages_viewreports_view.sharetorecovertroops;
                    c.feed_id = 113;
                    break;
                case "defend_defeat":
                    c.tileName = g_mapObject.types[parseInt(this.tiletype)].capitalize();
                    c.button_text = g_js_strings.modal_messages_viewreports_view.sharetorecovertroops;
                    c.feed_id = 117;
                    break;
                case "attack_defeat":
                    c.tileName = g_mapObject.types[parseInt(this.tiletype)].capitalize();
                    c.button_text = g_js_strings.modal_messages_viewreports_view.sharetorecovertroops;
                    c.feed_id = 116;
                    break;
                default:
                    throw "No report type"
                }
                a.push(g.evaluate(c))
            }
        } catch (f) {
            a.push(f)
        }
        return a.join("")
    },
    getAttackReportType: function () {
        var a = "";
        try {
            if (parseInt(this.marchtype) == 8) {
                var b = 1 + Math.floor(Math.random() * 2);
                if (parseInt(this.rslt.winner) == 0) {
                    a = "barbarianraid_lose" + b
                } else {
                    a = "barbarianraid_win" + b
                }
            } else {
                if (parseInt(this.tiletype) != 51) {
                    if (parseInt(this.rslt.winner) == 1 && parseInt(this.side) == 1 || parseInt(this.rslt.winner) == 2 && parseInt(this.side) == 1) {
                        a = "wilderness_win"
                    } else {
                        if (parseInt(this.rslt.winner) == 0 && parseInt(this.side) == 0) {
                            a = "wilderness_win"
                        } else {
                            if ((parseInt(this.side) == 1 && parseInt(this.rslt.winner) == 0) || (parseInt(this.side) == 0 && parseInt(this.rslt.winner) == 1)) {
                                a = "wilderness_lose"
                            }
                        }
                    }
                } else {
                    if (parseInt(this.defid) == 0) {
                        if (parseInt(this.rslt.winner) == 1 && parseInt(this.side) == 1 || parseInt(this.rslt.winner) == 2 && parseInt(this.side) == 1) {
                            a = "barbarian_win"
                        } else {
                            if (parseInt(this.side) == 1 && parseInt(this.rslt.winner) == 0) {
                                a = "barbarian_lose"
                            }
                        }
                    } else {
                        if (parseInt(this.rslt.winner) == 1 && parseInt(this.side) == 1 || parseInt(this.rslt.winner) == 2 && parseInt(this.side) == 1) {
                            a = "attack_win"
                        } else {
                            if (parseInt(this.rslt.winner) == 0 && parseInt(this.side) == 0) {
                                a = "defend_victory"
                            } else {
                                if (parseInt(this.side) == 0 && (parseInt(this.rslt.winner) == 1 || parseInt(this.rslt.winner) == 2)) {
                                    a = "defend_defeat"
                                } else {
                                    if (parseInt(this.side) == 1 && parseInt(this.rslt.winner) == 0) {
                                        a = "attack_defeat"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        } catch (c) {
            a = "error"
        }
        return a
    },
    isViewerWinner: function () {
        if (parseInt(this.side) == 1 && (parseInt(this.rslt.winner) == 1 || parseInt(this.rslt.winner) == 2)) {
            return true
        } else {
            if (parseInt(this.side) == 0 && parseInt(this.rslt.winner) == 0) {
                return true
            } else {
                return false
            }
        }
    }
});
cm = cm || {};
cm.MarchReportModel = jQueryClass.extend({
    init: function (a) {
        this.reportId = a.reportId;
        this.totalPages = pageNavigatorModel.getPageCount();
        this.currentPage = pageNavigatorModel.getCurrentPage();
        this.timestamp = a.timestamp;
        this.readStatus = a.readStatus;
        this.tileType = ~~ (1 * a.tileType);
        this.tileLevel = ~~ (1 * a.tileLevel);
        this.marchType = ~~ (1 * a.marchType);
        this.rslt = a.rslt
    },
    render: function () {},
    renderReportInfo: function () {
        return cm.MarchReportView.renderReportInfo(this)
    },
    renderTitle: function () {},
    renderLoot: function () {
        return cm.MarchReportView.renderLoot(this)
    },
    renderScene: function (a, b) {
        return cm.MarchReportView.renderScene(a, b)
    },
    renderUnits: function () {
        return cm.MarchReportView.renderUnits(this)
    },
    renderBackButton: function () {
        return cm.MarchReportView.renderBackButton(this)
    }
});
cm.AttackReportModel = cm.MarchReportModel.extend({
    init: function (a) {
        this._super(a);
        this.side = (a.side == 0) ? "defender" : "attacker";
        this.winner = ~~ (1 * a.rslt.winner);
        this.wall = a.rslt.wall || 0;
        this.isConquered = a.rslt.conquered || false;
        this.defenderId = a.defenderId;
        this.defenderName = a.defenderName;
        this.defenderGender = a.defenderGender;
        this.defenderXCoordinate = a.defenderXCoordinate;
        this.defenderYCoordinate = a.defenderYCoordinate;
        this.defenderKnightLevel = a.rslt.s0KCombatLv;
        this.defenderAttackBoostPercent = ~~ (1 * a.rslt.s0atkBoost) * 100;
        this.defenderDefendBoostPercent = ~~ (1 * a.rslt.s0defBoost) * 100;
        this.defenderGuardianDefendBoost = ~~ (1 * a.rslt.s0guardianDefBoost) * 100;
        this.defenderUnits = a.rslt.fght.s0;
        this.attackerName = a.attackerName;
        this.attackerGender = a.attackerGender;
        this.attackerXCoordinate = a.attackerXCoordinate;
        this.attackerYCoordinate = a.attackerYCoordinate;
        this.attackerKnightLevel = a.rslt.s1KCombatLv;
        this.attackerAttackBoostPercent = ~~ (1 * a.rslt.s1atkBoost) * 100;
        this.attackerDefendBoostPercent = ~~ (1 * a.rslt.s1defBoost) * 100;
        this.attackerGuardianAttackBoost = ~~ (1 * a.s1guardianAtkBoost) * 100;
        this.attackerGuardianMarchBoost = ~~ (1 * a.s1guardianMarchBoost) * 100;
        this.attackerUnits = a.rslt.fght.s1;
        this.reportType = this.getReportType()
    },
    render: function () {
        var c = [],
            f = this.renderReportInfo(),
            g = this.renderAttackTitle(),
            e = this.renderLoot(),
            d = this.renderAttackScene(),
            b = this.renderBackButton(),
            a = this.renderUnits();
        return "<div id='marchReportContainer'>" + f + g + e + d + b + a + b + "</div>"
    },
    renderAttackScene: function () {
        var b = this.reportType + ".jpg",
            a = this.renderScene(b);
        return a
    },
    renderAttackTitle: function () {
        return cm.MarchReportView.renderAttackTitle(this)
    },
    isIWinner: function () {
        if (this.winner == 1 || this.winner == 2 && this.side == "attacker") {
            return true
        } else {
            if (this.winner == 0 && this.side == "defender") {
                return true
            } else {
                return false
            }
        }
    },
    getReportType: function () {
        var a, c = 1 + Math.floor(Math.random() * 2),
            b = ~~ (1 * this.winner);
        if (this.marchType == 8) {
            if (b == 0) {
                a = "barbarianraid_lose" + c
            } else {
                a = "barbarian_win" + c
            }
        } else {
            if (this.tileType != cm.TILE_TYPES.TILE_TYPE_CITY) {
                if (this.winner == 1 && this.side == "attacker" || this.winner == 2 && this.side == "attacker") {
                    a = "wilderness_win"
                } else {
                    if (this.winner == 0 && this.side == "defender") {
                        a = "wilderness_win"
                    } else {
                        if (this.winner == 0 && this.side == "attacker" || this.winner == 1 && this.side == "defender") {
                            a = "wilderness_lose"
                        } else {
                            if (this.winner == 1 && this.side == "defender" || this.winner == 2 && this.side == "defender") {
                                a = "wilderness_win"
                            }
                        }
                    }
                }
            } else {
                if (this.defenderId == 0) {
                    if (this.winner == 1 && this.side == "attacker" || this.winner == 2 && this.side == "attacker") {
                        a = "barbarian_win"
                    } else {
                        if (this.winner == 0 && this.side == "attacker") {
                            a = "barbarian_lose"
                        }
                    }
                } else {
                    if (this.winner == 1 && this.side == "attacker" || this.winner == 2 && this.side == "attacker") {
                        a = "attack_win"
                    } else {
                        if (this.winner == 0 && this.side == "attacker") {
                            a = "attack_defeat"
                        } else {
                            if (this.winner == 0 && this.side == "defender") {
                                a = "defend_victory"
                            } else {
                                if (this.winner == 1 || this.winner == 2 && this.side == "defender") {
                                    a = "defend_defeat"
                                }
                            }
                        }
                    }
                }
            }
        }
        return a
    },
    shouldShowFeedButton: function () {
        var c = new Date().getTime(),
            n = c - (this.timestamp * 1000),
            g = (n < (23 * 60 * 60 * 1000)),
            d, a = this.isIWinner(),
            j;
        if (this.reportType == "wilderness_lose") {
            return false
        }
        if (a) {
            if (this.rslt.loot) {
                for (var h = 0; h < 5; ++h) {
                    j = ~~ (1 * this.rslt.loot[h]);
                    if (j > 100) {
                        d = true
                    } else {
                        d = false
                    }
                }
            }
        } else {
            var b, e, f, m, l;
            if (this.side == "defender") {
                b = Object.keys(this.rslt.fght.s0);
                for (var h = 0, k = b.length; h < k; ++h) {
                    l = b[h];
                    e = ~~ (1 * this.rslt.fght.s0[l][0]);
                    f = ~~ (1 * this.rslt.fght.s0[l][1]);
                    m = e - f;
                    if (m > 100) {
                        d = true;
                        break
                    }
                }
            } else {
                b = Object.keys(this.rslt.fght.s1);
                for (var h = 0, k = b.length; h < k; ++h) {
                    l = b[h];
                    e = ~~ (1 * this.rslt.fght.s1[l][0]);
                    f = ~~ (1 * this.rslt.fght.s1[l][1]);
                    m = e - f;
                    if (m > 100) {
                        d = true;
                        break
                    }
                }
            }
        }
        return d && g
    },
    renderFeedText: function () {},
    renderFeedButton: function () {},
    showFeed: function () {}
});
cm.TransportReportModel = cm.MarchReportModel.extend({
    init: function (a) {
        this._super(a);
        this.defenderId = a.defenderId;
        this.defenderName = a.defenderName;
        this.defenderGender = a.defenderGender;
        this.defenderXCoordinate = a.defenderXCoordinate;
        this.defenderYCoordinate = a.defenderYCoordinate;
        this.attackerName = a.attackerName;
        this.attackerGender = a.attackerGender;
        this.attackerXCoordinate = a.attackerXCoordinate;
        this.attackerYCoordinate = a.attackerYCoordinate;
        this.gold = ~~ (1 * a.rslt.gold) || 0;
        this.food = ~~ (1 * a.rslt.resource1) || 0;
        this.wood = ~~ (1 * a.rslt.resource2) || 0;
        this.stone = ~~ (1 * a.rslt.resource3) || 0;
        this.ore = ~~ (1 * a.rslt.resource4) || 0;
        this.aetherstone = ~~ (1 * a.rslt.resource5) || 0;
        this.loot = [this.gold, this.food, this.wood, this.stone, this.ore, this.aetherstone]
    },
    render: function () {
        var b = [],
            e = this.renderReportInfo(),
            d = this.renderTransportLoot(),
            c = this.renderTransportScene(),
            a = this.renderBackButton();
        return "<div id='marchReportContainer'>" + e + d + c + a + "</div>"
    },
    renderTransportScene: function () {
        var b = "transport_scene.jpg",
            a = this.renderScene(b);
        return a
    },
    renderTransportLoot: function () {
        return cm.MarchReportView.renderTransportLoot(this)
    }
});
cm.ScoutReportModel = cm.MarchReportModel.extend({
    init: function (a) {
        this._super(a);
        this.side = (a.side == 0) ? "defender" : "attacker";
        this.winner = ~~ (1 * a.rslt.winner);
        this.defenderId = a.defenderId;
        this.defenderName = a.defenderName;
        this.defenderGender = a.defenderGender;
        this.defenderXCoordinate = a.defenderXCoordinate;
        this.defenderYCoordinate = a.defenderYCoordinate;
        this.attackerName = a.attackerName;
        this.attackerGender = a.attackerGender;
        this.attackerXCoordinate = a.attackerXCoordinate;
        this.attackerYCoordinate = a.attackerYCoordinate;
        this.attackerUnits = a.rslt.fght.s1;
        this.score = ~~ (1 * a.rslt.score) || null;
        this.units = ((a.rslt.unts && a.rslt.unts.length > 0) || !(a.rslt.unts instanceof Array)) ? a.rslt.unts : null;
        this.lastLogin = ~~ (1 * a.rslt.lstlgn) || null;
        this.knight = a.rslt.knght || null;
        this.fortifications = ((a.rslt.frt && a.rslt.frt.length > 0) || !(a.rslt.frt instanceof Array)) ? a.rslt.frt : null;
        this.buildings = ((a.rslt.blds && a.rslt.blds.length > 0) || !(a.rslt.blds instanceof Array)) ? a.rslt.blds : null;
        this.resources = a.rslt.rsc || null;
        this.technologies = ((a.rslt.tch && a.rslt.tch.length > 0) || !(a.rslt.tch instanceof Array)) ? a.rslt.tch : null
    },
    render: function () {
        var e = [],
            f = this.renderReportInfo(),
            d = this.renderScoutInfo(),
            b = this.renderUnits(),
            c = this.renderEagleEyes(),
            a = this.renderBackButton();
        return "<div id='marchReportContainer'>" + f + d + a + b + c + a + "</div>"
    },
    renderScoutInfo: function () {
        return cm.MarchReportView.renderScountInfo(this)
    },
    renderEagleEyes: function () {
        return cm.MarchReportView.renderEagleEyes(this)
    }
});
cm.BossScoutReportModel = cm.ScoutReportModel.extend({
    init: function (f) {
        var c = {},
            e = Object.keys(f.rslt.fght.s0),
            b = Object.values(f.rslt.fght.s0);
        for (var d = 0, a = e.length; d < a; ++d) {
            c[e[d]] = b[d][0]
        }
        f.rslt.units = c;
        this.units = c;
        f.rslt.fght.s0 = {};
        this._super(f);
        this.units = c
    }
});
cm.BossAttackReportModel = cm.AttackReportModel.extend({
    init: function (a) {
        this.side = (a.side == 0) ? "defender" : "attacker";
        this.winner = ~~ (1 * a.rslt.win);
        this.defenderId = a.defenderId;
        this.defenderName = a.defenderName;
        this.defenderGender = a.defenderGender;
        this.defenderXCoordinate = a.attackerXCoordinate;
        this.defenderYCoordinate = a.attackerYCoordinate;
        this.defenderKnightLevel = a.rslt.s0KCombatLv;
        this.defenderUnits = a.rslt.fght.s0;
        this.darkForestConflict = a.rslt.darkForestConflict;
        this.attackerName = a.attackerName;
        this.attackerGender = a.attackerGender;
        this.attackerXCoordinate = a.attackerXCoordinate;
        this.attackerYCoordinate = a.attackerYCoordinate;
        this.attackerKnightLevel = a.rslt.s1KCombatLv;
        this.attackerUnits = a.rslt.fght.s1;
        this.reportType = this.getReportType();
        this._super(a)
    },
    render: function (f) {
        var c = [],
            h = this.renderEffectiveHint(),
            f = this.renderReportInfo(),
            e = this.renderLoot(),
            g = this.renderAttackTitle(),
            d = this.renderAttackScene(h),
            b = this.renderBackButton(),
            a = this.renderUnits();
        return "<div id='marchReportContainer'>" + f + g + e + d + b + a + b + "</div>"
    },
    renderAttackScene: function (c) {
        var b = (this.darkForestConflict ? "boss_lose" : this.reportType) + ".jpg",
            a = this.renderScene(b, c);
        return a
    },
    renderEffectiveHint: function (a) {
        return cm.MarchReportView.renderEffectiveHint(this)
    },
    renderAttackTitle: function (a) {
        return cm.MarchReportView.renderAttackTitle(this)
    },
    getReportType: function (b) {
        var a;
        if (this.winner == 0) {
            a = "boss_lose"
        } else {
            if (this.winner == 1) {
                a = "boss_win"
            }
        }
        return a
    }
});
cm = cm || {};
cm.MarchReportView = function (e) {
    var p = function (t) {
            var q = [],
                s = [],
                w = ~~ (1 * t.tileType),
                y = t.tileLevel,
                v = t.defenderId,
                x = t.defenderXCoordinate,
                u = t.defenderYCoordinate,
                r = new cm.utils.CoordinateLink(x, u);
            switch (t.marchType) {
            case 1:
                q.push(g_js_strings.modal_messages_viewreports_view.transpto + " ");
                break;
            case 3:
            case 11:
                if (t.side == "attacker") {
                    q.push(g_js_strings.modal_messages_viewreports_view.scoutingat + " ")
                } else {
                    q.push(g_js_strings.modal_messages_viewreports_view.antiscoutingat + " ")
                }
                break;
            case 4:
            case 10:
                q.push(g_js_strings.modal_messages_viewreports_view.battleat + " ");
                break
            }
            if (t.tileType == 54) {
                q.push(g_js_strings.commonstr.darkForest);
                q.push(" " + g_js_strings.commonstr.lv + y)
            } else {
                if (t.tileType != 51) {
                    q.push(g_mapObject.types[parseInt(t.tileType)].capitalize());
                    q.push(" " + g_js_strings.commonstr.lv + y)
                } else {
                    if (t.defenderId == 0) {
                        q.push(g_js_strings.commonstr.barbariancamp);
                        q.push(" " + g_js_strings.commonstr.lv + y)
                    }
                }
            }
            q.push(" " + r.getHTML());
            if (t.marchType != 1 && t.conquered == 1) {
                q.push(" - <span>" + g_js_strings.commonstr.conquered + "</span>")
            }
            s.push("<div class='time'>" + formatDateByUnixTime(t.timestamp) + "</div>");
            s.push("<div class='id'>" + g_js_strings.modal_messages_viewreports_view.reportno + " " + t.reportId + "</div>");
            var z = cm.Template.renderTemplate("MarchReport", "marchReportInfo", {
                location: q.join(""),
                time: s.join("")
            });
            return z
        };
    var m = function () {
            var q = [];
            q.push("<p id='maxWilderness'>");
            q.push(g_js_strings.modal_messages_viewreports_view.cannotbeconq);
            q.push("</p>");
            return q.join("")
        };
    var d = function (s, t) {
            if (s.indexOf("barbarian") != -1) {
                s = s.replace(".", "_s33.")
            }
            var r = stimgUrl + "img/marchreport/" + s;
            var q = cm.Template.renderTemplate("MarchReport", "marchReportScenery", {
                image: r,
                hint: t
            });
            return q
        };
    var l = function (u) {
            var w = [],
                t = u.rslt.loot || [0, 0, 0, 0, 0, [], 0],
                r = Object.keys(t[5]),
                A = (!e.isArray(t[5])) ? Object.keys(t[5]) : [],
                E, B, x, s, y, q;
            if (typeof t[6] === "undefined") {
                t[6] = 0
            }
            if (!cm.WorldSettings.isOn("DARK_FOREST_AETHERSTONE")) {
                t.pop()
            }
            if (u.side == "attacker") {
                s = 1;
                y = "looted";
                B = g_js_strings.commonstr.loot
            } else {
                if (u.side == "defender") {
                    s = -1;
                    y = "plundered";
                    B = g_js_strings.commonstr.plundered
                }
            }
            x = ~~ (1 * t[0]);
            x = x * s;
            w.push("<li class='gold " + y + " " + u.side + "'>");
            w.push("<span class='name'>" + resourceinfo.rec0 + "</span>");
            w.push("<span class='amount'>" + addCommas(x) + "</span>");
            w.push("</li>");
            var D = (t.length == 7) ? 6 : 4;
            for (var v = 1; v <= D; ++v) {
                if (v == 5) {} else {
                    switch (v) {
                    case 1:
                        q = "food";
                        x = ~~ (1 * t[v]);
                        x = x * s;
                        x = addCommas(x);
                        break;
                    case 2:
                        q = "wood";
                        x = ~~ (1 * t[v]);
                        x = x * s;
                        x = addCommas(x);
                        break;
                    case 3:
                        q = "stone";
                        x = ~~ (1 * t[v]);
                        x = x * s;
                        x = addCommas(x);
                        break;
                    case 4:
                        q = "iron";
                        x = ~~ (1 * t[v]);
                        x = x * s;
                        x = addCommas(x);
                        break;
                    case 6:
                        q = "aetherstone";
                        x = ~~ (1 * t[6]);
                        x = x * s;
                        x = addCommas(x);
                        break
                    }
                    w.push("<li class='" + q + " " + y + " " + u.side + "'>");
                    if (v == 6) {
                        w.push("<span class='name'>" + g_js_strings.commonstr.aetherstone + "</span>")
                    } else {
                        w.push("<span class='name'>" + resourceinfo["rec" + v] + "</span>")
                    }
                    w.push("<span class='amount'>" + x + "</span>");
                    w.push("</li>")
                }
            }
            if (A.length > 0) {
                for (var v = 0, z = r.length; v < z; ++v) {
                    E = r[v];
                    x = ~~ (1 * t[5][E]);
                    x = addCommas(x);
                    w.push("<li class='" + y + " item item" + E + " " + u.side + "'>");
                    w.push("<img src='" + stimgUrl + "img/items/70/" + E + ".jpg' />");
                    w.push("<span class='name'>" + ksoItems[E].name + "</span>");
                    w.push("<span class='amount'>" + x + "</span>");
                    w.push("</li>")
                }
            }
            var C = cm.Template.renderTemplate("MarchReport", "marchReportLoot", {
                lis: w.join("")
            });
            return C
        };
    var g = function (G) {
            var q = [],
                s = [],
                y = [],
                v = [],
                Q, A = [],
                F = [],
                O = [],
                L = [],
                M, u, t, z, w, D, J, E, P, B, r;
            q.push("<span class='role'>" + g_js_strings.commonstr.attackers + "</span>");
            try {
                if (G.attackerName != "") {
                    q.push(" <span class='name'> (" + unescape(G.attackerName) + ") </span> ");
                    if (G.attackerXCoordinate != undefined || G.attackerXCoordinate != null) {
                        u = new cm.utils.CoordinateLink(G.attackerXCoordinate, G.attackerYCoordinate);
                        q.push(" - " + u.getHTML())
                    }
                } else {
                    q.push(" <span class='name'> " + g_js_strings.commonstr.enemy + " </span> ")
                }
                if ((G.winner == 1 || G.winner == 2) && !G.rslt.darkForestConflict) {
                    q.push(" <span class='winner'> " + g_js_strings.commonstr.winner + " </span> ")
                }
                if (G.winner === 1) {
                    cm.sounds.play("player_views_battle_report_and_won")
                }
                if (G.winner === 0) {
                    cm.sounds.play("player_views_battle_report_and_lost")
                }
                s.push("<ul>");
                if (G.rslt.s1KCombatLv) {
                    s.push("<li>");
                    s.push("<span class='label'>" + g_js_strings.modal_messages_viewreports_view.knightskills + ": </span>");
                    s.push("<span class='value'>" + G.rslt.s1KCombatLv + "</span>");
                    s.push("</li>")
                }
                s.push(c(g_js_strings.modal_messages_viewreports_view.attackboosted, G.rslt.s1atkBoost));
                s.push(c(g_js_strings.modal_messages_viewreports_view.defenseboosted, G.rslt.s1defBoost));
                s.push(c(g_js_strings.modal_messages_viewreports_view.guardian_lifeboosted, G.rslt.s1guardianDefBoost));
                s.push(c(g_js_strings.modal_messages_viewreports_view.guardian_attackboosted, G.rslt.s1guardianAtkBoost));
                s.push(c(g_js_strings.modal_messages_viewreports_view.guardian_marchboosted, G.rslt.s1guardianMarchBoost));
                s.push("</ul>");
                w = Object.keys(G.rslt.fght.s1);
                y.push("<table>");
                for (var H = 0, I = w.length; H < I; ++H) {
                    if (w[H].charAt(0) == "u") {
                        J = w[H].split("u")[1] || w[H];
                        E = stimgUrl + "img/units/unit_" + J + "_30_s34.jpg";
                        P = unitcost["unt" + J][0];
                        D = G.rslt.fght.s1["u" + J] || G.rslt.fght.s1[J]
                    } else {
                        if (w[H].charAt(0) == "f") {
                            J = w[H].split("f")[1] || w[H];
                            E = stimgUrl + "img/units/unit_" + J + "_30.jpg";
                            D = G.rslt.fght.s0["f" + J] || G.rslt.fght.s0[J];
                            P = fortcost["frt" + J][0]
                        }
                    }
                    B = ~~ (1 * D[0]);
                    B = addCommas(B);
                    r = ~~ (1 * D[1]);
                    r = addCommas(r);
                    v.push("<tr class='unit" + J + "'>");
                    v.push("<td class='name'>");
                    v.push("<img src='" + E + "' />");
                    v.push("<span class='name'>" + P + "</span>");
                    v.push("</td>");
                    v.push("<td class='fought'>");
                    v.push("<span class='fought'>" + B + "</span>");
                    v.push("</td>");
                    v.push("<td class='survived'>");
                    v.push("<span class='survived'>" + r + "</span>");
                    v.push("</td>");
                    v.push("</tr>")
                }
                v.push("</table>");
                Q = cm.Template.renderTemplate("MarchReport", "marchReportUnitsTable", {
                    troopHeader: g_js_strings.commonstr.troops,
                    foughtHeader: g_js_strings.commonstr.fought,
                    survivedHeader: g_js_strings.commonstr.survived,
                    units: v.join("")
                });
                y.push(Q);
                A.push("<span class='role'>" + g_js_strings.commonstr.defenders + "</span>");
                A.push(" <span class='name'> (" + unescape(G.defenderName) + ") </span> ");
                if (G.winner == 0) {
                    A.push(" <span class='winner'> " + g_js_strings.commonstr.winner + " </span> ")
                }
                F.push("<ul>");
                if (G.rslt.s0KCombatLv) {
                    F.push("<li>");
                    F.push("<span class='label'>" + g_js_strings.modal_messages_viewreports_view.knightskills + ": </span>");
                    F.push("<span class='value'>" + G.rslt.s0KCombatLv + "</span>");
                    F.push("</li>")
                }
                F.push(c(g_js_strings.modal_messages_viewreports_view.attackboosted, G.rslt.s0atkBoost));
                F.push(c(g_js_strings.modal_messages_viewreports_view.defenseboosted, G.rslt.s0defBoost));
                F.push(c(g_js_strings.modal_messages_viewreports_view.guardian_lifeboosted, G.rslt.s0guardianDefBoost));
                F.push(c(g_js_strings.modal_messages_viewreports_view.guardian_attackboosted, G.rslt.s0guardianAtkBoost));
                F.push(c(g_js_strings.modal_messages_viewreports_view.guardian_marchboosted, G.rslt.s0guardianMarchBoost));
                F.push("</ul>");
                if (G.rslt.darkForestConflict) {
                    O.push(g_js_strings.returned.not_engaged + "<br><br>")
                }
                w = Object.keys(G.rslt.fght.s0);
                if (G.rslt.overwhelmed) {
                    O.push("<p>" + g_js_strings.modal_messages_viewreports_view.overwhelmedinbattle + "</p>");
                    O.push("<table>");
                    for (var H = 0, I = w.length; H < I; ++H) {
                        if (w[H].charAt(0) == "u") {
                            J = w[H].split("u")[1] || w[H];
                            E = stimgUrl + "img/units/unit_" + J + "_30_s34.jpg";
                            D = G.rslt.fght.s0["u" + J] || G.rslt.fght.s0[J];
                            P = unitcost["unt" + J][0]
                        } else {
                            if (w[H].charAt(0) == "m") {
                                J = w[H].split("m")[1] || w[H];
                                E = stimgUrl + "img/units/unit_" + J + "_30.jpg";
                                D = G.rslt.fght.s0["m" + J] || G.rslt.fght.s0[J];
                                P = g_js_strings.monsterUnitsNames["m" + J]
                            } else {
                                if (w[H].charAt(0) == "f") {
                                    J = w[H].split("f")[1] || w[H];
                                    E = stimgUrl + "img/units/unit_" + J + "_30.jpg";
                                    D = G.rslt.fght.s0["f" + J] || G.rslt.fght.s0[J];
                                    P = fortcost["frt" + J][0]
                                }
                            }
                        }
                        B = ~~ (1 * D[0]);
                        r = ~~ (1 * D[1]);
                        L.push("<tr class='unit" + J + "'>");
                        L.push("<td class='name'>");
                        L.push("<img src='" + E + "' />");
                        L.push("<span class='name'>" + P + "</span>");
                        L.push("</td>");
                        L.push("<td class='killed'>");
                        L.push("<span class='killed'>" + addCommas(B - r) + "</span>");
                        L.push("</td>");
                        L.push("</tr>")
                    }
                    O.push("</table>");
                    M = cm.Template.renderTemplate("MarchReport", "marchReportUnitsOverwhelmedTable", {
                        troopHeader: g_js_strings.commonstr.troops,
                        killedHeader: g_js_strings.commonstr.killed,
                        units: L.join("")
                    });
                    O.push(M)
                } else {
                    if (w.length > 0) {
                        for (var H = 0, I = w.length; H < I; ++H) {
                            if (w[H].charAt(0) == "u") {
                                J = w[H].split("u")[1] || w[H];
                                E = stimgUrl + "img/units/unit_" + J + "_30_s34.jpg";
                                D = G.rslt.fght.s0["u" + J] || G.rslt.fght.s0[J];
                                P = unitcost["unt" + J][0]
                            } else {
                                if (w[H].charAt(0) == "m") {
                                    J = w[H].split("m")[1] || w[H];
                                    E = stimgUrl + "img/units/unit_" + J + "_30.jpg";
                                    D = G.rslt.fght.s0["m" + J] || G.rslt.fght.s0[J];
                                    P = g_js_strings.monsterUnitsNames["m" + J]
                                } else {
                                    if (w[H].charAt(0) == "f") {
                                        J = w[H].split("f")[1] || w[H];
                                        E = stimgUrl + "img/units/unit_" + J + "_30.jpg";
                                        D = G.rslt.fght.s0["f" + J] || G.rslt.fght.s0[J];
                                        P = fortcost["frt" + J][0]
                                    }
                                }
                            }
                            B = ~~ (1 * D[0]);
                            r = ~~ (1 * D[1]);
                            L.push("<tr class='unit" + J + "'>");
                            L.push("<td class='name'>");
                            L.push("<img src='" + E + "' />");
                            L.push("<span class='name'>" + P + "</span>");
                            L.push("</td>");
                            L.push("<td class='fought'>");
                            L.push("<span class='fought'>" + addCommas(B) + "</span>");
                            L.push("</td>");
                            L.push("<td class='survived'>");
                            L.push("<span class='survived'>" + addCommas(r) + "</span>");
                            L.push("</td>");
                            L.push("</tr>")
                        }
                        M = cm.Template.renderTemplate("MarchReport", "marchReportUnitsTable", {
                            troopHeader: g_js_strings.commonstr.troops,
                            foughtHeader: g_js_strings.commonstr.fought,
                            survivedHeader: g_js_strings.commonstr.survived,
                            units: L.join("")
                        });
                        O.push(M)
                    } else {
                        O.push("<p>" + g_js_strings.modal_messages_viewreports_view.notroopsdef + "</p>")
                    }
                }
            } catch (K) {
                var C
            }
            var N = cm.Template.renderTemplate("MarchReport", "marchReportUnits", {
                attackerRole: q.join(""),
                attackerBoosts: s.join(""),
                attackerUnits: y.join(""),
                defenderRole: A.join(""),
                defenderBoosts: F.join(""),
                defenderUnits: O.join("")
            });
            return N
        };
    var c = function (r, s) {
            if (typeof s === "undefined" || s <= 0) {
                return ""
            }
            r = r || "";
            var q = [],
                t = parseInt(+s * 100) || 0;
            q.push("<li>");
            q.push("<span class='label'>" + r + "</span>");
            q.push("<span class='value'>" + t + "%</span>");
            q.push("</li>");
            return q.join("")
        };
    var o = function (q) {
            var s = [],
                r = 'loadPage_pagination("modal_msg_list_pagination", ' + q.currentPage + ', "modal_messages_viewreports", ' + q.totalPages + ")";
            s.push("<div class='buttonContainer'>");
            s.push("<a class='button20' onclick='" + r + "'>");
            s.push("<span>" + g_js_strings.modal_messages_viewreports_view.backtoreports + "</span>");
            s.push("</a>");
            s.push("</div>");
            return s.join("")
        };
    var j = function (q) {
            var s = q.attackType,
                r = s + ".jpg";
            return r
        };
    var b = function (s) {
            var r, w, q, t = s.rslt.conquered,
                v;
            switch (s.reportType) {
            case "wilderness_win":
                r = g_js_strings.modal_messages_viewreports_view.attack_result_wilderness_barbarian_win;
                break;
            case "wilderness_lose":
                r = g_js_strings.modal_messages_viewreports_view.attack_result_wilderness_barbarian_lose;
                break;
            case "barbarian_win":
                r = g_js_strings.modal_messages_viewreports_view.attack_result_wilderness_barbarian_win;
                break;
            case "barbarian_lose":
                r = g_js_strings.modal_messages_viewreports_view.attack_result_wilderness_barbarian_lose;
                break;
            case "attack_win":
            case "boss_win":
                r = g_js_strings.modal_messages_viewreports_view.attack_result_attacked_enemy_win;
                break;
            case "defend_victory":
                r = g_js_strings.modal_messages_viewreports_view.attack_result_attack_by_enemy_win;
                break;
            case "defend_defeat":
                r = g_js_strings.modal_messages_viewreports_view.attack_result_attack_by_enemy_lose;
                break;
            case "attack_defeat":
            case "boss_lose":
                r = g_js_strings.modal_messages_viewreports_view.attack_result_attacked_enemy_lose;
                break;
            case "barbarianraid_win1":
            case "barbarianraid_win2":
                r = g_js_strings.barbarian.barbarianwin;
                break;
            case "barbarianraid_lose1":
            case "barbarianraid_lose2":
                r = g_js_strings.barbarian.barbarianlose;
                break;
            default:
                throw "No attack result found"
            }
            if (s.rslt.darkForestConflict) {
                r = g_js_strings.returned.avoided
            }
            if (s.winner == 1 && s.rslt.wall) {
                if (s.tileType == 51) {
                    w = g_js_strings.modal_messages_viewreports_view.wallbreach + " "
                } else {
                    w = g_js_strings.modal_messages_viewreports_view.securedwilderness + " "
                }
                if (!t || t == false || ~~ (1 * t) == 0) {
                    v = false
                } else {
                    v = true
                }
                if (!v && s.winner == 1 && s.tileType != 51 && s.side == "attacker") {
                    q = this.renderMaxWilderness()
                }
            } else {
                if (s.winner == 2) {
                    if (s.tileType == 51) {
                        w = g_js_strings.modal_messages_viewreports_view.nowallbreach + " "
                    } else {
                        w = g_js_strings.modal_messages_viewreports_view.nosecuredwilderness + " ";
                        if (s.rslt.wall) {
                            w += s.rslt.wall + g_js_strings.modal_messages_viewreports_view.wildernesspercsec
                        }
                    }
                }
            }
            if (s.winner == 1 && s.side == "defender" && s.tileType == 51) {
                if (s.rslt.wall) {
                    w += s.rslt.wall;
                    w += g_js_strings.modal_messages_viewreports_view.percdamage
                }
                if (s.rslt.wall == 100) {
                    w += " " + g_js_strings.modal_messages_viewreports_view.pendingcancel
                }
            }
            var u = cm.Template.renderTemplate("MarchReport", "marchReportTitle", {
                status: r,
                hint: s.rslt.darkForestConflict ? "" : w,
                maxWilderness: s.rslt.darkForestConflict ? "" : q
            });
            return u
        };
    var a = function (q) {
            var t = [],
                v = q.loot,
                r;
            t.push("<li class='gold'>");
            t.push("<span class='name'>" + resourceinfo.rec0 + "</span>");
            t.push("<span class='amount'>" + v[0] + "</span>");
            t.push("</li>");
            for (var s = 1; s <= 5; ++s) {
                switch (s) {
                case 1:
                    r = "food";
                    break;
                case 2:
                    r = "wood";
                    break;
                case 3:
                    r = "stone";
                    break;
                case 4:
                    r = "iron";
                    break;
                case 5:
                    r = "aetherstone";
                    break
                }
                t.push("<li class='" + r + "'>");
                if (s == 5) {
                    t.push("<span class='name'>" + resourceinfo["7"] + "</span>")
                } else {
                    t.push("<span class='name'>" + resourceinfo[s] + "</span>")
                }
                t.push("<span class='amount'>" + v[s] + "</span>");
                t.push("</li>")
            }
            var u = cm.Template.renderTemplate("MarchReport", "marchReportLoot", {
                lis: t.join("")
            });
            return u
        };
    var i = function (w) {
            var s = [],
                C = [],
                t = [],
                B = [],
                v = [],
                D = [],
                A = [],
                G = [],
                F, E, r, u, q, y;
            if (w.score > 0) {
                s.push("<div class='scoutTitle'>");
                s.push(g_js_strings.modal_messages_viewreports_view.scoutrpt);
                s.push("</div>");
                C.push("<div class='container units'>");
                C.push("<table>");
                C.push("<thead>");
                C.push("<tr>");
                C.push("<td> &nbsp; </td>");
                C.push("<td>" + g_js_strings.commonstr.nametx + "</td>");
                C.push("<td>" + g_js_strings.commonstr.count + "</td>");
                C.push("</tr>");
                C.push("</thead>");
                C.push("<tbody>");
                if (w.units != null) {
                    F = Object.keys(w.units);
                    E = Object.values(w.units);
                    for (var x = 0, z = F.length; x < z; ++x) {
                        if (F[x].charAt(0) == "u") {
                            r = F[x].split("u")[1];
                            u = stimgUrl + "img/units/unit_" + r + "_30_s34.jpg";
                            q = unitcost["unt" + r][0]
                        } else {
                            if (F[x].charAt(0) == "m") {
                                r = F[x].split("m")[1];
                                u = stimgUrl + "img/units/unit_" + r + "_30.jpg";
                                q = g_js_strings.monsterUnitsNames["m" + r]
                            }
                        }
                        C.push("<tr>");
                        C.push("<td> <img src='" + u + "' /> </td>");
                        C.push("<td>" + q + "</td>");
                        C.push("<td>" + E[x] + "</td>");
                        C.push("</tr>")
                    }
                } else {
                    C.push(" <tr> ");
                    C.push(" <td colspan='3'> ");
                    C.push(g_js_strings.modal_messages_viewreports_view.nounits);
                    C.push(" </td> ");
                    C.push(" </tr> ")
                }
                C.push("</tbody>");
                C.push("</table>");
                C.push("</div>");
                if (w.lastLogin != null) {
                    t.push("<div class='container login'>");
                    t.push("<table>");
                    t.push("<thead>");
                    t.push("<tr>");
                    t.push("<td> &nbsp; </td>");
                    t.push("<td>" + g_js_strings.modal_messages_viewreports_view.lastlogin + "</td>");
                    t.push("</tr>");
                    t.push("</thead>");
                    t.push("<tbody>");
                    t.push("<tr>");
                    t.push("<td>");
                    t.push("<td>" + new Date(w.lastLogin * 1000).toGMTString() + "</td");
                    t.push("</td>");
                    t.push("</tr>");
                    t.push("</tbody>");
                    t.push("</table>");
                    t.push("</div>")
                }
                if (w.knight != null) {
                    B.push("<div class='container knight'>");
                    B.push("<table>");
                    B.push("<thead>");
                    B.push("<tr>");
                    B.push("<td> &nbsp; </td>");
                    B.push("<td>" + g_js_strings.modal_messages_viewreports_view.knightcomabtlv + "</td>");
                    B.push("</tr>");
                    B.push("</thead>");
                    B.push("<tbody>");
                    B.push("<tr>");
                    B.push("<td>");
                    B.push("<td>" + w.knight.cbt + "</td");
                    B.push("</td>");
                    B.push("</tr>");
                    B.push("</tbody>");
                    B.push("</table>");
                    B.push("</div>")
                }
                if (w.fortifications != null) {
                    v.push("<div class='container fortfications'>");
                    v.push("<table>");
                    v.push("<thead>");
                    v.push("<tr>");
                    v.push("<td> &nbsp; </td>");
                    v.push("<td>" + g_js_strings.commonstr.nametx + "</td>");
                    v.push("<td>" + g_js_strings.commonstr.count + "</td>");
                    v.push("</tr>");
                    v.push("</thead>");
                    v.push("<tbody>");
                    F = Object.keys(w.fortifications);
                    E = Object.values(w.fortifications);
                    for (var x = 0, z = F.length; x < z; ++x) {
                        r = F[x].split("f")[1];
                        u = stimgUrl + "img/units/unit_" + r + "_30.png";
                        q = fortcost["frt" + r][0];
                        v.push("<tr>");
                        v.push("<td> <img src='" + u + "' /> </td>");
                        v.push("<td>" + q + "</td>");
                        v.push("<td>" + E[x] + "</td>");
                        v.push("</tr>")
                    }
                    v.push("</tbody>");
                    v.push("</table>");
                    v.push("</div>")
                }
                if (w.buildings != null) {
                    D.push("<div class='container buildings'>");
                    D.push("<table>");
                    D.push("<thead>");
                    D.push("<tr>");
                    D.push("<td> &nbsp; </td>");
                    D.push("<td>" + g_js_strings.commonstr.building + "</td>");
                    D.push("<td>" + g_js_strings.commonstr.levels + "</td>");
                    D.push("</tr>");
                    D.push("</thead>");
                    D.push("<tbody>");
                    F = Object.keys(w.buildings);
                    E = Object.values(w.buildings);
                    for (var x = 0, z = F.length; x < z; ++x) {
                        r = F[x].split("b")[1];
                        q = buildingcost["bdg" + r][0];
                        D.push("<tr>");
                        D.push("<td> &nbsp; </td>");
                        D.push("<td>" + q + "</td>");
                        D.push("<td>" + E[x].join(", ") + "</td>");
                        D.push("</tr>")
                    }
                    D.push("</tbody>");
                    D.push("</table>");
                    D.push("</div>")
                }
                if (w.resources != null) {
                    A.push("<div class='container resources'>");
                    A.push("<table>");
                    A.push("<thead>");
                    A.push("<tr>");
                    A.push("<td>" + g_js_strings.commonstr.resource + "</td>");
                    A.push("<td>" + g_js_strings.commonstr.quantity + "</td>");
                    A.push("</tr>");
                    A.push("</thead>");
                    A.push("<tbody>");
                    F = Object.keys(w.resources);
                    E = Object.values(w.resources);
                    for (var x = 0, z = F.length; x < z; ++x) {
                        r = ~~ (1 * F[x].split("r")[1]);
                        y = Number(E[x]);
                        y = Math.floor(y);
                        u = stimgUrl + "img/";
                        switch (r) {
                        case 1:
                            u += "food";
                            break;
                        case 2:
                            u += "wood";
                            break;
                        case 3:
                            u += "stone";
                            break;
                        case 4:
                            u += "iron";
                            break
                        }
                        u += "_30.png";
                        q = resourceinfo["rec" + r];
                        A.push("<tr>");
                        A.push("<td class='name'> <img src='" + u + "' /> <span class='name'>" + q + "</span></td>");
                        A.push("<td>" + addCommas(y) + "</td>");
                        A.push("</tr>")
                    }
                    A.push("</tbody>");
                    A.push("</table>");
                    A.push("</div>")
                }
                if (w.technologies != null) {
                    G.push("<div class='container technologies'>");
                    G.push("<table>");
                    G.push("<thead>");
                    G.push("<tr>");
                    G.push("<td>" + g_js_strings.commonstr.research + "</td>");
                    G.push("<td>" + g_js_strings.commonstr.levels + "</td>");
                    G.push("</tr>");
                    G.push("</thead>");
                    G.push("<tbody>");
                    F = Object.keys(w.technologies);
                    E = Object.values(w.technologies);
                    for (var x = 0, z = F.length; x < z; ++x) {
                        r = F[x].split("t")[1];
                        q = techcost["tch" + r][0];
                        G.push("<tr>");
                        G.push("<td>" + q + "</td>");
                        G.push("<td>" + E[x] + "</td>");
                        G.push("</tr>")
                    }
                    G.push("</tbody>");
                    G.push("</table>");
                    G.push("</div>")
                }
            } else {
                if (this.side == "attacker") {
                    s.push("<div class='scoutTitle'>");
                    s.push(g_js_strings.modal_messages_viewreports_view.scoutfail);
                    s.push("</div>")
                }
            }
            s = s.join("");
            C = C.join("");
            t = t.join("");
            B = B.join("");
            v = v.join("");
            D = D.join("");
            A = A.join("");
            G = G.join("");
            return "<div id='scoutingInformationContainer'>" + s + C + t + B + v + D + A + G + "</div>"
        };
    var n = function (q) {
            var s = ~~ (1 * seed.tech.tch6),
                r = [];
            if (s < 11) {
                r.push("<div class='eagleEyesContainer'>");
                r.push(g_js_strings.modal_messages_viewreports_view.eagleeyes);
                r.push("</div>")
            }
            return r.join("")
        };
    var h = {
        u1m101: "0",
        u1m102: "0",
        u1m103: "0",
        u1m104: "0",
        u1m105: "0",
        u1m106: "0",
        u1m107: "0",
        u1m108: "0",
        u1m109: "0",
        u1m110: "0",
        u2m101: "0",
        u2m102: "+",
        u2m103: "0",
        u2m104: "-",
        u2m105: "+",
        u2m106: "-",
        u2m107: "0",
        u2m108: "+",
        u2m109: "---",
        u2m110: "0",
        u3m101: "0",
        u3m102: "0",
        u3m103: "0",
        u3m104: "0",
        u3m105: "0",
        u3m106: "0",
        u3m107: "0",
        u3m108: "0",
        u3m109: "0",
        u3m110: "0",
        u4m101: "0",
        u4m102: "+",
        u4m103: "0",
        u4m104: "-",
        u4m105: "+",
        u4m106: "--",
        u4m107: "0",
        u4m108: "+",
        u4m109: "---",
        u4m110: "0",
        u5m101: "0",
        u5m102: "++",
        u5m103: "0",
        u5m104: "-",
        u5m105: "++",
        u5m106: "--",
        u5m107: "0",
        u5m108: "++",
        u5m109: "---",
        u5m110: "0",
        u6m101: "+",
        u6m102: "-",
        u6m103: "0",
        u6m104: "0",
        u6m105: "--",
        u6m106: "0",
        u6m107: "+",
        u6m108: "---",
        u6m109: "0",
        u6m110: "+",
        u7m101: "-",
        u7m102: "0",
        u7m103: "0",
        u7m104: "+",
        u7m105: "0",
        u7m106: "+",
        u7m107: "--",
        u7m108: "0",
        u7m109: "+",
        u7m110: "---",
        u8m101: "-",
        u8m102: "0",
        u8m103: "0",
        u8m104: "++",
        u8m105: "0",
        u8m106: "++",
        u8m107: "--",
        u8m108: "0",
        u8m109: "++",
        u8m110: "--",
        u9m101: "0",
        u9m102: "0",
        u9m103: "0",
        u9m104: "0",
        u9m105: "0",
        u9m106: "0",
        u9m107: "0",
        u9m108: "0",
        u9m109: "0",
        u9m110: "0",
        u10m101: "++",
        u10m102: "-",
        u10m103: "0",
        u10m104: "0",
        u10m105: "--",
        u10m106: "0",
        u10m107: "++",
        u10m108: "--",
        u10m109: "0",
        u10m110: "++",
        u11m101: "-",
        u11m102: "-",
        u11m103: "0",
        u11m104: "-",
        u11m105: "--",
        u11m106: "--",
        u11m107: "--",
        u11m108: "---",
        u11m109: "---",
        u11m110: "---",
        u12m101: "-",
        u12m102: "-",
        u12m103: "0",
        u12m104: "-",
        u12m105: "--",
        u12m106: "--",
        u12m107: "--",
        u12m108: "--",
        u12m109: "---",
        u12m110: "---"
    };
    var k = function (x) {
            var w = [],
                A = [],
                C, z, v, D, B, q, u;
            D = Object.keys(x.attackerUnits);
            q = Object.keys(x.defenderUnits);
            for (var y = 0, s = D.length; y < s; ++y) {
                for (var t = 0, r = q.length; t < r; ++t) {
                    v = D[y].split("u")[1];
                    B = q[t].split("m")[1];
                    C = h["u" + v + "m" + B];
                    if (x.winner == 0) {
                        if (C == "-" || C == "--" || C == "---" || C == "0") {
                            A.push("u" + v + "-m" + B)
                        }
                    } else {
                        if (x.winner == 1) {
                            if (C == "+" || C == "++" || C == "+++" || C == "0") {
                                A.push("u" + v + "-m" + B)
                            }
                        }
                    }
                }
            }
            if (x.darkForestConflict) {
                C = "conflict"
            } else {
                if (x.winner == 0 && A.length == 0) {
                    C = "-+"
                } else {
                    if (x.winner == 1 && A.length == 0) {
                        C = "+-"
                    } else {
                        u = Math.floor(Math.random() * A.length);
                        z = A[u];
                        v = z.split("-")[0];
                        v = v.split("u")[1];
                        B = z.split("-")[1];
                        C = h["u" + v + B]
                    }
                }
            }
            switch (C) {
            case "conflict":
                C = g_js_strings.returned.twisted;
                break;
            case "+++":
                C = g_js_strings.battleReport.crushed.replace("%1$s", unitcost["unt" + v][0]).replace("%2$s", g_js_strings.monsterUnitsNames[B]);
                break;
            case "++":
                C = g_js_strings.battleReport.dominated.replace("%1$s", unitcost["unt" + v][0]).replace("%2$s", g_js_strings.monsterUnitsNames[B]);
                break;
            case "+":
                C = g_js_strings.battleReport.upperHand.replace("%1$s", unitcost["unt" + v][0]).replace("%2$s", g_js_strings.monsterUnitsNames[B]);
                break;
            case "-":
                C = g_js_strings.battleReport.struggled.replace("%1$s", unitcost["unt" + v][0]).replace("%2$s", g_js_strings.monsterUnitsNames[B]);
                break;
            case "--":
                C = g_js_strings.battleReport.noMatch.replace("%1$s", unitcost["unt" + v][0]).replace("%2$s", g_js_strings.monsterUnitsNames[B]);
                break;
            case "---":
                C = g_js_strings.battleReport.wasCrushed.replace("%1$s", unitcost["unt" + v][0]).replace("%2$s", g_js_strings.monsterUnitsNames[B]);
                break;
            case "0":
                C = g_js_strings.battleReport.valiantly.replace("%1$s", unitcost["unt" + v][0]).replace("%2$s", g_js_strings.monsterUnitsNames[B]);
                break;
            case "-+":
                C = g_js_strings.battleReport.loserNoHint;
                break;
            case "+-":
                C = g_js_strings.battleReport.winnerNoHint;
                break
            }
            w.push("<div class='effectiveHintContainer'>");
            w.push(C);
            w.push("</div>");
            return w.join("")
        };
    var f = function () {};
    f();
    return {
        renderReportInfo: p,
        renderMaxWilderness: m,
        renderScene: d,
        renderLoot: l,
        renderBackButton: o,
        renderTransportLoot: a,
        renderUnits: g,
        renderAttackTitle: b,
        renderAttackScenery: j,
        renderScountInfo: i,
        renderEagleEyes: n,
        renderEffectiveHint: k
    }
}(jQuery);

function modal_openMarket(a) {
    modal_marketplace(a)
}

function modal_marketplace(b) {
    var a = new Array();
    a.push("<div class='tabsbar clearfix' id='marketmod_recsel' name='1'><a  class='tab selected' id='marketmod_recsel1' onclick='modal_marketplace_changerec(1);return false;'><span><img src='" + stimgUrl + "img/chrome_icon_food.png' align='absmiddle'/> " + resourceinfo.rec1 + "</span></a><a class='tab'  id='marketmod_recsel2' onclick='modal_marketplace_changerec(2);return false;'><span><img src='" + stimgUrl + "img/chrome_icon_wood.png' align='absmiddle'/> " + resourceinfo.rec2 + "</span></a><a class='tab'  id='marketmod_recsel3' onclick='modal_marketplace_changerec(3);return false;'><span><img src='" + stimgUrl + "img/chrome_icon_stone.png' align='absmiddle'/> " + resourceinfo.rec3 + "</span></a><a class='tab'  id='marketmod_recsel4' onclick='modal_marketplace_changerec(4);return false;'><span><img src='" + stimgUrl + "img/chrome_icon_ore.png' align='absmiddle'/> " + resourceinfo.rec4 + "</span></a><a  class='tab' id='marketmod_recsel5' onclick='modal_marketplace_viewtransactions();return false;'><span id='market_num_of_transactions'>" + g_js_strings.commonstr.transactions + "</span></a></div>");
    a.push("<div class='marketmain_maxtransac' id='marketmain_maxtransac' style='display:none;' name='" + b + "'>max</div>");
    a.push("<div class='marketmain_bdy' id='marketmain_bdy'>");
    a.push("<div class='buysellinfo'>");
    a.push("<div class='buyselltophd'>" + g_js_strings.commonstr.buy.toUpperCase() + "</div>");
    a.push("<div id='marketmod_selltable' class='buyselltable'></div>");
    a.push("</div>");
    a.push("<div class='acct'>");
    a.push("<div class='accthd'>" + g_js_strings.modal_marketplace.youract + "</div>");
    a.push("<div class='info'><b id='marketmod_recname'>" + resourceinfo.rec1 + "");
    a.push("</b>: <span id='marketmod_recnum'>");
    a.push(addCommas(parseInt(seed.resources["city" + currentcityid]["rec" + 1][0]) / 3600));
    a.push("</span></div>");
    a.push("<div class='info'><b>" + resourceinfo.rec0 + "</b>: <span id='marketmod_goldnum'>");
    a.push(addCommas(seed.citystats["city" + currentcityid].gold[0]));
    a.push("</span></div>");
    a.push("</div>");
    a.push("<div class='marketinfotx'><div>");
    a.push(g_js_strings.modal_marketplace.provincedesc + ": <b>" + provincenames["p" + currentcityinfo[4]] + "</b>. " + g_js_strings.modal_marketplace.provincerestr);
    a.push("</div></div>");
    a.push("<input type='hidden' id='marketmod_transac' value='2'/>");
    a.push("<div class='transactions'>");
    a.push("<div class='header'>" + g_js_strings.commonstr.sell.toUpperCase() + "</div>");
    a.push("<div class='clearfix transactentry'><b>" + g_js_strings.modal_marketplace.resamt + ":</b><br/><input type='text' id='marketmod_amount' value='0' maxlength='6' onkeyup='modal_marketplace_updateprice();'/></div>");
    a.push("<div class='tradingfee'>" + g_js_strings.modal_marketplace.roundingdesc + "</div><br/>");
    a.push("<div class='clearfix transactentry'><b>" + g_js_strings.modal_marketplace.unitprice + ":</b><br/><input type='text' id='marketmod_price' value='0' onkeyup='modal_marketplace_updateprice();' maxlength='5'/></div>");
    a.push("<div class='tradingfee'>" + g_js_strings.modal_marketplace.newpercdesc + "</div><br/>");
    a.push("<div class='clearfix transactentry'><b>" + g_js_strings.modal_marketplace.tradefee + ": </b><br/><span id='marketmod_fee' class='price'>0</span> <span class='price'>" + resourceinfo.rec0 + "</span></div>");
    a.push("<div class='marketmod_totalpricediv clearfix transactentry'><b id='marketmod_totalpricetxt'>" + g_js_strings.modal_marketplace.totalcost + ":</b><br/><span id='marketmod_totalprice' class='price'>0</span> <span class='price'>" + resourceinfo.rec0 + "</span></div><br/>");
    a.push("<div class='clearfix buysellbtn'><a onclick='market_confirm_transaction(2,0);return false;'  class='button25'><span id='modal_marketplace_buysell'>" + g_js_strings.commonstr.sell + "</span></a></div>");
    a.push("</div>");
    a.push("</div>");
    a.push("<div id='marketmain_transactions' style='display:none;'>");
    a.push("<div class='marketmain_transactions'>");
    a.push("<div class='transacthd'>" + g_js_strings.modal_marketplace.pendingoffers + "</div>");
    a.push("<div id='marketmain_transactions_pending' class='market_transactions_table'></div>");
    a.push("<div class='transacthd'>" + g_js_strings.modal_marketplace.tradestatus + "</div>");
    a.push("<div id='marketmain_transactions_status' class='market_transactions_table'></div>");
    a.push("</div>");
    a.push("</div>");
    $("modal_build_content").innerHTML = a.join("");
    getModalResourceBar();
    modal_marketplace_changerec(1)
}

function modal_marketplace_cancel(mid, rtype, postingtype, kremaining, price) {
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    params.pro = currentcityinfo[4];
    params.mid = mid;
    params.rtype = rtype;
    new Ajax.Request(g_ajaxpath + "ajax/untrade.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                modal_marketplace_viewtransactions();
                Modal.showAlert(g_js_strings.modal_marketplace_cancel.transcancel);
                if (parseInt(postingtype) == 1) {
                    seed.citystats["city" + currentcityid].gold[0] = parseInt(seed.citystats["city" + currentcityid].gold[0]) + (kremaining * price);
                    update_gold()
                } else {
                    seed.resources["city" + currentcityid]["rec" + rtype][0] = parseInt(seed.resources["city" + currentcityid]["rec" + rtype][0]) + (kremaining * 3600000)
                }
                getModalResourceBar()
            } else {
                if (!rslt.error_code && rslt.msg) {
                    var msgObj = {
                        type: "worker",
                        text: rslt.msg
                    };
                    Modal.showTrackerAlert(msgObj)
                } else {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                }
            }
        },
        onFailure: function () {}
    })
}

function modal_marketplace_viewtransactions() {
    $("marketmain_maxtransac").hide();
    var sels = $("marketmod_recsel").select(".selected");
    if (sels.length > 0) {
        sels[0].removeClassName("selected")
    }
    $("marketmod_recsel5").addClassName("selected");
    $("modal_build").className = "tab0";
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/getCityTradeStatus.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                $("marketmain_bdy").hide();
                var pending = new Array();
                pending.push("<table cellpadding='0' cellspacing='0'><thead><tr><td class='resource'>" + g_js_strings.commonstr.resource + "</td><td class='amount'>" + g_js_strings.commonstr.amount + "</td><td class='unitprice'>" + g_js_strings.modal_marketplace.unitprice + "</td><td class='amounttraded'>" + g_js_strings.modal_marketplace_viewtransactions.amttraded + "</td><td class='status'>" + g_js_strings.commonstr.status + "</td><td class='actions'>" + g_js_strings.commonstr.actions + "</td></tr></thead><tbody>");
                var numoftransactions = rslt.pending.length;
                for (var i = 0; i < rslt.pending.length; i++) {
                    pending.push("<tr><td>");
                    pending.push(resourceinfo["rec" + rslt.pending[i].resourceType]);
                    pending.push("</td><td>");
                    pending.push(parseInt(rslt.pending[i].quantityK) * 1000);
                    pending.push("</td><td>");
                    pending.push(parseInt(rslt.pending[i].unitPricex1000) / 1000);
                    pending.push("</td><td>");
                    pending.push((parseInt(rslt.pending[i].quantityK) - parseInt(rslt.pending[i].remainingQuantityK)) * 1000);
                    pending.push("</td><td>");
                    if (parseInt(rslt.pending[i].postingType) == 1) {
                        pending.push(g_js_strings.commonstr.buying)
                    } else {
                        pending.push(g_js_strings.commonstr.selling)
                    }
                    pending.push("</td><td>");
                    pending.push("<a  class='button20' onclick='modal_marketplace_cancel(" + rslt.pending[i].marketPostingId + "," + rslt.pending[i].resourceType + "," + rslt.pending[i].postingType + "," + rslt.pending[i].remainingQuantityK + "," + rslt.pending[i].unitPricex1000 + ");return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a>");
                    pending.push("</td></tr>")
                }
                pending.push("</tbody></table>");
                $("marketmain_transactions_pending").innerHTML = pending.join("");
                $("marketmain_transactions").show();
                var delivery = new Array();
                delivery.push("<table cellpadding='0' cellspacing='0'><thead><tr><td class='resource'>" + g_js_strings.commonstr.resource + "</td><td class='amount'>" + g_js_strings.commonstr.amount + "</td><td class='unitprice'>" + g_js_strings.modal_marketplace.unitprice + "</td><td class='amounttraded'>" + g_js_strings.modal_marketplace_viewtransactions.totalprice + "</td><td class='status'>" + g_js_strings.modal_marketplace_viewtransactions.esttime + "</td><td class='actions'>" + g_js_strings.commonstr.actions + "</td></tr></thead><tbody>");
                if (!Object.isArray(rslt.deliveries)) {
                    var times = Object.keys(rslt.deliveries);
                    for (var k = 0; k < times.length; k++) {
                        var deliv = rslt.deliveries[times[k]];
                        for (var i = 0; i < deliv.length; i++) {
                            if (seed.queue_mkt["city" + currentcityid][times[k]] && seed.queue_mkt["city" + currentcityid][times[k]][i]) {
                                numoftransactions++;
                                delivery.push("<tr><td>");
                                delivery.push(resourceinfo["rec" + deliv[i].resourceType]);
                                delivery.push("</td><td>");
                                delivery.push(parseInt(deliv[i].quantityK) * 1000);
                                delivery.push("</td><td>");
                                delivery.push(parseInt(deliv[i].unitPricex1000) / 1000);
                                delivery.push("</td><td>");
                                delivery.push(parseInt(deliv[i].quantityK) * parseInt(deliv[i].unitPricex1000));
                                delivery.push("</td><td class='time' name='" + deliv[i].eventUnixTime + "_" + i + "'>");
                                delivery.push(timestr(parseInt(deliv[i].eventUnixTime) - unixtime()));
                                delivery.push("</td><td>");
                                delivery.push("&nbsp;");
                                delivery.push("<a  class='inlineButton20Red' onclick='modal_marketplace_speedup(" + deliv[i].marketDeliveryId + "," + deliv[i].eventUnixTime + "," + i + ");return false;'><span>" + g_js_strings.commonstr.speedup + "</span></a>");
                                delivery.push("</td></tr>")
                            }
                        }
                    }
                }
                $("marketmain_transactions_status").innerHTML = delivery.join("");
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                $("market_num_of_transactions").innerHTML = g_js_strings.commonstr.transactions + "<br/>" + numoftransactions
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function modal_marketplace_speedup(b, c, a) {
    var d = new Array();
    d.push("<div id='modal_lv10'>");
    d.push("<div class='lv10 clearfix'>");
    d.push("<img src='");
    d.push(stimgUrl);
    d.push("img/items/70/49.jpg'/>");
    d.push("<div class='info'><div class='ttl'>" + g_js_strings.commonstr.youneed + " ");
    d.push(itemlist.i49.name);
    d.push(" to finish this transaction immediately.</div><div class='own'>" + g_js_strings.commonstr.youown + ": ");
    if (seed.items.i49 > 0) {
        d.push(seed.items.i49)
    } else {
        d.push(0)
    }
    d.push("</div></div>");
    d.push("</div>");
    d.push("<div class='btns clearfix'>");
    if (seed.items.i49 > 0) {
        d.push("<a  class='button20' onclick='modal_marketplace_speedup_do(" + b + "," + c + "," + a + ");return false;'><span>" + g_js_strings.commonstr.speedup + "</span></a>")
    } else {
        d.push("<a  class='button20' onclick='Modal.hideModalAll();cm.ShopView.openShop(2);return false;'><span>" + g_js_strings.commonstr.getmore + "</span></a>")
    }
    d.push("<a  class='cancel' onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    d.push("</div></div>");
    Modal.showModal(400, 400, 130, 130, g_js_strings.modaltitles.speedupmarkettransaction, d.join(""))
}

function modal_marketplace_speedup_do(mid, timeidx, idx) {
    var params = Object.clone(g_ajaxparams);
    params.mid = mid;
    params.cid = currentcityid;
    params.iid = 49;
    new Ajax.Request(g_ajaxpath + "ajax/speedupTrade.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                seed.items.i49 = parseInt(seed.items.i49) - 1;
                ksoItems[49].subtract();
                Modal.hideModal();
                if (seed.queue_mkt["city" + currentcityid][timeidx] && seed.queue_mkt["city" + currentcityid][timeidx][idx]) {
                    seed.queue_mkt["city" + currentcityid][timeidx][idx].eventUnixTime = "1";
                    seed.resources["city" + currentcityid]["rec" + seed.queue_mkt["city" + currentcityid][timeidx][idx].resourceType][0] += parseInt(seed.queue_mkt["city" + currentcityid][timeidx][idx].quantityK) * 3600000
                }
                modal_marketplace_viewtransactions()
            } else {
                Modal.showAlert(rslt.msg)
            }
        },
        onFailure: function () {}
    })
}

function modal_marketplace_buysell(b, c) {
    $("marketmod_transac").value = b;
    var a = $("market_buyselltabs").select(".selected");
    if (a.length > 0) {
        a[0].removeClassName("selected")
    }
    c.className = "tab selected";
    if (parseInt(b) == 1) {
        $("modal_marketplace_buysell").innerHTML = g_js_strings.commonstr.buy;
        $("marketmod_totalpricetxt").innerHTML = g_js_strings.modal_marketplace_buysell.totalcost + ":"
    } else {
        $("modal_marketplace_buysell").innerHTML = g_js_strings.commonstr.sell;
        $("marketmod_totalpricetxt").innerHTML = g_js_strings.modal_marketplace_buysell.totalearned + ":"
    }
    modal_marketplace_updateprice()
}

function modal_marketplace_base() {
    modal_marketplace_changerec(1)
}

function modal_marketplace_checkbuy(quantk, price, res) {
    var params = Object.clone(g_ajaxparams);
    params.pid = currentcityinfo[4];
    new Ajax.Request(g_ajaxpath + "ajax/getMarketInfo.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                var sellinfo = rslt.data[res]["2"];
                if (!Object.isArray(sellinfo)) {
                    var pricemg = parseInt(price * 1000) + "mg";
                    if (parseInt(sellinfo[pricemg]) >= quantk) {
                        market_dotrade(quantk, price, 1)
                    } else {
                        Modal.hideModal();
                        Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.noresource, false, 450);
                        modal_marketplace_changerec(res)
                    }
                } else {
                    Modal.hideModal();
                    Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.noresource, false, 450);
                    modal_marketplace_changerec(res)
                }
            } else {}
        },
        onFailure: function () {}
    })
}

function modal_marketplace_changerec(recid) {
    market_update_num_of_transaction();
    var oldid = $("marketmod_recsel").getAttribute("name");
    var sels = $("marketmod_recsel").select(".selected");
    if (sels.length > 0) {
        sels[0].removeClassName("selected")
    }
    $("marketmod_goldnum").innerHTML = addCommas(seed.citystats["city" + currentcityid].gold[0]);
    $("marketmod_recsel").setAttribute("name", recid);
    $("marketmod_recsel" + recid).addClassName("selected");
    $("modal_build").className = "tab" + recid;
    $("marketmod_selltable").innerHTML = "<div class='spinny'></div>";
    var params = Object.clone(g_ajaxparams);
    params.pid = currentcityinfo[4];
    new Ajax.Request(g_ajaxpath + "ajax/getMarketInfo.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                var buyhtml = new Array();
                var buyinfo = rslt.data[recid][1];
                var recnm = resourceinfo["rec" + recid];
                buyhtml.push("<div class='buysellhd'>" + g_js_strings.modal_marketplace_changerec.numrequested.replace("%1$s", recnm) + "</div>");
                buyhtml.push("<table cellpadding='0' cellspacing='0'><thead><tr><td class='amount'><div>" + g_js_strings.commonstr.amount + "</div></td><td class='unitprice'>" + g_js_strings.modal_marketplace.unitprice + "</td></tr></thead><tbody>");
                if (!Object.isArray(buyinfo)) {
                    var prices = Object.keys(buyinfo);
                    for (var i = 0; i < prices.length; i++) {
                        buyhtml.push("<tr><td class='amount'><div>");
                        buyhtml.push(addCommas(parseInt(buyinfo[prices[i]]) * 1000));
                        buyhtml.push("</div></td><td class='unitprice'><div>");
                        buyhtml.push(parseInt(prices[i].split("mg")[0]) / 1000);
                        buyhtml.push("</div></td></tr>")
                    }
                }
                buyhtml.push("</tbody></table>");
                var sellhtml = new Array();
                var sellinfo = rslt.data[recid][2];
                sellhtml.push("<table cellpadding='5' cellspacing='0' width='100%'><thead><tr><td><div>" + g_js_strings.commonstr.amount + "</div></td><td><div>" + g_js_strings.modal_marketplace.unitprice + "</div></td><td colspan='2'></td></tr></thead><tbody>");
                if (!Object.isArray(sellinfo)) {
                    var prices = Object.keys(sellinfo);
                    for (var i = 0; i < prices.length; i++) {
                        sellhtml.push("<tr><td width='27%' class='amount'>");
                        sellhtml.push("<input type='hidden' id='market_resourceamount_input" + i + "' value='" + parseInt(sellinfo[prices[i]]) * 1000 + "'/>");
                        sellhtml.push(addCommas(parseInt(sellinfo[prices[i]]) * 1000));
                        sellhtml.push("</td><td width='26%' class='unitprice'>");
                        sellhtml.push(parseInt(prices[i].split("mg")[0]) / 1000);
                        sellhtml.push("</td>");
                        sellhtml.push("<td width='25%' class='max'><input type='hidden' id='market_unitprice_input" + i + "' value='" + (parseInt(prices[i].split("mg")[0]) / 1000) + "'/><input type='text' id='market_amount_input" + i + "' /></td>");
                        sellhtml.push('<td width="22%" class="buttons"><a class="buttonDown14" onclick="market_max(' + i + "," + parseInt(sellinfo[prices[i]]) * 1000 + '); return false;"><span>' + g_js_strings.commonstr.max + "</span></a>");
                        sellhtml.push("<a class='button14' onclick='market_confirm_transaction(1," + i + "); return false;'><span>" + g_js_strings.commonstr.buy + "</span></a></td>");
                        sellhtml.push("</tr>")
                    }
                }
                sellhtml.push("</tbody></table>");
                $("marketmod_selltable").innerHTML = sellhtml.join("")
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    });
    $("marketmod_recname").innerHTML = $("marketmod_recsel" + recid).innerHTML;
    $("marketmod_recnum").innerHTML = addCommas(parseInt(parseInt(seed.resources["city" + currentcityid]["rec" + recid][0]) / 3600));
    $("marketmod_amount").value = 0;
    $("marketmod_price").value = 0;
    $("marketmod_fee").innerHTML = "0";
    $("marketmod_totalprice").innerHTML = "0";
    $("marketmain_transactions").hide();
    $("marketmain_bdy").show()
}

function market_update_num_of_transaction() {
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    new Ajax.Request(g_ajaxpath + "ajax/getCityTradeStatus.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                var numoftransactions = rslt.pending.length;
                if (!Object.isArray(rslt.deliveries)) {
                    var times = Object.keys(rslt.deliveries);
                    for (var k = 0; k < times.length; k++) {
                        var deliv = rslt.deliveries[times[k]];
                        for (var i = 0; i < deliv.length; i++) {
                            if (seed.queue_mkt["city" + currentcityid][times[k]] && seed.queue_mkt["city" + currentcityid][times[k]][i]) {
                                numoftransactions++
                            }
                        }
                    }
                }
                $("market_num_of_transactions").innerHTML = g_js_strings.commonstr.transactions + "<br/>" + numoftransactions;
                if ($("marketmain_maxtransac")) {
                    if (parseInt(numoftransactions) >= parseInt($("marketmain_maxtransac").getAttribute("name"))) {
                        if (parseInt($("marketmain_maxtransac").getAttribute("name")) < 10) {
                            $("marketmain_maxtransac").innerHTML = g_js_strings.market_update_num_of_transaction.maxtransac + " " + g_js_strings.market_update_num_of_transaction.upgrademarket.replace("%1$s", buildingcost.bdg10[0])
                        } else {
                            $("marketmain_maxtransac").innerHTML = g_js_strings.market_update_num_of_transaction.maxtransac
                        }
                        $("marketmain_maxtransac").show()
                    } else {
                        $("marketmain_maxtransac").hide()
                    }
                }
            } else {}
        },
        onFailure: function () {}
    })
}

function market_max(c, b) {
    var a = market_resource_maxpossible(c, b);
    $("market_amount_input" + c).value = a
}

function market_resource_maxpossible(a, b) {
    var d = parseInt(b) * parseFloat($("market_unitprice_input" + a).value);
    var e = parseInt(d * 0.005 * 100) / 100;
    var f = d + e;
    var h = parseInt(seed.citystats["city" + currentcityid].gold[0]);
    var g = 0;
    if (f < h) {
        g = b
    } else {
        var i = h / 1.005;
        var c = parseInt(h / (1.005 * parseFloat($("market_unitprice_input" + a).value)));
        g = market_rounddown_resourceamount(c)
    }
    if (g < 1000) {
        g = 0
    }
    if (g > 999000) {
        g = 999000
    }
    return g
}

function market_rounddown_resourceamount(a) {
    return Math.floor(parseFloat(a) / 1000) * 1000
}

function market_confirm_transaction(d, a) {
    var f = new Array();
    var o;
    var g;
    var j;
    var p;
    var h;
    var l;
    var n;
    var e;
    var k = new Array();
    if (d == 1) {
        o = g_js_strings.modaltitles.confirmbuy;
        g = g_js_strings.commonstr.buy;
        j = $("market_amount_input" + a).value;
        p = $("market_unitprice_input" + a).value;
        e = g_js_strings.modal_marketplace_buysell.totalcost
    } else {
        o = g_js_strings.modaltitles.confirmsale;
        g = g_js_strings.commonstr.sell;
        j = $("marketmod_amount").value;
        p = $("marketmod_price").value;
        e = g_js_strings.modal_marketplace_buysell.totalearned
    }
    if (/^((\d+(\.\d*)?)|((\d*\.)?\d+))$/.test(p) == false) {
        k.push(g_js_strings.modal_marketplace_bidoffer.invalidprice)
    }
    if (/^\d+$/.test(j) == false) {
        k.push(g_js_strings.modal_marketplace_bidoffer.invalidamt)
    }
    if (k.length > 0) {
        Modal.showAlert(k);
        return false
    }
    j = market_rounddown_resourceamount(parseInt(j, 10));
    if (parseInt(j) < 1000) {
        if (parseInt(d) == 1) {
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.buyink, false, 450)
        } else {
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.sellink, false, 450)
        }
        return false
    }
    if (parseInt(d) == 1) {
        h = parseInt(j) * parseFloat(p);
        l = parseInt(h * 0.005);
        n = parseInt(h + l)
    } else {
        h = parseInt(j) * parseFloat(p);
        l = parseInt(h * 0.005);
        n = parseInt(h - l)
    }
    if (n > parseInt(seed.citystats["city" + currentcityid].gold[0]) && parseInt(d) == 1) {
        Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.nogold, false, 450);
        return false
    }
    if (l > parseInt(seed.citystats["city" + currentcityid].gold[0]) && parseInt(d) == 2) {
        Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.nogold, false, 450);
        return false
    }
    if (parseInt(d) == 2) {
        var m = parseInt($("marketmod_recsel").getAttribute("name"));
        var b = 0;
        var c = "";
        if (m == 1) {
            b = parseInt(seed.resources["city" + currentcityid].rec1[0] / 3600)
        } else {
            if (m == 2) {
                b = parseInt(seed.resources["city" + currentcityid].rec2[0] / 3600)
            } else {
                if (m == 3) {
                    b = parseInt(seed.resources["city" + currentcityid].rec3[0] / 3600)
                } else {
                    b = parseInt(seed.resources["city" + currentcityid].rec4[0] / 3600)
                }
            }
        }
        if (j > b) {
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.noresource, false, 450);
            return false
        }
    }
    if (!(parseInt(j) > 0)) {
        if (parseInt(d) == 1) {
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.buyink, false, 450)
        } else {
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.sellink, false, 450)
        }
        return false
    } else {
        if (!(p > 0)) {
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.greaterthan, false, 450);
            return false
        } else {
            if (!(parseInt(p * 1000) > 0)) {
                Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.atleast, false, 450);
                return false
            }
        }
    }
    if (parseInt(d) == 2) {
        j = market_rounddown_resourceamount(j)
    }
    var i = j;
    if ($("market_resourceamount_input" + a)) {
        i = parseInt($("market_resourceamount_input" + a).value)
    }
    if (parseInt(d) == 1) {
        if (j > i) {
            j = i
        }
    }
    f.push("<input type='hidden' id='market_submit_totalprice' value='" + n + "'/>");
    f.push("<input type='hidden' id='market_submit_unitprice' value='" + p + "'/>");
    f.push("<input type='hidden' id='market_submit_quantity' value='" + j + "'/>");
    f.push("<input type='hidden' id='market_submit_type' value='" + d + "'/>");
    f.push("<div class='modal_market_confirm_wrapper clearfix'>");
    f.push("<div class='header top-pad'>" + g_js_strings.modal_marketplace.resamt + ":</div>");
    f.push("<div class='amount'>" + addCommas(j) + "</div>");
    f.push("<div class='desc'>" + g_js_strings.modal_marketplace.roundingdesc + "</div>");
    f.push("<div class='header top-pad'>" + g_js_strings.modal_marketplace.unitprice + ":</div>");
    f.push("<div class='amount'>" + p + "</div>");
    f.push("<div class='desc'>" + g_js_strings.modal_marketplace.newpercdesc + "</div>");
    f.push("<div class='header top-pad'>" + g_js_strings.modal_marketplace.tradefee + ":</div>");
    f.push("<div class='price bottom-pad'>" + addCommas(l) + " " + g_js_strings.commonstr.gold + "</div>");
    f.push("<div class='header sep top-pad'>" + e + ":</div>");
    f.push("<div class='price'>" + addCommas(n) + " " + g_js_strings.commonstr.gold + "</div>");
    f.push("<div class='buttons'><a class='button25' onclick='market_submit_transaction(); return false;'><span>" + g + "</span></a> <a class='buttonDown25' onclick='Modal.hideModal(); return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a></div>");
    f.push("</div>");
    Modal.showModal(400, 400, 180, 525, o.toUpperCase(), f.join(""))
}

function market_submit_transaction() {
    var d = new Array();
    var c = $("market_submit_unitprice").value;
    if (/^((\d+(\.\d*)?)|((\d*\.)?\d+))$/.test(c) == false) {
        d.push(g_js_strings.modal_marketplace_bidoffer.invalidprice)
    }
    var b = parseInt(parseInt($("market_submit_quantity").value.split(",").join("")) / 1000);
    if (/^\d+$/.test(b) == false) {
        d.push(g_js_strings.modal_marketplace_bidoffer.invalidamt)
    }
    if (d.length > 0) {
        Modal.hideModal();
        Modal.showAlert(d);
        return false
    }
    var a = $("market_submit_type").value;
    if (!(parseInt(b) > 0)) {
        Modal.hideModal();
        if (parseInt(a) == 1) {
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.buyink)
        } else {
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.sellink)
        }
        return false
    } else {
        if (!(c > 0)) {
            Modal.hideModal();
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.greaterthan);
            return false
        } else {
            if (!(parseInt(c * 1000) > 0)) {
                Modal.hideModal();
                Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.atleast);
                return false
            }
        }
    }
    if (parseInt(a) == 1) {
        if (parseInt($("market_submit_totalprice").innerHTML.split(",").join("")) > seed.citystats["city" + currentcityid].gold[0]) {
            Modal.hideModal();
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.nogold);
            return false
        }
    } else {
        if ((b * 1000) > parseInt(seed.resources["city" + currentcityid]["rec" + $("marketmod_recsel").getAttribute("name")][0]) / 3600) {
            Modal.hideModal();
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.noresource);
            return false
        }
    }
    if (a == 1) {
        modal_marketplace_checkbuy(parseInt(b), c, parseInt($("marketmod_recsel").getAttribute("name")))
    } else {
        market_dotrade(b, c, a)
    }
}

function market_dotrade(quantk, price, transac) {
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    params.quantk = quantk;
    params.price = price;
    params.transac = transac;
    params.rtype = $("marketmod_recsel").getAttribute("name");
    new Ajax.Request(g_ajaxpath + "ajax/trade.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                Modal.hideModal();
                Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.tradesub, false, 450);
                if (parseInt(transac) == 1) {
                    seed.citystats["city" + currentcityid].gold[0] = parseInt(seed.citystats["city" + currentcityid].gold[0]) - parseInt($("marketmod_totalprice").innerHTML.split(",").join(""));
                    var deliveries = rslt.deliveries;
                    if (deliveries) {
                        seed.queue_mkt["city" + currentcityid] = deliveries;
                        queue_changetab_market()
                    }
                } else {
                    seed.citystats["city" + currentcityid].gold[0] = parseInt(seed.citystats["city" + currentcityid].gold[0]) - parseInt($("marketmod_fee").innerHTML.split(",").join(""));
                    seed.resources["city" + currentcityid]["rec" + params.rtype][0] = parseInt(seed.resources["city" + currentcityid]["rec" + params.rtype][0]) - quantk * 3600000
                }
                $("marketmod_amount").value = 0;
                $("marketmod_price").value = 0;
                modal_marketplace_updateprice();
                modal_marketplace_changerec($("marketmod_recsel").getAttribute("name"));
                update_gold();
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                market_update_num_of_transaction();
                getModalResourceBar()
            } else {
                Modal.hideModal();
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function modal_marketplace_updateprice() {
    var b = parseInt($("marketmod_amount").value) * parseFloat($("marketmod_price").value);
    var a = parseInt(b * 0.005 * 100) / 100;
    $("marketmod_fee").innerHTML = addCommas(parseInt(a));
    if (parseInt($("marketmod_transac").value) == 1) {
        $("marketmod_totalprice").innerHTML = addCommas(parseInt(b + a))
    } else {
        $("marketmod_totalprice").innerHTML = addCommas(parseInt(b - a))
    }
}

function modal_marketplace_bidoffer() {
    var invalid = new Array();
    var price = $("marketmod_price").value;
    if (/^((\d+(\.\d*)?)|((\d*\.)?\d+))$/.test(price) == false) {
        invalid.push(g_js_strings.modal_marketplace_bidoffer.invalidprice)
    }
    var quantk = parseInt(parseInt($("marketmod_amount").value.split(",").join("")) / 1000);
    if (/^\d+$/.test(quantk) == false) {
        invalid.push(g_js_strings.modal_marketplace_bidoffer.invalidamt)
    }
    if (invalid.length > 0) {
        Modal.showAlert(invalid);
        return false
    }
    var transac = $("marketmod_transac").value;
    if (!(parseInt(quantk) > 0)) {
        if (parseInt($("marketmod_transac").value) == 1) {
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.buyink)
        } else {
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.sellink)
        }
        return false
    } else {
        if (!(price > 0)) {
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.greaterthan);
            return false
        } else {
            if (!(parseInt(price * 1000) > 0)) {
                Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.atleast);
                return false
            }
        }
    }
    if (parseInt($("marketmod_transac").value) == 1) {
        if (parseInt($("marketmod_totalprice").innerHTML.split(",").join("")) > seed.citystats["city" + currentcityid].gold[0]) {
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.nogold);
            return false
        }
    } else {
        if ((quantk * 1000) > parseInt(seed.resources["city" + currentcityid]["rec" + $("marketmod_recsel").getAttribute("name")][0]) / 3600) {
            Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.noresource);
            return false
        }
    }
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    params.quantk = quantk;
    params.price = price;
    params.transac = transac;
    params.rtype = $("marketmod_recsel").getAttribute("name");
    new Ajax.Request(g_ajaxpath + "ajax/trade.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                Modal.showAlert(g_js_strings.modal_marketplace_bidoffer.tradesub);
                if (parseInt($("marketmod_transac").value) == 1) {
                    seed.citystats["city" + currentcityid].gold[0] = parseInt(seed.citystats["city" + currentcityid].gold[0]) - parseInt($("marketmod_totalprice").innerHTML.split(",").join(""));
                    var deliveries = rslt.deliveries;
                    if (deliveries) {
                        seed.queue_mkt["city" + currentcityid] = deliveries;
                        queue_changetab_market()
                    }
                } else {
                    seed.citystats["city" + currentcityid].gold[0] = parseInt(seed.citystats["city" + currentcityid].gold[0]) - parseInt($("marketmod_fee").innerHTML.split(",").join(""));
                    seed.resources["city" + currentcityid]["rec" + params.rtype][0] = parseInt(seed.resources["city" + currentcityid]["rec" + params.rtype][0]) - quantk * 3600000;
                    $("marketmod_recnum").innerHTML = addCommas(parseInt(parseInt(seed.resources["city" + currentcityid]["rec" + params.rtype][0]) / 3600))
                }
                $("marketmod_goldnum").innerHTML = addCommas(seed.citystats["city" + currentcityid].gold[0]);
                $("marketmod_amount").value = 0;
                $("marketmod_price").value = 0;
                modal_marketplace_updateprice();
                modal_marketplace_changerec($("marketmod_recsel").getAttribute("name"));
                update_gold();
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
};
cm.MerlinTutorialSteps = [{
    name: "MERLIN_INTRODUCTION",
    events: {
        enter: function () {
            cm.TutorialKeyController.disableKeys();
            if (cm.TutorialProgressChecker.isSawmillPositionOccupied()) {
                cm.TutorialManager.gotoStep("WATCH_SAWMILL_PROGRESS")
            } else {
                var a = [];
                a.push("<div class='content'>");
                a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin0.replace("%1$s", seed.player.prefix) + "</div>");
                a.push("<div class='buttonrow clearfix'>");
                a.push("<a class='button20' onclick='cm.TutorialEventDispatcher.dispatchTutorialEvent(\"complete\", \"MERLIN_INTRODUCTION\");return false;'><span>" + g_js_strings.commonstr.next + "</span></a>");
                a.push("<a class='textlink' onclick='cm.TutorialEventDispatcher.dispatchTutorialEvent(\"skip\", \"MERLIN_INTRODUCTION\");return false;'>" + g_js_strings.commonstr.nothanks + "</a></div>");
                a.push("</div>");
                var b = new cm.MerlinTutorialDialog(a.join(""));
                b.show();
                cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3-Merlin Intro-1" + seed.player.g);
                cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3 Skip-Merlin Intro-1" + seed.player.g);
                cm.MixPanelTracker.trackFunnel("FTE Tutorial v3", 1, "Merlin Intro", {
                    usr_gen: seed.player.g,
                    usr_byr: seed.player.y,
                    usr_ttl: titlenames[seed.player.title],
                    distinct_id: tvuid
                });
                cm.MixPanelTracker.trackFunnel("FTE Tutorial v3 Skip", 1, "Merlin Intro", {
                    usr_gen: seed.player.g,
                    usr_byr: seed.player.y,
                    usr_ttl: titlenames[seed.player.title],
                    distinct_id: tvuid
                });
                cm.ConversionTracker.track("biftetracking", 300);
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_merlin_intro");
                    fteConversionTracker("fte_conv_merlin_intro")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        },
        skip: function () {
            cm.TutorialManager.gotoStep("MERLIN_SKIP")
        }
    }
}, {
    name: "MERLIN_INCREASE_MIGHT",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillPositionOccupied()) {
                cm.TutorialManager.gotoStep("WATCH_SAWMILL_PROGRESS")
            } else {
                var a = [];
                a.push("<div class='content'>");
                a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin1 + "</div>");
                a.push("<div class='buttonrow clearfix'>");
                a.push("<a class='button20' onclick='cm.TutorialEventDispatcher.dispatchTutorialEvent(\"complete\", \"MERLIN_INCREASE_MIGHT\");return false;'><span>" + g_js_strings.commonstr.next + "</span></a></div>");
                a.push("</div>");
                var b = new cm.MerlinTutorialDialog(a.join(""));
                b.show();
                cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3-Merlin Increase Might-2");
                cm.MixPanelTracker.trackFunnel("FTE Tutorial v3", 2, "Merlin Increase Might", {
                    usr_gen: seed.player.g,
                    usr_byr: seed.player.y,
                    usr_ttl: titlenames[seed.player.title],
                    distinct_id: tvuid
                });
                cm.ConversionTracker.track("biftetracking", 400);
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_merlin_increase_might");
                    fteConversionTracker("fte_conv_merlin_increase_might")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_FIELD_TAB",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillPositionOccupied()) {
                cm.TutorialManager.gotoStep("WATCH_SAWMILL_PROGRESS")
            } else {
                $("arrowtip").innerHTML = "<div class='arrowup'><div>" + g_js_strings.tutorialCheck.clickforfield + "</div></div>";
                $("arrowtip").style.top = "139px";
                $("arrowtip").style.left = "49px";
                $("arrowtip").show();
                $("tutorialCover").addClassName("fieldview");
                tutorialUpdateCover2(37, 103, 43, 24);
                $("tutorialCover").show();
                cm.ConversionTracker.track("biftetracking", 500);
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_field_view");
                    fteConversionTracker("fte_conv_field_view")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_LOT_BUILD_SAWMILL",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillPositionOccupied()) {
                cm.TutorialManager.gotoStep("WATCH_SAWMILL_PROGRESS")
            } else {
                if (!$("maparea_fields").visible()) {
                    changeview_fields($("mod_views_field"))
                }
                $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialCheck.clickforsawmill + "</div></div>";
                $("arrowtip").style.top = "187px";
                $("arrowtip").style.left = "300px";
                $("arrowtip").show();
                $("tutorialCover").addClassName("sawmill");
                tutorialUpdateCover2(288, 308, 65, 45);
                $("tutorialCover").show();
                cm.ConversionTracker.track("biftetracking", 600);
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_start_sawmill");
                    fteConversionTracker("fte_conv_start_sawmill")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CHOOSE_SAWMILL",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillPositionOccupied()) {
                cm.TutorialManager.gotoStep("WATCH_SAWMILL_PROGRESS")
            } else {
                $("arrowtip").innerHTML = "<div class='arrowleft'><div>" + g_js_strings.tutorialCheck.clickheresawmill + "</div></div>";
                $("arrowtip").style.top = "264px";
                $("arrowtip").style.left = "254px";
                $("arrowtip").show();
                $("tutorialCover").addClassName("clicksawmill");
                tutorialUpdateCover2(128, 118, 105, 206);
                $("tutorialCover").show();
                cm.ConversionTracker.track("biftetracking", 700);
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_select_sawmill");
                    fteConversionTracker("fte_conv_select_sawmill")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_BUILD_BUTTON_SAWMILL",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillPositionOccupied()) {
                cm.TutorialManager.gotoStep("WATCH_SAWMILL_PROGRESS")
            } else {
                $("modalControls1").hide();
                if ($("modal_whats_this_link")) {
                    $("modal_whats_this_link").style.visibility = "hidden"
                }
                $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialCheck.clickbuildnohelp + "</div></div>";
                $("arrowtip").style.top = "175px";
                $("arrowtip").style.left = "379px";
                $("arrowtip").show();
                Modal.showCurtain();
                cm.ConversionTracker.track("biftetracking", 800);
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_build_sawmill");
                    fteConversionTracker("fte_conv_build_sawmill")
                }
            }
        },
        complete: function () {
            tutorialAdvance(1, 15);
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "WATCH_SAWMILL_PROGRESS",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillBuilding()) {
                $("arrowtip").innerHTML = "<div class='arrowdown'></div>";
                $("arrowtip").style.top = "465px";
                $("arrowtip").style.left = "500px";
                $("arrowtip").show();
                Modal.showCurtain();
                $("modalCurtain0").setOpacity(0.3);
                cm.ConversionTracker.track("biftetracking", 900);
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_building_sawmill");
                    fteConversionTracker("fte_conv_building_sawmill")
                }
            } else {
                cm.TutorialManager.gotoNextStep()
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_QUEST_SAWMILL_REWARD",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillRewardClaimed()) {
                cm.TutorialManager.gotoStep("MERLIN_BUILD_COTTAGE")
            } else {
                tutorialAdvance(1, 16);
                Modal.hideModalAll();
                $("arrowtip").innerHTML = "<div class='arrowup'><div>" + g_js_strings.tutorialCheck.clickforquests + "</div></div>";
                $("arrowtip").style.top = "100px";
                $("arrowtip").style.left = "209px";
                $("arrowtip").show();
                $("tutorialCover").addClassName("quest");
                tutorialUpdateCover2(190, 40, 55, 55);
                $("tutorialCover").show();
                cm.ConversionTracker.track("biftetracking", 1000);
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_click_quest");
                    fteConversionTracker("fte_conv_click_quest")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_QUEST_REWARD_BUTTON",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillRewardClaimed()) {
                cm.TutorialManager.gotoStep("MERLIN_BUILD_COTTAGE")
            } else {
                modal_quests_doquests();
                $("modalControls1").hide();
                Event.observe("modalControlsClose1", "click", modal_questsFTEClose1);
                $("arrowtip").innerHTML = "<div class='arrowright'><div>" + g_js_strings.tutorialCheck.clickforreward + "</div></div>";
                $("arrowtip").style.top = "497px";
                $("arrowtip").style.left = "340px";
                $("arrowtip").show();
                Modal.showCurtain();
                cm.ConversionTracker.track("biftetracking", 1100);
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_get_quest_reward");
                    fteConversionTracker("fte_conv_get_quest_reward")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_QUEST_CLOSE_BUTTON",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isSawmillRewardClaimed()) {
                cm.TutorialManager.gotoStep("MERLIN_BUILD_COTTAGE")
            } else {
                $("arrowtip").innerHTML = "<div class='arrowright'><div style='margin-left:-100px'>" + g_js_strings.tutorialCheck.clickclosetofieldview + "</div></div>";
                $("arrowtip").style.top = "497px";
                $("arrowtip").style.left = "570px";
                $("arrowtip").show();
                var a = document.createElement("div");
                a.id = "questClickCover";
                a.className = "clickCover";
                document.body.appendChild(a);
                Modal.showCurtain();
                $("modal_quests_fte_close_btn").show();
                $("modalControls1").show();
                tutorialFlag = true
            }
        },
        complete: function () {
            tutorialAdvance(1, 18);
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "MERLIN_BUILD_COTTAGE",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isCottagePositionOccupied()) {
                cm.TutorialManager.gotoStep("MERLIN_CONGRATULATIONS")
            } else {
                var a = [];
                a.push("<div class='content'>");
                a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin4 + "</div>");
                a.push("<div class='buttonrow clearfix'>");
                a.push("<a class='button20' onclick='cm.TutorialManager.gotoNextStep();return false;'><span>" + g_js_strings.commonstr.next + "</span></a>");
                a.push("</div>");
                a.push("</div>");
                var b = new cm.MerlinTutorialDialog(a.join(""));
                b.show();
                cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3-Merlin Build Cottage-4");
                cm.MixPanelTracker.trackFunnel("FTE Tutorial v3", 4, "Merlin Build Cottage", {
                    usr_gen: seed.player.g,
                    usr_byr: seed.player.y,
                    usr_ttl: titlenames[seed.player.title],
                    distinct_id: tvuid
                });
                cm.ConversionTracker.track("biftetracking", 1200);
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_merlin_build_cottage");
                    fteConversionTracker("fte_conv_merlin_build_cottage")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_CITY_TAB",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isCottagePositionOccupied()) {
                cm.TutorialManager.gotoStep("MERLIN_CONGRATULATIONS")
            } else {
                $("arrowtip").innerHTML = "<div class='arrowup'><div>" + g_js_strings.tutorialCheck.clickforcity + "</div></div>";
                $("arrowtip").style.top = "148px";
                $("arrowtip").style.left = "6px";
                $("arrowtip").show();
                $("tutorialCover").addClassName("cityview");
                tutorialUpdateCover2(-6, 103, 43, 24);
                $("tutorialCover").show();
                cm.ConversionTracker.track("biftetracking", 1300);
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_city_view");
                    fteConversionTracker("fte_conv_city_view")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_LOT_BUILD_COTTAGE",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isCottagePositionOccupied()) {
                cm.TutorialManager.gotoStep("MERLIN_CONGRATULATIONS")
            } else {
                $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialCheck.clickforcott + "</div></div>";
                $("arrowtip").style.top = "216px";
                $("arrowtip").style.left = "240px";
                $("arrowtip").show();
                $("tutorialCover").addClassName("cottage");
                tutorialUpdateCover2(235, 322, 43, 59);
                $("tutorialCover").show();
                cm.ConversionTracker.track("biftetracking", 1400);
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_start_cottage");
                    fteConversionTracker("fte_conv_start_cottage")
                }
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CHOOSE_COTTAGE",
    events: {
        enter: function () {
            $("arrowtip").innerHTML = "<div class='arrowleft'><div>" + g_js_strings.tutorialCheck.clickherecottage + "</div></div>";
            $("arrowtip").style.top = "264px";
            $("arrowtip").style.left = "130px";
            $("arrowtip").show();
            $("tutorialCover").addClassName("clickcottage");
            tutorialUpdateCover2(16, 117, 105, 206);
            $("tutorialCover").show();
            cm.ConversionTracker.track("biftetracking", 1500);
            if (numWorlds == 1) {
                cm.ConversionTracker.track("", "fte_conv_select_cottage");
                fteConversionTracker("fte_conv_select_cottage")
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "CLICK_BUILD_BUTTON_COTTAGE",
    events: {
        enter: function () {
            if (cm.TutorialProgressChecker.isCottagePositionOccupied()) {
                cm.TutorialManager.gotoStep("MERLIN_CONGRATULATIONS")
            } else {
                $("modalControls1").hide();
                if ($("modal_whats_this_link")) {
                    $("modal_whats_this_link").style.visibility = "hidden"
                }
                $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialCheck.clickbuildnohelpcottage + "</div></div>";
                $("arrowtip").style.top = "175px";
                $("arrowtip").style.left = "379px";
                $("arrowtip").show();
                Modal.showCurtain();
                cm.ConversionTracker.track("biftetracking", 1600);
                if (numWorlds == 1) {
                    cm.ConversionTracker.track("", "fte_conv_build_cottage");
                    fteConversionTracker("fte_conv_build_cottage")
                }
            }
        },
        complete: function () {
            tutorialAdvance(1, 21);
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "MERLIN_CONGRATULATIONS",
    events: {
        enter: function () {
            var a = [];
            a.push("<div class='content'>");
            a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin5 + "</div>");
            a.push("<div class='buttonrow clearfix'>");
            a.push("<a class='button20' onclick='cm.TutorialManager.gotoNextStep();return false;'><span>" + g_js_strings.commonstr.next + "</span></a></div>");
            a.push("</div>");
            var b = new cm.MerlinTutorialDialog(a.join(""));
            b.show();
            cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3-Merlin Level Up-5");
            cm.MixPanelTracker.trackFunnel("FTE Tutorial v3", 5, "Merlin Level Up", {
                usr_gen: seed.player.g,
                usr_byr: seed.player.y,
                usr_ttl: titlenames[seed.player.title],
                distinct_id: tvuid
            });
            cm.ConversionTracker.track("biftetracking", 1700);
            if (numWorlds == 1) {
                cm.ConversionTracker.track("", "fte_conv_merlin_level_up");
                fteConversionTracker("fte_conv_merlin_level_up")
            }
        },
        complete: function () {
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "MERLIN_ENDING",
    nextStepName: "ENDING",
    events: {
        enter: function () {
            var a = [];
            a.push("<div class='content'>");
            a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin7 + "</div>");
            a.push("<div class='buttonrow clearfix'>");
            a.push("<a class='button20' onclick='cm.TutorialEventDispatcher.dispatchTutorialEvent(\"complete\",\"MERLIN_ENDING\");return false;'><span>" + g_js_strings.commonstr.ok + "</span></a></div>");
            a.push("<iframe src='https://kabam1-a.akamaihd.net/pixelkabam/html/pixels/KoCP5.html' width='0' height='0' frameborder='0'></iframe>");
            a.push("</div>");
            var b = new cm.MerlinTutorialDialog(a.join(""));
            b.show();
            cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3-Merlin End-6");
            cm.MixPanelTracker.trackFunnel("FTE Tutorial v3", 6, "Merlin End", {
                usr_gen: seed.player.g,
                usr_byr: seed.player.y,
                usr_ttl: titlenames[seed.player.title],
                distinct_id: tvuid
            });
            cm.ConversionTracker.track("biftetracking", 1800, 0);
            if (numWorlds == 1) {
                cm.ConversionTracker.track("", "fte_conv_merlin_end");
                fteConversionTracker("fte_conv_merlin_end")
            }
        },
        complete: function () {
            seed.tutorial.t1 = 50;
            tutorialMerlinOver();
            cm.TutorialManager.gotoNextStep()
        }
    }
}, {
    name: "MERLIN_SKIP",
    events: {
        enter: function () {
            var a = [];
            a.push("<div class='content'>");
            a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin10 + "</div>");
            a.push("<div class='buttonrow clearfix'>");
            a.push("<a class='button20' onclick='cm.TutorialEventDispatcher.dispatchTutorialEvent(\"complete\", \"MERLIN_SKIP\");return false;'><span>" + g_js_strings.tutorialMerlinTutorial.skiptutorial + "</span></a>");
            a.push("<a class='button20' onclick='cm.TutorialEventDispatcher.dispatchTutorialEvent(\"cancel\", \"MERLIN_SKIP\");return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a>");
            a.push("</div>");
            a.push("<iframe src='https://kabam1-a.akamaihd.net/pixelkabam/html/pixels/KoCP5.html' width='0' height='0' frameborder='0'></iframe>");
            a.push("</div>");
            var b = new cm.MerlinTutorialDialog(a.join(""));
            b.show()
        },
        complete: function () {
            tutorialNoShow();
            cm.TutorialManager.gotoNextStep()
        },
        cancel: function () {
            cm.TutorialManager.startFromBeginning()
        }
    }
}, {
    name: "ENDING",
    events: {
        enter: function () {
            cm.TutorialManager.end();
            cm.ConversionTracker.track("biftetracking", 1900, 0)
        }
    }
}];
cm.messageController = function ($) {
    var getCommaSeparatedOfficers = function (officers) {
            var trailing = officers.reduce(function (sum, el, index) {
                return sum + el.id + ","
            }, "");
            return trailing.substring(0, trailing.length - 1)
        };
    var reset = function (target) {
            setTimeout(function () {
                $(target).val($(target + " option:first").val())
            }, 1000)
        };
    return {
        onchange: function (event) {
            var val = $(".moreActionsSelect").val();
            if (val == g_js_strings.modal_messages.markread) {
                if ($("#modal_msg_tabs_report").hasClass("selected")) {
                    Messages.markCheckedReportsAsRead()
                } else {
                    messages_action("markRead", "tbl_messages")
                }
            }
            if (val == g_js_strings.modal_messages.markunread) {
                messages_action("markUnread", "tbl_messages")
            }
            reset(".moreActionsSelect")
        },
        forward: function () {
            modal_messages_reply(false, true)
        },
        sendGroupOnChange: function () {
            var val = $(".selectComposeSubject").val();
            if (val == g_js_strings.commonstr.alliance) {
                $("#modal_msg_write_to").val(g_js_strings.commonstr.allianceAtSign)
            }
            if (val == g_js_strings.commonstr.officers) {
                $("#modal_msg_write_to").val(g_js_strings.commonstr.officersAtSign)
            }
            reset(".selectComposeSubject")
        },
        messageReplyOnChange: function () {
            var val = $(".messageReplySubject").val();
            if (val == g_js_strings.commonstr.forward) {
                cm.messageController.forward()
            }
            if (val == g_js_strings.commonstr.reply) {
                modal_messages_reply(true)
            }
            if (val == g_js_strings.modaltitles.blockuser) {
                modal_block_user_confirm()
            }
        },
        bind: function () {
            cm.select.bind();
            $(".checkAll").unbind("click").bind("click", function () {
                modal_messages_inbox_check($(this).attr("checked") ? 1 : 2)
            });
            $(".checkAllReports").unbind("click").bind("click", function () {
                modal_messages_reports_chk($(this).attr("checked") ? 1 : 2)
            })
        },
        escape: function (str) {
            return str.replace(/\n/g, "custom-line-break").replace(/\<br\>/g, "custom-line-break")
        },
        unescape: function (str) {
            return str.replace(/custom-line-break/g, "<br>")
        },
        messageWide: function (allianceall) {
            AjaxCall.gPostRequest("ajax/allianceGetInfo.php", {
                parameters: {
                    seeOfficers: true
                }
            }, function (rslt) {
                if (rslt.ok) {
                    if (!rslt.inAlliance) {
                        cm.ModalManager.alert(g_js_strings.messages.youarenot)
                    } else {
                        var params = Object.clone(g_ajaxparams);
                        params.toIds = allianceall ? rslt.allianceInfo.allianceId : rslt.allianceInfo.allianceId;
                        params.subject = $("#modal_msg_write_subj").val();
                        params.message = cm.messageController.escape(document.getElementById("modal_msg_write_txt").value);
                        params.type = allianceall ? "allianceall" : "alliance";
                        new Ajax.Request(g_ajaxpath + "ajax/sendMessage.php" + g_ajaxsuffix, {
                            method: "post",
                            parameters: params,
                            onSuccess: function (message) {
                                var rslt = eval("(" + message.responseText + ")");
                                cm.ModalManager.alert(rslt.ok ? g_js_strings.modal_messages_send.msgsent : g_js_strings.modal_messages_send.msgnotsent);
                                $("#modal_msg_write_to, #modal_msg_write_subj, #modal_msg_write_txt").val("")
                            },
                            onFailure: function () {}
                        })
                    }
                }
            })
        }
    }
}(jQuery);
var pageNavigatorPresentationModel = {
    cssClass: "pageNavigator",
    itemCssClass: "pageNavigatorItem"
};
var pageNavigatorModel;
var pageNavigatorView;
var pageNavigatorController;
if (!window.Messages) {
    var Messages = new Object()
}
Messages.Properties = {
    messages_data: null
};
Messages.Methods = {
    markCheckedReportsAsRead: function () {
        var a = $("modal_msg_reports_tablediv").getElementsByTagName("input");
        var c = new Array();
        var h = new Array();
        var f = new Array();
        var e = 0;
        for (var d = 0; d < a.length; d++) {
            if (a[d].checked && a[d].getAttribute("master_check") == null) {
                var b = a[d].getAttribute("name").split(",");
                if (parseInt(b[2]) == 0) {
                    if (parseInt(b[1]) == parseInt(tvuid)) {
                        c.push(b[0])
                    } else {
                        h.push(b[0])
                    }
                    if ($("viewreports_marchreport_" + b[0]).hasClassName("unread")) {
                        e++
                    }
                    a[d].checked = false;
                    $("viewreports_marchreport_" + b[0]).removeClassName("unread")
                } else {
                    if (parseInt(b[2]) == 1) {
                        f.push(b[0]);
                        if ($("viewreports_cityreport_" + b[0]).hasClassName("unread")) {
                            e++
                        }
                        a[d].checked = false;
                        $("viewreports_cityreport_" + b[0]).removeClassName("unread")
                    }
                }
            }
        }
        if (parseInt(e) == 0) {
            return false
        }
        var g = {};
        g.s0rids = c.join(",");
        g.s1rids = h.join(",");
        g.cityrids = f.join(",");
        AjaxCall.gPostRequest("ajax/readCheckedReports.php", g, function (i) {
            if (i.ok) {
                if (e > 0) {
                    seed.newReportCount = parseInt(seed.newReportCount) - e;
                    messages_notify_bug()
                }
            }
        })
    },
    deleteCheckedReports: function (a) {
        var g = $("modal_msg_reports_tablediv") ? $("modal_msg_reports_tablediv").getElementsByTagName("input") : [];
        var d = new Array();
        var b = new Array();
        var h = new Array();
        var j = 0;
        for (var e = 0; e < g.length; e++) {
            var f = g[e].getAttribute("name");
            if (f && g[e].checked) {
                var k = f.split(",");
                if (parseInt(k[2]) == 0) {
                    if (parseInt(k[1]) == parseInt(tvuid)) {
                        d.push(k[0])
                    } else {
                        b.push(k[0])
                    }
                    if ($("viewreports_marchreport_" + k[0]).hasClassName("unread")) {
                        j++
                    }
                } else {
                    if (parseInt(k[2]) == 1) {
                        h.push(k[0]);
                        if ($("viewreports_cityreport_" + k[0]).hasClassName("unread")) {
                            j++
                        }
                    }
                }
            }
        }
        if (d.length == 0 && b.length == 0 && h.length == 0 && a != "deleteAll") {
            return false
        }
        var c = {};
        if (a) {
            c.requestType = a
        }
        c.s0rids = d.join(",");
        c.s1rids = b.join(",");
        c.cityrids = h.join(",");
        AjaxCall.gPostRequest("ajax/deleteCheckedReports.php", c, function (i) {
            if (i.ok) {
                if (j > 0) {
                    seed.newReportCount = parseInt(seed.newReportCount) - j;
                    messages_notify_bug()
                }
                pageNavigatorModel.gotoPage(1);
                Messages.listReports();
                seed.newReportCount = 0;
                cm.NotificationView.exe()
            }
        })
    },
    viewMarchReport: function (p, a, q, g, o, h, n, k, i, s, l, m, d, t, e, f, j, r) {
        var c = arguments;
        $("modal_msg_list_pagination").hide();
        var b = {
            rid: p,
            side: a
        };
        AjaxCall.gPostRequest("ajax/fetchReport.php", b, function (w) {
            cm.GloryView.set(w);
            if (t == 1) {
                seed.newReportCount = parseInt(seed.newReportCount) - 1;
                messages_notify_bug()
            }
            var v = w.marchType == 2 || w.marchType == 5;
            if (v) {
                $("modal_msg_list").innerHTML = MarchReport.getMarchReport(c, w).render();
                $("modal_msg_list").innerHTML = cm.MarchReportController.getMarchReport(c, w)
            }
            jQuery(".msgTopBar, .reportDeletes, .tradeDeletes, .report_view").hide();
            cm.GloryView.render();
            var x = {
                side0PlayerId: j,
                side1PlayerId: r,
                rptid: p,
                sideNum: a,
                side: parseInt(a) == 0 ? "defender" : "attacker",
                tileType: q,
                tileLevel: g,
                defid: o,
                defnm: h,
                defgen: n,
                atknm: k,
                atkgen: i,
                marchtype: s,
                xcoord: l,
                ycoord: m,
                timestamp: d,
                unread: t,
                atkxcoord: e,
                atkycoord: f
            };
            if (!v) {
                var u = jQuery.extend({}, w, x);
                cm.ReportView.render(u)
            }
        })
    },
    listReports: function (a) {
        jQuery("#modal_msg_view, .report_view").hide();
        $("modal_msg_write").hide();
        $("modal_msg_list").show();
        $("modal_msg_list_actions").hide();
        $("modal_msg_links").hide();
        jQuery("#modal_msg_list_pagination").show();
        jQuery(".modal_msg_listwrap").css("height", "auto");
        var b = $("modal_msg_tabs").select("a.selected");
        if (b.length > 0) {
            b[0].removeClassName("selected")
        }
        $("modal_msg_tabs_report").addClassName("selected");
        $("modal_msg_body").className = "modal_msg_tab2";
        jQuery(".markReadButton, .msgTopBar, .reportDeletes").show();
        jQuery(".moreActionsSelect, .messageDeletes, .tradeDeletes").hide();
        AjaxCall.gPostRequest("ajax/listReports.php", {
            pageNo: a
        }, function (c) {
            Messages.handleListReports(c, a)
        })
    },
    handleListReports: function (l, a) {
        if (l.ok) {
            var n = new Array();
            n.push("<div class='modal_msg_reports'>");
            n.push("<div class='rptshd'>" + g_js_strings.modal_messages_viewreports.trooprpt + "&nbsp;&nbsp;-&nbsp;&nbsp;<a  onclick='modal_messages_viewtrades();return false;'>" + g_js_strings.modal_messages_viewdisasterreports.viewmkttrades + " (" + seed.newTradeReports + ")</a></div>");
            var b = Object.keys(l.arReports);
            if (!Object.isArray(l.arReports)) {
                n.push("<div id='modal_msg_reports_tablediv'><table cellpadding='0' cellspacing='0' class='msgviewtable reportviewtable'>");
                n.push("<thead><tr><td class='chkcol'><input type='checkbox' master_check='true' class='checkAllReports' /></td><td class='dtcol'>" + g_js_strings.commonstr.date + "</td><td class='nmcol'>" + g_js_strings.commonstr.type + "</td><td class='subjcol'>" + g_js_strings.commonstr.view + "</td></tr></thead><tbody>");
                var j = null;
                var m = null;
                var h = null;
                var k = null;
                var d = "";
                var p = 0;
                for (var g = 0; g < b.length; g++) {
                    k = l.arReports[b[g]];
                    j = [];
                    m = [];
                    p = parseInt(k.reportType);
                    if (0 == p && 2 == parseInt(k.marchType)) {
                        d = "viewreports_marchreport_";
                        j = [g_js_strings.commonstr.reinforced, " - ", l.arCityNames["c" + k.side0CityId], " (", l.arPlayerNames["p" + k.side1PlayerId], ")"];
                        h = ["'" + k.reportId + "'", "'" + k.side0CityId + "'", "'" + escape(l.arCityNames["c" + k.side0CityId]) + "'", "'" + g_mapObject.getSlotCity(1, k.side0CityId) + "'", "'" + k.side1PlayerId + "'", "'" + escape(l.arPlayerNames["p" + k.side1PlayerId]) + "'", "'" + k.side1CityId + "'", "'" + escape(l.arCityNames["c" + k.side1CityId]) + "'", k.side1XCoord, k.side1YCoord];
                        m = ["<a onclick=\"jQuery('#modal_msg_body').trigger('viewReinforcedReport', [", h.join(","), ']);return false;" href="#">', g_js_strings.modal_messages_viewtrades.viewrpt, "</a>"]
                    } else {
                        if (0 == p) {
                            d = "viewreports_marchreport_";
                            switch (parseInt(k.marchType)) {
                            case 1:
                                j.push(g_js_strings.commonstr.transport);
                                break;
                            case 3:
                            case 11:
                                j.push(g_js_strings.commonstr.scout);
                                break;
                            case 10:
                            case 4:
                            default:
                                j.push(g_js_strings.commonstr.attack);
                                break
                            }
                            j.push(" ");
                            if (parseInt(k.side0PlayerId) == parseInt(tvuid)) {
                                j.push("(" + l.arCityNames["c" + k.side0CityId] + ")")
                            } else {
                                var f = new cm.utils.CoordinateLink(k.side0XCoord, k.side0YCoord);
                                f.setClassName("coordinateLink");
                                j.push(f.getHTML())
                            }
                            j.push(" ");
                            if (parseInt(k.side0TileType) != 51) {
                                j.push(" - ");
                                if (k.marchType == 10 || k.marchType == 11) {
                                    j.push(g_js_strings.commonstr.boss.capitalize())
                                } else {
                                    j.push(g_mapObject.types[parseInt(k.side0TileType)].capitalize())
                                }
                                j.push(" Lv." + k.side0TileLevel)
                            } else {
                                var o = "<a href='javascript:void(0)' onclick='getInfoForAnUser(" + k.side1PlayerId + ")'>" + l.arPlayerNames["p" + k.side1PlayerId] + "</a>";
                                if (parseInt(k.side0PlayerId) == 0) {
                                    j.push(" - ");
                                    j.push(g_js_strings.commonstr.barbariancamp);
                                    j.push(" " + g_js_strings.commonstr.lv + " " + k.side0TileLevel)
                                } else {
                                    if (parseInt(k.marchType) == 1) {
                                        j.push(" - <span>" + g_js_strings.commonstr.from + ": ");
                                        j.push(o);
                                        j.push("</span>")
                                    } else {
                                        if (parseInt(k.side0PlayerId) == parseInt(tvuid)) {
                                            j.push(" - <span style='color:#A02932;'>" + g_js_strings.modal_messages_viewreports.attackedby + " ");
                                            if (parseInt(k.marchType) == 8) {
                                                j.push(g_js_strings.commonstr.barbarians)
                                            } else {
                                                j.push(o)
                                            }
                                            j.push("</span>")
                                        }
                                    }
                                }
                            }
                            if (parseInt(k.marchType) == 1) {
                                j.push("<span>");
                                j.push(" (" + l.arCityNames["c" + k.side1CityId] + ")");
                                j.push("</span>")
                            } else {
                                if (parseInt(k.marchType) == 8) {} else {
                                    if (parseInt(k.side0PlayerId) == parseInt(tvuid)) {
                                        j.push("<span style='color:#A02932;'>");
                                        j.push(" (" + l.arCityNames["c" + k.side1CityId] + ")");
                                        j.push("</span>")
                                    } else {
                                        j.push(" (" + l.arCityNames["c" + k.side1CityId] + ")")
                                    }
                                }
                            }
                            m.push("<a  onclick='");
                            if (k.marchType == 8) {
                                m.push("BarbarianRaid.viewMarchReport(")
                            } else {
                                m.push("Messages.viewMarchReport(")
                            }
                            h = ['"' + k.reportId + '"'];
                            if (parseInt(k.side0PlayerId) == parseInt(tvuid)) {
                                h.push(0)
                            } else {
                                h.push(1)
                            }
                            h.push(k.side0TileType);
                            h.push(k.side0TileLevel);
                            h.push(k.side0PlayerId);
                            if (parseInt(k.side0PlayerId) != 0) {
                                h.push('"' + escape(l.arPlayerNames["p" + k.side0PlayerId]) + '"')
                            } else {
                                h.push('"' + g_js_strings.commonstr.enemy + '"')
                            }
                            if (parseInt(k.side0PlayerId) != 0) {
                                h.push('"' + escape(l.arPlayerNames["g" + k.side0PlayerId]) + '"')
                            } else {
                                h.push('"0"')
                            }
                            if (parseInt(k.side1PlayerId) > 0) {
                                h.push('"' + escape(l.arPlayerNames["p" + k.side1PlayerId]) + '"')
                            } else {
                                h.push('""')
                            }
                            if (parseInt(k.side1PlayerId) != 0) {
                                h.push('"' + escape(l.arPlayerNames["g" + k.side1PlayerId]) + '"')
                            } else {
                                h.push('""')
                            }
                            h.push(k.marchType);
                            h.push(k.side0XCoord);
                            h.push(k.side0YCoord);
                            h.push(k.reportUnixTime);
                            if (parseInt(k.reportStatus) == 2) {
                                h.push(1)
                            } else {
                                h.push(0)
                            }
                            if (k.side1XCoord) {
                                h.push(k.side1XCoord);
                                h.push(k.side1YCoord)
                            } else {
                                h.push("0");
                                h.push("0")
                            }
                            h.push(k.side0PlayerId);
                            h.push(k.side1PlayerId);
                            m.push(h.join(","));
                            m.push(");return false;'>" + g_js_strings.modal_messages_viewtrades.viewrpt + "</a>")
                        } else {
                            if (1 == p) {
                                d = "viewreports_cityreport_";
                                switch (parseInt(k.eventType)) {
                                case 70:
                                    j.push(g_js_strings.modal_messages_viewdisasterreports.troopsdeserted);
                                    break;
                                case 80:
                                    j.push(g_js_strings.modal_messages_viewdisasterreports.troopsrecovered);
                                    break;
                                default:
                                    j.push(g_js_strings.commonstr.disaster);
                                    break
                                }
                                var c = parseInt(k.eventType);
                                switch (c) {
                                case 70:
                                case 80:
                                    m.push("<a onclick='modal_messages_viewCityEventReport(");
                                    m.push([k.reportId, a || 1, c].join(","));
                                    m.push(");return false;' href='#'>" + g_js_strings.modal_messages_viewtrades.viewrpt + "</a>");
                                    break;
                                default:
                                    break
                                }
                            }
                        }
                    }
                    n.push("<tr class='");
                    if (g % 2 == 0) {
                        n.push("stripe")
                    }
                    if (parseInt(k.reportStatus) == 2) {
                        n.push(" unread")
                    }
                    n.push("' id='" + d + k.reportId + "'>");
                    n.push("<td class='chkcol'><input type='checkbox' name='");
                    n.push([k.reportId, k.side0PlayerId, k.reportType].join(","));
                    n.push("'/></td><td class='dtcol'><div>");
                    n.push(formatDateByUnixTime(k.reportUnixTime));
                    n.push("</div></td>");
                    n.push("<td class='nmcol'><div>");
                    n.push(j.join(""));
                    n.push("</div></td>");
                    n.push("<td class='subjcol'><div>");
                    n.push(m.join(""));
                    n.push("</div></td>");
                    n.push("</tr>")
                }
                n.push("</tbody></table></div>")
            }
            $("modal_msg_list").innerHTML = n.join("");
            var e = parseInt(l.noOfPages || l.totalPages);
            e = isNaN(e) || e < 0 ? 0 : e;
            pageNavigatorController.onClick = modal_messages_viewreports;
            pageNavigatorModel.setPageCount(e);
            a = a || 1;
            pageNavigatorModel.gotoPage(a)
        } else {
            var n = new Array();
            n.push("<div class='modal_msg_reports'>");
            n.push("<div class='rptshd'>" + g_js_strings.modal_messages_viewreports.trooprpt + "&nbsp;&nbsp;-&nbsp;&nbsp;<a  onclick='modal_messages_viewtrades();return false;'>" + g_js_strings.modal_messages_viewdisasterreports.viewmkttrades + " (" + seed.newTradeReports + ")</a></div>");
            n.push("<div style='font-size:17px;margin-left:30px;margin-top:20px'>" + g_js_strings.modal_messages_viewreports.nomarchrpts + "</div>");
            n.push("</div>");
            $("modal_msg_list").innerHTML = n.join("");
            $("modal_msg_list_actions").hide();
            $("modal_msg_links").hide();
            pageNavigatorModel.setPageCount(0);
            if ($("pagination_indexOnly")) {
                ($("pagination_indexOnly")).remove()
            }
        }
        cm.messageController.bind()
    },
    handleGetEmail: function (b, f, e, a) {
        if (b.ok) {
            var d = 0;
            var g = f.selectedMessageIds.split(",");
            if (e == "markRead") {
                for (var c = 0; c < g.length; c++) {
                    if ($("modal_msg_list_" + g[c]).hasClassName("unread")) {
                        $("modal_msg_list_" + g[c]).removeClassName("unread");
                        d--
                    }
                }
            } else {
                if (e == "markUnread") {
                    for (var c = 0; c < g.length; c++) {
                        if (!$("modal_msg_list_" + g[c]).hasClassName("unread")) {
                            $("modal_msg_list_" + g[c]).addClassName("unread");
                            d++
                        }
                    }
                } else {
                    if (e == "delete" || e == "deleteAll") {
                        if (a == "inbox") {
                            modal_messages_inbox()
                        } else {
                            if (a == "outbox") {
                                modal_messages_outbox()
                            }
                        }
                        if (e == "deleteAll") {
                            d = 0;
                            Modal.hideModal();
                            seed.newMailCount = 0;
                            messages_notify_bug();
                            pageNavigatorModel.setPageCount(0)
                        } else {
                            d = -(g.length)
                        }
                    } else {
                        if (e == "blockUser") {
                            Modal.showAlert(printLocalError((b.error_code || null), (b.msg || null), (b.feedback || null)))
                        }
                    }
                }
            }
            if (d != 0) {
                seed.newMailCount = parseInt(seed.newMailCount) + d;
                messages_notify_bug()
            }
        } else {
            Modal.showAlert(printLocalError((b.error_code || null), (b.msg || null), (b.feedback || null)))
        }
    }
};
Object.extend(Messages, Messages.Methods);
Object.extend(Messages, Messages.Properties);

function modal_messages() {
    var a = new Array();
    a.push("<div id='modal_msg_body' class='modal_msg_tab1'><div class='modal_msg_body_hd'>");
    a.push("<div id='modal_msg_tabs' class='tabsbar clearfix'>");
    a.push("<a class='tab selected' id='modal_msg_tabs_inbox'  onclick='modal_messages_inbox();return false;'><span>" + g_js_strings.commonstr.inbox + "</span></a>");
    a.push("<div id='modal_msg_tabnum_inbox' class='num' style='display:none;'>0</div>");
    a.push("<a  class='tab' id='modal_msg_tabs_report' onclick='Messages.listReports();return false;'><span>" + g_js_strings.modal_messages.viewreports + "</span></a>");
    a.push("<div id='modal_msg_tabnum_report' class='num' style='display:none;'>0</div>");
    a.push("<a class='tab' id='modal_msg_tabs_outbox'  onclick='modal_messages_outbox();return false;'><span>" + g_js_strings.commonstr.outbox + "</span></a>");
    a.push("<a class='tab' id='modal_msg_tabs_write'  onclick='modal_messages_compose();return false;'><span>" + g_js_strings.commonstr.compose + "</span></a>");
    a.push("</div>");
    a.push("<div id='modal_msg_listwrap' class='modal_msg_listwrap clearfix'>");
    a.push("<div class='msgTopBar'>");
    a.push('<a class="buttonDown20 markReadButton" onclick="Messages.markCheckedReportsAsRead();"><span>' + g_js_strings.modal_messages.markread + "</span></a>");
    a.push(cm.select.gen({
        "class": "moreActionsSelect",
        onchange: "cm.messageController.onchange();",
        options: [{
            text: g_js_strings.messages.moreActions
        }, {
            text: g_js_strings.modal_messages.markread
        }, {
            text: g_js_strings.modal_messages.markunread
        }]
    }));
    a.push("<div class='messageDeletes'>");
    a.push("<a class='inlineButton20Red' onclick='messages_action(\"delete\",\"tbl_messages\");return false;'><span>" + g_js_strings.commonstr.deletetx + "</span></a>");
    a.push("<a  class='inlineButton20Red' onclick='confirmDeleteAll(\"deleteAll\",\"tbl_messages\");return false;'><span>" + g_js_strings.modal_messages.deleteall + "</span></a>");
    a.push("</div>");
    a.push("<div class='reportDeletes'>");
    a.push("<a  class='inlineButton20Red' onclick='Messages.deleteCheckedReports();return false;'><span>" + g_js_strings.commonstr.deletetx + "</span></a>");
    a.push("<a  class='inlineButton20Red' onclick='confirmReportsDeleteAll();return false;'><span>" + g_js_strings.modal_messages.deleteall + "</span></a> ");
    a.push("</div>");
    a.push("<div class='tradeDeletes'>");
    a.push("<div class='clearfix viewtradesbtns'><a  class='button20' onclick='modal_messages_viewtrades_read();return false;'><span>" + g_js_strings.modal_messages.markread + "</span></a>");
    a.push("<a  class='inlineButton20Red mr5' onclick='modal_messages_tradereports_chkdel();return false;'><span>" + g_js_strings.commonstr.deletetx + "</span></a><a  class='inlineButton20Red' onclick='confirmTradeReportsDeleteAll();return false;'><span>" + g_js_strings.modal_messages.deleteall + "</span></a>");
    a.push("</div>");
    a.push("</div>");
    a.push("</div>");
    a.push("<div id='modal_msg_list' class='modal_msg_list'>");
    a.push("</div>");
    a.push("<div id='modal_msg_links' class='modal_msg_links'>");
    a.push("<a onmouseover='showTooltip(\"Report Policy Violation\",this,event,\"kocmain_bottom\");' onmouseout='removeTooltip();' onclick='HelpDesk.show(7);return false;'>" + g_js_strings.commonstr.report + "</a>");
    a.push("<a onclick='getUserSettings();return false;'>" + g_js_strings.modal_messages.msgsettings + "</a>");
    a.push("</div>");
    a.push("<div id='modal_msg_list_actions' class='clearfix'>");
    a.push("<a id='modal_msg_list_markasread' style='display: none;' class='button20' onclick='messages_action(\"markRead\",\"tbl_messages\");return false;'><span>" + g_js_strings.modal_messages.markread + "</span></a>");
    a.push("<a id='modal_msg_list_markasunread'  style='display: none;'  class='button20' onclick='messages_action(\"markUnread\",\"tbl_messages\");return false;'><span>" + g_js_strings.modal_messages.markunread + "</span></a>");
    a.push("</div>");
    a.push("<div id='modal_msg_list_pagination' style='float:none;display:none;'></div>");
    a.push("<div id='modal_msg_write' style='display:none;'>");
    a.push(cm.select.gen({
        "class": "selectComposeSubject",
        onchange: "cm.messageController.sendGroupOnChange();",
        options: [{
            text: g_js_strings.messages.selectGroup
        }, {
            text: g_js_strings.commonstr.alliance
        }, {
            text: g_js_strings.commonstr.officers
        }]
    }));
    a.push("<div class='writeto'><div class='left_pad'>" + g_js_strings.commonstr.totx + ":  &nbsp; </div><input type='text' id='modal_msg_write_to' /></div>");
    a.push("<div class='writesubj'><div class='left_pad'>" + g_js_strings.commonstr.subject + ":  &nbsp; </div><input type='text' id='modal_msg_write_subj'/></div>");
    a.push("<div class='writetx'><div class='left_pad'></div><textarea id='modal_msg_write_txt'></textarea></div>");
    a.push("<div class='btn clearfix sendBack'><div class='rightSide'></div><a  onclick='modal_messages_send();return false;' class='sendButtonAnchor button20'><span>" + g_js_strings.commonstr.send + "</span></a></div>");
    a.push("</div>");
    a.push("<div id='modal_msg_view' style='display:none;'>");
    a.push("<div class='datesent'><b>" + g_js_strings.commonstr.date + ":</b> <span id='modal_msg_view_date'></span></div>");
    a.push("<div><b>" + g_js_strings.commonstr.totx + ":</b> <span id='modal_msg_view_to'></span></div>");
    a.push("<div><b>" + g_js_strings.commonstr.from + ":</b> <span id='modal_msg_view_from'></span></div>");
    a.push("<div class='rightDrop'><div class='rightEdge'></div><a class='inlineButton20Red' onclick=\"messages_action('delete', 'modal_msg_view' );\" ><span>" + g_js_strings.commonstr.deletetx + "</span></a>" + cm.select.gen({
        "class": "messageReplySubject",
        onchange: "cm.messageController.messageReplyOnChange();",
        options: [{
            text: g_js_strings.messages.moreActions
        }, {
            text: g_js_strings.commonstr.forward
        }, {
            text: g_js_strings.commonstr.reply
        }, {
            text: g_js_strings.modaltitles.blockuser
        }]
    }) + "</div>");
    a.push("<div class='subj' style='display: none;'><b>:</b> <span id='modal_msg_view_subj'></span></div>");
    a.push("<div id='modal_msg_view_actions' class='clearfix'><a  onclick='modal_messages_reply();return false;' class='button20'><span>" + g_js_strings.commonstr.reply + "</span></a><a  class='inlineButton20Red' onclick='messages_action(\"delete\",\"modal_msg_view\");return false;'><span>" + g_js_strings.commonstr.deletetx + "</span></a> <a  class='inlineButton20Red' onclick='modal_block_user_confirm();return false;'><span>" + g_js_strings.modal_messages.blockuser + "</span></a></div>");
    a.push("<div class='msgbody'><div id='modal_msg_view_body'></div><div class='footerWithButtons' ></div></div>");
    a.push("</div>");
    a.push("<div style='clear:both'></div>");
    a.push("</div>");
    a.push("<div class='modal_msg_listwrapcap'></div>");
    a.push("<div class='modal_msg_body_foot'>&nbsp;</div>");
    a.push("</div></div>");
    Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.messages, a.join(""), modal_messages_inbox);
    pageNavigatorModel = new cm.PageNavigatorModel(0, 5);
    pageNavigatorView = new cm.PageNavigatorView(pageNavigatorModel, pageNavigatorPresentationModel);
    pageNavigatorController = new cm.PageNavigatorController(pageNavigatorModel, pageNavigatorView);
    cm.messageController.bind();
    setTimeout(cm.messageController.bind, 1000);
    $("modal_msg_list_pagination").appendChild(pageNavigatorView.getHtmlElement())
}

function modal_block_user_confirm() {
    var a = new Array();
    a.push("<div class='blockuserconfirm'>");
    a.push("<div>");
    a.push(g_js_strings.modal_block_user_confirm.blockuserconfirm);
    a.push("<div class='clearfix'>");
    a.push("<a class='button20' onclick='messages_action(\"blockUser\",\"modal_msg_view\");Modal.hideModal();return false;'><span>" + g_js_strings.modal_messages.blockuser + "</span></a>");
    a.push("<a class='button20' onclick='Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a>");
    a.push("</div>");
    a.push("</div>");
    a.push("</div>");
    Modal.showModal(400, 400, 120, 80, g_js_strings.modaltitles.blockuser, a.join(""))
}

function openMessageWindow(a) {
    if (a == "inbox") {
        modal_messages()
    }
}

function modal_messages_inbox_check(d) {
    var a = $("tbl_messages").getElementsByTagName("input");
    var b = false;
    if (d == 1) {
        b = true
    }
    for (var c = 0; c < a.length; c++) {
        a[c].checked = b
    }
    return true
}

function modal_messages_inbox(a) {
    var b = $("modal_msg_tabs").select("a.selected");
    if (b.length > 0) {
        b[0].removeClassName("selected")
    }
    $("modal_msg_tabs_inbox").addClassName("selected");
    jQuery("#modal_msg_list_pagination").show();
    $("modal_msg_body").className = "modal_msg_tab1";
    jQuery(".msgTopBar").show();
    jQuery(".modal_msg_listwrap").css("height", "auto");
    hideMessageTabs();
    jQuery(".moreActionsSelect, .messageDeletes").show();
    if (a === false) {
        return false
    }
    modal_messages_listshow("inbox");
    messages_notify_bug()
}

function hideMessageTabs() {
    jQuery(".markReadButton, .reportDeletes, .tradeDeletes, .report_view").hide()
}

function modal_messages_outbox() {
    var a = $("modal_msg_tabs").select("a.selected");
    if (a.length > 0) {
        a[0].removeClassName("selected")
    }
    $("modal_msg_tabs_outbox").addClassName("selected");
    $("modal_msg_body").className = "modal_msg_tab3";
    jQuery(".msgTopBar").show();
    jQuery(".modal_msg_listwrap").css("height", "auto");
    $("modal_msg_list_pagination").show();
    cm.messageController.bind();
    modal_messages_listshow("outbox");
    jQuery(".markReadButton, .report_view").hide();
    jQuery(".moreActionsSelect").hide()
}

function modal_messages_reply(a, d) {
    var b = jQuery(".innersubject span").text();
    var e = jQuery("#modal_msg_view_from a").text();
    if (a !== false) {
        $("modal_msg_write_to").value = $("modal_msg_view_from").firstDescendant().innerHTML
    }
    $("modal_msg_write_subj").value = "re: " + b;
    var c = jQuery(".bodytext").html();
    c = c.replace(/\n/gi, "");
    c = c.replace(/<br>/gi, "\n");
    c = c.replace(/<p>/gi, "\n\n");
    c = c.replace(/<\/p>/gi, "");
    c = c.replace(/(<([^>]+)>)/ig, "");
    if (d) {
        $("modal_msg_write_txt").value = "\n\n[" + g_js_strings.modal_messages.forwardtag + " " + e + "]\n" + c
    }
    modal_messages_compose()
}

function modal_messages_send() {
    var mess = cm.messageController.escape(document.getElementById("modal_msg_write_txt").value);
    var recipient = document.getElementById("modal_msg_write_to").value;
    var alli = g_js_strings.commonstr.allianceAtSign.toLowerCase();
    if (recipient.toLowerCase() == g_js_strings.commonstr.officersAtSign.toLowerCase() || recipient.toLowerCase() == alli) {
        cm.messageController.messageWide(recipient.toLowerCase() == alli)
    } else {
        var params = Object.clone(g_ajaxparams);
        params.emailTo = recipient;
        params.subject = document.getElementById("modal_msg_write_subj").value;
        params.message = mess;
        params.requestType = "COMPOSED_MAIL";
        new Ajax.Request(g_ajaxpath + "ajax/getEmail.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (message) {
                var rslt = eval("(" + message.responseText + ")");
                if (rslt.ok) {
                    Modal.showAlert(g_js_strings.modal_messages_send.msgsent);
                    $("modal_msg_write_to").value = "";
                    $("modal_msg_write_subj").value = "";
                    $("modal_msg_write_txt").value = ""
                } else {
                    Modal.showAlert(g_js_strings.modal_messages_send.enterexistingname)
                }
            },
            onFailure: function () {
                Modal.showAlert(g_js_strings.modal_messages_send.oopscompose)
            }
        })
    }
}

function modal_messages_compose() {
    var a = $("modal_msg_tabs").select("a.selected");
    if (a.length > 0) {
        a[0].removeClassName("selected")
    }
    $("modal_msg_tabs_write").addClassName("selected");
    $("modal_msg_view").hide();
    $("modal_msg_list").hide();
    $("modal_msg_list_actions").hide();
    $("modal_msg_links").hide();
    $("modal_msg_list_pagination").hide();
    jQuery(".msgTopBar, .report_view").hide();
    jQuery(".modal_msg_listwrap").css("height", "auto");
    $("modal_msg_body").className = "modal_msg_tab4";
    $("modal_msg_write").show()
}

function modal_messages_viewtrades_view(o, b, f, k, l, h, e, j, c, g) {
    var a = pageNavigatorModel.getPageCount();
    var m = pageNavigatorModel.getPageCount();
    $("modal_msg_list_pagination").hide();
    h = parseInt(h) / 1000;
    maxQuant = parseInt(e) * 1000;
    usedQuant = (parseInt(g) == 0) ? parseInt(e) * 1000 : (parseInt(e) - parseInt(g)) * 1000;
    var n = new Array();
    n.push("<div class='viewtrades'>");
    n.push("<div class='tradettl'>");
    n.push(addCommas(usedQuant));
    n.push(" ");
    n.push(resourceinfo["rec" + l]);
    switch (parseInt(k)) {
    case 1:
        n.push(" " + g_js_strings.commonstr.purchased);
        break;
    case 2:
        n.push(" " + g_js_strings.commonstr.sold);
        break
    }
    for (var d = 0; d < seed.cities.length; d++) {
        if (parseInt(seed.cities[d][0]) == parseInt(f)) {
            n.push(" - <span>(" + seed.cities[d][1] + ": " + seed.cities[d][2] + "," + seed.cities[d][3] + ")</span>");
            d = seed.cities.length
        }
    }
    n.push("</div>");
    n.push("<div>");
    n.push(resourceinfo["rec" + l]);
    switch (parseInt(k)) {
    case 1:
        n.push(" " + g_js_strings.commonstr.purchased);
        break;
    case 2:
        n.push(" " + g_js_strings.commonstr.sold);
        break
    }
    n.push(" " + g_js_strings.modal_messages_viewtrades_view.fromatob.replace("%1$s", j).replace("%2$s", b));
    n.push("</div>");
    if (parseInt(k) == 1) {
        n.push("<div><b>" + g_js_strings.modal_messages_viewtrades_view.unitprice + ":</b> " + h + " " + resourceinfo.rec0 + "</div>");
        n.push("<div><b>" + g_js_strings.modal_messages_viewtrades_view.costofa.replace("%1$s", resourceinfo["rec" + l]) + ":</b> " + addCommas(Math.floor(h * usedQuant)) + " " + resourceinfo.rec0 + "</div>");
        n.push("<div><b>" + g_js_strings.modal_messages_viewtrades_view.mktfee + ":</b> " + addCommas(parseInt(h * maxQuant * 0.005)) + " " + resourceinfo.rec0 + "</div>");
        n.push("<div><b>" + g_js_strings.modal_messages_viewtrades_view.totalgold + ":</b> " + addCommas(parseInt(parseInt(h * usedQuant * 1005) / 1000)) + " " + resourceinfo.rec0 + "</div>");
        n.push("<div>**" + g_js_strings.modal_messages_viewtrades_view.res30min + "</div>")
    } else {
        if (parseInt(k) == 2) {
            n.push("<div><b>" + g_js_strings.modal_messages_viewtrades_view.unitprice + ":</b> " + h + " " + resourceinfo.rec0 + "</div>");
            n.push("<div><b>" + g_js_strings.modal_messages_viewtrades_view.mktfee + ":</b> " + addCommas(parseInt(h * maxQuant * 0.005)) + " " + resourceinfo.rec0 + "</div>");
            n.push("<div><b>" + g_js_strings.modal_messages_viewtrades_view.goldearned + ":</b> " + addCommas(Math.floor(h * usedQuant)) + " " + resourceinfo.rec0 + " <span class='note'></span></div>")
        }
    }
    n.push("</div>");
    $("modal_msg_list").innerHTML = n.join("");
    if (parseInt(c) == 2) {
        modal_messages_viewtrades_read([o]);
        seed.newTradeReports = parseInt(seed.newTradeReports) - 1;
        messages_notify_bug()
    }
}

function modal_messages_viewtrades_read(a) {
    var c = false;
    if (!a) {
        c = true;
        var b = $("modal_msg_reports_tablediv").getElementsByTagName("input");
        var a = new Array();
        var g = 0;
        for (var d = 0; d < b.length; d++) {
            if (b[d].checked) {
                var e = b[d].getAttribute("name");
                if ($("viewreports_tradereport_" + e) && $("viewreports_tradereport_" + e).hasClassName("unread")) {
                    a.push(e);
                    g++
                }
            }
        }
        if (g == 0) {
            return false
        }
    }
    var f = Object.clone(g_ajaxparams);
    f.rids = a.join(",");
    new Ajax.Request(g_ajaxpath + "ajax/readCheckedTradeReports.php" + g_ajaxsuffix, {
        method: "post",
        parameters: f,
        onSuccess: function (h) {
            if (c == true) {
                seed.newTradeReports = parseInt(seed.newTradeReports) - g;
                if (seed.newTradeReports < 0) {
                    seed.newTradeReports = 0
                }
                messages_notify_bug();
                modal_messages_viewtrades()
            }
        },
        onFailure: function () {}
    })
}

function modal_messages_viewtrades(pageNo) {
    $("modal_msg_view").hide();
    $("modal_msg_write").hide();
    $("modal_msg_list").show();
    $("modal_msg_list_actions").hide();
    $("modal_msg_links").hide();
    var tabs = $("modal_msg_tabs").select("a.selected");
    if (tabs.length > 0) {
        tabs[0].removeClassName("selected")
    }
    $("modal_msg_tabs_report").addClassName("selected");
    jQuery(".msgTopBar").show();
    $("modal_msg_body").className = "modal_msg_tab2";
    var params = Object.clone(g_ajaxparams);
    params.pageNo = pageNo;
    new Ajax.Request(g_ajaxpath + "ajax/listTradeReports.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            var msghtml = new Array();
            msghtml.push("<div class='modal_msg_reports'>");
            msghtml.push("<div class='tradeDeletes'>");
            msghtml.push("<div class='clearfix viewtradesbtns'><a  class='button20' onclick='modal_messages_viewtrades_read();return false;'><span>" + g_js_strings.modal_messages.markread + "</span></a>");
            msghtml.push("<a  class='inlineButton20Red mr5' onclick='modal_messages_tradereports_chkdel();return false;'><span>" + g_js_strings.commonstr.deletetx + "</span></a><a  class='inlineButton20Red' onclick='confirmTradeReportsDeleteAll();return false;'><span>" + g_js_strings.modal_messages.deleteall + "</span></a>");
            msghtml.push("</div>");
            msghtml.push("</div>");
            msghtml.push("<div class='rptshd'><a  onclick='Messages.listReports();return false;'>" + g_js_strings.modal_messages_viewtrades.viewtroop + "</a>&nbsp;&nbsp;-&nbsp;&nbsp;" + g_js_strings.modal_messages_viewtrades.viewmkt + "</div>");
            if (rslt.ok) {
                if (!Object.isArray(rslt.arReports)) {
                    msghtml.push("<div id='modal_msg_reports_tablediv'><table cellpadding='0' cellspacing='0' class='msgviewtable reportviewtable'>");
                    msghtml.push("<thead><tr><td class='chkcol'><input type='checkbox'  master_check='true'  class='checkAllReports' /></td><td class='dtcol'>" + g_js_strings.commonstr.date + "</td><td class='nmcol'>" + g_js_strings.commonstr.eventtx + "</td>");
                    msghtml.push("<td class='subjcol'>" + g_js_strings.commonstr.view + "</td>");
                    msghtml.push("</tr></thead><tbody>");
                    var rptkeys = Object.keys(rslt.arReports);
                    for (var i = 0; i < rptkeys.length; i++) {
                        var idvrpt = rslt.arReports[rptkeys[i]];
                        msghtml.push("<tr class='");
                        if (i % 2 == 0) {
                            msghtml.push("stripe")
                        }
                        if (parseInt(idvrpt.status) == 2) {
                            msghtml.push(" unread")
                        }
                        msghtml.push("' id='viewreports_tradereport_");
                        msghtml.push(idvrpt.id);
                        msghtml.push("'><td class='chkcol'><input type='checkbox' name='");
                        msghtml.push(idvrpt.id);
                        msghtml.push("'/></td><td class='dtcol'><div>");
                        msghtml.push(formatDateByUnixTime(idvrpt.reportUnixTime));
                        msghtml.push("</div></td>");
                        msghtml.push("<td class='nmcol'><div>");
                        msghtml.push(addCommas(parseInt(idvrpt.quantityK) * 1000));
                        msghtml.push(" ");
                        msghtml.push(resourceinfo["rec" + idvrpt.resourceType]);
                        switch (parseInt(idvrpt.postingType)) {
                        case 1:
                            msghtml.push(" " + g_js_strings.commonstr.purchased);
                            break;
                        case 2:
                            msghtml.push(" " + g_js_strings.commonstr.sold);
                            break
                        }
                        for (var j = 0; j < seed.cities.length; j++) {
                            if (parseInt(seed.cities[j][0]) == parseInt(idvrpt.cityId)) {
                                msghtml.push(" (" + seed.cities[j][1] + ")");
                                j = seed.cities.length
                            }
                        }
                        msghtml.push("</div></td>");
                        msghtml.push("<td class='subjcol'><div>");
                        msghtml.push("<a  onclick='modal_messages_viewtrades_view(");
                        msghtml.push(idvrpt.id + ',"' + idvrpt.strReportUnixTime + '",' + idvrpt.cityId + "," + idvrpt.postingType + "," + idvrpt.resourceType + "," + idvrpt.unitPricex1000 + "," + idvrpt.quantityK + ',"' + idvrpt.strPostUnixTime + '",' + idvrpt.status + "," + idvrpt.remainingQuantityK);
                        msghtml.push(");return false;'>" + g_js_strings.modal_messages_viewtrades.viewrpt + "</a>");
                        msghtml.push("</div></td>");
                        msghtml.push("</tr>")
                    }
                    msghtml.push("</tbody></table></div>")
                }
                msghtml.push("</div>");
                $("modal_msg_list").innerHTML = msghtml.join("");
                pageNavigatorController.onClick = modal_messages_viewtrades;
                var pageCount = parseInt(rslt.noOfPages || rslt.totalPages);
                pageCount = isNaN(pageCount) || pageCount < 0 ? 0 : pageCount;
                pageNavigatorModel.setPageCount(pageCount);
                pageNo = pageNo || 1;
                pageNavigatorModel.gotoPage(pageNo)
            } else {
                pageNavigatorModel.setPageCount(0);
                msghtml.push("<div style='font-weight:bold;font-size:14px;padding:10px 0 0 20px;'>" + g_js_strings.modal_messages_viewtrades.notrades + "</div>");
                msghtml.push("</div>");
                $("modal_msg_list").innerHTML = msghtml.join("")
            }
            jQuery(".msgTopBar, .reportDeletes, .report_view").hide();
            jQuery(".tradeDeletes").show();
            cm.messageController.bind()
        },
        onFailure: function () {}
    })
}

function modal_messages_viewdisasterreports(pageNo) {
    $("modal_msg_view").hide();
    $("modal_msg_write").hide();
    $("modal_msg_list").show();
    $("modal_msg_list_actions").hide();
    $("modal_msg_links").hide();
    var tabs = $("modal_msg_tabs").select("a.selected");
    if (tabs.length > 0) {
        tabs[0].removeClassName("selected")
    }
    $("modal_msg_tabs_report").addClassName("selected");
    jQuery(".msgTopBar").show();
    $("modal_msg_body").className = "modal_msg_tab2";
    var params = Object.clone(g_ajaxparams);
    params.pageNo = pageNo;
    new Ajax.Request(g_ajaxpath + "ajax/listDisasterReports.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            var msghtml = new Array();
            msghtml.push("<div class='modal_msg_reports'>");
            msghtml.push("<div class='rptshd'><a onclick='Messages.listReports();return false;'>" + g_js_strings.modal_messages_viewtrades.viewtroop + "</a>&nbsp;&nbsp;-&nbsp;&nbsp;" + g_js_strings.modal_messages_viewdisasterreports.disasterrpts + "&nbsp;&nbsp;-&nbsp;&nbsp;<a onclick='modal_messages_viewtrades();return false;'>" + g_js_strings.modal_messages_viewdisasterreports.viewmkttrades + " (" + seed.newTradeReports + ")</a></div>");
            if (rslt.ok) {
                if (!Object.isArray(rslt.arReports)) {
                    msghtml.push("<div id='modal_msg_reports_tablediv'><table cellpadding='0' cellspacing='0' class='msgviewtable reportviewtable'>");
                    msghtml.push("<thead><tr><td class='chkcol'><input type='checkbox'  master_check='true'  class='checkAllReports' /></td><td class='dtcol'>" + g_js_strings.commonstr.date + "</td><td class='nmcol'>" + g_js_strings.commonstr.eventtx + "</td>");
                    msghtml.push("<td class='subjcol'>" + g_js_strings.commonstr.view + "</td></tr></thead><tbody>");
                    var rptkeys = Object.keys(rslt.arReports);
                    for (var i = 0; i < rptkeys.length; i++) {
                        var idvrpt = rslt.arReports[rptkeys[i]];
                        msghtml.push("<tr class='");
                        if (i % 2 == 0) {
                            msghtml.push("stripe")
                        }
                        msghtml.push("' id='viewdisasterreports_marchreport_");
                        msghtml.push(idvrpt.cityEventReportId);
                        msghtml.push("'><td class='chkcol'><input type='checkbox' name='");
                        msghtml.push(idvrpt.cityEventReportId);
                        msghtml.push("'/></td><td class='dtcol'><div>");
                        msghtml.push(formatDateByUnixTime(idvrpt.reportUnixTime));
                        msghtml.push("</div></td>");
                        msghtml.push("<td class='nmcol'><div>");
                        switch (parseInt(idvrpt.eventType)) {
                        case 70:
                            msghtml.push(g_js_strings.modal_messages_viewdisasterreports.troopsdeserted);
                            break;
                        case 80:
                            msghtml.push(g_js_strings.modal_messages_viewdisasterreports.troopsrecovered);
                            break;
                        default:
                            msghtml.push(g_js_strings.commonstr.disaster);
                            break
                        }
                        msghtml.push("</div></td>");
                        var eventType = parseInt(idvrpt.eventType);
                        switch (eventType) {
                        case 70:
                        case 80:
                            msghtml.push("<td class='subjcol'><div>");
                            msghtml.push("<a onclick='modal_messages_viewCityEventReport(");
                            msghtml.push(idvrpt.cityEventReportId);
                            msghtml.push(",");
                            if (pageNo) {
                                msghtml.push(pageNo)
                            } else {
                                msghtml.push(1)
                            }
                            msghtml.push(", " + eventType);
                            msghtml.push(");return false;' href='#'>" + g_js_strings.modal_messages_viewtrades.viewrpt + "</a>");
                            msghtml.push("</div></td>");
                            break;
                        default:
                            msghtml.push("<td class='subjcol'><div>");
                            msghtml.push("</div></td>");
                            break
                        }
                        msghtml.push("</tr>")
                    }
                    msghtml.push("</tbody></table></div>")
                }
            } else {}
            msghtml.push("</div>");
            $("modal_msg_list").innerHTML = msghtml.join("");
            var pageCount = parseInt(rslt.noOfPages || rslt.totalPages);
            pageCount = isNaN(pageCount) || pageCount < 0 ? 0 : pageCount;
            pageNavigatorController.onClick = modal_messages_viewdisasterreports;
            pageNavigatorModel.setPageCount(pageCount);
            pageNo = pageNo || 1;
            pageNavigatorModel.gotoPage(pageNo)
        },
        onFailure: function () {}
    })
}

function modal_messages_viewCityEventReport(reportid, pageno, eventType) {
    eventType = eventType || 80;
    if (eventType = 70) {
        var params = Object.clone(g_ajaxparams);
        params.rid = reportid;
        new Ajax.Request(g_ajaxpath + "ajax/fetchCityEventReport.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (message) {
                var rslt = message.responseText.evalJSON();
                $("modal_msg_list_pagination").hide();
                if (!rslt.ok) {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                } else {
                    var reportDate = formatDateByUnixTime(rslt.index.reportUnixTime);
                    var reportNumber = rslt.index.cityEventReportId;
                    var production = Math.floor(rslt.detail.r1production);
                    var consumption = Math.floor(rslt.detail.r1consumption);
                    var deficit = production - consumption;
                    var cityId = rslt.index.cityId;
                    var cityNumber = g_mapObject.getSlotCity(1, cityId);
                    var cityName = "";
                    for (var i = 0; i < seed.cities.length; i++) {
                        var city = seed.cities[i];
                        if (city[0] == cityId) {
                            cityName = city[1];
                            break
                        }
                    }
                    var lostTroops = [];
                    var units = rslt.detail.units;
                    for (var unitKey in units) {
                        var lost = units[unitKey];
                        var after = rslt.detail.newUnitCounts ? rslt.detail.newUnitCounts[unitKey] : "-";
                        var before = rslt.detail.oldUnitCounts ? rslt.detail.oldUnitCounts[unitKey] : "-";
                        if (lost > 0) {
                            var unitId = unitKey.substring(1);
                            var img = "img/units/unit_" + unitId + "_30_s34.jpg";
                            var unitName = unitcost["unt" + unitId][0];
                            var unit = {};
                            unit.image = img;
                            unit.name = unitName;
                            unit.before = before;
                            unit.after = after;
                            unit.lost = lost;
                            lostTroops.push(unit)
                        }
                    }
                    var reportModel = {
                        date: reportDate,
                        reportNumber: reportNumber,
                        city: {
                            name: cityName,
                            number: cityNumber
                        },
                        lostTroops: lostTroops,
                        food: {
                            produced: production,
                            consumed: consumption,
                            deficit: deficit
                        }
                    };
                    var desertionReportView = new cm.DesertionReportView(reportModel);
                    var desertionReportController = new cm.DesertionReportController(reportModel, desertionReportView);
                    var modalMessgaList = $("modal_msg_list");
                    modalMessgaList.innerHTML = "";
                    modalMessgaList.appendChild(desertionReportView.getHTMLElement());
                    seed.newReportCount = parseInt(seed.newReportCount) - 1;
                    messages_notify_bug()
                }
            },
            onFailure: function () {}
        })
    } else {
        var params = Object.clone(g_ajaxparams);
        params.rid = reportid;
        new Ajax.Request(g_ajaxpath + "ajax/fetchCityEventReport.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (message) {
                var rslt = eval("(" + message.responseText + ")");
                $("modal_msg_list_pagination").hide();
                if (rslt.ok) {
                    var msghtml = new Array();
                    msghtml.push("<div class='reportdetail clearfix'>");
                    msghtml.push("<div class='side'><div class='scoutttl'>" + g_js_strings.modal_messages_viewdisasterreports.rewardmsg.replace("%1$s", rslt.detail.battleTimestamp) + "</div></div>");
                    msghtml.push("<div class='reporttimestamp'>" + rslt.detail.reportTimestamp + "</div>");
                    msghtml.push("<div class='reporthelp'>" + g_js_strings.modal_messages_viewdisasterreports.helpedmsg_1.replace("%1$s", rslt.detail.numFriends) + "</div>");
                    msghtml.push("</div>");
                    msghtml.push("<div class='reportdetail clearfix'><div class='side leftside'>");
                    msghtml.push("<table class='trttl' cellspacing='0' cellpadding='0'>");
                    msghtml.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.troops + "</td><td>" + g_js_strings.modal_messages_viewdisasterreports.troopsrecovered + "</td></tr></thead>");
                    msghtml.push("<tbody>");
                    var units = Object.keys(rslt.detail.units);
                    if (rslt.detail.units.length != 0) {
                        for (var i = 0; i < units.length; i++) {
                            var uid = units[i].split("u")[1];
                            msghtml.push("<tr>");
                            msghtml.push("<td><img src='" + stimgUrl + "img/units/unit_" + uid + "_30_s34.jpg'/></td>");
                            msghtml.push("<td class='trnm'>" + unitcost["unt" + uid][0] + "</td>");
                            msghtml.push("<td>" + rslt.detail.units[units[i]] + "</td>");
                            msghtml.push("</tr>")
                        }
                    }
                    msghtml.push("</tbody></table>");
                    msghtml.push("</div></div>");
                    msghtml.push('<div class="reportdetail"><div class="lootttl">' + g_js_strings.commonstr.loot + '</div><div class="loot clearfix"><div class="item"><img src="' + stimgUrl + '/img/gold_30.png"><b>' + resourceinfo[0] + ":</b> " + rslt.detail.resources.r0 + '</div><div class="item"><img src="' + stimgUrl + '/img/food_30.png"><b>' + resourceinfo[1] + ":</b> " + rslt.detail.resources.r1 + '</div><div class="item"><img src="' + stimgUrl + '/img/wood_30.png"><b>' + resourceinfo[2] + ":</b> " + rslt.detail.resources.r2 + '</div><div class="item"><img src="' + stimgUrl + '/img/stone_30.png"><b>' + resourceinfo[3] + ":</b> " + rslt.detail.resources.r3 + '</div><div class="item"><img src="' + stimgUrl + '/img/iron_30.png"><b>' + resourceinfo[4] + ":</b> " + rslt.detail.resources.r4 + "</div></div></div>");
                    msghtml.push("<div class='reportdetail clearfix' style='padding-top:10px;'><a class='button20' onclick='modal_messages_viewreports(" + pageno + ");return false;'><span>" + g_js_strings.commonstr.back + "</span></a></div>");
                    $("modal_msg_list").innerHTML = msghtml.join("")
                } else {}
            },
            onFailure: function () {}
        })
    }
}

function modal_messages_viewreports(a) {
    Messages.listReports(a)
}

function modal_share_victory(c, f, d, h, a, j, b, i, k, g) {
    var e = new Array();
    e.push(["REPLACE_TiLeNaMe", c]);
    e.push(["REPLACE_TiLeLeVeL", f]);
    e.push(["REPLACE_ReSoUrCES", addCommas(d)]);
    e.push(["REPLACE_mArCh_RePortiD", k]);
    e.push(["REPLACE_sIdE", g]);
    e.push(["REPLACE_DeFeNdErNaMe", h]);
    e.push(["REPLACE_AtTaCkErNaMe", a]);
    if (j == "F") {
        j = g_js_strings.commonstr.lady
    } else {
        j = g_js_strings.commonstr.lord
    }
    if (b == "F") {
        b = g_js_strings.commonstr.lady
    } else {
        b = g_js_strings.commonstr.lord
    }
    e.push(["REPLACE_DeFeNdErGeNdEr", j]);
    e.push(["REPLACE_AtTaCkErGeNdEr", b]);
    if (parseInt(g) == 0) {} else {}
    switch (i) {
    case 110:
        common_postToProfile("110", Object.cloneFeed(template_data_110), Object.cloneFeed(actionlink_data_110), continuation_110, e);
        break;
    case 111:
        common_postToProfile("111", Object.cloneFeed(template_data_111), Object.cloneFeed(actionlink_data_111), continuation_111, e);
        break;
    case 112:
        common_postToProfile("112", Object.cloneFeed(template_data_112), Object.cloneFeed(actionlink_data_112), continuation_112, e);
        break;
    case 113:
        common_postToProfile("113", Object.cloneFeed(template_data_113), Object.cloneFeed(actionlink_data_113), continuation_113, e);
        break;
    case 114:
        common_postToProfile("114", Object.cloneFeed(template_data_114), Object.cloneFeed(actionlink_data_114), continuation_114, e);
        break;
    case 115:
        common_postToProfile("115", Object.cloneFeed(template_data_115), Object.cloneFeed(actionlink_data_115), continuation_115, e);
        break;
    case 116:
        common_postToProfile("116", Object.cloneFeed(template_data_116), Object.cloneFeed(actionlink_data_116), continuation_116, e);
        break;
    case 117:
        common_postToProfile("117", Object.cloneFeed(template_data_117), Object.cloneFeed(actionlink_data_117), continuation_117, e);
        break
    }
}

function confirmReportsDeleteAll() {
    var a = [];
    a.push("<div style='padding: 50px; font-size: 16px;'>Are you sure you want to delete all messages in this folder?<div style='padding-top:20px'>");
    a.push("<a  onclick='Messages.deleteCheckedReports(\"deleteAll\"); Modal.hideModal();' class='button20'><span>" + g_js_strings.commonstr.yes + "</span></a>");
    a.push("<a  onclick='Modal.hideModal();' class='buttonDown20'><span>" + g_js_strings.commonstr.no + "</span></a></div></div>");
    Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.deleteall, a.join(""))
}

function modal_messages_reports_chkdel(a) {
    Messages.deleteCheckedReports(a)
}

function confirmTradeReportsDeleteAll() {
    var a = [];
    a.push("<div style='padding: 50px; font-size: 16px;'>Are you sure you want to delete all messages in this folder?<div style='padding-top:20px'>");
    a.push("<a  onclick='modal_messages_tradereports_chkdel(\"deleteAll\"); Modal.hideModal();' class='button20'><span>" + g_js_strings.commonstr.yes + "</span></a>");
    a.push("<a  onclick='Modal.hideModal();' class='buttonDown20'><span>" + g_js_strings.commonstr.no + "</span></a></div></div>");
    Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.deleteall, a.join(""))
}

function modal_messages_tradereports_chkdel(rType) {
    var chks = $("modal_msg_reports_tablediv").getElementsByTagName("input");
    var rids = new Array();
    var unreadcount = 0;
    for (var i = 0; i < chks.length; i++) {
        if (chks[i].checked) {
            var attrs = chks[i].getAttribute("name");
            rids.push(attrs);
            if ($("viewreports_tradereport_" + attrs) && $("viewreports_tradereport_" + attrs).hasClassName("unread")) {
                unreadcount++
            }
        }
    }
    if (rids.length == 0 && rType != "deleteAll") {
        return false
    }
    var params = Object.clone(g_ajaxparams);
    if (rType) {
        params.requestType = rType
    }
    var withoutFirstComma = rids.join(",");
    if (withoutFirstComma[0] == ",") {
        withoutFirstComma = withoutFirstComma.substring(1)
    }
    params.rids = withoutFirstComma;
    new Ajax.Request(g_ajaxpath + "ajax/deleteCheckedTradeReports.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                if (unreadcount > 0) {
                    seed.newTradeReports = parseInt(seed.newTradeReports) - unreadcount;
                    if (seed.newTradeReports < 0) {
                        seed.newTradeReports = 0
                    }
                    messages_notify_bug()
                }
                modal_messages_viewtrades();
                cm.NotificationView.exe()
            }
        },
        onFailure: function () {}
    })
}

function modal_messages_reports_chkread() {
    Messages.markCheckedReportsAsRead()
}

function modal_messages_reports_chk(c) {
    var b = $("modal_msg_reports_tablediv").getElementsByTagName("input");
    var a = true;
    if (c == 2) {
        a = false
    }
    for (var d = 0; d < b.length; d++) {
        b[d].checked = a
    }
}

function getReportDisplay() {
    var q = arguments[0];
    var a = arguments[1];
    var b = q[0];
    var t = q[1];
    var u = q[2];
    var n = q[3];
    var I = q[4];
    var l = q[5];
    var A = q[6];
    var y = q[7];
    var g = q[8];
    var F = q[9];
    var p = q[10];
    var B = q[11];
    var k = q[12];
    var z = q[13];
    var J = q[14];
    var w = q[15];
    var G = formatDateByUnixTime(k);
    var j = g_js_strings.modal_messages_viewreports_view;
    var K = new Array();
    var D = function (i, L) {
            if (typeof i === "undefined" || i === "" || typeof L === "undefined" || L <= 0) {
                return ""
            }
            var M = Math.floor(+L * 100);
            return "<br/>" + i + ": " + M + "%"
        };
    K.push("<div class='reportdetail clearfix'>");
    K.push("<div class='side'>");
    K.push("<div class='scoutttl'>");
    if (parseInt(F) == 3) {
        if (parseInt(t) == 1) {
            K.push(j.scoutingat + " ")
        } else {
            K.push(j.antiscoutingat + " ")
        }
    } else {
        if (parseInt(F) == 1) {
            K.push(j.transpto + " ")
        } else {
            K.push(j.battleat + " ")
        }
    }
    if (parseInt(u) != 51) {
        K.push(g_mapObject.types[parseInt(u)].capitalize());
        K.push(" " + g_js_strings.commonstr.lv + n)
    } else {
        if (parseInt(I) == 0) {
            K.push(g_js_strings.commonstr.barbariancamp);
            K.push(" " + g_js_strings.commonstr.lv + n)
        }
    }
    var h = new cm.utils.CoordinateLink(p, B);
    h.setClassName("coordinateLink");
    K.push(h.getHTML());
    if (F != 1) {
        if (parseInt(a.conquered) == 1) {
            K.push(" - <b class='conq'>" + g_js_strings.commonstr.conquered + "</b>")
        }
    }
    K.push("</div>");
    K.push("</div>");
    K.push("<div class='reporttimestamp'>" + G + "</div>");
    K.push("<div class='reportid'>" + j.reportno + " " + b + " </div>");
    K.push("</div>");
    if (F != 1) {
        K.push("<div class='reportdetail clearfix'>");
        if (parseInt(a.conquered) == 0 && parseInt(a.winner) == 1 && parseInt(u) != 51) {
            K.push("<b class='conq'>" + j.cannotbeconq + "</b>")
        } else {
            if (a.conquered == false && parseInt(a.winner) == 1 && parseInt(u) != 51) {
                K.push("<b class='conq'>" + j.cannotbeconq + "</b>")
            }
        }
        K.push("</div>");
        if (parseInt(F) == 3) {
            if (parseInt(a.score) > 0) {
                K.push("<div class='reportdetail'>");
                K.push("<div class='side clearfix'>");
                K.push("<div class='scoutttl'>" + j.scoutrpt + "</div>");
                K.push("<div class='reporttablewrap'>");
                K.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                K.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.nametx + "</td><td class='startcol'>" + g_js_strings.commonstr.count + "</td></tr></thead><tbody>");
                if (a.unts && !Object.isArray(a.unts)) {
                    var c = Object.keys(a.unts);
                    for (var E = 0; E < c.length; E++) {
                        K.push("<tr><td><img src='");
                        K.push(stimgUrl);
                        K.push("img/units/unit_");
                        K.push(c[E].split("u")[1]);
                        K.push("_30_s34.jpg'/></td><td class='trnm'>");
                        K.push(unitcost["unt" + c[E].split("u")[1]][0]);
                        K.push("</td><td class='startcol'>");
                        K.push(a.unts[c[E]]);
                        K.push("</td></tr>")
                    }
                } else {
                    K.push("<tr><td colspan='3'>" + j.nounits + "</td></tr>")
                }
                K.push("</tbody></table>");
                K.push("</div>");
                if (a.lstlgn) {
                    K.push("<div class='reporttablewrap'>");
                    K.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                    K.push("<thead><tr><td colspan='2'>" + j.lastlogin + "</td></tr></thead><tbody>");
                    K.push("<tr><td colspan='2'>");
                    K.push(new Date(a.lstlgn * 1000).toGMTString());
                    K.push("</td></tr>");
                    K.push("</tbody></table>");
                    K.push("</div>")
                }
                if (a.knght && a.knght.cbt) {
                    K.push("<div class='reporttablewrap'>");
                    K.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                    K.push("<thead><tr><td colspan='2'>" + j.knightcomabtlv + "</td></tr></thead><tbody>");
                    K.push("<tr><td colspan='2'>");
                    K.push(a.knght.cbt);
                    K.push("</td></tr>");
                    K.push("</tbody></table>");
                    K.push("</div>")
                }
                if (a.frt && !Object.isArray(a.frt)) {
                    K.push("<div class='reporttablewrap'>");
                    K.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                    K.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.nametx + "</td><td class='startcol'>" + g_js_strings.commonstr.count + "</td></tr></thead><tbody>");
                    var c = Object.keys(a.frt);
                    for (var E = 0; E < c.length; E++) {
                        K.push("<tr><td><img src='");
                        K.push(stimgUrl);
                        K.push("img/units/unit_");
                        K.push(c[E].split("f")[1]);
                        K.push("_30.png'/></td><td class='trnm'>");
                        K.push(fortcost["frt" + c[E].split("f")[1]][0]);
                        K.push("</td><td class='startcol'>");
                        K.push(a.frt[c[E]]);
                        K.push("</td></tr>")
                    }
                    K.push("</tbody></table>");
                    K.push("</div>")
                }
                if (a.blds && !Object.isArray(a.blds)) {
                    K.push("<div class='reporttablewrap'>");
                    K.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                    K.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.building + "</td><td class='startcol'>" + g_js_strings.commonstr.levels + "</td></tr></thead><tbody>");
                    var c = Object.keys(a.blds);
                    for (var E = 0; E < c.length; E++) {
                        var r = parseInt(c[E].split("b")[1]);
                        K.push("<tr><td>&nbsp;</td><td class='trnm'>");
                        K.push(buildingcost["bdg" + r][0]);
                        K.push("</td><td class='startcol'>");
                        K.push(a.blds[c[E]].join(", "));
                        K.push("</td></tr>")
                    }
                    K.push("</tbody></table>");
                    K.push("</div>")
                }
                if (a.rsc && !Object.isArray(a.rsc)) {
                    K.push("<div class='reporttablewrap'>");
                    K.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                    K.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.resource + "</td><td class='startcol'>" + g_js_strings.commonstr.quantity + "</td></tr></thead><tbody>");
                    var c = Object.keys(a.rsc);
                    for (var E = 0; E < c.length; E++) {
                        var v = parseInt(c[E].split("r")[1]);
                        K.push("<tr><td><img src='");
                        K.push(stimgUrl);
                        K.push("img/");
                        if (v == 1) {
                            K.push("food")
                        } else {
                            if (v == 2) {
                                K.push("wood")
                            } else {
                                if (v == 3) {
                                    K.push("stone")
                                } else {
                                    if (v == 4) {
                                        K.push("iron")
                                    } else {
                                        if (v == 5) {
                                            K.push("aetherstone")
                                        }
                                    }
                                }
                            }
                        }
                        K.push("_30.png'/></td><td class='trnm'>");
                        if (E === 5) {
                            K.push(resourceinfo["7"])
                        } else {
                            K.push(resourceinfo["rec" + v])
                        }
                        K.push("</td><td class='startcol'>");
                        K.push(addCommas(parseInt(a.rsc[c[E]])));
                        K.push("</td></tr>")
                    }
                    K.push("</tbody></table>");
                    K.push("</div>")
                }
                if (a.tch && !Object.isArray(a.tch)) {
                    K.push("<div class='reporttablewrap'>");
                    K.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                    K.push("<thead><tr><td class='trnm'>" + g_js_strings.commonstr.research + "</td><td class='startcol'>" + g_js_strings.commonstr.levels + "</td></tr></thead><tbody>");
                    var c = Object.keys(a.tch);
                    for (var E = 0; E < c.length; E++) {
                        K.push("<tr><td class='trnm'>");
                        K.push(techcost["tch" + c[E].split("t")[1]][0]);
                        K.push("</td><td class='startcol'>");
                        K.push(a.tch[c[E]]);
                        K.push("</td></tr>")
                    }
                    K.push("</tbody></table>");
                    K.push("</div>")
                }
                K.push("</div></div>")
            } else {
                if (parseInt(t) == 1) {
                    K.push("<div class='reportdetail clearfix'><div class='side'><div class='scoutttl'>" + j.scoutfail + "</div></div></div>")
                }
            }
        }
        if (Object.keys(a.fght.s0).length == 0 && Object.keys(a.fght.s1) == 0) {
            K.push("<div class='reportdetail clearfix' style='display:none;'>")
        } else {
            K.push("<div class='reportttl'>" + j.battlerpt);
            if ((parseInt(a.winner) == 1 && parseInt(t) == 1) || (parseInt(a.winner) == 0 && parseInt(t) == 0) || (parseInt(a.winner) == 2 && parseInt(t) == 1)) {
                K.push(" - <b class='victory'>" + g_js_strings.commonstr.victory + "</b>")
            } else {
                K.push(" - <b class='defeat'>" + g_js_strings.commonstr.defeat + "</b>")
            }
            K.push("</div>");
            K.push("<div class='nobreach'>");
            if (parseInt(a.winner) == 1 && typeof (a.wall) != "undefined") {
                if (parseInt(u) == 51) {
                    K.push(j.wallbreach + " ")
                } else {
                    K.push(j.securedwilderness + " ")
                }
            }
            if (parseInt(a.winner) == 2) {
                if (parseInt(u) == 51) {
                    K.push(j.nowallbreach + " ")
                } else {
                    K.push(j.nosecuredwilderness + " ");
                    if (typeof (a.wall) != "undefined") {
                        K.push(a.wall);
                        K.push(j.wildernesspercsec)
                    }
                }
            }
            if (parseInt(a.winner) == 1 && parseInt(t) == 0 && parseInt(u) == 51) {
                if (typeof (a.wall) != "undefined") {
                    K.push(a.wall);
                    K.push(j.percdamage)
                }
                if (parseInt(a.wall) == 100) {
                    K.push(" " + j.pendingcancel)
                }
            }
            K.push("</div>");
            K.push("<div class='reportdetail clearfix'>")
        }
        K.push("<div class='side leftside'>");
        K.push("<div class='sidettl'>" + g_js_strings.commonstr.attackers + " <span class='who'>(");
        if (y != "") {
            K.push(unescape(y));
            K.push(")");
            if (J != undefined || J != null) {
                K.push(" - <b>");
                var h = new cm.utils.CoordinateLink(J, w);
                h.setClassName("coordinateLink");
                K.push(h.getHTML());
                K.push("</b>")
            }
            K.push("</span>")
        } else {
            K.push(g_js_strings.commonstr.enemy);
            K.push(")</span>")
        }
        if ((parseInt(a.winner) == 1) || (parseInt(a.winner) == 2)) {
            K.push("<b class='winner'>" + g_js_strings.commonstr.winner + "</b>")
        }
        if (parseInt(F) != 3 && typeof a.s1KCombatLv !== "undefined") {
            K.push("<br/>" + j.knightskills + ": " + a.s1KCombatLv);
            K.push(D(j.attackboosted, a.s1atkBoost));
            K.push(D(j.defenseboosted, a.s1defBoost));
            K.push(D(j.guardian_lifeboosted, a.s1guardianDefBoost));
            K.push(D(j.guardian_attackboosted, a.s1guardianAtkBoost));
            K.push(D(j.guardian_marchboosted, a.s1guardianMarchBoost))
        }
        K.push("</div>");
        K.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
        K.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.troops + "</td><td class='startcol'>" + g_js_strings.commonstr.fought + "</td><td class='endcol'>" + g_js_strings.commonstr.survived + "</td></tr></thead><tbody>");
        var c = Object.keys(a.fght.s1);
        for (var E = 0; E < c.length; E++) {
            var H = parseInt(a.fght.s1[c[E]][0]);
            var m = parseInt(a.fght.s1[c[E]][1]);
            K.push("<tr><td><img src='");
            K.push(stimgUrl);
            K.push("img/units/unit_");
            if (c[E].split("u")[0] == "") {
                K.push(c[E].split("u")[1]);
                K.push("_30_s34.jpg'/></td><td class='trnm'>");
                K.push(unitcost["unt" + c[E].split("u")[1]][0])
            } else {
                K.push(c[E].split("f")[1]);
                K.push("_30.png'/></td><td class='trnm'>");
                K.push(fortcost["frt" + c[E].split("f")[1]][0])
            }
            K.push("</td><td class='startcol'>");
            K.push(H);
            K.push("</td><td class='endcol");
            if (m < H) {
                K.push(" loseunt")
            }
            K.push("'>");
            K.push(m);
            K.push("</td></tr>")
        }
        K.push("</tbody></table>");
        K.push("</div>");
        K.push("<div class='side rightside'>");
        K.push("<div class='sidettl'>" + g_js_strings.commonstr.defenders + " <span class='who'>(");
        K.push(unescape(l));
        K.push(")</span>");
        if (parseInt(a.winner) == 0) {
            K.push("<b class='winner'>" + g_js_strings.commonstr.winner + "</b>")
        }
        if (parseInt(F) != 3 && typeof a.s0KCombatLv !== "undefined") {
            K.push("<br/>" + j.knightskills + ": " + a.s0KCombatLv);
            K.push(D(j.attackboosted, a.s0atkBoost));
            K.push(D(j.defenseboosted, a.s0defBoost));
            K.push(D(j.guardian_lifeboosted, a.s0guardianDefBoost));
            K.push(D(j.guardian_attackboosted, a.s0guardianAtkBoost));
            K.push(D(j.guardian_marchboosted, a.s0guardianMarchBoost))
        }
        K.push("</div>");
        var c = Object.keys(a.fght.s0);
        if (a.overwhelmed) {
            K.push(j.overwhelmedinbattle);
            K.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
            K.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.troops + "</td><td class='endcol'>" + g_js_strings.commonstr.killed + "</td></tr></thead><tbody>");
            for (var E = 0; E < c.length; E++) {
                var H = parseInt(a.fght.s0[c[E]][0]);
                var m = parseInt(a.fght.s0[c[E]][1]);
                K.push("<tr><td>");
                var d, e, s, o;
                if (c[E].charAt(0) == "u") {
                    d = c[E].split("u")[1] || c[E];
                    e = stimgUrl + "img/units/unit_" + d + "_30_s34.jpg";
                    s = a.fght.s0["u" + d] || a.fght.s0[d];
                    o = unitcost["unt" + d][0]
                } else {
                    if (c[E].charAt(0) == "m") {
                        d = c[E].split("m")[1] || c[E];
                        e = stimgUrl + "img/units/unit_" + d + "_30.jpg";
                        s = a.fght.s0["m" + d] || a.fght.s0[d];
                        o = g_js_strings.monsterUnitsNames["m" + d]
                    } else {
                        if (c[E].charAt(0) == "f") {
                            d = c[E].split("f")[1] || c[E];
                            e = stimgUrl + "img/units/unit_" + d + "_30.jpg";
                            s = a.fght.s0["f" + d] || a.fght.s0[d];
                            o = fortcost["frt" + d][0]
                        }
                    }
                }
                K.push("<img src='" + e + "'/></td>");
                K.push("<td class='trnm'>");
                K.push(o);
                K.push("</td><td class='endcol");
                K.push(" loseunt");
                K.push("'>");
                K.push(H - m);
                K.push("</td></tr>")
            }
            K.push("</tbody></table>")
        } else {
            if (c.length > 0) {
                K.push("<table cellpadding='0' cellspacing='0' class='trttl'>");
                K.push("<thead><tr><td>&nbsp;</td><td class='trnm'>" + g_js_strings.commonstr.troops + "</td><td class='startcol'>" + g_js_strings.commonstr.fought + "</td><td class='endcol'>" + g_js_strings.commonstr.survived + "</td></tr></thead><tbody>");
                for (var E = 0; E < c.length; E++) {
                    var H = parseInt(a.fght.s0[c[E]][0]);
                    var m = parseInt(a.fght.s0[c[E]][1]);
                    K.push("<tr>");
                    var d, e, s, o;
                    if (c[E].charAt(0) == "u") {
                        d = c[E].split("u")[1] || c[E];
                        e = stimgUrl + "img/units/unit_" + d + "_30_s34.jpg";
                        s = a.fght.s0["u" + d] || a.fght.s0[d];
                        o = unitcost["unt" + d][0]
                    } else {
                        if (c[E].charAt(0) == "m") {
                            d = c[E].split("m")[1] || c[E];
                            e = stimgUrl + "img/units/unit_" + d + "_30.jpg";
                            s = a.fght.s0["m" + d] || a.fght.s0[d];
                            o = g_js_strings.monsterUnitsNames["m" + d]
                        } else {
                            if (c[E].charAt(0) == "f") {
                                d = c[E].split("f")[1] || c[E];
                                e = stimgUrl + "img/units/unit_" + d + "_30.jpg";
                                s = a.fght.s0["f" + d] || a.fght.s0[d];
                                o = fortcost["frt" + d][0]
                            }
                        }
                    }
                    K.push("<td><img src='" + e + "'/></td>");
                    K.push("<td class='trnm'>");
                    K.push(o);
                    K.push("</td>");
                    K.push("<td class='startcol'>");
                    K.push(H);
                    K.push("</td><td class='endcol");
                    if (m < H) {
                        K.push(" loseunt")
                    }
                    K.push("'>");
                    K.push(m);
                    K.push("</td></tr>")
                }
                K.push("</tbody></table>")
            }
        }
        if (c.length == 0) {
            K.push(j.notroopsdef)
        }
        K.push("</div>");
        K.push("</div>");
        if (a.loot && (parseInt(a.loot[0]) > 0 || parseInt(a.loot[1]) > 0 || parseInt(a.loot[2]) > 0 || parseInt(a.loot[3]) > 0 || parseInt(a.loot[4]) > 0 || !Object.isArray(a.loot[5]))) {
            K.push("<div class='reportdetail'><div class='lootttl'>");
            if (parseInt(t) == 1) {
                K.push(g_js_strings.commonstr.loot)
            } else {
                if (parseInt(t) == 0) {
                    K.push("<span style='color:#A02932;'>" + g_js_strings.commonstr.plundered + "</span>")
                }
            }
            K.push("</div>");
            K.push("<div class='loot clearfix'>");
            K.push("<div class='item'><img src='");
            K.push(stimgUrl);
            var x = 0;
            if (parseInt(t) == 1) {
                x += a.loot[0];
                K.push("img/gold_30.png'/><b>" + resourceinfo.rec0 + ":</b> " + a.loot[0] + "</div>")
            } else {
                if (parseInt(a.loot[0]) > 0 && parseInt(t) == 0) {
                    K.push("img/gold_30.png'/><b>" + resourceinfo.rec0 + ":</b><span style='color:#A02932;'> -" + a.loot[0] + "</span></div>")
                } else {
                    if (parseInt(a.loot[0]) == 0 && parseInt(t) == 0) {
                        K.push("img/gold_30.png'/><b>" + resourceinfo.rec0 + ":</b><span style='color:#A02932;'> " + a.loot[0] + "</span></div>")
                    }
                }
            }
            var f;
            for (var E = 1; E <= 5; E++) {
                K.push("<div class='item'><img src='");
                K.push(stimgUrl);
                K.push("img/");
                switch (E) {
                case 1:
                    K.push("food");
                    f = (a.loot[1] > 0) ? 1 * a.loot[1] : 0;
                    break;
                case 2:
                    K.push("wood");
                    f = (a.loot[2] > 0) ? 1 * a.loot[2] : 0;
                    break;
                case 3:
                    K.push("stone");
                    f = (a.loot[3] > 0) ? 1 * a.loot[3] : 0;
                    break;
                case 4:
                    K.push("iron");
                    f = (a.loot[4] > 0) ? 1 * a.loot[4] : 0;
                    break;
                case 5:
                    K.push("aetherstone");
                    f = (a.loot[6] > 0) ? 1 * a.loot[6] : 0;
                    break
                }
                K.push("_30.png'/><b>");
                if (E === 5) {
                    K.push(resourceinfo["7"])
                } else {
                    K.push(resourceinfo["rec" + E])
                }
                if (parseInt(t) == 1) {
                    x += a.loot[E];
                    K.push(":</b> " + f + "</div>")
                } else {
                    K.push(":</b><span style='color:#A02932;'>" + f + "</span></div>")
                }
            }
            K.push("</div>");
            if (!Object.isArray(a.loot[5]) && Object.keys(a.loot[5]).length > 0) {
                var C = Object.keys(a.loot[5]);
                K.push("<div class='loot crests clearfix'>");
                for (var E = 0; E < C.length; E++) {
                    K.push("<div class='item'><img style='width:30px;' src='");
                    K.push(stimgUrl);
                    K.push("img/items/70/");
                    K.push(C[E]);
                    K.push(".png'/><b>");
                    K.push(itemlist["i" + C[E]].name);
                    K.push(": </b> ");
                    K.push(a.loot[5][C[E]]);
                    K.push("</div>")
                }
                K.push("</div>")
            }
            K.push("</div>")
        }
        if (parseInt(F) == 3 && parseInt(seed.tech.tch6) < 11) {
            K.push("<div class='reportdetail clearfix'>" + j.eagleeyes + "</div>")
        }
        K.push("</div>")
    } else {
        K.push("<div class='reportdetail'><div class='loot clearfix'>");
        K.push("<div class='item'><img src='");
        K.push(stimgUrl);
        K.push("img/gold_30.png'/><b>" + resourceinfo.rec0 + ":</b><span style='color:#77823C;'> " + a.gold + "</span></div>");
        for (var E = 1; E <= 5; E++) {
            K.push("<div class='item'><img src='");
            K.push(stimgUrl);
            K.push("img/");
            switch (E) {
            case 1:
                K.push("food");
                break;
            case 2:
                K.push("wood");
                break;
            case 3:
                K.push("stone");
                break;
            case 4:
                K.push("iron");
                break;
            case 5:
                K.push("aetherstone");
                break
            }
            K.push("_30.png'/><b>");
            if (E == 5) {
                K.push(resourceinfo["7"])
            } else {
                K.push(resourceinfo[E])
            }
            K.push(":</b><span style='color:#77823C;'> " + a["resource" + E] + "</span></div>")
        }
        K.push("</div></div>")
    }
    return K.join("")
}

function modal_messages_viewreports_view(n, a, o, e, m, f, l, i, g, q, j, k, b, r, c, d, h, p) {
    Messages.viewMarchReport(n, a, o, e, m, f, l, i, g, q, j, k, b, r, c, d, h, p)
}

function sortMessages(c) {
    var b = [];
    for (var a in c.message) {
        var d = parseInt(a);
        if (!isNaN(d)) {
            b[d] = c.message[a];
            b[d].msgIndex = a
        }
    }
    c.message = b.reverse()
}
var currentBoxType = "";

function modal_messages_listshow(boxType, pageNo) {
    jQuery("#modal_msg_view").hide();
    jQuery("#modal_msg_write").hide();
    jQuery("#modal_msg_list").show();
    jQuery("#modal_msg_list_actions").show();
    jQuery("#modal_msg_links").show();
    jQuery(".moreActionsSelect").show();
    jQuery("#modal_msg_list_actions").hide();
    if (boxType == "inbox") {} else {
        jQuery(".moreActionsSelect").hide()
    }
    var params = Object.clone(g_ajaxparams);
    params.requestType = "GET_MESSAGE_HEADERS_FOR_USER_INBOX";
    params.boxType = boxType;
    params.pageNo = (pageNo || 1);
    currentBoxType = boxType;
    new Ajax.Request(g_ajaxpath + "ajax/getEmail.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                var msghtml = new Array();
                var colHeading = (boxType == "outbox") ? g_js_strings.commonstr.totx : g_js_strings.commonstr.from;
                msghtml.push("<table cellpadding='0' cellspacing='0' border='0' class='msgviewtable' id='tbl_messages'>");
                msghtml.push("<thead><tr><td class='chkcol'><input type='checkbox'  master_check='true'  class='checkAll' /></td><td class='dtcol'>" + g_js_strings.commonstr.date + "</td><td class='nmcol'>" + colHeading + "</td><td class='subjcol'>" + g_js_strings.commonstr.subject + "</td></tr></thead><tbody>");
                var i = 0;
                for (msgId in rslt.message) {
                    if (!isNaN(msgId)) {
                        var onclickaction = [];
                        onclickaction.push("modal_messages_view(" + msgId + ',"' + boxType + '",');
                        if (parseInt(rslt.message[msgId].messageRead) == 1) {
                            onclickaction.push(0)
                        } else {
                            onclickaction.push(1)
                        }
                        onclickaction.push(");");
                        msghtml.push("<tr id='modal_msg_list_" + msgId + "' class='");
                        if (parseInt(rslt.message[msgId].messageRead) == 1) {
                            msghtml.push("")
                        } else {
                            msghtml.push("unread")
                        }
                        if (i++ % 2 == 0) {
                            msghtml.push(" stripe")
                        }
                        msghtml.push("'>");
                        msghtml.push("<td class='chkcol'><input type='checkbox' id='inbox_chk_" + msgId + "'/></td>");
                        msghtml.push("<td class='dtcol' onclick='" + onclickaction.join("") + "' ><div>" + rslt.message[msgId].dateSent + "</div></td>");
                        msghtml.push("<td class='nmcol'><div><a href='javascript:void(0)' onclick='getInfoForAnUser(" + (boxType === "outbox" ? rslt.message[msgId].toUserId : rslt.message[msgId].fromUserId) + ")'>" + rslt.message[msgId].displayName + "</a></div></td>");
                        msghtml.push("<td class='subjcol' onclick='" + onclickaction.join("") + "' ><div><a onclick='");
                        var subject = g_js_strings.modal_messages_listshow.nosubject;
                        if (rslt.message[msgId].subject && rslt.message[msgId].subject.length > 0) {
                            subject = rslt.message[msgId].subject
                        }
                        msghtml.push("return false'>" + subject + "</a></div></td>");
                        msghtml.push("</tr>")
                    }
                }
                msghtml.push("</tbody></table>");
                $("modal_msg_list").innerHTML = msghtml.join("");
                if (rslt.messageCount == 0) {
                    $("modal_msg_list").innerHTML = "<div style='font-size:17px;margin-left:30px;margin-top:20px'>" + g_js_strings.modal_messages_listshow.nomsg + "</div>";
                    $("modal_msg_list_actions").hide();
                    $("modal_msg_links").hide();
                    if ($("pagination_indexOnly")) {
                        ($("pagination_indexOnly")).remove()
                    }
                }
                var pageCount = parseInt(rslt.noOfPages || rslt.totalPages);
                pageCount = isNaN(pageCount) || pageCount < 0 ? 0 : pageCount;
                pageNavigatorController.onClick = paginationWrapperForListShow;
                pageNavigatorModel.setPageCount(pageCount);
                pageNo = pageNo || 1;
                pageNavigatorModel.gotoPage(pageNo)
            }
            cm.messageController.bind()
        },
        onFailure: function () {}
    });
    var msglis = new Array();
    msglis.push("<table cellpadding='0' cellspacing='0' border='1'>");
    msglis.push("<thead><tr><td></td><td>" + g_js_strings.commonstr.date + "</td><td>" + g_js_strings.commonstr.from + "</td><td>" + g_js_strings.commonstr.subject + "</td></tr></thead>");
    msglis.push("<tbody>");
    msglis.push("</tbody>");
    msglis.push("</table>");
    jQuery("#modal_msg_list").html(msglis.join(""))
}

function paginationWrapperForListShow(a) {
    modal_messages_listshow(currentBoxType, a)
}

function modal_messages_view(msgid, boxType, unread) {
    var tpgs = pageNavigatorModel.getPageCount();
    var currpg = pageNavigatorModel.getCurrentPage();
    $("modal_msg_write").hide();
    $("modal_msg_list").hide();
    $("modal_msg_list_actions").hide();
    $("modal_msg_links").hide();
    $("modal_msg_list_pagination").hide();
    if (boxType == "inbox") {
        $("modal_msg_view_actions").show()
    } else {
        $("modal_msg_view_actions").hide()
    }
    $("modal_msg_view").setAttribute("name", msgid);
    load_start();
    var params = Object.clone(g_ajaxparams);
    params.messageId = msgid;
    params.requestType = "GET_MESSAGE_FOR_ID";
    new Ajax.Request(g_ajaxpath + "ajax/getEmail.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                load_stop();
                if (unread == 1) {
                    seed.newMailCount = parseInt(seed.newMailCount) - 1;
                    messages_notify_bug()
                }
                var listinfo = $("modal_msg_list_" + msgid).getElementsByTagName("td");
                var backButtonHtml = "<div class='bottomBar'><a  class='buttonDown20' onclick='modal_messages_inbox( false );loadPage_pagination(\"modal_msg_list_pagination\",\"" + currpg + '","paginationWrapperForListShow",' + tpgs + ");return false;'><span>" + g_js_strings.commonstr.back + "</span></a><a class='inlineButton20Red' onclick=\"messages_action('delete', 'modal_msg_view' );\" ><span>" + g_js_strings.commonstr.deletetx + "</span></a><div class='rightPanel'><a class='buttonDown20 ' onclick='cm.messageController.forward();' ><span>" + g_js_strings.commonstr.forward + "</span></a><a class='button20 ' onclick='modal_messages_reply();' ><span>" + g_js_strings.commonstr.reply + "</span></a></div></div>";
                $("modal_msg_view_to").innerHTML = "Me";
                $("modal_msg_view_from").innerHTML = listinfo[2].getElementsByTagName("div")[0].innerHTML;
                $("modal_msg_view_date").innerHTML = listinfo[1].getElementsByTagName("div")[0].innerHTML;
                $("modal_msg_view_body").innerHTML = "<div class='innersubject'>" + g_js_strings.commonstr.subject + ": <span id='modal_msg_view_subj'>" + listinfo[3].getElementsByTagName("a")[0].innerHTML + "</span></div><div class='bodytext'>" + cm.formatModel.exe(cm.messageController.unescape(rslt.messageBody)) + "</div>" + backButtonHtml;
                $("modal_msg_view").show();
                jQuery(".msgTopBar").hide()
            }
        },
        onFailure: function () {}
    })
}

function messages_notify_bug() {
    cm.NotificationView.exe();
    return true
}
var g_reports_update_count = 0;
var g_reports_disaster_update_count = 0;
var g_messages_update_count = 0;

function reports_update_count() {}
cm.RedundancyManager = {
    message_count: 0,
    init_count: 0
};

function messages_update_count() {
    if (cm.RedundancyManager.message_count++ > 3) {
        return false
    }
    var params = Object.clone(g_ajaxparams);
    params.requestType = "GET_UNREAD_MESSAGES";
    new Ajax.Request(g_ajaxpath + "ajax/updateChrome.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                seed.newMailCount = parseInt(rslt.noOfUnreadMessages);
                messages_notify_bug()
            }
        },
        onFailure: function () {}
    })
}

function confirmDeleteAll(c, a) {
    var b = [];
    b.push("<div style='padding: 50px; font-size: 16px;'>Are you sure you want to delete all messages in this folder?<div style='padding-top:20px'>");
    b.push("<a  onclick='messages_action(\"" + c + '","' + a + "\")' class='button20'><span>" + g_js_strings.commonstr.yes + "</span></a>");
    b.push("<a  onclick='Modal.hideModal();' class='buttonDown20'><span>" + g_js_strings.commonstr.no + "</span></a></div></div>");
    Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.deleteall, b.join(""))
}

function messages_action(d, b) {
    var e = {};
    var a = "";
    e.requestType = "ACTION_ON_MESSAGES";
    e.selectedAction = d;
    if (b == "tbl_messages") {
        var c = getSelectedMessages("tbl_messages");
        if (c[0] == ",") {
            c = c.substring(1)
        }
        e.selectedMessageIds = c;
        if (e.selectedMessageIds == 0 && d != "deleteAll") {
            return false
        }
    } else {
        if (b == "modal_msg_view") {
            e.selectedMessageIds = $("modal_msg_view").getAttribute("name")
        }
    }
    if ($("modal_msg_tabs_inbox").hasClassName("selected")) {
        a = "inbox"
    } else {
        if ($("modal_msg_tabs_outbox").hasClassName("selected")) {
            a = "outbox"
        }
    }
    e.boxType = a;
    AjaxCall.gPostRequest("ajax/getEmail.php", e, function (f) {
        Messages.handleGetEmail(f, e, d, a);
        cm.NotificationView.exe()
    })
}

function getSelectedMessages(b) {
    var e = document.getElementById(b).getElementsByTagName("INPUT");
    var c = "";
    for (var a = 0; a < e.length; a++) {
        if (e[a].type.toUpperCase() == "CHECKBOX" && e[a].checked) {
            var d = e[a].id;
            c += d.substring(d.lastIndexOf("_") + 1) + ","
        }
    }
    if (c.length > 0) {
        c = c.substring(0, c.length - 1)
    }
    return c
}

function modal_messages_viewreports_showFeedHover(c, b, a) {
    MarchReport.showFeedHover(c, b, a)
}

function getMessageWindow(b, c, d, a) {
    c = unescape(c);
    if (d == null) {
        d = "user"
    }
    var e = new Array();
    if (!a || a == "") {
        a = "tmp_MessageModule"
    }
    e.push("<div id='" + a + "'>");
    e.push("<div id='gb_message_window'><div class='msgttl'>" + g_js_strings.getMessageWindow.sendmessage + '</div><input type="hidden" value=\'' + b + "' id='gb_message_toId' />");
    e.push("<table cellpadding='0' cellspacing='0'><tr><td>" + g_js_strings.commonstr.totx + "</td>");
    e.push("<td class='tocol'>" + c + "</td></tr>");
    e.push("<tr><td class='tocol'>" + g_js_strings.commonstr.subject + "</td>");
    e.push("<td><input type='text' id='gb_message_subject' /></td></tr>");
    e.push("<tr><td class='tocol'>" + g_js_strings.commonstr.message + "</td><td>");
    e.push('<textarea name="gb_message_content" id="gb_message_content"></textarea>');
    e.push("</td></tr>");
    e.push("<tr><td colspan='2' class='btns'><a  class='button20' onclick='sendMessageModule(\"" + a + '","' + d + "\");return false;'><span>" + g_js_strings.commonstr.send + "</span></a>");
    e.push("<a  class='buttonDown20' onclick='Modal.hideModal();return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a></td>");
    e.push("</tr></table></div></div>");
    Modal.showModal(740, 400, 10, 250, g_js_strings.modaltitles.sendmessage, e.join(""))
}

function sendMessageModule(divId, type) {
    if (type == null) {
        type = user
    }
    var params = Object.clone(g_ajaxparams);
    params.toIds = document.getElementById("gb_message_toId").value;
    params.subject = document.getElementById("gb_message_subject").value;
    params.message = document.getElementById("gb_message_content").value;
    params.type = type;
    new Ajax.Request(g_ajaxpath + "ajax/sendMessage.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok && document.getElementById(divId)) {
                document.getElementById(divId).innerHTML = "<div class='msgcon'><div class='msg'>" + g_js_strings.sendMessageModule.msgsent + "</div></div>"
            } else {
                document.getElementById(divId).innerHTML = "<div class='msgcon'><div class='msg'>" + g_js_strings.sendMessageModule.retrydesc + "</div></div>"
            }
        },
        onFailure: function () {}
    })
};
var cm = function (parent) {
        var my = parent.mww = parent.mww || {};

        function mmb_modal_confirm(pid) {
            var mmbhtml = new Array();
            mmbhtml.push("<div class='modal_mmb'>");
            mmbhtml.push("<div class='chosenitemwrap clearfix'>");
            mmbhtml.push("<div class='merlinleft'>");
            mmbhtml.push("</div>");
            mmbhtml.push("<div class='inforight clearfix'>");
            mmbhtml.push("<div class='titlebar'>");
            mmbhtml.push(g_js_strings.modal_mmb.playmmb);
            mmbhtml.push("</div>");
            mmbhtml.push("<div class='clearfix'>");
            mmbhtml.push("<div class='chosenitem'>");
            mmbhtml.push("<div class='cardtitle'>" + g_js_strings.mmb_modal_confirm.youwon + "</div>");
            mmbhtml.push("<div class='card'><img src='" + stimgUrl + "img/items/70/" + pid + ".jpg'/></div>");
            mmbhtml.push("<div class='placard'>" + itemlist["i" + pid].name + "</div>");
            mmbhtml.push("</div>");
            mmbhtml.push("<div class='chosenitemdesc'>");
            mmbhtml.push("<div class='desctitle'>" + itemlist["i" + pid].name + "</div>");
            mmbhtml.push("<div class='desc'>" + itemlist["i" + pid].description + "</div>");
            mmbhtml.push("<div class='applytext'>" + g_js_strings.mmb_modal_confirm.addedto + " <a  onclick='Modal.hideModalAll();cm.InventoryView.openInventory();return false;'>" + g_js_strings.commonstr.inventory + "</a></div>");
            mmbhtml.push("</div>");
            mmbhtml.push("</div>");
            mmbhtml.push("<div class='shareupsell'" + (cm.feedTracking.get("mmb_modal_confirm") ? "" : " style='visibility:hidden;'") + ">" + g_js_strings.mmb_modal_confirm.sharemmtoken + "</div>");
            mmbhtml.push("<div class='okaybtn clearfix'>");
            if (cm.feedTracking.get("mmb_modal_confirm") !== false) {
                mmbhtml.push("<a class='button25' onclick='cm.mww.mmb_share(\"" + pid + "\");return false;'><span>" + (g_js_strings.mmb_modal_confirm.sharefreetoken) + "</span></a>")
            } else {
                mmbhtml.push("<a class='buttonDown25' onclick='Modal.hideModal(); return false;'><span>" + g_js_strings.commonstr.ok + "</span></a>")
            }
            cm.feedTracking.setFalse("mmb_modal_confirm");
            mmbhtml.push("</div>");
            mmbhtml.push("</div>");
            mmbhtml.push("</div>");
            mmbhtml.push("</div>");
            var dialogProperties = {
                winWidth: 740,
                winHeight: 400,
                winLeft: 10,
                winTop: 10,
                winTitle: g_js_strings.modaltitles.mmb,
                winContent: mmbhtml.join(""),
                shutdown: my.modal_mmb
            };
            Modal.show(dialogProperties)
        }

        function mmb_add_confirm(pid) {
            Modal.hideModal();
            my.modal_mmb()
        }

        function modal_mmb_openbox(boxnum) {
            var mmbhtml = new Array();
            mmbhtml.push("<div>" + g_js_strings.modal_mmb_openbox.youvewon + "</div>");
            mmbhtml.push("<div class='item itemwin'><img src='https://profile.ak.fbcdn.net/profile5/224/58/q535310007_4445.jpg'/><div>" + g_js_strings.modal_mmb_openbox.redtapestry + "</div></div>");
            Modal.showModal(600, 400, 10, 10, g_js_strings.modaltitles.mmb, mmbhtml.join(""))
        }

        function testPanel() {
            var test = false;
            return (test ? "<input type='button' value='close' onclick='cm.flash.close();' /><input type='button' value='getgems' onclick='cm.flash.modal_getgems();' /><input type='button' value='Barkskin' onclick=\"cm.flash.incrementItem('271');\" /><input type='button' value='Wood 20k' onclick=\"cm.flash.incrementItem('1024');\" /><input type='button' value='postToProfile 85' onclick=\"cm.flash.postToProfile('10001', 85);\" /><input type='button' value='postToProfile 202' onclick=\"cm.flash.postToProfile('Item', 202);\" /><input type='button' value='post to profile 203' onclick=\"cm.flash.postToProfile('ItemB', 203);\" /><br>" : "")
        }

        function track(ftflag, is_mmw_on) {
            var origin = {
                0: "User Clicked on bottom left Link from within the game",
                1: "Auto Start from Game",
                2: "From items page",
                undefined: "Unknown Start."
            };
            var sub = {
                0: "From Link",
                1: "Auto Start",
                2: "From Items Page",
                undefined: "Unknown"
            };
            cm.MixPanelTracker.track("MWW " + sub[ftflag], {
                last_fbuid_digit: lastFbuidDigit,
                distinct_id: user_id,
                origin: origin[ftflag],
                mwwOn: is_mmw_on
            })
        }
        my.mmb_share = function (pid, feedNum, callback) {
            if (!feedNum) {
                feedNum = 85
            }
            var reparr = new Array();

            function feed_cb() {
                (feedNum == 202 ? continuation_202 : continuation_203)();
                if (typeof callback == "function") {
                    callback()
                }
            }
            if (feedNum == 85) {
                Modal.hideModal();
                reparr.push(["REPLACE_ItEmNaMe", itemlist["i" + pid].name]);
                var temptemplate = Object.cloneFeed(template_data_85);
                temptemplate.media[0].src = feedImgUrl + "img/items/130/" + pid + ".jpg";
                common_postToProfile("85", temptemplate, Object.cloneFeed(actionlink_data_85), continuation_85, reparr);
                cm.log.l("MMB media[0] url=" + temptemplate.media[0].src);
                var modalArray = jQuery("div.modal_mmb");
                if (modalArray == null || modalArray.length < 1) {
                    mmb_add_confirm(pid)
                }
            }
            if (feedNum == 202) {
                itemWon = pid;
                reparr.push(["REPLACE_ItEmNaMe", itemWon]);
                var temptemplate = Object.cloneFeed(template_data_202);
                temptemplate.media[0].src = feedImgUrl + "img/feeds/merlin_magical_token.jpg";
                common_postToProfile("202", temptemplate, Object.cloneFeed(actionlink_data_202), feed_cb, reparr)
            }
            if (feedNum == 203) {
                itemWon = pid;
                reparr.push(["REPLACE_ItEmNaMe", itemWon]);
                var temptemplate = Object.cloneFeed(template_data_203);
                temptemplate.media[0].src = feedImgUrl + "img/feeds/merlin_magical_token.jpg";
                common_postToProfile("203", temptemplate, Object.cloneFeed(actionlink_data_203), feed_cb, reparr)
            }
        };
        my.modal_mmb = function () {
            var tokenCnt = parseInt(seed.items.i599) || 0;
            var mmbhtml = new Array();
            mmbhtml.push("<div class='modal_mmb'>");
            mmbhtml.push("<div class='topinfo clearfix'>");
            mmbhtml.push("<div class='enddeco_s33'></div>");
            mmbhtml.push("<div class='middlecontent'>");
            mmbhtml.push("<div class='titlebar'>");
            mmbhtml.push(g_js_strings.modal_mmb.playmmb);
            mmbhtml.push("</div>");
            mmbhtml.push("<div class='description'>" + g_js_strings.modal_mmb.gamechance + "</div>");
            mmbhtml.push("<div class='description'>" + g_js_strings.modal_mmb.everyonewins + "</div>");
            if (cm.WorldSettings.hasKeyValuePair("MIGRATION1", "true")) {
                if (seed.platform.type == "kabam") {
                    mmbhtml.push("<div class='kabammsg' style='margin-top: 10px; color: #900;'> " + g_js_strings.modal_mmb.playonkabam + " </div>")
                } else {
                    mmbhtml.push("<div class='kabammsg' style='margin-top: 10px;'><a style=' color: #900;' href='" + seed.platform.url + "' target='_top'> " + g_js_strings.modal_mmb.playonfb + " </a></div>")
                }
            }
            mmbhtml.push("</div>");
            mmbhtml.push("<div class='enddeco_s33'></div>");
            mmbhtml.push("</div>");
            mmbhtml.push("<div class='playgamewrap'>");
            mmbhtml.push("<div class='playgametext'>" + g_js_strings.modal_mmb.usetokens + "</div>");
            mmbhtml.push("<div class='playgametext'>" + g_js_strings.commonstr.cost + ": <span>1<img src='" + stimgUrl + "img/mmb_merlintoken1.png'/> " + g_js_strings.modal_mmb.magicaltokens + "</span></div>");
            mmbhtml.push("<div class='playgametoken'>" + g_js_strings.commonstr.youown + ": " + tokenCnt);
            if (tokenCnt > 0) {
                mmbhtml.push("<a  onclick='Modal.hideModalAll();cm.ShopView.openShop(1);return false;'>" + g_js_strings.commonstr.buymore + "</a>")
            }
            mmbhtml.push("</div>");
            if (tokenCnt > 0) {
                mmbhtml.push("<div class='playbtn clearfix'><a class='button30' onclick='Modal.hideModal();cm.mww.start(0);return false;'><span>" + g_js_strings.modal_mmb.playnow + "</span></a></div><div class='playbtn'><a class='closelink'  onclick='Modal.hideModal();return false;'>" + g_js_strings.modal_mmb.playlater + "</a></div>")
            } else {
                mmbhtml.push("<div class='playbtn clearfix'><a  class='button30' onclick='Modal.hideModal();cm.ShopView.openShop(1);return false;'><span>" + g_js_strings.commonstr.buymore + "</span></a></div>")
            }
            mmbhtml.push("</div>");
            mmbhtml.push("</div>");
            Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.mmb, mmbhtml.join(""))
        };
        my.modal_mmb_tooltip = function (iid, tgt, evt) {
            showTooltip(itemlist["i" + iid].description, tgt, evt, "modal_mmb")
        };
        my.modal_mmb_play = function () {
            $("mmbPlayBox").innerHTML = "";
            var fronts = $("mmbDisplayCase").getElementsByClassName("item");
            for (var i = 0; i < fronts.length; i++) {
                Element.extend(fronts[i]);
                fronts[i].hide()
            }
            var backs = $("mmbPickCase").getElementsByTagName("a");
            for (var i = 0; i < backs.length; i++) {
                Element.extend(backs[i]);
                backs[i].show()
            }
            $("mmbPickText").show()
        };
        my.incrementItem = function (itemId) {
            if (seed.items["i" + itemId]) {
                seed.items["i" + itemId] = parseInt(seed.items["i" + itemId]) + 1;
                ksoItems[itemId].add()
            } else {
                seed.items["i" + itemId] = 1;
                ksoItems[itemId].add()
            }
        };
        my.chooseMmbCard = function () {
            var params = Object.clone(g_ajaxparams);
            new Ajax.Request(g_ajaxpath + "ajax/magicalboxPick.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        Modal.hideModal();
                        my.incrementItem(rslt.prize);
                        var tokenCount = parseInt(seed.items.i599);
                        if (tokenCount > 0) {
                            seed.items.i599 = (tokenCount - 1).toString();
                            ksoItems[599].subtract()
                        }
                        mmb_modal_confirm(rslt.prize)
                    } else {
                        Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                    }
                },
                onFailure: function () {}
            })
        };
        my.start = function (ftflag) {
            Modal.hideModal();
            track(ftflag, false);
            var params = Object.clone(g_ajaxparams);
            params.ftflag = ftflag;
            new Ajax.Request(g_ajaxpath + "ajax/magicalboxPreview.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (message) {
                    var rslt = eval("(" + message.responseText + ")");
                    if (rslt.ok) {
                        var lockeditems;
                        var showitems;
                        if (rslt.unlocked) {
                            showitems = rslt.data
                        } else {
                            var giftCutoff = 10;
                            if (cm.WorldSettings.hasSetting("MMB_NUMBOX_NOT_GIFTED") && !isNaN(cm.WorldSettings.getSetting("MMB_NUMBOX_NOT_GIFTED"))) {
                                giftCutoff = Math.min(cm.WorldSettings.getSetting("MMB_NUMBOX_NOT_GIFTED"), 20)
                            }
                            giftCutoff = Math.max(giftCutoff, 0);
                            showitems = rslt.data.slice(0, giftCutoff);
                            lockeditems = rslt.data.slice(giftCutoff)
                        }
                        var mmbhtml = new Array();
                        mmbhtml.push("<div id='modal_mmb' class='modal_mmb' style=''>");
                        mmbhtml.push("<div class='topinfo clearfix'>");
                        mmbhtml.push("<div class='enddeco_s33'></div>");
                        mmbhtml.push("<div class='middlecontent'>");
                        mmbhtml.push("<div class='titlebar'>");
                        mmbhtml.push(g_js_strings.modal_mmb.playmmb);
                        mmbhtml.push("</div>");
                        mmbhtml.push("<div class='description'>" + g_js_strings.modal_mmb.gamechance + "</div>");
                        mmbhtml.push("<div class='description'>" + g_js_strings.modal_mmb_game.playfreedesc + "</div>");
                        if (cm.WorldSettings.hasKeyValuePair("MIGRATION1", "true")) {
                            if (seed.platform.type == "kabam") {
                                mmbhtml.push("<div class='kabammsg' style='margin-top: 10px; color: #900;'> Playing on Kabam.com gives two tokens per day! </div>")
                            } else {
                                mmbhtml.push("<div class='kabammsg' style='margin-top: 10px;'><a style=' color: #900;' href='" + seed.platform.url + "' target='_top'> Play on Kabam.com for one additional FREE token! </a></div>")
                            }
                        }
                        mmbhtml.push("<div class='playbtn clearfix' id='mmbPlayBox'><a onclick='cm.mww.modal_mmb_play();return false;' class='button30' style='width:200px;'><span>" + g_js_strings.modal_mmb.playnow + "</span></a></div>");
                        mmbhtml.push("<div id='mmbPickText' class='mmbpicktext' style='display:none;'>" + g_js_strings.modal_mmb_game.pickbox + "</div>");
                        mmbhtml.push("</div>");
                        mmbhtml.push("<div class='enddeco_s33'></div>");
                        mmbhtml.push("</div>");
                        mmbhtml.push("<div class='displaycase clearfix'>");
                        mmbhtml.push("<div id='mmbDisplayCase'>");
                        for (var i = 0; i < showitems.length; i++) {
                            if (itemlist["i" + showitems[i]]) {
                                mmbhtml.push("<div class='item' onmouseout='removeTooltip();return false;' onmouseover='cm.mww.modal_mmb_tooltip(" + showitems[i] + ",this,event)'>");
                                mmbhtml.push("<div class='card'><img src='" + stimgUrl + "img/items/70/" + showitems[i] + ".jpg'/></div>");
                                mmbhtml.push("<div class='placard'>" + itemlist["i" + showitems[i]].name + "</div>");
                                mmbhtml.push("</div>")
                            }
                        }
                        if (lockeditems) {
                            for (var i = 0; i < lockeditems.length; i++) {
                                if (itemlist["i" + lockeditems[i]]) {
                                    mmbhtml.push("<div class='item' onmouseout='removeTooltip();return false;' onmouseover='cm.mww.modal_mmb_tooltip(" + lockeditems[i] + ",this,event)'>");
                                    mmbhtml.push("<div class='card'><img src='" + stimgUrl + "img/items/70/" + lockeditems[i] + ".jpg'/><div class='lockedicon'>&nbsp;</div></div>");
                                    mmbhtml.push("<div class='placard'>" + itemlist["i" + lockeditems[i]].name + "</div>");
                                    mmbhtml.push("</div>")
                                }
                            }
                        }
                        mmbhtml.push("</div>");
                        mmbhtml.push("<div id='mmbPickCase'>");
                        var totalGifts = 20;
                        if (cm.WorldSettings.hasSetting("MMB_NUMBOX_GIFTED") && !isNaN(cm.WorldSettings.getSetting("MMB_NUMBOX_GIFTED"))) {
                            totalGifts = Math.min(cm.WorldSettings.getSetting("MMB_NUMBOX_GIFTED"), totalGifts)
                        }
                        for (var i = 0; i < totalGifts; i++) {
                            mmbhtml.push("<a  class='pickitem' style='display:none;' onclick='cm.mww.chooseMmbCard();return false;'><span>?</span></a>")
                        }
                        mmbhtml.push("</div>");
                        mmbhtml.push("</div>");
                        mmbhtml.push("</div>");
                        Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.mmb, mmbhtml.join(""))
                    }
                },
                onFailure: function () {}
            })
        };
        my.startMMW = function (ftflag) {
            Modal.hideModal();
            track(ftflag, true);
            cm.flash.setFTFlag(ftflag);
            var ht = testPanel() + "<div id='modal_mmb' class='modal_mmb modal_mww'></div>";
            Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.mmb, ht, function () {
                cm.flash_init.exe()
            }, undefined, false)
        };
        return parent
    }(cm);
if (!window.Modal) {
    var Modal = new Object()
}
Modal.Properties = {
    curtain: null,
    modalid: 0,
    onCloseCallback: null,
    m_onCloseCallbackMap: {},
    shutdown: {},
    stack: []
};
Modal.Methods = {
    showAlert: function (d, a, e, f) {
        if (d.tracker) {
            this.showTrackerAlert(d, e)
        } else {
            f = f || {};
            var c = new Array();
            c.push("<div class='kofcalert'>");
            c.push(d);
            c.push("</div>");
            if (a) {
                c.push("<div class='" + (f.buttonContainerClass ? f.buttonContainerClass : "kofccustombtn clearfix") + "'>");
                c.push(a);
                c.push("</div>")
            } else {
                c.push("<div class='kofcalertbtn clearfix'>");
                c.push("<a class='button20' onclick='Modal.hideModal();return false;'><span>");
                c.push(g_js_strings.commonstr.ok);
                c.push("</span></a>");
                c.push("</div>")
            }
            var b = 150;
            if (e) {
                b = e
            }
            this.showModal(400, 400, 150, b, f.title ? f.title : g_js_strings.modaltitles.notice, c.join(""), null, null, null, f)
        }
    },
    showTrackerAlert: function (a, d) {
        var e = d || 150,
            b = {
                merlin: [
                    ["default", "0", "1", "3"], "error"],
                traffic: [
                    ["8"], "excesstraffic"],
                knight: [
                    ["216"], "error"],
                worker: [
                    ["103", "2", "102"], "error"]
            },
            i = a.type || "",
            g = g_js_strings.modaltitles.error,
            f = a.text || "";
        if (a.errorCode && a.msg) {
            for (var h in b) {
                if (b[h][0].indexOf(a.errorCode.toString()) != -1) {
                    i = h;
                    g = g_js_strings.modaltitles[b[h][1]];
                    break
                }
            }
            if (f == "") {
                f = g_js_strings.errorcode["err_" + a.errorCode]
            }
        }
        var c = [];
        c.push("<div class='kofctrackeralert " + i + "'>");
        c.push("<div class='text'>");
        c.push(f);
        c.push("</div>");
        c.push("</div>");
        c.push("<div class='btn' onclick='Modal.hideModal();return false;'>");
        c.push(g_js_strings.commonstr.ok);
        c.push("</div>");
        this.showModal(436, 279, 150, e, g, c.join(""))
    },
    showModalUEP: function (c, b, d, e) {
        if (cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON")) {
            return
        }
        var a = new Array();
        a.push("<div class='uepwrap'>");
        a.push("<div class='clearfix'>");
        a.push("<div class='leftimg'>");
        a.push(d);
        a.push("</div>");
        a.push("<div class='righttxt'>");
        a.push(c);
        a.push("</div>");
        a.push("</div>");
        a.push("<div class='btnrow clearfix'>");
        a.push(b);
        a.push("</div>");
        a.push("</div>");
        if (e && e == 1) {
            this.showModal(544, 368, 100, 300, "", a.join(""))
        } else {
            this.showModal(544, 368, 100, 125, "", a.join(""))
        }
    },
    showModalUEP2: function (c, b, d, e) {
        if (cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON")) {
            return
        }
        var a = new Array();
        a.push("<div class='uepwrap'>");
        a.push("<div class='clearfix'>");
        a.push("<div class='leftimg'>");
        a.push(d);
        a.push("</div>");
        a.push("<div class='righttxt'>");
        a.push(c);
        a.push("</div>");
        a.push("</div>");
        a.push("<div class='btnrow2'>");
        a.push(b);
        a.push("</div>");
        a.push("</div>");
        if (e && e == 1) {
            this.showModal(544, 368, 100, 300, "", a.join(""))
        } else {
            this.showModal(544, 368, 100, 125, "", a.join(""))
        }
        showModal
    },
    show: function (c) {
        var a = {
            winWidth: 740,
            winHeight: 400,
            winLeft: 10,
            winTop: 10,
            winTitle: "Window Title",
            winContent: "Window Content",
            callback: function () {},
            callbackparams: [],
            topBar: null,
            shutdown: function () {}
        };
        var b = c;
        this.shutdown[(this.modalid + 1).toString()] = b.shutdown;
        this.showModal(b.winWidth, b.winHeight, b.winLeft, b.winTop, b.winTitle, b.winContent, b.callback, b.callbackparams, b.topBar, b.o)
    },
    showModal: function (b, d, h, e, k, i, j, g, c, a, f) {
        if (cm.TutorialManager.inTutorialMode()) {
            tutorialClear();
            if (f && promo()) {
                e = 85
            }
        }
        this.modalid++;
        if (a && a.additionalClass == "directLinkOverride") {
            this.showCurtain(100999)
        } else {
            this.showCurtain()
        }
        this.showWindow(b, d, h, e, k, i, j, g, c, a)
    },
    hideModal: function () {
        cm.ModalManager.subZ();
        cm.util.clearDouble("modal_getgems");
        this.hideCurtain();
        this.hideWindow();
        if (this.modalid > 0) {
            this.modalid--
        }
        var a = this.shutdown[(this.modalid + 1).toString()];
        delete this.shutdown[(this.modalid + 1).toString()];
        if (a && typeof a == "function") {
            a()
        }
    },
    hideModalAll: function () {
        while (this.modalid > 0) {
            this.hideModal()
        }
        this.modalid = 0
    },
    showWindow: function (e, g, k, h, p, l, n, i, f, c) {
        c = jQuery.extend({
            additionalClass: ""
        }, c);
        if (!$("modalBox" + this.modalid)) {
            if (this.onCloseCallback) {
                this.m_onCloseCallbackMap[this.modalid] = this.onCloseCallback;
                this.onCloseCallback = null
            }
            var a = document.createElement("div");
            a.id = "modalBox" + this.modalid;
            modalboxHtml = new Array();
            if (parseInt(e) == 740) {
                a.className = "modalBox " + (f === false ? "" : ("modalBox740 " + c.additionalClass));
                modalboxHtml.push('<div id="modalInner' + this.modalid + '" class="modalInner modalInner' + (f === false ? "" : "740") + '">');
                modalboxHtml.push('<div id="modalTitleBar' + this.modalid + '" class="modalTitleBar modalTitleBar740" style="' + (f === false ? "display: none;" : "") + '">')
            } else {
                if (parseInt(e) == 500) {
                    a.className = "modalBox modalBox500";
                    modalboxHtml.push('<div id="modalInner' + this.modalid + '" class="modalInner modalInner500">');
                    modalboxHtml.push('<div id="modalTitleBar' + this.modalid + '" class="modalTitleBar modalTitleBar500">')
                } else {
                    if (parseInt(e) == 400) {
                        a.className = "modalBox modalBox400 " + c.additionalClass;
                        modalboxHtml.push('<div id="modalInner' + this.modalid + '" class="modalInner modalInner400">');
                        modalboxHtml.push('<div id="modalTitleBar' + this.modalid + '" class="modalTitleBar modalTitleBar400">')
                    } else {
                        if (parseInt(e) == 436) {
                            a.className = "modalBox modalBox436";
                            modalboxHtml.push('<div id="modalInner' + this.modalid + '" class="modalInner modalInner436">');
                            modalboxHtml.push('<div id="modalTitleBar' + this.modalid + '" class="modalTitleBar modalTitleBar436">')
                        } else {
                            if (parseInt(e) == 544) {
                                a.className = "modalBox modalBoxUEP";
                                modalboxHtml.push('<div id="modalInner' + this.modalid + '" class="modalInner modalInnerUEP">');
                                modalboxHtml.push('<div id="modalTitleBar' + this.modalid + '" class="modalTitleBar modalTitleBarUEP">')
                            } else {
                                if (parseInt(e) == 250) {
                                    a.className = "modalBox modalBoxFBFan";
                                    modalboxHtml.push('<div id="modalInner' + this.modalid + '" class="modalInner modalInnerFBFan">');
                                    modalboxHtml.push('<div id="modalTitleBar' + this.modalid + '" class="modalTitleBar modalTitleBarFBFan">')
                                } else {
                                    if (parseInt(e) == 580) {
                                        a.className = "modalBox modalBoxHelpDesk";
                                        modalboxHtml.push('<div id="modalInner' + this.modalid + '" class="modalInner modalInnerHelpDesk">');
                                        modalboxHtml.push('<div id="modalTitleBar' + this.modalid + '" class="modalTitleBar modalTitleBarHelpDesk">')
                                    } else {
                                        a.className = "modalBox " + c.additionalClass;
                                        modalboxHtml.push('<div id="modalInner' + this.modalid + '" class="modalInner">');
                                        modalboxHtml.push('<div id="modalTitleBar' + this.modalid + '" class="modalTitleBar">')
                                    }
                                }
                            }
                        }
                    }
                }
            }
            modalboxHtml.push('<div id="modalTitle' + this.modalid + '" class="modalTitle"></div>');
            if (!c.noControl) {
                modalboxHtml.push('<div id="modalControls' + this.modalid + '" class="modalControls">');
                if (parseInt(e) == 250) {
                    modalboxHtml.push('<a onclick="Modal.hideModal();" id="modalControlsClose' + this.modalid + '">x</a>')
                } else {
                    modalboxHtml.push('<a onclick="Modal.hideModal();" id="modalControlsClose' + this.modalid + '"><span>&nbsp;</span></a>')
                }
                modalboxHtml.push("</div>")
            }
            modalboxHtml.push("</div>");
            if (parseInt(e) == 740) {
                modalboxHtml.push('<div id="modalContent' + this.modalid + '" class="modalContent modalContent740"></div>')
            } else {
                if (parseInt(e) == 500) {
                    modalboxHtml.push('<div id="modalContent' + this.modalid + '" class="modalContent modalContent500"></div>')
                } else {
                    if (parseInt(e) == 400) {
                        modalboxHtml.push('<div id="modalContent' + this.modalid + '" class="modalContent modalContent400"></div>')
                    } else {
                        if (parseInt(e) == 519) {
                            modalboxHtml.push('<div id="modalContent' + this.modalid + '" class="modalContent modalContentUEP"></div>')
                        } else {
                            if (parseInt(e) == 250) {
                                modalboxHtml.push('<div id="modalContent' + this.modalid + '" class="modalContent modalContentFBFan"></div>')
                            } else {
                                modalboxHtml.push('<div id="modalContent' + this.modalid + '" class="modalContent"></div>')
                            }
                        }
                    }
                }
            }
            modalboxHtml.push("</div>");
            a.innerHTML = modalboxHtml.join("");
            document.getElementsByTagName("body")[0].appendChild(a)
        }
        var a = $("modalBox" + this.modalid);
        this.stack.push(a);
        a.show();
        switch (e) {
        case 740:
            var b = 742;
            var m = 10;
            break;
        case 500:
            var b = 522;
            var m = 119;
            break;
        case 400:
            var b = 416;
            var m = 172;
            break;
        default:
            var b = e;
            var m = k;
            break
        }
        switch (h) {
        case "high":
            var d = 48;
        case "low":
            var d = 500;
        default:
            var d = h
        }
        a.style.width = b + "px";
        $("modalTitle" + this.modalid).innerHTML = p;
        $("modalContent" + this.modalid).innerHTML = l;
        a.style.top = d + "px";
        a.style.left = m + "px";
        var j = cm.ModalManager.addZ();
        Element.setStyle($("modalBox" + this.modalid), {
            zIndex: j
        });
        Element.setStyle($("modalCurtain" + this.modalid), {
            zIndex: j - 1
        });
        if (n) {
            if (i) {
                n(i)
            } else {
                n()
            }
        }
    },
    hideWindow: function () {
        if ($("modalTitle" + this.modalid)) {
            $("modalTitle" + this.modalid).innerHTML = "";
            $("modalContent" + this.modalid).innerHTML = "";
            Element.remove($("modalBox" + this.modalid));
            if (this.m_onCloseCallbackMap[this.modalid]) {
                this.m_onCloseCallbackMap[this.modalid]();
                delete this.m_onCloseCallbackMap[this.modalid]
            }
        }
    },
    showCurtain: function (c) {
        if (!$("modalCurtain")) {
            var a = document.getElementsByTagName("body")[0];
            var b = document.createElement("div");
            b.className = "modalCurtain";
            b.id = "modalCurtain" + this.modalid;
            a.appendChild(b);
            var d = (this.modalid + 1) * 100 + 100000;
            if (c) {
                d = c;
                this.modalid++;
                b.id = "modalCurtain" + this.modalid
            }
            Element.setStyle($("modalCurtain" + this.modalid), {
                zIndex: d
            })
        } else {
            $("modalCurtain").show()
        }
    },
    hideCurtain: function () {
        if ($("modalCurtain" + this.modalid)) {
            Element.remove($("modalCurtain" + this.modalid))
        }
    },
    okay: function (a) {
        a.text = a.text ? a.text : "Are you sure you want to do that?";
        a.width = a.width ? a.width : 740;
        a.top = a.top ? a.top : 10;
        a.left = a.left ? a.left : 10;
        a.title = a.title ? a.title : g_js_strings.modal_questions.question;
        a.formattedText = a.formattedText ? a.formattedText : ["<div style='padding: 50px; font-size: 16px;'>", a.text, "<br>", "<div style='margin-top:10px;'>", "<a class='okay inlineButton blue20'><span>", g_js_strings.commonstr.ok, "</span></a> &nbsp; ", "<a class='cancel inlineButton blue20'><span>", g_js_strings.commonstr.cancel, "</span></a>", "</div></div>"].join("");
        Modal.showModal(a.width, 400, a.left, a.top, a.title, a.formattedText);
        $$("#modalBox" + this.modalid + " .okay")[0].onclick = function () {
            if (a.okay) {
                a.okay(a.data)
            }
            Modal.hideModal()
        };
        $$("#modalBox" + this.modalid + " .cancel")[0].onclick = function () {
            if (a.cancel) {
                a.cancel()
            }
            Modal.hideModal()
        }
    },
    confirm: function (a) {
        a.width = 400;
        a.top = 130;
        a.left = 130;
        a.formattedText = ["<div style='padding-top: 40px; font-size: 12px;'>", "<div style='width: 330px; margin: 0 auto 40px;'>", a.text, "</div>", "<div style='margin-top:10px; text-align: center;'>", "<a class='okay inlineButton blue20'><span>", g_js_strings.commonstr.ok, "</span></a> &nbsp; ", "<a class='cancel inlineButton blue20'><span>", g_js_strings.commonstr.cancel, "</span></a>", "</div>", "</div>"].join("");
        Modal.okay(a)
    },
    multiButton: function (h) {
        var g = new Array();
        var c = new Array();
        var d = null;
        var b = false;
        g.push("<div class='mistwarn'>" + h.body + "</div>");
        for (var a in h.buttons) {
            if (h.buttons.hasOwnProperty(a)) {
                var f = h.buttons[a];
                if (!b && f.description) {
                    b = true
                }
                d = f.cls || "button20";
                c.push("<a class='" + d + " choice" + a + "'><span>" + f.txt + "</span></a>")
            }
        }
        Modal.showAlert(g.join(""), c.join(""), undefined, h);
        for (var a in h.buttons) {
            if (h.buttons.hasOwnProperty(a)) {
                var e = jQuery("#modalBox" + this.modalid + " .choice" + a);
                if (h.buttons[a].id) {
                    e[0].id = h.buttons[a].id
                }
                if (b) {
                    e.wrap('<div class="descriptionButtonWrapper" />')
                }
                e.bind("click", h.buttons[a].exe);
                if (h.buttons[a].description) {
                    e.parent().width(e.outerWidth());
                    e.parent().append('<div class="description">' + h.buttons[a].description + "</div>")
                }
            }
        }
    }
};
Object.extend(Modal, Modal.Methods);
Object.extend(Modal, Modal.Properties);
cm.ModalManager = function (i) {
    var c = [],
        d = 0;
    var f = {
        style: "",
        "class": "",
        left: 200,
        top: 150,
        width: 300,
        height: 200,
        show: function () {}
    };

    function m() {
        if (d > 0) {
            d--;
            var n = d;
            if (typeof c[d].close == "function") {
                c[d].close()
            }
            i(".cmModal" + d + ", .curtainNum" + d).remove()
        }
    }

    function g() {
        for (var n = d; n >= 0; --n) {
            i(".cmModal" + n + ", .curtainNum" + d).remove()
        }
        d = 0
    }

    function a(n, o) {
        o = o ? " style='background: url(" + stimgUrl + "img/" + o + ");' " : "";
        return "<div class='" + n + "' " + o + "/>"
    }

    function b(r) {
        if (r.closeNow) {
            m()
        }
        var q = i.extend({}, f, r);
        var n = r["class"] + " cmModal" + d;
        var p = r.style + "position: absolute; left: " + q.left + "px; top: " + q.top + "px; width: " + q.width + "px; height: " + q.height + "px;";
        c[d] = q;
        i("body").append((q.curtain ? a("curtainMM curtainNum" + d) : "") + "<div class='cmModalContainer " + n + "' style='" + p + "'>" + a("close", "close_icon.png") + q.body + "</div>");
        q.show(".cmModal" + d);
        e(r)
    }

    function k(s) {
        if (s.closeNow) {
            m()
        }
        var r = i.extend({}, f, s);
        var n = s["class"] + " cmModal" + d + " largeModal primaryContainer";
        var q = (s.style) ? s.style : " position: absolute; left: " + r.left + "px; top: " + r.top + "px; width: " + r.width + "px; height: " + r.height + "px;";
        var p;
        c[d] = r;
        if (r.secondaryBody) {
            p = cm.Template.renderTemplate("Modal", "largeModal2", {
                curtainId: d,
                curtainZ: 0,
                modalClasses: n,
                modalStyles: q,
                primaryTitle: r.primaryTitle,
                primaryBody: r.primaryBody,
                secondaryTitle: r.secondaryTitle,
                secondaryBody: r.secondaryBody
            })
        } else {
            p = cm.Template.renderTemplate("Modal", "largeModal1", {
                curtainId: d,
                curtainZ: 0,
                modalClasses: n,
                modalStyles: q,
                gem: r.gem,
                primaryTitle: r.primaryTitle,
                primaryBody: r.primaryBody
            })
        }
        i("body").append(p);
        r.show(".cmModal" + d);
        e(s)
    }

    function l(s) {
        if (s.closeNow) {
            m()
        }
        var r = i.extend({}, f, s);
        var n = s["class"] + " cmModal" + d + " mediumModal primaryContainer";
        var q = s.style + "position: absolute; left: " + r.left + "px; top: " + r.top + "px; width: " + r.width + "px; height: " + r.height + "px;";
        c[d] = r;
        var p = cm.Template.renderTemplate("Modal", "mediumModal", {
            curtainId: d,
            curtainZ: 0,
            modalClasses: n,
            modalStyles: q,
            primaryTitle: r.title,
            primaryBody: r.body
        });
        i("body").append(p);
        r.show(".cmModal" + d);
        e(s)
    }

    function e(n) {
        var p;
        if (n.lower) {
            p = 100000
        } else {
            if (n.z) {
                p = n.z
            } else {
                p = 100400
            }
        }
        i(".cmModal" + d).css("z-index", p + (d * 5));
        i(".curtainNum" + d).css("z-index", (p - 1) + (d * 5));
        i(".close").unbind("click").bind("click", m).show();
        if (n.hideClose) {
            i(".close").hide()
        }
        d++
    }

    function j() {
        var n = 100400;
        c[d] = {
            wtf: "filler from Modal.js"
        };
        n = n + (d * 5);
        d++;
        return n
    }

    function h() {
        if (d > 0) {
            d--
        }
    }
    return {
        addZ: j,
        subZ: h,
        add: b,
        addLarge: k,
        addMedium: function (n) {
            l(n);
            i(".hint").unbind("click").bind("click", function () {
                cm.ModalManager.alert(g_js_strings.comingsoon.comingsoon)
            })
        },
        close: m,
        closeAll: g,
        alert: function (p) {
            if (typeof p == "string") {
                p = {
                    text: p
                }
            }
            var n = "<div class='main'>" + p.text + "</div><div class='bottom_box'>" + (p.button_text || g_js_strings.commonstr.ok) + "</div>";
            cm.ModalManager.add({
                close: (p.close) ? p.close : null,
                body: n,
                "class": "guardian_generic " + p["class"],
                curtain: true,
                width: 360,
                height: 250,
                left: 225,
                top: 155
            });
            i(".guardian_generic .bottom_box").unbind("click").bind("click", function () {
                m();
                if (typeof p.exe == "function") {
                    p.exe()
                }
            })
        }
    }
}(jQuery);
cm.NewGameController = function (f) {
    var b = ["m1", "m2", "m3", "m5", "m7", "f1", "f3", "f4", "f5", "f9"],
        l = {
            avatarId: b[Math.floor(Math.random() * b.length)],
            playerName: "",
            avatarList: b,
            domain: {
                serverName: "Not Chosen"
            }
        };
    var d = function (n) {
            n.languages = n.languages;
            l = f.extend(l, n);
            if (l.domain.might !== undefined || !cm.ChangeDomainController.getDomain(g_server)) {
                m();
                return false
            }
            cm.NewGameView.openNewPlayer(l)
        };
    var e = function (n) {
            l.avatarId = n;
            cm.NewGameView.selectAvatar(n)
        };
    var a = function (o) {
            if (!i(o)) {
                o.preventDefault()
            }
            var n = cm.NewGameView.getPlayerName();
            l.playerName = n;
            cm.NewGameView.setPlayerName(n);
            cm.NewGameView.showPlayerNameValid(c(n))
        };
    var m = function () {
            cm.ChangeDomainController.open({})
        };
    var g = function () {
            cm.NewGameView.showNameError(false);
            if (!c(l.playerName)) {
                cm.NewGameView.showNameError(true);
                return false
            }
            h()
        };
    var k = function () {
            top.location = l.domain.playUrl
        };
    var i = function (t) {
            var n = t.which,
                q = (n > 64 && n < 91),
                s = (n > 96 && n < 123),
                r = (n > 47 && n < 58),
                p = (t.charCode === 0 && n === 0),
                o = (n === 8);
            return (q) || (s) || (r) || (p) || (o)
        };
    var c = function (p) {
            var o = 3,
                n = 15,
                r = p.length,
                q = (/^[a-z0-9]+$/i).test(p);
            return r >= o && r <= n && q
        };
    var h = function () {
            var o = g_initPlayerAjaxParamBase,
                n = l.domain.serverId;
            o.displayname = l.playerName;
            o.gender = (l.avatarId.split("")[0]).toUpperCase() === "F" ? "F" : "M";
            o.portrait = l.avatarId.split("")[1];
            o.server = n;
            o.lang = g_currentLanguage;
            AjaxCall.gPostRequest(g_ajaxpath_base + n + g_ajaxpath_append + "ajax/initPlayer.php", o, function (p) {
                if (p.ok) {
                    if (p.skip) {
                        k()
                    } else {
                        j()
                    }
                } else {
                    cm.ModalManager.alert({
                        text: p.msg,
                        button_text: "Close"
                    })
                }
            })
        };
    var j = function () {
            cm.NewGameView.openPlayConfirm(l)
        };
    return {
        openNewPlayer: d,
        avatarEventClick: e,
        nameEventKey: a,
        changeDomainEventClick: m,
        submitEventClick: g,
        openPlayConfirm: j,
        playEventClick: k
    }
}(jQuery);
cm = cm || {};
cm.NewGameView = function (g) {
    var c = function (v) {
            var u = v.languages ? o(v.languages) : "",
                t = b(v);
            l(u, t, v.logoClass)
        };
    var l = function (w, t, v) {
            w = w || "";
            t = t || "";
            v = v || "";
            var u = p(w, t, v);
            if (g("#newGameModal").length > 0) {
                g("#newGameModal").html(u)
            } else {
                cm.ModalManager.add({
                    body: '<div id="newGameModal" class="clearfix">' + u + "</div>",
                    "class": "newGame changeDomain",
                    closeNow: false,
                    hideClose: true,
                    curtain: true,
                    width: 746,
                    height: 613,
                    left: 7,
                    top: 5
                })
            }
        };
    var p = function (w, t, v) {
            var u = g_js_strings.commonstr;
            return cm.Template.renderTemplate("NewGame", "modalShell", {
                titleBar: w,
                body: t,
                logoClass: v
            })
        };
    var b = function (u) {
            var t = g_js_strings.commonstr;
            return cm.Template.renderTemplate("NewGame", "parchmentShell", {
                avatarId: u.avatarId,
                lordyText: i(u.avatarId),
                playerName: u.playerName,
                panelTitle: u.panelTitle,
                panelBody: u.panelBody
            })
        };
    var o = function (u) {
            var t = [];
            t.push('<div class="language_container"><select id="userLanguage">');
            g.each(u, function (v, w) {
                t.push('<option value="' + w.url + '" ' + ((g_ajaxparams.lang === v) ? "selected" : "") + ">" + w.display + "</option>")
            });
            t.push("</select></div>");
            return t.join("")
        };
    var s = function (t, u) {
            return cm.Template.renderTemplate("NewGame", "actionButton", {
                label: t,
                className: u
            })
        };
    var i = function (u) {
            if (typeof u !== "string") {
                return ""
            }
            var t = g_js_strings.commonstr;
            return u.split("")[0] === "f" ? t.lady : t.lord
        };
    var j = function (u) {
            var t = [stimgUrl + "img/newGame/modal_whole_746.png", stimgUrl + "img/newGame/container_parchment.png", stimgUrl + "img/newGame/container_avatars.png", stimgUrl + "img/logo_458.png"];
            g(u.avatarList).each(function () {
                t.unshift(stimgUrl + "img/avatars/v2/246/" + this + ".png");
                t.unshift(stimgUrl + "img/avatars/v2/50x51/" + this + ".png")
            });
            g(t).each(function (v, x) {
                var w = new Image();
                w.src = x
            })
        };
    var q = function (t) {
            t.panelTitle = g_js_strings.newGame.howBeKnown;
            t.panelBody = r(t);
            t.logoClass = "logo";
            j(t);
            c(t);
            g("#newGameModal .avatar_50x51").click(function (v) {
                var u = g("#newGameModal .avatar_50x51").index(this),
                    w = t.avatarList[u];
                cm.NewGameController.avatarEventClick(w)
            });
            g("#newGameNameInput").bind("keypress keyup", function (u) {
                cm.NewGameController.nameEventKey(u)
            });
            g("#newGameModal .change_domain").click(function () {
                cm.NewGameController.changeDomainEventClick()
            });
            g("#newGameModal .create_player").click(function () {
                cm.NewGameController.submitEventClick()
            });
            g("#userLanguage").change(function () {
                top.location = g(this).val()
            })
        };
    var f = function (t) {
            g("#newGameNameInput").val(t);
            g("#newGameNameHeader").text(t)
        };
    var m = function () {
            return g("#newGameNameInput").val()
        };
    var n = function (t) {
            if (t) {
                g("#newGameNameStatus").addClass("checkmark")
            } else {
                g("#newGameNameStatus").removeClass("checkmark")
            }
        };
    var k = function (t) {
            if (t) {
                g("#newGameNameInput").addClass("error");
                g("#nameHint").addClass("error")
            } else {
                g("#newGameNameInput").removeClass("error");
                g("#nameHint").removeClass("error")
            }
        };
    var r = function (u) {
            var t = "",
                v = "";
            g.each(u.avatarList, function (w, x) {
                if (x === u.avatarId) {
                    x += " selected"
                }
                t += '<div class="avatar_50x51 ' + x + '"></div>'
            });
            v += s(g_js_strings.modaltitles.changedomain, "change_domain brown");
            v += s(g_js_strings.commonstr.ok, "create_player blue");
            return cm.Template.renderTemplate("NewGame", "newPlayerPanel", {
                avatarSelectionText: g_js_strings.newGame.settingChangedAnytime,
                nameSelectionText: g_js_strings.newGame.chooseNameStature,
                nameHintText: g_js_strings.newGame.nameValidationMsg,
                cityLocationText: g_js_strings.newGame.yourCityLocated,
                domainText: g_js_strings.commonstr.domain,
                domain: u.domain.serverName || g_js_strings.newGame.notChosen,
                avatarChoices: t,
                lordyText: i(u.avatarId),
                playerName: u.playerName,
                actionButtons: v
            })
        };
    var e = function (u) {
            var t = i(u);
            g("#newGameLordyHeader").text(t);
            g("#newGameLordyLabel").text(t);
            g("#newGamePortrait").attr("class", "avatar_246 " + u);
            g.each(g("#newGameModal .avatar_50x51"), function (v, x) {
                var w = g(x);
                if (w.hasClass(u)) {
                    w.addClass("selected")
                } else {
                    w.removeClass("selected")
                }
            })
        };
    var a = function (t) {
            t.panelTitle = t.panelTitle || g_js_strings.gemGifting.congratulations;
            t.panelBody = t.panelBody || "";
            t.logoClass = "logo";
            c(t)
        };
    var h = function (t) {
            t.panelTitle = g_js_strings.gemGifting.congratulations;
            t.panelBody = d(t);
            a(t);
            g("#newGameModal .play").click(function () {
                cm.NewGameController.playEventClick()
            })
        };
    var d = function (u) {
            var t = [g_js_strings.newGame.lastStepBullet1, g_js_strings.newGame.lastStepBullet2, g_js_strings.newGame.lastStepBullet3, ],
                v = "";
            g.each(t, function (x, w) {
                v += '<li class="redShieldBullet">' + w + "</li>"
            });
            return cm.Template.renderTemplate("NewGame", "playConfirmPanel", {
                lordyText: i(u.avatarId),
                playerName: u.playerName,
                foundedKingdom: g_js_strings.newGame.foundedKingdom,
                placedUnderProtection: g_js_strings.newGame.placedUnderProtection,
                playerHints: v,
                actionButtons: '<div class="gemButtonv2 play">Play</div>'
            })
        };
    return {
        openNewPlayer: q,
        selectAvatar: e,
        getPlayerName: m,
        setPlayerName: f,
        showPlayerNameValid: n,
        showNameError: k,
        openConfirm: a,
        openPlayConfirm: h,
        open: l
    }
}(jQuery);
var cm = cm || {};
cm.NotificationDialogManager = new function () {
    var a = null;
    var b = function () {
            a = null
        };
    this.popup = function (c) {
        if (a && a.isActive() && c.getPriority() >= a.getPriority()) {
            a.removeEventListener(cm.DialogEvent.CLOSE, b);
            a.close();
            a = null
        }
        if (!a || !a.isActive()) {
            a = c;
            a.setParentElement(document.getElementById("mod_maparea"));
            a.addEventListener(cm.DialogEvent.CLOSE, b);
            a.show();
            jQuery(a.getHtmlElement()).animate({
                top: -25
            }, "slow")
        }
    }
}();
cm.NotificationView = function (a) {
    return {
        exe: function () {
            var c = parseInt(seed.newReportCount) + parseInt(seed.newTradeReports);
            if (c > 0) {
                a("#chrome_messages_report").html(c);
                a("#chrome_messages_report").removeClass("noCount");
                a("#modal_msg_tabnum_report").html(c);
                a("#modal_msg_tabnum_report").show()
            } else {
                a("#chrome_messages_report").addClass("noCount");
                a("#modal_msg_tabnum_report").hide()
            }
            var b = parseInt(seed.newMailCount);
            if (b > 0) {
                a("#chrome_messages_notify").html(b);
                a("#chrome_messages_notify").removeClass("noCount");
                if (a("#modal_msg_tabs").length) {
                    if (parseInt(seed.newMailCount) > 0) {
                        a("#modal_msg_tabnum_inbox").html(seed.newMailCount);
                        a("#modal_msg_tabnum_inbox").show()
                    } else {
                        a("#modal_msg_tabnum_inbox").hide()
                    }
                }
            } else {
                a("#chrome_messages_notify").addClass("noCount");
                if (a("#modal_msg_tabs").length) {
                    a("#modal_msg_tabnum_inbox").hide()
                }
            }
        }
    }
}(jQuery);
var cm = cm || {};
cm.PageNavigatorModel = function (b, d) {
    var a = b;
    var c = d;
    var e = b > 0 ? 1 : 0;
    this.onPageChange = null;
    this.onPageCountChange = null;
    this.gotoPage = function (f) {
        e = f;
        if (this.onPageChange != null) {
            this.onPageChange()
        }
    };
    this.gotoPrevPage = function () {
        if (e > 1) {
            this.gotoPage(e - 1)
        }
    };
    this.gotoNextPage = function () {
        if (e < a) {
            this.gotoPage(e + 1)
        }
    };
    this.gotoLastPage = function () {
        this.gotoPage(a)
    };
    this.getSlidingWindow = function () {
        var f = {
            start: 1,
            end: c
        };
        if (a > c) {
            start = Math.max(e - Math.floor((c - 1) / 2), 1);
            end = Math.min(start + c - 1, a);
            if (end - start + 1 < c) {
                start = end - c + 1
            }
            f.start = start;
            f.end = end
        }
        return f
    };
    this.setPageCount = function (f) {
        if (f <= 0) {
            e = 0
        } else {
            e = e > 0 ? e : 1
        }
        e = Math.min(e, a);
        a = f;
        if (this.onPageCountChange != null) {
            this.onPageCountChange()
        }
    };
    this.getPageCount = function () {
        return a
    };
    this.getCurrentPage = function () {
        return e
    };
    this.getMaxPagesShown = function () {
        return c
    };
    this.hasPrev = function () {
        return a > c && e > 1
    };
    this.hasNext = function () {
        return a > c && e < a
    }
};
cm.PageNavigatorItemView = function (a, g) {
    var k = this;
    var e = a;
    var h = "";
    var f = true;
    var d = false;
    var c = true;
    var i = g;
    var b = new Element("a").update("");
    b.href = "javascript:void(0)";
    if (i && i.itemCssClass) {
        b.addClassName(i.itemCssClass);
        b.addClassName(e)
    }
    this.onclick = null;
    var j = function (l) {
            if (k.onClick != null && f) {
                k.onClick(k)
            }
            Event.stop(l)
        };
    Event.observe(b, "mouseup", j);
    this.setText = function (l) {
        h = l;
        b.update(l)
    };
    this.setEnabled = function (l) {
        enabled = l;
        if (!l) {
            b.addClassName("disabled")
        } else {
            b.removeClassName("disabled")
        }
    };
    this.isEnabled = function () {
        return f
    };
    this.setSelected = function (l) {
        d = l;
        if (l) {
            b.addClassName("selected")
        } else {
            b.removeClassName("selected")
        }
    };
    this.isSelected = function () {
        return d
    };
    this.setVisible = function (l) {
        c = l;
        if (!l) {
            b.addClassName("hidden")
        } else {
            b.removeClassName("hidden")
        }
    };
    this.isVisible = function () {
        return c
    };
    this.getHtmlElement = function () {
        return b
    };
    this.getText = function () {
        return h
    }
};
cm.PageNavigatorInputView = function () {
    var d = this;
    var a = null;
    var b = document.createElement("div");
    b.addClassName("input");
    b.innerHTML = "<span>" + g_js_strings.commonstr.pageshort + '</span><input id="navCur" type="text"/>/';
    var c = document.createElement("span");
    b.appendChild(c);
    this.onkeyup = null;
    Event.observe(b, "keyup", function (g) {
        var f = g.target.getValue();
        if (!isNaN(parseInt(f)) && parseInt(f) > 0 && parseInt(f) <= parseInt(a)) {
            d.onkeyup(parseInt(f))
        } else {
            g.target.setValue("")
        }
    });
    this.getHtmlElement = function () {
        return b
    };
    this.updateCurrentPage = function (e) {
        jQuery("#navCur").val(e)
    };
    this.updateCount = function (e) {
        a = e;
        c.innerHTML = e
    }
};
cm.PageNavigatorView = function (d, g) {
    var l = this;
    var h = d;
    var k = [];
    var j = g;
    var c = new Element("div");
    if (j && j.cssClass) {
        c.addClassName(g.cssClass)
    }
    if (h.getPageCount <= 1) {
        c.addClassName("disabled")
    }
    this.input = new cm.PageNavigatorInputView(j);
    this.input.updateCurrentPage(h.getCurrentPage());
    c.appendChild(this.input.getHtmlElement());
    var a = document.createElement("div");
    a.addClassName("nav");
    this.first = new cm.PageNavigatorItemView("leftleft", j);
    this.first.setEnabled(h.hasPrev());
    a.appendChild(this.first.getHtmlElement());
    this.prev = new cm.PageNavigatorItemView("left", j);
    this.prev.setEnabled(h.hasPrev());
    a.appendChild(this.prev.getHtmlElement());
    var f;
    var e = h.getMaxPagesShown();
    for (f = 1; f <= e; f++) {
        var b = new cm.PageNavigatorItemView(f.toString(), j);
        b.setSelected(f == h.getCurrentPage());
        k.push(b)
    }
    this.next = new cm.PageNavigatorItemView("right", j);
    this.next.setEnabled(h.hasNext());
    a.appendChild(this.next.getHtmlElement());
    this.last = new cm.PageNavigatorItemView("rightright", j);
    this.last.setEnabled(h.hasNext());
    a.appendChild(this.last.getHtmlElement());
    c.appendChild(a);
    c.appendChild(new Element("br", {
        clear: "all"
    }));
    _onPageCountChange = function () {
        l.update()
    };
    _onPageChange = function () {
        l.update()
    };
    h.onPageCountChange = _onPageCountChange;
    h.onPageChange = _onPageChange;
    this.update = function () {
        if (h.getPageCount() > 1) {
            c.removeClassName("disabled")
        } else {
            c.addClassName("disabled")
        }
        this.first.setEnabled(h.hasPrev());
        this.prev.setEnabled(h.hasPrev());
        this.next.setEnabled(h.hasNext());
        this.last.setEnabled(h.hasNext());
        this.input.updateCount(h.getPageCount());
        this.input.updateCurrentPage(h.getCurrentPage());
        var o = h.getSlidingWindow();
        if (o) {
            var q = o.start;
            var m = o.end;
            var n;
            for (n = q; n <= m; n++) {
                var p = k[n - q];
                p.setSelected(n == h.getCurrentPage());
                p.setVisible(n <= h.getPageCount());
                p.setEnabled(n <= h.getPageCount());
                p.setText(n.toString())
            }
        }
    };
    this.getHtmlElement = function () {
        return c
    };
    this.getItem = function (i) {
        var m = null;
        if (i >= 0 && i < k.length) {
            m = k[i]
        }
        return m
    };
    this.getItemCount = function () {
        return k.length
    }
};
cm.PageNavigatorController = function (k, n) {
    var o = this;
    var m = k;
    var j = n;
    this.onClick = null;
    var d = function (i) {
            if (typeof (i) == "function") {
                i(m.getCurrentPage())
            }
        };
    var p = function () {
            var i = m.getCurrentPage();
            m.gotoPage(1);
            if (i != m.getCurrentPage()) {
                d(o.onClick)
            }
        };
    var c = function () {
            var i = m.getCurrentPage();
            m.gotoPrevPage();
            if (i != m.getCurrentPage()) {
                d(o.onClick)
            }
        };
    var e = function () {
            var i = m.getCurrentPage();
            m.gotoNextPage();
            if (i != m.getCurrentPage()) {
                d(o.onClick)
            }
        };
    var g = function () {
            var i = m.getCurrentPage();
            m.gotoLastPage();
            if (i != m.getCurrentPage()) {
                d(o.onClick)
            }
        };
    var l = function (q) {
            var r = m.getCurrentPage();
            var i = parseInt(q.getText());
            if (!isNaN(i)) {
                m.gotoPage(i)
            }
            if (r != m.getCurrentPage()) {
                d(o.onClick)
            }
        };
    var b = function (i) {
            var q = m.getCurrentPage();
            m.gotoPage(i);
            if (q != m.getCurrentPage()) {
                d(o.onClick)
            }
        };
    j.first.onClick = p;
    j.prev.onClick = c;
    j.next.onClick = e;
    j.last.onClick = g;
    j.input.onkeyup = b;
    var h;
    var f = j.getItemCount();
    var o = this;
    for (h = 0; h < f; h++) {
        var a = j.getItem(h);
        if (a) {
            a.onClick = l
        }
    }
};
var noOfPageIndexesToBeShown = 5;
var baseStartPageIndex = 1;
var currentPage_Pagination = 1;

function ctrlPagination(a, c, b, e) {
    baseStartPageIndex = 1;
    if (e > 1) {
        baseStartPageIndex = e
    }
    if (e) {
        currentPage_Pagination = e
    } else {
        currentPage_Pagination = 1;
        $(a).innerHTML = ""
    }
    if (c > 1) {
        var d = [];
        d.push("<div id='pagination_indexOnly'>" + findPageIndexes_pagination(a, b, c) + "</div>");
        if (document.getElementById(a)) {
            document.getElementById(a).innerHTML = d.join("")
        }
        if ($(a + "_pageNo_" + currentPage_Pagination)) {
            $(a + "_pageNo_" + currentPage_Pagination).className = "paginationHighlightedPage"
        }
    }
}

function findPageIndexes_pagination(a, b, f) {
    var g = [];
    prefixDiv = "";
    var h = 0;
    var d = (baseStartPageIndex + noOfPageIndexesToBeShown) - 1;
    h = (d > f) ? f : d;
    for (var c = baseStartPageIndex; c <= h; c++) {
        var e = "";
        if (c == h && h < f) {
            e = 'baseStartPageIndex++;loadPage_pagination("' + a + '",' + c + ',"' + b + '",' + f + ");"
        } else {
            if (c == baseStartPageIndex && baseStartPageIndex > 1) {
                e = 'baseStartPageIndex--;loadPage_pagination("' + a + '",' + c + ',"' + b + '",' + f + ");"
            } else {
                e = 'loadPage_pagination("' + a + '","' + c + '","' + b + '",' + f + ")"
            }
        }
        g.push("<a  id='" + a + "_pageNo_" + c + "' class='paginationNormalPage' onclick='");
        g.push(e);
        g.push(";return false;'>");
        g.push(c);
        g.push("</a> ")
    }
    if (h < f) {
        g.push("<a onclick='baseStartPageIndex++;loadPage_pagination(\"" + a + '",' + (currentPage_Pagination + 1) + ',"' + b + '",' + f + ");return false;'>" + g_js_strings.commonstr.next.toLowerCase() + "&gt;&gt;</a>")
    }
    if (baseStartPageIndex > 1) {
        prefixDiv += "<a onclick='baseStartPageIndex--;loadPage_pagination(\"" + a + '",' + (currentPage_Pagination - 1) + ',"' + b + '",' + f + ");return false;'> &lt;&lt;" + g_js_strings.commonstr.prev.toLowerCase() + " </a>"
    }
    return prefixDiv + g.join("")
}

function loadPage_pagination(divId, currentPage, callbackFunction, totalPages) {
    currentPage_Pagination = parseInt(currentPage);
    var fn = callbackFunction + "(" + currentPage_Pagination + ")";
    eval(fn);
    if ($("pagination_indexOnly")) {
        $("pagination_indexOnly").innerHTML = findPageIndexes_pagination(divId, callbackFunction, totalPages)
    }
    if ($(divId + "_pageNo_" + currentPage_Pagination)) {
        $(divId + "_pageNo_" + currentPage_Pagination).className = "paginationHighlightedPage"
    }
};
cm.ParseModel = function (d) {
    var a;
    var b = 5;

    function e() {
        a = {
            links: [],
            shopButtons: []
        }
    }

    function c(f, g, j) {
        var i = 0;
        do {
            var h = f.indexOf(g, i);
            if (h > -1) {
                i = h + 1;
                a[j][a[j].length] = f.substr(h + 5, b)
            }
        } while (h > -1)
    }
    return {
        parseTokens: function (f) {
            e();
            c(f, "SHOP_", "shopButtons");
            c(f, "LINK_", "links");
            return a
        }
    }
}(jQuery);

function resizeIframe(b, a) {
    var c = parseInt(a);
    if (c > 100) {
        if (b != "") {
            $(b).height = (c + 20) + "px"
        } else {
            $("paymentIFrame").height = (c + 30) + "px";
            $("paymentPage").height = (c + 30) + "px"
        }
    }
}
if (!window.Payment) {
    var Payment = new Object()
}
Payment.Properties = {
    c_payment_abbr_to_symbol: {
        USD: "&#36;",
        AUD: "&#36; AUD",
        CAD: "&#36; CAD",
        EUR: "&#128;",
        GBP: "&#163;",
        HKD: "&#36; HKD",
        NZD: "&#36; NZD",
        SGD: "&#36; SGD",
        JPY: "&#165;"
    },
    card: [],
    debitCardData: null,
    bankTransferData: null,
    payPalData: null,
    mobileData: null,
    packages: null,
    currency: "USD",
    offersData: null,
    otherData: [],
    optionOrder: [],
    selectedIndex: 0,
    isDefaultPaypal: false
};
Payment.Methods = {
    resetData: function () {
        this.selectedIndex = 0;
        this.card.creditCardData = [];
        this.debitCardData = null;
        this.bankTransferData = null;
        this.payPalData = null;
        this.mobileData = null;
        this.packages = null;
        this.currency = "USD";
        this.offersData = null;
        this.optionOrder = [];
        this.selectedIndex = 0;
        this.otherData = [];
        this.isDefaultPaypal = false
    },
    processPaymentXML: function () {
        var a = cm.PreloadedPaymentXMLService.getResult();
        if (a && a.ok) {
            if (cm.PreloadedPaymentXMLService.getVersion() == 2) {
                var b = a.data.paymentURL;
                this.paymentURL = b;
                if (b) {
                    Payment.renderPaymentModalV2(b)
                } else {
                    Modal.showAlert(g_js_strings.errorcode.err_default)
                }
            } else {
                var c = a.data;
                Payment.initializeData(c);
                Payment.renderPaymentModal()
            }
        } else {
            Modal.showAlert(g_js_strings.errorcode.err_default)
        }
    },
    startPaymentModal: function () {
        cm.flash.hideFlash();
        if (!cm.PreloadedPaymentXMLService.hasExpired()) {
            Payment.processPaymentXML()
        } else {
            var a = function (c) {
                    Payment.processPaymentXML()
                };
            var b = function (c) {
                    Modal.showAlert(g_js_strings.errorcode.err_default)
                };
            cm.PreloadedPaymentXMLService.makeRequest(null, {
                onSuccess: a,
                onFailure: b
            })
        }
    },
    initializeData: function (c) {
        this.resetData();
        var e = c["101"];
        if (!e) {
            return false
        }
        var a = Object.keys(e);
        for (var b = 0; b < a.length; b++) {
            var d = e[a[b]];
            switch (d.category) {
            case "Credit Cards":
                Payment.initCreditCardData(d);
                break;
            case "Debit Cards":
                Payment.initDebitCardData(d);
                break;
            case "PayPal":
                Payment.initPayPalData(d);
                break;
            case "Mobile":
                Payment.initMobileData(d);
                break;
            case "Offers":
                Payment.initOffersData(d);
                break;
            default:
                Payment.initOtherData(d);
                break
            }
        }
        Payment.initOptionOrder()
    },
    initOptionOrder: function () {
        var b = [];
        for (var a = 0; a < this.card.creditCardData.length; a++) {
            b.push(this.card.creditCardData[a])
        }
        if (this.payPalData) {
            b.push(this.payPalData)
        }
        if (this.debitCardData) {
            b.push(this.debitCardData)
        }
        if (this.mobileData) {
            b.push(this.mobileData)
        }
        if (this.otherData) {
            for (var c = 0; c < this.otherData.length; c++) {
                b.push(this.otherData[c])
            }
        }
        this.optionOrder = b
    },
    initOtherData: function (a) {
        this.otherData.push(a)
    },
    initCreditCardData: function (a) {
        this.card.creditCardData[this.card.creditCardData.length] = a
    },
    initDebitCardData: function (a) {
        if ((this.debitCardData && parseInt(this.debitCardData.ranking) > parseInt(a.ranking)) || !this.debitCardData) {
            this.debitCardData = a
        }
    },
    initPayPalData: function (a) {
        if ((this.payPalData && parseInt(this.payPalData.ranking) > parseInt(a.ranking)) || !this.payPalData) {
            this.payPalData = a
        }
    },
    initMobileData: function (a) {
        if ((this.mobileData && parseInt(this.mobileData.ranking) > parseInt(a.ranking)) || !this.mobileData) {
            this.mobileData = a
        }
    },
    initOffersData: function (a) {
        if ((this.offersData && parseInt(this.offersData.ranking) > parseInt(a.ranking)) || !this.offersData) {
            this.offersData = a
        }
    },
    renderPaymentModalV2: function (b) {
        var d = "paymentIFrame";
        if ($(d)) {
            return
        }
        var c = '<div class="modalBody" id="paymentPage">  <iframe style="background-color: transparent; margin-left: -2px; border: medium none;" width="760px" id="paymentIFrame" name="paymentIFrame" allowtransparency="true" frameborder="0"></iframe></div>';
        if (g_modal == 3) {
            var a = "directLinkOverride"
        }
        Modal.show({
            winWidth: 740,
            winHeight: 400,
            winLeft: 10,
            winTop: 10,
            winTitle: g_js_strings.modaltitles.getmoregems,
            winContent: c,
            callback: function () {
                modal_getgems_open();
                cm.IframeUtil.post("paymentIFrame", b)
            },
            shutdown: cm.flash.showFlash,
            o: {
                additionalClass: a
            }
        })
    },
    renderPaymentModal: function () {
        var a = [];
        a.push("<div id='modal_getgemsdiv'>");
        a.push(this.getTopHtml());
        a.push("<div class='payoptions clearfix'>");
        a.push(this.getOptionListHtml());
        a.push(this.getPackagesHtml());
        a.push("</div>");
        a.push("</div>");
        try {
            if (g_trackingPixels.paymentV1Modal.length) {
                a.push("<iframe src='" + g_trackingPixels.paymentV1Modal + "' width='0' height='0' frameborder='0'></iframe>")
            }
        } catch (b) {}
        Modal.show({
            winWidth: 740,
            winHeight: 400,
            winLeft: 10,
            winTop: 10,
            winTitle: g_js_strings.modaltitles.getmoregems,
            winContent: a.join(""),
            callback: modal_getgems_open,
            shutdown: cm.flash.showFlash
        })
    },
    modalGetPackages: function () {
        var d = null;
        var b = 0;
        this.isDefaultPaypal = false;
        if ((this.optionOrder.length > 0) && ("EUR" == this.optionOrder[0].currency)) {
            for (b = this.optionOrder.length - 1; b; --b) {
                if ("paypal" == this.optionOrder[b].method) {
                    d = this.optionOrder[b].campaigns;
                    this.isDefaultPaypal = true;
                    break
                }
            }
        }
        if (null == d) {
            d = this.optionOrder[0].campaigns
        }
        var a = Object.keys(d);
        var c = [];
        for (b = 0; b < a.length; b++) {
            if (d[a[b]].packageId) {
                c.push(d[a[b]])
            }
        }
        return c
    },
    getPackagesHtml: function () {
        var a = this.modalGetPackages();
        var h = [];
        var b = 0;
        var k = 0;
        var j = 0;
        var c = "";
        var f = 0;
        var p = "";
        var l = false;
        h.push("<div class='promolist'>");
        for (var g = 0; g < a.length; g++) {
            b = parseInt(a[g].base) + parseInt(a[g].bonus);
            k = a[g].price;
            j = a[g].msrpPrice;
            if (j != k) {
                l = true
            } else {
                l = false
            }
            c = a[g].url;
            f = a[g].packageChestId;
            p = this.c_payment_abbr_to_symbol[a[g].currency] || a[g].currency;
            var n, e = "";
            if (l) {
                n = g_js_strings.modal_getgems.purchaseafordiscount.replace("%1$s", b).replace("%2$s", parseInt(j)).replace(/%3\$s/g, p).replace("%4$s", k);
                var m = parseInt((parseFloat(j) - parseFloat(k)) / parseFloat(j) * 100);
                e = "saleTag" + m
            } else {
                n = g_js_strings.modal_getgems.purchaseaforb.replace("%1$s", b).replace("%2$s", k).replace("%3$s", p)
            }
            var o = '				<div class="packageContainer package#{chestId} #{onsale}" onclick="cm.ConversionTracker.track(\'payments\', \'PAYMENT_BUY_PACKAGE\', \'PACKAGE#{index1}\');Payment.gotoIframe(\'#{iframeUrl}\',#{cents},#{index0});return false;" onmouseout="removeTooltip();return false;" onmouseover="Payment.doPackageTooltip(#{index0},this,event);">			    <div class="rightColumn"></div>			    <div class="leftColumn">			        <div class="packageName">#{name}</div>			        <div class="packageDescription">#{description}</div>			        <a class="packageButton"><span class="innerContainer">#{buttonText}</span></a><span class="#{saleTag}">&nbsp;</span>			    </div>			</div>			';
            packageInfo = {
                chestId: f,
                onsale: (l ? "onsale" : ""),
                index0: g,
                index1: g + 1,
                iframeUrl: c,
                cents: a[g].cents,
                name: itemlist["i" + f].name,
                description: itemlist["i" + f].description,
                buttonText: n,
                saleTag: e
            };
            var d = new Template(o).evaluate(packageInfo);
            h.push(d)
        }
        h.push("</div>");
        return h.join("")
    },
    doPackageTooltip: function (d, g, a) {
        var c = this.modalGetPackages();
        var b = c[d].packageContents;
        var f = Object.keys(b);
        var e = new Array();
        for (i = 0; i < f.length; i++) {
            e.push("<div style='padding-bottom:2px;'><b>x");
            e.push(b[f[i]].quantity);
            e.push("</b> - ");
            e.push(b[f[i]].name);
            e.push("</div>")
        }
        showTooltip(e.join(""), g, a, "mainbody")
    },
    getTopHtml: function () {
        var c = "";
        for (var b = 0; b < this.optionOrder.length; ++b) {
            c += this.optionOrder[b].category;
            if (b < (this.optionOrder.length - 2)) {
                c += g_js_strings.modal_getgems.itemseparator
            } else {
                if (b < (this.optionOrder.length - 1)) {
                    c += g_js_strings.modal_getgems.itemseparatorlast
                }
            }
        }
        var a = [];
        a.push("<div class='paytitle'>" + g_js_strings.modal_getgems.purchasegemstitle + "</div>");
        a.push("<div class='paydescription'>" + g_js_strings.modal_getgems.purchasegemsdescription.replace("%1$s", c) + "</div>");
        return a.join("")
    },
    getOptionListHtml: function () {
        var c = [];
        c.push("<div class='optionlist'>");
        c.push("<div class='directlist'>");
        c.push("<div class='directlisthd'>" + g_js_strings.modal_getgems.gemsdirect + "</div>");
        c.push("<div id='gemsdirectpurchasedrop'>");
        c.push("<select id='gemsdirectselect'>");
        var f = this.optionOrder[0].campaigns;
        var e = Object.keys(f);
        for (var b = 0; b < e.length; b++) {
            var h = this.c_payment_abbr_to_symbol[f[e[b]].currency] || f[e[b]].currency;
            var d = f[e[b]].price;
            if (parseInt(f[e[b]].level) != 0) {
                c.push("<option value='" + e[b] + "' selected>")
            } else {
                c.push("<option value='" + e[b] + "'>")
            }
            c.push(f[e[b]].gems + " " + g_js_strings.commonstr.gems + " (" + h + d + ")");
            c.push("</option>")
        }
        c.push("</select>");
        c.push("</div>");
        for (var b = 0; b < this.optionOrder.length; b++) {
            var g = (b == 0) ? "checked" : "";
            c.push("<div class='payopt'><input type='radio' name='gemsdirect' value='" + b + "' " + g + " onclick='Payment.selectOption(this);' onchange='Payment.selectOption(this);'/><label for='gemsdirect1'>");
            c.push("<img src='");
            c.push(this.optionOrder[b].asset);
            c.push("'/></label></div>")
        }
        c.push("<div class='pnow clearfix'><a  class='button20' onclick='Payment.gotoIframe();return false;'><span>" + g_js_strings.modal_getgems.purchasenow + "</span></a></div>");
        c.push("</div>");
        c.push("<div class='otherway'>");
        c.push("<div class='otherwayhd'>" + g_js_strings.modal_getgems.gemoffer + "</div>");
        if (this.offersData && this.offersData.campaigns) {
            var j = Object.keys(this.offersData.campaigns)[0];
            var a = this.offersData.campaigns[j].url;
            c.push('<div class=\'pnow\'><a onclick=\'cm.ConversionTracker.track("payments", "PAYMENT_SEE_OFFERS2", "");Payment.gotoBigIframe("' + a + "\");return false;'>" + g_js_strings.modal_getgems.obtaindesc + "</a></div>")
        }
        c.push("</div>");
        c.push("</div>");
        return c.join("")
    },
    gotoIframe: function (l, a, c, d) {
        removeTooltip();
        var g = false;
        if (l) {
            var b = l;
            var f = a || null;
            g = this.isDefaultPaypal || d
        } else {
            var m = $("gemsdirectselect").value;
            var b = this.optionOrder[this.selectedIndex].campaigns[m].url;
            var f = this.optionOrder[this.selectedIndex].campaigns[m].cents || null;
            g = (this.optionOrder[this.selectedIndex].category == "Debit Cards" || this.optionOrder[this.selectedIndex].category == "PayPal") ? true : false;
            var e = ["PAYMENT_CREDIT_CARD", "PAYMENT_PAYPAL2", "PAYMENT_MOBILE2"];
            cm.ConversionTracker.track("payments", e[this.selectedIndex], "")
        }
        var h = "_blank";
        if (!g) {
            h = "payment_iframe";
            var k = [];
            k.push("<div class=\"goback\"><a onclick=\"cm.ConversionTracker.track('payments', 'PAYMENT_TRIALPAY_BACK', '');Modal.hideModal();Payment.startPaymentModal();return false;\">" + g_js_strings.modal_getgems_direct.backtogem + "</a></div>");
            if (parseInt(c) >= 0) {
                var j = Payment.modalGetPackages()[c];
                k.push("<div class='promobanner clearfix'");
                k.push(">");
                k.push("<img src='");
                k.push(stimgUrl);
                k.push("img/payments/chests/");
                k.push(j.packageChestId);
                k.push(".png'/>");
                k.push("<div class='promoinfo'>");
                k.push("<div class='nm'>" + j.packageName + "</div>");
                k.push("<div class='desc'>" + j.packageDescription + "</div>");
                k.push("</div>");
                k.push("</div>")
            }
            if (f && Payment.payPalData) {
                k.push("<div class='paybypaypal'><a onclick='Payment.gotoIframe(Payment.getPayPalLink(" + f + "), undefined, undefined, true);return false;'>");
                k.push("<img src='");
                k.push(stimgUrl);
                k.push("img/paypal.jpg'/> " + g_js_strings.modal_getgems_direct.clickforpaypal + "</a></div>")
            }
            k.push('<div id="payment_iframe_loading" style="width:600px;height:585px;margin:20px 0 15px 55px;overflow:hidden;"><div style="margin: 50px;text-align:center;font-size: 20px;"><img src="' + stimgUrl + 'img/spinny.gif" /></div></div>');
            k.push('<iframe name="payment_iframe" id="payment_iframe" width="600" height="585" scrolling="no" frameborder="0" style="display:none; margin:20px 0 15px 55px;"></iframe>');
            if (undefined == cm.features.NO_RIGHTNOW_CRM || "true" == cm.features.NO_RIGHTNOW_CRM) {
                k.push("<div class='phone'>Have a question? Contact us at (877) 399-6537</div>")
            } else {
                k.push("<div class='phone'><a onclick='HelpDesk.show();return false;'>");
                k.push(g_js_strings.modal_getgems_direct.needassistance);
                k.push("</a></div>")
            }
            $("modal_getgemsdiv").innerHTML = k.join("");
            $("payment_iframe").observe("load", this.gotoIframeDone)
        }
        cm.IframeUtil.post(h, b)
    },
    gotoBigIframe: function (a) {
        this.gotoIframe(a)
    },
    gotoIframeDone: function (a) {
        $("payment_iframe").stopObserving("load", this.gotoIframeDone);
        $("payment_iframe_loading").hide();
        $("payment_iframe").show()
    },
    getPayPalLink: function (d) {
        var e = Payment.payPalData.campaigns;
        var a = Object.keys(e);
        var c = "";
        for (var b = 0; b < a.length; b++) {
            if (parseInt(e[a[b]].cents) == parseInt(d)) {
                return e[a[b]].url
            } else {
                if (parseInt(e[a[b]].level) != 0) {
                    c = e[a[b]].url
                }
            }
        }
        return c
    },
    selectOption: function (h) {
        this.selectedIndex = h.value;
        var g = this.optionOrder[h.value].campaigns;
        var b = Object.keys(g);
        var d = [];
        d.push("<select id='gemsdirectselect'>");
        for (var c = 0; c < b.length; c++) {
            var e = g[b[c]].price;
            var a = g[b[c]].cents;
            var f = this.c_payment_abbr_to_symbol[g[b[c]].currency] || g[b[c]].currency;
            if (parseInt(g[b[c]].level) != 0) {
                d.push("<option value='" + b[c] + "' selected>")
            } else {
                d.push("<option value='" + b[c] + "'>")
            }
            d.push(g[b[c]].gems + " " + g_js_strings.commonstr.gems + " (" + f + e + ")");
            d.push("</option>")
        }
        d.push("</select>");
        $("gemsdirectpurchasedrop").innerHTML = d.join("")
    }
};
Object.extend(Payment, Payment.Methods);
Object.extend(Payment, Payment.Properties);

function modal_getgems() {
    if (cm.util.preventDoubleClick("modal_getgems")) {
        return false
    }
    if (false) {
        seed.player.entryTag = "swaves";
        g_locale = "zh_CN"
    }
    Payment.startPaymentModal()
}

function modal_getgems_geturls() {
    var params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/trialpayUrls.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                g_offerPaymentUrl = rslt.data.offer;
                g_paymentDirectUrls = rslt.data.quickpay;
                modal_getgems_pt2()
            } else {}
        },
        onFailure: function () {}
    })
}
var g_promos = null;

function modal_getgems_getbonusgems(a) {
    switch (parseInt(a)) {
    case 5:
        return 0;
        break;
    case 10:
        return 0;
        break;
    case 20:
        return 0;
        break;
    case 30:
        return 0;
        break;
    case 50:
        return 25;
        break;
    case 100:
        return 100;
        break;
    case 250:
        return 300;
        break;
    case 500:
        return 750;
        break
    }
}

function modal_getgems_packagetooltip(e, h, a) {
    var b = g_promos[e].itemsInPackage;
    var g = new Object();
    var f = new Array();
    for (c = 0; c < b.length; c++) {
        if (g["i" + b[c]]) {
            g["i" + b[c]]++
        } else {
            g["i" + b[c]] = 1
        }
    }
    var d = Object.keys(g);
    for (var c = 0; c < d.length; c++) {
        f.push("<div style='padding-bottom:2px;'><b>x");
        f.push(g[d[c]]);
        f.push("</b> - ");
        f.push(itemlist[d[c]].name);
        f.push("</div>")
    }
    showTooltip(f.join(""), h, a, "mainbody")
}

function modal_getgems_pt2() {
    isswaves = true;
    var shophtml = new Array();
    var params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/promos.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                g_promos = rslt.data;
                shophtml.push("<div id='modal_getgemsdiv'>");
                if (!isswaves) {
                    shophtml.push("<div class='creditcard'>" + g_js_strings.modal_getgems.purchasegems + "<img src='");
                    shophtml.push(stimgUrl);
                    shophtml.push("img/creditcards.gif'/><img src='");
                    shophtml.push(stimgUrl);
                    shophtml.push("img/paypal.jpg'/></div>");
                    shophtml.push("<div class='currencyinfo'>(" + g_js_strings.modal_getgems.pricesshown.replace("%1$s", g_paymentCurrency) + ")</div>")
                } else {
                    shophtml.push("<div class='creditcard'>" + g_js_strings.modal_getgems.selectbundle + ":</div>")
                }
                shophtml.push("<div class='payoptions clearfix'>");
                var promopts = new Array();
                var curprice = 9999;
                var promolist = Object.keys(g_promos);
                for (var i = 0; i < promolist.length; i++) {
                    var gemreq = parseInt(g_promos[promolist[i]].gemsRequired);
                    if (gemreq != curprice) {
                        promopts.push(promolist[i]);
                        curprice = gemreq
                    }
                }
                if (promopts.length > 1) {
                    if (parseInt(g_promos[promopts[0]].gemsRequired) < parseInt(g_promos[promopts[1]].gemsRequired)) {
                        promopts.reverse()
                    }
                }
                if (!isswaves) {
                    shophtml.push("<div class='promolist'>");
                    promopts.reverse();
                    for (var i = 0; i < promopts.length; i++) {
                        var gemreq = parseInt(g_promos[promopts[i]].gemsRequired);
                        var price = modal_getgems_gemprice_nobonus(gemreq);
                        var bonus = modal_getgems_gembonus_nobonus(gemreq);
                        var totalgemreq = gemreq + bonus;
                        shophtml.push("<a  class='gembtn' onclick='modal_getgems_direct(1," + totalgemreq + ");return false;' onmouseout='removeTooltip();return false;' onmouseover='modal_getgems_packagetooltip(" + promopts[i] + ",this,event);'>");
                        shophtml.push("<img src='");
                        shophtml.push(stimgUrl);
                        shophtml.push("img/trialpay/");
                        shophtml.push(g_promos[promopts[i]].itemId);
                        shophtml.push(".png' class='packagepic'/>");
                        shophtml.push("<div class='packageinfo'><div class='ttl'>");
                        shophtml.push(itemlist["i" + g_promos[promopts[i]].itemId].name);
                        shophtml.push("</div><div class='desc'>");
                        shophtml.push(g_promos[promopts[i]].description);
                        shophtml.push("</div></div>");
                        shophtml.push("<div class='pricing'>");
                        shophtml.push(g_js_strings.modal_getgems.purchaseaforb.replace("%1$s", g_promos[promopts[i]].gemsRequired).replace("%2$s", price).replace("%3$s", g_paymentSymbol));
                        shophtml.push("</div>");
                        if (bonus > 0) {
                            shophtml.push("<div class='bonus'><b>+");
                            shophtml.push(bonus);
                            shophtml.push("</b>" + g_js_strings.modal_getgems.bonusgems + "</div>")
                        }
                        shophtml.push("</a>")
                    }
                    shophtml.push("</div>")
                } else {
                    shophtml.push("<table style='text-align:left;margin:0 auto 5px auto;'>");
                    for (var i = 0; i < promopts.length; i++) {
                        shophtml.push("<tr style='font-size:14px;' onmouseover='modal_getgems_packagetooltip(" + promopts[i] + ",this,event);' onmouseout='removeTooltip();return false;'><td style='height:40px;'>");
                        var price = parseInt(g_promos[promopts[i]].gemsRequired) / 10;
                        shophtml.push("<b>" + g_js_strings.commonstr.purchase + " " + g_promos[promopts[i]].gemsRequired);
                        shophtml.push("&nbsp;<img src='");
                        shophtml.push(stimgUrl);
                        shophtml.push("img/gem.png' style='margin-bottom:-3px;'/></b>");
                        shophtml.push("</td><td style='font-weight:bold;font-size:16px;padding:0 5px;'>+</td><td>" + g_js_strings.commonstr.get + " ");
                        shophtml.push(" 1");
                        shophtml.push("<img style='height:35px;width:32px;margin:0 5px -15px 5px;' src='");
                        shophtml.push(stimgUrl);
                        shophtml.push("img/trialpay/");
                        shophtml.push(g_promos[promopts[i]].itemId);
                        shophtml.push(".png'/>");
                        shophtml.push(g_promos[promopts[i]].name);
                        shophtml.push("</td></tr>")
                    }
                    shophtml.push("</table>");
                    shophtml.push("<div style='font-size:10px;'>*" + g_js_strings.modal_getgems.singletransact + "</div>")
                }
                if (!isswaves) {
                    shophtml.push("<div class='directlist'>");
                    shophtml.push("<div class='directlisthd'>" + g_js_strings.modal_getgems.gemsdirect + "</div>");
                    shophtml.push("<div id='gemsdirectpurchasedrop'>");
                    shophtml.push("<select id='gemsdirectselect'>");
                    var gemcounts = Object.keys(g_paymentDirectUrls[2]);
                    for (var i = 0; i < gemcounts.length; i++) {
                        if (parseInt(gemcounts[i]) == 300) {
                            shophtml.push("<option value='" + gemcounts[i] + "' selected>")
                        } else {
                            shophtml.push("<option value='" + gemcounts[i] + "'>")
                        }
                        shophtml.push(gemcounts[i] + " " + g_js_strings.commonstr.gems + " (" + g_paymentSymbol + g_paymentDirectUrls[2][gemcounts[i]].price + ")");
                        shophtml.push("</option>")
                    }
                    shophtml.push("</select>");
                    shophtml.push("</div>");
                    shophtml.push("<div id='gemsmobilepurchasedrop' style='display:none;'></div>");
                    shophtml.push("<div class='payopt'><input type='radio' name='gemsdirect' value='1' checked id='gemsdirect1' onclick='modal_getgems_mobile_unselect();' onchange='modal_getgems_mobile_unselect();'/><label for='gemsdirect1'><img src='");
                    shophtml.push(stimgUrl);
                    shophtml.push("img/creditcards.gif'/></label></div>");
                    shophtml.push("<div class='payopt'><input type='radio' name='gemsdirect' value='2' id='gemsdirect2' onclick='modal_getgems_mobile_unselect();' onchange='modal_getgems_mobile_unselect();'/><label for='gemsdirect2'><img src='");
                    shophtml.push(stimgUrl);
                    shophtml.push("img/paypal.jpg'/></label></div>");
                    if (g_paymentMobileCheck == 1) {
                        shophtml.push("<div class='payopt mobi'><input type='radio' name='gemsdirect' value='2' id='gemsdirect3' onclick='modal_getgems_mobile_select();' onchange='modal_getgems_mobile_select();'/><label for='gemsdirect3'><img src='");
                        shophtml.push(stimgUrl);
                        shophtml.push("img/icon_mobile.png' class='mobi'/>" + g_js_strings.modal_getgems.obtainmobile + "</label></div>")
                    }
                    if (g_paymentMobileCheck == 1 || g_paymentMobileLinkTarget == 2) {
                        modal_getgems_mobile_init()
                    }
                    shophtml.push("<div class='pnow clearfix'><a  class='button20' onclick='modal_getgems_purchasedirect();return false;'><span>" + g_js_strings.modal_getgems.purchasenow + "</span></a></div>");
                    shophtml.push("<div class='pnow'><a href='" + appUrl + "?page=payment' target='_blank'>" + g_js_strings.modal_getgems.obtaindesc + "</a></div>");
                    if (g_paymentMobileLinkTarget == 1) {
                        shophtml.push("<div class='pnow'><b>" + g_js_strings.modal_getgems.ordash + "</b>&nbsp;<a href='" + g_paymentMobile + "' target='_blank'>" + g_js_strings.modal_getgems.obtainmobile + "</a></div>")
                    } else {
                        if (g_paymentMobileLinkTarget == 2) {
                            shophtml.push("<div class='pnow' id='modal_getgems_mobilelink1' style='display:none;'><b>" + g_js_strings.modal_getgems.ordash + "</b>&nbsp;<a onclick='modal_getgems_mobilepopup();return false;' href='#'>" + g_js_strings.modal_getgems.obtainmobile + "</a></div>")
                        }
                    }
                    if (g_gashurl.length > 0 && seed.player.entryTag.substr(0, 6) == "swaves") {
                        shophtml.push("<div class='pnow'><b>" + g_js_strings.modal_getgems.ordash + "</b>&nbsp;<a href='#' onclick='modal_getgems_offers(1);return false;'>" + g_js_strings.modal_getgems.linkgashmycard + "</a></div>");
                        shophtml.push("<div class='pnow'><a href='#' onclick='modal_getgems_offers(1);return false;'><img src='" + stimgUrl + "img/logo_gash.gif'/></a></div>");
                        shophtml.push("<div class='pnow'><a href='#' onclick='modal_getgems_offers(1);return false;'><img src='" + stimgUrl + "img/logo_mycard.gif'/></a></div>")
                    }
                    shophtml.push("</div>")
                }
                shophtml.push("</div>");
                if (!isswaves) {
                    shophtml.push("<div class='takeoffers'><b>" + g_js_strings.modal_getgems.ordash + "</b>");
                    if (g_paymentFlow == "newwindow") {
                        shophtml.push("<a href='" + appUrl + "?page=payment' target='_blank'>" + g_js_strings.modal_getgems.obtainmobiledesc + "</a>")
                    } else {
                        if (g_paymentFlow == "replacewindow") {
                            shophtml.push("<a href='" + appUrl + "?page=payment' target='_top'>" + g_js_strings.modal_getgems.obtainmobiledesc + "</a>")
                        } else {
                            if (g_paymentFlow == "modaloverlay") {
                                shophtml.push("<a href='#' onclick='modal_getgems_offers();return false;'>" + g_js_strings.modal_getgems.obtainmobiledesc + "</a>")
                            } else {
                                shophtml.push("<a href='" + appUrl + "?page=payment' target='_blank'>" + g_js_strings.modal_getgems.obtainmobiledesc + "</a>")
                            }
                        }
                    }
                    shophtml.push("</div>");
                    if (g_paymentMobileLinkTarget == 1) {
                        shophtml.push("<div class='takeoffers' style='padding-top:0;'><b>" + g_js_strings.modal_getgems.ordash + "</b><a href='" + g_paymentMobile + "' target='_blank'>" + g_js_strings.modal_getgems.obtainmobile + "</a></div>")
                    } else {
                        if (g_paymentMobileLinkTarget == 2) {
                            shophtml.push("<div class='takeoffers' id='modal_getgems_mobilelink2' style='display:none;padding-top:0;'><b>" + g_js_strings.modal_getgems.ordash + "</b><a href='#' onclick='modal_getgems_mobilepopup();return false;'>" + g_js_strings.modal_getgems.obtainmobile + "</a></div>")
                        }
                    }
                    if (g_gashurl.length > 0) {
                        shophtml.push("<div class='takeoffers' style='padding-top:0;'><b>" + g_js_strings.modal_getgems.ordash + "</b><a href='#' onclick='modal_getgems_offers(1);return false;'>GASH & MyCard</a></div>")
                    }
                }
                shophtml.push("</div>");
                if (isswaves) {
                    var custom = "serverid%3D" + g_server + "%26productid%3D101"
                }
                Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.getmoregems, shophtml.join(""), modal_getgems_open)
            }
        },
        onFailure: function () {}
    })
}

function modal_getgems_gemprice(a) {
    return g_paymentDirectUrls[2][a].price
}

function modal_getgems_gemprice_nobonus(a) {
    return g_paymentDirectUrls[2][parseInt(a + modal_getgems_gembonus_nobonus(a))].price
}

function modal_getgems_gembonus(a) {
    switch (parseInt(a)) {
    case 525:
        return 25;
        break;
    case 1100:
        return 100;
        break;
    case 2800:
        return 300;
        break;
    case 5570:
        return 570;
        break;
    default:
        return 0;
        break
    }
}

function modal_getgems_gembonus_nobonus(a) {
    switch (parseInt(a)) {
    case 500:
        return 25;
        break;
    case 1000:
        return 100;
        break;
    case 2500:
        return 300;
        break;
    case 5000:
        return 570;
        break;
    default:
        return 0;
        break
    }
}

function modal_getgems_purchasedirect() {
    if ($("gemsdirect1").checked) {
        modal_getgems_direct(1, $("gemsdirectselect").value)
    } else {
        if ($("gemsdirect2").checked) {
            var a = modal_getgems_directpayurl(2, $("gemsdirectselect").value);
            a += user_id + "&server_id=" + g_server;
            window.open(a)
        } else {
            if ($("gemsdirect3").checked) {
                modal_getgems_purchasemobile($("gemsmobileselect").value)
            }
        }
    }
}

function modal_getgems_purchasemobile(b) {
    var a = new Array();
    Modal.showModal(740, 400, 10, 10, "Get Gems", a.join(""))
}

function modal_getgems_goback() {
    Modal.hideModal();
    modal_getgems()
}

function modal_getgems_directpayurl(a, b) {
    if (parseInt(a) == 1) {
        return g_paymentDirectUrls[2][b].url
    } else {
        if (parseInt(a) == 2) {
            return g_paymentDirectUrls[3][b].url
        }
    }
}

function modal_getgems_direct(e, g) {
    removeTooltip();
    var c = new Array();
    c.push('<div class="goback"><a onclick="modal_getgems_goback();return false;">' + g_js_strings.modal_getgems_direct.backtogem + "</a></div>");
    var a = Object.keys(g_promos);
    var b = null;
    var f = 0;
    for (var d = 0; d < a.length; d++) {
        if (parseInt(g_promos[a[d]].gemsRequired) <= g) {
            b = g_promos[a[d]];
            f = a[d];
            break
        }
    }
    if (b != null) {
        c.push("<div class='promobanner clearfix'");
        c.push(">");
        c.push("<img src='");
        c.push(stimgUrl);
        c.push("img/trialpay/");
        c.push(b.itemId);
        c.push(".png'/>");
        c.push("<div class='promoinfo'>");
        c.push("<div class='nm'>" + b.name + "</div>");
        c.push("<div class='desc'>" + b.description + "</div>");
        c.push("</div>");
        c.push("</div>")
    }
    if (e == 1) {
        c.push("<div class='paybypaypal'><a href='");
        c.push("' target='_blank'><img src='");
        c.push(stimgUrl);
        c.push("img/paypal.jpg'/> " + g_js_strings.modal_getgems_direct.clickforpaypal + "</a></div>")
    }
    c.push("<div class='phone'>Have a question? Contact us at (877) 399-6537</div>");
    $("modal_getgemsdiv").innerHTML = c.join("")
}

function modal_getgems_mobile_unselect() {
    $("gemsdirectpurchasedrop").show();
    $("gemsmobilepurchasedrop").hide()
}

function modal_getgems_mobile_select() {
    $("gemsdirectpurchasedrop").hide();
    $("gemsmobilepurchasedrop").show()
}

function modal_getgems_mobile_init() {
    var params = Object.clone(g_ajaxparams);
    var profiler = new cm.Profiler("ResponseTime", "paymentXml.php");
    new Ajax.Request(g_ajaxpath + "ajax/paymentXml.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            profiler.stop();
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                var groups = Object.keys(rslt.data);
                for (var g = 0; g < groups.length; g++) {
                    if (g_paymentMobileCheck == 1 && rslt.data[groups[g]].method == "bokuStatic") {
                        var campaigns = Object.keys(rslt.data[groups[g]].campaigns);
                        var selecthtml = new Array();
                        selecthtml.push("<select id='gemsmobileselect'>");
                        var selindex = 0;
                        var overtwenty = false;
                        for (var i = 0; i < campaigns.length; i++) {
                            selecthtml.push("<option value='");
                            selecthtml.push(rslt.data[groups[g]].campaigns[campaigns[i]].url);
                            selecthtml.push("'>");
                            selecthtml.push(rslt.data[groups[g]].campaigns[campaigns[i]].gems + " " + g_js_strings.commonstr.gems + " (" + g_paymentSymbol + rslt.data[groups[g]].campaigns[campaigns[i]].price + ")");
                            selecthtml.push("</option>");
                            if (!overtwenty) {
                                if (parseInt(rslt.data[groups[g]].campaigns[campaigns[i]].gems) <= 200) {
                                    selindex = i
                                }
                            }
                            if (parseInt(rslt.data[groups[g]].campaigns[campaigns[i]].gems) >= 200) {
                                overtwenty = true
                            }
                        }
                        selecthtml.push("</select>");
                        $("gemsmobilepurchasedrop").innerHTML = selecthtml.join("");
                        $("gemsmobileselect").selectedIndex = selindex;
                        if (g_paymentMethod == 1) {
                            $("gemsdirect3").checked = true;
                            modal_getgems_mobile_select()
                        }
                    } else {
                        if (g_paymentMobileLinkTarget == 2 && rslt.data[groups[g]].method == "bokuAutoPreset") {
                            var campaigns = Object.keys(rslt.data[groups[g]].campaigns);
                            var preseturl = rslt.data[groups[g]].campaigns[campaigns[0]].url;
                            if ($("modal_getgems_mobilelink1")) {
                                $("modal_getgems_mobilelink1").setAttribute("name", preseturl);
                                $("modal_getgems_mobilelink1").show()
                            }
                            if ($("modal_getgems_mobilelink2")) {
                                $("modal_getgems_mobilelink2").setAttribute("name", preseturl);
                                $("modal_getgems_mobilelink2").show()
                            }
                        }
                    }
                }
            } else {}
        },
        onFailure: function () {
            profiler.stop()
        }
    })
}

function modal_getgems_mobilepopup() {
    var b = "";
    if ($("modal_getgems_mobilelink1")) {
        b = $("modal_getgems_mobilelink1").getAttribute("name")
    } else {
        if ($("modal_getgems_mobilelink2")) {
            b = $("modal_getgems_mobilelink2").getAttribute("name")
        }
    }
    if (b.length > 0) {
        var a = new Array();
        Modal.showModal(740, 600, 10, 10, g_js_strings.modal_getgems.obtainmobile, a.join(""))
    }
}

function modal_getgems_offers(b) {
    var a = new Array();
    a.push('<div class="goback"><a  onclick="modal_getgems_goback();return false;">' + g_js_strings.modal_getgems_direct.backtogem + "</a></div>");
    $("modal_getgemsdiv").innerHTML = a.join("")
}

function modal_getgems_open() {
    if ($("modalControlsClose2")) {
        Event.observe("modalControlsClose2", "click", modal_getgems_check)
    } else {
        if ($("modalControlsClose1")) {
            Event.observe("modalControlsClose1", "click", modal_getgems_check)
        }
    }
    cm.ConversionTracker.track("payments", "PAYMENT_MODAL_LOADED", "")
}
var g_getgems_chk = 0;

function modal_getgems_check() {
    new PeriodicalExecuter(function (pe) {
        if (g_getgems_chk > 20) {
            g_getgems_chk = 0;
            pe.stop()
        } else {
            g_getgems_chk++;
            var params = Object.clone(g_ajaxparams);
            new Ajax.Request(g_ajaxpath + "ajax/getGems.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        if (parseInt(rslt.data) > parseInt(seed.player.gems)) {
                            alert(g_js_strings.modal_getgems_check.gemsupdated);
                            seed.player.gems = parseInt(rslt.data);
                            if ($("modal_shop_gems")) {
                                $("modal_shop_gems").innerHTML = rslt.data
                            }
                            $("kochead_gems").innerHTML = seed.player.gems;
                            g_getgems_chk = 0;
                            pe.stop();
                            cm.CRMLink.update()
                        }
                    } else {}
                },
                onFailure: function () {}
            })
        }
    }, 30)
};
var cm = cm || {};
cm.Player = function (e) {
    cm.CustomEventDispatcher.call(this);
    var j = this;
    var g;
    var b;
    var f;
    var i;
    var m;
    var d;
    var l;
    var c = function (n) {
            return d < n
        };
    this.getTitle = function () {
        return m
    };
    this.setMight = function (p) {
        g = p;
        var n = cm.LevelUtil.getUserLevel(p);
        if (!cm.TutorialManager.inTutorialMode() && !b && c(n.level)) {
            b = true;
            i = d;
            f = m;
            d = n.level;
            m = n.title;
            var o = cm.LevelUtil.getQuestId(d);
            l.claim(o)
        }
    };
    this.getLevel = function () {
        return d
    };
    this.getMight = function () {
        return g
    };
    var k = function (q) {
            var o;
            for (o = i; o <= d; o++) {
                var n = cm.LevelUtil.getQuestId(o);
                seed.quests["q" + n] = 1
            }
            b = false;
            var p = new cm.PlayerEvent(cm.PlayerEvent.LEVEL_INCREASED);
            p.setTarget(j);
            p.setPreviousState({
                level: i,
                title: f
            });
            j.dispatchCustomEvent(p)
        };
    var a = function (n) {
            d = i;
            m = f;
            b = false
        };
    var h = function () {
            d = parseInt(e.level);
            b = false;
            l = new cm.LevelUpReward();
            l.addEventListener(cm.RewardEvent.SUCCESS, k);
            l.addEventListener(cm.RewardEvent.FAILURE, a)
        };
    h()
};
cm.OOP.inherits(cm.Player, cm.CustomEventDispatcher);
cm.PlayerController = function (a) {
    var c = function (h) {
            if (!cm.TutorialManager.inTutorialMode()) {
                var m = h.getTarget();
                var l = h.getPreviousState();
                var d = cm.LevelUtil.getLevelUpRewards(l.level, m.getLevel());
                var f = parseInt(seed.player.avatarId) > 6 ? ".jpg" : ".png";
                var j = seed.player.avatarurl.replace("profile", "130").replace(".png", f);
                var g = {
                    text: {
                        levelUp: g_js_strings.LevelUp.levelUp,
                        congratulations: g_js_strings.LevelUp.congratulations.replace("%1$s", m.getLevel()),
                        yourReward: g_js_strings.LevelUp.yourReward,
                        gold: g_js_strings.commonstr.gold,
                        celebrate: g_js_strings.LevelUp.celebrate
                    },
                    avatar: {
                        name: seed.player.prefix + " " + seed.player.name,
                        pictureUrl: j,
                        title: m.getTitle(),
                        level: m.getLevel(),
                        previousLevel: l.level
                    },
                    reward: {
                        gold: addCommas(d)
                    },
                    player: m
                };
                if (10 < seed.player.name.length && seed.player.name.length < 15) {
                    g.avatar.name = seed.player.name
                } else {
                    if (seed.player.name.length >= 15) {
                        g.avatar.name = seed.player.name.substring(0, 15) + "..."
                    }
                }
                $("topnav_level").innerHTML = m.getLevel();
                var i = new cm.LevelUpRewardDialog(g);
                var k = new cm.LevelUpRewardDialogController(g, i);
                i.show()
            }
        };
    var b = function () {
            a.addEventListener(cm.PlayerEvent.LEVEL_INCREASED, c)
        };
    b()
};
cm.PlayerEvent = function (a) {
    cm.CustomEvent.call(this, a);
    var b;
    this.setPreviousState = function (c) {
        b = c
    };
    this.getPreviousState = function () {
        return b
    }
};
cm.OOP.inherits(cm.PlayerEvent, cm.CustomEvent);
cm.PlayerEvent.LEVEL_INCREASED = "levelIncreased";
cm.LevelUtil = new function () {
    var c = 11000;
    var b = 2;
    var a = 90;
    this.getQuestId = function (d) {
        return d + c
    };
    this.getUserLevel = function (g) {
        var d, f, h, j;
        try {
            for (d = b; d <= a; d++) {
                f = parseInt(questlist["q" + (d + c)].objective[2]);
                if (g < f) {
                    break
                }
            }
        } catch (e) {}
        j = d - 1;
        h = titlenames[j.toString()];
        return {
            level: j,
            title: h
        }
    };
    this.getLevelUpRewards = function (g, d) {
        var h = 0;
        var e, j;
        try {
            for (e = Math.max(2, g + 1); e <= Math.min(d, a); e++) {
                j = questlist["q" + (e + c)].reward;
                h += parseInt(j[0][0])
            }
        } catch (f) {}
        return h
    }
}();
cm.playerReportsModel = function (b) {
    var a = {};
    return {
        load: function (c) {
            for (var d in c.arPlayerNames) {
                var e = c.arPlayerNames[d];
                for (var f in e) {
                    a[c.arPlayerNames[x]]
                }
            }
        },
        get: function (c) {}
    }
}(jQuery);
cm.ProfileController = function (c) {
    var e = {},
        b = false;
    var a = function (f) {
            if (typeof f === "undefined") {
                f = tvuid
            }
            f = +f;
            if (f < 1) {
                cm.ModalManager.alert(g_js_strings.getInfoForAnUser.plsSelectPlayer);
                return
            }
            if (e[f]) {
                cm.ProfileView.openProfile(e[f])
            }
            d(f)
        };
    var d = function (f) {
            AjaxCall.gPostRequest("ajax/_dispatch.php", {
                ctrl: "PlayerProfile",
                action: "get",
                userId: f
            }, function (g) {
                if (!g.ok) {
                    cm.ModalManager.alert(g_js_strings.errorcode.err_602);
                    return
                }
                if (+g.profile.userId < 1) {
                    cm.ModalManager.alert(g_js_strings.getInfoForAnUser.plsSelectPlayer);
                    return
                }
                var h = g.profile;
                e[f] = h;
                cm.ProfileView.openProfile(h)
            })
        };
    return {
        open: a,
        disabled: b
    }
}(jQuery);
cm = cm || {};
cm.ProfileView = function (f) {
    var c = function (j) {
            var g = g_js_strings.commonstr,
                h = {
                    1: g.normal,
                    2: g_js_strings.MapObject.begprotect,
                    3: g.truce,
                    4: g.vacation
                },
                l = "",
                k = "",
                i = "";
            if (!cm.WorldSettings.isOn("TR_KILLSWITCH")) {
                k += d(g.throneroom, "throne blue")
            }
            k += d(g.court, "court brown");
            if (+j.userId === +tvuid) {
                l = '<a class="button swipe"></a>'
            } else {
                i += b("message");
                i += b("ignore")
            }
            return cm.Template.renderTemplate("Profile", "mainProfile", {
                mightLabel: g.might,
                gloryLabel: g.glory,
                titleLabel: g.title,
                allianceLabel: g.alliance,
                statusLabel: g.status,
                changeAvatarButton: l,
                miniActionButtons: i,
                actionButtons: k,
                avatarClass: j.playerSex.toLowerCase() + j.avatarId,
                playerTitle: j.playerSex === "F" ? g.lady : g.lord,
                playerName: j.displayName,
                mightValue: j.might,
                gloryValue: j.glory,
                gloryIcons: e(j.maxGlory),
                titleValue: titlenames[+j.title],
                allianceValue: j.allianceName || g.none,
                statusValue: h[+j.warStatus] || g.normal
            })
        };
    var e = function (g) {
            var h = [];
            f.each(seed.gloryChatMapping, function (i, j) {
                if (+i <= +g) {
                    h.push('<img class="glory_icon" src="img/chat_' + j + '.png" />')
                }
            });
            return h.join("")
        };
    var d = function (g, h) {
            return cm.Template.renderTemplate("Profile", "actionButton", {
                label: g,
                className: h
            })
        };
    var b = function (g) {
            return cm.Template.renderTemplate("Profile", "miniActionButton", {
                className: g
            })
        };
    var a = function (h) {
            var g = c(h);
            if (f("#profileBody").length > 0) {
                f("#profileBody").html(g)
            } else {
                cm.ModalManager.addMedium({
                    title: g_js_strings.commonstr.profile,
                    body: '<div id="profileBody" class="profile_body clearfix">' + g + "</div>",
                    closeNow: true,
                    close: function () {},
                    lower: false,
                    "class": "mediumModal",
                    curtain: true,
                    width: 500,
                    height: 409,
                    left: 131,
                    top: 120
                })
            }
            f(".profile_body .swipe").click(function () {
                cm.ModalManager.close();
                change_avatar()
            });
            f(".profile_body .message").click(function () {
                cm.ModalManager.close();
                getMessageWindow(+h.userId, h.displayName, "user")
            });
            f(".profile_body .ignore").click(function () {
                Chat.ignoreUserConfirm(+h.userId)
            });
            f(".profile_body .throne").click(function () {
                cm.ModalManager.close();
                cm.ThroneView.openThrone(+h.userId === +tvuid)
            });
            f(".profile_body .court").click(function () {
                cm.ModalManager.close();
                changeview_court(+h.userId)
            });
            cm.Tooltip.setTooltip({
                htmlElement: f(".profile_body .message"),
                tooltip: "Message"
            });
            cm.Tooltip.setTooltip({
                htmlElement: f(".profile_body .ignore"),
                tooltip: "Ignore"
            })
        };
    return {
        openProfile: a
    }
}(jQuery);
if (!window.ProgressBar) {
    var ProgressBar = new Object()
}
ProgressBar.Properties = {
    progressbar_data: null
};
ProgressBar.Methods = {
    initializeProgressBar: function (e, f, c, d) {
        var b = parseInt(e);
        if (f) {
            var a = f
        } else {
            var a = false
        }
        var g = Object.clone(g_ajaxparams);
        if (b == 1) {
            g.loadFlag = true
        } else {
            g.loadFlag = false
        }
        new Ajax.Request(g_ajaxpath + "ajax/updateUserReengagement.php" + g_ajaxsuffix, {
            method: "post",
            parameters: g,
            onSuccess: function (m) {
                var i = m.responseText.evalJSON();
                if (i.ok && parseInt(i.maxScore) < 4) {
                    var j = {
                        install: {
                            complete: "complete",
                            text: g_js_strings.initializeProgressBar.install
                        },
                        bookmark: {
                            complete: i.status.bookmarked == "1" ? "complete" : "",
                            text: g_js_strings.initializeProgressBar.bookmark
                        },
                        fan: {
                            complete: i.status.fan ? "complete" : "",
                            text: g_js_strings.initializeProgressBar.fan
                        },
                        permissions: {
                            complete: i.status.publish_stream == "1" ? "complete" : "",
                            text: g_js_strings.initializeProgressBar.permissions
                        },
                        alliance: {
                            complete: i.status.alliance == "1" ? "complete" : "",
                            text: g_js_strings.initializeProgressBar.joinAlliance
                        }
                    };
                    var l = [];
                    l.push('<div class="progressBar">');
                    l.push('    <div class="topRow">');
                    l.push('        <a onclick="ProgressBar.modal_progress_actions()" class="container end install {install.complete}">{install.text}</a>');
                    l.push('        <a onclick="ProgressBar.modal_progress_actions()" class="container bookmark {bookmark.complete}">{bookmark.text}</a>');
                    l.push('        <a onclick="ProgressBar.modal_progress_actions()" class="container fan {fan.complete}">{fan.text}</a>');
                    l.push('        <a onclick="ProgressBar.modal_progress_actions()" class="container permissions {permissions.complete}">{permissions.text}</a>');
                    l.push('        <a onclick="ProgressBar.modal_progress_actions()" class="container end alliance {alliance.complete}">{alliance.text}</a>');
                    l.push("    </div>");
                    l.push('    <div class="bottomRow">');
                    l.push('        <a class="finishButton" onclick="ProgressBar.modal_progress_actions()">Click to Finish!</a>');
                    l.push("    </div>");
                    l.push("</div>");
                    var h = {
                        self: l.join("\n")
                    };
                    ProgressBar.progressbar_data = i;
                    $("progressBar").innerHTML = jsonT(j, h);
                    if (!d) {
                        $("progressBar").show()
                    }
                    if (i.pop && !a) {
                        ProgressBar.modal_progress_actions(2)
                    } else {
                        if (b == 2) {
                            ProgressBar.modal_progress_actions(1)
                        }
                    }
                } else {
                    if (i.ok && parseInt(i.maxScore) == 4 && !i.score && b == 2) {
                        ProgressBar.progressbar_data = i;
                        ProgressBar.modal_progress_actions(1)
                    } else {
                        if (i.ok && i.score && b == 2) {
                            Modal.hideModalAll();
                            $("progressBar").innerHTML = "";
                            $("progressBar").hide()
                        } else {
                            if (!i.ok) {
                                if (i.error_code && i.error_code != 0 && i.error_code != 1001) {
                                    Modal.showAlert(printLocalError((i.error_code || null), (i.msg || null), (i.feedback || null)))
                                } else {
                                    if (i.error_code && i.error_code == 1001) {
                                        var k = $("progressBar");
                                        k.addClassName("fbdown").show()
                                    }
                                }
                            }
                        }
                    }
                }
                if (typeof (c) == "function") {
                    c()
                }
            },
            onFailure: function () {}
        })
    },
    modal_progress_actions: function (f) {
        Modal.hideModalAll();
        var b = 1;
        var e = Object.keys(this.progressbar_data.status);
        for (var d = 0; d < e.length; d++) {
            if (this.progressbar_data.status[e[d]] == true || parseInt(this.progressbar_data.status[e[d]]) == 1) {
                b++
            }
        }
        var g = new Array();
        g.push("<div class='progressmodalbox'>");
        g.push("<div class='progressheader'>");
        g.push("</div>");
        g.push("<div class='progress-bar clearfix'>");
        var a = new Array(0, 1, 2, 3, 6);
        for (var d = 1; d <= 5; d++) {
            if (d <= b) {
                g.push("<div class='progress-bar-complete-step" + d + "'>");
                g.push("<div class='progress-bar-step" + d + "-status'>" + g_js_strings.initializeProgressBar.completetxt + "</div>");
                g.push("</div>")
            } else {
                g.push("<div class='progress-bar-incomplete-step" + d + "'>");
                g.push("<div class='progress-bar-step-percentage'>" + (d * 20) + "%</div>");
                g.push("</div>")
            }
        }
        g.push("</div>");
        g.push("<div class='button_wrapper clearfix'>");
        var c = "";
        g.push("<div class='buttonrow clearfix'>");
        if (parseInt(this.progressbar_data.status.alliance) === 0) {
            g.push("<a class='fbishbutton subscribe' onclick='modal_alliance()' style='text-align:center;'><span>");
            g.push(g_js_strings.initializeProgressBar.joinAlliance);
            g.push("</span></a>")
        } else {
            c = " complete";
            g.push("<div class='completedbar'>");
            g.push("</div>")
        }
        g.push("<div class='desc" + c + "'>");
        g.push(g_js_strings.modal_progress_actions.joinAlliance);
        g.push("</div>");
        g.push("</div>");
        c = "";
        g.push("<div class='buttonrow clearfix'>");
        if (parseInt(this.progressbar_data.status.publish_stream) == 0) {
            g.push("<a class='fbishbutton publish' onclick='FB.Connect.showPermissionDialog(\"publish_stream\");return false;'><span>");
            g.push(g_js_strings.modal_progress_actions.publishper);
            g.push("</span></a>")
        } else {
            c = " complete";
            g.push("<div class='completedbar'>");
            g.push("</div>")
        }
        g.push("<div class='desc" + c + "'>");
        g.push(g_js_strings.modal_progress_actions.enabletxt);
        g.push("</div>");
        g.push("</div>");
        c = "";
        g.push("<div class='buttonrow clearfix'>");
        if (this.progressbar_data.status.fan == false) {
            g.push("<a class='fbishbutton fan' onclick='ProgressBar.showFanBox();return false;'><span><img src='" + stimgUrl + "img/become_fan_Icon.jpg'/>");
            g.push(g_js_strings.modal_progress_actions.becomefan);
            g.push("</span></a>")
        } else {
            c = " complete";
            g.push("<div class='completedbar'>");
            g.push("</div>")
        }
        g.push("<div class='desc" + c + "'>");
        g.push(g_js_strings.modal_progress_actions.becometxt);
        g.push("</div>");
        g.push("</div>");
        c = "";
        g.push("<div class='buttonrow clearfix'>");
        if (parseInt(this.progressbar_data.status.bookmarked) == 0) {
            g.push("<a class='fbishbutton bookmark' onclick='FB.Connect.showBookmarkDialog();return false;'><span><img src='" + stimgUrl + "img/bookmark_icon.jpg'/>");
            g.push(g_js_strings.modal_progress_actions.addbook);
            g.push("</span></a>")
        } else {
            c = " complete";
            g.push("<div class='completedbar'>");
            g.push("</div>")
        }
        g.push("<div class='desc" + c + "'>");
        g.push(g_js_strings.modal_progress_actions.bookmarktxt);
        g.push("</div>");
        g.push("</div>");
        g.push("<div class='buttonrow clearfix'>");
        g.push("<div class='completedbar'>");
        g.push("</div>");
        g.push("<div class='desc complete'>");
        g.push(g_js_strings.modal_progress_actions.installtxt);
        g.push("</div>");
        g.push("</div>");
        g.push("</div>");
        g.push("<div class='actionbtns clearfix'>");
        g.push("<a onclick='ProgressBar.updateProgressStatus();return false;' class='button20 updatebtn'><span>");
        g.push(g_js_strings.modal_progress_actions.updatestatus);
        g.push("</span></a>");
        g.push("<a onclick='Modal.hideModal();return false;' class='button20 remindbtn'><span>");
        g.push(g_js_strings.commonstr.close);
        g.push("</span></a>");
        g.push("</div>");
        g.push("<div class='statusmsg'>");
        g.push(g_js_strings.modal_progress_actions.pressbutton.replace("%1$s", g_js_strings.modal_progress_actions.updatestatus));
        g.push("</div>");
        g.push("<div class='statusmsg'>");
        g.push(g_js_strings.modal_progress_actions.upto24);
        g.push("</div>");
        g.push("</div>");
        Modal.showModal(500, 400, 130, 130, g_js_strings.modaltitles.continuesetup, g.join(""));
        if (f && this.progressbar_data.gemsGained) {
            this.modal_gems_gained()
        } else {
            if (f && f == 1 && !this.progressbar_data.gemsGained) {
                this.modal_gems_not_gained()
            }
        }
    },
    updateProgressStatus: function () {
        this.initializeProgressBar(2)
    },
    showFanBox: function () {
        var a = new Array();
        a.push("<div class='progressfanboxwrap'>");
        a.push("<div class='fanboxbody'>");
        a.push($("fbFanBox").innerHTML);
        a.push("</div>");
        a.push("</div>");
        Modal.showModal(250, 400, 245, 190, "Become a Fan", a.join(""))
    },
    modal_gems_gained: function () {
        seed.player.gems = parseInt(seed.player.gems) + parseInt(this.progressbar_data.gemsGained);
        $("kochead_gems").innerHTML = seed.player.gems;
        var a = "";
        switch (parseInt(this.progressbar_data.maxScore)) {
        case 1:
            a = g_js_strings.modal_gems_gained.msg1;
            break;
        case 2:
            a = g_js_strings.modal_gems_gained.msg2;
            break;
        case 3:
            a = g_js_strings.modal_gems_gained.msg3;
            break;
        case 4:
            a = g_js_strings.modal_gems_gained.msg4;
            break;
        default:
            break
        }
        Modal.showAlert(a);
        if (parseInt(this.progressbar_data.maxScore) == 4) {
            $("progressBar").innerHTML = "";
            $("progressBar").hide()
        }
    },
    modal_gems_not_gained: function () {}
};
Object.extend(ProgressBar, ProgressBar.Methods);
Object.extend(ProgressBar, ProgressBar.Properties);
cm = cm || {};
cm.QuestModel = jQueryClass.extend({
    init: function (b, a) {
        this.id = Number(b);
        this.heading = a.heading;
        this.name = a.name;
        this.category = a.category;
        this.description = a.description;
        this.objective = "";
        this.order = Number(a.preferredorder);
        this.prerequisite = Number(a.prerequisite);
        this.reward = this.setReward(a.reward);
        this.claimed = "";
        this.prereqmet = "";
        this.objectivemet = ""
    },
    setReward: function (g) {
        var f = g[0],
            b = g[1],
            e = g[2],
            h = g[3],
            d = {};
        d.resources = [];
        d.units = [];
        d.items = [];
        d.player = [];
        if (f.length !== 0) {
            for (var j = 0; j < f.length; ++j) {
                var c = Number(j),
                    a, i = Number(f[j]);
                switch (c) {
                case 0:
                    a = g_js_strings.commonstr.gold;
                    break;
                case 1:
                    a = g_js_strings.commonstr.food;
                    break;
                case 2:
                    a = g_js_strings.commonstr.wood;
                    break;
                case 3:
                    a = g_js_strings.commonstr.stone;
                    break;
                case 4:
                    a = g_js_strings.commonstr.ore;
                    break;
                case 5:
                    a = g_js_strings.commonstr.population;
                    break
                }
                d.resources.push({
                    id: c,
                    name: a,
                    count: i,
                    type: "resource"
                })
            }
        } else {
            d.resources = null
        }
        if (b.length !== 0) {
            for (var j = 0; j < b.length; ++j) {
                var c = Number(b[j][0]),
                    i = Number(b[j][1]);
                d.units.push({
                    id: c,
                    name: unitcost["unt" + c][0],
                    count: i,
                    type: "unit"
                })
            }
        } else {
            d.units = null
        }
        if (e.length !== 0) {
            for (var j = 0; j < e.length; ++j) {
                if (typeof (e[j]) == "number" || typeof (e[j]) == Number) {
                    e = [
                        [e[0], e[1]]
                    ]
                }
                var c = Number(e[j][0]);
                var a = itemlist["i" + c].name;
                var i = Number(e[j][1]);
                d.items.push({
                    id: c,
                    name: a,
                    count: i,
                    type: "item"
                })
            }
        } else {
            d.items = null
        }
        for (var j = 0; j < h.length; ++j) {
            var c = Number(j),
                a, i = Number(h[j]);
            switch (j) {
            case 0:
                a = g_js_strings.commonstr.gems;
                break;
            case 1:
                a = g_js_strings.commonstr.might;
                break;
            case 2:
                a = g_js_strings.commonstr.title;
                break
            }
            if (i > 0) {
                d.player.push({
                    id: c,
                    name: a,
                    count: i,
                    type: "player"
                })
            } else {
                d.player.push(null)
            }
        }
        return d
    }
});

function modal_quests() {
    var a = new Array();
    a.push("<div id='modal_quests'>");
    a.push("<div class='questlist' id='modal_quests_questlist'>");
    a.push("<div class='hdg'><span>" + g_js_strings.commonstr.building + "</span></div>");
    a.push("<a  class='quest questsel questcomp'><span>" + g_js_strings.modal_quests.enlistfriends + "</span></a>");
    a.push("<a  class='quest questrec'><span>" + g_js_strings.modal_quests.askhelp + "</span></a>");
    a.push("<a  class='quest'><span>" + g_js_strings.modal_quests.buildcott + "</span></a>");
    a.push("<a  class='questgroup questgroupopen'><span>" + g_js_strings.modal_quests.domexpan + "</span></a>");
    a.push("<div>");
    a.push("<a  class='questsub'><span>" + g_js_strings.modal_quests.buildcott + "</span></a>");
    a.push("</div>");
    a.push("</div>");
    a.push("<div class='questbody' id='modal_quests_questbody'>");
    a.push("<div class='questname' id='modal_quests_qbdy_nm'>" + g_js_strings.modal_quests.buildfarm + "</div>");
    a.push("<div class='questhdg'>" + g_js_strings.modal_quests.questdesc + "</div>");
    a.push("<div class='questtx' id='modal_quests_qbdy_desc'>" + g_js_strings.modal_quests.buildfarmdesc + "</div>");
    a.push("<div class='questhdg'>" + g_js_strings.modal_quests.questobj + "</div>");
    a.push("<div class='questtx' id='modal_quests_qbdy_obj'>" + g_js_strings.modal_quests.farlvl1 + "</div>");
    a.push("<div class='questhdg'>" + g_js_strings.modal_quests.questrwd + "</div>");
    a.push("<div class='questtx clearfix' id='modal_quests_qbdy_award'>" + g_js_strings.modal_quests.squireandfood + "</div>");
    a.push("<div class='questbtn clearfix'>");
    a.push("<a  onclick='modal_quest_getaward(this,0);return false;' class='share' id='modal_quests_qbdy_btn2'><div class='ga'>" + g_js_strings.modal_quests.getrwd + "</div></a>");
    a.push("</div>");
    a.push("<div class='clearfix'>");
    a.push("<a style='display:none;margin-top:30px;margin-left:330px;' onclick='modal_questsFTEClose1();return false;' class='button25' id='modal_quests_fte_close_btn'><span>" + g_js_strings.commonstr.close + "</span></a>");
    a.push("</div>");
    a.push("</div>");
    a.push("</div>");
    if (cm.TutorialManager.inTutorialMode()) {
        Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.quests, a.join(""));
        cm.TutorialEventDispatcher.dispatchTutorialEvent("complete", "CLICK_QUEST_SAWMILL_REWARD")
    } else {
        Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.quests, a.join(""), modal_quests_doquests)
    }
}

function modal_questsFTEClose1() {
    var a = document.getElementById("questClickCover");
    if (a) {
        document.body.removeChild(a)
    }
    Modal.hideModalAll();
    cm.TutorialEventDispatcher.dispatchTutorialEvent("complete", "CLICK_QUEST_CLOSE_BUTTON")
}

function modal_quests_doquests() {
    var a = quests_validquests();
    for (var b = 0; b < a.valid.length; b++) {
        if (parseInt(a.valid[b]) == 8002) {
            a.valid.splice(b, 1);
            a.valid = [8002].concat(a.valid);
            break
        } else {
            if (parseInt(a.valid[b]) == 8003) {
                a.valid.splice(b, 1);
                a.valid = [8003].concat(a.valid);
                break
            } else {
                if (parseInt(a.valid[b]) == 8004) {
                    a.valid.splice(b, 1);
                    a.valid = [8004].concat(a.valid);
                    break
                } else {
                    if (parseInt(a.valid[b]) == 8005) {
                        a.valid.splice(b, 1);
                        a.valid = [8005].concat(a.valid);
                        break
                    } else {
                        if (parseInt(a.valid[b]) == 8006) {
                            a.valid.splice(b, 1);
                            a.valid = [8006].concat(a.valid);
                            break
                        } else {
                            if (parseInt(a.valid[b]) == 8007) {
                                a.valid.splice(b, 1);
                                a.valid = [8007].concat(a.valid);
                                break
                            } else {
                                if (parseInt(a.valid[b]) == 8008) {
                                    a.valid.splice(b, 1);
                                    a.valid = [8008].concat(a.valid);
                                    break
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    quest_allcompleted(a.valid);
    modal_quests_generate(a.valid, a.recommended, 1)
}

function modal_quests_viewquest(b) {
    removePopOverLayer();
    var a = $("modal_quests_questlist").select(".questsel");
    if (a.length > 0) {
        a[0].removeClassName("questsel")
    }
    $("modal_quests_questlist_q" + b).addClassName("questsel");
    $("modal_quests_qbdy_nm").innerHTML = questlist["q" + b].name;
    $("modal_quests_qbdy_desc").innerHTML = questlist["q" + b].description;
    $("modal_quests_qbdy_obj").innerHTML = quest_string_objective(b);
    $("modal_quests_qbdy_award").innerHTML = quest_string_award(b);
    $("modal_quests_qbdy_btn2").setAttribute("name", b);
    if ($("modal_quests_questlist_q" + b).hasClassName("questcomp")) {
        $("modal_quests_qbdy_btn2").removeClassName("incomplete");
        $("modal_quests_qbdy_obj").removeClassName("incomplete")
    } else {
        $("modal_quests_qbdy_btn2").addClassName("incomplete");
        $("modal_quests_qbdy_obj").addClassName("incomplete")
    }
}

function modal_quests_togglegroup(a) {
    return false
}

function modal_quests_generate(b, f, a) {
    var m = 0;
    var l = new Array();
    var p = new Object();
    for (var g = 0; g < b.length; g++) {
        var c = questlist["q" + b[g]];
        if (!p[c.heading]) {
            p[c.heading] = new Object()
        }
        if (!p[c.heading][c.category]) {
            p[c.heading][c.category] = new Array()
        }
        c.qid = b[g];
        p[c.heading][c.category].push(c)
    }
    var n = Object.keys(p);
    var h = 0;
    for (var g = 0; g < n.length; g++) {
        var o = Object.keys(p[n[g]]);
        if (a == 1) {
            l.push("<div class='hdg'><span>");
            l.push(n[g]);
            l.push("</span></div>")
        }
        for (var e = 0; e < o.length; e++) {
            h++;
            if (a == 1) {
                l.push("<a  class='questgroup questgroupopen' id='modal_quests_questlist_gtop");
                l.push(h);
                l.push("' onclick='modal_quests_togglegroup(");
                l.push(h);
                l.push(");return false;'><span>");
                l.push(o[e]);
                l.push("</span></a>");
                l.push("<div id='modal_quests_questlist_g");
                l.push(h);
                l.push("'>")
            }
            for (var d = 0; d < p[n[g]][o[e]].length; d++) {
                if (a == 1) {
                    l.push("<a  id='modal_quests_questlist_q");
                    l.push(p[n[g]][o[e]][d].qid);
                    l.push("' onclick='modal_quests_viewquest(");
                    l.push(p[n[g]][o[e]][d].qid);
                    l.push(");return false;' class='questsub")
                }
                if (parseInt(p[n[g]][o[e]][d].qid) == parseInt(f)) {
                    if (a == 1) {
                        l.push(" questrec")
                    }
                }
                if (g_questcomp["q" + p[n[g]][o[e]][d].qid] == 1) {
                    if (a == 1) {
                        l.push(" questcomp")
                    }
                    m++
                }
                if (a == 1) {
                    l.push("'><span>");
                    l.push(p[n[g]][o[e]][d].name);
                    l.push("</span><span class='questrec_label'></span></a>")
                }
            }
            if (a == 1) {
                l.push("</div>")
            }
        }
    }
    if (a == 1) {
        $("modal_quests_questlist").innerHTML = l.join("");
        modal_quests_viewquest(f)
    }
    quest_notify_bug(m)
}
var g_questcomp = new Object();

function quest_allcompleted(a) {
    for (var b = 0; b < a.length; b++) {
        if (!g_questcomp["q" + a[b]]) {
            if (quest_check_objective(a[b])) {
                g_questcomp["q" + a[b]] = 1
            }
        }
    }
    var c = Object.keys(g_questcomp);
    quest_notify_bug(c.length);
    return true
}

function quest_notify_bug(b) {
    if (b > 0) {
        $("chrome_quest_notify").innerHTML = b;
        $("chrome_quest_notify").removeClassName("noCount")
    } else {
        var a = $("chrome_quest_notify");
        if (a) {
            a.addClassName("noCount")
        }
    }
    return true
}

function modal_quest_getaward(tgt, share) {
    cm.sounds.play("modal_quest_getaward");
    var newCityModalFlag = ($("modal_quests_qbdy_btn2")) ? false : true;
    if ($("modal_quests_qbdy_btn2") && $("modal_quests_qbdy_btn2").hasClassName("incomplete")) {
        return false
    } else {
        var qid = parseInt(tgt.getAttribute("name"));
        var tutorialFlag = false;
        var params = Object.clone(g_ajaxparams);
        params.cid = currentcityid;
        params.qid = qid;
        new Ajax.Request(g_ajaxpath + "ajax/quest.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                if (seed.tutorial.t1 == 17) {
                    tutorialAdvance(1, 18);
                    tutorialFlag = true
                }
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    if (qid == 8003 && !seed.items.i1203) {
                        seed.items.i1101 = parseInt(seed.items.i1101) - 4;
                        seed.items.i1102 = parseInt(seed.items.i1102) - 2;
                        seed.items.i1103 = parseInt(seed.items.i1103) - 1;
                        ksoItems[1101].subtract(4);
                        ksoItems[1102].subtract(2);
                        ksoItems[1103].subtract(1)
                    } else {
                        if (qid == 8004 && !seed.items.i1204) {
                            seed.items.i1103 = parseInt(seed.items.i1103) - 4;
                            seed.items.i1104 = parseInt(seed.items.i1104) - 3;
                            seed.items.i1105 = parseInt(seed.items.i1105) - 1;
                            ksoItems[1103].subtract(4);
                            ksoItems[1104].subtract(3);
                            ksoItems[1105].subtract(1)
                        } else {
                            if (qid == 8005 && !seed.items.i1205) {
                                seed.items.i1106 = parseInt(seed.items.i1106) - 4;
                                seed.items.i1107 = parseInt(seed.items.i1107) - 3;
                                seed.items.i1108 = parseInt(seed.items.i1108) - 2;
                                ksoItems[1106].subtract(4);
                                ksoItems[1107].subtract(3);
                                ksoItems[1108].subtract(2)
                            } else {
                                if (qid == 8006 && !seed.items.i1206) {
                                    seed.items.i1109 = parseInt(seed.items.i1109) - 4;
                                    seed.items.i1110 = parseInt(seed.items.i1110) - 3;
                                    seed.items.i1111 = parseInt(seed.items.i1111) - 2;
                                    ksoItems[1109].subtract(4);
                                    ksoItems[1110].subtract(3);
                                    ksoItems[1111].subtract(2)
                                } else {
                                    if (qid == 8007 && !seed.items.i1207) {
                                        seed.items.i1112 = parseInt(seed.items.i1111) - 4;
                                        seed.items.i1113 = parseInt(seed.items.i1112) - 3;
                                        seed.items.i1114 = parseInt(seed.items.i1113) - 2;
                                        ksoItems[1112].subtract(4);
                                        ksoItems[1113].subtract(3);
                                        ksoItems[1114].subtract(2)
                                    } else {
                                        if (qid == 8008 && ksoItems[1211].count === 0) {
                                            seed.items.i1115 = parseInt(seed.items.i1115) - 4;
                                            seed.items.i1120 = parseInt(seed.items.i1120) - 3;
                                            seed.items.i1121 = parseInt(seed.items.i1121) - 2;
                                            ksoItems[1115].subtract(4);
                                            ksoItems[1120].subtract(3);
                                            ksoItems[1121].subtract(2)
                                        }
                                    }
                                }
                            }
                        }
                    }
                    quest_give_award(qid);
                    if (cm.TutorialManager.inTutorialMode()) {
                        tutorialClear();
                        tutorialFlag = true
                    }
                    if (parseInt(seed.tutorial.t1) == 4) {
                        $("modalControls1").show();
                        tutorialFlag = true
                    }
                    cm.TutorialEventDispatcher.dispatchTutorialEvent("complete", "CLICK_QUEST_REWARD_BUTTON");
                    seed.quests["q" + qid] = 1;
                    if (newCityModalFlag) {
                        Modal.hideModal();
                        modal_addcityhelp()
                    } else {
                        modal_quests_doquests()
                    }
                    if (rslt.updateSeed) {
                        update_seed(rslt.updateSeed)
                    }
                    if (!tutorialFlag && !newCityModalFlag) {
                        popOverShareLayer(qid)
                    }
                    if (cm.feedTracking.get("shareQuestComplete") !== false && !cm.TutorialManager.inTutorialMode()) {
                        shareQuestComplete(qid)
                    }
                    removePopOverLayer()
                } else {
                    if (rslt.tracker) {
                        var msgObj = {
                            type: "knight",
                            text: rslt.msg
                        };
                        Modal.showTrackerAlert(msgObj)
                    } else {
                        Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                    }
                }
            },
            onFailure: function () {}
        })
    }
}

function popOverShareLayer(b) {
    var a = [];
    a.push("<div class='sharewrap' id='shareQuestWrapper'>");
    a.push("<div class='questname'>");
    a.push(questlist["q" + b].name);
    a.push("</div>");
    a.push("<div class='sharetitle'>");
    a.push(g_js_strings.popOverShareLayer.sharetitle);
    a.push("</div>");
    a.push("<div class='sharedesc'>");
    a.push(g_js_strings.popOverShareLayer.sharedesc);
    a.push("</div>");
    a.push("<div class='shareimg'>");
    a.push("</div>");
    a.push("<div class='questbtn clearfix'>");
    a.push("<a class='share selfish' onclick='removePopOverLayer();return false;'>");
    a.push("<div class='ga'>");
    a.push(g_js_strings.commonstr.skip);
    a.push("</div>");
    a.push("</a>");
    a.push("<a class='share' onclick='shareQuestComplete(" + b + ");return false;'>");
    a.push("<div class='ga'>");
    a.push(g_js_strings.pop_treasure_chest_modal.sharewithfriends);
    a.push("</div>");
    a.push("</a>");
    a.push("</div>");
    a.push("</div>");
    if ($("modal_quests_questbody")) {
        $("modal_quests_questbody").insert(a.join(""))
    }
}

function removePopOverLayer() {
    if ($("shareQuestWrapper")) {
        $("shareQuestWrapper").remove()
    }
}

function shareQuestComplete(b) {
    cm.feedTracking.setFalse("shareQuestComplete");
    var a = new Array();
    a.push(["REPLACE_AsSeTiD", b]);
    a.push(["REPLACE_QuEsTnAmE", questlist["q" + b].name]);
    a.push(["REPLACE_AwArDnAmE", questlist["q" + b].name]);
    common_postToProfile("84", Object.cloneFeed(template_data_84), Object.cloneFeed(actionlink_data_84), continuation_84, a);
    removePopOverLayer()
}

function quest_string_objective(j) {
    j = +j;
    var k = questlist["q" + j].objective,
        h = +k[0],
        g = +k[1],
        f = +k[2],
        a = "",
        b = g_js_strings.commonstr,
        i = g_js_strings.quest_string_objective;
    if (h == 1) {
        a = i.areachlvlb.replace("%1$s", buildingcost["bdg" + g][0]).replace("%2$s", f)
    } else {
        if (h == 2) {
            a = i.areachlvlb.replace("%1$s", techcost["tch" + g][0]).replace("%2$s", f)
        } else {
            if (h == 3) {
                var e = "";
                if (g == 2) {
                    e = b.militiamen
                } else {
                    if (g == 4) {
                        e = b.pikemen
                    } else {
                        if (g == 5) {
                            e = b.swordsmen
                        } else {
                            if (g == 10) {
                                e = b.ballistae
                            } else {
                                if (g == 7 || g == 8) {
                                    e = unitcost["unt" + g][0]
                                } else {
                                    e = unitcost["unt" + g][0]
                                }
                            }
                        }
                    }
                }
                a = b.train + " " + addCommas(f) + " " + e + "."
            } else {
                if (h == 4) {
                    a = b.build + " " + addCommas(f) + " " + unitcost["unt" + g][0] + "."
                } else {
                    if (h == 5) {
                        var c = "";
                        if (g == 0) {
                            c = resourceinfo.rec0
                        } else {
                            if (g == 5) {
                                c = resourceinfo.rec5
                            } else {
                                c = resourceinfo["rec" + g]
                            }
                        }
                        a = b.obtain + " " + addCommas(f) + " " + c + "."
                    } else {
                        if (h == 6) {
                            if (g == 0) {
                                a = i.raisegolda.replace("%1$s", addCommas(f))
                            } else {
                                if (g == 5) {
                                    a = i.raisepopa.replace("%1$s", addCommas(f))
                                } else {
                                    a = i.increaseaprodb.replace("%1$s", resourceinfo["rec" + g]).replace("%2$s", addCommas(f))
                                }
                            }
                        } else {
                            if (h == 7) {
                                var d = b.wilderness;
                                if (g == 50) {
                                    d = b.plain
                                }
                                a = i.conqueraofb.replace("%1$s", d).replace("%2$s", addCommas(f))
                            } else {
                                if (h == 15) {
                                    a = i.constructabbdgs.replace("%1$s", f).replace("%2$s", buildingcost["bdg" + g][0])
                                } else {
                                    if (h == 999) {
                                        if (j === 1302) {
                                            a = i.collectresource.replace("%1$s", addCommas(f)).replace("%2$s", b.aetherstone)
                                        } else {
                                            if (j === 1303) {
                                                a = i.craftitem.replace("%1$s", addCommas(f)).replace("%2$s", ksoItems[g].name)
                                            } else {
                                                if (j === 1502) {
                                                    a = i.buildsecond
                                                } else {
                                                    if (j >= 11002 && j <= 11090) {
                                                        a = i.mightreachesa.replace("%1$s", addCommas(parseInt(f)))
                                                    } else {
                                                        if (j == 999001) {
                                                            a = i.appointfriendknight
                                                        } else {
                                                            if (j == 999002) {
                                                                a = i.appointknightrole
                                                            } else {
                                                                if (j == 999010) {
                                                                    a = i.changetaxrate
                                                                } else {
                                                                    if (j == 8002) {
                                                                        a = i.secondcity.replace("%1$s", itemlist.i1202.name)
                                                                    } else {
                                                                        if (j == 8003) {
                                                                            a = i.obtain4a2b1c.replace("%1$s", itemlist.i1101.name).replace("%2$s", itemlist.i1102.name).replace("%2$s", itemlist.i1103.name)
                                                                        } else {
                                                                            if (j == 8004) {
                                                                                a = i.obtain4a3b1c.replace("%1$s", itemlist.i1103.name).replace("%2$s", itemlist.i1104.name).replace("%2$s", itemlist.i1105.name)
                                                                            } else {
                                                                                if (j == 8005) {
                                                                                    a = i.obtain4a3b2c.replace("%1$s", itemlist.i1106.name).replace("%2$s", itemlist.i1107.name).replace("%2$s", itemlist.i1108.name)
                                                                                } else {
                                                                                    if (j == 8008) {
                                                                                        a = i.obtain4a3b2c.replace("%1$s", itemlist.i1115.name).replace("%2$s", itemlist.i1120.name).replace("%2$s", itemlist.i1121.name)
                                                                                    } else {
                                                                                        if (j == 7901) {
                                                                                            a = i.citybuildreinforce.replace("%1$s", b.plain).replace("%2$s", unitcost.unt1[0]).replace("%3$s", resourceinfo[0]).replace("%4$s", resourceinfo[1]).replace("%5$s", resourceinfo[2]).replace("%6$s", resourceinfo[3]).replace("%7$s", resourceinfo[4])
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    return a
}

function quest_give_award(g) {
    var a = questlist["q" + g].reward,
        d = a[0] || [];
    if (d[0] && +d[0] !== 0) {
        seed.citystats["city" + currentcityid].gold[0] = parseInt(seed.citystats["city" + currentcityid].gold[0]) + parseInt(d[0]);
        update_gold()
    }
    if (d[5] && +d[5] !== 0) {
        seed.citystats["city" + currentcityid].pop[0] = parseInt(seed.citystats["city" + currentcityid].pop[0]) + parseInt(d[5])
    }
    if (d[6] && +d[6] !== 0) {
        seed.resources["city" + currentcityid]["rec5"][0] = parseInt(seed.resources["city" + currentcityid]["rec5"][0]) + parseInt(d[6])
    }
    for (var c = 1; c < 5; c++) {
        if (d[c] && +d[c] !== 0) {
            seed.resources["city" + currentcityid]["rec" + c][0] = parseInt(seed.resources["city" + currentcityid]["rec" + c][0]) + parseInt(d[c]) * 3600
        }
    }
    if (a[1].length > 0) {
        for (var c = 0; c < a[1].length; c++) {
            seed.units["city" + currentcityid]["unt" + a[1][c][0]] = parseInt(seed.units["city" + currentcityid]["unt" + a[1][c][0]]) + parseInt(a[1][c][1])
        }
    }
    if (a[2].length > 0) {
        var f, e, b;
        for (var c = 0; c < a[2].length; c++) {
            f = +a[2][c][0];
            e = "i" + f;
            b = +a[2][c][1];
            if (f >= 1202 && f <= 1211) {
                if (ksoItems[f].count === 0) {
                    seed.items[e] = +b;
                    ksoItems[f].add(b)
                }
            } else {
                seed.items[e] = +b;
                ksoItems[f].add(b)
            }
        }
    }
    if (parseInt(a[3][0]) != 0) {
        seed.player.gems = parseInt(seed.player.gems) + parseInt(a[3][0]);
        $("kochead_gems").innerHTML = seed.player.gems
    }
    if (parseInt(a[3][1]) != 0) {
        seed.player.might = parseInt(seed.player.might) + parseInt(a[3][1]);
        $("topnav_might").innerHTML = seed.player.might
    }
    if (parseInt(a[3][2]) != 0) {
        seed.player.title = a[3][2];
        $("topnav_level").innerHTML = seed.player.title
    }
    return true
}

function quest_string_award(e) {
    var c = new Array(),
        a = questlist["q" + e].reward,
        d = a[0] || [];
    if (d[0] && +d[0] !== 0) {
        c.push("<div class='item'><img src='");
        c.push(stimgUrl);
        c.push("img/gold_qa.png'/><div class='iteminfo'><div class='ttl'>" + resourceinfo.rec0 + "</div><div>");
        c.push(addCommas(d[0]));
        c.push("</div></div></div>")
    }
    for (var b = 1; b < 5; b++) {
        if (d[b] && +d[b] !== 0) {
            c.push("<div class='item'><img src='");
            c.push(stimgUrl);
            c.push("img/rec");
            c.push(b);
            c.push("_qa.png'/><div class='iteminfo'><div class='ttl'>");
            c.push(resourceinfo["rec" + b]);
            c.push("</div><div>");
            c.push(addCommas(d[b]));
            c.push("</div></div></div>")
        }
    }
    if (d[5] && +d[5] !== 0) {
        c.push("<div class='item'><img src='");
        c.push(stimgUrl);
        c.push("img/population_qa.png'/><div class='iteminfo'><div class='ttl'>" + resourceinfo.rec5 + "</div><div>");
        c.push(addCommas(d[5]));
        c.push("</div></div></div>")
    }
    if (d[6] && +d[6] !== 0) {
        c.push("<div class='item'><img src='");
        c.push(stimgUrl);
        c.push("img/aetherstone_70.png'/><div class='iteminfo'><div class='ttl'>" + g_js_strings.commonstr.aetherstone + "</div><div>");
        c.push(addCommas(d[6]));
        c.push("</div></div></div>")
    }
    if (a[1].length > 0) {
        for (var b = 0; b < a[1].length; b++) {
            c.push("<div class='item'><img src='");
            c.push(stimgUrl);
            c.push("img/units/unit_");
            c.push(a[1][b][0]);
            c.push("_50_s34.jpg'/><div class='iteminfo'><div class='ttl'>");
            c.push(unitcost["unt" + a[1][b][0]][0]);
            c.push("</div><div>");
            c.push(addCommas(a[1][b][1]));
            c.push("</div></div></div>")
        }
    }
    if (a[2].length > 0) {
        for (var b = 0; b < a[2].length; b++) {
            c.push("<div class='item'><img src='");
            c.push(stimgUrl);
            c.push("img/items/70/");
            c.push(a[2][b][0]);
            c.push(".jpg?5c10831'/><div class='iteminfo'><div class='ttl'>");
            c.push(itemlist["i" + a[2][b][0]].name);
            c.push("</div><div>");
            c.push(addCommas(a[2][b][1]));
            c.push("</div></div></div>")
        }
    }
    if (parseInt(a[3][0]) != 0) {
        c.push("Gems " + addCommas(a[3][0]) + "<br/>")
    }
    if (parseInt(a[3][1]) != 0) {
        c.push("<div class='item'><img src='");
        c.push(stimgUrl);
        c.push("img/might_qa.png'/><div class='iteminfo'><div class='ttl'>" + g_js_strings.commonstr.might + "</div><div>");
        c.push(addCommas(a[3][1]));
        c.push("</div></div></div>")
    }
    if (parseInt(a[3][2]) != 0) {
        c.push("<div class='item'><img src='");
        c.push(stimgUrl);
        c.push("img/title_qa.png'/><div class='iteminfo'><div class='ttl'>" + g_js_strings.commonstr.title + "</div><div>");
        c.push(titlenames[a[3][2]]);
        c.push("</div></div></div>")
    }
    return c.join("")
}

function quest_check_prereqs(d) {
    var f = questlist["q" + d].prerequisite.split(","),
        e = true,
        b;
    for (var c = 0, a = f.length; c < a; c++) {
        b = f[c];
        if (b !== "" && !quest_check_completed(b)) {
            e = false
        }
    }
    return e
}

function quest_check_objective(l) {
    l = +l;
    var o = questlist["q" + l].objective,
        g = +o[0],
        f = +o[1],
        e = +o[2],
        c = 1;
    if (g == 1) {
        var a = new Array();
        var p = Object.keys(seed.buildings["city" + currentcityid]);
        for (var d = 0; d < p.length; d++) {
            var m = seed.buildings["city" + currentcityid][p[d]];
            if (a["b" + m[0]] == null) {
                a["b" + m[0]] = parseInt(m[1])
            } else {
                a["b" + m[0]] = Math.max(m[1], a["b" + m[0]])
            }
        }
        if (a["b" + f]) {
            if (parseInt(a["b" + f]) < e) {
                return 0
            }
        } else {
            return 0
        }
    } else {
        if (g == 2) {
            if (parseInt(seed.tech["tch" + f]) < e) {
                return 0
            }
        } else {
            if (g == 3) {
                if (parseInt(seed.units["city" + currentcityid]["unt" + f]) < e) {
                    return 0
                }
            } else {
                if (g == 4) {} else {
                    if (g == 5) {
                        if (f == 0) {
                            if (parseInt(seed.citystats["city" + currentcityid].gold[0]) < e) {
                                return 0
                            }
                        } else {
                            if (f == 5) {
                                if (parseInt(seed.citystats["city" + currentcityid].pop[0]) < e) {
                                    return 0
                                }
                            } else {
                                if (parseInt(seed.resources["city" + currentcityid]["rec" + f][0]) < e) {
                                    return 0
                                }
                            }
                        }
                    } else {
                        if (g == 6) {
                            if (f == 0) {
                                if (parseInt(seed.citystats["city" + currentcityid].gold[1]) * 0.01 * parseInt(seed.citystats["city" + currentcityid].pop[0]) < e) {
                                    return 0
                                }
                            } else {
                                if (f == 5) {
                                    if (parseInt(seed.citystats["city" + currentcityid].pop[1]) < e) {
                                        return 0
                                    }
                                } else {
                                    if ((parseInt(seed.resources["city" + currentcityid]["rec" + f][2]) - 100) < e) {
                                        return 0
                                    }
                                }
                            }
                        } else {
                            if (g == 7) {
                                var q = false;
                                var k = Object.keys(seed.wilderness);
                                for (var d = 0; d < k.length; d++) {
                                    var r = Object.keys(seed.wilderness[k[d]]);
                                    for (var b = 0; b < r.length; b++) {
                                        if (f != -1) {
                                            if (parseInt(seed.wilderness[k[d]][r[b]].tileType) == f && parseInt(seed.wilderness[k[d]][r[b]].tileLevel) >= e) {
                                                q = true;
                                                break
                                            }
                                        } else {
                                            if (parseInt(seed.wilderness[k[d]][r[b]].tileLevel) >= e) {
                                                q = true;
                                                break
                                            }
                                        }
                                    }
                                }
                                if (!q) {
                                    return 0
                                }
                            } else {
                                if (g == 15) {
                                    var n = 0;
                                    var p = Object.keys(seed.buildings["city" + currentcityid]);
                                    for (var d = 0; d < p.length; d++) {
                                        var m = seed.buildings["city" + currentcityid][p[d]];
                                        if ((parseInt(m[0]) == f) && (parseInt(m[1]) > 0)) {
                                            n++
                                        }
                                    }
                                    if (n < e) {
                                        return 0
                                    }
                                } else {
                                    if (g == 999) {
                                        if (l === 1302) {
                                            if ((+seed.resources["city" + currentcityid]["rec" + f][0]) < e) {
                                                return 0
                                            }
                                        } else {
                                            if (l === 1303) {
                                                if (+ksoItems[+f].count < e) {
                                                    return 0
                                                }
                                            } else {
                                                if (l === 1502) {
                                                    if (seed.cities.length < 2) {
                                                        return 0
                                                    }
                                                } else {
                                                    if (l >= 11002 && l <= 11090) {
                                                        if (parseInt(seed.player.might) < parseInt(e)) {
                                                            return 0
                                                        }
                                                    } else {
                                                        if (l == 999001) {
                                                            if (!seed.knights["city" + currentcityid]) {
                                                                return 0
                                                            }
                                                        } else {
                                                            if (l == 999002) {
                                                                if (!seed.leaders["city" + currentcityid]) {
                                                                    return 0
                                                                } else {
                                                                    if (parseInt(seed.leaders["city" + currentcityid].combatKnightId) == 0 && parseInt(seed.leaders["city" + currentcityid].intelligenceKnightId) == 0 && parseInt(seed.leaders["city" + currentcityid].politicsKnightId) == 0 && parseInt(seed.leaders["city" + currentcityid].resourcefulnessKnightId) == 0) {
                                                                        return 0
                                                                    }
                                                                }
                                                            } else {
                                                                if (l == 999010) {
                                                                    if (parseInt(seed.citystats["city" + currentcityid].gold[1]) != 20) {
                                                                        return 0
                                                                    }
                                                                } else {
                                                                    if (l == 8002) {
                                                                        if (($("panel_friendlist").select(".friend").length < 10) && !(parseInt(seed.items.i1202) > 0)) {
                                                                            return 0
                                                                        }
                                                                    } else {
                                                                        if (l == 8003) {
                                                                            if ((!(parseInt(seed.items.i1101) >= 4) || !(parseInt(seed.items.i1102) >= 2) || !(parseInt(seed.items.i1103) >= 1)) && !(parseInt(seed.items.i1203) > 0)) {
                                                                                return 0
                                                                            }
                                                                        } else {
                                                                            if (l == 8004) {
                                                                                if ((!(parseInt(seed.items.i1103) >= 4) || !(parseInt(seed.items.i1104) >= 3) || !(parseInt(seed.items.i1105) >= 1)) && !(parseInt(seed.items.i1204) > 0)) {
                                                                                    return 0
                                                                                }
                                                                            } else {
                                                                                if (l == 8005) {
                                                                                    if ((!(parseInt(seed.items.i1106) >= 4) || !(parseInt(seed.items.i1107) >= 3) || !(parseInt(seed.items.i1108) >= 2)) && !(parseInt(seed.items.i1205) > 0)) {
                                                                                        return 0
                                                                                    }
                                                                                } else {
                                                                                    if (l == 8006) {
                                                                                        if ((!(parseInt(seed.items.i1109) >= 4) || !(parseInt(seed.items.i1110) >= 3) || !(parseInt(seed.items.i1111) >= 2)) && !(parseInt(seed.items.i1206) > 0)) {
                                                                                            return 0
                                                                                        }
                                                                                    } else {
                                                                                        if (l == 8007) {
                                                                                            if ((!(parseInt(seed.items.i1112) >= 4) || !(parseInt(seed.items.i1113) >= 3) || !(parseInt(seed.items.i1114) >= 2)) && !(parseInt(seed.items.i1207) > 0)) {
                                                                                                return 0
                                                                                            }
                                                                                        } else {
                                                                                            if (l == 8008) {
                                                                                                if ((!(parseInt(seed.items.i1115) >= 4) || !(parseInt(seed.items.i1120) >= 3) || !(parseInt(seed.items.i1121) >= 2)) && !(parseInt(seed.items.i1211) > 0)) {
                                                                                                    return 0
                                                                                                }
                                                                                            } else {
                                                                                                if (l == 12001) {
                                                                                                    if ((parseInt(seed.player.usedSpeedup) == 0)) {
                                                                                                        return 0
                                                                                                    }
                                                                                                } else {
                                                                                                    if (l == 12002) {
                                                                                                        if ((parseInt(seed.player.spentFiveGems) == 0)) {
                                                                                                            return 0
                                                                                                        }
                                                                                                    } else {
                                                                                                        if (l == 7901) {
                                                                                                            var h = 0;
                                                                                                            for (var d = 0; d < seed.cities.length; d++) {
                                                                                                                var r = Object.keys(seed.wilderness["city" + seed.cities[d][0]]);
                                                                                                                for (var b = 0; b < r.length; b++) {
                                                                                                                    if (modal_wilderness_buildcity_citybuildcheck(seed.wilderness["city" + seed.cities[d][0]][r[b]].xCoord, seed.wilderness["city" + seed.cities[d][0]][r[b]].yCoord)) {
                                                                                                                        h = 1
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                            if (parseInt(seed.cities.length) > 1) {
                                                                                                                h = 1
                                                                                                            }
                                                                                                            return h
                                                                                                        } else {
                                                                                                            return 0
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    return c
}

function quest_check_completed(a) {
    return +(seed.quests["q" + a]) === 1
}

function quests_validquests() {
    var g = Object.keys(questlist),
        a = [],
        h = 9999,
        j = 0,
        c, k, f, e;
    for (var d = 0, b = g.length; d < b; d++) {
        c = g[d];
        k = +c.substring(1);
        f = questlist[c];
        e = +f.preferredorder || h;
        if (k >= 11061 && k <= 11090 && !cm.WorldSettings.isOn("LevelUpPopupEnabled")) {
            continue
        }
        if (!quest_check_completed(k) && quest_check_prereqs(k)) {
            a.push(k);
            if (e < h) {
                h = e;
                j = k
            } else {
                if (j === 0) {
                    j = k
                }
            }
        }
    }
    return {
        valid: a,
        recommended: j
    }
};

function modal_openRallypoint() {
    var b = new Array();
    b.push("<div id='modal_rallypoint'>");
    b.push("<div class='tabsbar' id='modal_rallypoint_tabs'>");
    b.push("<a class='tab selected' onclick='modal_openRallypoint_tab(\"mytroops\",1);return false;' id='modal_rallypoint_tab_mytroops'><span>" + g_js_strings.modal_openRallypoint.mytroops + "</span></a>");
    b.push("<a class='tab' onclick='modal_openRallypoint_tab(\"movement\",2);return false;' id='modal_rallypoint_tab_movement'><span>" + g_js_strings.modal_openRallypoint.troopmove + "</span></a>");
    b.push("<a class='button20' onclick='Modal.hideModalAll();modal_attack(4,\"\",\"\");return false;'><span>" + g_js_strings.modal_openRallypoint.marchtroops + "</span></a>");
    b.push("</div>");
    b.push("<div class='rallypointwrap'>");
    b.push("<div class='mytroops clearfix' id='modal_rallypoint_mytroops'>");
    for (var c in cm.UNIT_TYPES) {
        c = cm.UNIT_TYPES[c];
        b.push("<div class='unit'><img src='");
        b.push(stimgUrl);
        b.push("img/units/unit_");
        b.push(c);
        b.push("_50_s34.jpg?6545'/><div class='unitinfo'>");
        b.push("<div><b>");
        b.push(unitcost["unt" + c][0]);
        b.push("</b></div>");
        b.push("<div>");
        b.push(seed.units["city" + currentcityid]["unt" + c]);
        b.push("</div>");
        b.push("</div>");
        b.push("</div>")
    }
    b.push("</div>");
    b.push("<div class='troopmovement' id='modal_rallypoint_movement' style='display:none;'>");
    b.push("</div>");
    b.push("</div>");
    b.push("</div>");
    $("modal_build_content").innerHTML = b.join("");
    if ("on" == cm.features.AUTO_ATTACK) {
        var a = new cm.AutoAttackManagerModel();
        new cm.AutoAttackManagerController(a, new cm.AutoAttackManagerView(a))
    }
}

function modal_openRallypoint_tab(b, a) {
    $("modal_rallypoint_tabs").select(".selected")[0].removeClassName("selected");
    $("modal_rallypoint_tab_" + b).className = "tab selected";
    $("modal_build").className = "tab" + a;
    $("modal_rallypoint").select(".rallypointwrap > div").each(function (c) {
        c.hide()
    });
    $("modal_rallypoint_" + b).show();
    switch (a) {
    case 2:
        modal_openRallypoint_movement();
        break
    }
}

function modal_openRallypoint_movement() {
    var e = new Array();
    e.push("<table cellpadding='0' cellspacing='0'>");
    e.push("<thead><tr><td class='typecol'><div>" + g_js_strings.modal_openRallypoint_movement.marchtype + "</div></td><td class='statuscol'><div>" + g_js_strings.commonstr.status + "</div></td><td class='targetcol'><div>" + g_js_strings.modal_openRallypoint_movement.tgtloc + "</div></td><td class='actionscol'><div>" + g_js_strings.commonstr.actions + "</div></td></tr></thead><tbody>");
    var f = seed.queue_atkp["city" + currentcityid];
    var a = unixtime();
    if (!Object.isArray(f)) {
        var h = Object.keys(f);
        for (var d = 0; d < h.length; d++) {
            var g = f[h[d]];
            var j = parseInt(g.marchStatus);
            var c = parseInt(g.marchType);
            if (c == cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN) {
                switch (j) {
                case cm.MARCH_STATUS.MARCH_STATUS_OUTBOUND:
                case cm.MARCH_STATUS.MARCH_STATUS_RESTING:
                case cm.MARCH_STATUS.MARCH_STATUS_RETURNING:
                    break;
                default:
                    continue
                }
            }
            e.push("<tr");
            if (d % 2 == 0) {
                e.push(" class='stripe'")
            }
            e.push("><td class='typecol'><div>");
            switch (c) {
            case cm.MARCH_TYPES.MARCH_TYPE_TRANSPORT:
                e.push(g_js_strings.commonstr.transport);
                break;
            case cm.MARCH_TYPES.MARCH_TYPE_REINFORCE:
                e.push(g_js_strings.commonstr.reinforce);
                break;
            case cm.MARCH_TYPES.MARCH_TYPE_SCOUT:
                e.push(g_js_strings.commonstr.scout);
                break;
            case cm.MARCH_TYPES.MARCH_TYPE_ATTACK:
                e.push(g_js_strings.commonstr.attack);
                break;
            case cm.MARCH_TYPES.MARCH_TYPE_REASSIGN:
                e.push(g_js_strings.commonstr.reassign);
                break;
            case cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN:
                e.push(g_js_strings.commonstr.raid);
                break
            }
            e.push("</div></td><td class='statuscol'><div>");
            switch (j) {
            case cm.MARCH_STATUS.MARCH_STATUS_OUTBOUND:
                e.push(g_js_strings.commonstr.marching);
                break;
            case cm.MARCH_STATUS.MARCH_STATUS_DEFENDING:
                e.push(g_js_strings.commonstr.defending);
                break;
            case cm.MARCH_STATUS.MARCH_STATUS_RESTING:
                e.push(g_js_strings.attack_generatequeue.unloadingloot);
                break;
            case cm.MARCH_STATUS.MARCH_STATUS_RETURNING:
                e.push(g_js_strings.commonstr.returning);
                break;
            case cm.MARCH_STATUS.MARCH_STATUS_ABORTING:
                e.push(g_js_strings.commonstr.aborting);
                break
            }
            e.push("</div></td><td class='targetcol'><div>");
            var b = new cm.utils.CoordinateLink(g.toXCoord, g.toYCoord);
            b.setClassName("coordinateLink");
            e.push(b.getHTML());
            e.push("</div></td><td class='actionscol'><div class='clearfix'>");
            if (g.marchType == cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN) {
                e.push("</div></td></tr>");
                continue
            }
            if (j == cm.MARCH_STATUS.MARCH_STATUS_OUTBOUND) {
                e.push("<a href='#' class='button20' onclick='cm.recall.ask(");
                e.push(h[d].split("m")[1]);
                e.push(", " + currentcityid + ");return false;'>");
                e.push("<span>" + g_js_strings.commonstr.recall + "</span></a>")
            }
            if (j == cm.MARCH_STATUS.MARCH_STATUS_DEFENDING) {
                e.push("<a href='#' class='button20' onclick='attack_recall(");
                e.push(h[d].split("m")[1]);
                e.push(",1," + currentcityid + ");return false;'>");
                e.push("<span>" + g_js_strings.commonstr.recall + "</span></a>")
            }
            e.push("<a href='#' class='button20' onclick='view_march(");
            e.push(h[d].split("m")[1]);
            e.push(");return false;'>");
            e.push("<span>" + g_js_strings.commonstr.view + "</span></a>");
            if (cm.features && cm.features.speedupMarch == "on") {
                if ((j == 1 && a < parseInt(g.destinationUnixTime)) || (j == 8 && a < parseInt(g.returnUnixTime))) {
                    e.push('<a href="#" class="inlineButton red20" onclick="modal_speedup(\'');
                    e.push(h[d] + "," + currentcityid);
                    e.push("',0,undefined,'" + g_js_strings.commonstr.march);
                    e.push(" (" + g.toXCoord + "," + g.toYCoord + ")');return false;\">");
                    e.push("<span>" + g_js_strings.commonstr.speedup + "</span></a>")
                }
            }
            e.push("</div></td></tr>")
        }
    }
    e.push("</tbody></table>");
    $("modal_rallypoint_movement").innerHTML = e.join("")
}
cm.recall = function (a) {
    return {
        ask: function (c, d) {
            Modal.multiButton({
                buttons: [{
                    txt: g_js_strings.commonstr.recall,
                    exe: function b() {
                        attack_recall(c, 2, d);
                        Modal.hideModal()
                    }
                }, {
                    txt: g_js_strings.commonstr.cancel,
                    exe: function () {
                        Modal.hideModal()
                    }
                }],
                body: "<strong>" + g_js_strings.recall.header + "</strong><br><br>" + g_js_strings.recall.ask
            })
        }
    }
}(jQuery);

function attack_recall(marchid, type, cid) {
    var params = Object.clone(g_ajaxparams);
    params.cid = cid;
    params.mid = marchid;
    var recall = parseInt(type) == 1 ? "ajax/undefend.php" : "ajax/cancelMarch.php";
    new Ajax.Request(g_ajaxpath + recall + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (rslt.updateSeed) {
                    seed.queue_atkp["city" + params.cid]["m" + params.mid].marchStatus = 8;
                    var marchtime = parseInt(seed.queue_atkp["city" + params.cid]["m" + params.mid].returnUnixTime) - parseInt(seed.queue_atkp["city" + params.cid]["m" + params.mid].destinationUnixTime);
                    var ut = unixtime();
                    if (seed.playerEffects.returnExpire > unixtime()) {
                        marchtime *= 0.5
                    }
                    seed.queue_atkp["city" + cid]["m" + marchid].destinationUnixTime = rslt.destinationUnixTime || ut;
                    seed.queue_atkp["city" + cid]["m" + marchid].returnUnixTime = rslt.returnUnixTime || ut + marchtime * rslt.returnMultiplier;
                    seed.queue_atkp["city" + cid]["m" + marchid].marchStatus = 8;
                    update_seed(rslt.updateSeed)
                }
                if (parseInt(type) == 1 || parseInt(type) == 2) {
                    modal_openRallypoint_tab("movement", 2)
                }
                if (parseInt(type) == 2) {
                    for (var j in cm.UNIT_TYPES) {
                        j = cm.UNIT_TYPES[j];
                        seed.queue_atkp["city" + cid]["m" + marchid]["unit" + j + "Return"] = parseInt(seed.queue_atkp["city" + cid]["m" + marchid]["unit" + j + "Count"])
                    }
                }
            } else {
                if (parseInt(rslt.error_code) == 253) {
                    Modal.showAlert(g_js_strings.recall.error)
                }
            }
        },
        onFailure: function () {}
    })
}

function view_march(marchid) {
    var msghtml = new Array();
    var params = Object.clone(g_ajaxparams);
    params.rid = marchid;
    new Ajax.Request(g_ajaxpath + "ajax/fetchMarch.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                msghtml.push("<div class='modal_march_info_top'>");
                msghtml.push("</div>");
                msghtml.push("<div class='modal_march_body'>");
                msghtml.push("<div style='position:relative'>");
                msghtml.push("<div class='modal_march_header_left'>");
                msghtml.push("<div class='modal_march_info_knight'>");
                msghtml.push(g_js_strings.commonstr.knight + ": ");
                if (rslt.march["knightName"] == null) {
                    msghtml.push("None")
                } else {
                    msghtml.push(rslt.march["knightName"])
                }
                msghtml.push("</div>");
                msghtml.push("<div class='modal_march_info_knight'>");
                msghtml.push(g_js_strings.commonstr.type + ": ");
                switch (parseInt(rslt.march["marchType"])) {
                case 1:
                    msghtml.push(g_js_strings.commonstr.transport);
                    break;
                case 2:
                    msghtml.push(g_js_strings.commonstr.reinforce);
                    break;
                case 3:
                    msghtml.push(g_js_strings.commonstr.scout);
                    break;
                case 4:
                    msghtml.push(g_js_strings.commonstr.attack);
                    break;
                case 5:
                    msghtml.push(g_js_strings.commonstr.reassign);
                    break
                }
                msghtml.push("</div>");
                msghtml.push("<div class='modal_march_info_knight'>");
                msghtml.push(g_js_strings.commonstr.status + ": ");
                switch (parseInt(rslt.march["marchStatus"])) {
                case 1:
                    msghtml.push(g_js_strings.commonstr.marching);
                    break;
                case 2:
                    msghtml.push(g_js_strings.commonstr.defending);
                    break;
                case 8:
                    msghtml.push(g_js_strings.commonstr.returning);
                    break;
                case 9:
                    msghtml.push(g_js_strings.commonstr.aborting);
                    break;
                default:
                    msghtml.push(g_js_strings.commonstr.undefined);
                    break
                }
                msghtml.push("</div>");
                msghtml.push("</div>");
                msghtml.push("<div class='modal_march_header_right modal_march_info_text'>");
                msghtml.push(g_js_strings.commonstr.target + ": " + rslt.march["xCoord"] + "," + rslt.march["yCoord"]);
                msghtml.push("</div>");
                msghtml.push("</div>");
                msghtml.push("<br style='clear:both'>");
                msghtml.push("<div style='position:relative'>");
                msghtml.push("<div class='modal_march_info_left'>");
                msghtml.push("<div class='modal_march_info_text'>");
                msghtml.push(g_js_strings.commonstr.troops + ":");
                msghtml.push("</div>");
                msghtml.push("<table cellpadding='0' cellspacing='0' class=''>");
                msghtml.push("<thead><tr><td>&nbsp;</td><td class='modal_march_table_cell'>" + g_js_strings.commonstr.nametx + "</td><td class='modal_march_table_cell'>" + g_js_strings.commonstr.quantity + "</td></tr></thead><tbody>");
                for (var i in cm.UNIT_TYPES) {
                    i = cm.UNIT_TYPES[i];
                    if (rslt.march["unit" + i + "Return"] > 0) {
                        msghtml.push("<tr><td><img src='../src/img/units/unit_" + i + "_30_s34.jpg'></td>");
                        msghtml.push("<td class='modal_march_table_cell'>" + unitcost["unt" + i][0] + "</td>");
                        msghtml.push("<td class='modal_march_table_cell'>" + rslt.march["unit" + i + "Return"] + "</td></tr>")
                    }
                }
                msghtml.push("</tbody></table>");
                msghtml.push("</div>");
                msghtml.push("<div class='modal_march_info_right'>");
                msghtml.push("<div class='modal_march_info_text'>");
                msghtml.push(g_js_strings.view_march.rescarr + ":");
                msghtml.push("</div>");
                msghtml.push("<table cellpadding='0' cellspacing='0' class=''>");
                msghtml.push("<thead><tr><td>&nbsp;</td><td class='modal_march_table_cell'>" + g_js_strings.commonstr.nametx + "</td><td class='modal_march_table_cell'>" + g_js_strings.commonstr.quantity + "</td></tr></thead><tbody>");
                msghtml.push("<tr><td>");
                msghtml.push("<img src='../src/img/gold_30.png'>");
                msghtml.push("</td><td class='modal_march_table_cell'>");
                msghtml.push(g_js_strings.commonstr.gold);
                msghtml.push("</td><td class='modal_march_table_cell'>");
                msghtml.push(rslt.march["gold"] + "<br/>");
                msghtml.push("</tr>");
                for (var j = 1; j <= 5; j++) {
                    switch (j) {
                    case 1:
                        image = "food";
                        break;
                    case 2:
                        image = "wood";
                        break;
                    case 3:
                        image = "stone";
                        break;
                    case 4:
                        image = "iron";
                        break;
                    case 5:
                        image = "aetherstone";
                        break
                    }
                    msghtml.push("<tr><td>");
                    msghtml.push("<img src='../src/img/" + image + "_30.png'>");
                    msghtml.push("</td><td class='modal_march_table_cell'>");
                    if (j == 5) {
                        msghtml.push(resourceinfo["7"])
                    } else {
                        msghtml.push(resourceinfo["rec" + j])
                    }
                    msghtml.push("</td><td class='modal_march_table_cell'>");
                    msghtml.push(rslt.march["resource" + j] + "<br/>");
                    msghtml.push("</tr>")
                }
                msghtml.push("</tbody></table>");
                msghtml.push("</div>");
                msghtml.push("</div>");
                msghtml.push("<br style='clear:both'>");
                msghtml.push("</div>");
                msghtml.push("<br style='clear:both'>");
                msghtml.push("<div class='modal_march_info_bottom'>&nbsp;</div>")
            }
            Modal.showModal(740, 400, 10, 10, g_js_strings.modaltitles.marchinformation, msghtml.join(""))
        },
        onFailure: function () {}
    })
};
cm = cm || {};
cm.RecipeController = function (f) {
    var h = function (k) {
            var i, j = true;
            jQuery.each(k.input.items, function (m, l) {
                if (ksoItems[m].count < l) {
                    j = false
                }
            });
            jQuery.each(k.input.resources, function (m, l) {
                i = seed.resources["city" + currentcityid]["rec5"][0];
                l = ~~ (1 * l);
                if (i < l) {
                    j = false
                }
            });
            return j
        };
    var g = function (j) {
            var i = seed.queue_craft["city" + currentcityid];
            if (i.length > 0) {
                return false
            }
            return true
        };
    var b = function (j) {
            var i = ~~ (1 * seed.player.gems);
            if (j.insurance > i) {
                return false
            }
            return true
        };
    var c = function (i) {
            return i.insurance
        };
    var a = function (i) {
            return i.failure
        };
    var e = function (m) {
            var k = cm.RecipeController.calcIngredients(m),
                l = cm.RecipeController.calcQueueSlots(m),
                j = cm.RecipeController.calcGems(m),
                i = jQuery("#insuranceCheckbox").is(":checked");
            if (!k) {
                cm.ModalManager.alert({
                    close: function () {
                        Modal.hideModalAll();
                        cm.ModalManager.close()
                    },
                    button_text: g_js_strings.commonstr.ok,
                    text: g_js_strings.crafting.notEnoughIngredients,
                    "class": "craftFailure",
                    exe: function () {
                        Modal.hideModalAll();
                        cm.ModalManager.close()
                    }
                });
                return false
            } else {
                if (!l) {
                    cm.ModalManager.alert({
                        close: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close()
                        },
                        button_text: g_js_strings.commonstr.ok,
                        text: g_js_strings.crafting.notEnoughSlots,
                        "class": "craftFailure",
                        exe: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close()
                        }
                    });
                    return false
                } else {
                    if (i && !j) {
                        cm.ModalManager.alert({
                            close: function () {
                                Modal.hideModalAll();
                                cm.ModalManager.close()
                            },
                            button_text: g_js_strings.commonstr.ok,
                            text: g_js_strings.crafting.notEnoughGems,
                            "class": "craftFailure",
                            exe: function () {
                                Modal.hideModalAll();
                                cm.ModalManager.close()
                            }
                        });
                        return false
                    }
                }
            }
            AjaxCall.gPostRequest("ajax/_dispatch.php", {
                ctrl: "Crafting",
                action: "craft",
                cityId: currentcityid,
                itemId: m.output,
                categoryId: m.category,
                recipeId: m.recipeId,
                insurance: i
            }, function (o) {
                if (o.ok === true) {
                    jQuery.each(m.input.items, function (s, r) {
                        ksoItems[s].subtract(r)
                    });
                    jQuery.each(m.input.resources, function (s, r) {
                        seed.resources["city" + currentcityid]["rec5"][0] = Number(seed.resources["city" + currentcityid]["rec5"][0]) - Number(r)
                    });
                    if (i) {
                        seed.player.gems = +(1 * seed.player.gems) - +(1 * m.insurance);
                        jQuery("#kochead_gems").html(seed.player.gems);
                        jQuery("#kochead_gems").html(seed.player.gems);
                        jQuery("#kochead_gems").html(seed.player.gems)
                    }
                    if (o.status == "failure") {
                        if (m.consolation) {
                            ksoItems[m.consolation].add()
                        }
                        Modal.hideModal();
                        var p = cm.Template.renderTemplate("Building", "craftFailure", {
                            itemId: (m.consolation) ? m.consolation : "0",
                            failure: "Craft Failed"
                        });
                        cm.ModalManager.alert({
                            button_text: g_js_strings.commonstr.ok,
                            text: p,
                            "class": "craftFailure",
                            exe: function () {
                                Modal.hideModalAll();
                                cm.ModalManager.close()
                            }
                        })
                    } else {
                        if (o.status == "success") {
                            if (!seed.queue_craft["city" + currentcityid]) {
                                seed.queue_craft["city" + currentcityid] = []
                            }
                            var q = cm.ThroneController.effectBonus(81);
                            var n = {};
                            n.recipeId = m.recipeId;
                            n.craftingUnixTime = o.time.startTime;
                            n.craftingEtaUnixTime = o.time.endTime;
                            n.craftingId = o.craftingId;
                            n.categoryId = null;
                            n.recipeIndex = null;
                            seed.queue_craft["city" + currentcityid].push(n);
                            queue_changetab_building();
                            update_queue();
                            Modal.hideModal()
                        }
                    }
                } else {
                    cm.ModalManager.alert({
                        button_text: g_js_strings.commonstr.ok,
                        text: o.msg,
                        "class": "craftFailure",
                        exe: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close()
                        }
                    })
                }
            })
        };
    var d = function () {};
    d();
    return {
        craft: e,
        calcInsurance: c,
        calcFailure: a,
        calcIngredients: h,
        calcQueueSlots: g,
        calcGems: b
    }
}(jQuery);
cm = cm || {};
cm.RecipeModel = jQueryClass.extend({
    init: function (b, a) {
        this.id = ~~ (1 * b);
        this.recipeId = ~~ (1 * a.recipe_id);
        this.name = a.name;
        this.category = ~~ (1 * a.category);
        this.failure = a.failure_chance;
        this.insurance = ~~ (1 * a.insurance_cost);
        this.consolation = ~~ (1 * a.consolation_item_id) || null;
        this.input = a.input;
        this.output = ~~ (1 * a.output_item_id);
        this.requirements = a.requirements
    },
    craft: function () {
        cm.RecipeController.craft(this)
    }
});
var cm = cm || {};
cm.ReinforcedReportTemplateLoader = function (b) {
    var a = function () {
            cm.REINFORCED_REPORT_PRESENTATION_MODEL = g_js_strings.modal_messages_viewreinforcedreports;
            cm.REINFORCED_REPORT_PRESENTATION_MODEL.troops = g_js_strings.commonstr.troops;
            cm.REINFORCED_REPORT_PRESENTATION_MODEL.backtoreports = g_js_strings.modal_messages_viewreports_view.backtoreports;
            cm.REINFORCED_REPORT_RULE = {
                self: cm.Template.getTemplate("reinforcedReport101", "self"),
                reinforced_troops: cm.Template.getTemplate("reinforcedReport101", "reinforced_troops"),
                "reinforced_troops[*]": cm.Template.getTemplate("reinforcedReport101", "reinforced_troops[*]")
            }
        };
    var c = function (e) {
            var d = e.responseText.split("<!---->");
            if (d.length < 3) {
                cm.log.l("Reinforced report template is corrupted.")
            }
            cm.REINFORCED_REPORT_RULE.self = d[0];
            cm.REINFORCED_REPORT_RULE.reinforced_troops = d[1];
            cm.REINFORCED_REPORT_RULE["reinforced_troops[*]"] = d[2]
        };
    b(document).ready(a);
    return {}
}(jQuery);
cm.ReinforcedReportLoader = function (b) {
    var c = function (f, j, d, l, i, h, e, o, n, m, k) {
            var g = Object.clone(g_ajaxparams);
            g.rid = j;
            g.side = 0;
            new Ajax.Request(g_ajaxpath + "ajax/fetchReport.php" + g_ajaxsuffix, {
                method: "post",
                parameters: g,
                onSuccess: function (D) {
                    var y = D.responseText.evalJSON();
                    b("#modal_msg_list_pagination").hide();
                    if (undefined == y.unts) {
                        Modal.showAlert(printLocalError((y.error_code || null), (y.msg || null), (y.feedback || null)))
                    } else {
                        var t = null;
                        var A = [];
                        var w = null;
                        var B = 0;
                        var s = 0;
                        for (var z in y.unts) {
                            w = parseInt(z.substr(1));
                            B = parseInt(y.unts[z]);
                            A.push({
                                unitid: w,
                                unitname: unitcost["unt" + w][0],
                                reinforced: y.unts[z]
                            });
                            s += B
                        }
                        var x = {
                            date: y.mTimestamp,
                            city: {
                                id: d,
                                name: unescape(l),
                                number: i
                            },
                            member: {
                                id: h,
                                name: unescape(e),
                                city_id: o,
                                city_name: unescape(n),
                                cordx: m,
                                cordy: k
                            },
                            reinforced_troops: A,
                            stimgurl: stimgUrl,
                            total_troops: s,
                            march_id: null,
                            upkeep: 0
                        };
                        do {
                            x.march_id = y.mid;
                            var p = seed.queue_atkinc["m" + y.mid];
                            if (!p || p.marchStatus != 2) {
                                break
                            }
                            var q = 0;
                            for (var v = 0; v < A.length; ++v) {
                                q += parseInt(p["unit" + A[v].unitid + "Return"]) * parseInt(unitupkeeps[A[v].unitid])
                            }
                            x.upkeep = q
                        } while (false);
                        var C = new cm.ReinforcedReportView(x);
                        var u = new cm.ReinforcedReportController(x, C);
                        var r = b("#modal_msg_list");
                        r.html("");
                        r.append(C.getHTMLElement());
                        if (b("#viewreports_marchreport_" + j).hasClass("unread")) {
                            seed.newReportCount = parseInt(seed.newReportCount) - 1
                        }
                        messages_notify_bug()
                    }
                },
                onFailure: function () {}
            })
        };
    var a = function () {
            b("#modal_msg_body").live("viewReinforcedReport", c)
        };
    b(document).ready(a)
}(jQuery);
cm.ReinforcedReportView = function (a) {
    if (!cm.REINFORCED_REPORT_RULE.self || !cm.REINFORCED_REPORT_RULE.reinforced_troops || !cm.REINFORCED_REPORT_RULE["reinforced_troops[*]"]) {
        throw "Reinforced Report Template failed to load.";
        return
    }
    var d = null;
    var c = null;
    var e = null;
    var b = function (f) {
            a.PRESENTATION_MODEL = cm.REINFORCED_REPORT_PRESENTATION_MODEL;
            d = document.createElement("div");
            d.innerHTML = jsonT(a, cm.REINFORCED_REPORT_RULE);
            c = f(d).find(".blue20");
            e = f(d).find(".brown20");
            if (null == a.march_id) {
                e.addClass("unmet")
            }
        };
    this.getHTMLElement = function () {
        return d
    };
    this.getButtons = function () {
        return {
            back_to_report: c,
            send_troops_home: e
        }
    };
    b(jQuery)
};
cm.ReinforcedReportController = function (model, view) {
    var myself = this;
    var model_ = model;
    var view_ = view;
    var onBackToReportButtonClick_ = function (e) {
            loadPage_pagination("modal_msg_list_pagination", pageNavigatorModel.getCurrentPage(), "modal_messages_viewreports", pageNavigatorModel.getPageCount());
            location.replace("#mainbody")
        };
    var onSendTroopsHomeButtonClick_ = function (e) {
            Modal.confirm({
                title: g_js_strings.modal_messages_viewreinforcedreports.sendtroopshome,
                text: g_js_strings.modal_messages_viewreinforcedreports.sendtroopshomeconfirm.replace(/%1\$s/g, model_.total_troops).replace(/%2\$s/g, model_.member.name).replace(/%3\$s/g, model_.member.city_name),
                okay: onSendTroopsHomeConfirmButtonClick_
            })
        };
    var onSendTroopsHomeConfirmButtonClick_ = function (e) {
            var params = Object.clone(g_ajaxparams);
            params.mid = model.march_id;
            params.cid = model.city.id;
            params.fromUid = model.member.id;
            params.fromCid = model.member.city_id;
            new Ajax.Request(g_ajaxpath + "ajax/kickoutReinforcements.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        if (rslt.updateSeed) {
                            update_seed(rslt.updateSeed)
                        }
                        onTroopsSentHome_()
                    } else {
                        Modal.showAlert(printLocalError(rslt.error_code || null, rslt.msg || null, rslt.feedback || null))
                    }
                },
                onFailure: function () {}
            })
        };
    var onTroopsSentHome_ = function () {
            do {
                var march = seed.queue_atkinc["m" + model_.march_id];
                if (!march || march.marchStatus != 2) {
                    break
                }
                seed.resources["city" + model_.city.id].rec1[3] = parseInt(seed.resources["city" + model_.city.id].rec1[3]) - model_.upkeep;
                delete seed.queue_atkinc["m" + model_.march_id]
            } while (false);
            setTimeout(function () {
                Modal.showAlert(g_js_strings.kickout_allies.troopshome)
            }, 50)
        };
    var init_ = function () {
            var buttons = view_.getButtons();
            buttons.back_to_report.click(onBackToReportButtonClick_);
            if (model.march_id) {
                buttons.send_troops_home.click(onSendTroopsHomeButtonClick_)
            }
        };
    init_()
};
cm.ReportModel = function (f) {
    var c = {
        life: "12",
        attack: "23",
        defense: "43",
        march: "6",
        range: "12",
        "training speed": "23"
    };
    var h = function (q) {
            var r = 0;
            for (k in q) {
                if (q.hasOwnProperty(k)) {
                    r++
                }
            }
            return r
        };
    var n = function (q, t) {
            var r = t && t > 0;
            var s = r ? " onclick='cm.ProfileController.open( " + t + ");return false;' " : "";
            return r ? "<a href='void(0);' class='" + (r ? "link" : "") + "' " + s + ">" + q + "</a>" : q
        };
    var a = function (r) {
            var t = "";
            if (r.atkxcoord != undefined || r.atkycoord != null) {
                var s = new cm.utils.CoordinateLink(r.atkxcoord, r.atkycoord);
                t = "<br>" + s.getHTML()
            }
            var q = {
                side: r.side,
                text: g_js_strings.commonstr.attackers + ": " + (r.atknm ? "(" + n(unescape(r.atknm), r.side1PlayerId) + ")" : "") + "    " + t + "   " + (r.winner == 1 ? " &nbsp; <span class='red'>" + g_js_strings.report_view.winner + "</span>" : "") + "<br />" + (r.s1KCombatLv ? g_js_strings.report_view.knight_combat_skill + ":" + r.s1KCombatLv + "<br />" : "") + (r.s1KLv ? g_js_strings.report_view.knight_combat_level + ":" + r.s1KLv : ""),
                troops: r.fght.s1,
                stats: r.bonus && r.bonus.mod ? r.bonus.mod.s1 : {},
                bonus_tab: {}
            };
            if (r.s1KCombatLv) {
                q.bonus_tab.knights_attack_defense = {
                    atk: r.s1KCombatLv,
                    def: r.s1KCombatLv
                }
            }
            if (r.s1ThroneRoomBoosts) {
                q.bonus_tab.throne_room = l(r.s1ThroneRoomBoosts)
            }
            if (r.bonus && r.bonus.tch && r.bonus.tch.s1 && h(r.bonus.tch.s1) > 0) {
                q.bonus_tab.research = r.bonus.tch.s1
            }
            if (r.s1atkBoost || r.s1defBoost) {
                q.bonus_tab.items = {
                    "Attack Boost": r.s1atkBoost,
                    "Defense Boost": r.s1defBoost
                }
            }
            if (r.s1guardianAtkBoost || r.s1guardianDefBoost || r.s1guardianMarchBoost) {
                q.bonus_tab.guardians = {};
                if (r.s1guardianAtkBoost) {
                    q.bonus_tab.guardians["Attack Boost"] = m(r.s1guardianAtkBoost)
                }
                if (r.s1guardianDefBoost) {
                    q.bonus_tab.guardians["Defense Boost"] = m(r.s1guardianDefBoost)
                }
                if (r.s1guardianMarchBoost) {
                    q.bonus_tab.guardians["March Boost"] = m(r.s1guardianMarchBoost)
                }
            }
            return q
        };
    var m = function (q) {
            return q ? (parseInt(q * 1000) / 10) + "%" : 0
        };
    var l = function (s) {
            var t = {};
            for (var q in s) {
                if (s.hasOwnProperty(q)) {
                    var r = cm.thronestats.effects && cm.thronestats.effects[q] && cm.thronestats.effects[q][1] ? cm.thronestats.effects[q][1] : q;
                    t[r] = s[q] + "%"
                }
            }
            return t
        };
    var g = function (r) {
            var t = "";
            if (r.xcoord != undefined || r.ycoord != null) {
                var s = new cm.utils.CoordinateLink(r.xcoord, r.ycoord);
                t = s.getHTML()
            }
            var q = {
                side: r.side,
                text: g_js_strings.commonstr.defenders + ": " + (r.defnm ? n(unescape(r.defnm), r.side0PlayerId) : "") + "<br>" + t + "  " + (r.winner == 0 ? " &nbsp; <span class='red'>" + g_js_strings.report_view.winner + "</span>" : "") + "<br />" + (r.s0KCombatLv && r.s0KCombatLv.toLowerCase && r.s0KCombatLv.toLowerCase() != "none" ? g_js_strings.report_view.knight_combat_skill + ":" + r.s0KCombatLv + "<br />" : "") + (r.s0KLv ? g_js_strings.report_view.knight_combat_level + ":" + r.s0KLv : ""),
                troops: r.fght.s0,
                stats: r.bonus && r.bonus.mod ? r.bonus.mod.s0 : {},
                bonus_tab: {}
            };
            if (r.s0KCombatLv) {
                q.bonus_tab.knights_attack_defense = {
                    atk: r.s0KCombatLv,
                    def: r.s0KCombatLv
                }
            }
            if (r.s0ThroneRoomBoosts) {
                q.bonus_tab.throne_room = l(r.s0ThroneRoomBoosts)
            }
            if (r.bonus && r.bonus.tch && r.bonus.tch.s0 && h(r.bonus.tch.s0) > 0) {
                q.bonus_tab.research = r.bonus.tch.s0
            }
            if (r.s0atkBoost || r.s0defBoost) {
                q.bonus_tab.items = {
                    "Attack Boost": i(r.s0atkBoost),
                    "Defense Boost": i(r.s0defBoost)
                }
            }
            if (r.s0guardianAtkBoost || r.s0guardianDefBoost || r.s0guardianMarchBoost) {
                q.bonus_tab.guardians = {};
                if (r.s0guardianAtkBoost) {
                    q.bonus_tab.guardians["Attack Boost"] = m(r.s0guardianAtkBoost)
                }
                if (r.s0guardianDefBoost) {
                    q.bonus_tab.guardians["Defense Boost"] = m(r.s0guardianDefBoost)
                }
                if (r.s0guardianMarchBoost) {
                    q.bonus_tab.guardians["March Boost"] = m(r.s0guardianMarchBoost)
                }
            }
            if (r.overwhelmed) {
                q.bottom_troop_count = g_js_strings.modal_messages_viewreports_view.overwhelmedinbattle
            }
            if (!r.fght.s0) {
                q.noTroops = true
            }
            return q
        };
    var e = function (q) {
            return stimgUrl + "img/" + q
        };
    var j = function (q) {
            return stimgUrl + "img/items/70/" + q
        };
    var i = function (q) {
            if (q == 0) {
                return 0
            }
            return parseInt(q) > 1 ? q + "%" : (q * 100) + "%"
        };
    var b = function (t, q) {
            if (q) {
                t.loot = [];
                t.loot[0] = t.gold;
                t.loot[4] = t.resource4;
                t.loot[2] = t.resource2;
                t.loot[1] = t.resource1;
                t.loot[3] = t.resource3;
                t.loot[6] = t.resource5
            }
            var u = [{
                pic: e("iron_30.png"),
                name: g_js_strings.commonstr.ore,
                details: t.loot ? t.loot[4] : "0"
            }, {
                pic: e("wood_30.png"),
                name: g_js_strings.commonstr.wood,
                details: t.loot ? t.loot[2] : "0"
            }, {
                pic: e("stone_30.png"),
                name: g_js_strings.commonstr.stone,
                details: t.loot ? t.loot[3] : "0"
            }, {
                pic: e("food_30.png"),
                name: g_js_strings.commonstr.food,
                details: t.loot ? t.loot[1] : "0"
            }, {
                pic: e("gold_30.png"),
                name: g_js_strings.commonstr.gold,
                details: t.loot ? t.loot[0] : "0"
            }];
            if (t.loot && t.loot[6]) {
                u[u.length] = {
                    pic: e("aetherstone_30.png"),
                    name: g_js_strings.report_view.aetherstone,
                    details: t.loot && t.loot[6] ? t.loot[6] : 0
                }
            }
            if (t.throneRoomDrop) {
                u[u.length] = {
                    pic: j("131.png"),
                    name: "Throne Item",
                    details: 1,
                    isThroneRoomItem: true,
                    throne_room_item: t.throneRoomDrop
                }
            }
            if (t && t.loot && t.loot[5] && typeof t.loot[5] == "object") {
                for (var s in t.loot[5]) {
                    if (t.loot[5].hasOwnProperty(s)) {
                        cm.log.l("itemnum=" + s);
                        if (!itemlist["i" + s]) {
                            cm.log.l("Item passed back from backend, in loot, is not defined in itemlist.")
                        } else {
                            var r = itemlist["i" + s].name;
                            u[u.length] = {
                                pic: j(s + (t.marchtype == 10 ? ".jpg" : ".png")),
                                name: "" + r,
                                details: 1
                            }
                        }
                    }
                }
            }
            return u
        };
    var d = 0;

    function o(s) {
        var q = [3007, 3008, 3009, 3001, 3003, 3011, 3002, 1038, 1028, 10021, 923, 2000, 9, 55, 351, 911, 361, 271, 261, 276, 277, 278, 3000, 1048];
        var r = q[d++];
        r = 3011;
        if (typeof s.loot !== "object") {
            s.loot = [];
            s.loot[5] = []
        }
        s.loot[5][r] = 1
    }
    var p = function (u) {
            var q, t = 0,
                s = ~~ (1 * u.winner);
            q = u.winner == 1 && u.side == 1 ? "wilderness_win" : "wilderness_lose";
            var r = false;
            if (u.tileType == 51 && r) {
                if (u.winner) {
                    q = "scenes_barbarian_win"
                } else {
                    q = "scenes_barbarian_lose"
                }
            } else {
                if (u.marchtype == 10) {
                    if (u.winner == 0) {
                        q = "df_lose"
                    } else {
                        q = "df_win"
                    }
                } else {
                    if (u.marchtype == 11) {
                        if (u.winner == 0) {
                            q = "scenes_darkForest_scout_lose"
                        } else {
                            q = "scenes_darkForest_scout_win"
                        }
                    } else {
                        if (u.darkForestConflict) {
                            q = "darkForestConflict"
                        } else {
                            if (u.marchtype == 1) {
                                q = "scenes_transport"
                            } else {
                                if (u.marchtype == 3 && u.side == "attacker") {
                                    if (u.winner == 0) {
                                        q = "scenes_scout_lose"
                                    } else {
                                        q = "scout_win_city"
                                    }
                                } else {
                                    if (u.marchtype == 8) {
                                        if (s == 0) {
                                            q = "barbarianraid_lose" + t
                                        } else {
                                            q = "barbarian_win" + t
                                        }
                                    } else {
                                        if (u.tileType != cm.TILE_TYPES.TILE_TYPE_CITY) {
                                            if (u.winner == 1 && u.side == "attacker" || u.winner == 2 && u.side == "attacker") {
                                                q = "wilderness_win"
                                            } else {
                                                if (u.winner == 0 && u.side == "defender") {
                                                    q = "wilderness_win"
                                                } else {
                                                    if (u.winner == 0 && u.side == "attacker" || u.winner == 1 && u.side == "defender") {
                                                        q = "wilderness_lose"
                                                    } else {
                                                        if (u.winner == 1 && u.side == "defender" || u.winner == 2 && u.side == "defender") {
                                                            q = "wilderness_win"
                                                        }
                                                    }
                                                }
                                            }
                                        } else {
                                            if (u.defenderId == 0) {
                                                if (u.winner == 1 && u.side == "attacker" || u.winner == 2 && u.side == "attacker") {
                                                    q = "scenes_barbarian_win"
                                                } else {
                                                    if (u.winner == 0 && u.side == "attacker") {
                                                        q = "scenes_barbarian_lose"
                                                    }
                                                }
                                            } else {
                                                if (u.winner == 1 && u.side == "attacker" || u.winner == 2 && u.side == "attacker") {
                                                    q = "scenes_battle_win01"
                                                } else {
                                                    if (u.winner == 0 && u.side == "attacker") {
                                                        q = "scenes_battle_lose"
                                                    } else {
                                                        if (u.winner == 0 && u.side == "defender") {
                                                            q = "defend_victory"
                                                        } else {
                                                            if (u.winner == 1 || u.winner == 2 && u.side == "defender") {
                                                                q = "defend_defeat"
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            return q
        };
    return {
        parseLeft: a,
        parseRight: g,
        parseLoot: b,
        getReportType: p,
        percent: i
    }
}(jQuery);
cm.ReportView = function (f) {
    var x = [];
    var g = function (A) {
            x = [];
            switch (A.marchtype) {
            case 1:
                x.push(g_js_strings.modal_messages_viewreports_view.from + " ");
                var B = new cm.utils.CoordinateLink(A.atkxcoord, A.atkycoord);
                B.setClassName("light_blue");
                x.push(" " + B.getHTML());
                x.push(" - " + g_js_strings.modal_messages_viewreports_view.transpto + " ");
                break;
            case 3:
            case 11:
                if (A.side == "attacker") {
                    x.push(g_js_strings.modal_messages_viewreports_view.scoutingat + " ")
                } else {
                    x.push(g_js_strings.modal_messages_viewreports_view.antiscoutingat + " ")
                }
                break;
            case 4:
            case 10:
                x.push(g_js_strings.modal_messages_viewreports_view.battleat + " ");
                break
            }
            if (A.tileType == 54) {
                x.push(g_js_strings.commonstr.darkForest);
                x.push(" " + g_js_strings.commonstr.lv + A.tileLevel)
            } else {
                if (A.tileType != 51) {
                    x.push(g_mapObject.types[parseInt(A.tileType)].capitalize());
                    x.push(" " + g_js_strings.commonstr.lv + A.tileLevel)
                } else {
                    if (A.defenderId == 0) {
                        x.push(g_js_strings.commonstr.barbariancamp);
                        x.push(" " + g_js_strings.commonstr.lv + A.tileLevel)
                    }
                }
            }
            var B = new cm.utils.CoordinateLink(A.xcoord, A.ycoord);
            B.setClassName("light_blue");
            x.push(" " + B.getHTML());
            if (A.marchType != 1 && A.conquered == 1) {
                x.push(" - <span>" + g_js_strings.commonstr.conquered + "</span>")
            }
            A.attackerUnits = A.fght ? A.fght.s1 : {};
            A.defenderUnits = A.fght ? A.fght.s0 : {};
            return j(A) + y(A) + p(A) + c(A)
        };
    var y = function (A) {
            return "<span class='details'>" + x.join(" ") + " - " + formatDateByUnixTime(A.timestamp) + "  Report No: " + A.rptid + "</span><br>"
        };
    var j = function (C) {
            var B = (C.side == "attacker" && C.winner > 0) || (C.side == "defender" && C.winner == 0);
            var A = "";
            if (C.marchtype == 1) {
                A = g_js_strings.report_view.transport_success
            } else {
                if (C.darkForestConflict) {
                    A = g_js_strings.report_view.darkForestConflict
                } else {
                    A = B ? g_js_strings.report_view.won : g_js_strings.report_view.lost
                }
            }
            if (B) {
                cm.sounds.play("player_views_battle_report_and_won")
            } else {
                cm.sounds.play("player_views_battle_report_and_lost")
            }
            return "<h2>" + A + "</h2>"
        };
    var p = function (A) {
            return (A.tileType == 54 ? cm.MarchReportView.renderEffectiveHint(A) : "")
        };
    var c = function (D) {
            var C = "";
            if (D.lstlgn) {
                C = "<div class='lastLogin'>" + g_js_strings.report_view.enemies_last_login + ": " + formatDateByUnixTime(D.lstlgn) + "</div>"
            }
            var B = cm.GloryView.render();
            if (!B) {
                B = ""
            }
            var A = D.scrbrkdwn ? g_js_strings.report_view.knight_level + ": " + D.scrbrkdwn.knghtntl + "   " + g_js_strings.report_view.scout_level + ": " + D.scrbrkdwn.sctlvl : "";
            return C + (D.marchtype == 3 && D.score ? "<div class='scouting_score' title='" + A + "'>" + g_js_strings.report_view.scout_score + ": " + D.score + "</div>" : "") + B
        };
    var v = function (E) {
            var G = "";
            for (var F = 0; F < E.length; F++) {
                var C = E[F];
                var B = "";
                var H = "<img src='" + C.pic + "' />";
                var D = "";
                if (C.isThroneRoomItem) {
                    var A = C.throne_room_item;
                    var I = kocThroneItems[A.id];
                    if (typeof I != "object") {
                        cm.ThroneController.addItem(A);
                        var I = kocThroneItems[A.id];
                        cm.log.l("Could not find throne room item definition.  So I'm adding the throne room item definition now.  I guess updateSeed hasn't fired yet.")
                    }
                    if (typeof I == "object") {
                        C.name = I.name;
                        H = "<span class='throne_item_box " + A.faction + " " + A.type + "'  />";
                        D = "throne_right"
                    } else {
                        cm.log.l("Warning: kocThroneItems is not returning an object.  Perhaps it's a bad throne_room_item.id ?")
                    }
                } else {
                    B = ":<br><span class='num'>" + addCommas(C.details) + "</span>"
                }
                G += "<div class='section'>" + H + "<div class='right " + D + "'><strong>" + C.name + "</strong>" + B + "</div></div>"
            }
            return "<div class='lootBody'><div class='title'>" + g_js_strings.report_view.loot_acquired + "</div>" + G + "</div>"
        };
    var u = function (E, A, B) {
            var D = {};
            var C = {
                "53": "d1",
                "61": "d4",
                "62": "d5",
                "55": "d2",
                "60": "d3"
            };
            if (E.charAt(0) == "u") {
                D.unitId = E.split("u")[1] || E;
                D.image = B ? stimgUrl + "img/rt" + D.unitId + ".png" : stimgUrl + "img/units/unit_" + D.unitId + "_30_s34.jpg";
                D.unitsInfoValue = A["u" + D.unitId] || A[D.unitId];
                D.name = unitcost["unt" + D.unitId] ? unitcost["unt" + D.unitId][0] : "Troops"
            } else {
                if (E.charAt(0) == "m") {
                    D.unitId = E.split("m")[1] || E;
                    D.image = B ? stimgUrl + "img/L" + D.unitId + ".png" : stimgUrl + "img/units/unit_" + D.unitId + "_30.jpg";
                    D.unitsInfoValue = A["m" + D.unitId] || A[D.unitId];
                    D.name = g_js_strings.monsterUnitsNames["m" + D.unitId]
                } else {
                    if (E.charAt(0) == "f") {
                        D.unitId = E.split("f")[1] || E;
                        D.image = B && C["" + D.unitId] ? stimgUrl + "img/" + C["" + D.unitId] + ".png" : stimgUrl + "img/units/unit_" + D.unitId + "_30.jpg";
                        D.unitsInfoValue = A["f" + D.unitId] || A[D.unitId];
                        D.name = fortcost["frt" + D.unitId] ? fortcost["frt" + D.unitId][0] : "Defenses"
                    }
                }
            }
            return D
        };
    var n = function (B) {
            var C = "<tr class='top_row'><td></td><td class='col0'>" + g_js_strings.report_view.troops + "</td><td class='col1'>" + g_js_strings.report_view.fought + "</td><td class='col2'>" + g_js_strings.report_view.survived + "</td></tr>";
            for (var E in B) {
                if (B.hasOwnProperty(E)) {
                    var A = u(E, B);
                    if (A.image === undefined) {
                        cm.log.l("TroopLoss_(): Troop type: " + E + "  Troop image not defined.")
                    } else {
                        if (A.name === undefined) {
                            cm.log.l("TroopLoss_(): Troop type: " + E + "  Troop name not defined.")
                        } else {
                            var D = {
                                troop_src: A.image,
                                troop_type: A.name,
                                troop_fought: ~~ (1 * B[E][0]),
                                troop_survived: ~~ (1 * B[E][1])
                            };
                            C += "<tr class='middle_row'><td><img class='troop_src' src='" + D.troop_src + "' /></td><td class='col0'>" + D.troop_type + "</td><td class='col1'>" + addCommas(D.troop_fought) + "</td><td class='col2'>" + addCommas(D.troop_survived) + "</td></tr>"
                        }
                    }
                }
            }
            return "<table cellpadding='0' cellspacing='0'>" + C + "</table>"
        };
    var l = {
        atk: "Attack",
        def: "Defense",
        hp: "Life",
        upk: "Upkeep",
        spd: "Speed",
        rng: "Range",
        ld: "Load",
        type: "Type"
    };
    var h = function (E) {
            var B = "";
            for (var D in E) {
                var C = Math.round(E[D][0]);
                var F = Math.round(E[D][1]);
                var A = F > C ? "green" : (F < C ? "red" : "");
                if (E.hasOwnProperty(D)) {
                    B += "<div class='mini_stat' title='Base Stat: " + C + "'><b>" + (l[D] || D) + ":</b> <span class='" + A + "'>" + F + "</span></div>"
                }
            }
            return B
        };
    var t = function (B) {
            var A = (B * 100) < 100;
            return A ? parseInt(B * 100) + "%" : B
        };
    var d = function (E, D) {
            var B = "";
            var C = 0;
            if (!D) {
                D = " goliath_div"
            }
            for (var F in E) {
                if (E.hasOwnProperty(F)) {
                    var A = (C == 2 || C == 3 || C == 6 || C == 7 ? " odd_row" : "");
                    var G = (Math.floor(C / 2) % 2 == 1) ? " stripe_light" : "";
                    B += "<div class='mini_stat " + G + D + A + "' >" + (l[F] || F) + ": " + t(E[F]) + "</div>";
                    C++
                }
            }
            if (C % 2 == 1) {
                B += "<div class='mini_stat goliath_div odd_row back_color'>_</div>"
            }
            return B
        };
    var i = function (B) {
            var A = "";
            var D = {};
            var C = true;
            for (var F in B) {
                if (B.hasOwnProperty(F)) {
                    var E = u(F, D, true);
                    C = !C;
                    if (E.image === undefined) {
                        cm.log.l("Troop type: " + F + "  Troop image not defined.")
                    } else {
                        if (E.name === undefined) {
                            cm.log.l("Troop type: " + F + "  Troop name not defined.")
                        } else {
                            A += "<div class='troop_section " + (C ? "odd" : "") + "'><img src='" + E.image + "'><div class='st'><div class='name'>" + E.name + "</div><div class='v_stats'>" + h(B[F]) + "</div></div></div>"
                        }
                    }
                }
            }
            return A
        };
    var o = function (A) {
            var B = "";
            if (A.throne_room) {
                B += "<div class='b_header'>" + g_js_strings.report_view.throne_room + "</div>";
                B += d(A.throne_room, "wide_stat")
            }
            if (A.knights_attack_defense) {
                B += "<div class='b_header'>" + g_js_strings.report_view.knights + "</div>";
                B += d(A.knights_attack_defense)
            }
            if (A.research) {
                B += "<div class='b_header'>" + g_js_strings.report_view.research + "</div>";
                B += d(A.research)
            }
            if (A.items) {
                B += "<div class='b_header'>" + g_js_strings.report_view.items + "</div>";
                B += d(A.items)
            }
            if (A.guardians) {
                B += "<div class='b_header'>" + g_js_strings.report_view.guardian + "</div>";
                B += d(A.guardians)
            }
            return B
        };
    var q = function (E, B) {
            var F = (B == "right" && E.side == "defender") || (B == "left" && E.side == "attacker");
            var A = false;
            var D = E.bottom_troop_count ? "<div class='overwhelmed'>" + E.bottom_troop_count + "</div>" : "";
            var C = E.noTroops ? "<div class='notroops'>" + g_js_strings.report_view.noTroops + "</div>" : "";
            return "<div class='report_middle_text'>" + E.text + "</div>" + (cm.WorldSettings.isOn("TR_KILLSWITCH") ? "" : "<a class='buttonv2 blue h15 throne_room_button'>" + g_js_strings.report_view.throne_room + "</a>") + (F ? "<a class='buttonv2 brown h15 inventory_button'>" + g_js_strings.report_view.inventory + "</a>" : "") + (A ? "<a class='buttonv2 brown h15 attack_button'>" + g_js_strings.report_view.attack + "</a>" : "") + "<div class='tab_detail_area'><div class='black_tab'><div side='" + B + "' tab='0'  class='tab tab0'>" + g_js_strings.report_view.tab0 + "</div><div side='" + B + "' tab='1'  class='tab tab1'>" + g_js_strings.report_view.tab1 + "</div><div side='" + B + "' tab='2'  class='tab tab2'>" + g_js_strings.report_view.tab2 + "</div></div><div class='small_tab_bar'></div></div><div class='detail_main detail_main0'>" + n(E.troops) + D + C + "</div><div class='detail_main detail_main1'>" + i(E.stats) + "</div><div class='detail_main detail_main2'>" + o(E.bonus_tab) + "</div>"
        };
    var b = function (A) {
            return ""
        };
    var a = function () {
            var B = f(this).attr("side");
            var A = f(this).attr("tab");
            f("." + B + "_details .tab").removeClass("active");
            f("." + B + "_details .tab" + A).addClass("active");
            f("." + B + "_details .detail_main").hide();
            f("." + B + "_details .detail_main" + A).show()
        };
    var k = function (A) {
            return "<div class='scout_tab_section'><div class='black_tab'><div class='tab tab0' tab='0'>" + g_js_strings.report_view.troop0 + "</div><div class='tab tab1' tab='1'>" + g_js_strings.report_view.defenses + "</div><div class='tab tab2' tab='2'>" + g_js_strings.report_view.buildings + "</div><div class='tab tab3' tab='3'>" + g_js_strings.report_view.research + "</div><div class='tab tab4' tab='4'>" + g_js_strings.report_view.resources + "</div></div><div class='scout_detail_main scout_detail_main0'>" + r(A.unts, "Troop type", "count") + "</div><div class='scout_detail_main scout_detail_main1'>" + r(A.frt, "Defense type", "count") + "</div><div class='scout_detail_main scout_detail_main2'>" + r(A.blds, "Building type", "level") + "</div><div class='scout_detail_main scout_detail_main3'>" + r(A.tch, "Research type", "level") + "</div><div class='scout_detail_main scout_detail_main4'>" + r(A.rsc, "Resource", "Amount") + "</div></div>"
        };
    var r = function (G, F, D) {
            var C = 0;
            var B = "";
            B += "<div class='quarter stripe_dark'>" + cm.translate.it(F) + "</div><div class='quarter stripe_dark'>" + cm.translate.it(D) + "</div>";
            B += "<div class='quarter stripe_dark'>" + cm.translate.it(F) + "</div><div class='quarter stripe_dark'>" + cm.translate.it(D) + "</div>";
            for (var A in G) {
                if (G.hasOwnProperty(A)) {
                    var E = C % 4 == 2 || C % 4 == 3 ? "stripe_light" : "";
                    C++;
                    B += "<div class='quarter " + E + "'>" + cm.translate.it(A) + "</div><div class='quarter " + E + "'>" + addCommas(parseInt(G[A])) + "</div>"
                }
            }
            if (C == 0) {
                return "<div class='padding5'>" + g_js_strings.report_view.no_scouting_info + "</div>"
            } else {
                return B
            }
        };
    var m = function () {
            var A = f(this).attr("tab");
            f(".scout_tab_section .tab").removeClass("active");
            f(".scout_tab_section .tab" + A).addClass("active");
            f(".scout_detail_main").hide();
            f(".scout_detail_main" + A).show()
        };
    var z = function (A) {
            return A.marchtype == 3 && A.side == "attacker" && A.winner == 1
        };
    var w = function (B) {
            var A = cm.ReportModel.getReportType(B) + ".jpg";
            var D = "<a class='buttonv2 blue h15 blueGlow back_to_reports transport_back'>" + g_js_strings.report_view.back_to_reports + "</a>";
            var C = (z(B) ? k(B) : "");
            f(".report_view").remove();
            f(".modal_msg_listwrap").append("<div class='report_view " + (z(B) ? "scouting_report" : "") + "'><img class='main_battle_pic' src='" + stimgUrl + "img/" + A + "' /><div class='top_message'>" + g(B) + "</div>" + (B.marchtype == 3 || B.darkForestConflict ? "" : v(cm.ReportModel.parseLoot(B, B.marchtype == 1))) + (B.marchtype == 1 ? D : "<div class='bottom_report'><div class='left_details detail_section'>" + q(cm.ReportModel.parseLeft(B), "left") + "</div><div class='right_details detail_section'>" + q(cm.ReportModel.parseRight(B), "right") + "</div><div class='research_resources'>" + b(B) + "</div><a class='buttonv2 blue h15 blueGlow back_to_reports'>" + g_js_strings.report_view.back_to_reports + "</a>" + C + "</div>") + "</div>");
            cm.GloryView.set(B);
            if (z(B)) {
                f(".modal_msg_listwrap").css("height", "740px")
            } else {
                if (B.marchtype == 3) {
                    f(".modal_msg_listwrap").css("height", "620px")
                } else {
                    if (B.darkForestConflict) {
                        f(".modal_msg_listwrap").css("height", "590px")
                    } else {
                        if (B.marchtype == 1) {
                            f(".modal_msg_listwrap").css("height", "378px")
                        } else {
                            f(".modal_msg_listwrap").css("height", "670px")
                        }
                    }
                }
            }
            f(".left_details .throne_room_button").unbind("click").bind("click", function () {
                var E = B.side == "attacker";
                cm.log.l("me=" + E);
                cm.ThroneView.openThrone(E)
            });
            f(".right_details .throne_room_button").unbind("click").bind("click", function () {
                var E = B.side == "defender";
                cm.log.l("me=" + E);
                cm.ThroneView.openThrone(E)
            });
            f(".scout_tab_section .tab").unbind("click").bind("click", m);
            f(".detail_section .tab").unbind("click").bind("click", a);
            f(".left_details .tab0").trigger("click");
            f(".right_details .tab0").trigger("click");
            f(".scout_tab_section .tab0").trigger("click");
            f(".back_to_reports").unbind("click").bind("click", function () {
                var E = f("#navCur").val();
                loadPage_pagination("modal_msg_list_pagination", E, "modal_messages_viewreports", E)
            });
            f(".inventory_button").unbind("click").bind("click", cm.InventoryView.openInventory);
            f(".attack_button").unbind("click").bind("click", s)
        };
    var s = function () {};
    var e = function () {
            var A = false;
            if (A) {
                modal_messages();
                setTimeout(function () {
                    AjaxCall.gPostRequest("ajax/fetchReport.php", {
                        rid: 2529,
                        side: 1,
                        testLoot: 0
                    }, function (B) {
                        cm.ReportView.render(B)
                    })
                }, 2000)
            }
        };
    return {
        render: w,
        development: e
    }
}(jQuery);
var cm = cm || {};
cm.ResearchSpeedupController = new function () {
    var c = function (g) {
            var f = Event.element(g);
            while (!f.name) {
                f = f.parentNode
            }
            var d = f.name;
            return d
        };
    var a = "Speedup_Research_Click";
    var b = "tch";
    this.queueClick = function (h) {
        var d = c(h),
            f = seed.queue_tch["city" + currentcityid][0],
            g = techcost["tch" + f[0]][0] + " (" + g_js_strings.commonstr.lv + f[1] + ")";
        modal_speedup(b, d, undefined, g);
        cm.MixPanelTracker.track(a, {
            from: "queue"
        })
    };
    this.popupClick = function (f) {
        var d = c(f);
        modal_speedup(b, d);
        cm.MixPanelTracker.track(a, {
            from: "popup"
        })
    }
};
cm.ResearchController = function (b, a) {
    var c = this;
    var d = b;
    var e = a;
    this.researchButtonClicked = function (j) {
        var i = Event.findElement(j, "a");
        var f = i.name;
        var g = d.researches[f];
        var h = g.getHelped() ? 1 : 0;
        upg_tch(f, g.getCurrentLevel() + 1, h)
    };
    this.checkboxChanged = function (i) {
        var h = i.srcElement ? i.srcElement : i.target;
        var f = h.name;
        for (var f in d.researches) {
            var g = d.researches[f];
            g.setHelped(h.checked);
            e.getElement(f, "checkboxId").checked = g.getHelped();
            e.getElement(f, "timeTextId").innerHTML = g.getTime()
        }
    }
};
cm.ResearchModel = function (f) {
    var b = f.baseTime;
    var a = f.speedTime;
    var c = f.helped;
    var d = f.techId;
    var e = f.currentLevel;
    this.setHelped = function (g) {
        c = g
    };
    this.getHelped = function () {
        return c
    };
    this.getTime = function () {
        return c ? a : b
    };
    this.getCurrentLevel = function () {
        return e
    }
};
cm.ResearchCollectionModel = function (b) {
    var a = this;
    this.researches = {};
    for (techId in b) {
        var c = b[techId];
        c.techId = techId;
        this.researches[techId] = new cm.ResearchModel(c)
    }
};
cm.ResearchView = function (b, f) {
    var c = this;
    var a = b;
    var e = f;
    var d = function () {
            for (var g in e.researches) {
                var h = e.researches[g];
                c.getElement(g, "checkboxId").checked = h.getHelped();
                c.getElement(g, "timeTextId").innerHTML = h.getTime()
            }
        };
    this.getElement = function (h, g) {
        return $(a[h.toString()][g])
    };
    d()
};
cm.ResearchView.BUTTON_PREFIX = "techButton";
cm.ResearchView.TIMETEXT_PREFIX = "timeText";
cm.ResearchView.CHECKBOX_PREFIX = "techCheckbox";
var researchCollectionModel;
var researchController;
var researchView;
if (!window.Research) {
    var Research = new Object()
}
Research.Properties = {};
Research.Methods = {
    openAlchemy: function () {
        removeTooltip();
        var o = new Array();
        o.push("<div class='alchemymodal' id='alchemymodal'>");
        o.push("<div class='tabsbar'>");
        o.push("<a class='tab selected'><span>" + g_js_strings.modal_openAlchemy.resitms + "</span></a>");
        o.push("</div>");
        o.push("<div class='alchemywrap' id='alchemywrap'>");
        o.push("<div class='tableheader'><table cellpadding='0' cellspacing='0'><thead><tr><td class='tch'><div>" + g_js_strings.commonstr.technology + "</div></td><td class='res'><div>" + g_js_strings.commonstr.resource + "</div></td><td class='req'><div>" + g_js_strings.commonstr.required + "</div></td><td class='own'><div>" + g_js_strings.commonstr.youown + "</div></td></tr></thead></table></div>");
        o.push("<div class='techlist'>");
        var e = Object.keys(techcost);
        o.push("<table cellpadding='0' cellspacing='0'><tbody>");
        var A = 0;
        if (seed.queue_tch["city" + currentcityid].length > 0) {
            A = parseInt(seed.queue_tch["city" + currentcityid][0][0])
        }
        var b = new Array();
        var d = Object.keys(seed.queue_tch);
        for (var u = 0; u < d.length; u++) {
            if (d[u] != "city" + currentcityid) {
                if (seed.queue_tch[d[u]].length > 0) {
                    b.push(parseInt(seed.queue_tch[d[u]][0][0]))
                }
            }
        }
        var a = new Object();
        var y = new Object();
        var k = false;
        for (var u = 0; u < e.length; u++) {
            var z = techcost[e[u]];
            var m = parseInt(e[u].split("tch")[1]);
            var w = parseInt(seed.tech[e[u]]);
            var x = checkreq("tch", m, (parseInt(seed.tech[e[u]]) + 1));
            var s = new Array();
            var l = new Array();
            var q = new Array();
            var p = true;
            if (w < 11) {
                for (var t = 0; t < x[0].length; t++) {
                    s.push("<div>");
                    s.push(x[0][t]);
                    s.push("</div>");
                    if (x[3][t] == 0) {
                        p = false;
                        l.push("<div class='unmet'>")
                    } else {
                        l.push("<div class='met'>")
                    }
                    if (parseInt(x[1][t]) > 0) {
                        l.push(addCommas(parseInt(x[1][t])))
                    } else {
                        l.push(x[1][t])
                    }
                    l.push("</div>");
                    q.push("<div>");
                    if (parseInt(x[2][t]) > 0) {
                        q.push(addCommas(parseInt(x[2][t])))
                    } else {
                        q.push(x[2][t])
                    }
                    q.push("</div>")
                }
            } else {
                p = false
            }
            if (u % 2 == 1) {
                o.push("<tr class='stripe'>")
            } else {
                o.push("<tr>")
            }
            o.push("<td class='tchlist_img'><img src='");
            o.push(stimgUrl);
            o.push("img/tech/");
            o.push(m);
            o.push("_s33.png'/></td>");
            o.push("<td class='tchlist_info'>");
            o.push("<div class='techhd'>");
            o.push(z[0]);
            o.push(" (" + g_js_strings.commonstr.lv + " ");
            o.push(seed.tech[e[u]]);
            o.push(")</div>");
            o.push("<div class='desc'>");
            o.push(techcost[e[u]][10]);
            o.push("</div>");
            var n = false;
            for (var t = 0; t < b.length; t++) {
                if (m == b[t]) {
                    n = true;
                    t = b.length
                }
            }
            if (n) {
                o.push("<div class='btns clearfix'><b>" + g_js_strings.modal_openAlchemy.currentlyres + "</b></div>")
            } else {
                if (parseInt(seed.tech[e[u]]) < 11 && A == 0 && p) {
                    var v = 0;
                    var c = seed.knights["city" + currentcityid];
                    if (c) {
                        c = c["knt" + seed.leaders["city" + currentcityid].intelligenceKnightId];
                        if (c) {
                            v = parseInt(c.intelligence);
                            v = ((parseInt(c.intelligenceBoostExpireUnixtime) - unixtime()) > 0) ? (v * 1.25) : v
                        }
                    }
                    var r = "";
                    var g = Math.pow(2, parseInt(seed.tech[e[u]]));
                    var f = cm.ThroneController.effectBonus(80);
                    var h = parseInt(techcost[e[u]][7] * g * (1 / (1 + 0.005 * v)));
                    h = Math.round(h / (1 + f / 100));
                    y[m.toString()] = {
                        buttonId: cm.ResearchView.BUTTON_PREFIX + m,
                        timeTextId: cm.ResearchView.TIMETEXT_PREFIX + m,
                        checkboxId: cm.ResearchView.CHECKBOX_PREFIX + m
                    };
                    a[m.toString()] = {
                        currentLevel: w,
                        baseTime: timestr(h),
                        speedTime: timestr(Math.max(h - 600, 0)),
                        helped: k
                    };
                    o.push("<div class='buttonRow'>");
                    o.push("<a class='buttonDown20' id='" + y[m.toString()].buttonId + "' name='" + m + "' onclick='researchController.researchButtonClicked(event);return false'>");
                    o.push("<span>" + g_js_strings.commonstr.research + "</span></a> ");
                    o.push("<span>" + g_js_strings.commonstr.time + ": <span class='timeText' id='" + y[m.toString()].timeTextId + "'>" + a[m.toString()].speedTime + "</span></span>");
                    o.push("</div>");
                    o.push("<div class='checkboxRow'>");
                    o.push("<div>");
                    o.push("<a class='helptext' onclick='Modal.showAlert(\"");
                    o.push(g_js_strings.modal_build.whatsthiscontent);
                    o.push("\");return false;'>");
                    o.push(g_js_strings.modal_build.whatsthis);
                    o.push("</a>");
                    o.push("</div>");
                    o.push("<div>");
                    o.push("<input id='" + y[m.toString()].checkboxId + "' name='" + m + "' type='checkbox' onclick='researchController.checkboxChanged(event)' />");
                    o.push("<label for='" + y[m.toString()].checkboxId + "'>");
                    o.push(g_js_strings.modal_build.sharemessagebuildorresearch);
                    o.push("</label>");
                    o.push("</div>");
                    o.push("</div>")
                } else {
                    if (m == A) {
                        o.push("<div class='btns clearfix'><a class='inlineButton20Red' name='" + m + "' onclick='cm.ResearchSpeedupController.popupClick(event)'>");
                        o.push("<span>" + g_js_strings.commonstr.speedup + "</span></a></div>");
                        o.push("<div class='timerem'>" + g_js_strings.commonstr.timeremaining + ": <span id='alchemymodal_tch");
                        o.push(m);
                        o.push("_queue_timeleft'>");
                        o.push(timestr(parseInt(seed.queue_tch["city" + currentcityid][0][3]) - unixtime()));
                        o.push("</span></b></div>");
                        if (getTechHelpEligible(m, currentcityid) == false) {
                            o.push("<div class='btns clearfix'><a class='button20' onclick='tch_gethelp(");
                            o.push(m);
                            o.push(");return false;'><span>" + g_js_strings.modal_quests.askhelp + "</span></a>");
                            o.push("<a class='helptext' onclick='Modal.showAlert(\"");
                            o.push(g_js_strings.modal_build.whatsthiscontent);
                            o.push("\");return false;'>");
                            o.push(g_js_strings.modal_build.whatsthis);
                            o.push("</a>");
                            o.push("</div>")
                        }
                    } else {
                        if (!p) {
                            if (w < 11) {
                                o.push("<div class='btns clearfix'><b class='unmet'>" + g_js_strings.modal_openAlchemy.reqnotmet + "</b></div>")
                            } else {
                                o.push("<div class='btns clearfix'><b class='maxlv'>" + g_js_strings.modal_openAlchemy.maxres + "</b></div>")
                            }
                        }
                    }
                }
            }
            o.push("</td>");
            o.push("<td class='tchlist_res'>");
            o.push(s.join(""));
            o.push("</td>");
            o.push("<td class='tchlist_req'>");
            o.push(l.join(""));
            o.push("</td>");
            o.push("<td class='tchlist_own'>");
            o.push(q.join(""));
            o.push("</td>");
            o.push("</tr>")
        }
        o.push("</tbody></table>");
        o.push("</div>");
        o.push("</div>");
        o.push("</div>");
        $("modal_build_content").innerHTML = o.join("");
        researchCollectionModel = new cm.ResearchCollectionModel(a);
        researchView = new cm.ResearchView(y, researchCollectionModel);
        researchController = new cm.ResearchController(researchCollectionModel, researchView)
    },
    shareBtnTooltip: function (a) {
        var b = "<div>" + g_js_strings.modal_openAlchemy.reshelp_tooltip + "</div>";
        Tooltip.show(a, b)
    }
};
Object.extend(Research, Research.Methods);
Object.extend(Research, Research.Properties);

function modal_openAlchemy() {
    Research.openAlchemy()
};
var cm = cm || {};
cm.ResourceLoader = (function (e) {
    var h = false,
        g = [];
    var d = function (k, i, j) {
            j = j || {};
            g.push({
                type: k,
                url: i,
                extraOptions: j
            });
            c()
        };
    var a = function () {
            e(window).load(function () {
                setTimeout(f, 0)
            })
        };
    var b = function () {
            a();
            setTimeout(f, 20000)
        };
    var c = function (m, j, l) {
            if (!h) {
                return
            }
            var k = 0,
                n = g.length;
            if (n < 1) {
                return
            }
            for (k = 0; k < n; k++) {
                e(document).ready(function () {
                    setTimeout(function () {
                        var p = document.createElement("script"),
                            i = document.getElementsByTagName("script"),
                            o = g.shift();
                        if (!o) {
                            return
                        }
                        p.type = "text/javascript";
                        p.async = !! o.extraOptions.async;
                        if (o.extraOptions.callback) {
                            e(p).load(o.extraOptions.callback)
                        }
                        p.src = o.url;
                        i[i.length - 1].parentNode.appendChild(p)
                    }, 0)
                })
            }
        };
    var f = function () {
            e(window).unbind("load", f);
            if (h) {
                return
            }
            h = true;
            c()
        };
    b();
    return {
        add: d
    }
})(jQuery);
cm.LevelUpReward = function () {
    cm.CustomEventDispatcher.call(this);
    var b = this;
    var c = function (d) {
            var e = new cm.RewardEvent(cm.RewardEvent.SUCCESS);
            b.dispatchCustomEvent(e)
        };
    var a = function () {
            var d = new cm.RewardEvent(cm.RewardEvent.FAILURE);
            b.dispatchCustomEvent(d)
        };
    this.claim = function (d) {
        var e = Object.clone(g_ajaxparams);
        e.cid = currentcityid;
        e.qid = d;
        new Ajax.Request(g_ajaxpath + "ajax/quest.php" + g_ajaxsuffix, {
            method: "post",
            parameters: e,
            onSuccess: function (g) {
                var f = g.responseText.evalJSON();
                if (f.ok) {
                    c(d);
                    update_seed(f.updateSeed)
                } else {
                    a()
                }
            },
            onFailure: function () {
                a()
            }
        })
    }
};
cm.OOP.inherits(cm.LevelUpReward, cm.CustomEventDispatcher);
cm = cm || {};
cm.SalesPromotionView = function (d) {
    var c = function (i) {
            var g = (seed.tutorial.t1 >= 19),
                f = Math.max(+(i.expireTime || 0) - unixtime(), 0),
                h = Math.floor(f / 60);
            if (!readCookie("salesPromo") && g) {
                a(i);
                createCookie("salesPromo", true, h)
            }
            if (f) {
                e(i)
            }
        };
    var b = function (k) {
            var j = g_js_strings.salesPromotion,
                h = (k.rewards && k.rewards.items) ? k.rewards.items : {},
                g = 5,
                i = "speed-ups",
                m = [],
                f = k.discountPercentage ? (j.percentOff).replace("%1$s", k.discountPercentage) : "",
                l = +k.expireTime - unixtime();
            d.each(h, function (o, n) {
                m.push(cm.Template.renderTemplate("SalesPromotion", "saleRewardItem", {
                    itemId: o,
                    itemName: ksoItems[o].name,
                    itemAmount: n
                }))
            });
            return cm.Template.renderTemplate("SalesPromotion", "saleBody", {
                title: j.title,
                saleImageId: g,
                header: (j.comingBackSale).replace("%1$s", i),
                discountAmount: f,
                itemsHeader: j.freeItemsForReturning,
                itemList: m.join(""),
                timeLeftString: l ? j.offerEnds : "",
                timeLeftAmount: l ? timestr(l) : "",
                buttonString: j.goToShop
            })
        };
    var a = function (g) {
            var f = b(g);
            cm.ModalManager.add({
                body: f,
                closeNow: true,
                close: function () {},
                lower: false,
                "class": "salesPromotion",
                curtain: true,
                width: 645,
                height: 409,
                left: 59,
                top: 120,
                z: 123455
            });
            d(".salesPromotion .button").bind("click", function () {
                cm.ModalManager.close();
                cm.ShopView.openShop()
            })
        };
    var e = function (g) {
            var h, f;
            if (g.expireTime && d("#impendingAttackContainer").html() === "") {
                h = +(g.expireTime) - unixtime();
                f = g_js_strings.commonstr.speedup + " " + g_js_strings.salesPromotion.saleTimeLeft + ' <span id="promoTimeLeftCountdown">' + timestr(h) + "</span>";
                d("#promoTimeLeft").html(f).show().bind("click", function () {
                    cm.ShopView.openShop()
                });
                CountDown.addCountDown("promoTimeLeftCountdown salesPromoModalCountdown", h, function () {
                    d("#promoTimeLeft").hide()
                })
            } else {
                d("#promoTimeLeft").hide()
            }
        };
    return {
        init: c
    }
}(jQuery);
cm.select = function (d) {
    var b = {};
    var c = 0;
    var a = function (f) {
            var e = b[parseInt(d(this).attr("selectedIndex"))].func;
            if (e && typeof e == "function") {
                e()
            }
        };
    return {
        gen: function (g) {
            b = g.options;
            var f = g.onclick ? " onclick='" + g.onclick + "' " : "";
            var e = g.onchange ? " onchange='" + g.onchange + "' " : "";
            return "<select " + f + e + " class='select_widget_ " + (g["class"] || "") + "'>" + g.options.reduce(function (i, h) {
                return i + "<option " + f + " index_inc='" + (c++) + "'>" + h.text + "</option>"
            }, "") + "</select>"
        },
        bind: function () {}
    }
}(jQuery);
var cm = cm || {};
cm.ServerUpgraded = (function (c) {
    var a = false;
    var d = function (e) {
            var g = (new Date()).getTime(),
                f = false;
            e.preventDefault();
            e.stopImmediatePropagation();
            if (a) {
                if (g - a > 2000) {
                    f = true
                } else {
                    return
                }
            } else {
                a = g
            }
            kraken.network.login(function (h) {
                if (h && h.accessToken) {
                    if (h.accessToken) {
                        var j = document.location.hostname.split(".");
                        j.reverse();
                        var i = j[1] + "." + j[0];
                        FB.Cookie.setRaw("fbac_", h.accessToken, (new Date()).getTime() + h.expiresIn * 1000, i)
                    }
                } else {
                    kraken.log("Login failed!")
                }
                cm.LinkHelper.trackAndOpenLinkOnClick(e, "ServerUpgraded")
            });
            if (f) {
                cm.LinkHelper.trackAndOpenLinkOnClick(e, "ServerUpgraded_network_failed")
            }
        };
    var b = function (f) {
            var h = true,
                j = f.playerInfo;
            if (h) {
                var e = [g_js_strings.serverUpgraded.enhancedBullet1, g_js_strings.serverUpgraded.enhancedBullet2, g_js_strings.serverUpgraded.enhancedBullet3, g_js_strings.serverUpgraded.enhancedBullet4],
                    i = "",
                    g;
                c.each(e, function (l, k) {
                    i += '<li class="redShieldBullet">' + k + "</li>"
                });
                g = cm.Template.renderTemplate("NewGame", "playConfirmPanel", {
                    foundedKingdom: g_js_strings.serverUpgraded.youreSelectedEnchanced,
                    placedUnderProtection: g_js_strings.serverUpgraded.newEnhancedFeaturesAre,
                    playerHints: i,
                    callToAction: g_js_strings.serverUpgraded.goContinueToKabam,
                    actionButtons: '<a href="' + f.kcomLink + '" class="outbound_link gemButtonv2 blue" target="_top">Kabam.com</a>'
                });
                cm.NewGameView.openConfirm({
                    avatarId: (j.playerSex).toLowerCase() + j.avatarId,
                    playerName: j.displayName,
                    panelBody: g
                })
            }
            c(".outbound_link").click(d)
        };
    return {
        init: b
    }
})(jQuery);
var cm = cm || {};
cm.BaseItemService = function (c) {
    cm.CustomEventDispatcher.call(this);
    var b = this;
    var a;
    this.buyItem = function () {
        var g = a.getId();
        var f = Object.clone(g_ajaxparams);
        f.iid = g;
        f.original_quantity = seed.items["i" + g];
        var e = new cm.Profiler("ResponseTime", "buyItem.php");
        new Ajax.Request(g_ajaxpath + "ajax/buyItem.php" + g_ajaxsuffix, {
            method: "post",
            parameters: f,
            onSuccess: function (h) {
                e.stop();
                var i = new cm.ItemServiceEvent(cm.ItemServiceEvent.BUY_SUCCESS);
                i.setTarget(b);
                i.setResponse(h);
                b.dispatchCustomEvent(i)
            },
            onFailure: function () {
                e.stop();
                var h = new cm.ItemServiceEvent(cm.ItemServiceEvent.BUY_FAILED);
                b.DispatchCustomEvent(h)
            }
        })
    };
    var d = function () {
            if (c) {
                a = c
            }
        };
    d()
};
cm.OOP.inherits(cm.BaseItemService, cm.CustomEventDispatcher);
cm.CombatBoostItemService = function (a) {
    cm.BaseItemService.call(this, a);
    var c = this;
    var b;
    this.applyItem = function () {
        var e = Object.clone(g_ajaxparams);
        e.iid = b.getId();
        e.cid = currentcityid;
        new Ajax.Request(g_ajaxpath + "ajax/boostCombat.php" + g_ajaxsuffix, {
            method: "post",
            parameters: e,
            onSuccess: function (f) {
                var g = new cm.ItemServiceEvent(cm.ItemServiceEvent.APPLY_SUCCESS);
                g.setTarget(c);
                g.setResponse(f);
                c.dispatchCustomEvent(g)
            },
            onFailure: function () {
                var f = new cm.ItemServiceEvent(cm.ItemServiceEvent.APPLY_FAILED);
                c.DispatchCustomEvent(f)
            }
        })
    };
    var d = function () {
            b = a
        };
    d()
};
cm.OOP.inherits(cm.CombatBoostItemService, cm.BaseItemService);
cm.GemGiftingNotificationService = function () {
    cm.BaseItemService.call(this);
    var a = this;
    this.getNotifications = function () {
        var b = new cm.Profiler("ResponseTime", "getGifts.php");
        var c = Object.clone(g_ajaxparams);
        new Ajax.Request(g_ajaxpath + "ajax/getGifts.php", {
            method: "post",
            parameters: c,
            onSuccess: function (d) {
                b.stop();
                var e = new cm.ServiceEvent(cm.ServiceEvent.SUCCESS);
                e.setTarget(a);
                e.setResponse(d);
                a.dispatchCustomEvent(e)
            },
            onFailure: function () {
                b.stop();
                var d = new cm.ServiceEvent(cm.ServiceEvent.FAILED);
                a.DispatchCustomEvent(d)
            }
        })
    };
    this.acknowledgeRead = function (d) {
        var b = new cm.Profiler("ResponseTime", "ackGift.php");
        var c = Object.clone(g_ajaxparams);
        c.tvuid = tvuid;
        c.txnid = d.join(",");
        new Ajax.Request(g_ajaxpath + "ajax/ackGift.php", {
            method: "post",
            parameters: c,
            onSuccess: function (e) {
                b.stop();
                var f = new cm.ServiceEvent(cm.ServiceEvent.SUCCESS);
                f.setTarget(a);
                f.setResponse(e);
                a.dispatchCustomEvent(f)
            },
            onFailure: function () {
                b.stop();
                var e = new cm.ServiceEvent(cm.ServiceEvent.FAILED);
                a.DispatchCustomEvent(e)
            }
        })
    }
};
cm.OOP.inherits(cm.GemGiftingNotificationReadService, cm.BaseItemService);
cm.ItemServiceEvent = function (b) {
    cm.CustomEvent.call(this, b);
    var a;
    this.setResponse = function (c) {
        a = c
    };
    this.getResponse = function () {
        return a
    }
};
cm.OOP.inherits(cm.ItemServiceEvent, cm.CustomEvent);
cm.ItemServiceEvent.BUY_SUCCESS = "buySuccess";
cm.ItemServiceEvent.BUY_FAILED = "buyFailed";
cm.ItemServiceEvent.APPLY_SUCCESS = "applySuccess";
cm.ItemServiceEvent.APPLY_FAILED = "applyFailed";
cm.ServiceEvent = function (b) {
    cm.CustomEvent.call(this, b);
    var a;
    this.setResponse = function (c) {
        a = c
    };
    this.getResponse = function () {
        return a
    }
};
cm.OOP.inherits(cm.ItemServiceEvent, cm.CustomEvent);
cm.ServiceEvent.SUCCESS = "success";
cm.ServiceEvent.FAILED = "failed";
cm.PaymentXMLService = function (b) {
    var d = this;
    var e = b;
    var a = 0;
    var c = null;
    this.getResult = function () {
        return c
    };
    this.getVersion = function () {
        return e
    };
    this.hasExpired = function () {
        var f = !c || !c.ok;
        if (!f && e == 2) {
            f = (new Date()).getTime() > a
        }
        return f
    };
    this.makeRequest = function (i, h) {
        var k = Object.clone(g_ajaxparams);
        k.v = e;
        k.platform = seed.platform.type;
        for (var g in i) {
            var j = i[g];
            k[g] = j
        }
        if (cm.WorldSettings.hasSetting("protocol")) {
            k.protocol = cm.WorldSettings.getSetting("protocol")
        }
        var f = new cm.Profiler("ResponseTime", "paymentXml.php");
        new Ajax.Request(g_ajaxpath + "ajax/paymentXml.php", {
            method: "post",
            parameters: k,
            onSuccess: function (l) {
                f.stop();
                a = (new Date()).getTime() + 4 * 60 * 1000;
                c = l.responseText.evalJSON(true);
                if (h && h.onSuccess) {
                    h.onSuccess()
                }
            },
            onFailure: function () {
                f.stop();
                if (h && h.onFailure) {
                    h.onFailure()
                }
            }
        })
    }
};
cm = cm || {};
cm.ShopController = function ($) {
    var buy = function (itemId) {
            var item = ksoItems[itemId],
                gems = Number(seed.player.gems),
                isCourtItem;
            if (item.price > gems) {
                cm.ShopView.openGetMoreGemsModal()
            } else {
                var params = Object.clone(g_ajaxparams);
                params.iid = item.id;
                if (item.isOnSale) {
                    params.sale = 1
                }
                var profiler = new cm.Profiler("ResponseTime", "buyItem.php");
                new Ajax.Request(g_ajaxpath + "ajax/buyItem.php" + g_ajaxsuffix, {
                    method: "post",
                    parameters: params,
                    onSuccess: function (transport) {
                        var itemKey, maxOwnedAllowed, rslt = eval("(" + transport.responseText + ")");
                        if (rslt.ok) {
                            seed.player.gems = Number(seed.player.gems) - item.price;
                            itemKey = "i" + item.id;
                            var kso1 = seed.items[itemKey];
                            if (seed.items[itemKey]) {
                                seed.items[itemKey] = Number(seed.items[itemKey]) + 1
                            } else {
                                seed.items[itemKey] = 1
                            }
                            var kso2 = seed.items[itemKey];
                            item.add();
                            cm.ShopView.increaseInventoryHistoryByItemKey(itemKey);
                            $("#shopGemQuantity").text(seed.player.gems);
                            $("#kochead_gems").text(seed.player.gems);
                            var text = g_js_strings.modal_shop_buy.purchasealert.replace("%1$s", item.name);
                            $("#shopMessage").text(text);
                            $("#shopMessage").show();
                            $("#item" + item.id + "Count").text(item.count);
                            if (item.category == 6) {
                                cm.ShopView.removeItemFromShop(item.id)
                            }
                            do {
                                if (!rslt.data && !rslt.data.checkMaxOwnedAllowed) {
                                    break
                                }
                                maxOwnedAllowed = cm.ShopView.getMaxOwnedAllowedByItemKey(itemKey);
                                if (maxOwnedAllowed === null) {
                                    break
                                }
                                if (maxOwnedAllowed) {
                                    cm.ShopView.removeItemFromShop(item.id)
                                }
                            } while (false);
                            if ((item.id >= 1202 && item.id <= 1210) || (item.id >= 700 && item.id <= 900) || item.id == 10018) {
                                if ($(".item").length === 0) {
                                    cm.ShopView.goPrevPage()
                                } else {
                                    cm.ShopView.organizeItems()
                                }
                                if (item.id == 10018) {
                                    common_postToProfile("20", Object.clone(template_data_20), Object.clone(actionlink_data_20), continuation_20, new Array())
                                }
                            }
                            if (item.id == 2) {
                                if (seed.player.spentFiveGems && seed.player.spentFiveGems === 0) {
                                    seed.player.spentFiveGems = 1
                                }
                            }
                            cm.MixPanelTracker.track("store_purchase", {
                                item: itemlist["i" + itemId].name,
                                cost: itemcost,
                                usr_gen: seed.player.g,
                                usr_byr: seed.player.y,
                                usr_ttl: titlenames[seed.player.title],
                                distinct_id: tvuid
                            })
                        }
                    }
                })
            }
        };
    var easyBuy = function (itemId, callBack) {
            var item = ksoItems[itemId],
                gems = Number(seed.player.gems);
            if (item.price > gems) {
                cm.ShopView.openGetMoreGemsModal()
            } else {
                var params = Object.clone(g_ajaxparams);
                params.iid = item.id;
                if (item.isOnSale) {
                    params.sale = 1
                }
                new Ajax.Request(g_ajaxpath + "ajax/buyItem.php" + g_ajaxsuffix, {
                    method: "post",
                    parameters: params,
                    onSuccess: function (transport) {
                        var rslt = eval("(" + transport.responseText + ")");
                        if (rslt.ok) {
                            seed.player.gems = Number(seed.player.gems) - item.price;
                            $("#kochead_gems").text(seed.player.gems);
                            seed.items["i" + item.id] = Number(seed.items["i" + item.id]) + 1;
                            item.add();
                            cm.MixPanelTracker.track("store_purchase", {
                                item: itemlist["i" + itemId].name,
                                cost: item.price,
                                usr_gen: seed.player.g,
                                usr_byr: seed.player.y,
                                usr_ttl: titlenames[seed.player.title],
                                distinct_id: tvuid
                            });
                            callBack()
                        }
                    }
                })
            }
        };
    var init_ = function () {};
    init_();
    return {
        buy: buy,
        easyBuy: easyBuy
    }
}(jQuery);
cm = cm || {};
cm.ShopView = function ($) {
    var tab0 = [],
        tab1 = [],
        tab2 = [],
        tab3 = [],
        tab4 = [],
        tab5 = [],
        tab6 = [],
        currentTab, currentPage, itemsPerPage = 9,
        inventoryHistory_ = {},
        shopOrder, featuredInfo, featuredOrder, lastTimeChecked = 0,
        maxOwnedAllowed_ = null;
    var getMaxOwnedAllowedByItemKey_ = function (itemKey) {
            if (!maxOwnedAllowed_ || (undefined == maxOwnedAllowed_[itemKey])) {
                return null
            }
            return maxOwnedAllowed_[itemKey]
        };
    var increaseInventoryHistoryByItemKey_ = function (itemKey) {
            if (undefined == inventoryHistory_[itemKey]) {
                inventoryHistory_[itemKey] = 1
            } else {
                (inventoryHistory_[itemKey])++
            }
        };
    var openShop = function (currentTab) {
            currentTab = currentTab || 0;
            currentPage = 1;
            var title = g_js_strings.modaltitles.shop,
                bannerMessage, bannerHTML, className;
            if (cm.WorldSettings.hasKeyValuePair("MIGRATION1", "true")) {
                bannerMessage = g_js_strings.modal_shop_buy_banner.banner_exclusiveitemsonkabam;
                if (seed.platform.type == "facebook") {
                    bannerHTML = "<div class='msg'><a href='" + seed.platform.url + "' target='_top'>" + bannerMessage + "</a></div>"
                } else {
                    bannerHTML = "<div class='msg'>" + bannerMessage + "</div>"
                }
                className = "new"
            } else {
                bannerMessage = g_js_strings.modal_shop_buy_banner.banner_feycitycomingsoon;
                bannerHTML = "<div class='msg'>" + bannerMessage + "</div>";
                className = "old"
            }
            var template = cm.Template.renderTemplate("Shop", "openShop", {
                gemsString: g_js_strings.commonstr.gems,
                getmoregemsString: g_js_strings.modaltitles.getmoregems,
                getmoreitemsString: g_js_strings.commonstr.inventory,
                featuredString: g_js_strings.commonstr.featured,
                generalString: g_js_strings.commonstr.general,
                speedupString: g_js_strings.commonstr.speedup,
                combatString: g_js_strings.commonstr.combat,
                resourcesString: g_js_strings.commonstr.resources,
                chestString: g_js_strings.commonstr.chest,
                courtString: g_js_strings.commonstr.court,
                type: seed.platform.type,
                url: seed.platform.type == "facebook" ? seed.platform.url : "#",
                gemsAmount: seed.player.gems,
                bannerHTML: bannerHTML,
                className: className
            });
            Modal.showModal(740, 400, 10, 10, title, template);
            if ($("#shopModalContainer").length < 1) {
                return
            }
            var params = Object.clone(g_ajaxparams);
            new Ajax.Request(g_ajaxpath + "ajax/showShop.php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (transport) {
                    var rslt = eval("(" + transport.responseText + ")");
                    if (rslt.ok) {
                        shopOrder = rslt.data.shopOrder;
                        featuredOrder = rslt.data.featuredOrder;
                        featuredInfo = rslt.data.featureInfo;
                        inventoryHistory_ = {};
                        maxOwnedAllowed_ = rslt.data.maxOwnedAllowed;
                        $.each(rslt.data.inventoryHistory, function (key, item) {
                            inventoryHistory_[key] = item[0] + item[1]
                        });
                        lastTimeChecked = unixtime();
                        openTab(currentTab)
                    }
                }
            })
        };
    var organizeItems = function () {
            var item, resortedTab0 = [];
            tab0 = [];
            tab1 = [];
            tab2 = [];
            tab3 = [];
            tab4 = [];
            tab5 = [];
            tab6 = [];
            var featuredIndex, item, newEnd, saleStart, saleEnd, now = unixtime();
            $.each(shopOrder, function (key, item) {
                var itemKey, owned = 0;
                item = ksoItems[Number(item)];
                itemKey = "i" + item.id;
                if (item) {
                    if (undefined !== maxOwnedAllowed_[itemKey]) {
                        if (undefined !== inventoryHistory_[itemKey]) {
                            owned = inventoryHistory_[itemKey]
                        }
                        if (maxOwnedAllowed_[itemKey] <= owned) {
                            return
                        }
                    }
                    item.featuredInfo = featuredInfo[itemKey];
                    item.setFeatured();
                    if (item.isFeatured) {
                        newEnd = item.featuredInfo[0];
                        saleStart = item.featuredInfo[1];
                        saleEnd = item.featuredInfo[2];
                        if ((newEnd && newEnd > now) || (saleStart && saleStart < now && saleEnd > now)) {
                            featuredIndex = featuredOrder.indexOf(item.id);
                            tab0[featuredIndex] = item.id
                        }
                    }
                    switch (item.category) {
                    case 1:
                        tab1.push(item.id);
                        break;
                    case 2:
                        tab2.push(item.id);
                        break;
                    case 3:
                        tab3.push(item.id);
                        break;
                    case 4:
                        tab4.push(item.id);
                        break;
                    case 5:
                        tab5.push(item.id);
                        break;
                    case 6:
                        if (item.count === 0) {
                            tab6.push(item.id)
                        }
                        break;
                    default:
                        tab1.push(item.id);
                        break
                    }
                }
            });
            $.each(tab0, function (key, item) {
                if (item) {
                    resortedTab0.push(item)
                }
            });
            tab0 = resortedTab0;
            injectItems()
        };
    var openTab = function (tabIndex) {
            $("#shopTabs").find("a").attr("disabled", true);
            var link = $("#shopTabs").find("a")[tabIndex];
            $(link).attr("onClick", "");
            $("#shopNextPageButton").attr("disabled", true);
            $("#shopNextPageButton").attr("onClick", "");
            $("#shopPrevPageButton").attr("disabled", true);
            $("#shopPrevPageButton").attr("onClick", "");
            currentPage = 1;
            $("div#shopMessage").hide();
            $("li#shopTab" + currentTab).removeClass("selected");
            currentTab = Number(tabIndex);
            $("li#shopTab" + currentTab).addClass("selected");
            organizeItems()
        };
    var injectItems = function () {
            var currentItems, sliceStart, sliceEnd;
            switch (currentTab) {
            case 0:
                currentItems = tab0;
                break;
            case 1:
                currentItems = tab1;
                break;
            case 2:
                currentItems = tab2;
                break;
            case 3:
                currentItems = tab3;
                break;
            case 4:
                currentItems = tab4;
                break;
            case 5:
                currentItems = tab5;
                break;
            case 6:
                currentItems = tab6;
                break;
            default:
                currentItems = tab1;
                break
            }
            if (currentPage < 0) {
                currentPage = 1
            }
            controlPaginationButtons(currentItems.length);
            controlPaginationList(currentItems.length);
            sliceStart = (currentPage - 1) * itemsPerPage;
            sliceEnd = currentPage * itemsPerPage;
            currentItems = currentItems.slice(sliceStart, sliceEnd);
            $("#shopItemsContainerList").empty();
            var costContent, item, className, templateId, templateArray = [],
                imageSource;
            $.each(currentItems, function (key, item) {
                item = ksoItems[item];
                costContent = [];
                if (item.isOnSale) {
                    costContent.push("<span class='salePrice'>");
                    costContent.push(item.price);
                    costContent.push("</span>");
                    costContent.push("<span class='defaultPrice'>");
                    costContent.push(item.defaultPrice);
                    costContent.push("</span>")
                } else {
                    costContent.push("<span class='price'>");
                    costContent.push(item.price);
                    costContent.push("</span>")
                }
                if (item.isOnSale) {
                    className = "sale"
                } else {
                    if (item.isFeatured) {
                        className = "featured"
                    } else {
                        className = "normal"
                    }
                }
                imageSource = stimgUrl + "img/items/70/" + item.id + ".jpg";
                var template = cm.Template.renderTemplate("Shop", "shopItem", {
                    id: item.id,
                    img: imageSource,
                    description: item.description,
                    name: item.name,
                    className: className,
                    costContent: costContent.join(""),
                    count: item.count,
                    ownedString: g_js_strings.commonstr.owned,
                    buyString: g_js_strings.commonstr.buy
                });
                templateArray.push(template)
            });
            $("#shopItemsContainerList").append(templateArray.join(""))
        };
    var controlPaginationList = function (totalItems) {
            var totalPages = Math.ceil(totalItems / itemsPerPage),
                html = [],
                liHtml = [];
            if (totalPages != 1) {
                for (var i = 1; i <= totalPages; ++i) {
                    liHtml.push("<li class='page'>");
                    if (i == currentPage) {
                        liHtml.push("<span class='current'>" + i + "</span>")
                    } else {
                        liHtml.push("<span onclick='cm.ShopView.goToPage(" + i + ");'>" + i + "</span>")
                    }
                    liHtml.push("</li>")
                }
                if ($("#shopPaginationList").length != 0) {
                    $("#shopPaginationList").empty();
                    $("#shopPaginationList").append(liHtml.join(""))
                } else {
                    html.push("<ul id='shopPaginationList'>");
                    html.push(liHtml.join(""));
                    html.push("</ul>");
                    $("#shopBanner").append(html.join(""))
                }
            } else {
                $("#shopPaginationList").remove()
            }
        };
    var controlPaginationButtons = function (totalItems) {
            var totalPages = Math.ceil(totalItems / itemsPerPage),
                prevButton = $("a#shopPrevPageButton"),
                nextButton = $("a#shopNextPageButton").hide();
            if (totalPages > 1) {
                if (currentPage > 1) {
                    if ((currentPage < totalPages) && (currentPage > 1)) {
                        prevButton.show();
                        nextButton.show()
                    } else {
                        if (currentPage == totalPages) {
                            prevButton.show();
                            nextButton.hide()
                        } else {
                            prevButton.hide();
                            nextButton.show()
                        }
                    }
                } else {
                    prevButton.hide();
                    nextButton.show()
                }
            } else {
                prevButton.hide();
                nextButton.hide()
            }
            $("#shopNextPageButton").attr("disabled", false);
            $("#shopNextPageButton").attr("onClick", "cm.ShopView.goNextPage();");
            $("#shopPrevPageButton").attr("disabled", false);
            $("#shopPrevPageButton").attr("onClick", "cm.ShopView.goPrevPage();");
            var links = $("#shopTabs").find("a");
            $.each(links, function (index, link) {
                if (currentTab == index) {
                    $(link).attr("disabled", true);
                    $(link).attr("onClick", "")
                } else {
                    $(link).attr("disabled", false);
                    $(link).attr("onClick", "cm.ShopView.openTab(" + index + ");")
                }
            })
        };
    var goNextPage = function () {
            $("#shopNextPageButton").attr("disabled", true);
            $("#shopNextPageButton").attr("onClick", "");
            $("#shopPrevPageButton").attr("disabled", true);
            $("#shopPrevPageButton").attr("onClick", "");
            ++currentPage;
            organizeItems()
        };
    var goPrevPage = function () {
            $("#shopNextPageButton").attr("disabled", true);
            $("#shopNextPageButton").attr("onClick", "");
            $("#shopPrevPageButton").attr("disabled", true);
            $("#shopPrevPageButton").attr("onClick", "");
            --currentPage;
            organizeItems()
        };
    var goToPage = function (pageNumber) {
            currentPage = pageNumber;
            organizeItems()
        };
    var showItemTooltip = function (tgt, evt) {
            showTooltip(tgt.getAttribute("name"), tgt, evt, "shopItemsContainer")
        };
    var removeItemFromShop = function (itemId) {
            var seedCount = seed.items["i" + itemId],
                ksoItemsCount = ksoItems[itemId].count;
            if (seedCount >= 1 && ksoItemsCount >= 1) {
                $("#item" + itemId).remove()
            } else {
                $("#item" + itemId + "Count").text(seed.items["i" + itemId].toString());
                $("#item" + itemId + "Count").text(ksoItems[itemId].count.toString())
            }
            if ($(".item").length === 0) {
                goPrevPage()
            } else {
                organizeItems()
            }
        };
    var openGetMoreGemsModal = function () {
            var title = g_js_strings.modaltitles.getmoregems;
            var template = cm.Template.renderTemplate("Shop", "getMoreGems", {
                content1: g_js_strings.modal_shop_buy_notenough.notenoughgems,
                content2: g_js_strings.modal_shop_buy_notenough.thatsokay,
                getMoreGemsString: g_js_strings.modal_shop_buy_notenough.getmoregems
            });
            Modal.showModal(500, 400, 130, 10, title, template)
        };
    var init_ = function () {};
    init_();
    return {
        getMaxOwnedAllowedByItemKey: getMaxOwnedAllowedByItemKey_,
        increaseInventoryHistoryByItemKey: increaseInventoryHistoryByItemKey_,
        showItemTooltip: showItemTooltip,
        openShop: openShop,
        openTab: openTab,
        goNextPage: goNextPage,
        goPrevPage: goPrevPage,
        goToPage: goToPage,
        openGetMoreGemsModal: openGetMoreGemsModal,
        removeItemFromShop: removeItemFromShop
    }
}(jQuery);
cm.sounds = function (g) {
    var k = {},
        e = false;
    _effects = true;
    _currentMusic = "field";
    var a = {
        modal_build0: "open_castle",
        modal_build5: "open_cottage",
        modal_build6: "open_tavern",
        modal_build7: "open_knightshall",
        modal_build12: "open_rally_point",
        modal_build8: "open_embassy",
        open_guardian: "open_guardian",
        modal_build9: "open_storehouse",
        modal_build10: "open_market",
        modal_build13: "open_barracks",
        modal_build14: "open_watchtower",
        modal_build15: "open_blacksmith",
        modal_build16: "open_workshop",
        modal_build17: "open_stable",
        modal_build18: "open_relief_station",
        modal_build19: "open_wall",
        modal_build11: "open_alchemy_lab",
        modal_build20: "open_fey_spire",
        modal_build3: "open_quarry",
        modal_build2: "open_sawmill",
        modal_build4: "open_mine",
        modal_build1: "open_farm",
        modal_barracks_train_1: "select_supplytroop1",
        modal_barracks_train_2: "select_militiaman1",
        modal_barracks_train_3: "select_scout1",
        modal_barracks_train_4: "select_pikeman1",
        modal_barracks_train_5: "select_swordsman",
        modal_barracks_train_6: "select_archer1",
        modal_barracks_train_7: "select_cavalry1",
        modal_barracks_train_8: "select_heavy_calvary1",
        modal_barracks_train_9: "select_supplywagon",
        modal_barracks_train_10: "select_ballista",
        modal_barracks_train_11: "select_batteringram1",
        modal_barracks_train_12: "select_catapult1",
        modal_barracks_train_action: "training_start",
        demolish_building: "deconstruct_building",
        destroy_building: "destroy_building",
        modal_quest_getaward: "claim_reward",
        player_initiates_march: "march_start",
        modal_build_speedup_apply: "use_speedup",
        finished_training: "training_complete",
        player_recieves_new_message_inbox: "message_received",
        finished_building: "build_complete",
        finished_research: "research_complete",
        started_research: "research_start",
        build_start: "build_start",
        player_completes_a_craft: "craft_complete",
        player_starts_a_craft: "craft_complete",
        player_views_battle_report_and_won: "battle_won1",
        player_views_battle_report_and_lost: "battle_lost",
        player_recieves_rare_drop_after_combat: "rare_drop",
        chat_received: "chat_received",
        tr_build: "tr_build",
        tr_success_build: "tr_success_build",
        tr_fail_build: "tr_fail_build"
    };
    var i = function () {
            localStorage.setItem("effects", _effects);
            localStorage.setItem("music", e)
        };
    var b = function () {
            e = true;
            cm.sounds.music_play(_currentMusic);
            i()
        };
    var d = function () {
            e = false;
            AM_stopMusic();
            i()
        };
    var m = function () {
            _effects = true;
            i()
        };
    var j = function () {
            _effects = false;
            i()
        };
    var f = function () {
            if (e) {
                cm.sounds.music_play("field")
            } else {}
        };
    var c = function () {
            AM_initAudioManager({
                sound: {
                    cacheSize: 10,
                    cached: ["open_barracks", "open_embassy"],
                    regular: ["open_barracks", "open_embassy"]
                },
                music: {
                    cacheSize: 2,
                    regular: ["map", "field"]
                }
            })
        };
    g(document).ready(function l() {
        if (cm.WorldSettings.isOn("SOUND_EFFECTS")) {
            _effects = localStorage.getItem("effects") == "true";
            e = localStorage.getItem("music") == "true";
            if (localStorage.getItem("effects") != "true" && localStorage.getItem("effects") != "false") {
                cm.log.l("setting default sound to On");
                m();
                b()
            }
            g(".kocmain").append("<div class='sfx_main_view'></div>");
            g(".sfx_main_view").soundView({
                effects: _effects,
                effects_click_on: m,
                effects_click_off: j,
                music: e,
                music_click_on: b,
                music_click_off: d
            });
            c();
            f();
            setTimeout(function () {}, 4000)
        }
    });
    var h = {
        field: "field",
        map: "map"
    };
    return {
        music_play: function (o) {
            var n = h[o];
            if (!n) {
                cm.log.l("invalid music type");
                return false
            } else {
                _currentMusic = n;
                if (e) {
                    var q = AM_changeMusic(n);
                    if (!q) {
                        var p = AM_playMusic();
                        if (!p) {
                            AM_changeMusic("field");
                            AM_changeMusic(n)
                        }
                    }
                }
            }
        },
        get: function (n) {
            k[n] = k[n] ? k[n] + 1 : 1;
            cm.log.l("play: " + n);
            cm.log.dir(k);
            return a[n] || "end"
        },
        play: function (o) {
            if (_effects && cm.WorldSettings.isOn("SOUND_EFFECTS")) {
                var n = cm.sounds.get(o);
                AM_playSound(n)
            }
        }
    }
}(jQuery);

function modal_speedup(type, typeid, slotid, subjectCurrentlyBuilding) {
    var params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/showShop.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                do_modal_speedup(type, typeid, slotid, subjectCurrentlyBuilding, rslt.data.featureInfo)
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function do_modal_speedup(d, a, b, c, s) {
    cm.speedUpModalTimer.saveLastSpeedUpModal({
        type: d,
        typeid: a,
        slotid: b,
        subjectCurrentlyBuilding: c
    });
    var m = new Array();
    update_queue();
    var p = cm.speedUpModalTimer.getTimeLeft(d);
    var q = cm.intelligentOrdering.get(seed.items, p);
    var h = false;
    cm.speedUpModalTimer.open(d);
    if (d == "bdg") {
        h = getBuildHelpEligible(a, currentcityid)
    } else {
        if (d == "tch") {
            h = getTechHelpEligible(a, currentcityid)
        } else {
            if (("frt" == d) || d.match(/^m\d+,\d+$/)) {
                h = true
            } else {
                if ("craft" == d || "throne" == d) {
                    h = false
                }
            }
        }
    }
    m.push("<div id='modal_speedup'>");
    m.push("<div class='itemlist'><div class='speedUpModalTimeLeft'></div>");
    var n = 0;
    for (n = 0; n < q.length; n++) {
        q[n] = q[n].substr(1);
        if (n == 1 && d != "craft" && d != "throne") {
            addHelp(n, h, m, d, a);
            if (d == "trn" && cm.WorldSettings.hasKeyValuePair("TROOP_GAMBLE", "ON")) {
                addTutelage(n, h, m, d, a, s)
            }
        }
        var o = (parseInt(seed.items["i" + q[n]]) > 0) ? parseInt(seed.items["i" + q[n]]) : 0;
        m.push("<div class='item " + (n == 0 ? "instantFinish" : "") + " clearfix'>");
        m.push("<img class='itemIcon' src='");
        m.push(stimgUrl);
        m.push("img/items/70/");
        m.push(q[n]);
        m.push(".jpg'/>");
        m.push("<div class='iteminfo'>");
        m.push("<div class='itemhd'>");
        m.push(itemlist["i" + q[n]].name);
        var k = 'modal_speedup_apply("' + d + '","' + q[n] + '", ' + a + ");return false;";
        var t = o == 0 ? "return false;" : k;
        var g = o == 0 ? "greyedout" : "";
        if (n == 0 && p < (4 * 24 * 3600)) {
            m.push("<a  class='button20 " + g + "' onclick='" + t + "'><span>" + (n == 0 ? g_js_strings.commonstr.instantfinish : g_js_strings.commonstr.apply) + "</span></a></div>")
        } else {
            m.push("<a  class='button20 " + g + "' onclick='" + t + "'><span>" + g_js_strings.commonstr.apply + "</span></a></div>")
        }
        m.push("<div class='itemdesc'>");
        m.push(itemlist["i" + q[n]].description);
        m.push("</div>");
        m.push("<div class='itemown'>" + g_js_strings.commonstr.youown + ": ");
        m.push(o);
        m.push("</div>");
        m.push("</div>" + price("i" + q[n], s));
        m.push("</div>")
    }
    if (q.length == 0 || q.length == 1) {
        n = 1;
        if (d != "craft" && d != "throne") {
            addHelp(n, h, m, d, a)
        }
        if (d == "trn" && cm.WorldSettings.hasKeyValuePair("TROOP_GAMBLE", "ON")) {
            addTutelage(n, h, m, d, a, s)
        }
    }
    m.push("</div><a class='buyMoreSpeedUps' onclick='cm.speedUpModalTimer.goToSpeedups();'>Buy More Speed Ups</a>");
    m.push("</div>");
    var j = "";
    if (c) {
        j = c
    } else {
        if (b) {
            var f = getMsg(b);
            j = f.substr(f.indexOf(">") + 1);
            j = j.substr(0, j.indexOf(")") + 1)
        }
    }
    var l = jQuery("#modal_speedup");
    if (l.length) {
        try {
            l.parents(".modalInner").find(".modalTitle").html(j + " " + g_js_strings.modaltitles.speedup);
            l.replaceWith(m.join(""));
            return
        } catch (r) {}
        Modal.hideModalAll()
    }
    Modal.show({
        winWidth: 400,
        winHeight: 400,
        winLeft: 180,
        winTop: 10,
        winTitle: j + " " + g_js_strings.modaltitles.speedup,
        winContent: m.join("")
    })
}

function addHelp(c, e, a, d, b) {
    if (c == 1 && e == false && d != "trn" && d != "craft") {
        a.push("<div class='item askForHelp clearfix'>");
        a.push("<img class='itemIcon' src='");
        a.push(stimgUrl);
        a.push("img/war_horn.png'/>");
        a.push("<div class='iteminfo'>");
        a.push("<div class='itemhd'>" + g_js_strings.modal_speedup.askhelp + "<a  class='button20' onclick='");
        if (d == "bdg") {
            a.push("build_gethelp(");
            a.push(b);
            a.push(");Modal.hideModalAll();")
        } else {
            if (d == "tch") {
                a.push("tch_gethelp(");
                a.push(b);
                a.push(");")
            }
        }
        a.push("return false;'><span>" + g_js_strings.commonstr.sharetowall + "</span></a></div>");
        a.push("<div class='itemdesc'>" + g_js_strings.modal_speedup.buildresearchaskhelpdesc + "</div>");
        a.push("</div>");
        a.push("</div><div style='height: 77px;'></div>")
    }
}

function addTutelage(n, f, m, c, a, r) {
    if (n == 1) {
        var b = [36, 37, 38],
            s, g, h, d, q, p;
        for (var n = 0, o = b.length; n < o; ++n) {
            s = b[n];
            var e = ksoItems[s].count;
            var l = (s == 36);
            var k = (s == 37 && ksoItems[s].count > 0);
            var j = (s == 38 && ksoItems[s].count > 0);
            if (l || k || j) {
                g = ksoItems[s].count;
                h = stimgUrl + "img/items/70/" + s + ".jpg";
                d = 'modal_speedup_apply("' + c + '","' + s + '", ' + a + ");";
                q = g == 0 ? "return false;" : d;
                p = g == 0 ? "greyedout" : "";
                m.push(" <div class='item clearfix'> ");
                m.push(" <img class='itemIcon' src='" + h + "' /> ");
                m.push(" <div class='iteminfo'> ");
                m.push(" <div class='itemhd'> ");
                m.push(ksoItems[s].name);
                m.push("<a  class='button20 " + p + "' onclick='" + q + "'><span>" + g_js_strings.commonstr.apply + "</span></a>");
                m.push(" </div> ");
                m.push("<div class='itemdesc'>");
                m.push(ksoItems[s].description);
                m.push("</div>");
                m.push("<div class='itemown'>" + g_js_strings.commonstr.youown + ": ");
                m.push(g);
                m.push("</div>");
                m.push(" </div> " + price("i" + b[n], r));
                m.push(" </div> ")
            }
        }
    }
}

function price(g, c) {
    var h = itemlist[g].price;
    var e = h;
    var a = false;
    if (c[g]) {
        var d = c[g];
        var f = unixtime();
        var j = parseInt(d[1]);
        var i = parseInt(d[2]);
        var b = parseInt(d[3]);
        if (j > 0 && j < f && i > 0 && i > f) {
            a = true;
            e = b
        }
    }
    return "<div class='buyitem'><a onclick='modal_shop_buy(\"" + g.substr(1) + '",' + e + ", \"redisplaySpeedUpModal\", event);return false;' class='buttonGreen20'><span>" + g_js_strings.commonstr.buyitem + "</span></a><div class='gemprice" + (a ? " onsale" : "") + "'>" + (a ? ("<span class='saleprice'>" + b + "</span>") : "") + "<span class='oldprice' id='modal_itemprice_" + g + "'>" + h + "</span><img  class='smallGreenGem' src='" + stimgUrl + "img/gem.png'/></div></div>"
}

function modal_speedup_getmore() {
    Modal.hideModalAll();
    modal_shop(3)
}

function modal_speedup_market(d, a, c) {
    var b = new Array();
    b.push("<div id='modal_speedup_market'>");
    b.push("<div class='itemlist'>");
    var e = (parseInt(seed.items["i" + 49]) > 0) ? parseInt(seed.items["i" + 49]) : 0;
    b.push("<div class='item clearfix'>");
    b.push("<img src='");
    b.push(stimgUrl);
    b.push("img/items/70/");
    b.push("49");
    b.push(".jpg'/>");
    b.push("<div class='iteminfo'>");
    b.push("<div class='itemhd'>");
    b.push(itemlist["i" + 49].name);
    if (e > 0) {
        b.push("<a  class='button20' onclick='modal_speedup_market_apply(");
        b.push(d + "," + a + "," + c);
        b.push(");return false;'><span>" + g_js_strings.commonstr.apply + "</span></a></div>")
    } else {
        b.push("<a  class='button20' onclick='Modal.hideModalAll();modal_shop(3);return false;'><span>" + g_js_strings.commonstr.getmore + "</span></a></div>")
    }
    b.push("<div class='itemdesc'>");
    b.push(itemlist["i" + 49].description);
    b.push("</div>");
    b.push("<div class='itemown'>" + g_js_strings.commonstr.youown + ": ");
    b.push(e);
    b.push(". <a  onclick='Modal.hideModalAll();modal_shop(3);return false;'>" + g_js_strings.commonstr.getmore + "</a></div>");
    b.push("</div>");
    b.push("</div>");
    b.push("</div>");
    b.push("</div>");
    Modal.showModal(400, 400, 180, 150, g_js_strings.modaltitles.speedup, b.join(""))
}

function modal_speedup_market_apply(tkey, ind, mktid) {
    var params = Object.clone(g_ajaxparams);
    params.mid = mktid;
    params.cid = currentcityid;
    params.iid = 49;
    new Ajax.Request(g_ajaxpath + "ajax/speedupTrade.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                seed.items.i49 = parseInt(seed.items.i49) - 1;
                ksoItems[49].subtract();
                Modal.hideModal();
                if (seed.queue_mkt["city" + currentcityid][tkey][ind]) {
                    seed.queue_mkt["city" + currentcityid][tkey][ind].eventUnixTime = "1"
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function modal_speedup_apply(type, itemid, typeid) {
    cm.sounds.play("modal_build_speedup_apply");
    if (type == "throne") {
        AjaxCall.gPostRequest("ajax/_dispatch53.php", {
            ctrl: "throneRoom\\ThroneRoomServiceAjax",
            action: "speedupRepair",
            throneItemId: typeid,
            speedupItemId: itemid
        }, function (rslt) {
            if (rslt.ok === true) {
                var reduced = cm.intelligentOrdering.getReduceTime(itemid),
                    timeDifference = 0,
                    hourGlassArray = [60, 900, 3600, 9000, 28800, 54000, 86400, 216000, 0, 345600],
                    startTime, endTime, hourGlassId = Number(itemid - 1);
                seed.items["i" + itemid] = parseInt(seed.items["i" + itemid]) - 1;
                ksoItems[itemid].subtract();
                timeDifference = hourGlassArray[hourGlassId];
                startTime = seed.queue_throne.start;
                endTime = seed.queue_throne.end;
                seed.queue_throne.start = startTime - reduced;
                seed.queue_throne.end = endTime - reduced;
                cm.ThronePanelView.appliedSpeedUp();
                cm.log.l("hide speedup modal 1");
                if (seed.queue_throne.end < unixtime()) {
                    Modal.hideModalAll();
                    cm.ModalManager.close();
                    cm.log.l("hide speedup modal 2")
                }
            } else {
                cm.ModalManager.alert({
                    button_text: g_js_strings.commonstr.ok,
                    text: rslt.msg,
                    "class": "craftFailure",
                    exe: function () {
                        Modal.hideModalAll();
                        cm.ModalManager.close()
                    }
                })
            }
        })
    } else {
        if (type == "craft") {
            AjaxCall.gPostRequest("ajax/_dispatch.php", {
                ctrl: "Crafting",
                action: "speedup",
                cityId: currentcityid,
                itemId: itemid,
                craftingId: typeid
            }, function (rslt) {
                var reduced = cm.intelligentOrdering.getReduceTime(itemid),
                    timeDifference = 0,
                    hourGlassArray = [60, 900, 3600, 9000, 28800, 54000, 86400, 216000, 0, 345600],
                    startTime, endTime, hourGlassId = Number(itemid - 1);
                seed.items["i" + itemid] = parseInt(seed.items["i" + itemid]) - 1;
                ksoItems[itemid].subtract();
                timeDifference = hourGlassArray[hourGlassId];
                startTime = seed.queue_craft["city" + currentcityid][0].craftingUnixTime;
                endTime = seed.queue_craft["city" + currentcityid][0].craftingEtaUnixTime;
                seed.queue_craft["city" + currentcityid][0].craftingUnixTime = startTime - timeDifference;
                seed.queue_craft["city" + currentcityid][0].craftingEtaUnixTime = endTime - timeDifference;
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                if (seed.player.usedSpeedup && seed.player.usedSpeedup == 0) {
                    seed.player.usedSpeedup = 1
                }
                var lastHourGlassFinished = reduced > cm.speedUpModalTimer.getCurrentModalTimeLeft();
                if (lastHourGlassFinished) {
                    Modal.hideModalAll()
                } else {
                    cm.speedUpModalTimer.redisplayModal()
                }
                update_queue()
            })
        } else {
            var params = Object.clone(g_ajaxparams);
            params.cid = currentcityid;
            params.iid = itemid;
            var phppg = "";
            if (type == "bdg") {
                params.bid = typeid;
                phppg = "speedupConstruction"
            } else {
                if (type == "tch") {
                    params.tid = typeid;
                    phppg = "speedupResearch"
                } else {
                    if (type == "trn") {
                        params.uid = typeid;
                        phppg = "speedupTraining"
                    } else {
                        if (type == "frt") {
                            params.fid = typeid;
                            phppg = "speedupFortify"
                        } else {
                            if (type == "mkt") {
                                params.mid = typeid;
                                phppg = "speedupTrade"
                            } else {
                                if (type.match(/^m\d+,\d+$/)) {
                                    var march_info = type.split(",");
                                    params.mid = type.split(",")[0].split("m")[1];
                                    phppg = "speedupMarch"
                                } else {
                                    return
                                }
                            }
                        }
                    }
                }
            }
            new Ajax.Request(g_ajaxpath + "ajax/" + phppg + ".php" + g_ajaxsuffix, {
                method: "post",
                parameters: params,
                onSuccess: function (message) {
                    var rslt = eval("(" + message.responseText + ")");
                    if (rslt.ok) {
                        var reduced = cm.intelligentOrdering.getReduceTime(itemid);
                        seed.items["i" + itemid] = parseInt(seed.items["i" + itemid]) - 1;
                        ksoItems[itemid].subtract();
                        var qloc = 0;
                        var timered = 0;
                        var timeredarr = [60, 900, 3600, 9000, 28800, 54000, 86400, 216000, 0, 345600];
                        if (type == "bdg") {
                            for (var i = 0; i < seed.queue_con["city" + currentcityid].length; i++) {
                                if (parseInt(seed.queue_con["city" + currentcityid][i][0]) == parseInt(typeid)) {
                                    qloc = i;
                                    break
                                }
                            }
                            var utstart = parseInt(seed.queue_con["city" + currentcityid][qloc][3]);
                            var uteta = parseInt(seed.queue_con["city" + currentcityid][qloc][4])
                        } else {
                            if (type == "tch") {
                                var utstart = parseInt(seed.queue_tch["city" + currentcityid][0][2]);
                                var uteta = parseInt(seed.queue_tch["city" + currentcityid][0][3])
                            } else {
                                if (type == "trn") {
                                    seed.queue_unt["city" + currentcityid][0][3] = rslt.dateTraining;
                                    if ($("intraining_estimatedtimeremain")) {
                                        var q = seed.queue_unt["city" + currentcityid],
                                            that = this;
                                        var kso = $("#button_training_cancel");
                                        var ksoo = $("button_training_cancel");
                                        ksoo.setAttribute("onclick", "");
                                        ksoo.onclick = function () {
                                            cancelTraining(0, currentcityid, q[0][0], q[0][1], q[0][3], q[0][2], q[0][5], true)
                                        };
                                        if (q[0][3]) {
                                            CountDown.stopCountDown("intraining_estimatedtimeremain");
                                            CountDown.addCountDown("intraining_estimatedtimeremain", (q[0][3] - unixtime()), function () {
                                                update_seed_ajax(true, function () {
                                                    $("intraining_estimatedtimeremain").update(g_js_strings.modal_barracks_trainingtab.completetxt);
                                                    $("button_training_cancel").hide();
                                                    modal_barracks_trainingtab()
                                                })
                                            })
                                        }
                                    }
                                    if (rslt.updateCityUnits) {
                                        update_cityUnits(rslt.updateCityUnits)
                                    }
                                } else {
                                    if ("frt" == type) {
                                        seed.queue_fort["city" + currentcityid][0][2] -= reduced;
                                        seed.queue_fort["city" + currentcityid][0][3] -= reduced
                                    }
                                }
                            }
                        }
                        timered = timeredarr[parseInt(itemid) - 1];
                        if (type == "bdg") {
                            seed.queue_con["city" + currentcityid][qloc][3] = utstart - timered;
                            seed.queue_con["city" + currentcityid][qloc][4] = uteta - timered
                        } else {
                            if (type == "tch") {
                                seed.queue_tch["city" + currentcityid][0][2] = utstart - timered;
                                seed.queue_tch["city" + currentcityid][0][3] = uteta - timered
                            } else {
                                if (type == "") {} else {
                                    if (type.match(/^m\d+,\d+$/)) {
                                        var march = seed.queue_atkp["city" + currentcityid]["m" + params.mid];
                                        march.destinationUnixTime = rslt.destinationUnixTime;
                                        march.marchUnixTime = rslt.marchUnixTime;
                                        march.returnUnixTime = rslt.returnUnixTime
                                    }
                                }
                            }
                        }
                        if (rslt.updateSeed) {
                            update_seed(rslt.updateSeed)
                        }
                        if (seed.player.usedSpeedup && seed.player.usedSpeedup == 0) {
                            seed.player.usedSpeedup = 1
                        }
                        var lastHourGlassFinished = reduced > cm.speedUpModalTimer.getCurrentModalTimeLeft();
                        if (lastHourGlassFinished) {
                            Modal.hideModalAll()
                        } else {
                            cm.speedUpModalTimer.redisplayModal()
                        }
                        update_queue()
                    } else {
                        Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                    }
                },
                onFailure: function () {}
            })
        }
    }
};
var swfobject = function () {
        var aq = "undefined",
            aD = "object",
            ab = "Shockwave Flash",
            X = "ShockwaveFlash.ShockwaveFlash",
            aE = "application/x-shockwave-flash",
            ac = "SWFObjectExprInst",
            ax = "onreadystatechange",
            af = window,
            aL = document,
            aB = navigator,
            aa = false,
            Z = [aN],
            aG = [],
            ag = [],
            al = [],
            aJ, ad, ap, at, ak = false,
            aU = false,
            aH, an, aI = true,
            ah = function () {
                var a = typeof aL.getElementById != aq && typeof aL.getElementsByTagName != aq && typeof aL.createElement != aq,
                    e = aB.userAgent.toLowerCase(),
                    c = aB.platform.toLowerCase(),
                    h = c ? /win/.test(c) : /win/.test(e),
                    j = c ? /mac/.test(c) : /mac/.test(e),
                    g = /webkit/.test(e) ? parseFloat(e.replace(/^.*webkit\/(\d+(\.\d+)?).*$/, "$1")) : false,
                    d = !+"\v1",
                    f = [0, 0, 0],
                    k = null;
                if (typeof aB.plugins != aq && typeof aB.plugins[ab] == aD) {
                    k = aB.plugins[ab].description;
                    if (k && !(typeof aB.mimeTypes != aq && aB.mimeTypes[aE] && !aB.mimeTypes[aE].enabledPlugin)) {
                        aa = true;
                        d = false;
                        k = k.replace(/^.*\s+(\S+\s+\S+$)/, "$1");
                        f[0] = parseInt(k.replace(/^(.*)\..*$/, "$1"), 10);
                        f[1] = parseInt(k.replace(/^.*\.(.*)\s.*$/, "$1"), 10);
                        f[2] = /[a-zA-Z]/.test(k) ? parseInt(k.replace(/^.*[a-zA-Z]+(.*)$/, "$1"), 10) : 0
                    }
                } else {
                    if (typeof af.ActiveXObject != aq) {
                        try {
                            var i = new ActiveXObject(X);
                            if (i) {
                                k = i.GetVariable("$version");
                                if (k) {
                                    d = true;
                                    k = k.split(" ")[1].split(",");
                                    f = [parseInt(k[0], 10), parseInt(k[1], 10), parseInt(k[2], 10)]
                                }
                            }
                        } catch (b) {}
                    }
                }
                return {
                    w3: a,
                    pv: f,
                    wk: g,
                    ie: d,
                    win: h,
                    mac: j
                }
            }(),
            aK = function () {
                if (!ah.w3) {
                    return
                }
                if ((typeof aL.readyState != aq && aL.readyState == "complete") || (typeof aL.readyState == aq && (aL.getElementsByTagName("body")[0] || aL.body))) {
                    aP()
                }
                if (!ak) {
                    if (typeof aL.addEventListener != aq) {
                        aL.addEventListener("DOMContentLoaded", aP, false)
                    }
                    if (ah.ie && ah.win) {
                        aL.attachEvent(ax, function () {
                            if (aL.readyState == "complete") {
                                aL.detachEvent(ax, arguments.callee);
                                aP()
                            }
                        });
                        if (af == top) {
                            (function () {
                                if (ak) {
                                    return
                                }
                                try {
                                    aL.documentElement.doScroll("left")
                                } catch (a) {
                                    setTimeout(arguments.callee, 0);
                                    return
                                }
                                aP()
                            })()
                        }
                    }
                    if (ah.wk) {
                        (function () {
                            if (ak) {
                                return
                            }
                            if (!/loaded|complete/.test(aL.readyState)) {
                                setTimeout(arguments.callee, 0);
                                return
                            }
                            aP()
                        })()
                    }
                    aC(aP)
                }
            }();

        function aP() {
            if (ak) {
                return
            }
            try {
                var b = aL.getElementsByTagName("body")[0].appendChild(ar("span"));
                b.parentNode.removeChild(b)
            } catch (a) {
                return
            }
            ak = true;
            var d = Z.length;
            for (var c = 0; c < d; c++) {
                Z[c]()
            }
        }

        function aj(a) {
            if (ak) {
                a()
            } else {
                Z[Z.length] = a
            }
        }

        function aC(a) {
            if (typeof af.addEventListener != aq) {
                af.addEventListener("load", a, false)
            } else {
                if (typeof aL.addEventListener != aq) {
                    aL.addEventListener("load", a, false)
                } else {
                    if (typeof af.attachEvent != aq) {
                        aM(af, "onload", a)
                    } else {
                        if (typeof af.onload == "function") {
                            var b = af.onload;
                            af.onload = function () {
                                b();
                                a()
                            }
                        } else {
                            af.onload = a
                        }
                    }
                }
            }
        }

        function aN() {
            if (aa) {
                Y()
            } else {
                am()
            }
        }

        function Y() {
            var d = aL.getElementsByTagName("body")[0];
            var b = ar(aD);
            b.setAttribute("type", aE);
            var a = d.appendChild(b);
            if (a) {
                var c = 0;
                (function () {
                    if (typeof a.GetVariable != aq) {
                        var e = a.GetVariable("$version");
                        if (e) {
                            e = e.split(" ")[1].split(",");
                            ah.pv = [parseInt(e[0], 10), parseInt(e[1], 10), parseInt(e[2], 10)]
                        }
                    } else {
                        if (c < 10) {
                            c++;
                            setTimeout(arguments.callee, 10);
                            return
                        }
                    }
                    d.removeChild(b);
                    a = null;
                    am()
                })()
            } else {
                am()
            }
        }

        function am() {
            var g = aG.length;
            if (g > 0) {
                for (var h = 0; h < g; h++) {
                    var c = aG[h].id;
                    var l = aG[h].callbackFn;
                    var a = {
                        success: false,
                        id: c
                    };
                    if (ah.pv[0] > 0) {
                        var i = aS(c);
                        if (i) {
                            if (ao(aG[h].swfVersion) && !(ah.wk && ah.wk < 312)) {
                                ay(c, true);
                                if (l) {
                                    a.success = true;
                                    a.ref = av(c);
                                    l(a)
                                }
                            } else {
                                if (aG[h].expressInstall && au()) {
                                    var e = {};
                                    e.data = aG[h].expressInstall;
                                    e.width = i.getAttribute("width") || "0";
                                    e.height = i.getAttribute("height") || "0";
                                    if (i.getAttribute("class")) {
                                        e.styleclass = i.getAttribute("class")
                                    }
                                    if (i.getAttribute("align")) {
                                        e.align = i.getAttribute("align")
                                    }
                                    var f = {};
                                    var d = i.getElementsByTagName("param");
                                    var k = d.length;
                                    for (var j = 0; j < k; j++) {
                                        if (d[j].getAttribute("name").toLowerCase() != "movie") {
                                            f[d[j].getAttribute("name")] = d[j].getAttribute("value")
                                        }
                                    }
                                    ae(e, f, c, l)
                                } else {
                                    aF(i);
                                    if (l) {
                                        l(a)
                                    }
                                }
                            }
                        }
                    } else {
                        ay(c, true);
                        if (l) {
                            var b = av(c);
                            if (b && typeof b.SetVariable != aq) {
                                a.success = true;
                                a.ref = b
                            }
                            l(a)
                        }
                    }
                }
            }
        }

        function av(b) {
            var d = null;
            var c = aS(b);
            if (c && c.nodeName == "OBJECT") {
                if (typeof c.SetVariable != aq) {
                    d = c
                } else {
                    var a = c.getElementsByTagName(aD)[0];
                    if (a) {
                        d = a
                    }
                }
            }
            return d
        }

        function au() {
            return !aU && ao("6.0.65") && (ah.win || ah.mac) && !(ah.wk && ah.wk < 312)
        }

        function ae(f, d, h, e) {
            aU = true;
            ap = e || null;
            at = {
                success: false,
                id: h
            };
            var a = aS(h);
            if (a) {
                if (a.nodeName == "OBJECT") {
                    aJ = aO(a);
                    ad = null
                } else {
                    aJ = a;
                    ad = h
                }
                f.id = ac;
                if (typeof f.width == aq || (!/%$/.test(f.width) && parseInt(f.width, 10) < 310)) {
                    f.width = "310"
                }
                if (typeof f.height == aq || (!/%$/.test(f.height) && parseInt(f.height, 10) < 137)) {
                    f.height = "137"
                }
                aL.title = aL.title.slice(0, 47) + " - Flash Player Installation";
                var b = ah.ie && ah.win ? "ActiveX" : "PlugIn",
                    c = "MMredirectURL=" + af.location.toString().replace(/&/g, "%26") + "&MMplayerType=" + b + "&MMdoctitle=" + aL.title;
                if (typeof d.flashvars != aq) {
                    d.flashvars += "&" + c
                } else {
                    d.flashvars = c
                }
                if (ah.ie && ah.win && a.readyState != 4) {
                    var g = ar("div");
                    h += "SWFObjectNew";
                    g.setAttribute("id", h);
                    a.parentNode.insertBefore(g, a);
                    a.style.display = "none";
                    (function () {
                        if (a.readyState == 4) {
                            a.parentNode.removeChild(a)
                        } else {
                            setTimeout(arguments.callee, 10)
                        }
                    })()
                }
                aA(f, d, h)
            }
        }

        function aF(a) {
            if (ah.ie && ah.win && a.readyState != 4) {
                var b = ar("div");
                a.parentNode.insertBefore(b, a);
                b.parentNode.replaceChild(aO(a), b);
                a.style.display = "none";
                (function () {
                    if (a.readyState == 4) {
                        a.parentNode.removeChild(a)
                    } else {
                        setTimeout(arguments.callee, 10)
                    }
                })()
            } else {
                a.parentNode.replaceChild(aO(a), a)
            }
        }

        function aO(b) {
            var d = ar("div");
            if (ah.win && ah.ie) {
                d.innerHTML = b.innerHTML
            } else {
                var e = b.getElementsByTagName(aD)[0];
                if (e) {
                    var a = e.childNodes;
                    if (a) {
                        var f = a.length;
                        for (var c = 0; c < f; c++) {
                            if (!(a[c].nodeType == 1 && a[c].nodeName == "PARAM") && !(a[c].nodeType == 8)) {
                                d.appendChild(a[c].cloneNode(true))
                            }
                        }
                    }
                }
            }
            return d
        }

        function aA(e, g, c) {
            var d, a = aS(c);
            if (ah.wk && ah.wk < 312) {
                return d
            }
            if (a) {
                if (typeof e.id == aq) {
                    e.id = c
                }
                if (ah.ie && ah.win) {
                    var f = "";
                    for (var i in e) {
                        if (e[i] != Object.prototype[i]) {
                            if (i.toLowerCase() == "data") {
                                g.movie = e[i]
                            } else {
                                if (i.toLowerCase() == "styleclass") {
                                    f += ' class="' + e[i] + '"'
                                } else {
                                    if (i.toLowerCase() != "classid") {
                                        f += " " + i + '="' + e[i] + '"'
                                    }
                                }
                            }
                        }
                    }
                    var h = "";
                    for (var j in g) {
                        if (g[j] != Object.prototype[j]) {
                            h += '<param name="' + j + '" value="' + g[j] + '" />'
                        }
                    }
                    a.outerHTML = '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"' + f + ">" + h + "</object>";
                    ag[ag.length] = e.id;
                    d = aS(e.id)
                } else {
                    var b = ar(aD);
                    b.setAttribute("type", aE);
                    for (var k in e) {
                        if (e[k] != Object.prototype[k]) {
                            if (k.toLowerCase() == "styleclass") {
                                b.setAttribute("class", e[k])
                            } else {
                                if (k.toLowerCase() != "classid") {
                                    b.setAttribute(k, e[k])
                                }
                            }
                        }
                    }
                    for (var l in g) {
                        if (g[l] != Object.prototype[l] && l.toLowerCase() != "movie") {
                            aQ(b, l, g[l])
                        }
                    }
                    a.parentNode.replaceChild(b, a);
                    d = b
                }
            }
            return d
        }

        function aQ(b, d, c) {
            var a = ar("param");
            a.setAttribute("name", d);
            a.setAttribute("value", c);
            b.appendChild(a)
        }

        function aw(a) {
            var b = aS(a);
            if (b && b.nodeName == "OBJECT") {
                if (ah.ie && ah.win) {
                    b.style.display = "none";
                    (function () {
                        if (b.readyState == 4) {
                            aT(a)
                        } else {
                            setTimeout(arguments.callee, 10)
                        }
                    })()
                } else {
                    b.parentNode.removeChild(b)
                }
            }
        }

        function aT(a) {
            var b = aS(a);
            if (b) {
                for (var c in b) {
                    if (typeof b[c] == "function") {
                        b[c] = null
                    }
                }
                b.parentNode.removeChild(b)
            }
        }

        function aS(a) {
            var c = null;
            try {
                c = aL.getElementById(a)
            } catch (b) {}
            return c
        }

        function ar(a) {
            return aL.createElement(a)
        }

        function aM(a, c, b) {
            a.attachEvent(c, b);
            al[al.length] = [a, c, b]
        }

        function ao(a) {
            var b = ah.pv,
                c = a.split(".");
            c[0] = parseInt(c[0], 10);
            c[1] = parseInt(c[1], 10) || 0;
            c[2] = parseInt(c[2], 10) || 0;
            return (b[0] > c[0] || (b[0] == c[0] && b[1] > c[1]) || (b[0] == c[0] && b[1] == c[1] && b[2] >= c[2])) ? true : false
        }

        function az(b, f, a, c) {
            if (ah.ie && ah.mac) {
                return
            }
            var e = aL.getElementsByTagName("head")[0];
            if (!e) {
                return
            }
            var g = (a && typeof a == "string") ? a : "screen";
            if (c) {
                aH = null;
                an = null
            }
            if (!aH || an != g) {
                var d = ar("style");
                d.setAttribute("type", "text/css");
                d.setAttribute("media", g);
                aH = e.appendChild(d);
                if (ah.ie && ah.win && typeof aL.styleSheets != aq && aL.styleSheets.length > 0) {
                    aH = aL.styleSheets[aL.styleSheets.length - 1]
                }
                an = g
            }
            if (ah.ie && ah.win) {
                if (aH && typeof aH.addRule == aD) {
                    aH.addRule(b, f)
                }
            } else {
                if (aH && typeof aL.createTextNode != aq) {
                    aH.appendChild(aL.createTextNode(b + " {" + f + "}"))
                }
            }
        }

        function ay(a, c) {
            if (!aI) {
                return
            }
            var b = c ? "visible" : "hidden";
            if (ak && aS(a)) {
                aS(a).style.visibility = b
            } else {
                az("#" + a, "visibility:" + b)
            }
        }

        function ai(b) {
            var a = /[\\\"<>\.;]/;
            var c = a.exec(b) != null;
            return c && typeof encodeURIComponent != aq ? encodeURIComponent(b) : b
        }
        var aR = function () {
                if (ah.ie && ah.win) {
                    window.attachEvent("onunload", function () {
                        var a = al.length;
                        for (var b = 0; b < a; b++) {
                            al[b][0].detachEvent(al[b][1], al[b][2])
                        }
                        var d = ag.length;
                        for (var c = 0; c < d; c++) {
                            aw(ag[c])
                        }
                        for (var e in ah) {
                            ah[e] = null
                        }
                        ah = null;
                        for (var f in swfobject) {
                            swfobject[f] = null
                        }
                        swfobject = null
                    })
                }
            }();
        return {
            registerObject: function (a, e, c, b) {
                if (ah.w3 && a && e) {
                    var d = {};
                    d.id = a;
                    d.swfVersion = e;
                    d.expressInstall = c;
                    d.callbackFn = b;
                    aG[aG.length] = d;
                    ay(a, false)
                } else {
                    if (b) {
                        b({
                            success: false,
                            id: a
                        })
                    }
                }
            },
            getObjectById: function (a) {
                if (ah.w3) {
                    return av(a)
                }
            },
            embedSWF: function (k, e, h, f, c, a, b, i, g, j) {
                var d = {
                    success: false,
                    id: e
                };
                if (ah.w3 && !(ah.wk && ah.wk < 312) && k && e && h && f && c) {
                    ay(e, false);
                    aj(function () {
                        h += "";
                        f += "";
                        var q = {};
                        if (g && typeof g === aD) {
                            for (var o in g) {
                                q[o] = g[o]
                            }
                        }
                        q.data = k;
                        q.width = h;
                        q.height = f;
                        var n = {};
                        if (i && typeof i === aD) {
                            for (var p in i) {
                                n[p] = i[p]
                            }
                        }
                        if (b && typeof b === aD) {
                            for (var l in b) {
                                if (typeof n.flashvars != aq) {
                                    n.flashvars += "&" + l + "=" + b[l]
                                } else {
                                    n.flashvars = l + "=" + b[l]
                                }
                            }
                        }
                        if (ao(c)) {
                            var m = aA(q, n, e);
                            if (q.id == e) {
                                ay(e, true)
                            }
                            d.success = true;
                            d.ref = m
                        } else {
                            if (a && au()) {
                                q.data = a;
                                ae(q, n, e, j);
                                return
                            } else {
                                ay(e, true)
                            }
                        }
                        if (j) {
                            j(d)
                        }
                    })
                } else {
                    if (j) {
                        j(d)
                    }
                }
            },
            switchOffAutoHideShow: function () {
                aI = false
            },
            ua: ah,
            getFlashPlayerVersion: function () {
                return {
                    major: ah.pv[0],
                    minor: ah.pv[1],
                    release: ah.pv[2]
                }
            },
            hasFlashPlayerVersion: ao,
            createSWF: function (a, b, c) {
                if (ah.w3) {
                    return aA(a, b, c)
                } else {
                    return undefined
                }
            },
            showExpressInstall: function (b, a, d, c) {
                if (ah.w3 && au()) {
                    ae(b, a, d, c)
                }
            },
            removeSWF: function (a) {
                if (ah.w3) {
                    aw(a)
                }
            },
            createCSS: function (b, a, c, d) {
                if (ah.w3) {
                    az(b, a, c, d)
                }
            },
            addDomLoadEvent: aj,
            addLoadEvent: aC,
            getQueryParamValue: function (b) {
                var a = aL.location.search || aL.location.hash;
                if (a) {
                    if (/\?/.test(a)) {
                        a = a.split("?")[1]
                    }
                    if (b == null) {
                        return ai(a)
                    }
                    var c = a.split("&");
                    for (var d = 0; d < c.length; d++) {
                        if (c[d].substring(0, c[d].indexOf("=")) == b) {
                            return ai(c[d].substring((c[d].indexOf("=") + 1)))
                        }
                    }
                }
                return ""
            },
            expressInstallCallback: function () {
                if (aU) {
                    var a = aS(ac);
                    if (a && aJ) {
                        a.parentNode.replaceChild(aJ, a);
                        if (ad) {
                            ay(ad, true);
                            if (ah.ie && ah.win) {
                                aJ.style.display = "block"
                            }
                        }
                        if (ap) {
                            ap(at)
                        }
                    }
                    aU = false
                }
            }
        }
    }();
cm.TagModel = function (f) {
    var e;
    var a;

    function b() {
        f(".motd_shop_item").each(function (v, w) {
            var x = a.shopButtons[v];
            f(this).attr("index", v).attr("onmouseover", "cm.ShopView.showItemTooltip( this, event );").attr("onmouseout", "removeTooltip();").html("<div class='name'>" + 0 + "</div><div class='info'><img src=''><div class='costContainer'><span class='price'>40</span></div><div class='ownedContainer'><span class='label'>Owned:</span><spanid='item932Count'>" + 2 + "</span></div><a class='buttonGreen20' onclick='cm.ShopController.buy();'><span id='item932ButtonText'>" + g_js_strings.commonstr.buy + "</span></a></div>")
        });
        var u = "name='Item' onmouseover='cm.ShopView.showItemTooltip( this, event );' onmouseout='removeTooltip();' ><div class='name'>Aura Of Conquest</div><div class='info'></div>"
    }

    function s() {
        var u = a.shopButtons[f(this).attr("index")]
    }

    function i(v) {
        var u = a.links[f(this).attr("index")];
        if (u == "00010") {
            p()
        }
        if (u == "00011") {
            k()
        }
        if (u == "00012") {
            n()
        }
        if (u == "00013") {
            g()
        }
        if (u == "00014") {
            q()
        }
        if (u == "00015") {
            l()
        }
        if (u == "00016") {
            h()
        }
        if (u == "00021") {
            d()
        }
        if (u == "00022") {
            o()
        }
        if (u == "00023") {
            c()
        }
        if (u == "00024") {
            r()
        }
        if (u == "00025") {
            m()
        }
        if (u == "00026") {
            j()
        }
        if (u == "00030") {
            t()
        }
        v.stopPropagation()
    }

    function p() {
        Modal.hideModalAll();
        cm.ShopView.openShop(0)
    }

    function k() {
        Modal.hideModalAll();
        cm.ShopView.openShop(1)
    }

    function n() {
        Modal.hideModalAll();
        cm.ShopView.openShop(2)
    }

    function g() {
        Modal.hideModalAll();
        cm.ShopView.openShop(3)
    }

    function q() {
        Modal.hideModalAll();
        cm.ShopView.openShop(4)
    }

    function l() {
        Modal.hideModalAll();
        cm.ShopView.openShop(5)
    }

    function h() {
        Modal.hideModalAll();
        cm.ShopView.openShop(6)
    }

    function d() {
        Modal.hideModalAll();
        cm.InventoryView.openInventory(1);
        cm.InventoryView.openTab(1)
    }

    function o() {
        Modal.hideModalAll();
        cm.InventoryView.openInventory(2);
        cm.InventoryView.openTab(2)
    }

    function c() {
        Modal.hideModalAll();
        cm.InventoryView.openInventory(3);
        cm.InventoryView.openTab(3)
    }

    function r() {
        Modal.hideModalAll();
        cm.InventoryView.openInventory(4);
        cm.InventoryView.openTab(4)
    }

    function m() {
        Modal.hideModalAll();
        cm.InventoryView.openInventory(5);
        cm.InventoryView.openTab(5)
    }

    function j() {
        Modal.hideModalAll();
        cm.InventoryView.openInventory(6);
        cm.InventoryView.openTab(6)
    }

    function t() {
        Modal.hideModalAll();
        modal_getgems()
    }
    return {
        markUp: function (u) {
            e = u;
            str = e.replace(/\[SHOP_.{1,6}\]/g, "<div class='motd_shop_item item' ></div>");
            str = str.replace(/\[LINK_.{1,6}\]/g, "<div class='motd_link'>").replace(/\[ENDLINK\]/g, "</div>");
            return str
        },
        bind: function () {
            a = cm.ParseModel.parseTokens(e);
            f(".motd_link").each(function (u, v) {
                f(this).attr("index", u)
            });
            f(".motd_shop_item").unbind("click").bind("click", s);
            f(".motd_link").unbind("click").bind("click", i);
            b()
        }
    }
}(jQuery);
cm = cm || {};
cm.Template = function (e) {
    var b = {};
    var d = function (h) {
            var g = "";
            if (b[h]) {
                g = b[h]
            } else {
                e.ajax({
                    url: "html/" + h + ".html",
                    type: "GET",
                    async: false,
                    dataType: "text",
                    timeout: 60000,
                    success: function (j, k, i) {
                        g = i.responseText;
                        b[h] = g
                    },
                    error: function (i, j) {
                        g = ["Cannot load ", h, ". (", j, ")"].join("")
                    }
                })
            }
            return g
        };
    var a = function (i, h) {
            try {
                if ("true" !== cm.features.FE_TEMPLATE_COMPILED) {
                    throw "fallback to legacy template loading flow..."
                }
                if (!cm.FETemplates[i][h]) {
                    throw "fallback to legacy template loading flow..."
                }
                return cm.FETemplates[i][h]
            } catch (l) {}
            var g, j, n, o, m, k;
            k = d(i);
            n = "<!--" + h + "-->";
            o = "<!--/" + h + "-->";
            g = k.indexOf(n) + n.length;
            j = k.indexOf("<!--/" + h + "-->");
            if (g >= 0 && j >= 0 && g < j) {
                m = k.substring(g, j);
                m.replace("\n", " ");
                m.replace("\t", " ");
                m.replace("'", "'");
                m.replace(/\\'/g, "'");
                return unescape(m)
            } else {
                return [h, " not found in ", i, ". (", k, ")"].join("")
            }
        };
    var c = function (j, i, l) {
            var h = null,
                k, g;
            h = a(j, i);
            k = new Template(h);
            if (e.isArray(l)) {
                g = [];
                e.each(l, function (n, m) {
                    g.push(k.evaluate(m))
                })
            } else {
                g = k.evaluate(l)
            }
            return g
        };
    var f = function () {};
    f();
    return {
        renderTemplate: c,
        getTemplate: a
    }
}(jQuery);
cm = cm || {};
cm.ThroneController = function (g) {
    var h = function (o) {
            var r = [],
                q, p = 0,
                n;
            g.each(o, function (s, t) {
                p++;
                n = Math.ceil(p / 5);
                q = g("<div/>");
                q.attr("id", "throneInventoryItem" + t.id);
                q.addClass(t.type + " " + t.faction);
                if (t.isEquipped) {
                    q.addClass(" equip")
                }
                if (!g.isEmptyObject(seed.queue_throne)) {
                    if (t.id == seed.queue_throne.itemId) {
                        q.append("<span class='repair'></span>")
                    } else {
                        if (t.isBroken) {
                            q.append("<span class='broken'></span>")
                        }
                    }
                } else {
                    if (t.isBroken) {
                        q.append("<span class='broken'></span>")
                    }
                }
                q.mouseenter(function (u) {
                    g("#contextMenu").remove();
                    if (g("#throneInventoryItemTooltip").length === 0 || g("#kofcNewTooltipDiv").css("display") === "none") {
                        cm.ThroneView.hoverItem(u, this, t)
                    }
                });
                q.mouseleave(function (u) {
                    cm.ThroneView.unhoverItem(u, this, t)
                });
                if (n <= seed.throne.rowNum) {
                    q.bind("click", function (u) {
                        cm.ThroneView.unhoverItem(u, this, t);
                        cm.ContextualMenuThrone.renderMenu(this, t)
                    })
                }
                r.push(q)
            });
            return r
        };
    var m = function (o) {
            var n = new cm.ThroneItemModel(999, o);
            kocThroneItems[n.id] = n
        };
    var j = function (o) {
            var n = +(cm.WorldSettings.getSetting("TR_MAX_INVENTORY_ROWS")),
                t = seed.throne.rowNum,
                q = [],
                s, r;
            for (var p = 0; p < n; ++p) {
                r = p + 1;
                s = g("<li/>");
                s.attr("id", "throneInventoryRow" + (p + 1));
                if (r <= t) {
                    s.addClass("active")
                } else {
                    if (r === (t + 1)) {
                        s.addClass("buy");
                        s.bind("click", function () {
                            cm.ContextualMenuThrone.renderMenu(this, null)
                        })
                    } else {
                        s.addClass("inactive")
                    }
                }
                if (o.length >= 5) {
                    g.each(o.splice(0, 5), function (u, v) {
                        s.append(v)
                    })
                } else {
                    if (o.length >= 1 && o.length < 5) {
                        g.each(o.splice(0, o.length), function (u, v) {
                            s.append(v)
                        })
                    }
                }
                q.push(s)
            }
            return q
        };
    var c = function (s) {
            var r = s.type,
                p = seed.throne.activeSlot,
                t = seed.throne.slotEquip[p],
                q = [],
                n;
            var o = {};
            g.each(t, function (u, v) {
                n = kocThroneItems[v];
                if (n.type === r) {
                    o.item1 = s;
                    o.item2 = n;
                    o.idx = u;
                    return false
                }
            });
            return o
        };
    var k = function (n) {
            AjaxCall.gPostRequest("ajax/_dispatch53.php", {
                ctrl: "throneRoom\\ThroneRoomServiceAjax",
                action: "equipItem",
                itemId: n.id,
                presetId: seed.throne.activeSlot
            }, function (o) {
                if (o.ok === true) {
                    cm.ThroneView.clickItemEquip(n)
                } else {
                    cm.ModalManager.alert({
                        button_text: g_js_strings.commonstr.ok,
                        text: o.msg,
                        "class": "craftFailure",
                        exe: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close()
                        }
                    })
                }
            })
        };
    var e = function (n) {
            AjaxCall.gPostRequest("ajax/_dispatch53.php", {
                ctrl: "throneRoom\\ThroneRoomServiceAjax",
                action: "unequipItem",
                itemId: n.id,
                presetId: seed.throne.activeSlot
            }, function (o) {
                if (o.ok === true) {
                    cm.ThroneView.clickItemUnequip(n)
                } else {
                    cm.ModalManager.alert({
                        button_text: g_js_strings.commonstr.ok,
                        text: o.msg,
                        "class": "craftFailure",
                        exe: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close()
                        }
                    })
                }
            })
        };
    var b = function (n) {
            AjaxCall.gPostRequest("ajax/_dispatch53.php", {
                ctrl: "throneRoom\\ThroneRoomServiceAjax",
                action: "salvage",
                itemId: n.id,
                cityId: currentcityid
            }, function (o) {
                if (o.ok === true) {
                    n.salvage()
                } else {
                    cm.ModalManager.alert({
                        button_text: g_js_strings.commonstr.ok,
                        text: o.msg,
                        "class": "craftFailure",
                        exe: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close()
                        }
                    })
                }
            })
        };
    var l = function (o, n) {
            AjaxCall.gPostRequest("ajax/_dispatch53.php", {
                ctrl: "throneRoom\\ThroneRoomServiceAjax",
                action: "setPreset",
                presetId: n
            }, function (p) {
                if (p.ok === true) {
                    cm.ThroneView.clickActivePreset(o)
                } else {
                    cm.ModalManager.alert({
                        button_text: g_js_strings.commonstr.ok,
                        text: p.msg,
                        "class": "craftFailure",
                        exe: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close()
                        }
                    })
                }
            })
        };
    var a = function (p) {
            var o = "TR_PRESET_COST_" + (seed.throne.slotNum + 1),
                q = +(cm.WorldSettings.getSetting(o)),
                n = +(seed.player.gems);
            if (q > n) {
                modal_getgems()
            } else {
                AjaxCall.gPostRequest("ajax/_dispatch53.php", {
                    ctrl: "throneRoom\\ThroneRoomServiceAjax",
                    action: "buyNextPreset"
                }, function (r) {
                    if (r.ok === true) {
                        seed.player.gems = +(seed.player.gems) - q;
                        g("#kochead_gems").text(seed.player.gems);
                        g(".gemContainer .amount").text(seed.player.gems);
                        cm.ThroneView.buyPreset(p)
                    } else {
                        cm.ModalManager.alert({
                            button_text: g_js_strings.commonstr.ok,
                            text: r.msg,
                            "class": "craftFailure",
                            exe: function () {
                                Modal.hideModalAll();
                                cm.ModalManager.close()
                            }
                        })
                    }
                })
            }
        };
    var f = function (p) {
            var o = "TR_ROW_COST_" + (seed.throne.rowNum + 1),
                q = +(cm.WorldSettings.getSetting(o)),
                n = +(seed.player.gems);
            if (q > n) {
                modal_getgems()
            } else {
                AjaxCall.gPostRequest("ajax/_dispatch53.php", {
                    ctrl: "throneRoom\\ThroneRoomServiceAjax",
                    action: "buyNextRow"
                }, function (r) {
                    if (r.ok === true) {
                        seed.player.gems = +(seed.player.gems) - q;
                        g("#kochead_gems").text(seed.player.gems);
                        g(".gemContainer .amount").text(seed.player.gems);
                        cm.ThroneView.buyRow(p)
                    } else {
                        cm.ModalManager.alert({
                            button_text: g_js_strings.commonstr.ok,
                            text: r.msg,
                            "class": "craftFailure",
                            exe: function () {
                                Modal.hideModalAll();
                                cm.ModalManager.close()
                            }
                        })
                    }
                })
            }
        };
    var d = function (s) {
            var n = seed.throne.slotEquip[seed.throne.activeSlot],
                r, q, p, t = 0,
                o;
            jQuery.each(n, function (u, v) {
                r = kocThroneItems[v];
                q = r.effects;
                jQuery.each(q, function (x, w) {
                    p = cm.thronestats.tiers[w.id][w.tier];
                    base = +(p.base);
                    growth = +(p.growth);
                    o = +(x.split("slot")[1]);
                    if (+(w.id) === s && r.quality >= o) {
                        t += base + (r.level * growth)
                    }
                })
            });
            return t
        };
    var i = function () {};
    i();
    return {
        createItems: h,
        createRows: j,
        checkType: c,
        addItem: m,
        equipItem: k,
        unequipItem: e,
        salvageItem: b,
        setPreset: l,
        buyPreset: a,
        buyRow: f,
        effectBonus: d
    }
}(jQuery);
cm = cm || {};
cm.ThroneItemModel = jQueryClass.extend({
    init: function (b, a) {
        this.id = a.id;
        this.faction = a.faction;
        this.type = a.type;
        this.quality = Number(a.quality);
        this.level = Number(a.level);
        this.effects = a.effects;
        this.isEquipped = false;
        this.isBroken = (a.status == 3 || a.status == 4) ? true : false;
        this.brokenType = this.brokenType(a);
        this.name = this.createName();
        this.description = g_js_strings.throneRoom["description_" + this.type]
    },
    createPrefix: function () {
        var b = this.quality,
            a;
        switch (b) {
        case 0:
            a = g_js_strings.throneRoom.simple;
            break;
        case 1:
            a = g_js_strings.throneRoom.common;
            break;
        case 2:
            a = g_js_strings.throneRoom.uncommon;
            break;
        case 3:
            a = g_js_strings.throneRoom.rare;
            break;
        case 4:
            a = g_js_strings.throneRoom.epic;
            break;
        case 5:
            a = g_js_strings.throneRoom.wondrous;
            break;
        default:
            a = g_js_strings.throneRoom.simple;
            break
        }
        return a
    },
    brokenType: function (b) {
        var a = b.status;
        if (a == 3) {
            return "quality"
        } else {
            if (a == 4) {
                return "level"
            } else {
                return ""
            }
        }
    },
    createSuffix: function () {
        var b = this.effects["slot" + 5],
            d = b.id,
            a = b.tier,
            c;
        c = cm.thronestats.effects[d][4];
        return c
    },
    createName: function () {
        var c = this.createPrefix(),
            b = this.type,
            d = this.createSuffix(),
            e = this.level,
            a;
        a = c + " " + b + " " + g_js_strings.commonstr.of + " " + d + " +" + e;
        return a
    },
    salvage: function () {
        var e, c = +(seed.resources["city" + currentcityid]["rec5"][0]),
            b = seed.throne.slotEquip,
            a, f = this;
        var d = 0;
        jQuery.each(this.effects, function (h, g) {
            d++
        });
        e = this.quality * (d + this.level) * cm.WorldSettings.getSettingAsNumber("AETHERSTONE_SALVAGE_MULTIPLIER", 500);
        seed.resources["city" + currentcityid]["rec5"][0] = c + e;
        jQuery.each(b, function (g, h) {
            a = jQuery.inArray(f.id, h);
            if (a > -1) {
                h.splice(a, 1)
            }
        });
        delete kocThroneItems[f.id];
        cm.ThroneView.renderInventory(kocThroneItems)
    }
});
cm = cm || {};
cm.ThronePanelController = function (f) {
    var k = null;
    var b = function (o, p) {
            if (o.quality >= 5 && p == "enhance") {
                return true
            } else {
                if (o.level >= 10 && p == "upgrade") {
                    return true
                } else {
                    return false
                }
            }
        };
    var d = function (o) {
            var p = +(cm.WorldSettings.getSetting("TR_AETHERSTONE_CONVERSION_COST")),
                q;
            q = Math.ceil(o / p);
            return q
        };
    var m = function (r, p, t, o) {
            var v = {},
                q = cm.thronestats[r],
                u, s = seed.resources["city" + currentcityid]["rec5"][0];
            v.stones = {};
            v.gems = {};
            if (r === "enhance") {
                u = p.quality + 1
            } else {
                if (r === "upgrade") {
                    u = p.level + 1
                }
            }
            if (o === "stones") {
                if (b(p, r)) {
                    v.stones.render = false;
                    v.gems.render = true;
                    v.gems.use = "--"
                } else {
                    v.stones.render = true;
                    v.stones.total = q[u].Stones;
                    if (s < v.stones.total) {
                        v.stones.use = s;
                        v.stones.css = "havent";
                        v.gems.render = true
                    } else {
                        v.stones.use = v.stones.total;
                        v.stones.css = "have";
                        v.gems.render = false
                    }
                    v.gems.total = +(seed.player.gems);
                    if (v.stones.use == v.stones.total) {
                        v.gems.use = 0
                    } else {
                        v.gems.use = d(v.stones.total - s)
                    }
                }
            } else {
                if (o === "gems") {
                    v.stones.render = false;
                    v.stones.total = 0;
                    v.stones.use = 0;
                    v.gems.render = true;
                    v.gems.total = +(seed.player.gems);
                    v.gems.use = d(q[u].Stones)
                }
            }
            return v
        };
    var n = function (r) {
            var u = 0,
                o = f("#buffDropDown"),
                t = +(o.val()),
                p = [null, ksoItems[20001], ksoItems[20002], ksoItems[20003], ksoItems[20004]],
                q = [null, ksoItems[20001], ksoItems[20002], ksoItems[20005], ksoItems[20006]],
                s;
            if (r === "enhance") {
                s = p[t]
            } else {
                if (r === "upgrade") {
                    s = q[t]
                }
            }
            if (s == null) {
                u = 0
            } else {
                if (s.count > 0) {
                    u = 0
                } else {
                    u = s.price
                }
            }
            return u
        };
    var j = function (o) {
            var p = {};
            p.id = 0;
            p.name = g_js_strings.throneRoom.buff_none, buffDropDown = f("#buffDropDown"), value = buffDropDown.val();
            if (o === "enhance") {
                if (ksoItems[20004].count > 0) {
                    p = ksoItems[20004]
                } else {
                    if (ksoItems[20003].count > 0) {
                        p = ksoItems[20003]
                    }
                }
            } else {
                if (o === "upgrade") {
                    if (ksoItems[20006].count > 0) {
                        p = ksoItems[20006]
                    } else {
                        if (ksoItems[20005].count > 0) {
                            p = ksoItems[20005]
                        }
                    }
                }
            }
            if (p.id === 0) {
                if (ksoItems[20002].count > 0) {
                    p = ksoItems[20002]
                } else {
                    if (ksoItems[20001].count > 0) {
                        p = ksoItems[20001]
                    }
                }
            }
            if (this.currentBuff) {
                if (this.currentBuff.count == 0) {
                    p = this.currentBuff
                }
            }
            return p
        };
    var g = function (u, t, v) {
            var p = 0,
                o = 0,
                s = cm.thronestats[u],
                q = 23 / 2,
                w = 257,
                r = {
                    "0": 0,
                    "1VL": 0.005,
                    "2VL": 0.0175,
                    "3VL": 0.035,
                    "4VL": 0.0575,
                    "5VL": 0.085,
                    "1L": 0.1175,
                    "2L": 0.155,
                    "3L": 0.1975,
                    "1ML": 0.245,
                    "2ML": 0.2975,
                    "3ML": 0.355,
                    "1M": 0.4175,
                    "2M": 0.485,
                    "3M": 0.5575,
                    "1MH": 0.635,
                    "2MH": 0.7175,
                    "1H": 0.805,
                    "2H": 0.8975,
                    "1EH": 0.9725,
                    "2EH": 1
                };
            if (u === "enhance") {
                o = t.quality + 1
            } else {
                if (u === "upgrade") {
                    o = t.level + 1
                }
            }
            if (v > 20000) {
                switch (v) {
                case 20001:
                    v = 1;
                    break;
                case 20002:
                    v = 2;
                    break;
                case 20003:
                    v = 3;
                    break;
                case 20004:
                    v = 4;
                    break;
                case 20005:
                    v = 3;
                    break;
                case 20006:
                    v = 4;
                    break
                }
            }
            if (v === 0 || !v) {
                p = s[o]["Base"]
            } else {
                p = s[o]["Item" + v]
            }
            p = r[p] * w + q;
            return p
        };
    var c = function (u, y) {
            var s, q, o = +(f("#costDropDown").val()),
                x, w = +(f("#buffDropDown").val()),
                p = +(seed.player.gems);
            if (u === "enhance") {
                s = "upgradeQuality"
            } else {
                if (u === "upgrade") {
                    s = "upgradeLevel"
                }
            }
            if (o === 0) {
                q = "aetherstone"
            } else {
                if (o === 1) {
                    q = "gems"
                }
            }
            if (w == 0) {
                x = {
                    id: 0
                }
            } else {
                if (w == 1) {
                    x = ksoItems[20001]
                } else {
                    if (w == 2) {
                        x = ksoItems[20002]
                    } else {
                        if (u == "enhance") {
                            if (w == 3) {
                                x = ksoItems[20003]
                            } else {
                                if (w == 4) {
                                    x = ksoItems[20004]
                                }
                            }
                        } else {
                            if (u == "upgrade") {
                                if (w == 3) {
                                    x = ksoItems[20005]
                                } else {
                                    if (w == 4) {
                                        x = ksoItems[20006]
                                    }
                                }
                            }
                        }
                    }
                }
            }
            var r = (q == "aetherstone") ? "stones" : "gems";
            var t = m(u, y, x, r);
            this.currentBuff = x;
            var v;
            if (x.count <= 0) {
                v = t.gems.use + x.price
            } else {
                v = t.gems.use
            }
            if (v > +(seed.player.gems)) {
                cm.ModalManager.alert({
                    close: function () {
                        Modal.hideModalAll();
                        cm.ModalManager.closeAll();
                        cm.ThronePanelView.panelStatus = "closed";
                        modal_getgems()
                    },
                    closeAll: true,
                    button_text: g_js_strings.commonstr.ok,
                    text: g_js_strings.crafting.notEnoughGems,
                    "class": "",
                    exe: function () {
                        Modal.hideModalAll();
                        cm.ModalManager.closeAll();
                        cm.ThronePanelView.panelStatus = "closed";
                        modal_getgems()
                    }
                })
            } else {
                AjaxCall.gPostRequest("ajax/_dispatch53.php", {
                    ctrl: "throneRoom\\ThroneRoomServiceAjax",
                    action: s,
                    throneRoomItemId: y.id,
                    payment: q,
                    buffItemId: x.id,
                    cityId: currentcityid
                }, function (z) {
                    cm.ThronePanelView.removeSpinny();
                    if (z.ok === true) {
                        if (z.gems > 0) {
                            cm.Gems.spend(z.gems)
                        }
                        seed.resources["city" + currentcityid]["rec5"][0] = seed.resources["city" + currentcityid]["rec5"][0] - z.aetherstones;
                        if (x.id != 0) {
                            x.subtract()
                        }
                        if (z.success) {
                            cm.sounds.play("tr_success_build");
                            cm.ThronePanelView.statusAnim("success");
                            y.quality = z.item.quality;
                            y.level = z.item.level;
                            y.name = y.createName()
                        } else {
                            cm.sounds.play("tr_fail_build");
                            cm.ThronePanelView.statusAnim("failure");
                            y.quality = z.item.quality;
                            y.level = z.item.level;
                            y.name = y.createName();
                            if (z["break"]) {
                                if (u === "enhance") {
                                    y.brokenType = "quality"
                                } else {
                                    if (u === "upgrade") {
                                        y.brokenType = "level"
                                    }
                                }
                                f("#throneInventoryItem" + y.id).attr("class", "");
                                f("#throneInventoryItem" + y.id).addClass("broken " + y.type + " " + y.faction);
                                f("#throneInventoryItem" + y.id + " .broken").remove();
                                f("#throneInventoryItem" + y.id).append("<span class='broken'></span>");
                                y.isBroken = true;
                                y.name = y.createName();
                                cm.ThronePanelView.renderBroken(y)
                            }
                        }
                        cm.ThroneView.renderInventory(kocThroneItems);
                        cm.ThronePanelView.renderPanel(u, y)
                    } else {
                        cm.ModalManager.alert({
                            close: function () {
                                Modal.hideModalAll();
                                cm.ModalManager.closeAll();
                                cm.ThronePanelView.panelStatus = "closed";
                                cm.ThronePanelController.currentBuff = null
                            },
                            button_text: g_js_strings.commonstr.ok,
                            text: g_js_strings.errorcode.err_default,
                            "class": "",
                            exe: function () {
                                Modal.hideModalAll();
                                cm.ModalManager.closeAll();
                                cm.ThronePanelView.panelStatus = "closed";
                                cm.ThronePanelController.currentBuff = null
                            }
                        })
                    }
                })
            }
        };
    var l = function (o) {
            AjaxCall.gPostRequest("ajax/_dispatch53.php", {
                ctrl: "throneRoom\\ThroneRoomServiceAjax",
                action: "timeRepair",
                throneRoomItemId: o.id
            }, function (p) {
                if (p.ok === true) {
                    cm.ThronePanelView.clickSpeedUp(o)
                } else {
                    cm.ModalManager.alert({
                        close: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close()
                        },
                        button_text: g_js_strings.commonstr.ok,
                        text: g_js_strings.errorcode.err_default,
                        "class": "",
                        exe: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close();
                            cm.ThronePanelView.panelStatus = "closed"
                        }
                    })
                }
            })
        };
    var e = function (o) {
            AjaxCall.gPostRequest("ajax/_dispatch53.php", {
                ctrl: "throneRoom\\ThroneRoomServiceAjax",
                action: "instantRepair",
                throneRoomItemId: o.id
            }, function (q) {
                cm.ThronePanelView.removeSpinny();
                if (q.ok === true) {
                    var r = cm.thronestats.instantCost,
                        p;
                    if (o.brokenType == "quality") {
                        p = cm.thronestats.repairCostEnhance[o.quality].GemCost
                    } else {
                        if (o.brokenType == "level") {
                            p = cm.thronestats.repairCostUpgrade[o.level].GemCost
                        }
                    }
                    cm.Gems.spend(p);
                    o.isBroken = false;
                    o.brokenType = "";
                    cm.ThronePanelView.clickInstantRepair(o)
                } else {
                    cm.ModalManager.alert({
                        close: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close()
                        },
                        button_text: g_js_strings.commonstr.ok,
                        text: g_js_strings.errorcode.err_default,
                        "class": "",
                        exe: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close();
                            cm.ThronePanelView.panelStatus = "closed"
                        }
                    })
                }
            })
        };
    var a = function (p, q, o) {
            AjaxCall.gPostRequest("ajax/_dispatch53.php", {
                ctrl: "throneRoom\\ThroneRoomServiceAjax",
                action: "timeRepair",
                throneRoomItemId: q.id
            }, function (r) {
                cm.ThronePanelView.removeSpinny();
                if (r.ok === true) {
                    cm.ThronePanelView.clickStandardRepair(p, q, o)
                } else {
                    cm.ModalManager.alert({
                        close: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close()
                        },
                        button_text: g_js_strings.commonstr.ok,
                        text: g_js_strings.errorcode.err_default,
                        "class": "",
                        exe: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close();
                            cm.ThronePanelView.panelStatus = "closed"
                        }
                    })
                }
            })
        };
    var i = function (o) {
            AjaxCall.gPostRequest("ajax/_dispatch53.php", {
                ctrl: "throneRoom\\ThroneRoomServiceAjax",
                action: "cancelRepair",
                throneRoomItemId: o.id
            }, function (p) {
                cm.ThronePanelView.removeSpinny();
                if (p.ok === true) {
                    cm.ThronePanelView.clickCancelRepair(o)
                } else {
                    cm.ModalManager.alert({
                        close: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close()
                        },
                        button_text: g_js_strings.commonstr.ok,
                        text: g_js_strings.errorcode.err_default,
                        "class": "",
                        exe: function () {
                            Modal.hideModalAll();
                            cm.ModalManager.close();
                            cm.ThronePanelView.panelStatus = "closed"
                        }
                    })
                }
            })
        };
    var h = function () {};
    h();
    return {
        currentBuff: k,
        isLastLevel: b,
        calcCost: m,
        calcBuffCost: n,
        calcBuffItem: j,
        calcRiskBarWidth: g,
        changeItem: c,
        instantRepair: e,
        speedupRepair: l,
        standardRepair: a,
        cancelRepair: i
    }
}(jQuery);
cm = cm || {};
cm.ThronePanelView = function (z) {
    var g = g_js_strings.throneRoom,
        v = [{
            id: 0,
            name: g_js_strings.throneRoom.buff_none
        },
        ksoItems["20001"], ksoItems["20002"], ksoItems["20003"], ksoItems["20004"]],
        l = [{
            id: 0,
            name: g_js_strings.throneRoom.buff_none
        },
        ksoItems["20001"], ksoItems["20002"], ksoItems["20005"], ksoItems["20006"]],
        a = [g.buff_none],
        k = "closed",
        d = {},
        q, J, D = "";
    var B = function (P, R) {
            D = P;
            z("#throneInventoryList .selected").removeClass("selected");
            var O, K, M, N, L, Q;
            O = cm.Template.renderTemplate("Throne", "thronePanel", {});
            z("#thronePanelContainer").html(O);
            if (R) {
                J = R.id;
                if (P === "enhance") {
                    N = h(1, R, "current", P);
                    L = h(2, R, "next", P);
                    z("#thronePanelStat1").empty();
                    z("#thronePanelStat1").html(N);
                    z("#thronePanelStat2").empty();
                    z("#thronePanelStat2").html(L)
                } else {
                    if (P === "upgrade") {
                        N = h(1, R, "current", P);
                        L = h(2, R, "next", P);
                        z("#thronePanelStat1").empty();
                        z("#thronePanelStat1").html(N);
                        z("#thronePanelStat2").empty();
                        z("#thronePanelStat2").html(L)
                    }
                }
                x(P, R);
                p(P);
                A(R);
                if (P == "enhance") {
                    t(R)
                }
                c(P, R);
                if (cm.ThronePanelView.panelStatus == "closed") {
                    z("#thronePanelContainer").animate({
                        right: "+=500"
                    }, 500, function () {
                        cm.ThronePanelView.panelStatus = "opened"
                    })
                }
                z("#thronePanelSlideArrow").click(function () {
                    z("#thronePanelContainer").animate({
                        right: "-=500"
                    }, 500, function () {
                        G()
                    })
                });
                z("#throneInventoryItem" + R.id).addClass("selected")
            }
            return O
        };
    var G = function () {
            cm.ThronePanelView.panelStatus = "closed";
            z("#throneInventoryItem" + J).removeClass("selected");
            currentThroneRoomeItem = null;
            D = "";
            cm.ThronePanelController.currentBuff = null
        };
    var x = function (O, P) {
            var N = z("#thronePanelContainer ul.tabsv2"),
                Q = [g_js_strings.throneRoom.button_enhance, g_js_strings.throneRoom.button_upgrade],
                L;
            N.empty();
            for (var M = 0, K = Q.length; M < K; ++M) {
                L = z("<li/>").html(Q[M]).click({
                    id: M
                }, function (R) {
                    z(".tabsv2 .selected").removeClass("selected");
                    z(this).addClass("selected");
                    cm.ThronePanelController.currentBuff = null;
                    B(Q[R.data.id].toLowerCase(), P);
                    D = O
                });
                if (O === "enhance" && M === 0) {
                    L.addClass("selected")
                } else {
                    if (O === "upgrade" && M === 1) {
                        L.addClass("selected")
                    }
                }
                N.append(L)
            }
        };
    var p = function (N) {
            var M = [],
                K = z("#thronePanelInstructions"),
                O = standalone;
            K.empty();
            for (var L = 1; L <= 4; ++L) {
                if (N == "enhance") {
                    K.append("<li>" + g_js_strings.throneRoom["enhance_instr" + L] + "</li>")
                } else {
                    if (N == "upgrade") {
                        K.append("<li>" + g_js_strings.throneRoom["upgrade_instr" + L] + "</li>")
                    }
                }
            }
            return false
        };
    var s = function (L, K) {
            return "img/throne/icons/" + K + "/" + L.faction + "/" + L.createPrefix().toLowerCase() + "_" + L.faction + "_" + L.type + "_1.png"
        };
    var A = function (L) {
            var K = z("#thronePanelName");
            K.html(L.name);
            K.attr("class", "");
            K.addClass("name " + L.createPrefix().toLowerCase())
        };
    var t = function (R) {
            var M = [],
                S = ["simple", "common", "uncommon", "rare", "epic", "wondrous", "unique"],
                N = [g_js_strings.throneRoom.simple, g_js_strings.throneRoom.common, g_js_strings.throneRoom.uncommon, g_js_strings.throneRoom.rare, g_js_strings.throneRoom.epic, g_js_strings.throneRoom.wondrous, g_js_strings.throneRoom.unique],
                P = document.createDocumentFragment(),
                Q, O = z("#thronePanelProgressBarList");
            P = z(P);
            if (R.quality === 6) {
                for (var L = 0; L <= 6; ++L) {
                    if (L !== 6) {
                        M.push("<li class='locked'>" + g_js_strings.throneRoom.locked + "</li>");
                        Q = z("<li/>").addClass("locked").html(g_js_strings.throneRoom.locked);
                        Q.bind("mouseenter", {
                            idx: L
                        }, function (T) {
                            Tooltip.show(T, N[T.data.idx], [0, 0])
                        });
                        Q.bind("mouseenter", function (T) {
                            Tooltip.remove(0)
                        });
                        O.append(Q)
                    } else {
                        M.push("<li class='unique last'>" + g_js_strings.throneRoom.unique + "</li>");
                        Q = z("<li/>").addClass("unique last").html(g_js_strings.throneRoom.unique);
                        Q.bind("mouseenter", {
                            idx: L
                        }, function (T) {
                            Tooltip.show(T, N[T.data.idx], [0, 0])
                        });
                        Q.bind("mouseenter", function (T) {
                            Tooltip.remove(0)
                        });
                        O.append(Q)
                    }
                }
            } else {
                for (var K = 0; K <= 6; ++K) {
                    if (K === 6) {
                        M.push("<li class='locked last'>" + g_js_strings.throneRoom.unique + "</li>");
                        Q = z("<li/>").addClass("locked last").html(g_js_strings.throneRoom.unique);
                        Q.bind("mouseenter", {
                            idx: K
                        }, function (T) {
                            Tooltip.show(T, N[T.data.idx], [0, 0])
                        });
                        Q.bind("mouseenter", function (T) {
                            Tooltip.remove(0)
                        });
                        O.append(Q)
                    } else {
                        if (K <= R.quality) {
                            M.push("<li class='" + S[K] + "'>" + N[K] + "</li>");
                            Q = z("<li/>").addClass(S[K]).html(N[K]);
                            Q.bind("mouseenter", {
                                idx: K
                            }, function (T) {
                                Tooltip.show(T, N[T.data.idx], [0, 0])
                            });
                            Q.bind("mouseenter", function (T) {
                                Tooltip.remove(0)
                            });
                            O.append(Q)
                        } else {
                            M.push("<li class='empty'>" + N[K] + "</li>");
                            Q = z("<li/>").addClass("empty").html(N[K]);
                            Q.bind("mouseenter", {
                                idx: K
                            }, function (T) {
                                Tooltip.show(T, N[T.data.idx], [0, 0])
                            });
                            Q.bind("mouseenter", function (T) {
                                Tooltip.remove(0)
                            });
                            O.append(Q)
                        }
                    }
                }
            }
            return M.join("")
        };
    var h = function (L, U, S, M) {
            var O = [],
                N, V, P, R, K = {},
                Q, T;
            if (S == "next") {
                if (M == "enhance") {
                    ++U.quality
                } else {
                    if (M == "upgrade") {
                        ++U.level
                    }
                }
            }
            z.each(U.effects, function (W, X) {
                N = +(W.split("slot")[1]);
                V = cm.thronestats.effects[X.id];
                P = cm.thronestats.tiers[X.id][X.tier];
                R = +(P.base) + ((U.level * U.level + U.level) * +(P.growth) / 2);
                if (R < 1) {
                    R = R.toFixed(2)
                }
                K[X.id] = {};
                K[X.id].percent = R;
                K[X.id].name = V[1];
                if (N % 2 == 0) {
                    Q = "even"
                } else {
                    Q = "odd"
                }
                if (N <= U.quality) {
                    O.push("<li class='" + Q + "'>" + V[1] + " + " + R + "%</li>")
                } else {
                    O.push("<li class='disabled " + Q + "'>" + V[1] + " + " + R + "%</li>")
                }
            });
            if (S == "next") {
                if (M == "enhance") {
                    --U.quality
                } else {
                    if (M == "upgrade") {
                        --U.level
                    }
                }
            }
            if (S === "next") {
                if (cm.ThronePanelController.isLastLevel(U, M)) {
                    T = z("<div/>").addClass("lock").attr("id", "lockedStatIcon");
                    z("#nextStatContainer").append(T)
                } else {
                    z("#lockedStatIcon").remove()
                }
            }
            return O.join("")
        };
    var c = function (P, af) {
            var T = [],
                L = z("#thronePanelItemRequirementsContainer"),
                ai, O, S, ag, N, W, ae, aa, M, Q, aj, K, Y, U = ["gems", "aetherstones"],
                V = [],
                Z, ah, ad, X;
            if (P === "enhance") {
                V = [{
                    id: 0,
                    name: g_js_strings.throneRoom.buff_none
                },
                ksoItems["20001"], ksoItems["20002"],
                {},
                ksoItems["20004"]]
            } else {
                if (P === "upgrade") {
                    V = [{
                        id: 0,
                        name: g_js_strings.throneRoom.buff_none
                    },
                    ksoItems["20001"], ksoItems["20002"], ksoItems["20005"], ksoItems["20006"]]
                } else {
                    if (P === "modify") {
                        V = a
                    }
                }
            }
            L.empty();
            ai = z("<div/>");
            ai.addClass("title");
            ai.html(g_js_strings.throneRoom.req_title);
            L.append(ai);
            O = z("<div/>");
            O.addClass("costContainer");
            W = z("<select/>");
            W.attr("id", "costDropDown");
            if (!cm.ThronePanelController.isLastLevel(af, P)) {
                W.append('<option value="0">' + g_js_strings.commonstr.aetherstones + "</option>");
                W.append('<option value="1">' + g_js_strings.commonstr.gems + "</option>");
                W.bind("change", function (ak) {
                    j(z(this).val(), P, af)
                })
            } else {
                W.append('<option value="">--</option>');
                W.attr("disabled", "disabled")
            }
            ae = z("<div/>");
            ae.attr("id", "thronePanelCostIcon");
            if (cm.ThronePanelController.isLastLevel(af, P)) {
                ae.addClass("icon 0")
            } else {
                ae.addClass("icon aetherstones")
            }
            ae.html("aetherstones");
            o(ae, null, "cost");
            ag = cm.ThronePanelController.calcBuffItem(P);
            Z = cm.ThronePanelController.calcCost(P, af, ag, "stones");
            var R = cm.ThronePanelController.currentBuff;
            aa = z("<div/>");
            aa.attr("id", "thronePanelCostPrice");
            aa.addClass("price");
            if (Z.stones.render) {
                aa.append("<span class='" + Z.stones.css + "'>" + Z.stones.use + "/" + Z.stones.total + "</span>")
            }
            if (Z.gems.render) {
                aa.append("<span class='gems'>" + Z.gems.use + "</span>")
            }
            O.append(W);
            O.append(ae);
            O.append(aa);
            L.append(O);
            S = z("<div/>");
            S.addClass("buffContainer");
            W = z("<select/>");
            W.attr("id", "buffDropDown");
            if (!cm.ThronePanelController.isLastLevel(af, P)) {
                for (var ac = 0, ab = V.length; ac < ab; ++ac) {
                    if (!z.isEmptyObject(V[ac])) {
                        if (R != null || R != undefined) {
                            if (R.id == V[ac].id) {
                                W.append('<option value="' + ac + '" selected>' + V[ac].name + "</option>")
                            } else {
                                W.append('<option value="' + ac + '">' + V[ac].name + "</option>")
                            }
                        } else {
                            if (ag.id === V[ac].id) {
                                W.append('<option value="' + ac + '" selected>' + V[ac].name + "</option>")
                            } else {
                                W.append('<option value="' + ac + '">' + V[ac].name + "</option>")
                            }
                        }
                    }
                }
                W.bind("change", function (ak) {
                    u(z(this).val(), P, af)
                })
            } else {
                W.append('<option value="">--</option>');
                W.attr("disabled", "disabled")
            }
            ae = z("<div/>");
            ae.attr("id", "thronePanelBuffIcon");
            if (cm.ThronePanelController.isLastLevel(af, P)) {
                ae.addClass("icon 0")
            } else {
                ae.addClass("icon " + ag.id)
            }
            ae.html(ag.name);
            aa = z("<div/>");
            aa.attr("id", "thronePanelBuffPrice");
            aa.addClass("price");
            S.append(W);
            S.append(ae);
            S.append(aa);
            L.append(S);
            if (ag.id != 0) {
                u(W.val(), P, af)
            }
            N = z("<div/>");
            N.addClass("riskContainer");
            ai = z("<div/>");
            ai.addClass("title");
            ai.html(g_js_strings.throneRoom.risk_title);
            Q = z("<div/>");
            Q.attr("id", "thronePanelRiskBarContainer");
            Q.addClass("riskBarContainer");
            if (!cm.ThronePanelController.isLastLevel(af, P)) {
                Q.addClass("active");
                aj = z("<div/>");
                aj.attr("id", "thronePanelRiskBar");
                aj.addClass("riskBar active");
                width = cm.ThronePanelController.calcRiskBarWidth(P, af, ag.id);
                aj.css("width", width);
                Q.append(aj)
            }
            K = z("<span/>");
            K.addClass("low");
            K.html(g_js_strings.throneRoom.label_low);
            Y = z("<span/>");
            Y.addClass("high");
            Y.html(g_js_strings.throneRoom.label_high);
            N.append(ai);
            N.append(Q);
            N.append(K);
            N.append(Y);
            L.append(N);
            if (ag.id != 0) {
                if (ag.count <= 0) {
                    M = b(P, af, Z.gems.use + ag.price)
                } else {
                    M = b(P, af, Z.gems.use)
                }
            } else {
                M = b(P, af, Z.gems.use)
            }
        };
    var b = function (L, N, Q) {
            var P = cm.ThronePanelController.isLastLevel(N, L),
                K, M = z("#thronePanelItemRequirementsContainer"),
                O;
            if (L == "enhance") {
                O = g_js_strings.throneRoom.button_enhance
            } else {
                if (L == "upgrade") {
                    O = g_js_strings.throneRoom.button_upgrade
                }
            }
            if (Q == 0) {
                Q = ""
            } else {
                Q = " <span>" + Q + "</span>"
            }
            if (N.isBroken) {
                K = z("<a/>");
                K.addClass("gemButtonv2 gray");
                K.html(O + Q)
            } else {
                if (P) {
                    K = z("<a/>");
                    K.addClass("gemButtonv2 gray");
                    K.html(O + Q)
                } else {
                    K = z("<a/>");
                    K.addClass("gemButtonv2 green");
                    K.html(O + Q);
                    K.click(function () {
                        w("throneMainContainer");
                        cm.ThronePanelController.changeItem(L, N)
                    })
                }
            }
            z("#thronePanelItemRequirementsContainer .gemButtonv2").remove();
            M.append(K);
            return K
        };
    var w = function (M) {
            var L = z("<div/>").attr("id", "throneSpinnyContainer"),
                K = z("<div/>").addClass("spinny");
            if (M == "thronePanelBrokenContainer") {
                K.addClass("brokenContainer")
            }
            L.append(K);
            z("#" + M).append(L)
        };
    var n = function () {
            z("#throneSpinnyContainer").remove()
        };
    var u = function (M, W, Z) {
            var X = ["", ksoItems[20001], ksoItems[20002], ksoItems[20003], ksoItems[20004]],
                O = ["", ksoItems[20001], ksoItems[20002], ksoItems[20005], ksoItems[20006]],
                N = z("#thronePanelBuffIcon"),
                R = z("#thronePanelBuffPrice"),
                Q = z("#thronePanelRiskBarContainer"),
                K = z("#thronePanelRiskBar"),
                Y = z("#costDropDown"),
                T = [],
                S = cm.thronestats[W],
                P, V, U = Z,
                L;
            M = +(M);
            if (W === "enhance") {
                V = X[M]
            } else {
                if (W === "upgrade") {
                    V = O[M]
                }
            }
            N.attr("class", "");
            N.css("backgroundPosition", "0 0");
            if (cm.ThronePanelController.isLastLevel(Z, W)) {
                N.addClass("icon 0");
                N.unbind("hover")
            } else {
                N.addClass("icon i" + V.id);
                N.hover(function (aa) {
                    Tooltip.show(aa, ksoItems[V.id].description, [-50, -90])
                }, function (aa) {
                    Tooltip.remove()
                });
                o(N, null, "buff")
            }
            R.empty();
            if (Y.val() == 0) {
                P = cm.ThronePanelController.calcCost(W, U, V, "stones")
            } else {
                if (Y.val() == 1) {
                    P = cm.ThronePanelController.calcCost(W, U, V, "gems")
                }
            }
            if (!cm.ThronePanelController.isLastLevel(Z, W)) {
                if (V) {
                    if (V.count > 0) {
                        T.push("<span class='items'>" + ksoItems[V.id].count + "/1</span>")
                    } else {
                        T.push("<span class='items havent'>" + ksoItems[V.id].count + "/1</span>");
                        T.push("<span class='gems'>" + ksoItems[V.id].price + "</span>")
                    }
                }
            } else {
                T.push("<span class='gems'>--</span>")
            }
            R.append(T.join(""));
            if (!cm.ThronePanelController.isLastLevel(Z, W)) {
                L = cm.ThronePanelController.calcRiskBarWidth(W, U, M);
                K.css("width", L);
                K.addClass("riskBar active")
            } else {
                z("#thronePanelRiskBar").remove();
                z("#thronePanelRiskBarContainer").removeClass("active")
            }
            if (ksoItems[V.id]) {
                if (ksoItems[V.id].count > 0) {
                    b(W, Z, P.gems.use)
                } else {
                    b(W, Z, (ksoItems[V.id].price + P.gems.use))
                }
            } else {
                b(W, Z, (P.gems.use))
            }
            return false
        };
    var j = function (Q, L, N) {
            var K = z("#thronePanelCostIcon"),
                M = z("#thronePanelCostPrice"),
                P, O = 0;
            Q = +(Q);
            K.attr("class", "");
            if (Q === 0) {
                K.addClass("icon aetherstones")
            } else {
                if (Q === 1) {
                    K.addClass("icon gems")
                }
            }
            if (Q === 0) {
                P = cm.ThronePanelController.calcCost(L, N, null, "stones")
            } else {
                if (Q === 1) {
                    P = cm.ThronePanelController.calcCost(L, N, null, "gems")
                }
            }
            M.empty();
            if (P.stones.render) {
                M.append("<span class='" + P.stones.css + "'> " + P.stones.use + "/" + P.stones.total + "</span>")
            }
            if (P.gems.render) {
                M.append("<span class='gems'>" + P.gems.use + "</span>")
            }
            O = cm.ThronePanelController.calcBuffCost(L);
            b(L, N, (O + P.gems.use));
            return false
        };
    var o = function (M, K, L) {
            if (d[L]) {
                clearInterval(d[L]);
                d[L] = null
            }
            d[L] = setInterval(function () {
                var P = M.css("backgroundPosition"),
                    O, Q, N;
                O = parseInt(P.split(" ")[0], 10);
                Q = parseInt(P.split(" ")[1], 10);
                O = O - 70;
                if (O <= -6230) {
                    O = 0
                }
                N = O + "px 0px";
                z(M).css("backgroundPosition", N)
            }, 50)
        };
    var C = function (S) {
            var W, V, Q, L, P = 0,
                O = 0.5,
                K = 0,
                T = 0,
                N = 25,
                M = "",
                U = z.browser.version,
                R = +(U.split(".")[0]);
            if (z.browser.msie) {
                M = "ms";
                if (R == 8) {
                    N = 10
                }
            } else {
                if (z.browser.mozilla) {
                    M = "moz"
                } else {
                    if (z.browser.webkit) {
                        M = "webkit"
                    }
                }
            }
            W = z("<div/>").attr("id", "statusAnimContainer");
            V = z("<div/>").addClass("ray");
            Q = z("<div/>").addClass(S);
            V.append(Q);
            W.append(V);
            z("body").append(W);
            L = setInterval(function () {
                ++K;
                P += O;
                T += 0.1;
                W.attr("style", "opacity: " + T);
                V.attr("style", "-" + M + "-transform:rotate(" + P + "deg)");
                Q.attr("style", "-" + M + "-transform:rotate(-" + P + "deg)");
                if (K >= N) {
                    clearInterval(L);
                    W.animate({
                        opacity: 0
                    }, 1000, function () {
                        W.remove()
                    })
                }
            }, 50)
        };
    var e = function (U) {
            z("#contextMenu").remove();
            var S, N = h(null, U),
                K = s(U, 215),
                P = U.createPrefix().toLocaleLowerCase(),
                L = cm.thronestats.breakTime,
                M = cm.thronestats.instantCost,
                T, Q;
            if (U.brokenType == "quality") {
                T = cm.thronestats.repairCostEnhance[U.quality].Time;
                Q = cm.thronestats.repairCostEnhance[U.quality].GemCost
            } else {
                if (U.brokenType == "level") {
                    T = cm.thronestats.repairCostUpgrade[U.level].Time;
                    Q = cm.thronestats.repairCostUpgrade[U.level].GemCost
                }
            }
            J = U.id;
            S = cm.Template.renderTemplate("Throne", "brokenPanel", {
                title: g_js_strings.throneRoom.title_repairTime,
                labelTimeRemaining: g_js_strings.throneRoom.label_timeRemaining,
                labelInstantRepair: g_js_strings.throneRoom.button_instantRepair,
                labelStartRepair: g_js_strings.throneRoom.button_startRepair,
                src: K,
                quality: P,
                name: U.name,
                stats: N,
                time: timestr(T),
                cost: Q
            });
            cm.ModalManager.addMedium({
                title: g_js_strings.throneRoom.title_itemBroken,
                body: S,
                closeNow: false,
                close: function () {
                    f()
                },
                "class": "thronePanelBrokenModal",
                curtain: true,
                width: 500,
                height: 375,
                left: 140,
                top: 15
            });
            if (!z.isEmptyObject(seed.queue_throne)) {
                timeLeft = seed.queue_throne.end - unixtime();
                if (seed.queue_throne.itemId == U.id) {
                    if (timeLeft > 0) {
                        CountDown.addCountDown("thronePanelBrokenTime", timeLeft, function () {})
                    } else {
                        CountDown.addCountDown("thronePanelBrokenTime", 1, function () {})
                    }
                }
                var R = 0,
                    O = unixtime() - seed.queue_throne.start,
                    T = seed.queue_throne.end - seed.queue_throne.start,
                    V = 382;
                if (seed.queue_throne.itemId == U.id && !cm.ThronePanelView.repairIntervals) {
                    cm.ThronePanelView.repairIntervals = setInterval(function () {
                        if (seed.queue_throne.itemId == J.id) {
                            O = unixtime() - seed.queue_throne.start;
                            y(U, timeLeft, O)
                        }
                    }, 1000)
                }
            }
            E(U, T, Q)
        };
    var E = function (S, Q, N) {
            var R = z("#thronePanelBrokenActions"),
                P, L, T, M, K, O;
            P = z("<div/>");
            P.addClass("instantContainer");
            L = z("<div/>");
            L.addClass("startContainer");
            if (z.isEmptyObject(seed.queue_throne)) {
                T = z("<span/>");
                T.addClass("gems");
                T.html(N);
                K = z("<a/>");
                K.attr("id", "thronePanelBrokenInstantButton");
                K.addClass("buttonv2 h30 green");
                K.html(g_js_strings.throneRoom.button_instantRepair);
                K.hover(function () {
                    z("#thronePanelBrokenTimeBar").addClass("done")
                }, function () {
                    z("#thronePanelBrokenTimeBar").removeClass("done")
                });
                K.click(function () {
                    w("thronePanelBrokenContainer");
                    cm.ThronePanelController.instantRepair(S)
                });
                M = z("<span/>");
                M.addClass("time");
                M.html(timestr(Q));
                O = z("<a/>");
                O.attr("id", "thronePanelBrokenRepairButton");
                O.addClass("buttonv2 h30 blue");
                O.html(g_js_strings.throneRoom.button_startRepair);
                O.click(function () {
                    w("thronePanelBrokenContainer");
                    cm.ThronePanelController.standardRepair(z(this), S, Q)
                })
            } else {
                if (seed.queue_throne.itemId == S.id) {
                    K = z("<a/>");
                    K.attr("id", "thronePanelBrokenInstantButton");
                    K.addClass("buttonv2 h30 green");
                    K.html(g_js_strings.throneRoom.button_speedUp);
                    K.click(function () {
                        m(S)
                    });
                    O = z("<a/>");
                    O.attr("id", "thronePanelBrokenRepairButton");
                    O.addClass("buttonv2 h30 brown");
                    O.html(g_js_strings.commonstr.cancel);
                    O.click(function () {
                        w("thronePanelBrokenContainer");
                        cm.ThronePanelController.cancelRepair(S)
                    })
                } else {
                    K = z("<a/>");
                    K.attr("id", "thronePanelBrokenInstantButton");
                    K.addClass("buttonv2 h30 green");
                    K.html(g_js_strings.throneRoom.button_instantRepair);
                    K.hover(function () {
                        z("#thronePanelBrokenTimeBar").addClass("done")
                    }, function () {
                        z("#thronePanelBrokenTimeBar").removeClass("done")
                    });
                    K.click(function () {
                        cm.ThronePanelController.instantRepair(S)
                    });
                    O = z("<a/>");
                    O.attr("id", "thronePanelBrokenRepairButton");
                    O.addClass("buttonv2 h30 gray");
                    O.html(g_js_strings.throneRoom.button_startRepair)
                }
            }
            P.append(T).append(K);
            L.append(M).append(O);
            R.empty();
            R.append(P);
            R.append(L)
        };
    var f = function () {
            CountDown.stopCountDown("thronePanelBrokenTime")
        };
    var I = function (K) {
            n();
            z("#throneInventoryItem" + K.id).attr("class", "");
            z("#throneInventoryItem" + K.id).addClass(K.type + " " + K.faction);
            z("#throneInventoryItem" + K.id + " .broken").remove();
            if (z("#thronePanelBrokenContainer").html() != null) {
                cm.ModalManager.close()
            }
            B(D, K)
        };
    var i = function (N, P, L) {
            n();
            var R = L,
                K = 0,
                Q = 0,
                O = 382,
                M = z("#thronePanelBrokenInstantButton");
            z("#throneInventoryItem" + P.id).attr("class", "");
            z("#throneInventoryItem" + P.id).addClass(P.type + " " + P.faction);
            z("#throneInventoryItem" + P.id).append("<span class='repair'></span>");
            z("#throneInventoryItem" + P.id + " .broken").remove();
            seed.queue_throne.start = unixtime();
            seed.queue_throne.end = unixtime() + L;
            seed.queue_throne.itemId = P.id;
            CountDown.addCountDown("thronePanelBrokenTime", R, function () {});
            if (!cm.ThronePanelView.repairIntervals) {
                cm.ThronePanelView.repairIntervals = setInterval(function () {
                    Q = unixtime() - seed.queue_throne.start;
                    y(P, R, Q)
                }, 1000)
            }
            z("div.instantContainer span.gems").remove();
            M.html("Speed Up");
            M.unbind("click");
            M.click(function () {
                m(P)
            });
            z("div.startContainer span.time").remove();
            N.removeClass("blue");
            N.addClass("brown");
            N.html("Cancel Repair");
            N.unbind("click");
            N.click(function () {
                cm.ThronePanelController.cancelRepair(P)
            })
        };
    var y = function (N, P, O) {
            var Q = P,
                K = 0,
                M = 382,
                L = z("#thronePanelBrokenInstantButton");
            K = O / P;
            if (K > 1) {
                K = 1
            }
            if (seed.queue_throne.itemId == J) {
                z("#thronePanelBrokenTimeBar").css("width", (M * K + 8))
            }
            if (O >= P || z.isEmptyObject(seed.queue_throne)) {
                clearInterval(cm.ThronePanelView.repairIntervals);
                cm.ThronePanelView.repairIntervals = null;
                N.isBroken = false;
                N.brokenType = "";
                if (z("div#thronePanelBrokenContainer").html() != null) {
                    cm.log.l("TPV1");
                    Modal.hideModalAll();
                    cm.ModalManager.close();
                    cm.log.l("TPV2")
                }
                z("#throneInventoryItem" + N.id + " .repair").remove();
                B(D, N)
            }
        };
    var m = function (K) {
            modal_speedup("throne", K.id, undefined, K.name)
        };
    var F = function () {
            var K = z("#thronePanelBrokenTime"),
                L;
            if (K.html() != null) {
                L = seed.queue_throne.end - unixtime();
                CountDown.addCountDown("thronePanelBrokenTime", L, function () {})
            }
        };
    var H = function (K) {
            n();
            z("#throneInventoryItem" + K.id).attr("class", "");
            z("#throneInventoryItem" + K.id).addClass(K.type + " " + K.faction);
            z("#throneInventoryItem" + K.id + " .repair").remove();
            z("#throneInventoryItem" + K.id).append("<span class='broken'></span>");
            seed.queue_throne = {};
            clearInterval(cm.ThronePanelView.repairIntervals);
            cm.ThronePanelView.repairIntervals = null;
            CountDown.stopCountDown("thronePanelBrokenTime");
            cm.ModalManager.close();
            e(K)
        };
    var r = function () {};
    r();
    return {
        renderPanel: B,
        closePanel: G,
        panelStatus: k,
        renderBroken: e,
        repairInterval: q,
        doInterval: y,
        clickInstantRepair: I,
        clickStandardRepair: i,
        clickSpeedUp: m,
        appliedSpeedUp: F,
        clickCancelRepair: H,
        statusAnim: C,
        removeSpinny: n
    }
}(jQuery);
cm = cm || {};
cm.ThroneView = function (c) {
    var u = 1,
        f, h = {};
    var k = function (x) {
            if (x || x == null || x == undefined) {
                var w = cm.Template.renderTemplate("Throne", "mainThrone", {});
                cm.ModalManager.addLarge({
                    gem: seed.player.gems,
                    primaryTitle: g_js_strings.throneRoom.title_throneRoom,
                    primaryBody: w,
                    closeNow: true,
                    close: function () {
                        c("#contextMenu").remove();
                        cm.ThronePanelView.closePanel()
                    },
                    "class": "throneContainer",
                    curtain: true,
                    width: 702,
                    height: 900,
                    left: 27,
                    top: 5
                });
                c(".buttonv2.green.h20").click(function () {
                    modal_getgems()
                });
                c("#throneInventoryTab").click(function (B) {
                    q("inventory", this)
                });
                c("#throneStatTab").click(function (B) {
                    q("stat", this)
                });
                b();
                o(kocThroneItems);
                l();
                r();
                cm.ThronePanelView.renderPanel();
                if (!c.isEmptyObject(seed.queue_throne)) {
                    kocThroneItems[seed.queue_throne.itemId].isBroken = true;
                    var A = seed.queue_throne.end - unixtime(),
                        y = kocThroneItems[seed.queue_throne.itemId],
                        z = unixtime() - seed.queue_throne.start;
                    if (!cm.ThronePanelView.repairIntervals && A > 0) {
                        cm.ThronePanelView.repairIntervals = setInterval(function () {
                            ++z;
                            cm.ThronePanelView.doInterval(y, A, z)
                        }, 1000)
                    }
                }
                return false
            } else {
                cm.ModalManager.alert({
                    text: g_js_strings.comingsoon.comingsoon,
                    button_text: g_js_strings.commonstr.ok,
                    exe: function () {
                        cm.ModalManager.close()
                    }
                })
            }
        };
    var b = function (x) {
            var z, w = seed.throne.activeSlot,
                B = seed.throne.slotEquip[w],
                y, A;
            c("#throneItemContainer").empty();
            c.each(B, function (C, D) {
                y = kocThroneItems[D];
                A = c("<div/>");
                A.attr("id", y.type + "Container");
                A.addClass(y.faction);
                A.bind("mouseenter", {
                    item: y
                }, function (E) {
                    E.stopPropagation();
                    cm.ThroneView.hoverItem(E, this, E.data.item)
                });
                A.bind("mouseleave", {
                    item: y
                }, function (E) {
                    E.stopPropagation();
                    cm.ThroneView.unhoverItem(E, this, E.data.item)
                });
                c("#throneItemContainer").append(A)
            })
        };
    var o = function (w) {
            var y = cm.ThroneController.createItems(w),
                x = cm.ThroneController.createRows(y);
            c("#throneInventoryList").empty();
            c.each(x, function (z, A) {
                c("#throneInventoryList").append(A)
            })
        };
    var l = function () {
            var y = [],
                D = seed.throne.activeSlot,
                E = seed.throne.slotEquip[D],
                F, I, z, C, A = "odd",
                H = c("<ul/>"),
                G, B = 0,
                w = {},
                x;
            c("#throneStatDisplay").html("");
            c.each(E, function (J, K) {
                F = kocThroneItems[K];
                c.each(F.effects, function (L, M) {
                    x = +(L.split("slot")[1]);
                    if (F.quality >= x) {
                        B++;
                        I = cm.thronestats.effects[M.id];
                        z = cm.thronestats.tiers[M.id][M.tier];
                        C = +(z.base) + ((F.level * F.level + F.level) * +(z.growth) * 0.5);
                        C = Math.ceil(C);
                        if (!F.isBroken) {
                            if (!w[M.id]) {
                                w[M.id] = {}
                            }
                            if (!w[M.id].percent) {
                                w[M.id].percent = C
                            } else {
                                w[M.id].percent += C
                            }
                            w[M.id].name = I[1]
                        }
                    }
                })
            });
            B = 0;
            c.each(w, function (J, K) {
                B++;
                A = (B % 2 === 0) ? "even" : "odd";
                G = c("<li/>");
                G.addClass(A);
                G.html(K.percent + "% " + K.name);
                c("#throneStatDisplay").append(G)
            })
        };
    var r = function () {
            var x = [],
                B, A, w = 8,
                C = seed.throne.activeSlot,
                y = seed.throne.slotNum;
            for (var z = 0; z < w; ++z) {
                A = z + 1;
                B = c("<li/>");
                if (A === C) {
                    B.attr("id", "throneInventoryPreset" + A);
                    B.addClass("selected");
                    B.html(A);
                    B.bind("click", function () {
                        p(this)
                    })
                } else {
                    if (A === (y + 1)) {
                        B.attr("id", "throneInventoryPreset" + A);
                        B.addClass("buy");
                        B.html(A);
                        B.bind("click", function () {
                            m(this)
                        })
                    } else {
                        if (A <= y) {
                            B.attr("id", "throneInventoryPreset" + A);
                            B.addClass("active");
                            B.html(A);
                            B.bind("click", {
                                idx: z
                            }, function (D) {
                                var E = D.data.idx + 1;
                                cm.ThroneController.setPreset(this, E)
                            })
                        } else {
                            B.attr("id", "throneInventoryPreset" + A);
                            B.addClass("locked");
                            B.html(A)
                        }
                    }
                }
                x.push(B)
            }
            c.each(x, function (D, E) {
                c("#throneStatList").append(E)
            })
        };
    var q = function (y, A) {
            var z = c("div#throneInfoContainer ul.tabNavigation li.active"),
                x = c("#throneInfoContainer"),
                w;
            if (c(A).hasClass("active")) {
                w = "close";
                c(A).removeClass("active");
                c(A).addClass("inactive");
                x.animate({
                    left: "-=190"
                }, 500, function () {})
            } else {
                if (x.css("left").split("px")[0] < 0) {
                    w = "open";
                    x.animate({
                        left: "+=190"
                    }, 500, function () {})
                } else {
                    w = "open"
                }
            }
            if (w === "open") {
                z.removeClass("active");
                z.addClass("inactive");
                c(A).removeClass("inactive");
                c(A).addClass("active");
                switch (y) {
                case "inventory":
                    c("#throneInventoryContainer").show();
                    c("#throneStatContainer").hide();
                    break;
                case "stat":
                    c("#throneInventoryContainer").hide();
                    c("#throneStatContainer").show();
                    l();
                    break;
                default:
                    break
                }
            }
        };
    var m = function (w) {
            cm.ContextualMenuThrone.renderMenu(w, null)
        };
    var v = function (A) {
            var B = c("#throneStatList li"),
                y = +(c(A).html()),
                x = y - 1,
                w = y,
                z;
            z = c(B[x]);
            z.removeClass("buy");
            z.addClass("active");
            z.unbind("click");
            z.bind("click", function () {
                var C = y;
                cm.ThroneController.setPreset(this, C)
            });
            z = c(B[w]);
            z.removeClass("locked");
            z.addClass("buy");
            z.unbind("click");
            z.bind("click", function () {
                m(this)
            });
            seed.throne.slotNum = +(seed.throne.slotNum) + 1;
            seed.throne.slotEquip[x + 1] = []
        };
    var p = function (A) {
            var z = c(A),
                y = c("#throneStatList .selected"),
                x = +(c(A).html()),
                B = seed.throne.slotEquip[x],
                w;
            y.removeClass("selected");
            y.addClass("active");
            z.removeClass("active");
            z.addClass("selected");
            seed.throne.activeSlot = x;
            c.each(kocThroneItems, function (C, D) {
                w = c.inArray(D.id, B) > -1;
                if (w) {
                    D.isEquipped = true
                } else {
                    D.isEquipped = false
                }
            });
            cm.ThroneView.equipTimer();
            b();
            l();
            o(kocThroneItems)
        };
    var a = function (w) {
            cm.ContextualMenuThrone.renderMenu(w, null)
        };
    var t = function (w) {
            seed.throne.rowNum = +(seed.throne.rowNum) + 1;
            o(kocThroneItems)
        };
    var j = function (y) {
            s();
            var w = +(seed.throne.activeSlot),
                A = seed.throne.slotEquip[w],
                x = [],
                z = cm.ThroneController.checkType(y);
            if (c.isEmptyObject(z)) {
                kocThroneItems[y.id].isEquipped = true;
                c("#throneInventoryItem" + y.id).addClass("equip");
                A.push(y.id);
                seed.throne.slotEquip[w] = A;
                c("#throneInventoryItem" + y.id).unbind("click");
                c("#throneInventoryItem" + y.id).bind("click", function () {
                    cm.ContextualMenuThrone.renderMenu(this, y)
                })
            } else {
                z.item2.isEquipped = false;
                c("#throneInventoryItem" + z.item2.id).removeClass("equip");
                seed.throne.slotEquip[w] = A.splice(z.idx, 1);
                c("#throneInventoryItem" + z.item2.id).unbind("click");
                c("#throneInventoryItem" + z.item2.id).bind("click", function () {
                    cm.ContextualMenuThrone.renderMenu(this, z.item2)
                });
                kocThroneItems[z.item1.id].isEquipped = true;
                c("#throneInventoryItem" + z.item1.id).addClass("equip");
                A.push(z.item1.id);
                seed.throne.slotEquip[w] = A;
                c("#throneInventoryItem" + z.item1.id).unbind("click");
                c("#throneInventoryItem" + z.item1.id).bind("click", function () {
                    cm.ContextualMenuThrone.renderMenu(this, z.item1)
                })
            }
            b();
            l()
        };
    var d = function (y) {
            var w = +(seed.throne.activeSlot),
                z = seed.throne.slotEquip[w],
                x = [];
            c("#throneInventoryItem" + y.id).removeClass("equip");
            c("#throneInventoryItem" + y.id).unbind("click");
            c("#throneInventoryItem" + y.id).bind("click", function () {
                cm.ContextualMenuThrone.renderMenu(this, y)
            });
            s();
            y.isEquipped = false;
            c.each(z, function (A, B) {
                if (B !== y.id) {
                    x.push(B)
                }
            });
            seed.throne.slotEquip[w] = x;
            b();
            l()
        };
    var i = function (z, A, y) {
            z.stopPropagation();
            var w = e(y),
                C = [0, 30],
                x, B = c(A).attr("id");
            if (B.indexOf("throne") > -1) {
                x = "icon"
            } else {
                x = "item"
            }
            if (y.type == "advisor" && x == "item") {
                C = [-300, 250]
            }
            Tooltip.show(z, w, C);
            if (y.isEquipped) {
                c("#" + y.type + "Container").addClass("hover")
            }
        };
    var g = function (x, y, w) {
            if (w.isEquipped) {
                c("#" + w.type + "Container").removeClass("hover")
            }
        };
    var e = function (G) {
            var B = [],
                J, H, E, D, y, x, w, I, C = +(seed.throne.activeSlot),
                F = seed.throne.slotEquip[C],
                A, z;
            if (!G.isEquipped) {
                c.each(F, function (K, L) {
                    A = kocThroneItems[L];
                    if (G.type === A.type) {
                        A = A;
                        return false
                    } else {
                        A = null
                    }
                })
            }
            B.push(" <div id='throneInventoryItemTooltip'> ");
            B.push("<div class='section'>");
            B.push(" <div class='title " + G.createPrefix().toLowerCase() + "' style='text-transform: capitalize;'> ");
            B.push(G.name);
            B.push(" </div> ");
            B.push(" <ul> ");
            c.each(G.effects, function (K, L) {
                effect = cm.thronestats.effects[L.id];
                tier = cm.thronestats.tiers[L.id][L.tier];
                percent = +(tier.base + ((G.level * G.level + G.level) * tier.growth * 0.5));
                percent = (percent > 0) ? "+" + percent : +percent;
                percent = Math.ceil(percent);
                css = (K % 2 === 0) ? "even" : "odd";
                z = +(K.split("slot")[1]);
                if (z <= G.quality) {
                    B.push(" <li class='effect " + css + "'> " + percent + "% " + effect[1] + " </li> ")
                } else {
                    B.push(" <li class='effect disabled " + css + "'> " + percent + "% " + effect[1] + " </li> ")
                }
            });
            B.push(" </ul> ");
            B.push(" <div class='description'> ");
            B.push(" <div class='" + G.faction + " " + G.type + "'> </div> ");
            B.push(" <p>" + G.description + "</p> ");
            B.push(" </div> ");
            B.push(" </div> ");
            if (A) {
                B.push("<div class='section'>");
                B.push(" <div class='title equip " + A.createPrefix().toLowerCase() + "' style='text-transform: capitalize;'> ");
                B.push(A.name);
                B.push(" </div> ");
                B.push(" <ul> ");
                c.each(A.effects, function (K, L) {
                    effect = cm.thronestats.effects[L.id];
                    tier = cm.thronestats.tiers[L.id][L.tier];
                    percent = tier.base + (A.level * tier.growth);
                    percent = (percent > 0) ? "+" + percent : +percent;
                    percent = Math.ceil(percent);
                    css = (K % 2 === 0) ? "even" : "odd";
                    z = +(K.split("slot")[1]);
                    if (z <= A.quality) {
                        B.push(" <li class='effect " + css + "'> " + percent + "% " + effect[1] + " </li> ")
                    } else {
                        B.push(" <li class='effect disabled " + css + "'> " + percent + "% " + effect[1] + " </li> ")
                    }
                });
                B.push(" </ul> ");
                B.push(" <div class='description'> ");
                B.push(" <div class='" + A.faction + " " + A.type + "'> </div> ");
                B.push(" <p>" + A.description + "</p> ");
                B.push(" </div> ");
                B.push(" </div> ")
            }
            B.push(" </div> ");
            return B.join("")
        };
    var s = function () {
            var w = 5;
            c("#throneInfoContent").append("<div id='shitbox'></div>");
            c("#shitbox").html("Time left is " + w);
            var x = setInterval(function () {
                w--;
                c("#shitbox").html("Time left is " + w);
                if (w === 0) {
                    clearInterval(x);
                    c("#shitbox").remove()
                }
            }, 1000)
        };
    var n = function () {};
    n();
    return {
        openThrone: k,
        renderInventory: o,
        renderThrone: b,
        renderItemTooltip: e,
        renderStats: l,
        hoverItem: i,
        unhoverItem: g,
        clickItemEquip: j,
        clickItemUnequip: d,
        clickBuyRow: a,
        equipTimer: s,
        clickActivePreset: p,
        buyPreset: v,
        buyRow: t
    }
}(jQuery);
cm = cm || {};
cm.Tooltip = (function (a) {
    var c = function (d) {
            if (d.data.proxyElement) {
                showTooltip(d.data.tooltip, d.data.proxyElement, d.originalEvent, "mainbody")
            } else {
                showTooltip(d.data.tooltip, d.target, d.originalEvent, "mainbody")
            }
            d.stopPropagation()
        };
    var b = function (d) {
            removeTooltip();
            d.stopPropagation()
        };
    return {
        setTooltip: function (e) {
            var d = a(e.htmlElement);
            delete e.htmlElement;
            d.mouseenter(e, c);
            d.mouseout(b)
        }
    }
})(jQuery);

function showTooltip(d, o, j, u) {
    Event.extend(j);
    var i = j.pointerX();
    var h = j.pointerY();
    removeTooltip();
    var s = o;
    Element.extend(s);
    var c = document.createElement("div");
    Element.extend(c);
    var p = s.hasClassName("slot");
    var n = $(u);
    var k = s.cumulativeOffset()[0];
    var g = s.cumulativeOffset()[1] - n.cumulativeOffset()[1];
    var e = s.getWidth();
    var f = s.getHeight();
    c.id = "tooltip";
    c.className = (p) ? "maptooltip" : "tooltip";
    var r = new Array();
    r.push("<div class='box'>");
    r.push(unescape(d));
    r.push("</div>");
    c.innerHTML = r.join("");
    n.appendChild(c);
    var l = c.getHeight();
    var q = c.getWidth();
    var t = k + e;
    var b = g + 20;
    var a = n.getWidth() - q;
    var m = n.getHeight() + n.positionedOffset()[1] - l;
    if (t > a) {
        t = Math.max(0, k - q)
    }
    if (b > m) {
        b = Math.max(0, g - l)
    }
    if (b < 0) {
        b = 60
    }
    t = t + "px";
    b = b + "px";
    c.style.top = b;
    c.style.left = t;
    c.style.position = "absolute"
}

function removeTooltip() {
    if ($("tooltip")) {
        $("tooltip").remove()
    }
}
var Tooltip = {
    tooltipDiv: "kofcNewTooltipDiv",
    cssStyles: {
        padding: "5px",
        backgroundColor: "#d5a461",
        border: "2px solid #a56631",
        fontFamily: 'lucida grande",tahoma,verdana,arial,sans-serif',
        fontSize: "11px",
        color: "#000",
        zIndex: 200000,
        position: "absolute",
        top: "0px",
        left: "0px"
    },
    resetCSS: function (a) {
        $(a).setStyle(this.cssStyles)
    },
    show: function (g, n, b, l) {
        var j = 0;
        var h = 0;
        var m;
        var f = Event.element(g);
        var k = 10;
        var d = 10;
        if ($(this.tooltipDiv)) {
            m = $(this.tooltipDiv)
        } else {
            var i = document.createElement("div");
            i.id = this.tooltipDiv;
            $$("body")[0].insert(i);
            m = $(this.tooltipDiv);
            this.resetCSS(m)
        }
        if (l) {
            m.setStyle(l);
            var c = this;
            f.observe("mouseout", function () {
                c.resetCSS(m)
            })
        }
        f.observe("mouseout", this.hide.bind(this));
        var a = f.viewportOffset();
        if (b) {
            k = b[0];
            d = b[1]
        }
        j = a[0] + f.getWidth() + k;
        h = a[1] - d;
        m.setStyle({
            top: h + "px",
            left: j + "px"
        });
        m.update(n);
        m.style.display = "block"
    },
    hide: function () {
        $(this.tooltipDiv).style.display = "none"
    }
};

function modal_tournaments() {
    var a = new Array();
    a.push("<div class='modal_tourny_container'>");
    a.push("<div id='modal_tourny_body' class='tournywrap' name='1'><div class='modal_tourny_hd'>&nbsp;</div>");
    a.push("<div class='tabsbar clearfix' id='modal_tourny_tabs'>");
    a.push("<a  id='modal_tourny_tab1' onclick='modal_tourny_changetab(1);return false;' class='tab selected'><span>" + g_js_strings.commonstr.tournament + "</span></a>");
    a.push("<a  id='modal_tourny_tab2' onclick='modal_tourny_changetab(2);return false;' class='tab'><span>" + g_js_strings.commonstr.previous + " 1</span></a>");
    a.push("<a  id='modal_tourny_tab3' onclick='modal_tourny_changetab(3);return false;' class='tab'><span>" + g_js_strings.commonstr.previous + " 2</span></a>");
    a.push("<a  id='modal_tourny_tab4' onclick='modal_tourny_changetab(4);return false;' class='tab'><span>" + g_js_strings.commonstr.previous + " 3</span></a>");
    a.push("<a  id='modal_tourny_tab5' onclick='modal_tourny_changetab(5);return false;' class='tab'><span>" + g_js_strings.commonstr.previous + " 4</span></a>");
    a.push("</div>");
    a.push("<div id='modal_tourny_content'></div>");
    a.push("</div>");
    a.push("</div>");
    Modal.showModal(740, 740, 10, 10, g_js_strings.modaltitles.tournaments, a.join(""), "");
    modal_tourny_changetab(1)
}

function modal_tourny_changetab(newtab) {
    var oldtab = $("modal_tourny_body").getAttribute("name");
    $("modal_tourny_tabs").select(".selected")[0].removeClassName("selected");
    $("modal_tourny_tab" + newtab).addClassName("selected");
    $("modal_tourny_body").setAttribute("name", newtab);
    var params = Object.clone(g_ajaxparams);
    params.format = 2;
    params.tournyPos = parseInt(newtab) - 1;
    new Ajax.Request(g_ajaxpath + "ajax/getLeaderboard.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (!rslt.data) {
                    $("modal_tourny_content").innerHTML = "<div class='tourny_modal_upsell'>" + g_js_strings.modal_tourny_changetab.notourny + "</div><div class='closebtn clearfix'><a  onclick='Modal.hideModal();return false;' class='button20'><span>" + g_js_strings.commonstr.close + "</span></a></div>"
                } else {
                    var tournyhtml = new Array();
                    if (rslt.name) {
                        tournyhtml.push("<div class='tournymodaltitle'>" + rslt.name + "</div>")
                    } else {
                        tournyhtml.push("<div class='tournymodaltitle'>" + g_js_strings.commonstr.tournament + "</div>")
                    }
                    if (rslt.description) {
                        tournyhtml.push("<div class='tournymodaldesc'>" + rslt.description + "</div>")
                    }
                    tournyhtml.push("<div class='tournylistwrap'>");
                    tournyhtml.push("<table class='tourny_list_table' cellpadding='0' cellspacing='0' border='0'>");
                    tournyhtml.push("<thead>");
                    tournyhtml.push("<tr>");
                    if (rslt.type == 24) {
                        tournyhtml.push("<td class='rankcol'>");
                        tournyhtml.push("<div>" + g_js_strings.commonstr.ranking + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td>");
                        tournyhtml.push("<div>" + g_js_strings.modal_tourny_changetab.chancellorname + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td>");
                        tournyhtml.push("<div>" + g_js_strings.commonstr.alliance + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td>");
                        tournyhtml.push("<div>" + g_js_strings.modal_tourny_changetab.mightgained + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td>");
                        tournyhtml.push("<div>" + g_js_strings.modal_tourny_changetab.rewardperplayer + "</div>");
                        tournyhtml.push("</td>")
                    } else {
                        tournyhtml.push("<td class='rankcol'>");
                        tournyhtml.push("<div>" + g_js_strings.commonstr.ranking + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td>");
                        tournyhtml.push("<div>" + g_js_strings.modal_tourny_changetab.lordladyname + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td>");
                        tournyhtml.push("<div>" + g_js_strings.commonstr.alliance + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td>");
                        tournyhtml.push("<div>" + rslt.contestcategory + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td>");
                        tournyhtml.push("<div>" + g_js_strings.commonstr.reward + "</div>");
                        tournyhtml.push("</td>")
                    }
                    tournyhtml.push("</tr>");
                    tournyhtml.push("</thead>");
                    tournyhtml.push("</tbody>");
                    for (var i = 0; i < rslt.data.length; i++) {
                        var row = rslt.data[i];
                        var rewardString = row.itemCount + " ";
                        if (row.itemType == 0) {
                            rewardString += g_js_strings.commonstr.gems
                        } else {
                            rewardString += itemlist["i" + row.itemType].name
                        }
                        if (i % 2 == 1) {
                            tournyhtml.push("<tr>")
                        } else {
                            tournyhtml.push("<tr class='stripe'>")
                        }
                        tournyhtml.push("<td class='rankcol'>");
                        tournyhtml.push("<div>" + row.ranking + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td>");
                        tournyhtml.push("<div>" + row.name + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td>");
                        tournyhtml.push("<div>" + (row.alliance || "----") + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td>");
                        tournyhtml.push("<div>" + row.contestValue + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("<td>");
                        tournyhtml.push("<div>" + rewardString + "</div>");
                        tournyhtml.push("</td>");
                        tournyhtml.push("</tr>")
                    }
                    tournyhtml.push("</tbody>");
                    tournyhtml.push("</table>");
                    tournyhtml.push("</div>");
                    if (rslt.startdate && rslt.enddate) {
                        var startTime = rslt.startdate;
                        var endTime = rslt.enddate;
                        var now = parseInt(new Date().getTime() / 1000);
                        tournyhtml.push("<div class='timebar'>");
                        tournyhtml.push("<div class='elapsedtime' style='width:");
                        if (endTime <= now) {
                            tournyhtml.push("500px;'")
                        } else {
                            var perc = parseInt(((now - startTime) / (endTime - startTime)) * 100) * 5;
                            tournyhtml.push(perc + "px;'")
                        }
                        tournyhtml.push(">");
                        tournyhtml.push("</div>");
                        tournyhtml.push("</div>");
                        tournyhtml.push("<div class='datefooter clearfix'>");
                        tournyhtml.push("<div class='startdate'>");
                        tournyhtml.push("Start: " + new Date(startTime * 1000).toGMTString());
                        tournyhtml.push("</div>");
                        tournyhtml.push("<div class='enddate'>");
                        tournyhtml.push("End: " + new Date(endTime * 1000).toGMTString());
                        tournyhtml.push("</div>");
                        tournyhtml.push("</div>");
                        tournyhtml.push("<div class='closebtn clearfix'><a  onclick='Modal.hideModal();return false;' class='button20'><span>" + g_js_strings.commonstr.close + "</span></a></div>")
                    }
                    $("modal_tourny_content").innerHTML = tournyhtml.join("")
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
};
cm.TownCrierCaravan = function (d, e) {
    var c = this;
    var b = e;
    b.className = d.getCount() > 0 ? "crier" : "crier noMessage";
    var a = function () {
            b.className = d.getCount() > 0 ? "crier" : "crier noMessage"
        };
    this.getHtmlElement = function () {
        return b
    };
    d.addEventListener(cm.CollectionEvent.ELEMENT_ADDED, a);
    d.addEventListener(cm.CollectionEvent.ELEMENT_REMOVED, a)
};
cm.TownCrierCaravanController = function (d, c) {
    var f = function () {
            if (d.getCount() > 0) {
                var h = new cm.TownCrierMessageDialog(d);
                h.show();
                var i = new cm.TownCrierFooterNav(d);
                var g = new cm.FooterNavController(d, i, h);
                h.setFooter(i.getHtmlElement())
            } else {
                Modal.showAlert(g_js_strings.towncrier.noannouncements)
            }
        };
    var e = function (g) {
            f();
            cm.TagModel.bind()
        };
    var b = function (h) {
            var g = h.srcElement || h.target;
            showTooltip(g_js_strings.towncrier.annoucementcaravan, g, h, "mod_maparea")
        };
    var a = function (g) {
            removeTooltip()
        };
    this.onLoad = function () {
        f()
    };
    Event.observe(c.getHtmlElement(), "click", e);
    Event.observe(c.getHtmlElement(), "mouseover", b);
    Event.observe(c.getHtmlElement(), "mouseout", a)
};
var cm = cm || {};
cm.TownCrierMessageEvent = function (a) {
    cm.CustomEvent.call(this, a)
};
cm.OOP.inherits(cm.TownCrierMessageEvent, cm.CustomEvent);
cm.TownCrierMessageEvent.READ = "read";
var cm = cm || {};
cm.TownCrierFooterNav = function (h, f) {
    var a;
    var b = [];
    var e;
    var i;
    var c = function (l) {
            var k = l.getTarget();
            var j = h.getElementPosition(k);
            b[j].className = "navItem read"
        };
    var g = function (m) {
            var l = m.getTarget();
            var n = l.previousPosition;
            b[n].className = "navItem read";
            var k = h.getElementAtCurrentPosition();
            var j = l.currentPosition;
            b[j].className = "navItem current" + (k.isRead() ? " read" : "")
        };
    this.getHtmlElement = function () {
        return a
    };
    this.getPrevButton = function () {
        return e
    };
    this.getNextButton = function () {
        return i
    };
    this.getElements = function () {
        return b
    };
    var d = function () {
            a = document.createElement("div");
            a.className = "navContainer";
            e = document.createElement("a");
            e.className = "navButton";
            e.innerHTML = '<img src="img/crier/button_arrow_left.png" />';
            a.appendChild(e);
            var m, n;
            var j = h.getCount();
            var k = h.getCurrentPosition();
            for (m = 0; m < j; m++) {
                n = h.getElementAtPosition(m);
                n.addEventListener(cm.TownCrierMessageEvent.READ, c);
                var l = document.createElement("a");
                l.className = n.isRead() ? "navItem read" : "navItem";
                l.className += m == k ? " current" : "";
                l.innerHTML = m + 1;
                a.appendChild(l);
                b.push(l)
            }
            i = document.createElement("a");
            i.className = "navButton";
            i.innerHTML = '<img src="img/crier/button_arrow_right.png" />';
            a.appendChild(i);
            h.addEventListener(cm.CollectionEvent.POSITION_CHANGED, g)
        };
    d()
};
cm.FooterNavController = function (i, c, k) {
    var h;
    var j;
    var b;
    var g = function (l) {
            if (i.hasPrevious()) {
                i.previous()
            }
        };
    var a = function (l) {
            if (i.hasNext()) {
                i.next()
            }
        };
    var d = function (n) {
            var m = n.srcElement ? n.srcElement : n.target;
            var l = parseInt(m.innerHTML) - 1;
            if (!isNaN(l)) {
                i.jumpTo(l);
                cm.TagModel.bind()
            }
        };
    var f = function () {
            Event.stopObserving(h, "click", g);
            Event.stopObserving(j, "click", a);
            var m, l;
            for (m = 0; m < b.length; m++) {
                l = b[m];
                Event.stopObserving(l, "click", d)
            }
            k.removeEventListener(cm.DialogEvent.CLOSE, f)
        };
    var e = function () {
            k.addEventListener(cm.DialogEvent.CLOSE, f);
            h = c.getPrevButton();
            Event.observe(h, "click", g);
            j = c.getNextButton();
            Event.observe(j, "click", a);
            b = c.getElements();
            var m, l;
            for (m = 0; m < b.length; m++) {
                l = b[m];
                Event.observe(l, "click", d)
            }
        };
    e()
};
var cm = cm || {};
cm.TownCrierFetcherEvent = function (a) {
    cm.CustomEvent.call(this, a)
};
cm.OOP.inherits(cm.TownCrierFetcherEvent, cm.CustomEvent);
cm.TownCrierFetcherEvent.READY = "ready";
cm.TownCrierFetcher = new function () {
    var c = new cm.CustomEventDispatcher();
    var b;
    var d = function (f, e) {
            var h = new Date((f.start <= 0 ? f.created : f.start) * 1000);
            var g = new Date((e.start <= 0 ? e.created : e.start) * 1000);
            return g.getTime() - h.getTime()
        };
    var a = function (m) {
            b.removeEventListener(cm.ServiceEvent.SUCCESS, a);
            var j = m.getResponse().responseText.evalJSON();
            if (j) {
                var n = j && j.length ? j.length : 0;
                var k, l, g;
                var f = new cm.BaseCollection();
                for (k = 0; k < n; k++) {
                    l = j[k];
                    g = new cm.GemGiftingModel(l);
                    f.add(g)
                }
                var o = new cm.GemGiftingNotificationView(f);
                var h = new cm.GemGiftingNotificationController(f, o);
                cm.NotificationDialogManager.popup(o)
            }
        };
    this.fetchAnnoucements = function () {
        b = new cm.GemGiftingNotificationService();
        b.addEventListener(cm.ServiceEvent.SUCCESS, a);
        b.getNotifications();
        var f = Object.clone(g_ajaxparams);
        var e = new Ajax.Request(g_ajaxpath + "ajax/getMotd.php" + g_ajaxsuffix, {
            method: "post",
            parameters: f,
            onSuccess: function (m) {
                var j = m.responseText.evalJSON();
                j.sort(d);
                var l = new cm.BaseCollection();
                var k = new cm.TownCrierNotificationCollectionController(l);
                var u = new cm.BaseCollection();
                var s = null;
                for (var r = 0; r < j.length; r++) {
                    var h = j[r];
                    var n = cm.TownCrierMessage.COOKIE_PREFIX + "_" + user_id + "_" + h.id;
                    var q = cm.ClientSideCookieManager.getCookie(n);
                    h.read = q == "true";
                    var v = new cm.TownCrierMessage(h);
                    u.add(v);
                    if (!v.isRead()) {
                        l.add(v);
                        if (!s) {
                            s = v;
                            var t = new cm.TownCrierNotificationDialog(s, l);
                            var g = new cm.TownCrierNotificationDialogController(s, u, t);
                            cm.NotificationDialogManager.popup(t)
                        }
                    }
                }
                var p = new cm.TownCrierCaravan(l, document.getElementById("townCrier"));
                cm.caravanController = new cm.TownCrierCaravanController(u, p);
                var o = new cm.CustomEvent(cm.TownCrierFetcherEvent.READY);
                c.dispatchCustomEvent(o)
            }
        })
    };
    this.addEventListener = function (e, f) {
        c.addEventListener(e, f)
    }
}();
cm.TownCrierMessageDialog = function (p) {
    cm.BaseDialog.call(this);
    var h = this;
    var g;
    var r;
    var j;
    var k;
    var n;
    var c;
    var o;
    var m;
    var a = function (t) {
            var s = t.getTarget();
            if (s == o && s.isRead()) {
                j.className = "marker read"
            }
        };
    var q = function () {
            j.className = o.isRead() ? "marker read" : "marker";
            k.innerHTML = o.getDate();
            n.innerHTML = o.getTitle();
            c.innerHTML = cm.TagModel.markUp(o.getBodyHTML())
        };
    var e = function (s) {
            o.setRead(true);
            o.removeEventListener(cm.TownCrierMessageEvent.READ, a);
            o = p.getElementAtCurrentPosition();
            o.addEventListener(cm.TownCrierMessageEvent.READ, a);
            q()
        };
    var b = function () {
            Modal.hideModal();
            o.setRead(true);
            o.removeEventListener(cm.TownCrierMessageEvent.READ, a);
            h.close()
        };
    var l = function (s) {
            b()
        };
    var f = function () {
            g = h.getHtmlElement();
            o = p.getElementAtCurrentPosition();
            o.addEventListener(cm.TownCrierMessageEvent.READ, a);
            p.addEventListener(cm.CollectionEvent.POSITION_CHANGED, e);
            g.className = "dialogContainer";
            var x = document.createElement("div");
            x.className = $("crossPromoBarContainer") ? "notificationMessageDialog xPromo" : "notificationMessageDialog";
            g.appendChild(x);
            var s = document.createElement("div");
            s.className = "messageHeader";
            x.appendChild(s);
            var w = document.createElement("div");
            w.className = "headerTop";
            s.appendChild(w);
            j = document.createElement("div");
            j.className = "marker read";
            j.innerHTML = '<img src="img/crier/new_icon.png" />';
            w.appendChild(j);
            var t = document.createElement("div");
            t.className = "topRow";
            w.appendChild(t);
            var u = document.createElement("a");
            u.href = "javascript:void(0)";
            u.className = "closeButton";
            t.appendChild(u);
            k = document.createElement("div");
            k.className = "date";
            t.appendChild(k);
            n = document.createElement("div");
            n.className = "titleRow";
            w.appendChild(n);
            var v = document.createElement("div");
            v.className = "headerBottom";
            s.appendChild(v);
            var y = document.createElement("div");
            y.className = "messageBody";
            x.appendChild(y);
            c = document.createElement("div");
            c.className = "content";
            y.appendChild(c);
            r = document.createElement("div");
            r.className = "messageFooter";
            x.appendChild(r);
            q();
            Event.observe(u, "click", l)
        };
    var d = this.show;
    var i = function () {
            h.close()
        };
    this.show = function () {
        Modal.onCloseCallback = i;
        Modal.showModal(201, 101, 400, 300, "", "");
        $("modalControlsClose" + Modal.modalid).hide();
        d()
    };
    this.setFooter = function (s) {
        r.appendChild(s)
    };
    f()
};
cm.OOP.inherits(cm.TownCrierMessageDialog, cm.BaseDialog);
var cm = cm || {};
cm.TownCrierMessage = function (a) {
    cm.CustomEventDispatcher.call(this);
    var f = this;
    var g = false;
    var h = null;
    var c = null;
    var i = null;
    var e = null;
    var b = null;
    this.getId = function () {
        return e
    };
    this.getKey = function () {
        return e.toString()
    };
    this.getTitle = function () {
        return h
    };
    this.getBodyHTML = function () {
        return c
    };
    this.getDate = function () {
        return i
    };
    this.isRead = function () {
        return g
    };
    this.setRead = function (m) {
        if (g != m) {
            g = m;
            var k = new Date();
            k.setTime(k.getTime() + (7 * 24 * 60 * 60 * 1000));
            var j = cm.TownCrierMessage.COOKIE_PREFIX + "_" + user_id + "_" + e;
            cm.ClientSideCookieManager.setCookie(j, (g ? "true" : "false"), k);
            var l = new cm.TownCrierMessageEvent(cm.TownCrierMessageEvent.READ);
            l.setTarget(f);
            f.dispatchCustomEvent(l)
        }
    };
    this.getReadCSSClass = function () {
        return g ? " read" : ""
    };
    var d = function () {
            g = a.read;
            h = a.title;
            c = a.bodyHTML;
            i = a.date;
            e = a.id;
            b = a.expires
        };
    d()
};
cm.OOP.inherits(cm.TownCrierMessage, cm.CustomEventDispatcher);
cm.TownCrierMessage.COOKIE_PREFIX = "announcementRead";
cm.TownCrierMessageManagerClass = function () {
    cm.CustomEventDispatcher.call(this);
    var d = this;
    var e = [];
    var a = 0;
    var c = 0;
    this.add = function (f) {
        e.push(f)
    };
    var b = function () {
            var f = new cm.TownCrierMessageManagerEvent(cm.TownCrierMessageManagerEvent.INDEX_CHANGE);
            f.setTarget(d);
            d.dispatchCustomEvent(f)
        };
    this.gotoPrev = function () {
        if (c > 0) {
            a = c;
            c--;
            b()
        }
    };
    this.gotoNext = function () {
        if (c < e.length - 1) {
            a = c;
            c++;
            b()
        }
    };
    this.gotoMessage = function (f) {
        if (f >= 0 && f < e.length && c != f) {
            a = c;
            c = f;
            b()
        }
    };
    this.findMessageIndex = function (h) {
        var f, g;
        for (f = 0; f < e.length; f++) {
            g = e[f];
            if (h.getId() == g.getId()) {
                return f
            }
        }
        return -1
    };
    this.getCurrentMessage = function () {
        return e[c]
    };
    this.getMessages = function () {
        return e
    };
    this.getCurrentIndex = function () {
        return c
    };
    this.getLastMessage = function () {
        return e[a]
    };
    this.getLastIndex = function () {
        return a
    };
    this.getMessageCount = function () {
        return e.length
    }
};
cm.TownCrierMessageManagerClass.prototype = new cm.CustomEventDispatcher();
cm.TownCrierMessageManagerClass.prototype.constructor = cm.TownCrierMessageManagerClass;
cm.TownCrierMessageManager = new cm.TownCrierMessageManagerClass();
cm.TownCrierNotificationCollectionController = function (b) {
    var d = this;
    var c = function (h) {
            var g = h.getTarget();
            g.removeEventListener(cm.TownCrierMessageEvent.READ, f)
        };
    var a = function (h) {
            var g = h.getTarget();
            g.addEventListener(cm.TownCrierMessageEvent.READ, f)
        };
    var f = function (h) {
            var g = h.getTarget();
            b.remove(g)
        };
    var e = function () {
            b.addEventListener(cm.CollectionEvent.ELEMENT_ADDED, a);
            b.addEventListener(cm.CollectionEvent.ELEMENT_REMOVED, c)
        };
    e()
};
var cm = cm || {};
cm.TownCrierNotificationDialog = function (l, b) {
    cm.BaseDialog.call(this);
    var j = this;
    var c = this.getHtmlElement();
    var k = l;
    var d = null;
    var g = null;
    var m = function () {
            var n = 1;
            var o = b.getCount();
            d.innerHTML = n + " / " + o
        };
    this.getLink = function () {
        return g
    };
    var f = function (n) {
            if (b.getCount() > 0) {
                m()
            } else {
                j.close()
            }
        };
    var a;
    var i = function (n) {
            a()
        };
    var e = function (n) {
            a()
        };
    a = function () {
        k.removeEventListener(cm.TownCrierMessageEvent.READ, e);
        j.close()
    };
    var h = function () {
            k.addEventListener(cm.TownCrierMessageEvent.READ, e);
            c.className = "announcementContainer";
            var p = document.createElement("div");
            p.className = "notificationDialog";
            c.appendChild(p);
            var q = document.createElement("div");
            q.className = "titleBar";
            p.appendChild(q);
            var o = document.createElement("a");
            o.className = "closeButton";
            q.appendChild(o);
            d = document.createElement("div");
            d.className = "count";
            q.appendChild(d);
            var n = document.createElement("div");
            n.className = "dialogTitle";
            n.innerHTML = g_js_strings.towncrier.newannoucement;
            q.appendChild(n);
            var r = document.createElement("div");
            r.className = "dialogBody";
            p.appendChild(r);
            g = document.createElement("a");
            g.href = "javascript:void(0)";
            var s = k.getTitle();
            g.innerHTML = cm.StringFormatter.ellipsis(s, 34);
            g.setAttribute("title", s);
            r.appendChild(g);
            m();
            b.addEventListener(cm.CollectionEvent.ELEMENT_ADDED, f);
            b.addEventListener(cm.CollectionEvent.ELEMENT_REMOVED, f);
            Event.observe(o, "click", i)
        };
    h()
};
cm.OOP.inherits(cm.TownCrierNotificationDialog, cm.BaseDialog);
cm.TownCrierNotificationDialog.prototype.getPriority = function () {
    return 1
};
cm.TownCrierNotificationDialogController = function (e, d, a) {
    var c = a.getLink();
    var g = a;
    var h = function (l) {
            var j = d.getElementPosition(e);
            d.jumpTo(e.position);
            var k = new cm.TownCrierMessageDialog(d);
            k.show();
            var m = new cm.TownCrierFooterNav(d);
            var i = new cm.FooterNavController(d, m, k);
            k.setFooter(m.getHtmlElement())
        };
    var b = function (i) {
            g.removeEventListener(cm.DialogEvent.CLOSE, b);
            Event.stopObserving(c, "click", h)
        };
    var f = function () {
            g.addEventListener(cm.DialogEvent.CLOSE, b);
            Event.observe(c, "click", h)
        };
    f()
};
cm.TownCrierNotificationManagerClass = function () {
    cm.CustomEventDispatcher.call(this);
    var c = this;
    var e = [];
    var g = 0;
    var f = {};
    var d = function (m) {
            var k = m.getMessage();
            var l = cm.TownCrierMessageManager.findMessageIndex(k);
            cm.TownCrierMessageManager.gotoMessage(l);
            var j = new cm.TownCrierMessageDialog(cm.TownCrierMessageManager);
            var n = new cm.TownCrierFooterNav(cm.TownCrierMessageManager);
            var i = new cm.FooterNavController(cm.TownCrierMessageManager, n);
            j.setFooter(n.getHtmlElement());
            j.show()
        };
    var a = function () {
            var i = new cm.TownCrierNotificationDialog(c);
            i.addEventListener(cm.TownCrierDialogEvent.OK, d);
            i.show()
        };
    var b = function (j) {
            var i = j.getMessage();
            if (i.isRead()) {
                if (g < e.length) {
                    a()
                }
            } else {
                if (g < e.length - 1) {
                    g++;
                    a()
                }
            }
        };
    var h = function (m) {
            var n = m.getTarget().getId();
            var l, j;
            for (j = 0; j < e.length; j++) {
                l = e[j];
                if (l.getId() == n) {
                    e.splice(j, 1);
                    g = Math.min(g, e.length - 1);
                    var k = new cm.TownCrierNotificationManagerEvent(cm.TownCrierNotificationManagerEvent.COUNT_DECREASE);
                    k.setTarget(c);
                    c.dispatchCustomEvent(k)
                }
            }
        };
    this.add = function (j) {
        if (!j.isRead()) {
            e.push(j);
            j.addEventListener(cm.TownCrierMessageEvent.READ, h);
            if (e.length == 1) {
                a()
            }
            var i = new cm.TownCrierNotificationManagerEvent(cm.TownCrierNotificationManagerEvent.COUNT_INCREASE);
            i.setTarget(c);
            c.dispatchCustomEvent(i)
        }
    };
    this.getMessageCount = function () {
        return e.length
    };
    this.getMessage = function () {
        return e[g]
    };
    this.getIndex = function () {
        return g
    }
};
cm.TownCrierNotificationManagerClass.prototype = new cm.CustomEventDispatcher();
cm.TownCrierNotificationManagerClass.prototype.constructor = cm.TownCrierNotificationManagerClass;
cm.TownCrierNotificationManager = new cm.TownCrierNotificationManagerClass();

function viral_tracking(serverId, tracking_code, userid, other) {
    var params = Object.clone(g_ajaxparams);
    params.tracking_code = tracking_code;
    params.serverId = serverId;
    params.userId = userid;
    params.other = other;
    new Ajax.Request(g_ajaxpath + "ajax/tracking.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (response) {
            var rslt = eval("(" + response.responseText + ")");
            if (rslt.ok) {} else {}
        },
        onFailure: function () {}
    })
};

function cancelTraining(c, h, i, a, n, f, g) {
    var o = new Array();
    var k = new Array();
    o.push("<div id='modal_lv10'>");
    o.push("<div class='lv10 clearfix'>");
    o.push("<div class='info' style='margin-left: 10px; width: 340px;'><div class='ttl'>");
    o.push(g_js_strings.cancelTraining.canceltrainingtakes);
    o.push("<table cellpadding='2' cellspacing='0'><tbody><tr>");
    var e = ["Food", "Wood", "Stone", "Ore"];
    var b = 1;
    var m = checkreq("unt", i, 1);
    for (var d = 0; d < m[0].length; d++) {
        if (e.indexOf(m[0][d]) != -1) {
            var l = new Array();
            l.push("<td class='rec'>" + m[0][d] + "</td>");
            if (parseInt(m[1][d]) > 0) {
                l.push("<td class='rec'>" + addCommas(parseInt(m[1][d]) * a / 2) + "</td>")
            } else {
                l.push("<td class='rec'>" + m[1][d] * a / 2 + "</td>")
            }
            if (b % 2 == 0) {
                o.push(l.join("") + "</tr>")
            } else {
                o.push(l.join(""))
            }
            b++
        }
    }
    o.push("</tbody></table>");
    o.push("</div></div>");
    o.push("</div>");
    o.push("<div class='btns clearfix'>");
    o.push("<a  class='button20' onclick='removeTraining(" + c + "," + h + "," + i + "," + a + "," + n + "," + f + "," + g + ");return false;'><span>" + g_js_strings.cancelTraining.canceltraining + "</span></a>");
    o.push("<a  class='cancel' onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    o.push("</div></div>");
    Modal.showModal(400, 400, 130, 130, g_js_strings.cancelTraining.canceltrainingtitle, o.join(""))
}

function removeTraining(trainingId, cityId, typetrn, numtrptrn, trnETA, trnTmp, trnNeeded, speedUpTraining) {
    var params = Object.clone(g_ajaxparams);
    params.requestType = "CANCEL_TRAINING";
    params.cityId = cityId;
    params.typetrn = typetrn;
    params.numtrptrn = numtrptrn;
    params.trnETA = trnETA;
    params.trnTmp = trnTmp;
    params.trnNeeded = trnNeeded;
    new Ajax.Request(g_ajaxpath + (speedUpTraining ? "ajax/speedupTraining.php" : "ajax/cancelTraining.php") + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                update_seed_ajax(true, function () {
                    var k = 0;
                    for (var j = 0; j < seed.queue_unt["city" + cityId].length; j++) {
                        if (j > trainingId) {
                            seed.queue_unt["city" + cityId][j][2] = parseInt(rslt.dateTraining[k]["start"]);
                            seed.queue_unt["city" + cityId][j][3] = parseInt(rslt.dateTraining[k]["end"]);
                            k++
                        }
                    }
                    seed.queue_unt["city" + cityId].splice(trainingId, 1);
                    for (var i = 1; i < 5; i++) {
                        var totalReturn = parseInt(unitcost["unt" + typetrn][i]) * parseInt(numtrptrn) * 3600 / 2;
                        seed.resources["city" + cityId]["rec" + i][0] = parseInt(seed.resources["city" + cityId]["rec" + i][0]) + totalReturn
                    }
                    Modal.hideModalAll()
                })
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function cancelFortifications(b, g, f, l, a, i, h, k) {
    var p = new Array();
    var m = new Array();
    p.push("<div id='modal_lv10'>");
    p.push("<div class='lv10 clearfix'>");
    p.push("<div class='info' style='margin-left: 10px; width: 340px;'><div class='ttl'>");
    p.push(g_js_strings.cancelFortification.cancelfortificationtakes);
    p.push("<table cellpadding='2' cellspacing='0'><tbody><tr>");
    var e = ["Food", "Wood", "Stone", "Ore"];
    var c = 1;
    var o = checkreq("frt", f, 1);
    for (var d = 0; d < o[0].length; d++) {
        if (e.indexOf(o[0][d]) != -1) {
            var n = new Array();
            n.push("<td class='rec'>" + o[0][d] + "</td>");
            if (parseInt(o[1][d]) > 0) {
                n.push("<td class='rec'>" + addCommas(parseInt(o[1][d]) * l / 2) + "</td>")
            } else {
                n.push("<td class='rec'>" + o[1][d] * l / 2 + "</td>")
            }
            if (c % 2 == 0) {
                p.push(n.join("") + "</tr>")
            } else {
                p.push(n.join(""))
            }
            c++
        }
    }
    p.push("</tbody></table>");
    p.push("</div></div>");
    p.push("</div>");
    p.push("<div class='btns clearfix'>");
    p.push("<a  class='button20' onclick='removeFortifications(" + b + "," + g + "," + f + "," + l + "," + a + "," + i + "," + h + "," + k + ");return false;'><span>" + g_js_strings.cancelFortification.cancelfortification + "</span></a>");
    p.push("<a  class='cancel' onclick='Modal.hideModal();return false;'>" + g_js_strings.commonstr.cancel + "</a>");
    p.push("</div></div>");
    Modal.showModal(400, 400, 130, 130, g_js_strings.cancelFortification.cancelfortificationtitle, p.join(""))
}

function removeFortifications(queueId, cityId, typefrt, numtrpfrt, frtETA, frtTmp, frtNeeded, frtid) {
    var params = Object.clone(g_ajaxparams);
    params.requestType = "CANCEL_FORTIFICATIONS";
    params.cityId = cityId;
    params.typefrt = typefrt;
    params.numtrpfrt = numtrpfrt;
    params.frtETA = frtETA;
    params.frtTmp = frtTmp;
    params.frtNeeded = frtNeeded;
    params.frtid = frtid;
    new Ajax.Request(g_ajaxpath + "ajax/cancelFortifications.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                var k = 0;
                for (var j = 0; j < seed.queue_fort["city" + cityId].length; j++) {
                    if (j > queueId) {
                        seed.queue_fort["city" + cityId][j][2] = parseInt(rslt.dateFortifications[k]["start"]);
                        seed.queue_fort["city" + cityId][j][3] = parseInt(rslt.dateFortifications[k]["end"]);
                        k++
                    }
                }
                seed.queue_fort["city" + cityId].splice(queueId, 1);
                for (var i = 1; i < 5; i++) {
                    var totalReturn = parseInt(fortcost["frt" + typefrt][i]) * parseInt(numtrpfrt) * 3600 / 2;
                    seed.resources["city" + cityId]["rec" + i][0] = parseInt(seed.resources["city" + cityId]["rec" + i][0]) + totalReturn
                }
                Modal.hideModalAll()
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
};
cm.translate = function (c) {
    var d = {
        tch: g_js_strings.commonstr.technology,
        rsc: g_js_strings.commonstr.resources
    };
    var e = function () {
            var g, f;
            for (g in resourceinfo) {
                f = g;
                if (!f.match(/^\d+$/)) {
                    continue
                }
                d["r" + f] = resourceinfo[g]
            }
            for (g in techcost) {
                f = g.replace(/^tch(\d+)$/, "$1");
                if (!f.match(/^\d+$/)) {
                    continue
                }
                d["t" + f] = techcost[g][0]
            }
            for (g in unitnamedesctranslated) {
                f = g.replace(/^unt(\d+)$/, "$1");
                if (!f.match(/^\d+$/)) {
                    continue
                }
                d["u" + f] = unitnamedesctranslated[g][0]
            }
            for (g in buildingcost) {
                f = g.replace(/^bdg(\d+)$/, "$1");
                if (!f.match(/^\d+$/)) {
                    continue
                }
                d["b" + f] = buildingcost[g][0]
            }
            for (g in fortcost) {
                f = g.replace(/^frt(\d+)$/, "$1");
                if (!f.match(/^\d+$/)) {
                    continue
                }
                d["f" + f] = fortcost[g][0]
            }
        };
    var a = function (f) {
            return g_js_strings && g_js_strings.be && g_js_strings.be[f] ? g_js_strings.be[f] : f
        };
    var b = function (f) {
            return d[f] ? d[f] : f
        };
    e();
    return {
        it: b
    }
}(jQuery);
var cm = cm || {};
var cm = function (a) {
        var b = a.TutorialKeyController = a.TutorialKeyController || {};
        var c = function (f) {
                var d = f.keyCode ? f.keyCode : f.which ? f.which : f.charCode;
                if (d == 8 || d == 9) {
                    f.cancelBubble = true;
                    f.returnValue = false;
                    if (f.stopPropagation) {
                        f.stopPropagation();
                        f.preventDefault()
                    }
                }
            };
        b.disableKeys = function () {
            Event.observe(document, "keydown", c)
        };
        b.enableKeys = function () {
            Event.stopObserving(document, "keydown", c)
        };
        return a
    }(cm);

function tutorialMerlinTutorial(c) {
    cm.TutorialKeyController.disableKeys();
    tutorialClear();
    var a = new Array();
    var d = g_showNewTutorial ? "bltutorial" : "merlintutorial";
    switch (c) {
    case 0:
        if (g_showNewTutorial) {
            a.push("<div class='content'>");
            a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin0a.replace("%1$s", seed.player.prefix) + "</div>");
            a.push("<div class='buttonrow clearfix'>");
            a.push("<a class='brownButton' onclick='tutorialMerlinTutorial(10);return false;'>" + g_js_strings.commonstr.nothanks + "</a>");
            a.push("<a class='blueButton' onclick='tutorialMerlinTutorial(2);return false;'>" + g_js_strings.commonstr.next + "</a></div>");
            a.push("</div>")
        } else {
            a.push("<div class='content'>");
            a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin0.replace("%1$s", seed.player.prefix) + "</div>");
            a.push("<div class='buttonrow clearfix'>");
            a.push("<a class='button20' onclick='tutorialMerlinTutorial(1);return false;'><span>" + g_js_strings.commonstr.next + "</span></a><a class='textlink' onclick='tutorialMerlinTutorial(10);return false;'>" + g_js_strings.commonstr.nothanks + "</a></div>");
            a.push("</div>")
        }
        cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3-Merlin Intro-1" + seed.player.g);
        cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3 Skip-Merlin Intro-1" + seed.player.g);
        cm.MixPanelTracker.trackFunnel("FTE Tutorial v3", 1, "Merlin Intro", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        cm.MixPanelTracker.trackFunnel("FTE Tutorial v3 Skip", 1, "Merlin Intro", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        if (numWorlds == 1) {
            cm.ConversionTracker.track("", "fte_conv_merlin_intro");
            fteConversionTracker("fte_conv_merlin_intro")
        }
        break;
    case 1:
        a.push("<div class='content'>");
        a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin1 + "</div>");
        a.push("<div class='buttonrow clearfix'>");
        a.push("<a class='button20' onclick='tutorialMerlinTutorial(2);return false;'><span>" + g_js_strings.commonstr.next + "</span></a></div>");
        a.push("</div>");
        cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3-Merlin Increase Might-2");
        cm.MixPanelTracker.trackFunnel("FTE Tutorial v3", 2, "Merlin Increase Might", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        if (numWorlds == 1) {
            cm.ConversionTracker.track("", "fte_conv_merlin_increase_might");
            fteConversionTracker("fte_conv_merlin_increase_might")
        }
        break;
    case 2:
        if (g_showNewTutorial) {
            seed.tutorial.t1 = 13;
            tutorialCheck(13)
        } else {
            seed.tutorial.t1 = 12;
            tutorialCheck(12)
        }
        return;
        break;
    case 3:
        a.push("<div class='content'>");
        a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin3 + "</div>");
        a.push("<div class='buttonrow clearfix'>");
        a.push("<a class='button20' onclick='seed.tutorial.t1=12;tutorialCheck(12);return false;'><span>" + g_js_strings.commonstr.next + "</span></a></div>");
        a.push("</div>");
        break;
    case 4:
        a.push("<div class='content'>");
        a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin4 + "</div>");
        a.push("<div class='buttonrow clearfix'>");
        a.push("<a class='button20' onclick='seed.tutorial.t1=19;tutorialCheck(19);return false;'><span>" + g_js_strings.commonstr.next + "</span></a>");
        if (seed.player.entryTag == "fb884") {
            a.push("<img src='https://offerpal.go2jump.org/aff_l?offer_id=500' width='1' height='1'/>")
        }
        a.push("</div>");
        a.push("</div>");
        cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3-Merlin Build Cottage-4");
        cm.MixPanelTracker.trackFunnel("FTE Tutorial v3", 4, "Merlin Build Cottage", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        if (numWorlds == 1) {
            cm.ConversionTracker.track("", "fte_conv_merlin_build_cottage");
            fteConversionTracker("fte_conv_merlin_build_cottage")
        }
        break;
    case 5:
        if (g_showNewTutorial) {
            d = "bltutorial ending";
            a.push("<div class='content'>");
            a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin5a + "</div>");
            a.push("<div class='buttonrow'>");
            a.push("<a class='blueButton' onclick='tutorialMerlinOver();return false;'><span>" + g_js_strings.commonstr.next + "</span></a><br clear='all' /></div>");
            a.push("</div>")
        } else {
            a.push("<div class='content'>");
            a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin5 + "</div>");
            a.push("<div class='buttonrow clearfix'>");
            a.push("<a class='button20' onclick='tutorialMerlinTutorial(6);return false;'><span>" + g_js_strings.commonstr.next + "</span></a></div>");
            a.push("</div>")
        }
        cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3-Merlin Level Up-5");
        cm.MixPanelTracker.trackFunnel("FTE Tutorial v3", 5, "Merlin Level Up", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        if (numWorlds == 1) {
            cm.ConversionTracker.track("", "fte_conv_merlin_level_up");
            fteConversionTracker("fte_conv_merlin_level_up")
        }
        break;
    case 6:
        a.push("<div class='content'>");
        a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin7 + "</div>");
        a.push("<div class='buttonrow clearfix'>");
        a.push("<a class='button20' onclick=\"tutorialMerlinOver();return false;\"><span>" + g_js_strings.commonstr.ok + "</span></a></div>");
        a.push("</div>");
        cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3-Merlin End-6");
        cm.MixPanelTracker.trackFunnel("FTE Tutorial v3", 6, "Merlin End", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        if (numWorlds == 1) {
            cm.ConversionTracker.track("", "fte_conv_merlin_end");
            fteConversionTracker("fte_conv_merlin_end")
        }
        break;
    case 10:
        if (g_showNewTutorial) {
            a.push("<div class='content'>");
            a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin10a + "</div>");
            a.push("<div class='buttonrow clearfix'>");
            a.push("<a class='brownButton' onclick='tutorialNoShow();return false;'>" + g_js_strings.tutorialMerlinTutorial.skiptutorial + "</span></a>");
            a.push("<a class='blueButton' onclick='tutorialMerlinTutorial(0);return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a>");
            a.push("</div>");
            a.push("</div>")
        } else {
            a.push("<div class='content'>");
            a.push("<div class='desc'>" + g_js_strings.tutorialMerlinTutorial.merlin10 + "</div>");
            a.push("<div class='buttonrow clearfix'>");
            a.push("<a class='button20' onclick='tutorialNoShow();return false;'><span>" + g_js_strings.tutorialMerlinTutorial.skiptutorial + "</span></a>");
            a.push("<a class='button20' onclick='tutorialMerlinTutorial(0);return false;'><span>" + g_js_strings.commonstr.cancel + "</span></a>");
            a.push("</div>");
            a.push("</div>")
        }
        break;
    default:
        break
    }
    var b = document.createElement("div");
    b.id = "modal_tutorial_merlin";
    b.className = d;
    document.getElementsByTagName("body")[0].appendChild(b);
    b.innerHTML = a.join("");
    Modal.showCurtain();
    if (c == 3) {
        $("modalCurtain0").setOpacity(0.3)
    }
}
cm.MerlinTutorialDialog = function (a) {
    var b = document.createElement("div");
    b.id = "modal_tutorial_merlin";
    b.className = "merlintutorial";
    b.innerHTML = a;
    this.show = function () {
        document.getElementsByTagName("body")[0].appendChild(b);
        Modal.showCurtain()
    }
};
cm.BLTutorialDialog = function (a) {
    var b = document.createElement("div");
    b.id = "modal_tutorial_merlin";
    b.className = "bltutorial";
    b.innerHTML = a;
    this.show = function () {
        document.getElementsByTagName("body")[0].appendChild(b);
        Modal.showCurtain()
    };
    this.setClassName = function (c) {
        b.className = c
    }
};

function tutorialMerlinOver() {
    cm.TutorialKeyController.enableKeys();
    tutorialClear();
    tutorialAdvance(1, 50);
    jQuery(document).trigger("tutorialEnd");
    ProgressBar.initializeProgressBar(1, true)
}

function tutorialNoShow() {
    cm.TutorialKeyController.enableKeys();
    seed.tutorial.t1 = 99;
    tutorialAdvance(1, 99);
    tutorialClear();
    Modal.hideModalAll();
    jQuery(document).trigger("tutorialEnd");
    ProgressBar.initializeProgressBar(1, true);
    cm.ConversionTracker.track(g_tutorialEntryTag, "FTE Tutorial v3 Skip-Merlin Skipped-2" + seed.player.g);
    cm.MixPanelTracker.trackFunnel("FTE Tutorial v3 Skip", 2, "Merlin Skipped", {
        usr_gen: seed.player.g,
        usr_byr: seed.player.y,
        usr_ttl: titlenames[seed.player.title],
        distinct_id: tvuid
    });
    cm.ConversionTracker.track("biftetracking", 1800, 1)
}

function tutorialClear() {
    $("arrowtip").hide();
    $("tutorialCover").className = "tutorialcover";
    $("tutorialCover").hide();
    Modal.hideCurtain();
    if ($("modal_tutorial_merlin")) {
        $("modal_tutorial_merlin").remove()
    }
}

function tutorialDecree() {
    Modal.hideModalAll();
    var a = new Array();
    a.push("<div class='tutimg'><img src='");
    a.push(stimgUrl);
    a.push("img/tutorial/b5.jpg'/></div>");
    a.push("<div class='clearfix getreward'>");
    a.push("<a  class='button25' onclick='tutorialDecreeOk();return false;'><span>" + g_js_strings.tutorialDecree.getrwd + "</span></a></div>");
    a.push("<div class='noshow' style='display:none;'><input type='checkbox' id='modal_tutorialdecree_check'/>" + g_js_strings.tutorialDecree.donotshowtut + "</div>");
    var b = document.createElement("div");
    b.id = "modal_tutorialdecree";
    b.innerHTML = a.join("");
    document.getElementsByTagName("body")[0].appendChild(b);
    Modal.showCurtain()
}

function tutorialDecreeOk() {
    if ($("modal_tutorialdecree_check").checked) {} else {
        tutorialDone(1);
        tutorialCheck(2)
    }
    document.getElementsByTagName("body")[0].removeChild($("modal_tutorialdecree"));
    Modal.hideCurtain()
}

function tutorialDone(a) {
    if (a == parseInt(seed.tutorial.t1)) {
        tutorialAdvance(1, a + 1);
        seed.tutorial.t1 = a + 1
    }
}

function tutorialAdvance(step, state) {
    if (state == 10) {
        var params = Object.clone(g_ajaxparams);
        params.action = g_tutorial_start;
        params.serverId = g_server;
        params.uid = tvuid;
        new Ajax.Request(g_ajaxpath + "ajax/funnelTracking.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function () {},
            onFailure: function () {}
        })
    }
    if (state > 21) {
        var params = Object.clone(g_ajaxparams);
        params.action = g_tutorial_end;
        params.serverId = g_server;
        params.uid = tvuid;
        new Ajax.Request(g_ajaxpath + "ajax/funnelTracking.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function () {},
            onFailure: function () {}
        })
    }
    var params = Object.clone(g_ajaxparams);
    params.step = step;
    params.state = state;
    new Ajax.Request(g_ajaxpath + "ajax/progressTutorial.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                if (parseInt(step) != 1) {
                    seed.tutorial["t" + step] = state
                }
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed);
                    var bst = unixtime() + 604800;
                    seed.playerEffects.r1BstExp = bst;
                    seed.playerEffects.r2BstExp = bst;
                    seed.playerEffects.r3BstExp = bst;
                    seed.playerEffects.r4BstExp = bst;
                    update_boosts()
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function tutorialCheck(b) {
    if (b && b != parseInt(seed.tutorial.t1)) {
        tutorialClear();
        return false
    }
    tutorialClear();
    var a = Object.keys(seed.buildings["city" + currentcityid]);
    for (var c = 0; c < a.length; c++) {
        if (parseInt(seed.buildings["city" + currentcityid][a[c]][0]) == 5) {
            seed.tutorial.t1 = 22
        }
    }
    switch (parseInt(seed.tutorial.t1)) {
    case 0:
        if (g_showNewTutorial) {
            $("arrowtip").innerHTML = "<div class='arrowdown'><div width='width:200px;'>" + g_js_strings.tutorialCheck.clickforcott_a + "</div></div>"
        } else {
            $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialCheck.clickforcott + "</div></div>"
        }
        $("arrowtip").style.top = "260px";
        $("arrowtip").style.left = "385px";
        $("arrowtip").show();
        $("tutorialCover").addClassName("cottage");
        $("tutorialCover").show();
        break;
    case 1:
        $("arrowtip").hide();
        tutorialDecree();
        break;
    case 2:
        if (g_showNewTutorial) {
            $("arrowtip").innerHTML = "<div class='arrowup'><div style='width:200px;'>" + g_js_strings.tutorialCheck.clickforquests_a + "</div></div>"
        } else {
            $("arrowtip").innerHTML = "<div class='arrowup'><div>" + g_js_strings.tutorialCheck.clickforquests + "</div></div>"
        }
        $("arrowtip").style.top = "55px";
        $("arrowtip").style.left = "285px";
        $("arrowtip").show();
        $("tutorialCover").addClassName("quest");
        $("tutorialCover").show();
        break;
    case 3:
        if ($("modal_quests")) {
            if ($("modal_quests").visible()) {
                $("arrowtip").innerHTML = "<div class='arrowleft'></div>";
                $("arrowtip").style.top = "298px";
                $("arrowtip").style.left = "480px";
                $("arrowtip").show()
            }
        }
        break;
    case 4:
        $("arrowtip").innerHTML = "<div class='arrowup'><div>" + g_js_strings.tutorialCheck.clickforfield + "</div></div>";
        $("arrowtip").style.top = "239px";
        $("arrowtip").style.left = "49px";
        $("arrowtip").show();
        $("tutorialCover").addClassName("fieldview");
        $("tutorialCover").show();
        return true;
        break;
    case 5:
        tutorialClear();
        if ($("maparea_fields").visible()) {
            if (g_showNewTutorial) {
                $("arrowtip").innerHTML = "<div class='arrowdown'><div style='width:200px;'>" + g_js_strings.tutorialCheck.clickforsawmill_a + "</div></div>"
            } else {
                $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialCheck.clickforsawmill + "</div></div>"
            }
            $("arrowtip").style.top = "170px";
            $("arrowtip").style.left = "300px";
            $("arrowtip").show();
            $("tutorialCover").addClassName("sawmill");
            $("tutorialCover").show()
        }
        break;
    case 10:
        if (seed.items.i10020) {
            $("arrowtip").innerHTML = "<div class='arrowup'><div>" + g_js_strings.tutorialCheck.clickformyitems + "</div></div>";
            $("arrowtip").style.top = "100px";
            $("arrowtip").style.left = "483px";
            $("arrowtip").show();
            $("tutorialCover").addClassName("myitems");
            tutorialUpdateCover(50, 105);
            $("tutorialCover").show();
            if (numWorlds == 1) {
                cm.ConversionTracker.track("", "fte_conv_my_items");
                fteConversionTracker("fte_conv_my_items")
            }
            break
        } else {
            tutorialAdvance(1, 12);
            break
        }
    case 11:
        if (seed.items.i10020) {
            $("arrowtip").innerHTML = "<div class='arrowleft'><div>" + g_js_strings.tutorialCheck.clickopenchest + "</div></div>";
            $("arrowtip").style.top = "211px";
            $("arrowtip").style.left = "279px";
            $("arrowtip").show();
            $("tutorialCover").addClassName("startchest");
            $("tutCovTop").setStyle({
                height: "190px"
            });
            $("tutCovLeft").setStyle({
                top: "190px"
            });
            $("tutCovRight").setStyle({
                top: "190px"
            });
            $("tutCovBottom").setStyle({
                top: "301px"
            });
            $("tutorialCover").show();
            if (numWorlds == 1) {
                cm.ConversionTracker.track("", "fte_conv_new_city_chest");
                fteConversionTracker("fte_conv_new_city_chest")
            }
            break
        } else {
            tutorialAdvance(1, 12);
            break
        }
    case 12:
        if (seed.buildings["city" + currentcityid]["pos107"]) {
            tutorialAdvance(1, 16);
            break
        } else {
            tutorialAdvance(1, 12);
            $("arrowtip").innerHTML = "<div class='arrowup'><div>" + g_js_strings.tutorialCheck.clickforfield + "</div></div>";
            $("arrowtip").style.top = "139px";
            $("arrowtip").style.left = "49px";
            $("arrowtip").show();
            $("tutorialCover").addClassName("fieldview");
            tutorialUpdateCover(109, 143);
            $("tutorialCover").show();
            if (numWorlds == 1) {
                cm.ConversionTracker.track("", "fte_conv_field_view");
                fteConversionTracker("fte_conv_field_view")
            }
            return true;
            break
        }
    case 13:
        if (seed.buildings["city" + currentcityid]["pos107"]) {
            tutorialAdvance(1, 16);
            break
        } else {
            tutorialAdvance(1, 13);
            if (!$("maparea_fields").visible()) {
                changeview_fields($("mod_views_field"))
            }
            if (g_showNewTutorial) {
                $("arrowtip").innerHTML = "<div class='arrowdown'><div style='margin-top:-80px;width:200px;'>" + g_js_strings.tutorialCheck.clickforsawmill_a + "</div></div>";
                $("arrowtip").style.top = "210px"
            } else {
                $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialCheck.clickforsawmill + "</div></div>";
                $("arrowtip").style.top = "217px"
            }
            $("arrowtip").style.left = "300px";
            $("arrowtip").show();
            $("tutorialCover").addClassName("sawmill");
            tutorialUpdateCover(314, 369);
            $("tutorialCover").show();
            if (numWorlds == 1) {
                cm.ConversionTracker.track("", "fte_conv_start_sawmill");
                fteConversionTracker("fte_conv_start_sawmill")
            }
            break
        }
    case 14:
        if (seed.buildings["city" + currentcityid]["pos107"]) {
            tutorialAdvance(1, 16);
            break
        } else {
            if (g_showNewTutorial) {
                $("arrowtip").innerHTML = "<div class='arrowleft'><div>" + g_js_strings.tutorialCheck.clickheresawmill_a + "</div></div>"
            } else {
                $("arrowtip").innerHTML = "<div class='arrowleft'><div>" + g_js_strings.tutorialCheck.clickheresawmill + "</div></div>"
            }
            $("arrowtip").style.top = "251px";
            $("arrowtip").style.left = "244px";
            $("arrowtip").show();
            $("tutorialCover").addClassName("clicksawmill");
            tutorialUpdateCover(117, 306);
            $("tutorialCover").show();
            if (numWorlds == 1) {
                cm.ConversionTracker.track("", "fte_conv_select_sawmill");
                fteConversionTracker("fte_conv_select_sawmill")
            }
            break
        }
    case 15:
        if (seed.buildings["city" + currentcityid]["pos107"]) {
            if (seed.queue_con["city" + currentcityid] && seed.queue_con["city" + currentcityid].length > 0) {
                if (g_showNewTutorial) {
                    $("arrowtip").innerHTML = "<div class='arrowdown'><div style='margin-top:-150px;width:150px;'>" + g_js_strings.tutorialCheck.buildingtimeline + "</div></div>"
                } else {
                    $("arrowtip").innerHTML = "<div class='arrowdown'></div>"
                }
                $("arrowtip").style.top = "465px";
                $("arrowtip").style.left = "500px";
                $("arrowtip").show();
                Modal.showCurtain();
                $("modalCurtain0").setOpacity(0.3)
            } else {
                tutorialAdvance(1, 16)
            }
        } else {
            if (g_showNewTutorial) {
                $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialCheck.clickbuildnohelp_a + "</div></div>"
            } else {
                $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialCheck.clickbuildnohelp + "</div></div>"
            }
            $("arrowtip").style.top = "175px";
            $("arrowtip").style.left = "379px";
            $("arrowtip").show();
            Modal.showCurtain();
            if (numWorlds == 1) {
                cm.ConversionTracker.track("", "fte_conv_build_sawmill");
                fteConversionTracker("fte_conv_build_sawmill")
            }
        }
        break;
    case 16:
        if (seed.quests.q1021 && parseInt(seed.quests.q1021) > 0) {
            tutorialAdvance(1, 18);
            break
        } else {
            tutorialAdvance(1, 16);
            Modal.hideModalAll();
            if (g_showNewTutorial) {
                $("arrowtip").innerHTML = "<div class='arrowup'><div style='width:200px;'>" + g_js_strings.tutorialCheck.clickforquests_a + "</div></div>"
            } else {
                $("arrowtip").innerHTML = "<div class='arrowup'><div>" + g_js_strings.tutorialCheck.clickforquests + "</div></div>"
            }
            $("arrowtip").style.top = "100px";
            $("arrowtip").style.left = "279px";
            $("arrowtip").show();
            $("tutorialCover").addClassName("quest");
            tutorialUpdateCover(50, 105);
            $("tutorialCover").show();
            if (numWorlds == 1) {
                cm.ConversionTracker.track("", "fte_conv_click_quest");
                fteConversionTracker("fte_conv_click_quest")
            }
            break
        }
    case 17:
        if (seed.quests.q1021 && parseInt(seed.quests.q1021) > 0) {
            tutorialAdvance(1, 18);
            break
        } else {
            $("arrowtip").innerHTML = "<div class='arrowright'><div>" + g_js_strings.tutorialCheck.clickforreward + "</div></div>";
            $("arrowtip").style.top = "497px";
            $("arrowtip").style.left = "340px";
            $("arrowtip").show();
            Modal.showCurtain();
            if (numWorlds == 1) {
                cm.ConversionTracker.track("", "fte_conv_get_quest_reward");
                fteConversionTracker("fte_conv_get_quest_reward")
            }
            break
        }
    case 18:
        if (g_showNewTutorial) {
            seed.tutorial.t1 = 19;
            tutorialCheck(19);
            tutorialAdvance(1, 19)
        } else {
            tutorialAdvance(1, 18);
            tutorialMerlinTutorial(4)
        }
        break;
    case 19:
        tutorialAdvance(1, 19);
        if (g_showNewTutorial) {
            $("arrowtip").innerHTML = "<div class='arrowup'><div style='width:200px;'>" + g_js_strings.tutorialCheck.clickforcity_a + "</div></div>"
        } else {
            $("arrowtip").innerHTML = "<div class='arrowup'><div>" + g_js_strings.tutorialCheck.clickforcity + "</div></div>"
        }
        $("arrowtip").style.top = "148px";
        $("arrowtip").style.left = "6px";
        $("arrowtip").show();
        $("tutorialCover").addClassName("cityview");
        tutorialUpdateCover(109, 150);
        $("tutorialCover").show();
        if (numWorlds == 1) {
            cm.ConversionTracker.track("", "fte_conv_city_view");
            fteConversionTracker("fte_conv_city_view")
        }
        break;
    case 20:
        tutorialAdvance(1, 20);
        if (g_showNewTutorial) {
            $("arrowtip").innerHTML = "<div class='arrowdown'><div style='margin-top:-80px;width:200px;'>" + g_js_strings.tutorialCheck.clickforcott_a + "</div></div>"
        } else {
            $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialCheck.clickforcott + "</div></div>"
        }
        $("arrowtip").style.top = "236px";
        $("arrowtip").style.left = "240px";
        $("arrowtip").show();
        $("tutorialCover").addClassName("cottage");
        tutorialUpdateCover(329, 388);
        $("tutorialCover").show();
        if (numWorlds == 1) {
            cm.ConversionTracker.track("", "fte_conv_start_cottage");
            fteConversionTracker("fte_conv_start_cottage")
        }
        break;
    case 21:
        if (g_showNewTutorial) {
            $("arrowtip").innerHTML = "<div class='arrowleft'><div>" + g_js_strings.tutorialCheck.clickherecottage_a + "</div></div>"
        } else {
            $("arrowtip").innerHTML = "<div class='arrowleft'><div>" + g_js_strings.tutorialCheck.clickherecottage + "</div></div>"
        }
        $("arrowtip").style.top = "252px";
        $("arrowtip").style.left = "130px";
        $("arrowtip").show();
        $("tutorialCover").addClassName("clickcottage");
        tutorialUpdateCover(117, 306);
        $("tutorialCover").show();
        if (numWorlds == 1) {
            cm.ConversionTracker.track("", "fte_conv_select_cottage");
            fteConversionTracker("fte_conv_select_cottage")
        }
        break;
    case 22:
        tutorialAdvance(1, 22);
        tutorialMerlinTutorial(5);
        break;
    default:
        tutorialClear();
        return true
    }
}

function tutorialDecreeCheckBdg(a) {
    a = parseInt(a);
    switch (a) {
    case 0:
        tutorialDecreeCheck(3, a);
        break;
    case 1:
        tutorialDecreeCheck(17, a);
        break;
    case 2:
        tutorialDecreeCheck(16, a);
        break;
    case 3:
        tutorialDecreeCheck(18, a);
        break;
    case 4:
        tutorialDecreeCheck(19, a);
        break;
    case 5:
        break;
    case 6:
        tutorialDecreeCheck(26, a);
        break;
    case 7:
        tutorialDecreeCheck(4, a);
        break;
    case 8:
        tutorialDecreeCheck(9, a);
        break;
    case 9:
        tutorialDecreeCheck(5, a);
        break;
    case 10:
        tutorialDecreeCheck(8, a);
        break;
    case 11:
        tutorialDecreeCheck(7, a);
        break;
    case 12:
        tutorialDecreeCheck(20, a);
        break;
    case 13:
        tutorialDecreeCheck(6, a);
        break;
    case 14:
        tutorialDecreeCheck(23, a);
        break;
    case 15:
        tutorialDecreeCheck(22, a);
        break;
    case 16:
        tutorialDecreeCheck(21, a);
        break;
    case 17:
        tutorialDecreeCheck(24, a);
        break;
    default:
        return true
    }
}

function tutorialDecreeCheck(a, b) {
    if (parseInt(seed.tutorial["t" + a]) != 1) {
        switch (a) {
        case 2:
            break;
        case 3:
            tutorialDecreeDispBdg(b);
            break;
        case 4:
            tutorialDecreeDispBdg(b);
            break;
        case 5:
            tutorialDecreeDispBdg(b);
            break;
        case 6:
            tutorialDecreeDispBdg(b);
            break;
        case 7:
            tutorialDecreeDispBdg(b);
            break;
        case 8:
            tutorialDecreeDispBdg(b);
            break;
        case 9:
            tutorialDecreeDispBdg(b);
            break;
        case 10:
            break;
        case 11:
            break;
        case 12:
            tutorialDecreeDisp(g_js_strings.tutorialDecreeCheck.scoutdecree);
            break;
        case 13:
            tutorialDecreeDisp(g_js_strings.tutorialDecreeCheck.plunderdecree);
            break;
        case 14:
            break;
        case 15:
            tutorialDecreeDisp(g_js_strings.tutorialDecreeCheck.courtdecree);
            break;
        case 16:
            tutorialDecreeDispBdg(b);
            break;
        case 17:
            tutorialDecreeDispBdg(b);
            break;
        case 18:
            tutorialDecreeDispBdg(b);
            break;
        case 19:
            tutorialDecreeDispBdg(b);
            break;
        case 20:
            tutorialDecreeDispBdg(b);
            break;
        case 21:
            tutorialDecreeDispBdg(b);
            break;
        case 22:
            tutorialDecreeDispBdg(b);
            break;
        case 23:
            tutorialDecreeDispBdg(b);
            break;
        case 24:
            tutorialDecreeDispBdg(b);
            break;
        case 25:
            tutorialDecreeDispBdg(b);
            break;
        case 26:
            tutorialDecreeDispBdg(b);
            break;
        default:
            return true
        }
        tutorialAdvance(a, 1);
        seed.tutorial["t" + a] = 1
    } else {
        return true
    }
}

function tutorialFTE(a) {
    if (a != parseInt(seed.tutorial.t1)) {
        tutorialClear();
        return false
    }
    tutorialClear();
    switch (a) {
    case 0:
        changeview_fields($("mod_views_field"));
        tutorialDecreeDispViews(2);
        cm.MixPanelTracker.trackFunnel("FTE Tutorial", 1, "Field Decree", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        break;
    case 1:
        $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialFTE.clickforsawmill + "</div></div>";
        $("arrowtip").style.top = "205px";
        $("arrowtip").style.left = "300px";
        $("arrowtip").show();
        $("tutorialCover").addClassName("sawmill");
        $("tutorialCover").show();
        cm.MixPanelTracker.trackFunnel("FTE Tutorial", 2, "Sawmill Arrow", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        break;
    case 2:
        if (seed.player.entryTag == "fb884") {
            $("arrowtip").innerHTML = "<div class='arrowup'><div>" + g_js_strings.tutorialFTE.clickforquests + "</div></div><img src='https://offerpal.go2jump.org/aff_l?offer_id=500' width='1' height='1'/>"
        } else {
            $("arrowtip").innerHTML = "<div class='arrowup'><div>" + g_js_strings.tutorialFTE.clickforquests + "</div></div>"
        }
        $("arrowtip").style.top = "90px";
        $("arrowtip").style.left = "285px";
        $("arrowtip").show();
        $("tutorialCover").addClassName("quest");
        $("tutorialCover").show();
        cm.MixPanelTracker.trackFunnel("FTE Tutorial", 3, "Quest Button Arrow", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        break;
    case 3:
        tutorialDecreeDispViews(4);
        cm.MixPanelTracker.trackFunnel("FTE Tutorial", 4, "Quest Decree", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        break;
    case 4:
        $("arrowtip").innerHTML = "<div class='arrowup'></div>";
        $("arrowtip").style.top = "550px";
        $("arrowtip").style.left = "390px";
        $("arrowtip").show();
        cm.MixPanelTracker.trackFunnel("FTE Tutorial", 5, "Quest Reward Arrow", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        break;
    case 5:
        $("arrowtip").innerHTML = "<div class='arrowup'><div>" + g_js_strings.tutorialFTE.clickforcity + "</div></div>";
        $("arrowtip").style.top = "145px";
        $("arrowtip").style.left = "6px";
        $("arrowtip").show();
        $("tutorialCover").addClassName("cityview");
        $("tutorialCover").show();
        cm.MixPanelTracker.trackFunnel("FTE Tutorial", 6, "City Arrow", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        break;
    case 6:
        tutorialDecreeDispViews(1);
        cm.MixPanelTracker.trackFunnel("FTE Tutorial", 7, "City Decree", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        break;
    case 7:
        $("arrowtip").innerHTML = "<div class='arrowdown'><div>" + g_js_strings.tutorialFTE.clickforcott + "</div></div>";
        $("arrowtip").style.top = "215px";
        $("arrowtip").style.left = "240px";
        $("arrowtip").show();
        $("tutorialCover").addClassName("cottage");
        $("tutorialCover").show();
        cm.MixPanelTracker.trackFunnel("FTE Tutorial", 7, "Cottage Arrow", {
            usr_gen: seed.player.g,
            usr_byr: seed.player.y,
            usr_ttl: titlenames[seed.player.title],
            distinct_id: tvuid
        });
        break
    }
}

function tutorialFTE1() {
    tutorialAdvance(1, 1);
    seed.tutorial.t1 = 1;
    tutorialFTE(1)
}

function tutorialFTE4() {
    tutorialAdvance(1, 4);
    seed.tutorial.t1 = 4;
    tutorialFTE(4)
}

function tutorialFTE7() {
    tutorialAdvance(1, 7);
    seed.tutorial.t1 = 7;
    tutorialFTE(7)
}

function tutorialDecreeDispViews(b) {
    var d = Object.clone(g_ajaxparams);
    d.action = g_tutorial_start;
    d.serverId = g_server;
    d.uid = tvuid;
    new Ajax.Request(g_ajaxpath + "ajax/funnelTracking.php" + g_ajaxsuffix, {
        method: "post",
        parameters: d,
        onSuccess: function () {},
        onFailure: function () {}
    });
    var a = new Array();
    a.push("<div class='bdginfo'><div class='pic'><img src='");
    a.push(stimgUrl);
    a.push("img/tutorial/");
    if (b == 2) {
        a.push("FieldView.png");
        a.push("'/></div><div class='clearfix btn'><a  class='getaward' onclick='tutorialDecreeDispOk();tutorialFTE1();return false;'>" + g_js_strings.commonstr.ok + "</a></div>")
    } else {
        if (b == 1) {
            a.push("cityView.png");
            a.push("'/></div><div class='clearfix btn'><a  class='getaward' onclick='tutorialDecreeDispOk();tutorialFTE7();return false;'>" + g_js_strings.commonstr.ok + "</a></div>")
        } else {
            if (b == 4) {
                a.push("questTutorial.jpg");
                a.push("'/></div><div class='clearfix btn'><a  class='getaward' onclick='tutorialDecreeDispOk();tutorialFTE4();return false;'>" + g_js_strings.commonstr.ok + "</a></div>")
            }
        }
    }
    a.push("</div>");
    var c = document.createElement("div");
    c.id = "modal_tutorialdecree_disp";
    c.innerHTML = a.join("");
    tutorialClear();
    document.getElementsByTagName("body")[0].appendChild(c);
    Modal.showCurtain(101100)
}

function tutorialDecreeDispBdg(c) {
    if (parseInt(c) == 2) {
        Modal.hideModalAll()
    }
    var a = new Array();
    a.push("<div class='bdginfo'><div class='pic'><img src='");
    a.push(stimgUrl);
    a.push("img/tutorial/b");
    a.push(c);
    a.push(".jpg'/></div><div class='clearfix btn'><a class='getaward' onclick='tutorialDecreeDispOk();");
    if (parseInt(seed.tutorial.t1) == 2) {
        a.push("tutorialFTE(2);")
    }
    a.push("return false;'>" + g_js_strings.commonstr.ok + "</a></div>");
    a.push("</div>");
    var b = document.createElement("div");
    b.id = "modal_tutorialdecree_disp";
    b.innerHTML = a.join("");
    tutorialClear();
    document.getElementsByTagName("body")[0].appendChild(b);
    Modal.showCurtain(101100)
}

function tutorialDecreeDisp(b) {
    var a = new Array();
    a.push("<div class='txinfo'>");
    a.push(b);
    a.push("<div class='clearfix'><a  class='okbtn' onclick='tutorialDecreeDispOk();return false;'>" + g_js_strings.commonstr.ok + "</a></div>");
    a.push("</div>");
    var c = document.createElement("div");
    c.id = "modal_tutorialdecree_disp";
    c.innerHTML = a.join("");
    tutorialClear();
    document.getElementsByTagName("body")[0].appendChild(c);
    Modal.showCurtain(101100)
}

function tutorialDecreeDispOk() {
    document.getElementsByTagName("body")[0].removeChild($("modal_tutorialdecree_disp"));
    Modal.hideCurtain();
    Modal.modalid--
}

function tutorialUpdateCover(d, b) {
    var c = Element.positionedOffset($("kochead")).top;
    d = d + c;
    b = b + c;
    $("tutCovTop").setStyle({
        height: d + "px"
    });
    $("tutCovLeft").setStyle({
        top: d + "px"
    });
    $("tutCovRight").setStyle({
        top: d + "px"
    });
    $("tutCovBottom").setStyle({
        top: b + "px"
    });
    var a = parseInt($("arrowtip").getStyle("top"));
    $("arrowtip").setStyle({
        top: (a + c) + "px"
    })
}

function promo() {
    var a = jQuery("#crossPromoBarContainer").length > 0;
    cm.log.l("CrossPromoBar=" + a);
    return a
}

function tutorialUpdateCover2(a, g, b, e) {
    if (promo()) {
        a = a - 71;
        g = g - 71
    }
    var d = Element.positionedOffset($("kochead")).top;
    a += d;
    g += d;
    var f = document.body.offsetHeight;
    $("tutCovTop").setStyle({
        height: g + "px"
    });
    $("tutCovLeft").setStyle({
        top: g + "px",
        width: a + "px",
        left: "0px",
        height: (f - g) + "px"
    });
    $("tutCovRight").setStyle({
        top: g + "px",
        width: (760 - b - a) + "px",
        left: (a + b) + "px",
        height: (f - g) + "px"
    });
    $("tutCovBottom").setStyle({
        top: (g + e) + "px",
        width: b + "px",
        left: a + "px",
        height: (f - g - e) + "px"
    });
    var c = parseInt($("arrowtip").getStyle("top"));
    $("arrowtip").setStyle({
        top: (c + d) + "px"
    })
}
var cm = cm || {};
cm.TutorialStep = function (b) {
    var c = this;
    var a = null;
    this.onEnter = null;
    this.onExit = null;
    this.name = null;
    this.begin = function () {
        tutorialClear();
        cm.TutorialEventDispatcher.dispatchTutorialEvent("enter", c.name)
    };
    var d = function () {
            var f, g;
            for (var e in b) {
                g = b[e];
                c[e] = g
            }
        };
    d()
};
cm.TutorialProgressChecker = new function () {
    this.isSawmillPositionOccupied = function () {
        return seed.buildings["city" + currentcityid]["pos107"]
    };
    this.isSawmillBuilding = function () {
        return !this.isSawmillRewardClaimed() && seed.queue_con["city" + currentcityid] && seed.queue_con["city" + currentcityid].length > 0
    };
    this.isSawmillRewardClaimed = function () {
        return seed.quests.q1021 && parseInt(seed.quests.q1021) > 0
    };
    this.isCottagePositionOccupied = function () {
        return seed.buildings["city" + currentcityid]["pos6"]
    }
};
cm.TutorialManager = new function () {
    var d = false;
    var f = null;
    var h = null;
    var c = null;
    var b = {};
    var g = function (i) {
            if (!f) {
                f = i
            }
            if (!h) {
                h = i
            }
            if (c && !c.nextStepName) {
                c.nextStepName = i.name
            }
            c = i;
            b[i.name.toString()] = i
        };
    var a = function () {
            cm.TutorialEventDispatcher.clearAll();
            for (var i in h.events) {
                cm.TutorialEventDispatcher.addEventListener(i, h)
            }
        };
    this.getCurrentStep = function () {
        return h
    };
    this.startFromBeginning = function () {
        d = true;
        h = f;
        a();
        h.begin()
    };
    this.inTutorialMode = function () {
        return d
    };
    this.end = function () {
        d = false;
        e()
    };
    this.gotoNextStep = function () {
        h = b[h.nextStepName];
        a();
        h.begin()
    };
    this.gotoStep = function (i) {
        if (b[i]) {
            h = b[i];
            a();
            h.begin()
        }
    };
    this.init = function (m) {
        var k, j, l;
        for (k = 0; k < m.length; k++) {
            j = m[k];
            l = new cm.TutorialStep(j);
            g(l)
        }
    };
    var e = function () {
            for (var i in b) {
                delete b[i]
            }
            cm.TutorialEventDispatcher.clearAll()
        }
};
cm.TutorialEventDispatcher = new function () {
    var a = this;
    var b = {};
    this.addEventListener = function (d, c) {
        b[d] = c
    };
    this.dispatchTutorialEvent = function (e, c) {
        var d = b[e];
        if (d && d.name == c) {
            var f = d.events[e];
            if (typeof (f) == "function") {
                f()
            }
        }
    };
    this.clearAll = function () {
        for (var c in b) {
            delete b[c]
        }
    }
};
cm.UnlockController = function (e) {
    var a;
    var b;
    var d = function (g) {
            cm.guardianModalView.rerender();
            cm.UnlockView.render();
            cm.UnlockView.addGlassPane({
                showTimer: true,
                timer: parseInt(g.finishTime) - unixtime()
            });
            b = parseInt(g.finishTime) - unixtime();
            a = g.summonFinishCallback;
            var f = cm.guardianModalModel.gObj()
        };

    function c() {
        b--;
        if (b < -4) {
            return false
        }
        if (b < 0) {
            a();
            var f = cm.guardianModalView.rerender();
            if (f) {
                cm.UnlockView.removeGlassPane();
                cm.UnlockView.show()
            }
            cm.guardianCity.rerender(true);
            cm.guardianModalModel.gObj().finishTime = undefined
        }
        if (b > 0 && e(".guardianGlassPane").length == 0) {
            cm.UnlockView.addGlassPane({
                showTimer: true,
                timer: b
            })
        }
        e(".timerContainer .timer").html(g_js_strings.guardian.summoning + timestr(b))
    }
    return {
        bind: function () {
            e(".unlock_button").unbind("click").bind("click", function () {
                var f = cm.guardianTransformModel.getData(e(this).attr("guardian_type"));
                cm.guardianTransformView.rerender(f)
            });
            e(".summon_button").unbind("click").bind("click", function () {
                var g = e(this).attr("guardian_type");
                var j = false;
                var k = (Object.keys(seed.queue_atkinc).length > 0);
                var i = seed.queue_atkp["city" + currentcityid];
                for (var f in i) {
                    if (i[f].marchType == cm.MARCH_TYPES.MARCH_TYPE_ATTACK && i[f].marchStatus == cm.MARCH_STATUS.MARCH_STATUS_OUTBOUND) {
                        j = true;
                        break
                    }
                }
                var h = e(".sprite_button_20.active").attr("guardian_type");
                cm.log.l("currentType=" + h + "  atkWarning=" + j + "   incWarning=" + k);
                if (h == "wood" && k) {
                    cm.ModalManager.alert({
                        button_text: g_js_strings.commonstr.summon_text,
                        text: g_js_strings.guardian.summonWarningWood,
                        exe: function () {
                            cm.guardianSummonModel.summon(g, d)
                        }
                    })
                } else {
                    cm.guardianSummonModel.summon(g, d)
                }
            });
            if (cm.guardianModalModel.getData().isSummoning) {
                b = parseInt(cm.guardianModalModel.getData().summonFinishTime) - unixtime()
            }
        },
        register: function () {
            cm.timer.register("summonTimer", c)
        },
        setTimer: function () {
            var h;
            var g = cm.guardianModalModel.gObj();
            if (g.summonGuardian && g.summonGuardian.summonFinishTime) {
                h = g.summonGuardian.summonFinishTime;
                var f = parseInt(h) - unixtime();
                if (f < 0) {
                    b = -1;
                    cm.log.l("guardian summoning about to happen/finish.")
                } else {
                    b = f;
                    cm.log.l("guardian summoning in the future.")
                }
            } else {
                b = -10;
                return false
            }
            cm.log.l("currentcityid=" + currentcityid + ", setting time to " + b);
            a = cm.guardianSummonModel.get_summon_finish(currentcityid)
        }
    }
}(jQuery);
cm.UnlockView = function (f) {
    var h = function (n, r) {
            var o = "";
            for (var m = 0; m < 4; m++) {
                if (r != n[m].type) {
                    var p = n[m].cl3.substr(4);
                    var q = a(n[m].cl3.substr(0, 4), true, 5);
                    o += p + ": " + q + "<br>"
                }
            }
            return o
        };

    function a(m, o, n) {
        if (o) {
            m = Math.round(m.replace("%", "").replace("+", "") * n) / 10;
            return m + "%"
        } else {
            return m
        }
    }

    function i() {
        var v = cm.guardianSummonModel.getData();
        var r = cm.guardianSummonModel.getAttrBonus();
        var t = cm.guardianSummonModel.getSetBonus();
        var o = t ? g_js_strings.guardian.setBonusAchieved : "<strong>" + g_js_strings.guardian.setBonus + "</strong><br>" + g_js_strings.guardian.permanentlyReduce;
        var u = cm.guardianModalModel.getType();
        var m = t ? g_js_strings.guardian.setBonusAchievedTooltip : g_js_strings.guardian.tooltipSetBonus;
        var p = t ? h(v, u) : g_js_strings.guardian.tooltipSetBonus;
        var q = (r && r.value ? r.value.substr(0, 4) : "");
        var n = a(q, t, 15);
        var s = "<div title='" + g_js_strings.guardian.tooltipAttr + "' class='icon wood'></div><div title='" + g_js_strings.guardian.tooltipAttr + "' class='wood_stat'>" + a(v[0].cl2.substr(0, 4), t && u == "wood", 15) + "</div><div title='" + g_js_strings.guardian.tooltipAttr + "' class='icon ore'></div><div title='" + g_js_strings.guardian.tooltipAttr + "' class='ore_stat'>" + a(v[1].cl2.substr(0, 4), t && u == "ore", 15) + "</div><div title='" + g_js_strings.guardian.tooltipAttr + "' class='icon food'></div><div title='" + g_js_strings.guardian.tooltipAttr + "' class='food_stat'>" + a(v[2].cl2.substr(0, 4), t && u == "food", 15) + "</div><div title='" + g_js_strings.guardian.tooltipAttr + "' class='icon stone " + (v[3] ? "sat" : "desat") + "'></div><div title='" + g_js_strings.guardian.tooltipAttr + "' class='stone_stat " + (v[3] ? "sat" : "desat") + "'>" + (v[3] ? a(v[3].cl2.substr(0, 4), t && u == "stone", 15) : "+0%") + "</div><div title='" + g_js_strings.guardian.tooltipAttrReceived + "' class='attribute " + (r && r.type ? r.type.toLowerCase() : "none") + "'></div><div title='" + g_js_strings.guardian.tooltipAttrReceived + "' class='attribute_stat'>" + n + "</div>";
        cm.custom_tooltips.appleTop = p;
        return "<div class='unlock_view'><div class='brown_top'></div><div class='brown_bottom'></div><div class='vanilla_middle'><div class='resource_top'>" + s + "</div></div><div class='apple_top " + (t ? "glow" : "") + "'  onmouseover=\"showClearingTooltip( this, event, 'appleTop' );return false;\"  onmouseout='removeTooltip(); return false;'></div><div class='cityGuardianName'>" + fUp(currentcityinfo[1]) + "'s " + g_js_strings.guardian.guardians + "</div><div class='guardian_collection'>" + b(v) + "</div><div class='arrow'></div><div class='apple_bottom" + (t ? " glow" : "") + "' title='" + m + "'>" + o + "</div></div>"
    }
    var c = {
        summon: "orange",
        active: "active",
        unlock: "blue"
    };
    var l = {
        0: "wood",
        1: "ore",
        2: "food",
        3: "stone"
    };
    var d = {
        wood: 0,
        ore: 1,
        food: 2,
        stone: 3
    };

    function b(n) {
        var r = "";
        var q = "";
        for (var m = 0; m < 4; m++) {
            var p = n[m] ? n[m].status : "";
            var o = cm.guardianConst.enabled_types[m];
            if (o && (p == "summon" || p == "unlock" || p == "active")) {
                q += cm.utilityView.button({
                    text: fUp(p),
                    color: c[p],
                    "class": "pos" + m + " " + p + "_button",
                    attributes: {
                        guardian_type: l[m]
                    }
                })
            } else {
                q += ""
            }
            r += e(o ? n[m] : null, m) + q
        }
        return r
    }
    var k = {
        wood: -430,
        food: -551,
        ore: -669,
        stone: -787
    };
    var j = {
        plate: 10,
        junior: -96,
        teenager: -198,
        adult: -300,
        adult2: -407,
        adult3: -490
    };
    var g = {
        0: j.plate,
        1: j.junior,
        2: j.junior,
        3: j.junior,
        4: j.teenager,
        5: j.teenager,
        6: j.adult,
        7: j.adult,
        8: j.adult,
        9: j.adult,
        10: j.adult2,
        11: j.adult3
    };

    function e(p, n) {
        if (p == null) {
            return "<div class='card card" + n + " noButton'><div class='greyStone middleGrey' title='" + g_js_strings.guardian.tooltipSummon_comingsoon + "'></div></div>"
        }
        var m = parseInt(p.level) == 0 && p.status == "unlock" ? 10 : parseInt(p.level);
        var o = g_js_strings.guardian["tooltipSummon_" + p.type];
        return "<div class='card card" + n + "'>" + (p.status == "unlock" ? "<div class='locked'></div>" : "") + "<div title='" + o + "' class='pic " + p.type + "' style='background: url(" + stimgUrl + "img/guardian_change_spritemap102.png) no-repeat scroll " + g[m] + "px " + k[p.type] + "px;'></div><div class='cl0'>" + g_js_strings.guardian.level + " " + p.level + "</div><div class='cl2'>" + p.cl2 + "</div><div class='cl3'>" + p.cl3 + "</div></div>"
    }
    return {
        addGlassPane: function (m) {
            if (f(".guardianGlassPane").length == 0) {
                f(".unlock_view").append("<div class='guardianGlassPane'></div>" + (m.showTimer ? "<div class='timerContainer'><div class='timer'></div></div>" : ""));
                f(".guardianModal .rightBottom.upr").addClass("notclickable2")
            }
        },
        removeGlassPane: function () {
            f(".guardianGlassPane, .timerContainer").remove();
            f(".guardianModal .rightBottom.upr").removeClass("notclickable2")
        },
        render: function () {
            if (cm.WorldSettings.isOn("GUARDIAN_SUMMON")) {
                if (cm.guardianModalModel.upgrading()) {
                    cm.UnlockView.show();
                    cm.UnlockView.addGlassPane({
                        showTimer: false
                    })
                } else {
                    if (cm.guardianSummonModel.getSummonGuardian()) {
                        cm.UnlockView.show();
                        cm.UnlockView.addGlassPane({
                            showTimer: true
                        })
                    } else {
                        cm.UnlockView.removeGlassPane();
                        cm.UnlockView.show()
                    }
                }
            }
        },
        show: function () {
            f(".unlock_view").remove();
            f(".guardianModal").append(i());
            cm.UnlockController.bind()
        }
    }
}(jQuery);
var g_update_seed_ajax_do = false;

function update_seed_ajax(marchForceUpdateFlag, updateSeedDoneCallback) {
    if (g_update_seed_ajax_do) {
        return false
    }
    g_update_seed_ajax_do = true;
    var params = Object.clone(g_ajaxparams);
    if (marchForceUpdateFlag) {
        params.forceUpdate = true
    } else {
        params.forceUpdate = false
    }
    var startTime = cm.util.clientTime();
    var profiler = null;
    if (Math.random() < 0.01) {
        profiler = new cm.Profiler("ResponseTime", "updateSeed.php" + (marchForceUpdateFlag ? "_ForceUpdate" : ""))
    }
    new Ajax.Request(g_ajaxpath + "ajax/updateSeed.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (message) {
            if (profiler) {
                profiler.stop()
            }
            var endTime = cm.util.clientTime();
            g_update_seed_ajax_do = false;
            var rslt = eval("(" + message.responseText + ")");
            if (rslt.ok) {
                cm.epochTimeOffset.update(rslt.reqmicrotime, endTime - startTime);
                if (rslt.victoryTokenId) {
                    pop_treasure_chest_modal(rslt.victoryTokenId.m)
                }
                if (rslt.updateMarch) {
                    update_march(rslt.updateMarch)
                }
                if (rslt.updateInventory) {
                    update_inventory(rslt.updateInventory)
                }
                if (rslt.updateWildDef) {
                    update_wild_def(rslt.updateWildDef)
                }
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
                var msgbug = false;
                if (rslt.additionalNewTradeReportCnt) {
                    seed.newTradeReports = parseInt(seed.newTradeReports) + parseInt(rslt.additionalNewTradeReportCnt);
                    msgbug = true
                }
                if (rslt.newReportCount) {
                    seed.newReportCount = parseInt(rslt.newReportCount);
                    seed.newDisasterReportCount = parseInt(rslt.newDisasterReportCount);
                    msgbug = true
                }
                if (rslt.newMailCount) {
                    if (parseInt(seed.newMailCount) < parseInt(rslt.newMailCount)) {
                        cm.sounds.play("player_recieves_new_message_inbox")
                    }
                    seed.newMailCount = parseInt(rslt.newMailCount);
                    msgbug = true
                }
                if (msgbug) {
                    messages_notify_bug()
                }
                if (rslt.updateHelpConstruct) {
                    update_help_construct(rslt.updateHelpConstruct)
                }
                if (rslt.updateHelpResearch) {
                    update_help_research(rslt.updateHelpResearch)
                }
                if (rslt.allianceDiplomacies) {
                    seed.allianceDiplomacies = rslt.allianceDiplomacies
                }
                if (rslt.updateMight) {
                    seed.player.might = parseInt(rslt.updateMight);
                    update_might()
                }
                if (rslt.updateCityUnits) {
                    update_cityUnits(rslt.updateCityUnits)
                }
                if (rslt.updateSeed && rslt.updateSeed.guardian && rslt.updateSeed.guardian[parseInt(currentcityid)] && rslt.updateSeed.guardian[parseInt(currentcityid)].cityGuardianLevels) {
                    var guardianLevels = rslt.updateSeed.guardian[parseInt(currentcityid)].cityGuardianLevels;
                    cm.guardianModalModel.updateCityGuardianLevelsReplace(guardianLevels)
                }
                var gw = rslt.gloryWonItem;
                if (gw && cm.WorldSettings.isOn("GLORY_FE") && cm.WorldSettings.isOn("GLORY_WIN_ITEMS")) {
                    if (ksoItems[gw]) {
                        cm.sounds.play("player_recieves_rare_drop_after_combat");
                        var item = ksoItems[gw];
                        item.add();
                        cm.WonGloryItemView.alert(gw)
                    } else {
                        cm.log.l("Glory won unrecognized ksoItem.")
                    }
                }
                cm.GloryView.topNavGlory(rslt.updateGlory || 0);
                if (undefined != rslt.truceExpireUnixTime) {
                    seed.player.truceExpireUnixTime = rslt.truceExpireUnixTime
                } else {
                    delete seed.player.truceExpireUnixTime
                }
                if (updateSeedDoneCallback) {
                    updateSeedDoneCallback()
                }
            } else {
                if (rslt.error_code == 999) {
                    top.location = appUrl
                } else {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                }
            }
            if (rslt.arthurCheckArray) {
                arthurCheck(rslt.arthurCheckArray)
            }
        },
        onFailure: function () {
            if (profiler) {
                profiler.stop()
            }
            g_update_seed_ajax_do = false
        }
    })
}

function update_wild_def(a) {
    var c = Object.keys(a);
    for (var b = 0; b < c.length; b++) {
        seed.wildDef[c[b]] = a[c[b]]
    }
}

function update_inventory(b) {
    var c = Object.keys(b);
    for (var a = 0; a < c.length; a++) {
        if (seed.items["i" + c[a]]) {
            seed.items["i" + c[a]] = parseInt(seed.items["i" + c[a]]) + 1;
            ksoItems[c[a]].add()
        } else {
            seed.items["i" + c[a]] = 1
        }
    }
}

function update_cityUnits(a) {
    var g = Object.keys(a);
    for (var c = 0; c < g.length; c++) {
        var f = Object.keys(a[g[c]]);
        var e = g[c].split("c")[1];
        for (var b = 0; b < f.length; b++) {
            var d = f[b].split("u")[1];
            seed.units["city" + e]["unt" + d] = parseInt(a[g[c]][f[b]])
        }
    }
    if ($("cityinfo_3").visible()) {
        cityinfo_changetab(3)
    }
}

function update_help_research(m) {
    var a = Object.keys(m)[0];
    var e = m[a];
    var l = Object.keys(e)[0];
    var c = parseInt(e[l].t);
    var o = parseInt(e[l].n) + parseInt(e[l].a);
    var k = parseInt(seed.updateHelpResearch[a][l].a) + parseInt(seed.updateHelpResearch[a][l].n);
    if (k > 0) {
        o = o - k
    }
    seed.updateHelpResearch[a] = e;
    var n = Object.keys(seed.queue_tch);
    for (var g = 0; g < n.length; g++) {
        for (var f = 0; f < seed.queue_tch[n[g]].length; f++) {
            if (parseInt(seed.queue_tch[n[g]][f][0]) == c) {
                var b = parseInt(seed.queue_tch[n[g]][f][3]) - parseInt(seed.queue_tch[n[g]][f][2]);
                var d = parseInt(b * 0.01);
                var h = 60;
                var p = Math.max(d, h);
                seed.queue_tch[n[g]][f][2] = parseInt(seed.queue_tch[n[g]][f][2]) - p * o;
                seed.queue_tch[n[g]][f][3] = parseInt(seed.queue_tch[n[g]][f][3]) - p * o;
                break
            }
        }
    }
}

function update_help_construct(p) {
    var a = Object.keys(p)[0];
    var l = p[a];
    var d = Object.keys(l)[0];
    var f = parseInt(l[d].b);
    var n = parseInt(l[d].n) + parseInt(l[d].a);
    var k = parseInt(seed.updateHelpConstruct[a][d].a) + parseInt(seed.updateHelpConstruct[a][d].n);
    if (k > 0) {
        n = n - k
    }
    seed.updateHelpConstruct[a] = l;
    var m = Object.keys(seed.queue_con);
    for (var g = 0; g < m.length; g++) {
        for (var e = 0; e < seed.queue_con[m[g]].length; e++) {
            if (parseInt(seed.queue_con[m[g]][e][2]) == f) {
                var b = parseInt(seed.queue_con[m[g]][e][4]) - parseInt(seed.queue_con[m[g]][e][3]);
                var c = parseInt(b * 0.01);
                var h = 60;
                var o = Math.max(c, h);
                seed.queue_con[m[g]][e][3] = parseInt(seed.queue_con[m[g]][e][3]) - o * n;
                seed.queue_con[m[g]][e][4] = parseInt(seed.queue_con[m[g]][e][4]) - o * n;
                break
            }
        }
    }
}

function update_march(f) {
    var F = Object.keys(f),
        m = false,
        a, d;
    for (var R = 0; R < F.length; R++) {
        var C = Object.keys(f[F[R]]);
        for (var Q = 0; Q < C.length; Q++) {
            var O = f[F[R]][C[Q]];
            for (var G = 0; G < O.length; G++) {
                var D = f[F[R]][C[Q]][G];
                var s = parseInt(D.marchStatus);
                var h = F[R].split("c")[1];
                var c = C[Q].split("m")[1];
                var t = "city" + h;
                var o = C[Q];
                var v;
                var K = D.marchType;
                if (D.throneRoomDrop) {
                    cm.log.l("l_marchReport.throneRoomDrop exists id=" + D.throneRoomDrop.id);
                    cm.ThroneController.addItem(D.throneRoomDrop)
                } else {
                    cm.log.l("l_marchReport.throneRoomDrop does not exist")
                }
                if (D.score != undefined && !seed.queue_atkp["city" + h][C[Q]]) {
                    if (Object.isArray(seed.queue_atkinc)) {
                        seed.queue_atkinc = new Object
                    }
                    seed.queue_atkinc[C[Q]] = D;
                    v = new cm.IncomingAttack(D);
                    cm.IncomingAttackManager.add(v);
                    if (D.players) {
                        var S = D.players;
                        var p = Object.keys(S)[0];
                        if (!seed.players[p]) {
                            seed.players[p] = S[p]
                        }
                    }
                } else {
                    if (seed.queue_atkinc[o] && (s == cm.MARCH_STATUS.MARCH_STATUS_INACTIVE || s == cm.MARCH_STATUS.MARCH_STATUS_ABORTING)) {
                        var w = cm.IncomingAttackManager.getAllAttacks();
                        if (w) {
                            v = w.getElementByKey(c.toString());
                            if (v) {
                                v.setMarchStatus(D.marchStatus)
                            }
                        }
                        if (seed.queue_atkinc[o]) {
                            delete seed.queue_atkinc[o];
                            if (Object.keys(seed.queue_atkinc).length == 0) {
                                seed.queue_atkinc = []
                            }
                        }
                    } else {
                        if (D.updateAttackInc) {
                            seed.queue_atkinc[C[Q]].departureTime = D.marchUnixTime;
                            seed.queue_atkinc[C[Q]].arrivalTime = D.destinationUnixTime;
                            seed.queue_atkinc[C[Q]].returnUnixTime = D.returnUnixTime
                        } else {
                            if (D.transportUnitReturn) {
                                if (seed.queue_atkp["city" + h]["m" + c]) {
                                    seed.queue_atkp["city" + h]["m" + c]["unit9Return"] = D.transportUnitReturn
                                }
                            }
                            if (D.fght) {
                                var l = D.fght.s1;
                                var L = Object.keys(l);
                                for (var P = 0; P < L.length; P++) {
                                    if (seed.queue_atkp["city" + h]["m" + c]) {
                                        seed.queue_atkp["city" + h]["m" + c]["unit" + (L[P].split("u")[1]) + "Return"] = l[L[P]][1]
                                    } else {
                                        seed.units["city" + h]["unt" + L[P].split("u")[1]] = parseInt(seed.units["city" + h]["unt" + L[P].split("u")[1]]) + parseInt(l[L[P]][1])
                                    }
                                }
                            }
                            if (D.conquered && parseInt(D.conquered) == 1) {
                                if (Object.isArray(seed.queue_atkp["city" + h]) || !seed.queue_atkp["city" + h]["m" + c]) {
                                    seed.queue_atkp["city" + h]["m" + c] = {
                                        marchStatus: cm.MARCH_STATUS.MARCH_STATUS_DEFENDING
                                    }
                                } else {
                                    seed.queue_atkp["city" + h]["m" + c].marchStatus = cm.MARCH_STATUS.MARCH_STATUS_DEFENDING
                                }
                                if (seed.queue_atkp["city" + h]["m" + c] && parseInt(seed.queue_atkp["city" + h]["m" + c].toTileType) != cm.TILE_TYPES.TILE_TYPE_CITY && parseInt(seed.queue_atkp["city" + h]["m" + c].toTileType) != cm.TILE_TYPES.TILE_TYPE_RUIN) {
                                    var T = seed.queue_atkp["city" + h]["m" + c].toTileId;
                                    if (Object.isArray(seed.wilderness)) {
                                        seed.wilderness = {}
                                    }
                                    if (!seed.wilderness["city" + h]) {
                                        seed.wilderness["city" + h] = {}
                                    }
                                    if (!seed.wilderness["city" + h]["t" + T]) {
                                        seed.wilderness["city" + h]["t" + T] = {
                                            tileId: T,
                                            xCoord: seed.queue_atkp["city" + h]["m" + c].toXCoord,
                                            yCoord: seed.queue_atkp["city" + h]["m" + c].toYCoord,
                                            tileType: seed.queue_atkp["city" + h]["m" + c].toTileType,
                                            tileLevel: seed.queue_atkp["city" + h]["m" + c].toTileLevel
                                        }
                                    }
                                }
                                g_mapObject.getMoreSlots()
                            } else {
                                if (s == cm.MARCH_STATUS.MARCH_STATUS_DEFENDING) {
                                    if (seed.queue_atkp["city" + h]["m" + c]) {
                                        seed.queue_atkp["city" + h]["m" + c].marchStatus = cm.MARCH_STATUS.MARCH_STATUS_DEFENDING;
                                        for (var P in cm.UNIT_TYPES) {
                                            P = cm.UNIT_TYPES[P];
                                            seed.queue_atkp["city" + h]["m" + c]["unit" + P + "Return"] = seed.queue_atkp["city" + h]["m" + c]["unit" + P + "Count"]
                                        }
                                    }
                                } else {
                                    if (s == cm.MARCH_STATUS.MARCH_STATUS_INACTIVE) {
                                        var q = seed.queue_atkp["city" + h]["m" + c];
                                        if (q) {
                                            var x = 0;
                                            for (var P = 0; P < seed.cities.length; P++) {
                                                if (parseInt(seed.cities[P][2]) == parseInt(q.toXCoord) && parseInt(seed.cities[P][3]) == parseInt(q.toYCoord)) {
                                                    x = seed.cities[P][0];
                                                    P = seed.cities.length
                                                }
                                            }
                                            if (x != 0) {
                                                if (q.marchStatus != cm.MARCH_STATUS.MARCH_STATUS_RETURNING) {
                                                    for (var P in cm.UNIT_TYPES) {
                                                        P = cm.UNIT_TYPES[P];
                                                        seed.units["city" + x]["unt" + P] = parseInt(seed.units["city" + x]["unt" + P]) + parseInt(q["unit" + P + "Count"])
                                                    }
                                                    if (parseInt(q.knightId) != 0) {
                                                        seed.knights["city" + x] = seed.knights["city" + x] || {};
                                                        seed.knights["city" + x]["knt" + q.knightId] = seed.knights["city" + q.fromCityId]["knt" + q.knightId];
                                                        seed.knights["city" + x]["knt" + q.knightId].knightStatus = 1;
                                                        delete seed.knights["city" + q.fromCityId]["knt" + q.knightId]
                                                    }
                                                    seed.citystats["city" + x].gold[0] = parseInt(seed.citystats["city" + x].gold[0]) + parseInt(q.gold);
                                                    for (var P = 1; P < 5; P++) {
                                                        seed.resources["city" + x]["rec" + P][0] = parseInt(seed.resources["city" + x]["rec" + P][0]) + (3600 * parseInt(seed.queue_atkp["city" + h]["m" + c]["resource" + P]))
                                                    }
                                                }
                                            }
                                            seed.queue_atkp["city" + h]["m" + c].hasUpdated = true;
                                            if (Object.keys(seed.queue_atkp["city" + h]).length == 0) {
                                                seed.queue_atkp["city" + h] = []
                                            }
                                        }
                                    } else {
                                        if (s == cm.MARCH_STATUS.MARCH_STATUS_RESTING || s == cm.MARCH_STATUS.MARCH_STATUS_STOPPED) {
                                            var q = seed.queue_atkp["city" + h]["m" + c];
                                            if (!q) {
                                                continue
                                            }
                                            q.marchStatus = s;
                                            if (s == cm.MARCH_STATUS.MARCH_STATUS_STOPPED && D.botMarchStatus == cm.BOT_STATUS.BOT_MARCH_STOPPED) {
                                                q.botMarchStatus = D.botMarchStatus;
                                                seed.knights["city" + h]["knt" + q.knightId].knightStatus = 1;
                                                var U = seed.units["city" + h];
                                                for (var J in cm.UNIT_TYPES) {
                                                    J = cm.UNIT_TYPES[J];
                                                    var y = parseInt(q["unit" + J + "Return"]);
                                                    if (!isNaN(y) && (y > 0)) {
                                                        U["unt" + J] = parseInt(U["unt" + J]) + y
                                                    }
                                                }
                                                m = true
                                            }
                                        } else {
                                            if (D.fromPlayerId == tvuid) {
                                                try {
                                                    var A = Object.keys(D);
                                                    var n = D.fromCityId;
                                                    if (D.marchType == cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN && s == cm.MARCH_STATUS.MARCH_STATUS_OUTBOUND) {
                                                        var H = {};
                                                        var M = true;
                                                        do {
                                                            var r = seed.queue_atkp["city" + n][C[Q]];
                                                            if (undefined == r) {
                                                                break
                                                            }
                                                            switch (parseInt(r.botMarchStatus)) {
                                                            case cm.BOT_STATUS.BOT_MARCH_MARCHING:
                                                            case cm.BOT_STATUS.BOT_MARCH_RETURNING:
                                                            case cm.BOT_STATUS.BOT_MARCH_RESTING:
                                                                M = false;
                                                                break
                                                            }
                                                        } while (false);
                                                        if (M) {
                                                            for (a in cm.UNIT_TYPES) {
                                                                d = cm.UNIT_TYPES[a];
                                                                var E = parseInt(D["unit" + d + "Count"]);
                                                                if (!isNaN(E)) {
                                                                    H[d] = E
                                                                }
                                                            }
                                                        }
                                                        attach_addoutgoingmarch(D.marchId, Math.floor(D.marchTimestamp), Math.floor(D.destinationEta), D.toXCoord, D.toYCoord, H, cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN, D.knightId, [0, 0, 0, 0, 0], D.toTileId, D.toTileType, D.toTileLevel, n, M);
                                                        m = true
                                                    }
                                                    for (var B = 0; B < A.length; B++) {
                                                        if (typeof (seed.queue_atkp["city" + n][C[Q]][A[B]]) == "undefined") {
                                                            seed.queue_atkp["city" + n][C[Q]][A[B]] = D[A[B]]
                                                        }
                                                    }
                                                    var N = C[Q].substring(1);
                                                    seed.queue_atkp["city" + n][C[Q]]["marchId"] = N
                                                } catch (V) {}
                                            } else {
                                                if (!D.marchUnixTime || parseInt(seed.queue_atkp["city" + h]["m" + c].marchUnixTime) == parseInt(D.marchUnixTime)) {
                                                    try {
                                                        var q = seed.queue_atkp["city" + h]["m" + c];
                                                        q.marchStatus = cm.MARCH_STATUS.MARCH_STATUS_RETURNING;
                                                        q.hasUpdated = true;
                                                        var g = parseInt(q.marchType);
                                                        if (g == cm.MARCH_TYPES.MARCH_TYPE_TRANSPORT) {
                                                            for (var P in cm.UNIT_TYPES) {
                                                                P = cm.UNIT_TYPES[P];
                                                                q["unit" + P + "Return"] = q["unit" + P + "Count"]
                                                            }
                                                        } else {
                                                            if (g == cm.MARCH_TYPES.MARCH_TYPE_REINFORCE || g == cm.MARCH_TYPES.MARCH_TYPE_BOT_BARBARIAN || g == cm.MARCH_TYPES.MARCH_TYPE_ATTACK) {
                                                                for (var P in cm.UNIT_TYPES) {
                                                                    P = cm.UNIT_TYPES[P];
                                                                    if (D["unit" + P + "Return"] != undefined) {
                                                                        q["unit" + P + "Return"] = parseInt(D["unit" + P + "Return"])
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        if (seed.playerEffects.returnExpire > unixtime()) {
                                                            var b = parseInt(seed.queue_atkp["city" + h]["m" + c].returnUnixTime);
                                                            var I = parseInt(seed.queue_atkp["city" + h]["m" + c].destinationUnixTime);
                                                            seed.queue_atkp["city" + h]["m" + c].returnUnixTime = parseInt(0.5 * (b - I)) + I
                                                        }
                                                    } catch (V) {}
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    if (m) {
        cityinfo_army()
    }
    return true
}

function update_seed(k) {
    if (k == null || (Object.isArray(k) && k.length == 0)) {
        return false
    }
    var h = Object.keys(k.city);
    var a = unixtime();
    for (var e = 0; e < h.length; e++) {
        var g = h[e];
        var f = k.city[g].production;
        if (f.population) {
            seed.citystats["city" + g].pop[0] = parseInt(f.population)
        }
        if (f.populationCap) {
            seed.citystats["city" + g].pop[1] = parseInt(f.populationCap)
        }
        if (f.gold) {
            seed.citystats["city" + g].gold[0] = parseInt(f.gold)
        }
        for (var d = 1; d < 5; d++) {
            if (f["resource" + d + "x3600"] != undefined) {
                seed.resources["city" + g]["rec" + d][0] = parseInt(f["resource" + d + "x3600"])
            }
            if (f["resource" + d + "Productivity"] != undefined) {
                seed.resources["city" + g]["rec" + d][2] = parseInt(f["resource" + d + "Productivity"])
            }
            if (f["resource" + d + "Capx3600"] != undefined) {
                seed.resources["city" + g]["rec" + d][1] = parseInt(f["resource" + d + "Capx3600"])
            }
            if (f["resource" + d + "Upkeep"] != undefined) {
                var c = 1;
                if ((d == 1) && (seed.playerEffects.troopUpkeepReductExp > a)) {
                    c = 0.5
                }
                var b = parseInt(f["resource" + d + "Upkeep"]) * c;
                seed.resources["city" + g]["rec" + d][3] = b
            }
        }
        if (f.happiness) {
            seed.citystats["city" + g].pop[2] = parseInt(f.happiness)
        }
        if (f.AETHERSTONE != undefined) {
            seed.resources["city" + g]["rec5"][0] = parseInt(f.AETHERSTONE)
        }
    }
    update_gold();
    update_pop();
    return true
}
cm.epochTimeOffset = function () {
    var a = 10;
    return {
        update: function (c, b) {
            if (b < a) {
                g_timeoff = parseInt(c - cm.util.clientTime());
                a = b
            }
        }
    }
}();
if (!window.UserEngagement) {
    var UserEngagement = new Object()
}
UserEngagement.Properties = {
    exa: null,
    viralModal: false
};
UserEngagement.Methods = {
    popup: function (b) {
        if (b) {
            this.exa = b
        }
        if ((Modal.modalid && Modal.modalid > 0) || (cm.TutorialManager.inTutorialMode())) {
            return false
        } else {
            if (Math.floor(Math.random() * 2) == 1) {
                var a = getNextAvailableCase();
                if (!a) {
                    if (!readCookie("uep_court") && !readCookie("uep_feed")) {
                        if (Math.floor(Math.random() * 2) == 1) {
                            pop_friend_court()
                        } else {
                            pop_action_feed_modal()
                        }
                    }
                } else {
                    pop_information_message(a)
                }
            } else {
                return false
            }
        }
    },
    popCastleTwoModal: function () {
        var b = g_js_strings.pop_castle_two_modal.castledesc;
        var c = "<img src='" + stimgUrl + "img/alliance_icon.png' />";
        var a = "<a onclick='Modal.hideModal();return false;' class='inlineButton brown20'><span>" + g_js_strings.commonstr.skip + "</span></a>";
        a += "<a onclick='Modal.hideModal();cm.invite.load(cm.InviteTypes.INVITE_TYPE_CASTLE_LV_2);cm.invite.open();' class='inlineButton blue20'><span>" + g_js_strings.pop_castle_two_modal.castlerecommend + "</span></a>";
        Modal.showModalUEP2(b, a, c)
    },
    popSuggestInviteModal: function () {
        if (cm.feedTracking.get("popSuggestInviteModal") !== false) {
            var b = g_js_strings.pop_suggest_invite_modal.invitedesc;
            var c = "<img src='" + stimgUrl + "img/alliance_icon.png' />";
            var a = "<a onclick='Modal.hideModal();cm.invite.load(cm.InviteTypes.INVITE_TYPE_SUGGEST_INVITE);cm.invite.open();' class='button20'><span>" + g_js_strings.pop_suggest_invite_modal.invitefriend + "</span></a>";
            cm.feedTracking.setFalse("popSuggestInviteModal");
            Modal.showModalUEP(b, a, c)
        }
    },
    popActionFeedModal: function () {
        var params = Object.clone(g_ajaxparams);
        new Ajax.Request(g_ajaxpath + "ajax/rollFriendChance.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok && parseInt(rslt.feedType) > 0) {
                    switch (parseInt(rslt.feedType)) {
                    case 201:
                        var evtdesc = g_js_strings.pop_action_feed_modal.fairedesc2;
                        var evtbtns = "<a onclick='Modal.hideModal();pop_action_feed();return false;' class='button20 sendfriendbtn' style='width:158px;'><span>" + g_js_strings.pop_action_feed_modal.faireShareButton + "</span></a>";
                        var evtimg = "<img src='" + stimgUrl + "img/traveling_faire_icon.png' />";
                        break;
                    default:
                        var evtdesc = "";
                        var evtbtns = "";
                        var evtimg = "";
                        break
                    }
                    if (evtdesc != "" && cm.feedTracking.get("fairedesc2") !== false) {
                        cm.feedTracking.setFalse("fairedesc2");
                        Modal.showModalUEP(evtdesc, evtbtns, evtimg);
                        createCookie("uep_feed", "uep_feed", 15)
                    }
                }
            },
            onFailure: function () {}
        })
    },
    popActionFeed: function () {
        var params = Object.clone(g_ajaxparams);
        new Ajax.Request(g_ajaxpath + "ajax/postFriendChance.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    var replarr = new Array();
                    replarr.push(["REPLACE_fEeDiD", rslt.feedId]);
                    var clonedTemp = Object.cloneFeed(template_data_201);
                    var clonedAction = Object.cloneFeed(actionlink_data_201);
                    common_postToProfile("201", clonedTemp, clonedAction, continuation_201, replarr)
                }
            },
            onFailure: function () {}
        })
    },
    popInformationMessage: function (a) {
        Modal.showModalUEP(a.evtdesc, a.evtbtns, a.evtimg);
        createCookie("uep_" + a.evtid, "uep_" + a.evtid, (24 * 60))
    },
    popFriendCourt: function () {
        if (seed.appFriends) {
            var friendlist = Object.keys(seed.appFriends);
            var qualFriends = new Array();
            for (var i = 0; i < friendlist.length; i++) {
                if (seed.appFriends[friendlist[i]].userId && !seed.appFriends[friendlist[i]].dailyActionFlag) {
                    qualFriends.push(seed.appFriends[friendlist[i]])
                }
            }
            if (qualFriends.length > 0) {
                var randomIdx = Math.floor(Math.random() * qualFriends.length);
                var params = Object.clone(g_ajaxparams);
                params.pid = qualFriends[randomIdx].userId;
                new Ajax.Request(g_ajaxpath + "ajax/viewCourt.php" + g_ajaxsuffix, {
                    method: "post",
                    parameters: params,
                    onSuccess: function (transport) {
                        var rslt = eval("(" + transport.responseText + ")");
                        if (rslt.ok) {
                            if (rslt.dailyActionFlag == 0) {
                                var imgUrl = qualFriends[randomIdx].realPhoto || kraken.network.getNoPictureUrl();
                                var friendImg = "<div class='imgframe'><img src='" + imgUrl + "'/></div>";
                                var friendTxt = (qualFriends[randomIdx].playerSex == "M") ? g_js_strings.commonstr.lord : g_js_strings.commonstr.lady;
                                friendTxt += " ";
                                friendTxt += g_js_strings.pop_action_feed_modal.cordialvisitcourtdesc.replace("%1$s", qualFriends[randomIdx].displayName);
                                var friendBtns = "<a class='button25' onclick='Modal.hideModal();changeview_court(" + qualFriends[randomIdx].userId + ");return false;'><span>" + g_js_strings.commonstr.visit + "</span></a>";
                                Modal.showModalUEP(friendTxt, friendBtns, friendImg);
                                createCookie("uep_court", "uep_court", 15)
                            } else {
                                seed.appFriends[qualFriends[randomIdx].userId].dailyActionFlag = true;
                                pop_action_feed_modal()
                            }
                        } else {
                            pop_action_feed_modal()
                        }
                    },
                    onFailure: function () {
                        pop_action_feed_modal()
                    }
                })
            } else {
                pop_action_feed_modal()
            }
        } else {
            pop_action_feed_modal()
        }
    },
    popViralModalUEP: function (pos) {
        if (!cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON") && this.viralModal && !readCookie("uep_viral_action")) {
            if ((cm.TutorialManager.inTutorialMode())) {
                return false
            } else {
                var params = Object.clone(g_ajaxparams);
                new Ajax.Request(g_ajaxpath + "ajax/pickViralUEP.php" + g_ajaxsuffix, {
                    method: "post",
                    parameters: params,
                    onSuccess: function (transport) {
                        var rslt = eval("(" + transport.responseText + ")");
                        if (rslt.ok) {
                            if (rslt.type == 3) {
                                UserEngagement.popGiftReminder(pos)
                            } else {
                                if (rslt.type == 2) {
                                    UserEngagement.popAttractAllies(pos)
                                } else {
                                    if (rslt.type == 1) {
                                        UserEngagement.popInviteFriends(pos)
                                    }
                                }
                            }
                            createCookie("uep_viral_action", "uep_viral_action", (4 * 60))
                        }
                    },
                    onFailure: function () {}
                })
            }
        }
    },
    popInviteFriends: function (c) {
        var b = g_js_strings.popViralModalUEP.invitedesc;
        var a = "<a onclick='Modal.hideModal();return false;' class='buttonDown20' style='margin-left:10px;'><span>" + g_js_strings.commonstr.skip + "</span></a>";
        a += "<a onclick='Modal.hideModal();cm.invite.load(cm.InviteTypes.INVITE_TYPE_VIRALUEP_0);cm.invite.open();' class='button20'><span>" + g_js_strings.popViralModalUEP.inviteyourfriends + "</span></a>";
        Modal.showModalUEP(b, a, "", c)
    },
    popAttractAllies: function (c) {
        var b = g_js_strings.popViralModalUEP.attractalliesdesc;
        var a = "<a onclick='Modal.hideModal();return false;' class='buttonDown20' style='margin-left:10px;'><span>" + g_js_strings.commonstr.skip + "</span></a>";
        a += "<a onclick='Modal.hideModal();cm.invite.load(cm.InviteTypes.INVITE_TYPE_VIRALUEP_1);cm.invite.open();' class='button20'><span>" + g_js_strings.popViralModalUEP.inviteyourfriends + "</span></a>";
        Modal.showModalUEP(b, a, "", c)
    },
    popGiftReminder: function (c) {
        var b = g_js_strings.popViralModalUEP.giftreminddesc;
        var a = "<a onclick='Modal.hideModal();return false;' class='buttonDown20' style='margin-left:10px;'><span>" + g_js_strings.commonstr.skip + "</span></a>";
        a += "<a target='_top' href='" + viralGiftReminderUrl + "' onclick='Modal.hideModal();' class='button20'><span>" + g_js_strings.popViralModalUEP.sendfreegifts + "</span></a>";
        Modal.showModalUEP(b, a, "", c)
    },
    popTreasureChestModal: function (a) {
        if (cm.feedTracking.get("popTreasureChestModal") === false) {
            return false
        }
        if (Modal.modalid && Modal.modalid > 0) {
            return false
        } else {
            cm.feedTracking.setFalse("popTreasureChestModal");
            var c = g_js_strings.pop_treasure_chest_modal.chestdesc;
            var b = "<a onclick='Modal.hideModal();pop_treasure_chest(" + parseInt(a) + ");return false;' class='button20'><span>" + g_js_strings.pop_treasure_chest_modal.sharewithfriends + "</span></a>";
            var d = "<img src='" + stimgUrl + "img/treasurechest_icon.png' />";
            Modal.showModalUEP(c, b, d)
        }
    },
    popTreasureChest: function (tid) {
        var mid = tid;
        var params = Object.clone(g_ajaxparams);
        params.tid = tid;
        new Ajax.Request(g_ajaxpath + "ajax/postFriendVictoryTokenShare.php" + g_ajaxsuffix, {
            method: "post",
            parameters: params,
            onSuccess: function (transport) {
                var rslt = eval("(" + transport.responseText + ")");
                if (rslt.ok) {
                    var replarr = new Array();
                    var tileName = (seed.queue_atkp["city" + currentcityid]["m" + mid].toTileType == 51) ? "Barbarian Camp" : g_mapObject.types[parseInt(seed.queue_atkp["city" + currentcityid]["m" + mid].toTileType)].capitalize();
                    replarr.push(["REPLACE_TiLeNaMe", tileName]);
                    replarr.push(["REPLACE_fEeDiD", rslt.feedId]);
                    replarr.push(["REPLACE_tOkEnId", rslt.tokenId]);
                    var clonedTemp = Object.cloneFeed(template_data_118);
                    var clonedAction = Object.cloneFeed(actionlink_data_118);
                    common_postToProfile("118", clonedTemp, clonedAction, continuation_118, replarr)
                } else {
                    Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
                }
            },
            onFailure: function () {}
        })
    },
    getBuildCompleteInviteQual: function (e) {
        return false;
        var c = false;
        var f = false;
        if (feeds_sent.indexOf("13") >= 0) {
            c = true
        } else {
            var a = Object.keys(seed.buildings);
            for (var b = 0; b < a.length; b++) {
                var d = new Hash(seed.buildings[a[b]]);
                d.each(function (i) {
                    if (i.value[0] != 0) {
                        var h = Math.pow(2, parseInt(i.value[1]));
                        var g = buildingcost["bdg" + i.value[0]][7] * h;
                        if (g > 60) {
                            f = true
                        }
                    }
                })
            }
        }
        if (e) {
            if (c || f) {
                return false
            } else {
                return true
            }
        } else {
            if (c || !f) {
                return false
            } else {
                return true
            }
        }
    },
    getNextAvailableCase: function () {
        var H = 0;
        var g = new Array();
        var y = 60 * 60 * 24;
        var f = unixtime() - seed.player.datejoinUnixTime;
        var t = (!seed.allianceDiplomacies && f > (y * 2) && f < (y * 14)) ? true : false;
        var I = ((!seed.appFriends || !Object.keys(seed.appFriends) || Object.keys(seed.appFriends).length < 10) && !seed.items.i1202) ? true : false;
        var e = (seed.cities.length < 2 && f > (y * 5) && seed.items.i1202) ? true : false;
        var v = (seed.cities.length == 2 && f > (y * 10) && (seed.items.i1203 || (parseInt(seed.items.i1101) > 4 && parseInt(seed.items.i1102) > 2 && parseInt(seed.items.i1103) > 1))) ? true : false;
        var n = getBuildCompleteInviteQual();
        var w = true;
        var a = Object.keys(seed.wilderness);
        for (var D = 0; D < a.length; D++) {
            if (!Object.isArray(seed.wilderness[a[D]])) {
                w = false
            }
        }
        var k = Object.isArray(seed.knights) ? true : false;
        if (k) {
            var b = false;
            var z = 0;
            var h = Object.keys(seed.buildings);
            for (var D = 0; D < h.length; D++) {
                var q = new Hash(seed.buildings[h[D]]);
                q.each(function (i) {
                    if (i.value[0] == 7) {
                        b = true;
                        z = parseInt(i.value[2])
                    }
                })
            }
            if (!b) {
                k = false
            }
        }
        var d = false;
        var j = 0;
        var A = false;
        var h = Object.keys(seed.buildings);
        var G = 0;
        for (var D = 0; D < h.length; D++) {
            var q = new Hash(seed.buildings[h[D]]);
            q.each(function (i) {
                if (i.value[0] == 13) {
                    j++;
                    G = parseInt(i.value[2]);
                    if (parseInt(i.value[1]) >= 2) {
                        A = true
                    }
                }
            })
        }
        if (A || j >= 2) {
            if (parseInt(seed.player.might) < 100000) {
                d = true;
                var r = Object.keys(seed.units);
                for (var D = 0; D < r.length; D++) {
                    var E = new Hash(seed.units[r[D]]);
                    E.each(function (i) {
                        if (parseInt(i.value) > 0) {
                            d = false
                        }
                    })
                }
            }
        }
        var F = false;
        if (f > y) {
            var l = false;
            var m = 0;
            var p = seed.buildings["city" + currentcityid];
            for (var s in p) {
                if (p[s][0] == 11) {
                    l = true;
                    m = parseInt(p[s][2]);
                    break
                }
            }
            if (l) {
                var B = 0;
                var o = Object.keys(techcost);
                for (var D = 0; D < o.length; D++) {
                    if (parseInt(seed.tech[o[D]]) > 0) {
                        B++
                    }
                }
                if (B == 0) {
                    F = true
                }
            }
        }
        if (t) {
            var u = {
                evtid: 1,
                evtimg: "<img src='" + stimgUrl + "img/alliance_icon.png' />",
                evtdesc: g_js_strings.getNextAvailableCase.allidesc,
                evtbtns: "<a onclick='Modal.hideModal();modal_alliance();return false;' class='button20'><span>" + g_js_strings.commonstr.alliances + "</span></a>"
            };
            g.push(u)
        }
        if (I) {
            var u = {
                evtid: 2,
                evtimg: "<img src='" + stimgUrl + "img/second_city_icon.png' />",
                evtdesc: g_js_strings.getNextAvailableCase.frienddesc,
                evtbtns: "<a onclick='Modal.hideModal();return false;' class='buttonDown20'><span>" + g_js_strings.commonstr.skip + "</span></a><a onclick='Modal.hideModal();invite_friends_popup();return false;' class='button20'><span>" + g_js_strings.getNextAvailableCase.invitefriends + "</span></a>"
            };
            g.push(u)
        }
        if (e) {
            var u = {
                evtid: 3,
                evtimg: "<img src='" + stimgUrl + "img/second_city_icon.png' />",
                evtdesc: g_js_strings.getNextAvailableCase.expanddesc,
                evtbtns: "<a onclick='Modal.hideModal();return false;' class='button20'><span>" + g_js_strings.commonstr.ok + "</span></a>"
            };
            g.push(u)
        } else {
            if (v) {
                var u = {
                    evtid: 4,
                    evtimg: "<img src='" + stimgUrl + "img/third_city_icon.png' />",
                    evtdesc: g_js_strings.getNextAvailableCase.expanddesc,
                    evtbtns: "<a onclick='Modal.hideModal();return false;' class='button20'><span>" + g_js_strings.commonstr.ok + "</span></a>"
                };
                g.push(u)
            }
        }
        if (w) {
            var u = {
                evtid: 5,
                evtimg: "<img src='" + stimgUrl + "img/higher_level_wood_icon.png' />",
                evtdesc: g_js_strings.getNextAvailableCase.resourcedesc,
                evtbtns: "<a onclick='Modal.hideModal();return false;' class='button20'><span>" + g_js_strings.commonstr.ok + "</span></a>"
            };
            g.push(u)
        }
        if (k) {
            var u = {
                evtid: 6,
                evtimg: "<img src='" + stimgUrl + "img/knight_icon.png' />",
                evtdesc: g_js_strings.getNextAvailableCase.appointdesc,
                evtbtns: "<a onclick='Modal.hideModal();modal_build(" + z + ");return false;' class='button20'><span>" + g_js_strings.openKnights.appknights + "</span></a>"
            };
            g.push(u)
        }
        if (d) {
            var u = {
                evtid: 7,
                evtimg: "<img src='" + stimgUrl + "img/militiaman_icon.png' />",
                evtdesc: g_js_strings.getNextAvailableCase.troopdesc,
                evtbtns: "<a onclick='Modal.hideModal();modal_build(" + G + ");return false;' class='button20'><span>" + g_js_strings.modal_openBarracks.trainttl + "</span></a>"
            };
            g.push(u)
        }
        if (F) {
            var u = {
                evtid: 8,
                evtimg: "<img src='" + stimgUrl + "img/potion_brewing.png' />",
                evtdesc: g_js_strings.getNextAvailableCase.researchdesc,
                evtbtns: "<a onclick='Modal.hideModal();modal_build(" + m + ");return false;' class='button20'><span>" + g_js_strings.commonstr.research + "</span></a>"
            };
            g.push(u)
        }
        if (n) {
            var u = {
                evtid: 9,
                evtimg: "<img src='" + stimgUrl + "img/alliance_icon.png' />",
                evtdesc: g_js_strings.pop_suggest_invite_modal.invitedesc,
                evtbtns: "<a onclick='Modal.hideModal();cm.invite.load(cm.InviteTypes.INVITE_TYPE_SUGGEST_INVITE);cm.invite.open();' class='button20'><span>" + g_js_strings.pop_suggest_invite_modal.invitefriend + "</span></a><a onclick='Modal.hideModal();return false;' class='button20'><span>" + g_js_strings.commonstr.nothanks + "</span></a>"
            };
            g.push(u)
        }
        if (g.length > 1) {
            var C = true;
            var c = 0;
            while (C) {
                c = Math.floor(Math.random() * g.length);
                if (readCookie("uep_" + g[c].evtid)) {
                    g.splice(c, 1);
                    if (g.length == 0) {
                        return null
                    }
                } else {
                    C = false;
                    return g[c]
                }
            }
        }
        return null
    },
    testUEP: function (c) {
        var a = "<select onchange='eval(this.value)'>";
        var b = $(this.Methods);
        b.each(function (d) {
            var e = d[0];
            if (e == "testUEP" || e == "popup" || e == "popTreasureChest" || e == "getNextAvailableCase" || e == "getBuildCompleteInviteQual" || e == "popInformationMessage") {} else {
                a += "<option value='UserEngagement." + e + "()'>" + d[0] + "</option>"
            }
        });
        a += "</select>";
        $(c).update(a);
        $(c).onclick = "";
        return a
    }
};
Object.extend(UserEngagement, UserEngagement.Methods);
Object.extend(UserEngagement, UserEngagement.Properties);

function user_engagement_popup(a) {
    if (!cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON")) {
        UserEngagement.popup(a)
    } else {
        return false
    }
}

function pop_castle_two_modal() {
    if (!cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON")) {
        UserEngagement.popCastleTwoModal()
    }
}

function pop_suggest_invite_modal() {
    if (!cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON")) {
        UserEngagement.popSuggestInviteModal()
    }
}

function pop_action_feed_modal() {
    if (!cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON")) {
        UserEngagement.popActionFeedModal()
    }
}

function pop_action_feed() {
    if (!cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON")) {
        UserEngagement.popActionFeed()
    }
}

function pop_information_message(a) {
    if (!cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON")) {
        UserEngagement.popInformationMessage(a)
    }
}

function pop_friend_court() {
    if (!cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON")) {
        UserEngagement.popFriendCourt()
    }
}

function pop_treasure_chest_modal(a) {
    if (!cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON")) {
        UserEngagement.popTreasureChestModal(a)
    }
}

function pop_treasure_chest(a) {
    if (!cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON")) {
        UserEngagement.popTreasureChest(a)
    }
}

function getBuildCompleteInviteQual(a) {
    if (!cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON")) {
        UserEngagement.getBuildCompleteInviteQual(a)
    } else {
        return false
    }
}

function getNextAvailableCase() {
    if (!cm.WorldSettings.hasKeyValuePair("UEP_SUPPRESS", "ON")) {
        UserEngagement.getNextAvailableCase()
    } else {
        return null
    }
};

function getUserSettings() {
    var params = Object.clone(g_ajaxparams);
    new Ajax.Request(g_ajaxpath + "ajax/manageChatOptions.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                var ignorelist = rslt.chatdata;
                var ignoreHtml = new Array();
                if (Object.keys(ignorelist) && Object.keys(ignorelist).length > 0) {
                    var idlist = Object.keys(ignorelist);
                    for (var i = 0; i < idlist.length; i++) {
                        ignoreHtml.push("<div class='userrow clearfix' id='igList_" + idlist[i] + "'>");
                        ignoreHtml.push("<div class='name'>" + ignorelist[idlist[i]] + "</div>");
                        ignoreHtml.push("<a class='button14' onclick='removeFromIgnoreList(" + idlist[i] + ");return false;'><span>" + g_js_strings.commonstr.remove + "</span></a>");
                        ignoreHtml.push("</div>")
                    }
                }
                var blocklist = rslt.msgdata;
                var blockHtml = new Array();
                if (Object.keys(blocklist) && Object.keys(blocklist).length > 0) {
                    var bidlist = Object.keys(blocklist);
                    for (var i = 0; i < bidlist.length; i++) {
                        blockHtml.push("<div class='userrow clearfix' id='blList_" + bidlist[i] + "'>");
                        blockHtml.push("<div class='name'>" + blocklist[bidlist[i]] + "</div>");
                        blockHtml.push("<a class='button14' onclick='removeFromBlockList(" + bidlist[i] + ");return false;'><span>" + g_js_strings.commonstr.remove + "</span></a>");
                        blockHtml.push("</div>")
                    }
                }
                if (seed.playerSettings.s1 == "g") {
                    var gchat = "checked";
                    var achat = ""
                } else {
                    var gchat = "";
                    var achat = "checked"
                }
                var userHtml = new Array();
                userHtml.push("<div class='usersettingbox'>");
                userHtml.push("<div class='userupperbox'>");
                userHtml.push("<div class='clearfix'>");
                userHtml.push("<div class='userlangwrap'>");
                userHtml.push("<div class='usersubtitle'>");
                userHtml.push(g_js_strings.getUserSettings.changelang);
                userHtml.push("</div>");
                userHtml.push("<div class='langdd clearfix'>");
                userHtml.push("<select id='userLanguage'>");
                userHtml.push("<option value='en' " + ((g_ajaxparams.lang == "en") ? "selected" : "") + ">English</option>");
                userHtml.push("<option value='es' " + ((g_ajaxparams.lang == "es") ? "selected" : "") + ">Espa&#241;ol</option>");
                userHtml.push("<option value='de' " + ((g_ajaxparams.lang == "de") ? "selected" : "") + ">Deutsch</option>");
                userHtml.push("<option value='fr' " + ((g_ajaxparams.lang == "fr") ? "selected" : "") + ">Fran&#231;ais</option>");
                userHtml.push("<option value='it' " + ((g_ajaxparams.lang == "it") ? "selected" : "") + ">Italiano</option>");
                userHtml.push("<option value='sv' " + ((g_ajaxparams.lang == "sv") ? "selected" : "") + ">Svenska</option>");
                userHtml.push("<option value='da' " + ((g_ajaxparams.lang == "da") ? "selected" : "") + ">Dansk</option>");
                userHtml.push("<option value='tr' " + ((g_ajaxparams.lang == "tr") ? "selected" : "") + ">T&#252;rk&#231;e</option>");
                userHtml.push("<option value='ko' " + ((g_ajaxparams.lang == "ko") ? "selected" : "") + ">&#54620;&#44397;&#50612;</option>");
                userHtml.push("<option value='ja' " + ((g_ajaxparams.lang == "ja") ? "selected" : "") + ">&#26085;&#26412;&#35486;</option>");
                userHtml.push("<option value='zh-Hant' " + ((g_ajaxparams.lang == "zh-Hant") ? "selected" : "") + ">&#32321;&#39636;&#20013;&#25991;</option>");
                userHtml.push("<option value='zh-Hans' " + ((g_ajaxparams.lang == "zh-Hans") ? "selected" : "") + ">&#31616;&#20307;&#20013;&#25991;</option>");
                userHtml.push("<option value='nl' " + ((g_ajaxparams.lang == "nl") ? "selected" : "") + ">Nederlands</option>");
                userHtml.push("</select>");
                userHtml.push("<a class='button20' href='#' onclick='saveLanguage();return false;'><span>" + g_js_strings.getUserSettings.savelang + "</span></a>");
                userHtml.push("</div>");
                userHtml.push("</div>");
                userHtml.push("<div class='userchatwrap'>");
                userHtml.push("<div class='usersubtitle'>");
                userHtml.push(g_js_strings.getUserSettings.defaultchat);
                userHtml.push("</div>");
                userHtml.push("<div class='usertabs'>");
                userHtml.push("<input type='radio' " + gchat + " name='dchat' onclick='changeDefaultChat(0);'>");
                userHtml.push("<span>");
                userHtml.push(g_js_strings.commonstr.global);
                userHtml.push("</span>");
                userHtml.push("<input type='radio' " + achat + " name='dchat' onclick='changeDefaultChat(1);'>");
                userHtml.push("<span>");
                userHtml.push(g_js_strings.commonstr.alliance);
                userHtml.push("</span>");
                userHtml.push("</div>");
                userHtml.push("</div>");
                userHtml.push("</div>");
                userHtml.push("</div>");
                userHtml.push("<div class='userlowerbox clearfix'>");
                userHtml.push("<div class='userlistside'>");
                userHtml.push("<div class='listtitle'>");
                userHtml.push(g_js_strings.getUserSettings.chatignore);
                userHtml.push("</div>");
                userHtml.push("<div class='userlistbox'>");
                userHtml.push(ignoreHtml.join(""));
                userHtml.push("</div>");
                userHtml.push("</div>");
                userHtml.push("<div class='userlistside'>");
                userHtml.push("<div class='listtitle'>");
                userHtml.push(g_js_strings.getUserSettings.msgblock);
                userHtml.push("</div>");
                userHtml.push("<div class='userlistbox'>");
                userHtml.push(blockHtml.join(""));
                userHtml.push("</div>");
                userHtml.push("</div>");
                userHtml.push("</div>");
                userHtml.push("</div>");
                Modal.showModal(500, 400, 130, 75, g_js_strings.modaltitles.usersettings, userHtml.join(""))
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function saveLanguage() {
    var langco = $("userLanguage").value;
    var params = Object.clone(g_ajaxparams);
    params.lang = langco;
    new Ajax.Request(g_ajaxpath + "ajax/changeLanguage.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                top.location = appUrl + "?lang=" + langco
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function changeDefaultChat(type) {
    var params = Object.clone(g_ajaxparams);
    params.settingid = 1;
    params.settingvalue = (type == 0 ? "g" : "a");
    new Ajax.Request(g_ajaxpath + "ajax/changeUserSettings.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                seed.playerSettings.s1 = (type == 0 ? "g" : "a")
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function removeFromBlockList(uid) {
    var params = Object.clone(g_ajaxparams);
    params.pid = uid;
    new Ajax.Request(g_ajaxpath + "ajax/unignore.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                $("blList_" + uid).remove()
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
}

function removeFromIgnoreList(uid) {
    var params = Object.clone(g_ajaxparams);
    params.ignoreId = uid;
    params.set = 0;
    new Ajax.Request(g_ajaxpath + "ajax/ignore.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                $("igList_" + uid).remove();
                if (ignored["u" + uid]) {
                    delete ignored["u" + uid];
                    if (Object.keys(ignored) && Object.keys(ignored).length == 0) {
                        ignored = []
                    }
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {}
    })
};

function addCommas(b) {
    b += "";
    x = b.split(".");
    x1 = x[0];
    x2 = x.length > 1 ? "." + x[1] : "";
    var a = /(\d+)(\d{3})/;
    while (a.test(x1)) {
        x1 = x1.replace(a, "$1,$2")
    }
    return x1 + x2
}

function truncateStringAddEllipsis(c, b) {
    var a = c.toString(10);
    if (a.length <= parseInt(b)) {
        return a
    } else {
        return a.substr(0, (parseInt(b) - 3)) + "..."
    }
}

function isEmpty(a) {
    for (var b in a) {
        if (a.hasOwnProperty(b)) {
            return false
        }
    }
    return true
}

function validateEmails(f) {
    var d = f.split(",");
    var e = /^[a-z0-9_\+-]+(\.[a-z0-9_\+-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*\.([a-z]{2,4})$/i;
    var c = /^[a-z0-9,!#\$%&'\*\+/=\?\^_`\{\|}~-]+(\.[a-z0-9,!#\$%&'\*\+/=\?\^_`\{\|}~-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*\.([a-z]{2,})$/i;
    for (var b = 0; b < d.length; b++) {
        var a = d[b];
        if (!a.match(e) && !a.match(c)) {
            return false
        }
    }
    return true
}

function createCookie(c, e, d) {
    if (d) {
        var b = new Date();
        b.setTime(b.getTime() + (d * 60 * 1000));
        var a = "; expires=" + b.toGMTString()
    } else {
        var a = ""
    }
    document.cookie = c + "=" + e + a + "; path=/"
}

function readCookie(b) {
    var e = b + "=";
    var a = document.cookie.split(";");
    for (var d = 0; d < a.length; d++) {
        var f = a[d];
        while (f.charAt(0) == " ") {
            f = f.substring(1, f.length)
        }
        if (f.indexOf(e) == 0) {
            return f.substring(e.length, f.length)
        }
    }
    return null
}

function eraseCookie(a) {
    createCookie(a, "", -1)
}

function arthurCheck(a) {
    var b = false;
    for (var c = 0; c < a.length; c++) {
        if ($(unescape(a[c]))) {
            b = true;
            break
        }
    }
    if (b) {
        AjaxCall.gPostRequest("ajax/funnelTracking.php", {
            action: 1300,
            serverId: g_server,
            uid: tvuid
        })
    }
}

function getTemplate(b, c) {
    var d = unescape($(b).innerHTML.replace(/_tid_/g, ""));
    var a = new Template(d).evaluate(c);
    return a
}
var roman = Array("I", "II", "III", "IV", "V", "VI", "VII", "VIII");
var cm = cm || {};
cm.utils = cm.utils || {};
cm.utils.CoordinateLink = function (a, b) {
    _htmlElement = document.createElement("a");
    _htmlElement.href = "javascript:void(0)";
    _htmlElement.setAttribute("onclick", "cm.utils.CoordinateLinkController.onClick(event)");
    _htmlElement.innerHTML = "(" + a + "," + b + ")";
    Event.observe(_htmlElement, "onclick", cm.utils.CoordinateLinkController.onClick);
    this.setClassName = function (c) {
        _htmlElement.className = c
    };
    this.getHTMLElement = function () {
        return _htmlElement
    };
    this.getHTML = function () {
        var c = document.createElement("div");
        c.appendChild(_htmlElement);
        var d = c.innerHTML;
        c.removeChild(_htmlElement);
        return d
    }
};
cm.utils.CoordinateLinkController = new function () {
    this.onClick = function (c) {
        var b = c.srcElement ? c.srcElement : c.target;
        var d = b.innerHTML.split(",");
        var a = d[0].substr(1);
        var f = d[1].substr(0, d[1].length - 1);
        Modal.hideModalAll();
        changeview_map(b);
        $("mapXCoor").value = a;
        $("mapYCoor").value = f;
        reCenterMapWithCoor()
    }
};
cm.utils.ScrollbarWidthCalculator = function (c) {
    var b = 0;
    var a = function () {
            if (!b) {
                if (c.browser.msie) {
                    var f = c('<textarea cols="10" rows="2"></textarea>').css({
                        position: "absolute",
                        top: -1000,
                        left: -1000
                    }).appendTo("body"),
                        e = c('<textarea cols="10" rows="2" style="overflow: hidden;"></textarea>').css({
                            position: "absolute",
                            top: -1000,
                            left: -1000
                        }).appendTo("body");
                    b = f.width() - e.width();
                    f.add(e).remove()
                } else {
                    var d = c("<div />").css({
                        width: 100,
                        height: 100,
                        overflow: "auto",
                        position: "absolute",
                        top: -1000,
                        left: -1000
                    }).prependTo("body").append("<div />").find("div").css({
                        width: "100%",
                        height: 200
                    });
                    b = 100 - d.width();
                    d.parent().remove()
                }
            }
            return b
        };
    return {
        get: a
    }
}(jQuery);
cm.utils.BuildingStatPopulator = function (d) {
    var f = {
        "1": "1",
        "2": "2",
        "3": "3",
        "4": "4",
        "5": "0",
        "6": "5",
        "7": "6"
    },
        e = d.buildingcost,
        a, b, c;
    for (a in buildingcost) {
        if (!e[a]) {
            cm.log.l("Missing building cost for build " + a);
            continue
        }
        for (c in f) {
            buildingcost[a][c] = e[a][f[c]]
        }
    }
};
cm.utils.Date = function (j, h) {
    var g = this,
        i, e, b = /\\?([a-z])/gi,
        a = function (f, k) {
            return e[f] ? e[f]() : k
        },
        c = function (k, f) {
            if ((k = k + "").length < f) {
                return new Array((++f) - k.length).join("0") + k
            }
            return k
        },
        d = ["Sun", "Mon", "Tues", "Wednes", "Thurs", "Fri", "Satur", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    e = {
        d: function () {
            return c(e.j(), 2)
        },
        D: function () {
            return e.l().slice(0, 3)
        },
        j: function () {
            return i.getDate()
        },
        l: function () {
            return d[e.w()] + "day"
        },
        N: function () {
            return e.w() || 7
        },
        S: function () {
            var f = e.j();
            return f < 4 | f > 20 && ["st", "nd", "rd"][f % 10 - 1] || "th"
        },
        w: function () {
            return i.getDay()
        },
        z: function () {
            var k = new Date(e.Y(), e.n() - 1, e.j()),
                f = new Date(e.Y(), 0, 1);
            return Math.round((k - f) / 86400000) + 1
        },
        W: function () {
            var k = new Date(e.Y(), e.n() - 1, e.j() - e.N() + 3),
                f = new Date(k.getFullYear(), 0, 4);
            return c(1 + Math.round((k - f) / 86400000 / 7), 2)
        },
        F: function () {
            return d[6 + e.n()]
        },
        m: function () {
            return c(e.n(), 2)
        },
        M: function () {
            return e.F().slice(0, 3)
        },
        n: function () {
            return i.getMonth() + 1
        },
        t: function () {
            return (new Date(e.Y(), e.n(), 0)).getDate()
        },
        L: function () {
            var f = e.Y();
            return f % 4 == 0 & f % 100 != 0 | f % 400 == 0
        },
        o: function () {
            var l = e.n(),
                f = e.W(),
                k = e.Y();
            return k + (l === 12 && f < 9 ? -1 : l === 1 && f > 9)
        },
        Y: function () {
            return i.getFullYear()
        },
        y: function () {
            return (e.Y() + "").slice(-2)
        },
        a: function () {
            return i.getHours() > 11 ? "pm" : "am"
        },
        A: function () {
            return e.a().toUpperCase()
        },
        B: function () {
            var k = i.getUTCHours() * 3600,
                f = i.getUTCMinutes() * 60,
                l = i.getUTCSeconds();
            return c(Math.floor((k + f + l + 3600) / 86.4) % 1000, 3)
        },
        g: function () {
            return e.G() % 12 || 12
        },
        G: function () {
            return i.getHours()
        },
        h: function () {
            return c(e.g(), 2)
        },
        H: function () {
            return c(e.G(), 2)
        },
        i: function () {
            return c(i.getMinutes(), 2)
        },
        s: function () {
            return c(i.getSeconds(), 2)
        },
        u: function () {
            return c(i.getMilliseconds() * 1000, 6)
        },
        e: function () {
            throw "Not supported (see source code of date() for timezone on how to add support)"
        },
        I: function () {
            var k = new Date(e.Y(), 0),
                m = Date.UTC(e.Y(), 0),
                f = new Date(e.Y(), 6),
                l = Date.UTC(e.Y(), 6);
            return 0 + ((k - m) !== (f - l))
        },
        O: function () {
            var k = i.getTimezoneOffset(),
                f = Math.abs(k);
            return (k > 0 ? "-" : "+") + c(Math.floor(f / 60) * 100 + f % 60, 4)
        },
        P: function () {
            var f = e.O();
            return (f.substr(0, 3) + ":" + f.substr(3, 2))
        },
        T: function () {
            return "UTC"
        },
        Z: function () {
            return -i.getTimezoneOffset() * 60
        },
        c: function () {
            return "Y-m-d\\Th:i:sP".replace(b, a)
        },
        r: function () {
            return "D, d M Y H:i:s O".replace(b, a)
        },
        U: function () {
            return i / 1000 | 0
        }
    };
    this.date = function (k, f) {
        g = this;
        i = (f == null ? new Date() : (f instanceof Date) ? new Date(f) : new Date(f * 1000));
        return k.replace(b, a)
    };
    return this.date(j, h)
};
cm.utilityView = function (b) {
    function a(e) {
        var d = "";
        for (var c in e.attributes) {
            d += (c + "='" + e.attributes[c] + "' ")
        }
        return d
    }
    return {
        button: function (c) {
            if (!c.color) {
                c.color = "blue"
            }
            return "<div " + a(c) + " class='sprite_button_20 " + (c["class"]) + " " + c.color + "'><div class='inner'><span>" + c.text + "</span></div></div>"
        }
    }
}(jQuery);
var cm = cm || {};
cm.voltron = (function (c) {
    function a() {
        var d = c(".group").size();
        var e = parseInt(c("#groupsindex").attr("value"), 10);
        var f = e + 1;
        if (f > c(".group").size() - 1) {
            f = 0
        }
        c("#groupsindex").attr("value", f);
        c(".group").hide();
        c("#voltron .la").die();
        c("#voltron .ra").die();
        c("#g" + f).show(500, function () {
            c("#voltron .la").live("click", a);
            c("#voltron .ra").live("click", b)
        })
    }

    function b() {
        var d = c(".group").size();
        var e = parseInt(c("#groupsindex").attr("value"), 10);
        var f = e - 1;
        if (f < 0) {
            f = c(".group").size() - 1
        }
        c("#groupsindex").attr("value", f);
        c(".group").hide();
        c("#voltron .la").die();
        c("#voltron .ra").die();
        c("#g" + f).show(500, function () {
            c("#voltron .la").live("click", a);
            c("#voltron .ra").live("click", b)
        })
    }
    return {
        voltronInit: function (f) {
            var e = this;
            var d = "kso";
            c("#voltron").append('<form> <input id="groupsindex" type="hidden"> </input> </form> <div id="groups"> </div> <div class="la ar"> <span>&laquo;</span> </div> <div class="ra ar"> <span>&raquo;</span> </div>');
            c.each(f, function (h) {
                c("#groups").append('<div class="group" id="g' + h + '"></div>');
                c.each(f[h], function (g) {
                    c("#groups #g" + h).append('<div class="item i' + g + " s" + this.SIZE + '"><a href="' + this.URL + '" target="_blank"><img src="' + this.IMG + '"/></a></div>');
                    e.gameUrl = this.URL
                })
            });
            c(".item").live("click", function () {
                var g = c(this).attr("class");
                c.post("ajax/voltronTracking.php", {
                    data: "class=" + g + "&url=" + e.gameUrl
                })
            });
            if (f.length > 0) {
                c("#voltron").show();
                c("#g0").show();
                c("#groupsindex").attr("value", 0)
            }
            if (f.length > 1) {
                c("#voltron .la").live("click", a);
                c("#voltron .ra").live("click", b)
            }
        }
    }
})(jQuery);

function modal_openWalls() {
    var e = new Array();
    e.push("<div class='tabsbar clearfix barracksmodaltabs' id='barracksModalTabs'>");
    e.push("<a class='tab selected' onclick='changeWallsModalTabs(0);return false;'><span>");
    e.push(g_js_strings.modal_openWalls.builddefenses);
    e.push("</span></a>");
    e.push("<a class='tab' onclick='changeWallsModalTabs(1);return false;'><span>");
    e.push(g_js_strings.modal_openWalls.defqueue);
    e.push("</span></a>");
    var a = 0;
    var c = parseInt(seed.buildings["city" + currentcityid].pos1[1]);
    for (var b = 1; b < (c + 1); b++) {
        a += (b * 1000)
    }
    var d = modal_walls_spacecalc(1);
    e.push("<div class='wallspacetaken'>");
    e.push("<span>");
    e.push(d[0]);
    e.push("</span>");
    e.push("/<b>");
    e.push(a / 2);
    e.push("</b> " + g_js_strings.modal_openWalls.walldef);
    e.push("<span class='fielddefense'>");
    e.push(d[1]);
    e.push("</span>");
    e.push("/<b>");
    e.push(a / 2);
    e.push("</b> " + g_js_strings.modal_openWalls.fielddef);
    e.push("</div>");
    e.push("</div>");
    e.push("<div id='barracks_0' class='barrackswrap'>");
    e.push("<div class='unitlist clearfix'>");
    var g = Object.keys(fortcost);
    for (var b = 0; b < g.length; b++) {
        var f = g[b].split("frt")[1];
        e.push("<div class='unit'>");
        e.push("<img src='");
        e.push(stimgUrl);
        e.push("img/units/unit_");
        e.push(f);
        e.push("_68.jpg?6545'/>");
        e.push("<div class='unitinfo'>");
        e.push("<div class='unitnm'>");
        e.push(fortcost[g[b]][0]);
        e.push("</div>");
        e.push("<div class='unitdesc'>");
        e.push(fortcost[g[b]][10]);
        e.push("</div>");
        e.push("<div class='unitcount'><b>" + g_js_strings.commonstr.youown + ":</b> ");
        e.push(seed.fortifications["city" + currentcityid]["fort" + f]);
        e.push("</div>");
        e.push("<div class='clearfix btn'><a class='button20' onclick='modal_walls_train(");
        e.push(f);
        e.push(");return false;'><span>" + g_js_strings.commonstr.build + "</span></a>");
        e.push("</div>");
        e.push("</div>");
        e.push("</div>")
    }
    e.push("</div>");
    e.push("</div>");
    e.push("<div id='barracks_1' style='display:none;' class='barrackswrap'>");
    e.push("<div class='trainboxwrap'>");
    e.push("<div class='trainbox'>");
    e.push("<div class='trainhd'><span>" + g_js_strings.modal_openWalls.underconstruct + "</span></div><div id='modal_currentlytraining'>");
    e.push("</div>");
    e.push("</div>");
    e.push("<div class='trainbox'>");
    e.push("<div class='trainhd'><span>" + g_js_strings.modal_openWalls.waitforconstruct + "</span></div>");
    e.push("<div id='modal_trainingqueue'>");
    e.push("</div>");
    e.push("</div>");
    e.push("</div>");
    e.push("</div>");
    $("modal_build_content").innerHTML = e.join("")
}

function modal_walls_spacecalc(e) {
    var d = seed.fortifications["city" + currentcityid];
    var a = Object.keys(d);
    var g = [0, 0];
    for (var c = 0; c < a.length; c++) {
        var f = parseInt(a[c].split("fort")[1]);
        if (f < 60) {
            g[0] += (parseInt(fortstats["unt" + f][5]) * parseInt(d[a[c]]))
        } else {
            g[1] += (parseInt(fortstats["unt" + f][5]) * parseInt(d[a[c]]))
        }
    }
    if (e == 2) {
        var b = seed.queue_fort["city" + currentcityid];
        for (var c = 0; c < b.length; c++) {
            var f = parseInt(b[c][0]);
            if (f < 60) {
                g[0] += (parseInt(fortstats["unt" + f][5]) * parseInt(b[c][1]))
            } else {
                g[1] += (parseInt(fortstats["unt" + f][5]) * parseInt(b[c][1]))
            }
        }
    }
    return g
}

function modal_walls_trainingtab() {
    if (seed.queue_fort["city" + currentcityid].length > 0) {
        var b = new Array();
        var f = seed.queue_fort["city" + currentcityid][0];
        b.push("<div class='clearfix traincur'>");
        b.push("<div class='piccol'><img src='");
        b.push(stimgUrl);
        b.push("img/units/unit_");
        b.push(f[0]);
        b.push("_50.jpg'/></div>");
        b.push("<div class='infocol'><div class='untnm'>");
        b.push(fortcost["frt" + f[0]][0]);
        b.push("</div><div>");
        b.push(f[1]);
        b.push("</div></div>");
        b.push("</div>");
        b.push("<div class='btnrow clearfix'><div class='est'>" + g_js_strings.modal_walls_trainingtab.estdtime + ": <b id='underconstruction_estimatedtimeremain'>");
        var e = unixtime();
        var c = parseInt(f[3]) - e;
        b.push(timestr(c));
        b.push("</b></div>");
        b.push("<div style='float:right;'>");
        b.push('<a class="inlineButton red20" onclick="modal_speedup(');
        b.push(["'frt'", f[0], 0, "'" + g_js_strings.commonstr.fortification + "'", f[2]].join(","));
        b.push(');return false;">');
        b.push("<span>" + g_js_strings.commonstr.speedup + "</span></a>");
        b.push("</div>");
        b.push("<div style='float:right;' id='button_construction_cancel'>");
        b.push("<a href='#' class='button20' onclick='cancelFortifications(");
        b.push("0," + currentcityid + "," + f[0] + "," + f[1] + "," + f[3] + "," + f[2] + "," + f[5] + "," + f[6]);
        b.push(");return false;'>");
        b.push("<span>" + g_js_strings.commonstr.cancel + "</span></a>");
        b.push("</div>");
        b.push("</div>");
        $("modal_currentlytraining").innerHTML = b.join("");
        CountDown.addCountDown("underconstruction_estimatedtimeremain", c, function () {
            update_seed_ajax(true, function () {
                $("underconstruction_estimatedtimeremain").innerHTML = g_js_strings.modal_barracks_trainingtab.completetxt;
                $("button_construction_cancel").hide();
                modal_walls_trainingtab()
            })
        });
        if (seed.queue_fort["city" + currentcityid].length > 1) {
            var a = new Array();
            for (var d = 1; d < seed.queue_fort["city" + currentcityid].length; d++) {
                a.push("<div class='clearfix queueitem'>");
                a.push("<div class='piccol'><img src='");
                a.push(stimgUrl);
                a.push("img/units/unit_");
                a.push(seed.queue_fort["city" + currentcityid][d][0]);
                a.push("_50.jpg'/></div>");
                a.push("<div class='infocol'><div><b>");
                a.push(fortcost["frt" + seed.queue_fort["city" + currentcityid][d][0]][0]);
                a.push(":</b> ");
                a.push(seed.queue_fort["city" + currentcityid][d][1]);
                a.push("</div><div><b>" + g_js_strings.modal_walls_trainingtab.estdtime + ":</b> ");
                a.push(timestr(parseInt(seed.queue_fort["city" + currentcityid][d][3]) - parseInt(seed.queue_fort["city" + currentcityid][d][2])));
                a.push("</div></div>");
                a.push("<div style='float:right;margin-top:40px'>");
                a.push("<a href='#' class='button20' onclick='cancelFortifications(");
                a.push(+d + "," + currentcityid + "," + seed.queue_fort["city" + currentcityid][d][0] + "," + seed.queue_fort["city" + currentcityid][d][1] + "," + seed.queue_fort["city" + currentcityid][d][3] + "," + seed.queue_fort["city" + currentcityid][d][2] + "," + seed.queue_fort["city" + currentcityid][d][5] + "," + seed.queue_fort["city" + currentcityid][d][6]);
                a.push(");return false;'>");
                a.push("<span>" + g_js_strings.commonstr.cancel + "</span></a>");
                a.push("</div>");
                a.push("</div>")
            }
            $("modal_trainingqueue").innerHTML = a.join("")
        } else {
            $("modal_trainingqueue").update("")
        }
    } else {
        $("modal_currentlytraining").update("")
    }
}

function changeWallsModalTabs(a) {
    var c = $("barracksModalTabs").select("a");
    for (var b = 0; b < c.length; b++) {
        c[b].className = "tab";
        $("barracks_" + b).hide()
    }
    $("barracks_" + a).show();
    c[a].addClassName("selected");
    if (a == 0) {
        $("modal_build").className = "tab1"
    } else {
        $("modal_build").className = "tab2";
        modal_walls_trainingtab()
    }
}

function modal_walls_train(e) {
    var b = new Array();
    b.push("<div id='barracks_train' class='clearfix'>");
    b.push("<img src='");
    b.push(stimgUrl);
    b.push("img/units/unit_");
    b.push(e);
    b.push("_215.jpg?6545'/>");
    b.push("<div class='unitinfo'>");
    b.push("<div class='unitnm'>");
    b.push(fortcost["frt" + e][0]);
    b.push("</div>");
    b.push("<div class='unitdesc'>");
    b.push(fortcost["frt" + e][10]);
    b.push("</div>");
    b.push("<div class='unitstats'>");
    b.push("<table cellpadding='0' cellspacing='0'>");
    b.push("<tr><td><b>" + g_js_strings.commonstr.attack + ":</b> ");
    b.push(fortstats["unt" + e][1]);
    b.push("</td><td><b>" + g_js_strings.commonstr.speed + ":</b> ");
    b.push(fortstats["unt" + e][3]);
    b.push("</td></tr>");
    b.push("<tr><td><b>" + g_js_strings.commonstr.defense + ":</b> ");
    b.push(fortstats["unt" + e][2]);
    b.push("</td><td><b>" + g_js_strings.commonstr.range + ":</b> ");
    b.push(fortstats["unt" + e][4]);
    b.push("</td></tr>");
    b.push("<tr><td><b>" + g_js_strings.commonstr.life + ":</b> ");
    b.push(fortstats["unt" + e][0]);
    b.push("</td><td><b>" + g_js_strings.commonstr.space + ":</b> ");
    b.push(fortstats["unt" + e][5]);
    b.push("</td></tr>");
    b.push("</table>");
    b.push("</div>");
    b.push("<div class='unitreqs'>");
    b.push("<table cellpadding='0' cellspacing='0'><thead><tr><td class='res'>" + g_js_strings.commonstr.resource + "</td><td class='req'>" + g_js_strings.commonstr.required + "</td><td class='own'>" + g_js_strings.commonstr.youown + "</td></tr></thead><tbody>");
    var a = checkreq("frt", e, 1);
    var d = false;
    for (var c = 0; c < a[0].length; c++) {
        b.push("<tr><td class='res'>");
        b.push(a[0][c]);
        b.push("</td><td class='req ");
        if (a[3][c] == 0) {
            b.push("unmet");
            d = true
        } else {
            b.push("met")
        }
        b.push("'>");
        b.push(addCommas(a[1][c]));
        b.push("</td><td class='own'>");
        b.push(addCommas(a[2][c]));
        b.push("</td></tr>")
    }
    b.push("</tbody></table>");
    b.push("</div>");
    b.push("<div class='unit_youown'><b>" + g_js_strings.commonstr.youown + ":</b> ");
    b.push(seed.fortifications["city" + currentcityid]["fort" + e]);
    b.push("</div>");
    b.push("<div class='unit_max'><b>" + g_js_strings.commonstr.maximum + ":</b> <span id='modal_barracks_max_num'>");
    if (d) {
        b.push(0)
    } else {
        b.push(modal_walls_train_max(e))
    }
    b.push("</span></div>");
    b.push("<div class='unit_numtrain'><b>" + g_js_strings.modal_walls_train.numdefbuild + ":</b><input type='text' id='modal_barracks_num' onkeyup='modal_walls_train_timecalc(this,");
    b.push(e);
    b.push(");'/><a  class='inlineButton blue14' onclick='modal_walls_train_maxbtn(");
    b.push(e);
    b.push(");return false;'><span>" + g_js_strings.commonstr.max + "</span></a></div>");
    b.push("<div class='unit_time'><b>" + g_js_strings.modal_walls_train.consttime + ":</b> <span id='modal_barracks_traintime'></span></div>");
    b.push("<div class='unit_speedup clearfix'><input type='checkbox' id='modal_barracks_tut'/><div class='hlp'><div>" + g_js_strings.modal_walls_train.usesiege + " <span id='modal_barracks_tutred'>0 sec</span>.</div><div>" + g_js_strings.commonstr.youown + ": ");
    b.push((seed.items.i26 == null) ? 0 : seed.items.i26);
    b.push(". <a  onclick='modal_barracks_getmoreshop();return false;'>" + g_js_strings.commonstr.getmore + "</a></div></div></div>");
    b.push("<div class='unit_btns clearfix'><a  class='button25");
    if (d) {
        b.push(" unmet")
    }
    b.push("' id='unit_btns_start' onclick='");
    if (!d) {
        b.push("modal_walls_train_action(");
        b.push(e);
        b.push(");")
    }
    b.push("return false;'><span>" + g_js_strings.modal_walls_train.starttrain + "</span></a></div>");
    b.push("</div>");
    b.push("</div>");
    b.push("<div></div>");
    Modal.showModal(500, 400, 120, 20, fortcost["frt" + e][0], b.join(""))
}

function modal_walls_train_maxbtn(a) {
    $("modal_barracks_num").value = parseInt($("modal_barracks_max_num").innerHTML);
    modal_walls_train_timecalc($("modal_barracks_num"), a)
}

function modal_walls_train_max(b) {
    var g = new Array();
    var h = new Array();
    for (var c = 1; c < 5; c++) {
        g.push(parseInt(fortcost["frt" + b][c]) * 3600);
        h.push(parseInt(seed.resources["city" + currentcityid]["rec" + c][0]))
    }
    var f = h[0] / g[0];
    for (var c = 1; c < g.length; c++) {
        f = Math.min(f, h[c] / g[c])
    }
    f = parseInt(f);
    var e = 0;
    var d = parseInt(seed.buildings["city" + currentcityid].pos1[1]);
    for (var c = 1; c < (d + 1); c++) {
        e += (c * 1000)
    }
    e = e / 2;
    var j = modal_walls_spacecalc(2);
    var a = 0;
    if (parseInt(b) < 60) {
        a = parseInt((e - j[0]) / parseInt(fortstats["unt" + b][5]))
    } else {
        a = parseInt((e - j[1]) / parseInt(fortstats["unt" + b][5]))
    }
    if (a < f) {
        f = a
    }
    return f || 0
}

function modal_walls_train_action(b) {
    if (!$("unit_btns_start").hasClassName("unmet")) {
        var a = parseInt($("modal_barracks_num").value);
        if (a <= modal_walls_train_max(b) && a > 0) {
            var c = 0;
            if ($("modal_barracks_tut").checked) {
                if (parseInt(seed.items.i26) > 0) {
                    c = 26
                }
            }
            walls_train_defense(b, a, c)
        }
    }
}

function modal_walls_train_timecalc(d, b) {
    var c = parseInt(d.value);
    if (c) {
        if (c > parseInt($("modal_barracks_max_num").innerHTML)) {
            c = parseInt($("modal_barracks_max_num").innerHTML);
            d.value = parseInt($("modal_barracks_max_num").innerHTML)
        } else {
            if (c < 0) {
                c = 0;
                d.value = 0
            }
        }
        var a = modal_walls_traintime(b, c);
        $("modal_barracks_traintime").innerHTML = timestr(a, 1);
        $("modal_barracks_tutred").innerHTML = timestr(parseInt(a * 0.3), 1)
    } else {
        $("modal_barracks_traintime").innerHTML = "0sec";
        $("modal_barracks_tutred").innerHTML = "0sec"
    }
}

function modal_walls_traintime(d, e) {
    var b = parseInt(parseInt(fortcost["frt" + d][7])) * e;
    var f = 1;
    f += 0.1 * parseInt(seed.tech.tch16);
    var a = 0;
    var c = seed.knights["city" + currentcityid];
    if (c) {
        c = c["knt" + seed.leaders["city" + currentcityid].politicsKnightId];
        if (c) {
            a = parseInt(c.combat);
            newkntlv = ((parseInt(c.politicsBoostExpireUnixtime) - unixtime()) > 0) ? (a * 1.25) : a;
            f = f + (0.005 * newkntlv)
        }
    }
    b = Math.max(1, Math.ceil(b / f));
    return b
}

function walls_train_defense(tid, num, iid) {
    for (var i = 1; i < 5; i++) {
        seed.resources["city" + currentcityid]["rec" + i][0] = parseInt(seed.resources["city" + currentcityid]["rec" + i][0]) - parseInt(fortcost["frt" + tid][i]) * 3600 * parseInt(num)
    }
    seed.citystats["city" + currentcityid].gold[0] = parseInt(seed.citystats["city" + currentcityid].gold[0]) - parseInt(fortcost["frt" + tid][5]) * parseInt(num);
    seed.citystats["city" + currentcityid].pop[0] = parseInt(seed.citystats["city" + currentcityid].pop[0]) - parseInt(fortcost["frt" + tid][6]) * parseInt(num);
    var time = modal_walls_traintime(tid, num);
    if (iid == 26) {
        time = parseInt(time * 0.7)
    }
    var params = Object.clone(g_ajaxparams);
    params.cid = currentcityid;
    params.type = tid;
    params.quant = num;
    params.items = iid;
    var profiler = new cm.Profiler("ResponseTime", "fortify.php");
    new Ajax.Request(g_ajaxpath + "ajax/fortify.php" + g_ajaxsuffix, {
        method: "post",
        parameters: params,
        onSuccess: function (transport) {
            profiler.stop();
            var rslt = eval("(" + transport.responseText + ")");
            if (rslt.ok) {
                seed.queue_fort["city" + currentcityid].push([tid, num, rslt.initTS, parseInt(rslt.initTS) + time, 0, time, rslt.fortifyId]);
                Modal.hideModal();
                changeWallsModalTabs(1);
                queue_changetab_train();
                if (iid == 26) {
                    seed.items.i26 = parseInt(seed.items.i26) - 1;
                    ksoItems[26].subtract()
                }
                if (rslt.updateSeed) {
                    update_seed(rslt.updateSeed)
                }
            } else {
                Modal.showAlert(printLocalError((rslt.error_code || null), (rslt.msg || null), (rslt.feedback || null)))
            }
        },
        onFailure: function () {
            profiler.stop()
        }
    })
};
cm.WatchTower = function (d) {
    cm.CustomEventDispatcher.call(this);
    var c = this;
    var g;
    var a;
    var f;
    var b;
    this.getBuildingId = function () {
        return g
    };
    this.getCityId = function () {
        return a
    };
    this.getSlot = function () {
        return f
    };
    this.getLevel = function () {
        return b
    };
    this.setLevel = function (h) {
        b = h
    };
    this.demolish = function () {
        var h = b;
        b = 0;
        if (h > 0) {
            var i = new cm.WatchTowerEvent(cm.WatchTowerEvent.DEMOLISHED);
            i.setTarget(c);
            this.dispatchCustomEvent(i)
        }
    };
    var e = function () {
            g = d.buildingId;
            a = d.cityId;
            f = d.slot;
            b = d.level
        };
    e()
};
cm.OOP.inherits(cm.WatchTower, cm.CustomEventDispatcher);
cm.WatchTowerEvent = function (a) {
    cm.CustomEvent.call(this, a)
};
cm.OOP.inherits(cm.WatchTowerEvent, cm.CustomEvent);
cm.WatchTowerEvent.LEVEL_INCREASED = "watchTower_levelIncreased";
cm.WatchTowerEvent.DEMOLISHED = "watchTower_demolished";
cm.WatchTowerController = function (a) {
    var c = function (h) {
            a.removeEventListener(cm.WatchTowerEvent.DEMOLISHED, c);
            cm.WatchTowerList.remove(a);
            var f = cm.IncomingAttackManager.getAttacksByCity(currentcityid);
            var g = f ? f.getCount() : 0;
            var d;
            while (g > 0) {
                d = f.getElementAtPosition(0);
                d.setMarchStatus(cm.MARCH_STATUS.MARCH_STATUS_INACTIVE);
                g = f.getCount()
            }
        };
    var b = function () {
            a.addEventListener(cm.WatchTowerEvent.DEMOLISHED, c)
        };
    b()
};
cm.BootLoader.add(function () {
    cm.WatchTowerList = new function (c) {
        var b = this;
        var a = {};
        this.add = function (e) {
            if (e) {
                var f = new cm.WatchTowerController(e);
                a[e.getCityId()] = e
            }
        };
        this.remove = function (e) {
            if (e) {
                delete a[e.getCityId()]
            }
        };
        this.getCityWatchTower = function (e) {
            return a[e.toString()]
        };
        var d = function () {
                if (!(c instanceof Array) && typeof (c) == "object") {
                    var g, i, k, j, l, m, h, o, f, e, n;
                    for (g in c) {
                        j = c[g];
                        if (!(j instanceof Array) && typeof (j) == "object") {
                            for (k in j) {
                                l = j[k];
                                m = parseInt(l[0]);
                                if (m === cm.BUILDING_TYPES.WATCH_TOWER) {
                                    h = parseInt(l[1]);
                                    o = l[2];
                                    f = l[3];
                                    i = g.substring(4);
                                    n = {
                                        buildingId: f,
                                        cityId: i,
                                        slot: o,
                                        level: h
                                    };
                                    e = new cm.WatchTower(n);
                                    b.add(e);
                                    break
                                }
                            }
                        }
                    }
                }
            };
        d()
    }(seed.buildings)
}, null, 1);
var cm = cm || {};
cm.WatchTowerTimerView = function (l, d) {
    var m = this;
    var b;
    var e;
    var a;
    var n;
    var p;
    var k;
    this.getHtmlElement = function () {
        return a
    };
    var o = function () {
            var r = n.getArrivalTime();
            var q = r ? cm.TimeFormatter.format(n.getArrivalTime() - unixtime()) : "attack";
            b.nodeValue = q
        };
    var i = function (r) {
            var q = n.getMarchStatus();
            if (q === cm.MARCH_STATUS.MARCH_STATUS_INACTIVE || q === cm.MARCH_STATUS.MARCH_STATUS_ABORTING) {
                m.remove()
            }
        };
    var c = function (q) {
            o()
        };
    var f = function (q) {
            if (p.getElementAtPosition(0).getId() != n.getId()) {
                m.remove()
            }
        };
    var h = function (q) {
            m.remove()
        };
    var g = function (q) {
            m.remove()
        };
    var j = function () {
            k = false;
            n = l;
            n.addEventListener(cm.IncomingAttackEvent.STATUS_CHANGED, i);
            n.addEventListener(cm.IncomingAttackEvent.ARRIVAL_TIME_CHANGED, c);
            p = d;
            p.addEventListener(cm.CollectionEvent.ELEMENT_ADDED, f);
            cm.CitySwitch.addEventListener(cm.CitySwitchEvent.CITY_CHANGED, h);
            cm.CitySwitch.addEventListener(cm.CitySwitchEvent.VIEW_CHANGED, g);
            a = document.createElement("div");
            a.className = "watchTowerTimer";
            b = document.createTextNode("");
            a.appendChild(b);
            o()
        };
    this.setParentElement = function (q) {
        e = q
    };
    this.show = function () {
        k = true;
        e.insertBefore(a, e.firstChild)
    };
    this.isActive = function () {
        return k
    };
    this.remove = function () {
        k = false;
        if (e) {
            try {
                e.removeChild(a)
            } catch (q) {}
        }
        n.removeEventListener(cm.IncomingAttackEvent.STATUS_CHANGED, i);
        n.removeEventListener(cm.IncomingAttackEvent.ARRIVAL_TIME_CHANGED, c);
        p.removeEventListener(cm.CollectionEvent.ELEMENT_ADDED, f);
        cm.CitySwitch.removeEventListener(cm.CitySwitchEvent.CITY_CHANGED, h);
        cm.CitySwitch.removeEventListener(cm.CitySwitchEvent.VIEW_CHANGED, g)
    };
    j()
};
cm.CurrentWatchTowerTimer = null;
cm.WatchTowerUtil = {
    findSlotInCity: function (f) {
        var b = seed.buildings["city" + f];
        var a, d, c, e;
        for (a in b) {
            d = b[a];
            c = d[0];
            if (c == cm.BUILDING_TYPES.WATCH_TOWER) {
                e = d[2];
                return e
            }
        }
        return -1
    }
};
cm.CitySwitch = new function () {
    cm.CustomEventDispatcher.call(this);
    var b;
    var a;
    this.setCurrentCity = function (e) {
        var d = b;
        b = e;
        var c = new cm.CitySwitchEvent(cm.CitySwitchEvent.CITY_CHANGED);
        c.setTarget({
            currentCity: b,
            previousCity: d
        });
        this.dispatchCustomEvent(c)
    };
    this.setView = function (d) {
        if (a != d) {
            var e = a;
            a = d;
            var c = new cm.CitySwitchEvent(cm.CitySwitchEvent.VIEW_CHANGED);
            c.setTarget({
                currentView: a,
                previousView: e
            });
            this.dispatchCustomEvent(c)
        }
    };
    this.init = function (d, c) {
        b = d;
        a = c
    }
}();
cm.OOP.inherits(cm.CitySwitch, cm.CustomEventDispatcher);
cm.CitySwitchEvent = function (a) {
    cm.CustomEvent.call(this, a)
};
cm.OOP.inherits(cm.CitySwitchEvent, cm.CustomEvent);
cm.CitySwitchEvent.CITY_CHANGED = "cityChanged";
cm.CitySwitchEvent.VIEW_CHANGED = "viewChanged";
if (!window.WildDefense) {
    var WildDefense = new Object()
}
WildDefense.Properties = {
    c_trapCost: 200,
    c_mercenaryList: ["", g_js_strings.commonstr.novices, g_js_strings.commonstr.intermediates, g_js_strings.commonstr.veterans],
    c_mercenaryCost: [0, 200, 400, 1000],
    tileId: 0,
    cityId: 0,
    gold: 0,
    ownedTraps: 0,
    maxTraps: 0,
    currMercenaryIdx: 0,
    newMercenaryIdx: 0,
    feError: {
        noMercChange: g_js_strings.WildDefense.nochange,
        notEnoughGold: g_js_strings.WildDefense.nogold,
        notValidNumber: g_js_strings.WildDefense.validnumber
    },
    castleFlag: false
};
WildDefense.Methods = {
    fillData: function () {
        if (!seed.wildDef["t" + this.tileId]) {
            seed.wildDef["t" + this.tileId] = Object.clone(wilddeftemplate);
            seed.wildDef["t" + this.tileId].tileId = this.tileId
        }
        this.gold = seed.citystats["city" + currentcityid].gold[0];
        this.cityId = currentcityid;
        this.maxTraps = parseInt(seed.wilderness["city" + currentcityid]["t" + this.tileId].tileLevel) * 100;
        this.ownedTraps = seed.wildDef["t" + this.tileId].fort60Count;
        this.currMercenaryIdx = seed.wildDef["t" + this.tileId].mercLevel;
        (this.currMercenaryIdx == 90) && (this.currMercenaryIdx = 0)
    },
    defenseModal: function (g, e) {
        this.castleFlag = (e) ? true : false;
        this.tileId = g;
        this.fillData();
        var f = {
            text_traptitle: g_js_strings.commonstr.traps,
            text_trapdesc: g_js_strings.WildDefense.trapdesc,
            data_owned_ratio: this.ownedTraps + "/" + this.maxTraps,
            rtext_cost: g_js_strings.WildDefense.costeach.replace("%1$s", this.c_trapCost),
            text_build: g_js_strings.commonstr.build,
            text_merctitle: g_js_strings.commonstr.mercenaries,
            text_mercdesc: g_js_strings.WildDefense.mercdesc,
            text_set: g_js_strings.commonstr.set,
            text_mercnone: g_js_strings.WildDefense.mercnone,
            text_mercnov: this.c_mercenaryList[1],
            rtext_costhr_none: g_js_strings.WildDefense.costhour.replace("%1$s", this.c_mercenaryCost[0]),
            rtext_costhr_nov: g_js_strings.WildDefense.costhour.replace("%1$s", this.c_mercenaryCost[1]),
            text_mercinter: this.c_mercenaryList[2],
            rtext_costhr_inter: g_js_strings.WildDefense.costhour.replace("%1$s", this.c_mercenaryCost[2]),
            text_mercvet: this.c_mercenaryList[3],
            rtext_costhr_vet: g_js_strings.WildDefense.costhour.replace("%1$s", this.c_mercenaryCost[3])
        };
        var a = getTemplate("wilddefense_defensemodal", f);
        Modal.showModal(500, 580, 90, 10, g_js_strings.modaltitles.wildernessdefense, a);
        if (this.ownedTraps >= this.maxTraps) {
            $("wildBuildTrapBtn") && disableActionButton($("wildBuildTrapBtn"))
        }
        var d = $("mercListForm").merclist;
        for (var b = 0; b < d.length; b++) {
            (d[b].value == this.currMercenaryIdx) && (d[b].checked = true)
        }
        var c = $("wildDefenseMain").select(".merc");
        for (var b = 0; b <= 3; b++) {
            if (this.c_mercenaryCost[b] > this.gold) {
                c[b].setOpacity(0.5);
                c[b].select("input")[0].disabled = true
            }
        }
    },
    trapModal: function () {
        var b = {
            text_youhave: g_js_strings.WildDefense.youhave + ":",
            text_max: g_js_strings.commonstr.max,
            rtext_traps: g_js_strings.WildDefense.atraps.replace("%1$s", this.ownedTraps + "/" + this.maxTraps),
            rtext_gold: g_js_strings.WildDefense.agold.replace("%1$s", addCommas(this.gold)),
            rtext_cost: g_js_strings.commonstr.cost + ": " + g_js_strings.WildDefense.costeach.replace("%1$s", this.c_trapCost),
            text_tobuild: g_js_strings.WildDefense.tobuild,
            text_build: g_js_strings.commonstr.build
        };
        var a = getTemplate("wilddefense_trapsmodal", b);
        Modal.showModal(400, 580, 90, 10, g_js_strings.commonstr.traps, a)
    },
    buyTraps: function () {
        var b = $("trapCount").value;
        if (this.qualifyTrapsPurchase(b) == "invalid") {
            $("trapPurchaseError").innerHTML = this.feError.notValidNumber;
            $("trapPurchaseError").show();
            return false
        } else {
            if (this.qualifyTrapsPurchase(b) == "gold") {
                $("trapPurchaseError").innerHTML = this.feError.notEnoughGold;
                $("trapPurchaseError").show();
                return false
            } else {
                if (!isNaN(this.qualifyTrapsPurchase(b))) {
                    b = this.qualifyTrapsPurchase(b)
                }
            }
        }
        $("trapPurchaseError").innerHTML = "";
        $("trapPurchaseError").hide();
        $("trapCount").value = b;
        var a = {};
        a.quant = b;
        a.tid = this.tileId;
        a.cid = this.cityId;
        AjaxCall.gPostRequest("ajax/buyWildTraps.php", a, function (c) {
            if (c.ok) {
                seed.wildDef["t" + WildDefense.tileId].fort60Count = parseInt(seed.wildDef["t" + WildDefense.tileId].fort60Count) + parseInt(b);
                if (c.updateSeed) {
                    update_seed(c.updateSeed)
                }
                if (WildDefense.castleFlag) {
                    Modal.hideModalAll();
                    buildslot($("slot_0"));
                    changeCastleModalTabs(2);
                    WildDefense.defenseModal(WildDefense.tileId, 1)
                } else {
                    Modal.hideModalAll();
                    WildDefense.defenseModal(WildDefense.tileId)
                }
            } else {
                Modal.showAlert(printLocalError((c.error_code || null), (c.msg || null), (c.feedback || null)))
            }
        })
    },
    qualifyTrapsPurchase: function (a) {
        if (isNaN(a) || parseInt(a) <= 0) {
            return "invalid"
        } else {
            if (parseInt(a) * this.c_trapCost > this.gold) {
                return "gold"
            } else {
                if ((parseInt(a) + parseInt(this.ownedTraps)) > this.maxTraps) {
                    return (this.maxTraps - parseInt(this.ownedTraps))
                } else {
                    return "passed"
                }
            }
        }
    },
    fillMaxTraps: function () {
        var a = parseInt(this.maxTraps) - parseInt(this.ownedTraps);
        var b = parseInt(this.gold / this.c_trapCost);
        a = (a > b) ? b : a;
        $("trapCount").value = a
    },
    mercenaryModal: function () {
        var c = $("mercListForm").merclist;
        var e = this.currMercenaryIdx;
        for (var b = 0; b < c.length; b++) {
            (c[b].checked) && (e = c[b].value)
        }
        if (e == this.currMercenaryIdx) {
            Modal.showAlert(this.feError.noMercChange);
            return false
        }
        this.newMercenaryIdx = e;
        var d = {
            c_mercenaryList: ["", g_js_strings.commonstr.novices, g_js_strings.commonstr.intermediates, g_js_strings.commonstr.veterans],
            c_mercenaryCost: [0, 200, 400, 1000],
            rtext_desc: (e == 0) ? g_js_strings.WildDefense.mercconfirmnone : g_js_strings.WildDefense.mercconfirm.replace("%1$s", this.c_mercenaryCost[e]).replace("%2$s", this.c_mercenaryCost[e]).replace("%3$s", this.c_mercenaryList[e]),
            text_cancel: g_js_strings.commonstr.cancel,
            text_hire: g_js_strings.commonstr.hire
        };
        var a = getTemplate("wilddefense_mercmodal", d);
        Modal.showModal(400, 580, 90, 10, g_js_strings.commonstr.mercenaries, a)
    },
    hireMercs: function () {
        var a = {};
        a.cid = this.cityId;
        a.tid = this.tileId;
        a.lv = this.newMercenaryIdx;
        a.olv = this.currMercenaryIdx;
        AjaxCall.gPostRequest("ajax/hireWildMerc.php", a, function (b) {
            if (b.ok) {
                if (b.updateSeed) {
                    update_seed(b.updateSeed)
                }
                seed.wildDef["t" + WildDefense.tileId].mercLevel = WildDefense.newMercenaryIdx;
                if (WildDefense.castleFlag) {
                    Modal.hideModalAll();
                    buildslot($("slot_0"));
                    WildDefense.defenseModal(WildDefense.tileId, 1)
                } else {
                    Modal.hideModalAll();
                    WildDefense.defenseModal(WildDefense.tileId)
                }
            } else {
                Modal.showAlert(printLocalError((b.error_code || null), (b.msg || null), (b.feedback || null)))
            }
        })
    }
};
Object.extend(WildDefense, WildDefense.Methods);
Object.extend(WildDefense, WildDefense.Properties);
cm.WonGloryItemView = function (b) {
    var a = function () {};
    var c = function (d) {
            cm.ModalManager.alert({
                text: g_js_strings.commonstr.found + ksoItems[d].name
            })
        };
    return {
        render: a,
        alert: c
    }
}(jQuery);
